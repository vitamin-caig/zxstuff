0001   0000                   device zxspectrum128
0002   0000             
0003   0000                   org #6000
0004   6000             begin 
0005   6000                   include "test.asm"
0001+  6000 F3                di
0002+  6001 CD 00 80          call init
0003+  6004 FD 21 3A 5C       ld iy,#5c3a
0004+  6008 21 58 27          ld hl,10072
0005+  600B D9                exx
0006+  600C FB                ei
0007+  600D 76          .loop halt
0008+  600E 01 01 00          ld bc,1
0009+  6011 21 F4 01          ld hl,500
0010+  6014             .delay
0011+  6014 ED 42             sbc hl,bc
0012+  6016 20 FC             jr nz,.delay
0013+  6018 3E 04             ld a,4
0014+  601A D3 FE             out (-2),a
0015+  601C CD 05 80          call play
0016+  601F AF                xor a
0017+  6020 D3 FE             out (-2),a
0018+  6022 3E 7F             ld a,#7f
0019+  6024 DB FE             in a,(-2)
0020+  6026 1F                rra
0021+  6027 38 E4             jr c,.loop
0022+  6029 CD 08 80          CALL mute
0023+  602C 3E 02       .fail ld a,2
0024+  602E D3 FE             out (-2),a
0025+  6030 F3                di
0026+  6031 76                halt
0027+  6032             
0028+  6032                   define MTC_CYBERMOTION "CyberMotion.mtc"
0029+  6032                   define MTC_DRUMTEST "drumtest.mtc"
0030+  6032                   define MTC_MUG "mug.mtc"
0031+  6032                   define MTC_MYSTICAL "mystical.mtc"
0032+  6032                   define MTC_NEWOLD "newold.mtc"
0033+  6032                   define MTC_SNEGURKA "Snegurka.mtc"
0034+  6032             
0035+  6032                   define TFC_CYBERMOTION MTC_CYBERMOTION,0x76
0036+  6032                   define TFC_DRUMTEST MTC_DRUMTEST,0xa90
0037+  6032                   define TFC_MUG MTC_MUG,0x52
0038+  6032                   define TFC_MYSTICAL MTC_MYSTICAL,0xcd4
0039+  6032                   define TFC_NEWOLD MTC_NEWOLD,0x263a
0040+  6032                   define TFC_SNEGURKA MTC_SNEGURKA,0x52
0041+  6032             
0042+  6032                   define PT3_DRUMTEST MTC_DRUMTEST,0x52
0043+  6032                   define PT3_MYSTICAL MTC_MYSTICAL,0x52
0044+  6032                   define PT3_NEWOLD MTC_NEWOLD,0x52
0045+  6032                   define PT3_SNEGURKA MTC_SNEGURKA,0xaa4
0046+  6032             
0047+  6032                   define TS_INEEDREST "INEEDREST.ts"
0048+  6032             
0049+  6032                   define PT2_PITON "PITON.pt2"
0050+  6032                   
0006   6032                   
0007   6032                   org #8000
0008   8000             player      
0009   8000             init=player
0010   8000             play=player+5
0011   8000             mute=player+8
0012   8000                   include "uni.asm"
0001+  8000                   ifndef _uni_asm_defined
0002+  8000                   define _uni_asm_defined
0003+  8000                   
0004+  8000                   module UNI
0005+  8000 21 66 92          ld hl,End
0006+  8003 18 06             jr Init
0007+  8005 C3 00 00    Play  jp 0
0008+  8008 C3 00 00    Mute  jp 0
0009+  800B                   
0010+  800B             Init  ;check most stable first
0011+  800B CD 28 80          call .tryMTC
0012+  800E C4 39 80          call nz,.tryTFC
0013+  8011 C4 4A 80          call nz,.tryTS
0014+  8014 C4 5B 80          call nz,.tryPT2
0015+  8017 C4 6C 80          call nz,.tryPT3
0016+  801A C8                ret z
0017+  801B 21 34 00          ld hl,52
0018+  801F 54 5D             ld d,h,e,l
0019+  8020 22 06 80    .addr ld (Play+1),hl
0020+  8023 ED 53 09 80       ld (Mute+1),de
0021+  8027 C9                ret
0022+  8028             
0023+  8028             .tryMTC
0024+  8028 E5                push hl
0025+  8029 CD 7D 80          call MTC.CheckFormat
0026+  802C E1                pop hl
0027+  802D C0                ret nz
0028+  802E CD 9C 80          call MTC.Init
0029+  8031 21 D9 80          ld hl,MTC.Play
0030+  8034 11 F7 80          ld de,MTC.Mute
0031+  8037 18 E7             jr .addr      
0032+  8039                   
0033+  8039             .tryTFC
0034+  8039 E5                push hl
0035+  803A CD F8 8F          call TFC.CheckFormat
0036+  803D E1                pop hl
0037+  803E C0                ret nz
0038+  803F CD 21 90          call TFC.Init
0039+  8042 21 D4 90          ld hl,TFC.Play
0040+  8045 11 5D 90          ld de,TFC.Mute
0041+  8048 18 D6             jr .addr
0042+  804A                   
0043+  804A             .tryTS
0044+  804A E5                push hl
0045+  804B CD AF 8F          call TS.CheckFormat
0046+  804E E1                pop hl
0047+  804F C0                ret nz
0048+  8050 CD AA 8F          call TS.Init
0049+  8053 21 7F 8B          ld hl,TS.Play
0050+  8056 11 51 83          ld de,TS.Mute
0051+  8059 18 C5             jr .addr      
0052+  805B             
0053+  805B             .tryPT2
0054+  805B E5                push hl
0055+  805C CD 6F 8F          call PT2.CheckFormat
0056+  805F E1                pop hl
0057+  8060 C0                ret nz
0058+  8061 CD 6A 8F          call PT2.Init
0059+  8064 21 7F 8B          ld hl,PT2.Play
0060+  8067 11 51 83          ld de,PT2.Mute
0061+  806A 18 B4             jr .addr
0062+  806C             
0063+  806C             .tryPT3
0064+  806C E5                push hl
0065+  806D CD 23 8F          call PT3.CheckFormat
0066+  8070 E1                pop hl
0067+  8071 C0                ret nz
0068+  8072 CD 1E 8F          call PT3.Init
0069+  8075 21 7F 8B          ld hl,PT3.Play
0070+  8078 11 51 83          ld de,PT3.Mute
0071+  807B 18 A3             jr .addr      
0072+  807D                   
0073+  807D                   endmod
0074+  807D             
0075+  807D                   define HaveFormatCheck
0076+  807D                   define NoPrologue
0077+  807D                   include "mtc.asm"
0001++ 807D                     ifndef _mtc_asm_defined
0002++ 807D                     define _mtc_asm_defined
0003++ 807D                     
0004++ 807D                     module MTC
0005++ 807D             
0006++ 807D                     ;enum-like
0007++ 807D                     struct StreamType
0008++ 807D~            PT3     db 0
0009++ 807D~            PT2     db 0
0010++ 807D~            TS      db 0        
0011++ 807D~            TFC     db 0
0012++ 807D~            Unknown db 0
0013++ 807D                     ends
0014++ 807D                     
0015++ 807D                     struct StreamData
0016++ 807D~            Type    db 0
0017++ 807D~            Data1   dw 0        
0018++ 807D~            Data2   dw 0
0019++ 807D~            Init    dw 0
0020++ 807D~            Play    dw 0
0021++ 807D~            Mute    dw 0
0022++ 807D                     ends
0023++ 807D                     
0024++ 807D             Start        
0025++ 807D                     ifndef NoPrologue
0026++ 807D~                    ld hl,End
0027++ 807D~                    jr Init
0028++ 807D~                    jp Play
0029++ 807D~                    jp Mute
0030++ 807D                     endif
0031++ 807D             
0032++ 807D                     ifdef HaveFormatCheck
0033++ 807D                     
0034++ 807D                     include "format.asm"
0001+++807D             ;some format checking macros
0002+++807D                     ifndef _format_asm_defined
0003+++807D                     define _format_asm_defined
0004+++807D             
0005+++807D                     macro LessOrEqual number
0006+++807D~                    ld a,number
0007+++807D~                    cp (hl)
0008+++807D~                    inc hl
0009+++807D~                    ret c
0010+++807D                     endm
0011+++807D                     
0012+++807D                     macro Greater number
0013+++807D~                    ld a,(hl)
0014+++807D~                    inc hl
0015+++807D~                    cp number
0016+++807D~                    ret c
0017+++807D                     endm
0018+++807D                     
0019+++807D                     macro AnyByte
0020+++807D~                    inc hl
0021+++807D                     endm
0022+++807D                     
0023+++807D                     macro AnyBytes count
0024+++807D~                    if count > 7
0025+++807D~                    ld a,l
0026+++807D~                    add a,count
0027+++807D~                    ld l,a
0028+++807D~                    adc a,h
0029+++807D~                    sub l
0030+++807D~                    ld h,a
0031+++807D~                    else
0032+++807D~                    dup count
0033+++807D~                    inc hl
0034+++807D~                    edup
0035+++807D~                    endif
0036+++807D                     endm
0037+++807D                     
0038+++807D                     macro EqualTo number
0039+++807D~                    ld a,number
0040+++807D~                    cp (hl)
0041+++807D~                    inc hl
0042+++807D~                    ret nz
0043+++807D                     endm
0044+++807D             
0045+++807D                     endif
0046+++807D             
0035++ 807D                     
0036++ 807D             ;in HL - module addr
0037++ 807D             ;out Z - is mtc
0038++ 807D             CheckFormat
0039++ 807D                     EqualTo "M"
0039++ 807D 3E 4D       >        ld a,number
0039++ 807F BE          >        cp (hl)
0039++ 8080 23          >        inc hl
0039++ 8081 C0          >        ret nz
0040++ 8082                     EqualTo "T"
0040++ 8082 3E 54       >        ld a,number
0040++ 8084 BE          >        cp (hl)
0040++ 8085 23          >        inc hl
0040++ 8086 C0          >        ret nz
0041++ 8087                     EqualTo "C"
0041++ 8087 3E 43       >        ld a,number
0041++ 8089 BE          >        cp (hl)
0041++ 808A 23          >        inc hl
0041++ 808B C0          >        ret nz
0042++ 808C                     EqualTo "1"
0042++ 808C 3E 31       >        ld a,number
0042++ 808E BE          >        cp (hl)
0042++ 808F 23          >        inc hl
0042++ 8090 C0          >        ret nz
0043++ 8091                     EqualTo 0
0043++ 8091 3E 00       >        ld a,number
0043++ 8093 BE          >        cp (hl)
0043++ 8094 23          >        inc hl
0043++ 8095 C0          >        ret nz
0044++ 8096                     EqualTo 0
0044++ 8096 3E 00       >        ld a,number
0044++ 8098 BE          >        cp (hl)
0044++ 8099 23          >        inc hl
0044++ 809A C0          >        ret nz
0045++ 809B C9                  ret
0046++ 809C                     
0047++ 809C                     display "MTC checker size: ",$-CheckFormat
0048++ 809C             
0049++ 809C                     endif
0050++ 809C             
0051++ 809C             ;in HL - module addr
0052++ 809C DD 21 52 81 Init    ld ix,Streams
0053++ 80A0 DD 36 00 04         ld (ix+StreamData.Type),StreamType.Unknown
0054++ 80A4 CD 17 81            call ParseChunk
0055++ 80A7 FE 00               cp ChunkId.MTC1
0056++ 80A9 CC 1C 82            call z,ParseMTC1
0057++ 80AC CD DD 82            call MergeStreams
0058++ 80AF DD 21 52 81         ld ix,Streams
0059++ 80B3             .initstreams
0060++ 80B3 DD 7E 00            ld a,(ix+StreamData.Type)
0061++ 80B6 FE 04               cp StreamType.Unknown
0062++ 80B8 C8                  ret z
0063++ 80B9 DD 6E 01            ld l,(ix+StreamData.Data1)
0064++ 80BC DD 66 02            ld h,(ix+StreamData.Data1+1)
0065++ 80BF DD 5E 03            ld e,(ix+StreamData.Data2)
0066++ 80C2 DD 56 04            ld d,(ix+StreamData.Data2+1)
0067++ 80C5 DD 4E 05            ld c,(ix+StreamData.Init)
0068++ 80C8 DD 46 06            ld b,(ix+StreamData.Init+1)
0069++ 80CB DD E5               push ix
0070++ 80CD CD 15 81            call jp_bc
0071++ 80D0 DD E1               pop ix
0072++ 80D2 01 0B 00            ld bc,StreamData
0073++ 80D5 DD 09               add ix,bc
0074++ 80D7 18 DA               jr .initstreams
0075++ 80D9                     
0076++ 80D9 DD 21 52 81 Play    ld ix,Streams
0077++ 80DD             .playstreams        
0078++ 80DD DD 7E 00            ld a,(ix+StreamData.Type)
0079++ 80E0 FE 04               cp StreamType.Unknown
0080++ 80E2 C8                  ret z
0081++ 80E3 DD 4E 07            ld c,(ix+StreamData.Play)
0082++ 80E6 DD 46 08            ld b,(ix+StreamData.Play+1)
0083++ 80E9 DD E5               push ix
0084++ 80EB CD 15 81            call jp_bc
0085++ 80EE DD E1               pop ix
0086++ 80F0 01 0B 00            ld bc,StreamData
0087++ 80F3 DD 09               add ix,bc
0088++ 80F5 18 E6               jr .playstreams
0089++ 80F7             
0090++ 80F7 DD 21 52 81 Mute    ld ix,Streams
0091++ 80FB             .mutestreams        
0092++ 80FB DD 7E 00            ld a,(ix+StreamData.Type)
0093++ 80FE FE 04               cp StreamType.Unknown
0094++ 8100 C8                  ret z
0095++ 8101 DD 4E 09            ld c,(ix+StreamData.Mute)
0096++ 8104 DD 46 0A            ld b,(ix+StreamData.Mute+1)
0097++ 8107 DD E5               push ix
0098++ 8109 CD 15 81            call jp_bc
0099++ 810C DD E1               pop ix
0100++ 810E 01 0B 00            ld bc,StreamData
0101++ 8111 DD 09               add ix,bc
0102++ 8113 18 E6               jr .mutestreams
0103++ 8115             
0104++ 8115 C5          jp_bc   push bc
0105++ 8116 C9                  ret
0106++ 8117             
0107++ 8117             ;in hl - chunk start
0108++ 8117             ;out a - chunkid
0109++ 8117             ;out hl - chunk data start
0110++ 8117             ;out bc - chunk data size
0111++ 8117             ParseChunk
0112++ 8117 11 00 82            ld de,Chunks
0113++ 811A             .checkid
0114++ 811A 06 04               ld b,4
0115++ 811C E5                  push hl
0116++ 811D                     dup 4
0117++ 811D 1A          >        ld a,(de)
0118++ 811E 1C          >        inc e
0119++ 811F BE          >        cp (hl)
0120++ 8120 23          >        inc hl
0121++ 8121 20 01       >        jr nz,$+3
0122++ 8123 05          >        dec b
0117++ 8124 1A          >        ld a,(de)
0118++ 8125 1C          >        inc e
0119++ 8126 BE          >        cp (hl)
0120++ 8127 23          >        inc hl
0121++ 8128 20 01       >        jr nz,$+3
0122++ 812A 05          >        dec b
0117++ 812B 1A          >        ld a,(de)
0118++ 812C 1C          >        inc e
0119++ 812D BE          >        cp (hl)
0120++ 812E 23          >        inc hl
0121++ 812F 20 01       >        jr nz,$+3
0122++ 8131 05          >        dec b
0117++ 8132 1A          >        ld a,(de)
0118++ 8133 1C          >        inc e
0119++ 8134 BE          >        cp (hl)
0120++ 8135 23          >        inc hl
0121++ 8136 20 01       >        jr nz,$+3
0122++ 8138 05          >        dec b
0124++ 8139                     ;nz if last byte is not matched
0125++ 8139                     ;nz if b != 0 (not all bytes matched)
0126++ 8139 7B                  ld a,e
0127++ 813A 28 07               jr z,.matched
0128++ 813C FE 1C               cp ChunkId.Unknown
0129++ 813E 28 05               jr z,.getdata
0130++ 8140 E1                  pop hl
0131++ 8141 18 D7               jr .checkid
0132++ 8143             .matched
0133++ 8143 D6 04               sub 4
0134++ 8145             .getdata
0135++ 8145                     ;skip higher bytes of size, assume they are zero
0136++ 8145 23                  inc hl
0137++ 8146 23                  inc hl        
0138++ 8147 46                  ld b,(hl)
0139++ 8148 23                  inc hl
0140++ 8149 4E                  ld c,(hl)
0141++ 814A 23                  inc hl
0142++ 814B                     ;chunk is always aligned at word boundary, so correct length
0143++ 814B CB 41               bit 0,c
0144++ 814D 28 01               jr z,$+3
0145++ 814F 03                  inc bc
0146++ 8150 D1                  pop de
0147++ 8151 C9                  ret
0148++ 8152             
0149++ 8152             ;put streams in gap
0150++ 8152             Streams 
0151++ 8152             MinStreamsCount=3 ;approx: ts+tfm
0152++ 8152 00                  ds MinStreamsCount*StreamData ;approx
0153++ 8173             Streams.End
0154++ 8173                     display "MTC: loosed ",256-low $," bytes"
0155++ 8173 00                  align 256
0156++ 8200             Chunks
0157++ 8200             ChunkId
0158++ 8200             .MTC1=low $
0159++ 8200 4D 54 43 31         db "MTC1"
0160++ 8204             .TRCK=low $
0161++ 8204 54 52 43 4B         db "TRCK"
0162++ 8208             .DATA=low $
0163++ 8208 44 41 54 41         db "DATA"
0164++ 820C             .NAME=low $
0165++ 820C 4E 41 4D 45         db "NAME"
0166++ 8210             .AUTH=low $
0167++ 8210 41 55 54 48         db "AUTH"
0168++ 8214             .ANNO=low $
0169++ 8214 41 4E 4E 4F         db "ANNO"
0170++ 8218             .PROP=low $
0171++ 8218 50 52 4F 50         db "PROP"
0172++ 821C             .Unknown=low $
0173++ 821C             
0174++ 821C             MaxStreamsCount=(Chunks-Streams)/StreamData
0175++ 821C                     display "MTC: max streams ",MaxStreamsCount
0176++ 821C                     
0177++ 821C             ;in hl - content
0178++ 821C             ;in bc - size
0179++ 821C             ParseMTC1
0180++ 821C E5                  push hl
0181++ 821D 09                  add hl,bc
0182++ 821E E3                  ex (sp),hl
0183++ 821F                     ; (sp) - end of avail data
0184++ 821F             .nextchunk        
0185++ 821F CD 17 81            call ParseChunk
0186++ 8222 E5 C5               push hl,bc
0187++ 8224 FE 04               cp ChunkId.TRCK
0188++ 8226 CC 34 82            call z,ParseTrack
0189++ 8229 C1 E1               pop bc,hl
0190++ 822B 09                  add hl,bc
0191++ 822C D1                  pop de
0192++ 822D                     ;hl- end of chunk
0193++ 822D                     ;de- end of avail
0194++ 822D ED 52               sbc hl,de
0195++ 822F C8                  ret z ;last chunk
0196++ 8230 19                  add hl,de
0197++ 8231 D5                  push de
0198++ 8232 18 EB               jr .nextchunk
0199++ 8234             
0200++ 8234             ;in hl - content
0201++ 8234             ;in bc - size        
0202++ 8234             ParseTrack        
0203++ 8234 E5                  push hl
0204++ 8235 09                  add hl,bc
0205++ 8236 E3                  ex (sp),hl
0206++ 8237                     ; (sp) - end of avail data
0207++ 8237             .nextchunk        
0208++ 8237 CD 17 81            call ParseChunk
0209++ 823A E5 C5               push hl,bc
0210++ 823C FE 08               cp ChunkId.DATA
0211++ 823E CC 4D 82            call z,ParseData
0212++ 8241 C1 E1               pop bc,hl
0213++ 8243 09                  add hl,bc
0214++ 8244 D1                  pop de
0215++ 8245 C8                  ret z ;data is parsed
0216++ 8246                     ;hl- end of chunk
0217++ 8246                     ;de- end of avail
0218++ 8246 ED 52               sbc hl,de
0219++ 8248 C8                  ret z ;last chunk
0220++ 8249 19                  add hl,de
0221++ 824A D5                  push de
0222++ 824B 18 EA               jr .nextchunk
0223++ 824D             
0224++ 824D             ;in hl - content
0225++ 824D             ;in bc - size        
0226++ 824D             ;out Z - data parsed and added as stream
0227++ 824D             ParseData
0228++ 824D CD 59 82            call ParseTFC
0229++ 8250 C4 7B 82            call nz,ParseTS
0230++ 8253 C4 88 82            call nz,ParsePT2
0231++ 8256 20 43               jr nz,ParsePT3
0232++ 8258 C9                  ret
0233++ 8259                     
0234++ 8259             ParseTFC
0235++ 8259 E5 C5               push hl,bc
0236++ 825B CD F8 8F            call TFC.CheckFormat
0237++ 825E C1 E1               pop bc,hl
0238++ 8260 C0                  ret nz
0239++ 8261 3E 03               ld a,StreamType.TFC
0240++ 8263 D9                  exx
0241++ 8264 21 21 90            ld hl,TFC.Init
0242++ 8267 11 D4 90            ld de,TFC.Play
0243++ 826A 01 5D 90            ld bc,TFC.Mute
0244++ 826D CD BA 82            call FillStream
0245++ 8270             AddStream        
0246++ 8270 01 0B 00            ld bc,StreamData
0247++ 8273 DD 09               add ix,bc
0248++ 8275 DD 36 00 04         ld (ix+StreamData.Type),StreamType.Unknown
0249++ 8279 AF                  xor a;set Z
0250++ 827A C9                  ret
0251++ 827B                     
0252++ 827B             ParseTS
0253++ 827B E5 C5               push hl,bc
0254++ 827D CD C0 8F            call TS.CheckFormatKnownSize
0255++ 8280 C1 E1               pop bc,hl
0256++ 8282 C0                  ret nz
0257++ 8283 CD AE 82            call FillTS
0258++ 8286 18 E8               jr AddStream
0259++ 8288                     
0260++ 8288             ParsePT2
0261++ 8288 E5 C5               push hl,bc
0262++ 828A CD 6F 8F            call PT2.CheckFormat
0263++ 828D C1 E1               pop bc,hl
0264++ 828F C0                  ret nz
0265++ 8290 3E 01               ld a,StreamType.PT2
0266++ 8292 D9                  exx
0267++ 8293 21 6A 8F            ld hl,PT2.Init
0268++ 8296 CD B4 82            call FillPts
0269++ 8299 18 D5               jr AddStream
0270++ 829B             
0271++ 829B             ParsePT3        
0272++ 829B E5 C5               push hl,bc
0273++ 829D CD 23 8F            call PT3.CheckFormat
0274++ 82A0 C1 E1               pop bc,hl
0275++ 82A2 C0                  ret nz
0276++ 82A3 3E 00               ld a,StreamType.PT3
0277++ 82A5 D9                  exx
0278++ 82A6 21 1E 8F            ld hl,PT3.Init
0279++ 82A9 CD B4 82            call FillPts
0280++ 82AC 18 C2               jr AddStream
0281++ 82AE                     
0282++ 82AE 3E 02       FillTS  ld a,StreamType.TS        
0283++ 82B0 D9                  exx
0284++ 82B1 21 AA 8F            ld hl,TS.Init
0285++ 82B4 11 7F 8B    FillPts ld de,PTS.PLAY
0286++ 82B7 01 51 83            ld bc,PTS.MUTE
0287++ 82BA             FillStream
0288++ 82BA DD 77 00            ld (ix+StreamData.Type),a
0289++ 82BD DD 75 05            ld (ix+StreamData.Init),l
0290++ 82C0 DD 74 06            ld (ix+StreamData.Init+1),h
0291++ 82C3 DD 73 07            ld (ix+StreamData.Play),e
0292++ 82C6 DD 72 08            ld (ix+StreamData.Play+1),d
0293++ 82C9 DD 71 09            ld (ix+StreamData.Mute),c
0294++ 82CC DD 70 0A            ld (ix+StreamData.Mute+1),b
0295++ 82CF D9                  exx
0296++ 82D0 DD 75 01            ld (ix+StreamData.Data1),l
0297++ 82D3 DD 74 02            ld (ix+StreamData.Data1+1),h
0298++ 82D6 DD 73 03            ld (ix+StreamData.Data2),e
0299++ 82D9 DD 72 04            ld (ix+StreamData.Data2+1),d
0300++ 82DC C9                  ret
0301++ 82DD             
0302++ 82DD             ;some business-logic related to supported players        
0303++ 82DD             MergeStreams
0304++ 82DD 3A 52 81            ld a,(Streams+StreamData.Type)
0305++ 82E0 FE 04               cp StreamType.Unknown
0306++ 82E2 C8                  ret z ;no streams
0307++ 82E3 3A 5D 81            ld a,(Streams+StreamData+StreamData.Type)
0308++ 82E6 FE 04               cp StreamType.Unknown
0309++ 82E8 C8                  ret z ;single stream
0310++ 82E9             
0311++ 82E9                     ;sort streams according to type, use simple bubblesort
0312++ 82E9             Sort
0313++ 82E9                     assert 0 == ((Streams ^ Streams.End) >> 8)
0314++ 82E9                     assert 0 == StreamData.Type
0315++ 82E9 11 52 81            ld de,Streams
0316++ 82EC 21 5D 81            ld hl,Streams+StreamData
0317++ 82EF 0E 00               ld c,0;swaps mark
0318++ 82F1             .cycle        
0319++ 82F1 1A                  ld a,(de)
0320++ 82F2 FE 04               cp StreamType.Unknown
0321++ 82F4 28 1A               jr z,.end
0322++ 82F6 BE                  cp (hl)
0323++ 82F7 38 10               jr c,.next
0324++ 82F9 28 0E               jr z,.next
0325++ 82FB 06 0B               ld b,StreamData
0326++ 82FD             .swapitems
0327++ 82FD 1A                  ld a,(de)        
0328++ 82FE 4E                  ld c,(hl)
0329++ 82FF 77                  ld (hl),a
0330++ 8300 79                  ld a,c
0331++ 8301 12                  ld (de),a
0332++ 8302 2C                  inc l
0333++ 8303 1C                  inc e
0334++ 8304 10 F7               djnz .swapitems
0335++ 8306 4C                  ld c,h
0336++ 8307 18 E8               jr .cycle
0337++ 8309             .next
0338++ 8309 5D                  ld e,l
0339++ 830A 7D                  ld a,l
0340++ 830B C6 0B               add a,StreamData
0341++ 830D 6F                  ld l,a        
0342++ 830E 18 E1               jr .cycle
0343++ 8310             .end
0344++ 8310 79                  ld a,c
0345++ 8311 A7                  and a
0346++ 8312 20 D5               jr nz,Sort
0347++ 8314                     ;try merge streams
0348++ 8314                     ; X X merged to X (last is taken)
0349++ 8314                     ; PT3 PT3 merged to TS
0350++ 8314             Merge
0351++ 8314                     assert 0 == StreamData.Type
0352++ 8314 11 52 81            ld de,Streams
0353++ 8317 21 5D 81            ld hl,Streams+StreamData
0354++ 831A             .cycle        
0355++ 831A 1A                  ld a,(de)
0356++ 831B FE 04               cp StreamType.Unknown
0357++ 831D C8                  ret z
0358++ 831E BE                  cp (hl)
0359++ 831F 28 07               jr z,.perform
0360++ 8321 5D                  ld e,l
0361++ 8322 7D                  ld a,l
0362++ 8323 C6 0B               add a,StreamData
0363++ 8325 6F                  ld l,a
0364++ 8326 18 F2               jr .cycle
0365++ 8328             .perform
0366++ 8328 FE 00               cp StreamType.PT3
0367++ 832A 20 15               jr nz,.generic
0368++ 832C                     ;merge PT3 streams to TS
0369++ 832C E5 D5               push hl,de
0370++ 832E E5 D5               push hl,de
0371++ 8330 2C                  inc l
0372++ 8331 5E                  ld e,(hl)
0373++ 8332 2C                  inc l
0374++ 8333 56                  ld d,(hl) ;data1
0375++ 8334 E1                  pop hl
0376++ 8335 2C                  inc l
0377++ 8336 7E                  ld a,(hl)
0378++ 8337 2C                  inc l
0379++ 8338 66                  ld h,(hl)
0380++ 8339 6F                  ld l,a  ;data2
0381++ 833A DD E1               pop ix
0382++ 833C CD AE 82            call FillTS
0383++ 833F D1 E1               pop de,hl
0384++ 8341             .generic
0385++ 8341                     ;for other types just take last one
0386++ 8341 06 0B               ld b,StreamData
0387++ 8343             .copyitems
0388++ 8343 7E                  ld a,(hl)
0389++ 8344 12                  ld (de),a
0390++ 8345 2C                  inc l
0391++ 8346 1C                  inc e
0392++ 8347 10 FA               djnz .copyitems        
0393++ 8349 1A                  ld a,(de)
0394++ 834A FE 04               cp StreamType.Unknown
0395++ 834C 20 F3               jr nz,.generic
0396++ 834E 18 8D               jr MergeStreams
0397++ 8350             
0398++ 8350                     endmod
0399++ 8350                     
0400++ 8350                     ifndef NoPrologue
0401++ 8350~                    define NoPrologue
0402++ 8350                     endif
0403++ 8350                     
0404++ 8350                     ifndef HaveFormatCheck
0405++ 8350~                    define HaveFormatCheck
0406++ 8350                     endif
0407++ 8350                     
0408++ 8350                     ifndef ONtfm
0409++ 8350                     define ONtfm
0410++ 8350                     endif
0411++ 8350                     
0412++ 8350                     include "PTSPlay.asm"
0001+++8350                     ifndef _pts_asm_defined
0002+++8350                     define _pts_asm_defined
0003+++8350             
0004+++8350                     MODULE PTS
0005+++8350                     
0006+++8350             ;Universal PT2'n'PT3 Turbo Sound player for ZX Spectrum
0007+++8350             ;(c)2004-2007 S.V.Bulba <vorobey@mail.khstu.ru>
0008+++8350             ;Specially for AlCo
0009+++8350             ;http://bulba.untergrund.net/ (http://bulba.at.kz/)
0010+++8350             
0011+++8350             ;Release number
0012+++8350             Release EQU "0"
0013+++8350             
0014+++8350             ;Conditional assembly
0015+++8350             ;1) Current position counters at (Vars1+0) and (Vars2+0)
0016+++8350             CurPosCounter=0
0017+++8350             ;2) Allow channels allocation bits at (SETUP)
0018+++8350             ACBBAC=0
0019+++8350             ;3) Allow loop checking and disabling
0020+++8350             LoopChecker=0
0021+++8350             ;4) Insert official identificator
0022+++8350             Id=0
0023+++8350             ;5) Set IY for correct return to ZX Basic
0024+++8350             Basic=0
0025+++8350             
0026+++8350             ;Features
0027+++8350             ;--------
0028+++8350             ;-Can be compiled at any address (i.e. no need rounding ORG
0029+++8350             ; address).
0030+++8350             ;-Variables (VARS) can be located at any address (not only after
0031+++8350             ; code block).
0032+++8350             ;-INIT subprogram checks PT3-module version and rightly
0033+++8350             ; generates both note and volume tables outside of code block
0034+++8350             ; (in VARS).
0035+++8350             ;-Two portamento (spc. command 3xxx) algorithms (depending of
0036+++8350             ; PT3 module version).
0037+++8350             ;-New 1.XX and 2.XX special command behaviour (only for PT v3.7
0038+++8350             ; and higher).
0039+++8350             ;-Any Tempo value are accepted (including Tempo=1 and Tempo=2).
0040+++8350             ;-TS modes: 2xPT3, 2xPT2 and PT v3.7 TS standard.
0041+++8350             ;-Fully compatible with Ay_Emul PT3 and PT2 players codes.
0042+++8350             ;-See also notes at the end of this source code.
0043+++8350             
0044+++8350             ;Limitations
0045+++8350             ;-----------
0046+++8350             ;-Can run in RAM only (self-modified code is used).
0047+++8350             ;-PT2 position list must be end by #FF marker only.
0048+++8350             
0049+++8350             ;Warning!!! PLAY subprogram can crash if no module are loaded
0050+++8350             ;into RAM or INIT subprogram was not called before.
0051+++8350             
0052+++8350             ;Call MUTE or INIT one more time to mute sound after stopping
0053+++8350             ;playing 
0054+++8350             
0055+++8350             TonA	EQU 0
0056+++8350             TonB	EQU 2
0057+++8350             TonC	EQU 4
0058+++8350             Noise	EQU 6
0059+++8350             Mixer	EQU 7
0060+++8350             AmplA	EQU 8
0061+++8350             AmplB	EQU 9
0062+++8350             AmplC	EQU 10
0063+++8350             Env	EQU 11
0064+++8350             EnvTp	EQU 13
0065+++8350             
0066+++8350             START
0067+++8350             
0068+++8350             SETUP.NOLOOP EQU 1
0069+++8350             SETUP.PT2 EQU 2
0070+++8350             SETUP.ACB EQU 4
0071+++8350             SETUP.BAC EQU 8
0072+++8350             SETUP.TS02 EQU 16
0073+++8350             SETUP.TSPT3 EQU 32
0074+++8350             
0075+++8350 00          SETUP	DB 0 ;set bit0, if you want to play without looping
0076+++8351             	     ;(optional);
0077+++8351             	     ;set bit1 for PT2 and reset for PT3 before
0078+++8351             	     ;calling INIT;
0079+++8351             	     ;bits2-3: %00-ABC, %01-ACB, %10-BAC (optional);
0080+++8351             	     ;bits4-5: %00-no TS, %01-2 modules TS, %10-
0081+++8351             	     ;autodetect PT3 TS-format by AlCo (PT 3.7+);
0082+++8351             	     ;Remark: old PT3 TS-format by AlCo (PT 3.6) is not
0083+++8351             	     ;documented and must be converted to new standard.
0084+++8351             	     ;bit6 is set each time, when loop point of 2nd TS
0085+++8351             	     ;module is passed (optional).
0086+++8351             	     ;bit7 is set each time, when loop point of 1st TS
0087+++8351             	     ;or of single module is passed (optional).
0088+++8351             
0089+++8351             ;Identifier
0090+++8351             	IF Id
0091+++8351~            	DB "=UniPT2/PT3/TS-Player r.",Release,"="
0092+++8351             	ENDIF
0093+++8351             
0094+++8351             	IF LoopChecker
0095+++8351~            CHECKLP	LD HL,SETUP
0096+++8351~            	BIT 0,(IY-100+VRS.ModNum)
0097+++8351~            	JR Z,CHL1
0098+++8351~            	SET 6,(HL)
0099+++8351~            	JR CHL2
0100+++8351~            CHL1	SET 7,(HL)
0101+++8351~            CHL2	BIT 0,(HL)
0102+++8351~            	RET Z
0103+++8351~            	POP HL
0104+++8351~            	INC (IY-100+VRS.DelyCnt)
0105+++8351~            	INC (IY-100+VRS.ChanA+CHP.NtSkCn)
0106+++8351~            	XOR A
0107+++8351~            	LD (IY-100+VRS.AYREGS+AmplA),A
0108+++8351~            	LD (IY-100+VRS.AYREGS+AmplB),A
0109+++8351~            	LD (IY-100+VRS.AYREGS+AmplC),A
0110+++8351~            	RET
0111+++8351             	ENDIF
0112+++8351             
0113+++8351 AF          MUTE	XOR A
0114+++8352 67          	LD H,A
0115+++8353 6F          	LD L,A
0116+++8354 32 E1 8C    	LD (VARS1+VRS.AYREGS+AmplA),A
0117+++8357 22 E2 8C    	LD (VARS1+VRS.AYREGS+AmplB),HL
0118+++835A 32 68 8D    	LD (VARS2+VRS.AYREGS+AmplA),A
0119+++835D 22 69 8D    	LD (VARS2+VRS.AYREGS+AmplB),HL
0120+++8360 C3 93 8B    	JP ROUT
0121+++8363             
0122+++8363             INIT
0123+++8363             ;HL - AddressOfModule
0124+++8363             ;DE - AddresOf2ndModule
0125+++8363             ;A - mode
0126+++8363 D5          	PUSH DE
0127+++8364 E5          	PUSH HL
0128+++8365 21 5F 8C    	LD HL,VARS
0129+++8368 36 00       	LD (HL),0
0130+++836A 11 60 8C    	LD DE,VARS+1
0131+++836D 01 0E 01    	LD BC,VAR0END-VARS-1
0132+++8370 ED B0       	LDIR
0133+++8372 23          	INC HL
0134+++8373 22 C2 8C    	LD (VARS1+VRS.AdInPtA),HL ;ptr to zero
0135+++8376 22 49 8D    	LD (VARS2+VRS.AdInPtA),HL
0136+++8379             
0137+++8379 E1          	POP HL
0138+++837A FD 21 C4 8C 	LD IY,VARS1+100
0139+++837E 32 50 83        LD (SETUP),A
0140+++8381 E6 02       	AND SETUP.PT2
0141+++8383 C2 0C 84    	JP NZ,I_PT2
0142+++8386             
0143+++8386 CD 55 85    	CALL INITPT3
0144+++8389 21 18 1F    	LD HL,(e_-SamCnv-2)*256+#18
0145+++838C 22 28 89    	LD (SamCnv),HL
0146+++838F 3E BA       	LD A,#BA
0147+++8391 32 F3 88    	LD (OrnCP),A
0148+++8394 32 1F 89    	LD (SamCP),A
0149+++8397 3E 7B       	LD A,#7B
0150+++8399 32 F6 88    	LD (OrnLD),A
0151+++839C 32 22 89    	LD (SamLD),A
0152+++839F 3E 87       	LD A,#87
0153+++83A1 32 19 89    	LD (SamClc2),A
0154+++83A4 E1          	POP HL
0155+++83A5             	;Use version and ton table of 1st module
0156+++83A5 DD 7E A9    	LD A,(IX+13-100) ;EXTRACT VERSION NUMBER
0157+++83A8 D6 30       	SUB #30
0158+++83AA 38 04       	JR C,L20
0159+++83AC FE 0A       	CP 10
0160+++83AE 38 02       	JR C,L21
0161+++83B0 3E 06       L20	LD A,6
0162+++83B2 32 C6 87    L21	LD (Version),A
0163+++83B5 F5          	PUSH AF ;VolTable version
0164+++83B6 FE 04       	CP 4
0165+++83B8 DD 7E FF    	LD A,(IX+99-100) ;TONE TABLE NUMBER
0166+++83BB 17          	RLA
0167+++83BC E6 07       	AND 7
0168+++83BE F5          	PUSH AF ;NoteTable number
0169+++83BF             
0170+++83BF FD 21 4B 8D 	LD IY,VARS2+100
0171+++83C3 3A 50 83    	LD A,(SETUP)
0172+++83C6 E6 30       	AND SETUP.TS02|SETUP.TSPT3
0173+++83C8 28 37       	JR Z,NOTS
0174+++83CA FE 10       	CP SETUP.TS02
0175+++83CC 28 27       	JR Z,TwoPT3s
0176+++83CE 3A C6 87    	LD A,(Version)
0177+++83D1 FE 07       	CP 7
0178+++83D3 38 2C       	JR C,NOTS
0179+++83D5 DD 7E FE    	LD A,(IX+98-100) ;ALCO TS MARKER
0180+++83D8 FE 20       	CP #20
0181+++83DA 28 25       	JR Z,NOTS
0182+++83DC 21 60 8C    	LD HL,VARS1
0183+++83DF 11 E7 8C    	LD DE,VARS2
0184+++83E2 01 87 00    	LD BC,VRS
0185+++83E5 ED B0       	LDIR
0186+++83E7 FD CB 9E CE 	SET 1,(IY-100+VRS.ModNum)
0187+++83EB 4F          	LD C,A
0188+++83EC 87          	ADD A,A
0189+++83ED 81          	ADD A,C
0190+++83EE D6 02       	SUB 2
0191+++83F0 32 8A 8A    	LD (TSSub),A
0192+++83F3 18 03       	JR AlCoTS_
0193+++83F5 CD 55 85    TwoPT3s	CALL INITPT3
0194+++83F8 3E 01       AlCoTS_	LD A,1
0195+++83FA 32 5F 8C    	LD (is_ts),A
0196+++83FD FD CB 9E C6 	SET 0,(IY-100+VRS.ModNum)
0197+++8401             
0198+++8401 01 12 87    NOTS	LD BC,PT3PD
0199+++8404 21 00 00    	LD HL,0
0200+++8407 11 27 8C    	LD DE,PT3EMPTYORN
0201+++840A 18 48       	JR INITCOMMON
0202+++840C             
0203+++840C CD 8D 85    I_PT2	CALL INITPT2
0204+++840F 21 CB 51    	LD HL,#51CB
0205+++8412 22 28 89    	LD (SamCnv),HL
0206+++8415 3E BB       	LD A,#BB
0207+++8417 32 F3 88    	LD (OrnCP),A
0208+++841A 32 1F 89    	LD (SamCP),A
0209+++841D 3E 7A       	LD A,#7A
0210+++841F 32 F6 88    	LD (OrnLD),A
0211+++8422 32 22 89    	LD (SamLD),A
0212+++8425 3E 80       	LD A,#80
0213+++8427 32 19 89    	LD (SamClc2),A
0214+++842A E1          	POP HL
0215+++842B 3E 05       	LD A,5
0216+++842D 32 C6 87    	LD (Version),A
0217+++8430 F5          	PUSH AF
0218+++8431 3E 02       	LD A,2
0219+++8433 F5          	PUSH AF
0220+++8434             
0221+++8434 3A 50 83    	LD A,(SETUP)
0222+++8437 E6 30           AND SETUP.TS02|SETUP.TSPT3
0223+++8439 28 10       	JR Z,NOTS2
0224+++843B             
0225+++843B FD 21 4B 8D 	LD IY,VARS2+100
0226+++843F 3E 01       	LD A,1
0227+++8441 32 5F 8C    	LD (is_ts),A
0228+++8444 FD CB 9E C6 	SET 0,(IY-100+VRS.ModNum)
0229+++8448 CD 8D 85    	CALL INITPT2
0230+++844B             
0231+++844B 01 4C 86    NOTS2	LD BC,PT2PD
0232+++844E 21 87 86    	LD HL,#8687
0233+++8451 11 7D 8D    	LD DE,PT2EMPTYORN
0234+++8454             
0235+++8454             INITCOMMON
0236+++8454             
0237+++8454             	IF Basic
0238+++8454~            	LD IY,#5C3A
0239+++8454             	ENDIF
0240+++8454             
0241+++8454 ED 43 FD 85 	LD (PTDEC),BC
0242+++8458 22 8C 8A    	LD (PsCalc),HL
0243+++845B D5          	PUSH DE
0244+++845C             
0245+++845C             ;note table data depacker
0246+++845C             ;(c) Ivan Roshin
0247+++845C 11 2A 8C    	LD DE,T_PACK
0248+++845F 01 CF 8D    	LD BC,T1_+(2*49)-1
0249+++8462 1A          TP_0	LD A,(DE)
0250+++8463 13          	INC DE
0251+++8464 FE 1E       	CP 15*2
0252+++8466 30 06       	JR NC,TP_1
0253+++8468 67          	LD H,A
0254+++8469 1A          	LD A,(DE)
0255+++846A 6F          	LD L,A
0256+++846B 13          	INC DE
0257+++846C 18 07       	JR TP_2
0258+++846E D5          TP_1	PUSH DE
0259+++846F 16 00       	LD D,0
0260+++8471 5F          	LD E,A
0261+++8472 19          	ADD HL,DE
0262+++8473 19          	ADD HL,DE
0263+++8474 D1          	POP DE
0264+++8475 7C          TP_2	LD A,H
0265+++8476 02          	LD (BC),A
0266+++8477 0B          	DEC BC
0267+++8478 7D          	LD A,L
0268+++8479 02          	LD (BC),A
0269+++847A 0B          	DEC BC
0270+++847B D6 F0       	SUB (#F8*2)&255
0271+++847D 20 E3       	JR NZ,TP_0
0272+++847F             
0273+++847F 3C          	INC A
0274+++8480 32 CD 8C    	LD (VARS1+VRS.DelyCnt),A
0275+++8483 32 54 8D    	LD (VARS2+VRS.DelyCnt),A
0276+++8486 21 01 F0    	LD HL,#F001 ;H - CHP.Volume, L - CHP.NtSkCn
0277+++8489 22 7E 8C    	LD (VARS1+VRS.ChanA+CHP.NtSkCn),HL
0278+++848C 22 9B 8C    	LD (VARS1+VRS.ChanB+CHP.NtSkCn),HL
0279+++848F 22 B8 8C    	LD (VARS1+VRS.ChanC+CHP.NtSkCn),HL
0280+++8492 22 05 8D    	LD (VARS2+VRS.ChanA+CHP.NtSkCn),HL
0281+++8495 22 22 8D    	LD (VARS2+VRS.ChanB+CHP.NtSkCn),HL
0282+++8498 22 3F 8D    	LD (VARS2+VRS.ChanC+CHP.NtSkCn),HL
0283+++849B E1          	POP HL
0284+++849C 22 70 8C    	LD (VARS1+VRS.ChanA+CHP.OrnPtr),HL
0285+++849F 22 8D 8C    	LD (VARS1+VRS.ChanB+CHP.OrnPtr),HL
0286+++84A2 22 AA 8C    	LD (VARS1+VRS.ChanC+CHP.OrnPtr),HL
0287+++84A5 22 F7 8C    	LD (VARS2+VRS.ChanA+CHP.OrnPtr),HL
0288+++84A8 22 14 8D    	LD (VARS2+VRS.ChanB+CHP.OrnPtr),HL
0289+++84AB 22 31 8D    	LD (VARS2+VRS.ChanC+CHP.OrnPtr),HL
0290+++84AE             
0291+++84AE F1          	POP AF
0292+++84AF             
0293+++84AF             ;NoteTableCreator (c) Ivan Roshin
0294+++84AF             ;A - NoteTableNumber*2+VersionForNoteTable
0295+++84AF             ;(xx1b - 3.xx..3.4r, xx0b - 3.4x..3.6x..VTII1.0)
0296+++84AF             
0297+++84AF 21 D7 8B    	LD HL,NT_DATA
0298+++84B2 16 00       	LD D,0
0299+++84B4 87          	ADD A,A
0300+++84B5 5F          	LD E,A
0301+++84B6 19          	ADD HL,DE
0302+++84B7 5E          	LD E,(HL)
0303+++84B8 23          	INC HL
0304+++84B9 CB 3B       	SRL E
0305+++84BB 9F          	SBC A,A
0306+++84BC E6 A7       	AND #A7 ;#00 (NOP) or #A7 (AND A)
0307+++84BE 32 E6 84    	LD (L3),A
0308+++84C1 EB          	EX DE,HL
0309+++84C2 01 6E 8D    	LD BC,T1_
0310+++84C5 09          	ADD HL,BC
0311+++84C6             
0312+++84C6 1A          	LD A,(DE)
0313+++84C7 C6 E7       	ADD A,T_&255
0314+++84C9 4F          	LD C,A
0315+++84CA CE 8B       	ADC A,T_/256
0316+++84CC 91          	SUB C
0317+++84CD 47          	LD B,A
0318+++84CE C5          	PUSH BC
0319+++84CF 11 5E 8E    	LD DE,NT_
0320+++84D2 D5          	PUSH DE
0321+++84D3             
0322+++84D3 06 0C       	LD B,12
0323+++84D5 C5          L1	PUSH BC
0324+++84D6 4E          	LD C,(HL)
0325+++84D7 23          	INC HL
0326+++84D8 E5          	PUSH HL
0327+++84D9 46          	LD B,(HL)
0328+++84DA             
0329+++84DA D5          	PUSH DE
0330+++84DB EB          	EX DE,HL
0331+++84DC 11 17 00    	LD DE,23
0332+++84DF DD 26 08    	LD IXH,8
0333+++84E2             
0334+++84E2 CB 38       L2	SRL B
0335+++84E4 CB 19       	RR C
0336+++84E6 19          L3	DB #19	;AND A or NOP
0337+++84E7 79          	LD A,C
0338+++84E8 8A          	ADC A,D	;=ADC 0
0339+++84E9 77          	LD (HL),A
0340+++84EA 23          	INC HL
0341+++84EB 78          	LD A,B
0342+++84EC 8A          	ADC A,D
0343+++84ED 77          	LD (HL),A
0344+++84EE 19          	ADD HL,DE
0345+++84EF DD 25       	DEC IXH
0346+++84F1 20 EF       	JR NZ,L2
0347+++84F3             
0348+++84F3 D1          	POP DE
0349+++84F4 13          	INC DE
0350+++84F5 13          	INC DE
0351+++84F6 E1          	POP HL
0352+++84F7 23          	INC HL
0353+++84F8 C1          	POP BC
0354+++84F9 10 DA       	DJNZ L1
0355+++84FB             
0356+++84FB E1          	POP HL
0357+++84FC D1          	POP DE
0358+++84FD             
0359+++84FD 7B          	LD A,E
0360+++84FE FE F3       	CP TCOLD_1&255
0361+++8500 20 05       	JR NZ,CORR_1
0362+++8502 3E FD       	LD A,#FD
0363+++8504 32 8C 8E    	LD (NT_+#2E),A
0364+++8507             
0365+++8507 1A          CORR_1	LD A,(DE)
0366+++8508 A7          	AND A
0367+++8509 28 11       	JR Z,TC_EXIT
0368+++850B 1F          	RRA
0369+++850C F5          	PUSH AF
0370+++850D 87          	ADD A,A
0371+++850E 4F          	LD C,A
0372+++850F 09          	ADD HL,BC
0373+++8510 F1          	POP AF
0374+++8511 30 02       	JR NC,CORR_2
0375+++8513 35          	DEC (HL)
0376+++8514 35          	DEC (HL)
0377+++8515 34          CORR_2	INC (HL)
0378+++8516 A7          	AND A
0379+++8517 ED 42       	SBC HL,BC
0380+++8519 13          	INC DE
0381+++851A 18 EB       	JR CORR_1
0382+++851C             
0383+++851C             TC_EXIT
0384+++851C             
0385+++851C F1          	POP AF
0386+++851D             
0387+++851D             ;VolTableCreator (c) Ivan Roshin
0388+++851D             ;A - VersionForVolumeTable (0..4 - 3.xx..3.4x;
0389+++851D             			   ;5.. - 2.x,3.5x..3.6x..VTII1.0)
0390+++851D             
0391+++851D FE 05       	CP 5
0392+++851F 21 11 00    	LD HL,#11
0393+++8522 54          	LD D,H
0394+++8523 5C          	LD E,H
0395+++8524 3E 17       	LD A,#17
0396+++8526 30 03       	JR NC,M1
0397+++8528 2D          	DEC L
0398+++8529 5D          	LD E,L
0399+++852A AF          	XOR A
0400+++852B 32 3C 85    M1      LD (M2),A
0401+++852E             
0402+++852E DD 21 6E 8D 	LD IX,VT_+16
0403+++8532             
0404+++8532 0E 0F       	LD C,#F
0405+++8534 E5          INITV2  PUSH HL
0406+++8535             
0407+++8535 19          	ADD HL,DE
0408+++8536 EB          	EX DE,HL
0409+++8537 ED 62       	SBC HL,HL
0410+++8539             
0411+++8539 06 10       	LD B,#10
0412+++853B 7D          INITV1  LD A,L
0413+++853C 7D          M2      DB #7D
0414+++853D 7C          	LD A,H
0415+++853E CE 00       	ADC A,0
0416+++8540 DD 77 00    	LD (IX),A
0417+++8543 DD 23       	INC IX
0418+++8545 19          	ADD HL,DE
0419+++8546 10 F3       	DJNZ INITV1
0420+++8548             
0421+++8548 E1          	POP HL
0422+++8549 7B          	LD A,E
0423+++854A FE 77       	CP #77
0424+++854C 20 01       	JR NZ,M3
0425+++854E 1C          	INC E
0426+++854F 0D          M3      DEC C
0427+++8550 20 E2       	JR NZ,INITV2
0428+++8552             
0429+++8552 C3 93 8B    	JP ROUT
0430+++8555             
0431+++8555 CD C8 85    INITPT3	CALL SETMDAD
0432+++8558 E5          	PUSH HL
0433+++8559 11 64 00    	LD DE,100
0434+++855C 19          	ADD HL,DE
0435+++855D 7E          	LD A,(HL)
0436+++855E FD 77 08    	LD (IY-100+VRS.Delay),A
0437+++8561 E5          	PUSH HL
0438+++8562 DD E1       	POP IX
0439+++8564 19          	ADD HL,DE
0440+++8565 CD D6 85    	CALL SETCPPT
0441+++8568 DD 5E 02    	LD E,(IX+102-100)
0442+++856B 23          	INC HL
0443+++856C             
0444+++856C             	IF CurPosCounter
0445+++856C~            	LD (IY-100+VRS.PosSub),L
0446+++856C             	ENDIF
0447+++856C             
0448+++856C 19          	ADD HL,DE
0449+++856D CD DD 85    	CALL SETLPPT
0450+++8570 D1          	POP DE
0451+++8571 DD 6E 03    	LD L,(IX+103-100)
0452+++8574 DD 66 04    	LD H,(IX+104-100)
0453+++8577 19          	ADD HL,DE
0454+++8578 CD C1 85    	CALL SETPTPT
0455+++857B 21 A9 00    	LD HL,169
0456+++857E 19          	ADD HL,DE
0457+++857F CD CF 85    	CALL SETORPT
0458+++8582 21 69 00    	LD HL,105
0459+++8585 19          	ADD HL,DE
0460+++8586             
0461+++8586 FD 75 FA    SETSMPT LD (IY-100+VRS.SamPtrs),L
0462+++8589 FD 74 FB    	LD (IY-100+VRS.SamPtrs+1),H
0463+++858C C9          	RET
0464+++858D             
0465+++858D 7E          INITPT2	LD A,(HL)
0466+++858E FD 77 08    	LD (IY-100+VRS.Delay),A
0467+++8591 E5          	PUSH HL
0468+++8592 E5          	PUSH HL
0469+++8593 E5          	PUSH HL
0470+++8594 23          	INC HL
0471+++8595 23          	INC HL
0472+++8596 7E          	LD A,(HL)
0473+++8597 23          	INC HL
0474+++8598 CD 86 85    	CALL SETSMPT
0475+++859B 5E          	LD E,(HL)
0476+++859C 23          	INC HL
0477+++859D 56          	LD D,(HL)
0478+++859E E1          	POP HL
0479+++859F A7          	AND A
0480+++85A0 ED 52       	SBC HL,DE
0481+++85A2 CD C8 85    	CALL SETMDAD
0482+++85A5 E1          	POP HL
0483+++85A6 11 43 00    	LD DE,67
0484+++85A9 19          	ADD HL,DE
0485+++85AA CD CF 85    	CALL SETORPT
0486+++85AD 1E 20       	LD E,32
0487+++85AF 19          	ADD HL,DE
0488+++85B0 4E          	LD C,(HL)
0489+++85B1 23          	INC HL
0490+++85B2 46          	LD B,(HL)
0491+++85B3 1E 1E       	LD E,30
0492+++85B5 19          	ADD HL,DE
0493+++85B6 CD D6 85    	CALL SETCPPT
0494+++85B9 5F          	LD E,A
0495+++85BA 23          	INC HL
0496+++85BB             
0497+++85BB             	IF CurPosCounter
0498+++85BB~            	LD (IY-100+VRS.PosSub),L
0499+++85BB             	ENDIF
0500+++85BB             
0501+++85BB 19          	ADD HL,DE
0502+++85BC CD DD 85    	CALL SETLPPT
0503+++85BF E1          	POP HL
0504+++85C0 09          	ADD HL,BC
0505+++85C1             
0506+++85C1 FD 75 FC    SETPTPT	LD (IY-100+VRS.PatsPtr),L
0507+++85C4 FD 74 FD    	LD (IY-100+VRS.PatsPtr+1),H
0508+++85C7 C9          	RET
0509+++85C8             
0510+++85C8 FD 75 F6    SETMDAD	LD (IY-100+VRS.MODADDR),L
0511+++85CB FD 74 F7    	LD (IY-100+VRS.MODADDR+1),H
0512+++85CE C9          	RET
0513+++85CF             
0514+++85CF FD 75 F8    SETORPT	LD (IY-100+VRS.OrnPtrs),L
0515+++85D2 FD 74 F9    	LD (IY-100+VRS.OrnPtrs+1),H
0516+++85D5 C9          	RET
0517+++85D6             
0518+++85D6 FD 75 04    SETCPPT	LD (IY-100+VRS.CrPsPtr),L
0519+++85D9 FD 74 05    	LD (IY-100+VRS.CrPsPtr+1),H
0520+++85DC C9          	RET
0521+++85DD             
0522+++85DD FD 75 06    SETLPPT	LD (IY-100+VRS.LPosPtr),L
0523+++85E0 FD 74 07    	LD (IY-100+VRS.LPosPtr+1),H
0524+++85E3 C9          	RET
0525+++85E4             
0526+++85E4 FD 75 13    SETENBS	LD (IY-100+VRS.EnvBase),L
0527+++85E7 FD 74 14    	LD (IY-100+VRS.EnvBase+1),H
0528+++85EA C9          	RET
0529+++85EB             
0530+++85EB FD 75 0C    SETESLD	LD (IY-100+VRS.CurESld),L
0531+++85EE FD 74 0D    	LD (IY-100+VRS.CurESld+1),H
0532+++85F1 C9          	RET
0533+++85F2             
0534+++85F2 FD E5       GETIX	PUSH IY
0535+++85F4 DD E1       	POP IX
0536+++85F6 DD 19       	ADD IX,DE
0537+++85F8 C9          	RET
0538+++85F9             
0539+++85F9 CD F2 85    PTDECOD CALL GETIX
0540+++85FC             PTDEC	EQU $+1
0541+++85FC C3 C3 C3    	JP #C3C3
0542+++85FF             
0543+++85FF             ;PT2 pattern decoder
0544+++85FF CD 95 88    PD2_SAM	CALL SETSAM
0545+++8602 18 4A       	JR PD2_LOOP
0546+++8604             
0547+++8604 DD 77 08    PD2_EOff LD (IX-12+CHP.Env_En),A
0548+++8607 18 45       	JR PD2_LOOP
0549+++8609             
0550+++8609 DD 36 08 10 PD2_ENV	LD (IX-12+CHP.Env_En),16
0551+++860D FD 77 22    	LD (IY-100+VRS.AYREGS+EnvTp),A
0552+++8610 0A          	LD A,(BC)
0553+++8611 03          	INC BC
0554+++8612 6F          	LD L,A
0555+++8613 0A          	LD A,(BC)
0556+++8614 03          	INC BC
0557+++8615 67          	LD H,A
0558+++8616 CD E4 85    	CALL SETENBS
0559+++8619 18 33       	JR PD2_LOOP
0560+++861B             
0561+++861B CD 76 88    PD2_ORN	CALL SETORN
0562+++861E 18 2E       	JR PD2_LOOP
0563+++8620             
0564+++8620 3C          PD2_SKIP INC A
0565+++8621 DD 77 05    	LD (IX-12+CHP.NNtSkp),A
0566+++8624 18 28       	JR PD2_LOOP
0567+++8626             
0568+++8626 0F          PD2_VOL	RRCA
0569+++8627 0F          	RRCA
0570+++8628 0F          	RRCA
0571+++8629 0F          	RRCA
0572+++862A DD 77 10    	LD (IX-12+CHP.Volume),A
0573+++862D 18 1F       	JR PD2_LOOP
0574+++862F             
0575+++862F CD 46 88    PD2_DEL	CALL C_DELAY
0576+++8632 18 1A       	JR PD2_LOOP
0577+++8634             
0578+++8634 DD CB 09 D6 PD2_GLIS SET 2,(IX-12+CHP.Flags)
0579+++8638 3C          	INC A
0580+++8639 DD 77 0A    	LD (IX-12+CHP.TnSlDl),A
0581+++863C DD 77 F9    	LD (IX-12+CHP.TSlCnt),A
0582+++863F 0A          	LD A,(BC)
0583+++8640 03          	INC BC
0584+++8641 DD 77 0B            LD (IX-12+CHP.TSlStp),A
0585+++8644 87          	ADD A,A
0586+++8645 9F          	SBC A,A
0587+++8646 DD 77 0C            LD (IX-12+CHP.TSlStp+1),A
0588+++8649 37          	SCF
0589+++864A 18 01       	JR PD2_LP2
0590+++864C             
0591+++864C A7          PT2PD	AND A
0592+++864D             
0593+++864D 08          PD2_LP2	EX AF,AF'
0594+++864E             
0595+++864E 0A          PD2_LOOP LD A,(BC)
0596+++864F 03          	INC BC
0597+++8650 C6 20       	ADD A,#20
0598+++8652 28 3F       	JR Z,PD2_REL
0599+++8654 38 A9       	JR C,PD2_SAM
0600+++8656 C6 60       	ADD A,96
0601+++8658 38 3E       	JR C,PD2_NOTE
0602+++865A 3C          	INC A
0603+++865B 28 A7       	JR Z,PD2_EOff
0604+++865D C6 0F       	ADD A,15
0605+++865F CA 75 87    	JP Z,PD_FIN
0606+++8662 38 A5       	JR C,PD2_ENV
0607+++8664 C6 10       	ADD A,#10
0608+++8666 38 B3       	JR C,PD2_ORN
0609+++8668 C6 40       	ADD A,#40
0610+++866A 38 B4       	JR C,PD2_SKIP
0611+++866C C6 10       	ADD A,#10
0612+++866E 38 B6       	JR C,PD2_VOL
0613+++8670 3C          	INC A
0614+++8671 28 BC       	JR Z,PD2_DEL
0615+++8673 3C          	INC A
0616+++8674 28 BE       	JR Z,PD2_GLIS
0617+++8676 3C          	INC A
0618+++8677 28 0A       	JR Z,PD2_PORT
0619+++8679 3C          	INC A
0620+++867A 28 12       	JR Z,PD2_STOP
0621+++867C 0A          	LD A,(BC)
0622+++867D 03          	INC BC
0623+++867E DD 77 F7    	LD (IX-12+CHP.CrNsSl),A
0624+++8681 18 CB       	JR PD2_LOOP
0625+++8683             
0626+++8683 DD CB 09 96 PD2_PORT RES 2,(IX-12+CHP.Flags)
0627+++8687 0A          	LD A,(BC)
0628+++8688 03          	INC BC
0629+++8689 03          	INC BC ;ignoring precalc delta to right sound
0630+++868A 03          	INC BC
0631+++868B 37          	SCF
0632+++868C 18 BF       	JR PD2_LP2
0633+++868E             
0634+++868E DD 77 F9    PD2_STOP LD (IX-12+CHP.TSlCnt),A
0635+++8691 18 BB       	JR PD2_LOOP
0636+++8693             
0637+++8693 DD 77 09    PD2_REL	LD (IX-12+CHP.Flags),A
0638+++8696 18 2C       	JR PD2_EXIT
0639+++8698             
0640+++8698 6F          PD2_NOTE LD L,A
0641+++8699 DD 7E 06    	LD A,(IX-12+CHP.Note)
0642+++869C 32 AF 87    	LD (PrNote+1),A
0643+++869F DD 75 06    	LD (IX-12+CHP.Note),L
0644+++86A2 AF          	XOR A
0645+++86A3 DD 77 F9    	LD (IX-12+CHP.TSlCnt),A
0646+++86A6 DD CB 09 C6 	SET 0,(IX-12+CHP.Flags)
0647+++86AA 08          	EX AF,AF'
0648+++86AB 30 16       	JR NC,NOGLIS2
0649+++86AD DD CB 09 56 	BIT 2,(IX-12+CHP.Flags)
0650+++86B1 20 0C       	JR NZ,NOPORT2
0651+++86B3 32 D5 87    	LD (LoStep),A
0652+++86B6 87          	ADD A,A
0653+++86B7 9F          	SBC A,A
0654+++86B8 08          	EX AF,AF'
0655+++86B9 67          	LD H,A
0656+++86BA 6F          	LD L,A
0657+++86BB 3C          	INC A
0658+++86BC CD 90 87    	CALL SETPORT
0659+++86BF DD 36 F9 01 NOPORT2	LD (IX-12+CHP.TSlCnt),1
0660+++86C3 AF          NOGLIS2	XOR A
0661+++86C4             
0662+++86C4             
0663+++86C4 DD 77 F5    PD2_EXIT LD (IX-12+CHP.PsInSm),A
0664+++86C7 DD 77 F4    	LD (IX-12+CHP.PsInOr),A
0665+++86CA DD 77 FA    	LD (IX-12+CHP.CrTnSl),A
0666+++86CD DD 77 FB    	LD (IX-12+CHP.CrTnSl+1),A
0667+++86D0 C3 75 87    	JP PD_FIN
0668+++86D3             
0669+++86D3             ;PT3 pattern decoder
0670+++86D3 DD 36 08 00 PD_OrSm	LD (IX-12+CHP.Env_En),0
0671+++86D7 CD 76 88    	CALL SETORN
0672+++86DA 0A          PD_SAM_	LD A,(BC)
0673+++86DB 03          	INC BC
0674+++86DC 0F          	RRCA
0675+++86DD             
0676+++86DD CD 95 88    PD_SAM	CALL SETSAM
0677+++86E0 18 3F       	JR PD_LOOP
0678+++86E2             
0679+++86E2 0F          PD_VOL	RRCA
0680+++86E3 0F          	RRCA
0681+++86E4 0F          	RRCA
0682+++86E5 0F          	RRCA
0683+++86E6 DD 77 10    	LD (IX-12+CHP.Volume),A
0684+++86E9 18 39       	JR PD_LP2
0685+++86EB             	
0686+++86EB DD 77 08    PD_EOff	LD (IX-12+CHP.Env_En),A
0687+++86EE DD 77 F4    	LD (IX-12+CHP.PsInOr),A
0688+++86F1 18 31       	JR PD_LP2
0689+++86F3             
0690+++86F3 3D          PD_SorE	DEC A
0691+++86F4 20 07       	JR NZ,PD_ENV
0692+++86F6 0A          	LD A,(BC)
0693+++86F7 03          	INC BC
0694+++86F8 DD 77 05    	LD (IX-12+CHP.NNtSkp),A
0695+++86FB 18 27       	JR PD_LP2
0696+++86FD             
0697+++86FD CD 5B 88    PD_ENV	CALL SETENV
0698+++8700 18 22       	JR PD_LP2
0699+++8702             
0700+++8702 CD 76 88    PD_ORN	CALL SETORN
0701+++8705 18 1A       	JR PD_LOOP
0702+++8707             
0703+++8707 DD 77 08    PD_ESAM	LD (IX-12+CHP.Env_En),A
0704+++870A DD 77 F4    	LD (IX-12+CHP.PsInOr),A
0705+++870D C4 5B 88    	CALL NZ,SETENV
0706+++8710 18 C8       	JR PD_SAM_
0707+++8712             
0708+++8712 DD 7E 06    PT3PD	LD A,(IX-12+CHP.Note)
0709+++8715 32 AF 87    	LD (PrNote+1),A
0710+++8718 DD 6E FA    	LD L,(IX-12+CHP.CrTnSl)
0711+++871B DD 66 FB    	LD H,(IX-12+CHP.CrTnSl+1)
0712+++871E 22 CC 87    	LD (PrSlide+1),HL
0713+++8721             
0714+++8721 11 10 20    PD_LOOP	LD DE,#2010
0715+++8724 0A          PD_LP2	LD A,(BC)
0716+++8725 03          	INC BC
0717+++8726 83          	ADD A,E
0718+++8727 38 AA       	JR C,PD_OrSm
0719+++8729 82          	ADD A,D
0720+++872A 28 49       	JR Z,PD_FIN
0721+++872C 38 AF       	JR C,PD_SAM
0722+++872E 83          	ADD A,E
0723+++872F 28 25       	JR Z,PD_REL
0724+++8731 38 AF       	JR C,PD_VOL
0725+++8733 83          	ADD A,E
0726+++8734 28 B5       	JR Z,PD_EOff
0727+++8736 38 BB       	JR C,PD_SorE
0728+++8738 C6 60       	ADD A,96
0729+++873A 38 20       	JR C,PD_NOTE
0730+++873C 83          	ADD A,E
0731+++873D 38 C3       	JR C,PD_ORN
0732+++873F 82          	ADD A,D
0733+++8740 38 0F       	JR C,PD_NOIS
0734+++8742 83          	ADD A,E
0735+++8743 38 C2       	JR C,PD_ESAM
0736+++8745 87          	ADD A,A
0737+++8746 5F          	LD E,A
0738+++8747 21 D1 67    	LD HL,(SPCCOMS+#FF20-#2000)&65535
0739+++874A 19          	ADD HL,DE
0740+++874B 5E          	LD E,(HL)
0741+++874C 23          	INC HL
0742+++874D 56          	LD D,(HL)
0743+++874E D5          	PUSH DE
0744+++874F 18 D0       	JR PD_LOOP
0745+++8751             
0746+++8751 FD 77 10    PD_NOIS	LD (IY-100+VRS.Ns_Base),A
0747+++8754 18 CE       	JR PD_LP2
0748+++8756             
0749+++8756 DD CB 09 86 PD_REL	RES 0,(IX-12+CHP.Flags)
0750+++875A 18 08       	JR PD_RES
0751+++875C             
0752+++875C DD 77 06    PD_NOTE	LD (IX-12+CHP.Note),A
0753+++875F DD CB 09 C6 	SET 0,(IX-12+CHP.Flags)
0754+++8763 AF          	XOR A
0755+++8764             
0756+++8764 ED 73 73 87 PD_RES	LD (PDSP_+1),SP
0757+++8768 DD F9       	LD SP,IX
0758+++876A 67          	LD H,A
0759+++876B 6F          	LD L,A
0760+++876C E5          	PUSH HL
0761+++876D E5          	PUSH HL
0762+++876E E5          	PUSH HL
0763+++876F E5          	PUSH HL
0764+++8770 E5          	PUSH HL
0765+++8771 E5          	PUSH HL
0766+++8772 31 31 31    PDSP_	LD SP,#3131
0767+++8775             
0768+++8775 DD 7E 05    PD_FIN	LD A,(IX-12+CHP.NNtSkp)
0769+++8778 DD 77 0F    	LD (IX-12+CHP.NtSkCn),A
0770+++877B C9          	RET
0771+++877C             
0772+++877C 0A          C_PORTM LD A,(BC)
0773+++877D 03          	INC BC
0774+++877E             ;SKIP PRECALCULATED TONE DELTA (BECAUSE
0775+++877E             ;CANNOT BE RIGHT AFTER PT3 COMPILATION)
0776+++877E 03          	INC BC
0777+++877F 03          	INC BC
0778+++8780 08          	EX AF,AF'
0779+++8781 0A          	LD A,(BC) ;SIGNED TONE STEP
0780+++8782 03          	INC BC
0781+++8783 32 D5 87    	LD (LoStep),A
0782+++8786 0A          	LD A,(BC)
0783+++8787 03          	INC BC
0784+++8788 A7          	AND A
0785+++8789 08          	EX AF,AF'
0786+++878A DD 6E FA    	LD L,(IX-12+CHP.CrTnSl)
0787+++878D DD 66 FB    	LD H,(IX-12+CHP.CrTnSl+1)
0788+++8790             
0789+++8790             ;Set portamento variables
0790+++8790             ;A - Delay; A' - Hi(Step); ZF' - (A'=0); HL - CrTnSl
0791+++8790             
0792+++8790 DD CB 09 96 SETPORT	RES 2,(IX-12+CHP.Flags)
0793+++8794 DD 77 0A    	LD (IX-12+CHP.TnSlDl),A
0794+++8797 DD 77 F9    	LD (IX-12+CHP.TSlCnt),A
0795+++879A E5          	PUSH HL
0796+++879B 11 5E 8E    	LD DE,NT_
0797+++879E DD 7E 06    	LD A,(IX-12+CHP.Note)
0798+++87A1 DD 77 07    	LD (IX-12+CHP.SlToNt),A
0799+++87A4 87          	ADD A,A
0800+++87A5 6F          	LD L,A
0801+++87A6 26 00       	LD H,0
0802+++87A8 19          	ADD HL,DE
0803+++87A9 7E          	LD A,(HL)
0804+++87AA 23          	INC HL
0805+++87AB 66          	LD H,(HL)
0806+++87AC 6F          	LD L,A
0807+++87AD E5          	PUSH HL
0808+++87AE 3E 3E       PrNote	LD A,#3E
0809+++87B0 DD 77 06    	LD (IX-12+CHP.Note),A
0810+++87B3 87          	ADD A,A
0811+++87B4 6F          	LD L,A
0812+++87B5 26 00       	LD H,0
0813+++87B7 19          	ADD HL,DE
0814+++87B8 5E          	LD E,(HL)
0815+++87B9 23          	INC HL
0816+++87BA 56          	LD D,(HL)
0817+++87BB E1          	POP HL
0818+++87BC ED 52       	SBC HL,DE
0819+++87BE DD 75 0D    	LD (IX-12+CHP.TnDelt),L
0820+++87C1 DD 74 0E    	LD (IX-12+CHP.TnDelt+1),H
0821+++87C4 D1          	POP DE
0822+++87C5             Version EQU $+1
0823+++87C5 3E 3E       	LD A,#3E
0824+++87C7 FE 06       	CP 6
0825+++87C9 38 09       	JR C,OLDPRTM ;Old 3xxx for PT v3.5-
0826+++87CB 11 11 11    PrSlide	LD DE,#1111
0827+++87CE DD 73 FA    	LD (IX-12+CHP.CrTnSl),E
0828+++87D1 DD 72 FB    	LD (IX-12+CHP.CrTnSl+1),D
0829+++87D4             LoStep	EQU $+1
0830+++87D4 3E 3E       OLDPRTM	LD A,#3E
0831+++87D6 08          	EX AF,AF'
0832+++87D7 28 01       	JR Z,NOSIG
0833+++87D9 EB          	EX DE,HL
0834+++87DA ED 52       NOSIG	SBC HL,DE
0835+++87DC F2 E4 87    	JP P,SET_STP
0836+++87DF 2F          	CPL
0837+++87E0 08          	EX AF,AF'
0838+++87E1 ED 44       	NEG
0839+++87E3 08          	EX AF,AF'
0840+++87E4 DD 77 0C    SET_STP	LD (IX-12+CHP.TSlStp+1),A
0841+++87E7 08          	EX AF,AF'
0842+++87E8 DD 77 0B    	LD (IX-12+CHP.TSlStp),A
0843+++87EB DD 36 FE 00 	LD (IX-12+CHP.COnOff),0
0844+++87EF C9          	RET
0845+++87F0             
0846+++87F0 DD CB 09 D6 C_GLISS	SET 2,(IX-12+CHP.Flags)
0847+++87F4 0A          	LD A,(BC)
0848+++87F5 03          	INC BC
0849+++87F6 DD 77 0A    	LD (IX-12+CHP.TnSlDl),A
0850+++87F9 A7          	AND A
0851+++87FA 20 07       	JR NZ,GL36
0852+++87FC 3A C6 87    	LD A,(Version) ;AlCo PT3.7+
0853+++87FF FE 07       	CP 7
0854+++8801 9F          	SBC A,A
0855+++8802 3C          	INC A
0856+++8803 DD 77 F9    GL36	LD (IX-12+CHP.TSlCnt),A
0857+++8806 0A          	LD A,(BC)
0858+++8807 03          	INC BC
0859+++8808 08          	EX AF,AF'
0860+++8809 0A          	LD A,(BC)
0861+++880A 03          	INC BC
0862+++880B 18 D7       	JR SET_STP
0863+++880D             
0864+++880D 0A          C_SMPOS	LD A,(BC)
0865+++880E 03          	INC BC
0866+++880F DD 77 F5    	LD (IX-12+CHP.PsInSm),A
0867+++8812 C9          	RET
0868+++8813             
0869+++8813 0A          C_ORPOS	LD A,(BC)
0870+++8814 03          	INC BC
0871+++8815 DD 77 F4    	LD (IX-12+CHP.PsInOr),A
0872+++8818 C9          	RET
0873+++8819             
0874+++8819 0A          C_VIBRT	LD A,(BC)
0875+++881A 03          	INC BC
0876+++881B DD 77 FF    	LD (IX-12+CHP.OnOffD),A
0877+++881E DD 77 FE    	LD (IX-12+CHP.COnOff),A
0878+++8821 0A          	LD A,(BC)
0879+++8822 03          	INC BC
0880+++8823 DD 77 00    	LD (IX-12+CHP.OffOnD),A
0881+++8826 AF          	XOR A
0882+++8827 DD 77 F9    	LD (IX-12+CHP.TSlCnt),A
0883+++882A DD 77 FA    	LD (IX-12+CHP.CrTnSl),A
0884+++882D DD 77 FB    	LD (IX-12+CHP.CrTnSl+1),A
0885+++8830 C9          	RET
0886+++8831             
0887+++8831 0A          C_ENGLS	LD A,(BC)
0888+++8832 03          	INC BC
0889+++8833 FD 77 0E    	LD (IY-100+VRS.Env_Del),A
0890+++8836 FD 77 0F    	LD (IY-100+VRS.CurEDel),A
0891+++8839 0A          	LD A,(BC)
0892+++883A 03          	INC BC
0893+++883B 6F          	LD L,A
0894+++883C 0A          	LD A,(BC)
0895+++883D 03          	INC BC
0896+++883E 67          	LD H,A
0897+++883F FD 75 0A    	LD (IY-100+VRS.ESldAdd),L
0898+++8842 FD 74 0B    	LD (IY-100+VRS.ESldAdd+1),H
0899+++8845 C9          	RET
0900+++8846             
0901+++8846 0A          C_DELAY	LD A,(BC)
0902+++8847 03          	INC BC
0903+++8848 FD 77 08    	LD (IY-100+VRS.Delay),A
0904+++884B 21 E9 8C    	LD HL,VARS2+VRS.ModNum ;if AlCo_TS
0905+++884E CB 4E       	BIT 1,(HL)
0906+++8850 C8          	RET Z
0907+++8851 32 CC 8C    	LD (VARS1+VRS.Delay),A
0908+++8854 32 CD 8C    	LD (VARS1+VRS.DelyCnt),A
0909+++8857 32 53 8D    	LD (VARS2+VRS.Delay),A
0910+++885A C9          	RET
0911+++885B             	
0912+++885B DD 73 08    SETENV	LD (IX-12+CHP.Env_En),E
0913+++885E FD 77 22    	LD (IY-100+VRS.AYREGS+EnvTp),A
0914+++8861 0A          	LD A,(BC)
0915+++8862 03          	INC BC
0916+++8863 67          	LD H,A
0917+++8864 0A          	LD A,(BC)
0918+++8865 03          	INC BC
0919+++8866 6F          	LD L,A
0920+++8867 CD E4 85    	CALL SETENBS
0921+++886A AF          	XOR A
0922+++886B DD 77 F4    	LD (IX-12+CHP.PsInOr),A
0923+++886E FD 77 0F    	LD (IY-100+VRS.CurEDel),A
0924+++8871 67          	LD H,A
0925+++8872 6F          	LD L,A
0926+++8873 C3 EB 85    	JP SETESLD
0927+++8876             
0928+++8876 87          SETORN	ADD A,A
0929+++8877 5F          	LD E,A
0930+++8878 16 00       	LD D,0
0931+++887A DD 72 F4    	LD (IX-12+CHP.PsInOr),D
0932+++887D FD 6E F8    	LD L,(IY-100+VRS.OrnPtrs)
0933+++8880 FD 66 F9    	LD H,(IY-100+VRS.OrnPtrs+1)
0934+++8883 19          	ADD HL,DE
0935+++8884 5E          	LD E,(HL)
0936+++8885 23          	INC HL
0937+++8886 56          	LD D,(HL)
0938+++8887 FD 6E F6    	LD L,(IY-100+VRS.MODADDR)
0939+++888A FD 66 F7    	LD H,(IY-100+VRS.MODADDR+1)
0940+++888D 19          	ADD HL,DE
0941+++888E DD 75 01    	LD (IX-12+CHP.OrnPtr),L
0942+++8891 DD 74 02    	LD (IX-12+CHP.OrnPtr+1),H
0943+++8894 C9          C_NOP	RET
0944+++8895             
0945+++8895 87          SETSAM	ADD A,A
0946+++8896 5F          	LD E,A
0947+++8897 16 00       	LD D,0
0948+++8899 FD 6E FA    	LD L,(IY-100+VRS.SamPtrs);
0949+++889C FD 66 FB    	LD H,(IY-100+VRS.SamPtrs+1);
0950+++889F 19          	ADD HL,DE
0951+++88A0 5E          	LD E,(HL)
0952+++88A1 23          	INC HL
0953+++88A2 56          	LD D,(HL)
0954+++88A3 FD 6E F6    	LD L,(IY-100+VRS.MODADDR)
0955+++88A6 FD 66 F7    	LD H,(IY-100+VRS.MODADDR+1)
0956+++88A9 19          	ADD HL,DE
0957+++88AA DD 75 03    	LD (IX-12+CHP.SamPtr),L
0958+++88AD DD 74 04    	LD (IX-12+CHP.SamPtr+1),H
0959+++88B0 C9          	RET
0960+++88B1             
0961+++88B1             ;ALL 16 ADDRESSES TO PROTECT FROM BROKEN PT3 MODULES
0962+++88B1 94 88       SPCCOMS DW C_NOP
0963+++88B3 F0 87       	DW C_GLISS
0964+++88B5 7C 87       	DW C_PORTM
0965+++88B7 0D 88       	DW C_SMPOS
0966+++88B9 13 88       	DW C_ORPOS
0967+++88BB 19 88       	DW C_VIBRT
0968+++88BD 94 88       	DW C_NOP
0969+++88BF 94 88       	DW C_NOP
0970+++88C1 31 88       	DW C_ENGLS
0971+++88C3 46 88       	DW C_DELAY
0972+++88C5 94 88       	DW C_NOP
0973+++88C7 94 88       	DW C_NOP
0974+++88C9 94 88       	DW C_NOP
0975+++88CB 94 88       	DW C_NOP
0976+++88CD 94 88       	DW C_NOP
0977+++88CF 94 88       	DW C_NOP
0978+++88D1             
0979+++88D1 CD F2 85    CHREGS	CALL GETIX
0980+++88D4 AF          	XOR A
0981+++88D5 32 0E 8B    	LD (Ampl),A
0982+++88D8 DD CB 15 46 	BIT 0,(IX+CHP.Flags)
0983+++88DC E5          	PUSH HL
0984+++88DD CA 24 8A    	JP Z,CH_EXIT
0985+++88E0 ED 73 6E 89 	LD (CSP_+1),SP
0986+++88E4 DD 6E 0D    	LD L,(IX+CHP.OrnPtr)
0987+++88E7 DD 66 0E    	LD H,(IX+CHP.OrnPtr+1)
0988+++88EA F9          	LD SP,HL
0989+++88EB D1          	POP DE
0990+++88EC 67          	LD H,A
0991+++88ED DD 7E 00    	LD A,(IX+CHP.PsInOr)
0992+++88F0 6F          	LD L,A
0993+++88F1 39          	ADD HL,SP
0994+++88F2 3C          	INC A
0995+++88F3             		;PT2	PT3
0996+++88F3 3C          OrnCP	INC A	;CP E	CP D
0997+++88F4 38 01       	JR C,CH_ORPS
0998+++88F6 01          OrnLD	DB 1	;LD A,D	LD A,E
0999+++88F7 DD 77 00    CH_ORPS	LD (IX+CHP.PsInOr),A
1000+++88FA DD 7E 12    	LD A,(IX+CHP.Note)
1001+++88FD 86          	ADD A,(HL)
1002+++88FE F2 02 89    	JP P,CH_NTP
1003+++8901 AF          	XOR A
1004+++8902 FE 60       CH_NTP	CP 96
1005+++8904 38 02       	JR C,CH_NOK
1006+++8906 3E 5F       	LD A,95
1007+++8908 87          CH_NOK	ADD A,A
1008+++8909 08          	EX AF,AF'
1009+++890A DD 6E 0F    	LD L,(IX+CHP.SamPtr)
1010+++890D DD 66 10    	LD H,(IX+CHP.SamPtr+1)
1011+++8910 F9          	LD SP,HL
1012+++8911 D1          	POP DE
1013+++8912 26 00       	LD H,0
1014+++8914 DD 7E 01    	LD A,(IX+CHP.PsInSm)
1015+++8917 47          	LD B,A
1016+++8918 87          	ADD A,A
1017+++8919 87          SamClc2	ADD A,A ;or ADD A,B for PT2
1018+++891A 6F          	LD L,A
1019+++891B 39          	ADD HL,SP
1020+++891C F9          	LD SP,HL
1021+++891D 78          	LD A,B
1022+++891E 3C          	INC A
1023+++891F             		;PT2	PT3
1024+++891F 3C          SamCP	INC A	;CP E	CP D
1025+++8920 38 01       	JR C,CH_SMPS
1026+++8922 01          SamLD	DB 1	;LD A,D	LD A,E
1027+++8923 DD 77 01    CH_SMPS	LD (IX+CHP.PsInSm),A
1028+++8926 C1          	POP BC
1029+++8927 E1          	POP HL
1030+++8928             
1031+++8928             ;Convert PT2 sample to PT3
1032+++8928             		;PT2		PT3
1033+++8928 E1          SamCnv	POP HL  ;BIT 2,C	JR e_
1034+++8929 E1          	POP HL	
1035+++892A 60          	LD H,B
1036+++892B 20 06       	JR NZ,$+8
1037+++892D EB          	EX DE,HL
1038+++892E A7          	AND A
1039+++892F ED 62       	SBC HL,HL
1040+++8931 ED 52       	SBC HL,DE
1041+++8933 51          	LD D,C
1042+++8934 CB 19       	RR C
1043+++8936 9F          	SBC A,A
1044+++8937 2F          	CPL
1045+++8938 E6 3E       	AND #3E
1046+++893A CB 19       	RR C
1047+++893C CB 18       	RR B
1048+++893E A1          	AND C
1049+++893F 4F          	LD C,A
1050+++8940 78          	LD A,B
1051+++8941 1F          	RRA
1052+++8942 1F          	RRA
1053+++8943 CB 1A       	RR D
1054+++8945 1F          	RRA
1055+++8946 E6 9F       	AND #9F
1056+++8948 47          	LD B,A
1057+++8949             
1058+++8949 DD 5E 08    e_	LD E,(IX+CHP.TnAcc)
1059+++894C DD 56 09    	LD D,(IX+CHP.TnAcc+1)
1060+++894F 19          	ADD HL,DE
1061+++8950 CB 70       	BIT 6,B
1062+++8952 28 06       	JR Z,CH_NOAC
1063+++8954 DD 75 08    	LD (IX+CHP.TnAcc),L
1064+++8957 DD 74 09    	LD (IX+CHP.TnAcc+1),H
1065+++895A EB          CH_NOAC EX DE,HL
1066+++895B 08          	EX AF,AF'
1067+++895C C6 5E       	ADD A,NT_&255
1068+++895E 6F          	LD L,A
1069+++895F CE 8E       	ADC A,NT_/256
1070+++8961 95          	SUB L
1071+++8962 67          	LD H,A
1072+++8963 F9          	LD SP,HL
1073+++8964 E1          	POP HL
1074+++8965 19          	ADD HL,DE
1075+++8966 DD 5E 06    	LD E,(IX+CHP.CrTnSl)
1076+++8969 DD 56 07    	LD D,(IX+CHP.CrTnSl+1)
1077+++896C 19          	ADD HL,DE
1078+++896D 31 31 31    CSP_	LD SP,#3131
1079+++8970 E3          	EX (SP),HL
1080+++8971 AF          	XOR A
1081+++8972 DD B6 05    	OR (IX+CHP.TSlCnt)
1082+++8975 28 3E       	JR Z,CH_AMP
1083+++8977 DD 35 05    	DEC (IX+CHP.TSlCnt)
1084+++897A 20 39       	JR NZ,CH_AMP
1085+++897C DD 7E 16    	LD A,(IX+CHP.TnSlDl)
1086+++897F DD 77 05    	LD (IX+CHP.TSlCnt),A
1087+++8982 DD 6E 17    	LD L,(IX+CHP.TSlStp)
1088+++8985 DD 66 18    	LD H,(IX+CHP.TSlStp+1)
1089+++8988 7C          	LD A,H
1090+++8989 19          	ADD HL,DE
1091+++898A DD 75 06    	LD (IX+CHP.CrTnSl),L
1092+++898D DD 74 07    	LD (IX+CHP.CrTnSl+1),H
1093+++8990 DD CB 15 56 	BIT 2,(IX+CHP.Flags)
1094+++8994 20 1F       	JR NZ,CH_AMP
1095+++8996 DD 5E 19    	LD E,(IX+CHP.TnDelt)
1096+++8999 DD 56 1A    	LD D,(IX+CHP.TnDelt+1)
1097+++899C A7          	AND A
1098+++899D 28 01       	JR Z,CH_STPP
1099+++899F EB          	EX DE,HL
1100+++89A0 ED 52       CH_STPP SBC HL,DE
1101+++89A2 FA B5 89    	JP M,CH_AMP
1102+++89A5 DD 7E 13    	LD A,(IX+CHP.SlToNt)
1103+++89A8 DD 77 12    	LD (IX+CHP.Note),A
1104+++89AB AF          	XOR A
1105+++89AC DD 77 05    	LD (IX+CHP.TSlCnt),A
1106+++89AF DD 77 06    	LD (IX+CHP.CrTnSl),A
1107+++89B2 DD 77 07    	LD (IX+CHP.CrTnSl+1),A
1108+++89B5 DD 7E 02    CH_AMP	LD A,(IX+CHP.CrAmSl)
1109+++89B8 CB 79       	BIT 7,C
1110+++89BA 28 13       	JR Z,CH_NOAM
1111+++89BC CB 71       	BIT 6,C
1112+++89BE 28 07       	JR Z,CH_AMIN
1113+++89C0 FE 0F       	CP 15
1114+++89C2 28 0B       	JR Z,CH_NOAM
1115+++89C4 3C          	INC A
1116+++89C5 18 05       	JR CH_SVAM
1117+++89C7 FE F1       CH_AMIN	CP -15
1118+++89C9 28 04       	JR Z,CH_NOAM
1119+++89CB 3D          	DEC A
1120+++89CC DD 77 02    CH_SVAM	LD (IX+CHP.CrAmSl),A
1121+++89CF 6F          CH_NOAM	LD L,A
1122+++89D0 78          	LD A,B
1123+++89D1 E6 0F       	AND 15
1124+++89D3 85          	ADD A,L
1125+++89D4 F2 D8 89    	JP P,CH_APOS
1126+++89D7 AF          	XOR A
1127+++89D8 FE 10       CH_APOS	CP 16
1128+++89DA 38 02       	JR C,CH_VOL
1129+++89DC 3E 0F       	LD A,15
1130+++89DE DD B6 1C    CH_VOL	OR (IX+CHP.Volume)
1131+++89E1 C6 5E       	ADD A,VT_&255
1132+++89E3 6F          	LD L,A
1133+++89E4 CE 8D       	ADC A,VT_/256
1134+++89E6 95          	SUB L
1135+++89E7 67          	LD H,A
1136+++89E8 7E          	LD A,(HL)
1137+++89E9 CB 41       CH_ENV	BIT 0,C
1138+++89EB 20 03       	JR NZ,CH_NOEN
1139+++89ED DD B6 14    	OR (IX+CHP.Env_En)
1140+++89F0 32 0E 8B    CH_NOEN	LD (Ampl),A
1141+++89F3 CB 78       	BIT 7,B
1142+++89F5 79          	LD A,C
1143+++89F6 28 1A       	JR Z,NO_ENSL
1144+++89F8 17          	RLA
1145+++89F9 17          	RLA
1146+++89FA CB 2F       	SRA A
1147+++89FC CB 2F       	SRA A
1148+++89FE CB 2F       	SRA A
1149+++8A00 DD 86 04    	ADD A,(IX+CHP.CrEnSl) ;SEE COMMENT BELOW
1150+++8A03 CB 68       	BIT 5,B
1151+++8A05 28 03       	JR Z,NO_ENAC
1152+++8A07 DD 77 04    	LD (IX+CHP.CrEnSl),A
1153+++8A0A FD 86 12    NO_ENAC	ADD A,(IY-100+VRS.AddToEn) ;BUG IN PT3 - NEED WORD HERE
1154+++8A0D FD 77 12    	LD (IY-100+VRS.AddToEn),A
1155+++8A10 18 0E       	JR CH_MIX
1156+++8A12 1F          NO_ENSL RRA
1157+++8A13 DD 86 03    	ADD A,(IX+CHP.CrNsSl)
1158+++8A16 FD 77 11    	LD (IY-100+VRS.AddToNs),A
1159+++8A19 CB 68       	BIT 5,B
1160+++8A1B 28 03       	JR Z,CH_MIX
1161+++8A1D DD 77 03    	LD (IX+CHP.CrNsSl),A
1162+++8A20 78          CH_MIX	LD A,B
1163+++8A21 1F          	RRA
1164+++8A22 E6 48       	AND #48
1165+++8A24 FD B6 1C    CH_EXIT	OR (IY-100+VRS.AYREGS+Mixer)
1166+++8A27 0F          	RRCA
1167+++8A28 FD 77 1C    	LD (IY-100+VRS.AYREGS+Mixer),A
1168+++8A2B E1          	POP HL
1169+++8A2C AF          	XOR A
1170+++8A2D DD B6 0A    	OR (IX+CHP.COnOff)
1171+++8A30 C8          	RET Z
1172+++8A31 DD 35 0A    	DEC (IX+CHP.COnOff)
1173+++8A34 C0          	RET NZ
1174+++8A35 DD AE 15    	XOR (IX+CHP.Flags)
1175+++8A38 DD 77 15    	LD (IX+CHP.Flags),A
1176+++8A3B 1F          	RRA
1177+++8A3C DD 7E 0B    	LD A,(IX+CHP.OnOffD)
1178+++8A3F 38 03       	JR C,CH_ONDL
1179+++8A41 DD 7E 0C    	LD A,(IX+CHP.OffOnD)
1180+++8A44 DD 77 0A    CH_ONDL	LD (IX+CHP.COnOff),A
1181+++8A47 C9          	RET
1182+++8A48             
1183+++8A48 AF          PLAY_	XOR A
1184+++8A49 FD 77 12    	LD (IY-100+VRS.AddToEn),A
1185+++8A4C FD 77 1C    	LD (IY-100+VRS.AYREGS+Mixer),A
1186+++8A4F 3D          	DEC A
1187+++8A50 FD 77 22    	LD (IY-100+VRS.AYREGS+EnvTp),A
1188+++8A53 FD 35 09    	DEC (IY-100+VRS.DelyCnt)
1189+++8A56 C2 FB 8A    	JP NZ,PL2
1190+++8A59 FD 35 BA    	DEC (IY-100+VRS.ChanA+CHP.NtSkCn)
1191+++8A5C 20 69       	JR NZ,PL1B
1192+++8A5E FD 4E FE    	LD C,(IY-100+VRS.AdInPtA)
1193+++8A61 FD 46 FF    	LD B,(IY-100+VRS.AdInPtA+1)
1194+++8A64 0A          	LD A,(BC)
1195+++8A65 A7          	AND A
1196+++8A66 20 53       	JR NZ,PL1A
1197+++8A68 57          	LD D,A
1198+++8A69 FD 77 10    	LD (IY-100+VRS.Ns_Base),A
1199+++8A6C FD 6E 04    	LD L,(IY-100+VRS.CrPsPtr)
1200+++8A6F FD 66 05    	LD H,(IY-100+VRS.CrPsPtr+1)
1201+++8A72 23          	INC HL
1202+++8A73 7E          	LD A,(HL)
1203+++8A74 3C          	INC A
1204+++8A75 20 08       	JR NZ,PLNLP
1205+++8A77             
1206+++8A77             	IF LoopChecker
1207+++8A77~            	CALL CHECKLP
1208+++8A77             	ENDIF
1209+++8A77             
1210+++8A77 FD 6E 06    	LD L,(IY-100+VRS.LPosPtr)
1211+++8A7A FD 66 07    	LD H,(IY-100+VRS.LPosPtr+1)
1212+++8A7D 7E          	LD A,(HL)
1213+++8A7E 3C          	INC A
1214+++8A7F CD D6 85    PLNLP	CALL SETCPPT
1215+++8A82 3D          	DEC A
1216+++8A83 FD CB 9E 4E 	BIT 1,(IY-100+VRS.ModNum)
1217+++8A87 28 03       	JR Z,NoAlCo
1218+++8A89             TSSub	EQU $+1
1219+++8A89 D6 D6       	SUB #D6
1220+++8A8B 2F          	CPL
1221+++8A8C             NoAlCo
1222+++8A8C             		;PT2		PT3
1223+++8A8C 3D          PsCalc	DEC A	;ADD A,A	NOP
1224+++8A8D 3D          	DEC A	;ADD A,(HL)	NOP
1225+++8A8E 87          	ADD A,A
1226+++8A8F 5F          	LD E,A
1227+++8A90 CB 12       	RL D
1228+++8A92             
1229+++8A92             	IF CurPosCounter
1230+++8A92~            	LD A,L
1231+++8A92~            	SUB (IY-100+VRS.PosSub)
1232+++8A92~            	LD (IY-100+VRS.CurPos),A
1233+++8A92             	ENDIF
1234+++8A92             
1235+++8A92 FD 6E FC    	LD L,(IY-100+VRS.PatsPtr)
1236+++8A95 FD 66 FD    	LD H,(IY-100+VRS.PatsPtr+1)
1237+++8A98 19          	ADD HL,DE
1238+++8A99 FD 5E F6    	LD E,(IY-100+VRS.MODADDR)
1239+++8A9C FD 56 F7    	LD D,(IY-100+VRS.MODADDR+1)
1240+++8A9F ED 73 B9 8A 	LD (PSP_+1),SP
1241+++8AA3 F9          	LD SP,HL
1242+++8AA4 E1          	POP HL
1243+++8AA5 19          	ADD HL,DE
1244+++8AA6 44          	LD B,H
1245+++8AA7 4D          	LD C,L
1246+++8AA8 E1          	POP HL
1247+++8AA9 19          	ADD HL,DE
1248+++8AAA FD 75 00    	LD (IY-100+VRS.AdInPtB),L
1249+++8AAD FD 74 01    	LD (IY-100+VRS.AdInPtB+1),H
1250+++8AB0 E1          	POP HL
1251+++8AB1 19          	ADD HL,DE
1252+++8AB2 FD 75 02    	LD (IY-100+VRS.AdInPtC),L
1253+++8AB5 FD 74 03    	LD (IY-100+VRS.AdInPtC+1),H
1254+++8AB8 31 31 31    PSP_	LD SP,#3131
1255+++8ABB 11 AB FF    PL1A	LD DE,VRS.ChanA+12-100
1256+++8ABE CD F9 85    	CALL PTDECOD
1257+++8AC1 FD 71 FE    	LD (IY-100+VRS.AdInPtA),C
1258+++8AC4 FD 70 FF    	LD (IY-100+VRS.AdInPtA+1),B
1259+++8AC7             
1260+++8AC7 FD 35 D7    PL1B	DEC (IY-100+VRS.ChanB+CHP.NtSkCn)
1261+++8ACA 20 12       	JR NZ,PL1C
1262+++8ACC 11 C8 FF    	LD DE,VRS.ChanB+12-100
1263+++8ACF FD 4E 00    	LD C,(IY-100+VRS.AdInPtB)
1264+++8AD2 FD 46 01    	LD B,(IY-100+VRS.AdInPtB+1)
1265+++8AD5 CD F9 85    	CALL PTDECOD
1266+++8AD8 FD 71 00    	LD (IY-100+VRS.AdInPtB),C
1267+++8ADB FD 70 01    	LD (IY-100+VRS.AdInPtB+1),B
1268+++8ADE             
1269+++8ADE FD 35 F4    PL1C	DEC (IY-100+VRS.ChanC+CHP.NtSkCn)
1270+++8AE1 20 12       	JR NZ,PL1D
1271+++8AE3 11 E5 FF    	LD DE,VRS.ChanC+12-100
1272+++8AE6 FD 4E 02    	LD C,(IY-100+VRS.AdInPtC)
1273+++8AE9 FD 46 03    	LD B,(IY-100+VRS.AdInPtC+1)
1274+++8AEC CD F9 85    	CALL PTDECOD
1275+++8AEF FD 71 02    	LD (IY-100+VRS.AdInPtC),C
1276+++8AF2 FD 70 03    	LD (IY-100+VRS.AdInPtC+1),B
1277+++8AF5             
1278+++8AF5 FD 7E 08    PL1D	LD A,(IY-100+VRS.Delay)
1279+++8AF8 FD 77 09    	LD (IY-100+VRS.DelyCnt),A
1280+++8AFB             
1281+++8AFB 11 9F FF    PL2	LD DE,VRS.ChanA-100
1282+++8AFE FD 6E 15    	LD L,(IY-100+VRS.AYREGS+TonA)
1283+++8B01 FD 66 16    	LD H,(IY-100+VRS.AYREGS+TonA+1)
1284+++8B04 CD D1 88    	CALL CHREGS
1285+++8B07 FD 75 15    	LD (IY-100+VRS.AYREGS+TonA),L
1286+++8B0A FD 74 16    	LD (IY-100+VRS.AYREGS+TonA+1),H
1287+++8B0D             Ampl	EQU $+1
1288+++8B0D 3E 3E       	LD A,#3E
1289+++8B0F FD 77 1D    	LD (IY-100+VRS.AYREGS+AmplA),A
1290+++8B12 11 BC FF    	LD DE,VRS.ChanB-100
1291+++8B15 FD 6E 17    	LD L,(IY-100+VRS.AYREGS+TonB)
1292+++8B18 FD 66 18    	LD H,(IY-100+VRS.AYREGS+TonB+1)
1293+++8B1B CD D1 88    	CALL CHREGS
1294+++8B1E FD 75 17    	LD (IY-100+VRS.AYREGS+TonB),L
1295+++8B21 FD 74 18    	LD (IY-100+VRS.AYREGS+TonB+1),H
1296+++8B24 3A 0E 8B    	LD A,(Ampl)
1297+++8B27 FD 77 1E    	LD (IY-100+VRS.AYREGS+AmplB),A
1298+++8B2A 11 D9 FF    	LD DE,VRS.ChanC-100
1299+++8B2D FD 6E 19    	LD L,(IY-100+VRS.AYREGS+TonC)
1300+++8B30 FD 66 1A    	LD H,(IY-100+VRS.AYREGS+TonC+1)
1301+++8B33 CD D1 88    	CALL CHREGS
1302+++8B36 FD 75 19    	LD (IY-100+VRS.AYREGS+TonC),L
1303+++8B39 FD 74 1A    	LD (IY-100+VRS.AYREGS+TonC+1),H
1304+++8B3C 3A 0E 8B    	LD A,(Ampl)
1305+++8B3F FD 77 1F    	LD (IY-100+VRS.AYREGS+AmplC),A
1306+++8B42             
1307+++8B42 FD 7E 10    	LD A,(IY-100+VRS.Ns_Base)
1308+++8B45 FD 86 11    	ADD (IY-100+VRS.AddToNs)
1309+++8B48 FD 77 1B    	LD (IY-100+VRS.AYREGS+Noise),A
1310+++8B4B             
1311+++8B4B FD 7E 12    	LD A,(IY-100+VRS.AddToEn)
1312+++8B4E 5F          	LD E,A
1313+++8B4F 87          	ADD A,A
1314+++8B50 9F          	SBC A,A
1315+++8B51 57          	LD D,A
1316+++8B52 FD 6E 13    	LD L,(IY-100+VRS.EnvBase)
1317+++8B55 FD 66 14    	LD H,(IY-100+VRS.EnvBase+1)
1318+++8B58 19          	ADD HL,DE
1319+++8B59 FD 5E 0C    	LD E,(IY-100+VRS.CurESld)
1320+++8B5C FD 56 0D    	LD D,(IY-100+VRS.CurESld+1)
1321+++8B5F 19          	ADD HL,DE
1322+++8B60 FD 75 20    	LD (IY-100+VRS.AYREGS+Env),L
1323+++8B63 FD 74 21    	LD (IY-100+VRS.AYREGS+Env+1),H
1324+++8B66             
1325+++8B66 AF          	XOR A
1326+++8B67 FD B6 0F    	OR (IY-100+VRS.CurEDel)
1327+++8B6A C8          	RET Z
1328+++8B6B FD 35 0F    	DEC (IY-100+VRS.CurEDel)
1329+++8B6E C0          	RET NZ
1330+++8B6F FD 7E 0E    	LD A,(IY-100+VRS.Env_Del)
1331+++8B72 FD 77 0F    	LD (IY-100+VRS.CurEDel),A
1332+++8B75 FD 6E 0A    	LD L,(IY-100+VRS.ESldAdd)
1333+++8B78 FD 66 0B    	LD H,(IY-100+VRS.ESldAdd+1)
1334+++8B7B 19          	ADD HL,DE
1335+++8B7C C3 EB 85    	JP SETESLD
1336+++8B7F             
1337+++8B7F FD 21 C4 8C PLAY    LD IY,VARS1+100
1338+++8B83 CD 48 8A    	CALL PLAY_
1339+++8B86 3A 5F 8C    	LD A,(is_ts)
1340+++8B89 A7          	AND A
1341+++8B8A 28 07       	JR Z,PL_nts
1342+++8B8C FD 21 4B 8D 	LD IY,VARS2+100
1343+++8B90 CD 48 8A    	CALL PLAY_
1344+++8B93             PL_nts
1345+++8B93             	IF Basic
1346+++8B93~            	LD IY,#5C3A
1347+++8B93             	ENDIF
1348+++8B93             
1349+++8B93 01 FD FF    ROUT	LD BC,#FFFD
1350+++8B96               IFDEF ONtfm
1351+++8B96 2E F9           LD L,#F9
1352+++8B98 ED 69           OUT (C),L
1353+++8B9A               ELSE
1354+++8B9A~            	LD A,(is_ts)
1355+++8B9A~            	AND A
1356+++8B9A~            	JR Z,r_nts ;keep old standard
1357+++8B9A~            	OUT (C),B
1358+++8B9A                 ENDIF
1359+++8B9A 08          r_nts	EX AF,AF'
1360+++8B9B             
1361+++8B9B             	IF ACBBAC
1362+++8B9B~            	LD IX,VARS1+VRS.AYREGS
1363+++8B9B             	ELSE
1364+++8B9B 21 D9 8C    	LD HL,VARS1+VRS.AYREGS
1365+++8B9E             	ENDIF
1366+++8B9E             
1367+++8B9E CD AB 8B    	CALL ROUT_
1368+++8BA1 08          	EX AF,AF'
1369+++8BA2 C8          	RET Z
1370+++8BA3 42          	LD B,D
1371+++8BA4             
1372+++8BA4                 IFDEF ONtfm
1373+++8BA4 3E F8           LD A,#F8
1374+++8BA6                 ELSE
1375+++8BA6~            	CPL
1376+++8BA6                 ENDIF
1377+++8BA6 ED 79       	OUT (C),A
1378+++8BA8             
1379+++8BA8             	IF ACBBAC
1380+++8BA8~            	LD IX,VARS2+VRS.AYREGS
1381+++8BA8             	ELSE
1382+++8BA8 21 60 8D    	LD HL,VARS2+VRS.AYREGS
1383+++8BAB             	ENDIF
1384+++8BAB             
1385+++8BAB             ROUT_
1386+++8BAB             	IF ACBBAC
1387+++8BAB~            	LD A,(SETUP)
1388+++8BAB~            	AND 12
1389+++8BAB~            	JR Z,ABC
1390+++8BAB~            	ADD A,CHTABLE
1391+++8BAB~            	LD E,A
1392+++8BAB~            	ADC A,CHTABLE/256
1393+++8BAB~            	SUB E
1394+++8BAB~            	LD D,A
1395+++8BAB~            	LD B,0
1396+++8BAB~            	PUSH IX
1397+++8BAB~            	POP HL
1398+++8BAB~            	LD A,(DE)
1399+++8BAB~            	INC DE
1400+++8BAB~            	LD C,A
1401+++8BAB~            	ADD HL,BC
1402+++8BAB~            	LD A,(IX+TonB)
1403+++8BAB~            	LD C,(HL)
1404+++8BAB~            	LD (IX+TonB),C
1405+++8BAB~            	LD (HL),A
1406+++8BAB~            	INC HL
1407+++8BAB~            	LD A,(IX+TonB+1)
1408+++8BAB~            	LD C,(HL)
1409+++8BAB~            	LD (IX+TonB+1),C
1410+++8BAB~            	LD (HL),A
1411+++8BAB~            	LD A,(DE)
1412+++8BAB~            	INC DE
1413+++8BAB~            	LD C,A
1414+++8BAB~            	ADD HL,BC
1415+++8BAB~            	LD A,(IX+AmplB)
1416+++8BAB~            	LD C,(HL)
1417+++8BAB~            	LD (IX+AmplB),C
1418+++8BAB~            	LD (HL),A
1419+++8BAB~            	LD A,(DE)
1420+++8BAB~            	INC DE
1421+++8BAB~            	LD (RxCA1),A
1422+++8BAB~            	XOR 8
1423+++8BAB~            	LD (RxCA2),A
1424+++8BAB~            	LD A,(DE)
1425+++8BAB~            	AND (IX+Mixer)
1426+++8BAB~            	LD E,A
1427+++8BAB~            	LD A,(IX+Mixer)
1428+++8BAB~            RxCA1	DB #E6
1429+++8BAB~            	AND %010010
1430+++8BAB~            	OR E
1431+++8BAB~            	LD E,A
1432+++8BAB~            	LD A,(IX+Mixer)
1433+++8BAB~            	AND %010010
1434+++8BAB~            RxCA2	OR E
1435+++8BAB~            	OR E
1436+++8BAB~            	LD (IX+Mixer),A
1437+++8BAB~            ABC
1438+++8BAB             	ENDIF
1439+++8BAB             
1440+++8BAB AF          	XOR A
1441+++8BAC 11 BF FF    	LD DE,#FFBF
1442+++8BAF             
1443+++8BAF             	IF ACBBAC
1444+++8BAF~            	LD BC,#FFFD
1445+++8BAF~            	PUSH IX
1446+++8BAF~            	POP HL
1447+++8BAF             	ENDIF
1448+++8BAF             
1449+++8BAF             LOUT
1450+++8BAF                 IFDEF ONtfm
1451+++8BAF ED 70           INF 
1452+++8BB1 FA AF 8B        JP M,$-2
1453+++8BB4                 ENDIF 
1454+++8BB4 ED 79           OUT (C),A
1455+++8BB6                 IFDEF ONtfm
1456+++8BB6 ED 70           INF 
1457+++8BB8 FA B6 8B        JP M,$-2
1458+++8BBB                 ENDIF 
1459+++8BBB 43          	LD B,E
1460+++8BBC ED A3       	OUTI 
1461+++8BBE 42          	LD B,D
1462+++8BBF 3C          	INC A
1463+++8BC0 FE 0D       	CP 13
1464+++8BC2 20 EB       	JR NZ,LOUT
1465+++8BC4                 IFDEF ONtfm
1466+++8BC4 ED 70           INF 
1467+++8BC6 FA C4 8B        JP M,$-2
1468+++8BC9                 ENDIF 
1469+++8BC9 ED 79       	OUT (C),A
1470+++8BCB 7E          	LD A,(HL)
1471+++8BCC A7          	AND A
1472+++8BCD F8          	RET M
1473+++8BCE                 IFDEF ONtfm
1474+++8BCE ED 70           INF 
1475+++8BD0 FA CE 8B        JP M,$-2
1476+++8BD3                 ENDIF 
1477+++8BD3 43          	LD B,E
1478+++8BD4 ED 79       	OUT (C),A
1479+++8BD6 C9          	RET
1480+++8BD7             
1481+++8BD7             	IF ACBBAC
1482+++8BD7~            CHTABLE	EQU $-4
1483+++8BD7~            	DB 4,5,15,%001001,0,7,7,%100100
1484+++8BD7             	ENDIF
1485+++8BD7             
1486+++8BD7 64          NT_DATA	DB (T_NEW_0-T1_)*2
1487+++8BD8 2A          	DB TCNEW_0-T_
1488+++8BD9 65          	DB (T_OLD_0-T1_)*2+1
1489+++8BDA 00          	DB TCOLD_0-T_
1490+++8BDB 01          	DB (T_NEW_1-T1_)*2+1
1491+++8BDC 0C          	DB TCNEW_1-T_
1492+++8BDD 01          	DB (T_OLD_1-T1_)*2+1
1493+++8BDE 0C          	DB TCOLD_1-T_
1494+++8BDF 94          	DB (T_NEW_2-T1_)*2
1495+++8BE0 35          	DB TCNEW_2-T_
1496+++8BE1 30          	DB (T_OLD_2-T1_)*2
1497+++8BE2 0E          	DB TCOLD_2-T_
1498+++8BE3 60          	DB (T_NEW_3-T1_)*2
1499+++8BE4 20          	DB TCNEW_3-T_
1500+++8BE5 60          	DB (T_OLD_3-T1_)*2
1501+++8BE6 21          	DB TCOLD_3-T_
1502+++8BE7             
1503+++8BE7             T_
1504+++8BE7             
1505+++8BE7             TCOLD_0	DB #00+1,#04+1,#08+1,#0A+1,#0C+1,#0E+1,#12+1,#14+1
1505+++8BE7 0105090B0D0F1315
1506+++8BEF 19 25 3D 00 	DB #18+1,#24+1,#3C+1,0
1507+++8BF3 5D 00       TCOLD_1	DB #5C+1,0
1508+++8BF5             TCOLD_2	DB #30+1,#36+1,#4C+1,#52+1,#5E+1,#70+1,#82,#8C,#9C
1508+++8BF5 31374D535F71828C9C
1509+++8BFE             	DB #9E,#A0,#A6,#A8,#AA,#AC,#AE,#AE,0
1509+++8BFE 9EA0A6A8AAACAEAE00
1510+++8C07 57          TCNEW_3	DB #56+1
1511+++8C08             TCOLD_3	DB #1E+1,#22+1,#24+1,#28+1,#2C+1,#2E+1,#32+1,#BE+1,0
1511+++8C08 1F2325292D2F33BF00
1512+++8C11             TCNEW_0	DB #1C+1,#20+1,#22+1,#26+1,#2A+1,#2C+1,#30+1,#54+1
1512+++8C11 1D2123272B2D3155
1513+++8C19 BD BF 00    	DB #BC+1,#BE+1,0
1514+++8C1C             TCNEW_1 EQU TCOLD_1
1515+++8C1C             TCNEW_2	DB #1A+1,#20+1,#24+1,#28+1,#2A+1,#3A+1,#4C+1,#5E+1
1515+++8C1C 1B2125292B3B4D5F
1516+++8C24 BB BD BF 00 	DB #BA+1,#BC+1,#BE+1,0
1517+++8C28             
1518+++8C28             PT3EMPTYORN EQU $-1
1519+++8C28 01 00       	DB 1,0
1520+++8C2A             
1521+++8C2A             ;first 12 values of tone tables (packed)
1522+++8C2A             
1523+++8C2A 0D D8       T_PACK	DB #06EC*2/256,#06EC*2&255
1524+++8C2C 69          	DB #0755-#06EC
1525+++8C2D 70          	DB #07C5-#0755
1526+++8C2E 76          	DB #083B-#07C5
1527+++8C2F 7D          	DB #08B8-#083B
1528+++8C30 85          	DB #093D-#08B8
1529+++8C31 8D          	DB #09CA-#093D
1530+++8C32 95          	DB #0A5F-#09CA
1531+++8C33 9D          	DB #0AFC-#0A5F
1532+++8C34 A8          	DB #0BA4-#0AFC
1533+++8C35 B1          	DB #0C55-#0BA4
1534+++8C36 BB          	DB #0D10-#0C55
1535+++8C37 0C DA       	DB #066D*2/256,#066D*2&255
1536+++8C39 62          	DB #06CF-#066D
1537+++8C3A 68          	DB #0737-#06CF
1538+++8C3B 6D          	DB #07A4-#0737
1539+++8C3C 75          	DB #0819-#07A4
1540+++8C3D 7B          	DB #0894-#0819
1541+++8C3E 83          	DB #0917-#0894
1542+++8C3F 8A          	DB #09A1-#0917
1543+++8C40 92          	DB #0A33-#09A1
1544+++8C41 9C          	DB #0ACF-#0A33
1545+++8C42 A4          	DB #0B73-#0ACF
1546+++8C43 AF          	DB #0C22-#0B73
1547+++8C44 B8          	DB #0CDA-#0C22
1548+++8C45 0E 08       	DB #0704*2/256,#0704*2&255
1549+++8C47 6A          	DB #076E-#0704
1550+++8C48 72          	DB #07E0-#076E
1551+++8C49 78          	DB #0858-#07E0
1552+++8C4A 7E          	DB #08D6-#0858
1553+++8C4B 86          	DB #095C-#08D6
1554+++8C4C 90          	DB #09EC-#095C
1555+++8C4D 96          	DB #0A82-#09EC
1556+++8C4E A0          	DB #0B22-#0A82
1557+++8C4F AA          	DB #0BCC-#0B22
1558+++8C50 B4          	DB #0C80-#0BCC
1559+++8C51 BE          	DB #0D3E-#0C80
1560+++8C52 0F C0       	DB #07E0*2/256,#07E0*2&255
1561+++8C54 78          	DB #0858-#07E0
1562+++8C55 88          	DB #08E0-#0858
1563+++8C56 80          	DB #0960-#08E0
1564+++8C57 90          	DB #09F0-#0960
1565+++8C58 98          	DB #0A88-#09F0
1566+++8C59 A0          	DB #0B28-#0A88
1567+++8C5A B0          	DB #0BD8-#0B28
1568+++8C5B A8          	DB #0C80-#0BD8
1569+++8C5C E0          	DB #0D60-#0C80
1570+++8C5D B0          	DB #0E10-#0D60
1571+++8C5E E8          	DB #0EF8-#0E10
1572+++8C5F             
1573+++8C5F             ;vars from here can be stripped
1574+++8C5F             ;you can move VARS to any other address
1575+++8C5F             
1576+++8C5F             VARS
1577+++8C5F             
1578+++8C5F 00          is_ts	DB 0
1579+++8C60             
1580+++8C60             ;ChannelsVars
1581+++8C60             	STRUCT	CHP
1582+++8C60~            ;reset group
1583+++8C60~            PsInOr	DB 0
1584+++8C60~            PsInSm	DB 0
1585+++8C60~            CrAmSl	DB 0
1586+++8C60~            CrNsSl	DB 0
1587+++8C60~            CrEnSl	DB 0
1588+++8C60~            TSlCnt	DB 0
1589+++8C60~            CrTnSl	DW 0
1590+++8C60~            TnAcc	DW 0
1591+++8C60~            COnOff	DB 0
1592+++8C60~            ;reset group
1593+++8C60~            1594+++8C60~            OnOffD	DB 0
1595+++8C60~            1596+++8C60~            ;IX for PTDECOD here (+12)
1597+++8C60~            OffOnD	DB 0
1598+++8C60~            OrnPtr	DW 0
1599+++8C60~            SamPtr	DW 0
1600+++8C60~            NNtSkp	DB 0
1601+++8C60~            Note	DB 0
1602+++8C60~            SlToNt	DB 0
1603+++8C60~            Env_En	DB 0
1604+++8C60~            Flags	DB 0
1605+++8C60~             ;Enabled - 0, SimpleGliss - 2
1606+++8C60~            TnSlDl	DB 0
1607+++8C60~            TSlStp	DW 0
1608+++8C60~            TnDelt	DW 0
1609+++8C60~            NtSkCn	DB 0
1610+++8C60~            Volume	DB 0
1611+++8C60             	ENDS
1612+++8C60             
1613+++8C60             	STRUCT	VRS
1614+++8C60~            1615+++8C60~            ;IF not works in STRUCT in SjASM :(
1616+++8C60~            ;	IF CurPosCounter
1617+++8C60~            CurPos	DB 0
1618+++8C60~            PosSub	DB 0
1619+++8C60~            ;	ENDIF
1620+++8C60~            1621+++8C60~            ModNum	DB 0 ;bit0: ChipNum
1622+++8C60~            	     ;bit1: 1-reversed patterns order (AlCo TS)
1623+++8C60~            1624+++8C60~            ChanA	DS CHP
1625+++8C60~            ChanB	DS CHP
1626+++8C60~            ChanC	DS CHP
1627+++8C60~            1628+++8C60~            ;GlobalVars
1629+++8C60~            MODADDR	DW 0
1630+++8C60~            OrnPtrs	DW 0
1631+++8C60~            SamPtrs	DW 0
1632+++8C60~            PatsPtr	DW 0
1633+++8C60~            AdInPtA	DW 0
1634+++8C60~            AdInPtB	DW 0
1635+++8C60~            AdInPtC	DW 0
1636+++8C60~            CrPsPtr	DW 0
1637+++8C60~            LPosPtr	DW 0
1638+++8C60~            Delay	DB 0
1639+++8C60~            DelyCnt	DB 0
1640+++8C60~            ESldAdd	DW 0
1641+++8C60~            CurESld	DW 0
1642+++8C60~            Env_Del	DB 0
1643+++8C60~            CurEDel	DB 0
1644+++8C60~            Ns_Base	DB 0
1645+++8C60~            AddToNs	DB 0
1646+++8C60~            AddToEn	DB 0
1647+++8C60~            EnvBase	DW 0
1648+++8C60~            AYREGS	DS 14
1649+++8C60             	ENDS
1650+++8C60             
1651+++8C60 00          VARS1	DS VRS
1652+++8CE7 00          VARS2	DS VRS
1653+++8D6E             
1654+++8D6E             VT_	EQU $-16
1655+++8D6E 00          	DS 256-16 ;CreatedVolumeTableAddress
1656+++8E5E             
1657+++8E5E             T1_	EQU VT_+16 ;Tone tables data depacked here
1658+++8E5E             
1659+++8E5E             T_OLD_1	EQU T1_
1660+++8E5E             T_OLD_2	EQU T_OLD_1+24
1661+++8E5E             T_OLD_3	EQU T_OLD_2+24
1662+++8E5E             T_OLD_0	EQU T_OLD_3+2
1663+++8E5E             T_NEW_0	EQU T_OLD_0
1664+++8E5E             T_NEW_1	EQU T_OLD_1
1665+++8E5E             T_NEW_2	EQU T_NEW_0+24
1666+++8E5E             T_NEW_3	EQU T_OLD_3
1667+++8E5E             
1668+++8E5E             PT2EMPTYORN EQU VT_+31 ;1,0,0 sequence
1669+++8E5E             
1670+++8E5E 00          NT_	DS 192 ;CreatedNoteTableAddress
1671+++8F1E             
1672+++8F1E             VAR0END	EQU VT_+16 ;INIT zeroes from VARS to VAR0END-1
1673+++8F1E             
1674+++8F1E             VARSEND EQU $
1675+++8F1E             MDLADDR EQU $
1676+++8F1E             
1677+++8F1E                    DISPLAY "PTS player size=",$-START
1678+++8F1E             
1679+++8F1E             ;Release 0 steps:
1680+++8F1E             ;04/21/2007
1681+++8F1E             ;Works start (PTxPlay adaptation); first beta.
1682+++8F1E             ;04/22/2007
1683+++8F1E             ;Job finished; beta-testing.
1684+++8F1E             ;04/23/2007
1685+++8F1E             ;PT v3.7 TS mode corrected (after AlCo remarks).
1686+++8F1E             ;04/29/2007
1687+++8F1E             ;Added 1.XX and 2.XX special commands interpretation for PT3
1688+++8F1E             ;modules of v3.7+.
1689+++8F1E             
1690+++8F1E             ;Size (minimal build for ZX Spectrum):
1691+++8F1E             ;Code block #908 bytes
1692+++8F1E             ;Variables #2BF bytes (can be stripped)
1693+++8F1E             ;Total size #908+#2BF=#BC7 (3015) bytes
1694+++8F1E             
1695+++8F1E                    ENDMOD
1696+++8F1E             
1697+++8F1E                    endif
1698+++8F1E             
0413++ 8F1E                     include "pt3.asm"
0001+++8F1E                     ifndef _pt3_asm_defined
0002+++8F1E                     define _pt3_asm_defined
0003+++8F1E             
0004+++8F1E                     module PT3
0005+++8F1E                     
0006+++8F1E                     struct Header
0007+++8F1E~            Id      ds 13 ; usually 'Protracker 3.'
0008+++8F1E~            Subversion
0009+++8F1E~                    db 0
0010+++8F1E~            Description
0011+++8F1E~                    ds 84 ; usually ' compilation of ' + Name[32] + ' by ' + Author[32]
0012+++8F1E~            Mode    db 0
0013+++8F1E~            FreqTable
0014+++8F1E~                    db 0  ;assume 0..04
0015+++8F1E~            Tempo   db 0  ;01-ff
0016+++8F1E~            Length  db 0
0017+++8F1E~            Loop    db 0
0018+++8F1E~            Patterns
0019+++8F1E~                    dw 0  ;? 00-01
0020+++8F1E~            Samples 
0021+++8F1E~                    ds 64  ;(? 00-bf}{32}
0022+++8F1E~            Ornaments
0023+++8F1E~                    ds 32  ;(? 00-d9){16}
0024+++8F1E~            Positions
0025+++8F1E~                    db 0  ;*3&00-fe
0026+++8F1E~                    db 0  ;*3|ff       
0027+++8F1E                     ends
0028+++8F1E                     
0029+++8F1E             Start
0030+++8F1E                     ifndef NoPrologue
0031+++8F1E~                    ld hl,End
0032+++8F1E~                    jr Init
0033+++8F1E~                    jp PTS.PLAY
0034+++8F1E~                    jp PTS.MUTE
0035+++8F1E                     endif
0036+++8F1E             
0037+++8F1E 3E 20       Init    ld a,PTS.SETUP.TSPT3
0038+++8F20 C3 63 83            jp PTS.INIT
0039+++8F23             
0040+++8F23                     ifdef HaveFormatCheck
0041+++8F23                     include "format.asm"
0001+++8F23             ;some format checking macros
0002+++8F23                     ifndef _format_asm_defined
0003+++8F23~                    define _format_asm_defined
0004+++8F23~            0005+++8F23~                    macro LessOrEqual number
0006+++8F23~                    ld a,number
0007+++8F23~                    cp (hl)
0008+++8F23~                    inc hl
0009+++8F23~                    ret c
0010+++8F23~                    endm
0011+++8F23~                    
0012+++8F23~                    macro Greater number
0013+++8F23~                    ld a,(hl)
0014+++8F23~                    inc hl
0015+++8F23~                    cp number
0016+++8F23~                    ret c
0017+++8F23~                    endm
0018+++8F23~                    
0019+++8F23~                    macro AnyByte
0020+++8F23~                    inc hl
0021+++8F23~                    endm
0022+++8F23~                    
0023+++8F23~                    macro AnyBytes count
0024+++8F23~                    if count > 7
0025+++8F23~                    ld a,l
0026+++8F23~                    add a,count
0027+++8F23~                    ld l,a
0028+++8F23~                    adc a,h
0029+++8F23~                    sub l
0030+++8F23~                    ld h,a
0031+++8F23~                    else
0032+++8F23~                    dup count
0033+++8F23~                    inc hl
0034+++8F23~                    edup
0035+++8F23~                    endif
0036+++8F23~                    endm
0037+++8F23~                    
0038+++8F23~                    macro EqualTo number
0039+++8F23~                    ld a,number
0040+++8F23~                    cp (hl)
0041+++8F23~                    inc hl
0042+++8F23~                    ret nz
0043+++8F23~                    endm
0044+++8F23~            0045+++8F23                     endif
0046+++8F23             
0042+++8F23                     
0043+++8F23             ;in HL - module addr
0044+++8F23             ;out Z - is pt3
0045+++8F23             CheckFormat
0046+++8F23                     ; meta
0047+++8F23                     AnyBytes Header.FreqTable
0047+++8F23 7D          >        ld a,l
0047+++8F24 C6 63       >        add a,count
0047+++8F26 6F          >        ld l,a
0047+++8F27 8C          >        adc a,h
0047+++8F28 95          >        sub l
0047+++8F29 67          >        ld h,a
0048+++8F2A                     ;FreqTable
0049+++8F2A                     LessOrEqual 4
0049+++8F2A 3E 04       >        ld a,number
0049+++8F2C BE          >        cp (hl)
0049+++8F2D 23          >        inc hl
0049+++8F2E D8          >        ret c
0050+++8F2F                     ;Tempo
0051+++8F2F                     Greater 1
0051+++8F2F 7E          >        ld a,(hl)
0051+++8F30 23          >        inc hl
0051+++8F31 FE 01       >        cp number
0051+++8F33 D8          >        ret c
0052+++8F34                     ;Length
0053+++8F34                     AnyByte
0053+++8F34 23          >        inc hl
0054+++8F35                     ;Loop
0055+++8F35                     AnyByte
0055+++8F35 23          >        inc hl
0056+++8F36                     ;Patterns
0057+++8F36                     AnyByte
0057+++8F36 23          >        inc hl
0058+++8F37                     LessOrEqual 1
0058+++8F37 3E 01       >        ld a,number
0058+++8F39 BE          >        cp (hl)
0058+++8F3A 23          >        inc hl
0058+++8F3B D8          >        ret c
0059+++8F3C                     ;Samples
0060+++8F3C 06 20               ld b,(Header.Ornaments-Header.Samples)/2
0061+++8F3E             .samples
0062+++8F3E                     AnyByte
0062+++8F3E 23          >        inc hl
0063+++8F3F                     LessOrEqual #bf
0063+++8F3F 3E BF       >        ld a,number
0063+++8F41 BE          >        cp (hl)
0063+++8F42 23          >        inc hl
0063+++8F43 D8          >        ret c
0064+++8F44 10 F8               djnz .samples
0065+++8F46                     ;Ornaments
0066+++8F46 06 10               ld b,(Header.Positions-Header.Ornaments)/2
0067+++8F48             .ornaments
0068+++8F48                     AnyByte
0068+++8F48 23          >        inc hl
0069+++8F49                     LessOrEqual #d9
0069+++8F49 3E D9       >        ld a,number
0069+++8F4B BE          >        cp (hl)
0069+++8F4C 23          >        inc hl
0069+++8F4D D8          >        ret c
0070+++8F4E 10 F8               djnz .ornaments
0071+++8F50                     ;Positions
0072+++8F50                     ;255 at first position is denied
0073+++8F50                     LessOrEqual 254
0073+++8F50 3E FE       >        ld a,number
0073+++8F52 BE          >        cp (hl)
0073+++8F53 23          >        inc hl
0073+++8F54 D8          >        ret c
0074+++8F55 06 00               ld b,0
0075+++8F57 2B                  dec hl
0076+++8F58             .positions
0077+++8F58 7E                  ld a,(hl)
0078+++8F59 23                  inc hl
0079+++8F5A FE FF               cp 255
0080+++8F5C C8                  ret z ;finish
0081+++8F5D                     ;check is multiple of 3
0082+++8F5D A7          .div3   and a
0083+++8F5E 28 05               jr z,.posok
0084+++8F60 D6 03               sub 3
0085+++8F62 D8                  ret c
0086+++8F63 20 F8               jr nz,.div3
0087+++8F65 10 F1       .posok  djnz .positions
0088+++8F67                     ;fall through
0089+++8F67 7C          .fail   ld a,h
0090+++8F68 A7                  and a ;reset Z
0091+++8F69 C9                  ret
0092+++8F6A                     
0093+++8F6A                     display "PT3 checker size: ",$-CheckFormat
0094+++8F6A                     endif
0095+++8F6A                     
0096+++8F6A                     endmod
0097+++8F6A             
0098+++8F6A                     include "PTSPlay.asm"
0001+++8F6A                     ifndef _pts_asm_defined
0002+++8F6A~                    define _pts_asm_defined
0003+++8F6A~            0004+++8F6A~                    MODULE PTS
0005+++8F6A~                    
0006+++8F6A~            ;Universal PT2'n'PT3 Turbo Sound player for ZX Spectrum
0007+++8F6A~            ;(c)2004-2007 S.V.Bulba <vorobey@mail.khstu.ru>
0008+++8F6A~            ;Specially for AlCo
0009+++8F6A~            ;http://bulba.untergrund.net/ (http://bulba.at.kz/)
0010+++8F6A~            0011+++8F6A~            ;Release number
0012+++8F6A~            Release EQU "0"
0013+++8F6A~            0014+++8F6A~            ;Conditional assembly
0015+++8F6A~            ;1) Current position counters at (Vars1+0) and (Vars2+0)
0016+++8F6A~            CurPosCounter=0
0017+++8F6A~            ;2) Allow channels allocation bits at (SETUP)
0018+++8F6A~            ACBBAC=0
0019+++8F6A~            ;3) Allow loop checking and disabling
0020+++8F6A~            LoopChecker=0
0021+++8F6A~            ;4) Insert official identificator
0022+++8F6A~            Id=0
0023+++8F6A~            ;5) Set IY for correct return to ZX Basic
0024+++8F6A~            Basic=0
0025+++8F6A~            0026+++8F6A~            ;Features
0027+++8F6A~            ;--------
0028+++8F6A~            ;-Can be compiled at any address (i.e. no need rounding ORG
0029+++8F6A~            ; address).
0030+++8F6A~            ;-Variables (VARS) can be located at any address (not only after
0031+++8F6A~            ; code block).
0032+++8F6A~            ;-INIT subprogram checks PT3-module version and rightly
0033+++8F6A~            ; generates both note and volume tables outside of code block
0034+++8F6A~            ; (in VARS).
0035+++8F6A~            ;-Two portamento (spc. command 3xxx) algorithms (depending of
0036+++8F6A~            ; PT3 module version).
0037+++8F6A~            ;-New 1.XX and 2.XX special command behaviour (only for PT v3.7
0038+++8F6A~            ; and higher).
0039+++8F6A~            ;-Any Tempo value are accepted (including Tempo=1 and Tempo=2).
0040+++8F6A~            ;-TS modes: 2xPT3, 2xPT2 and PT v3.7 TS standard.
0041+++8F6A~            ;-Fully compatible with Ay_Emul PT3 and PT2 players codes.
0042+++8F6A~            ;-See also notes at the end of this source code.
0043+++8F6A~            0044+++8F6A~            ;Limitations
0045+++8F6A~            ;-----------
0046+++8F6A~            ;-Can run in RAM only (self-modified code is used).
0047+++8F6A~            ;-PT2 position list must be end by #FF marker only.
0048+++8F6A~            0049+++8F6A~            ;Warning!!! PLAY subprogram can crash if no module are loaded
0050+++8F6A~            ;into RAM or INIT subprogram was not called before.
0051+++8F6A~            0052+++8F6A~            ;Call MUTE or INIT one more time to mute sound after stopping
0053+++8F6A~            ;playing 
0054+++8F6A~            0055+++8F6A~            TonA	EQU 0
0056+++8F6A~            TonB	EQU 2
0057+++8F6A~            TonC	EQU 4
0058+++8F6A~            Noise	EQU 6
0059+++8F6A~            Mixer	EQU 7
0060+++8F6A~            AmplA	EQU 8
0061+++8F6A~            AmplB	EQU 9
0062+++8F6A~            AmplC	EQU 10
0063+++8F6A~            Env	EQU 11
0064+++8F6A~            EnvTp	EQU 13
0065+++8F6A~            0066+++8F6A~            START
0067+++8F6A~            0068+++8F6A~            SETUP.NOLOOP EQU 1
0069+++8F6A~            SETUP.PT2 EQU 2
0070+++8F6A~            SETUP.ACB EQU 4
0071+++8F6A~            SETUP.BAC EQU 8
0072+++8F6A~            SETUP.TS02 EQU 16
0073+++8F6A~            SETUP.TSPT3 EQU 32
0074+++8F6A~            0075+++8F6A~            SETUP	DB 0 ;set bit0, if you want to play without looping
0076+++8F6A~            	     ;(optional);
0077+++8F6A~            	     ;set bit1 for PT2 and reset for PT3 before
0078+++8F6A~            	     ;calling INIT;
0079+++8F6A~            	     ;bits2-3: %00-ABC, %01-ACB, %10-BAC (optional);
0080+++8F6A~            	     ;bits4-5: %00-no TS, %01-2 modules TS, %10-
0081+++8F6A~            	     ;autodetect PT3 TS-format by AlCo (PT 3.7+);
0082+++8F6A~            	     ;Remark: old PT3 TS-format by AlCo (PT 3.6) is not
0083+++8F6A~            	     ;documented and must be converted to new standard.
0084+++8F6A~            	     ;bit6 is set each time, when loop point of 2nd TS
0085+++8F6A~            	     ;module is passed (optional).
0086+++8F6A~            	     ;bit7 is set each time, when loop point of 1st TS
0087+++8F6A~            	     ;or of single module is passed (optional).
0088+++8F6A~            0089+++8F6A~            ;Identifier
0090+++8F6A~            	IF Id
0091+++8F6A~            	DB "=UniPT2/PT3/TS-Player r.",Release,"="
0092+++8F6A~            	ENDIF
0093+++8F6A~            0094+++8F6A~            	IF LoopChecker
0095+++8F6A~            CHECKLP	LD HL,SETUP
0096+++8F6A~            	BIT 0,(IY-100+VRS.ModNum)
0097+++8F6A~            	JR Z,CHL1
0098+++8F6A~            	SET 6,(HL)
0099+++8F6A~            	JR CHL2
0100+++8F6A~            CHL1	SET 7,(HL)
0101+++8F6A~            CHL2	BIT 0,(HL)
0102+++8F6A~            	RET Z
0103+++8F6A~            	POP HL
0104+++8F6A~            	INC (IY-100+VRS.DelyCnt)
0105+++8F6A~            	INC (IY-100+VRS.ChanA+CHP.NtSkCn)
0106+++8F6A~            	XOR A
0107+++8F6A~            	LD (IY-100+VRS.AYREGS+AmplA),A
0108+++8F6A~            	LD (IY-100+VRS.AYREGS+AmplB),A
0109+++8F6A~            	LD (IY-100+VRS.AYREGS+AmplC),A
0110+++8F6A~            	RET
0111+++8F6A~            	ENDIF
0112+++8F6A~            0113+++8F6A~            MUTE	XOR A
0114+++8F6A~            	LD H,A
0115+++8F6A~            	LD L,A
0116+++8F6A~            	LD (VARS1+VRS.AYREGS+AmplA),A
0117+++8F6A~            	LD (VARS1+VRS.AYREGS+AmplB),HL
0118+++8F6A~            	LD (VARS2+VRS.AYREGS+AmplA),A
0119+++8F6A~            	LD (VARS2+VRS.AYREGS+AmplB),HL
0120+++8F6A~            	JP ROUT
0121+++8F6A~            0122+++8F6A~            INIT
0123+++8F6A~            ;HL - AddressOfModule
0124+++8F6A~            ;DE - AddresOf2ndModule
0125+++8F6A~            ;A - mode
0126+++8F6A~            	PUSH DE
0127+++8F6A~            	PUSH HL
0128+++8F6A~            	LD HL,VARS
0129+++8F6A~            	LD (HL),0
0130+++8F6A~            	LD DE,VARS+1
0131+++8F6A~            	LD BC,VAR0END-VARS-1
0132+++8F6A~            	LDIR
0133+++8F6A~            	INC HL
0134+++8F6A~            	LD (VARS1+VRS.AdInPtA),HL ;ptr to zero
0135+++8F6A~            	LD (VARS2+VRS.AdInPtA),HL
0136+++8F6A~            0137+++8F6A~            	POP HL
0138+++8F6A~            	LD IY,VARS1+100
0139+++8F6A~                LD (SETUP),A
0140+++8F6A~            	AND SETUP.PT2
0141+++8F6A~            	JP NZ,I_PT2
0142+++8F6A~            0143+++8F6A~            	CALL INITPT3
0144+++8F6A~            	LD HL,(e_-SamCnv-2)*256+#18
0145+++8F6A~            	LD (SamCnv),HL
0146+++8F6A~            	LD A,#BA
0147+++8F6A~            	LD (OrnCP),A
0148+++8F6A~            	LD (SamCP),A
0149+++8F6A~            	LD A,#7B
0150+++8F6A~            	LD (OrnLD),A
0151+++8F6A~            	LD (SamLD),A
0152+++8F6A~            	LD A,#87
0153+++8F6A~            	LD (SamClc2),A
0154+++8F6A~            	POP HL
0155+++8F6A~            	;Use version and ton table of 1st module
0156+++8F6A~            	LD A,(IX+13-100) ;EXTRACT VERSION NUMBER
0157+++8F6A~            	SUB #30
0158+++8F6A~            	JR C,L20
0159+++8F6A~            	CP 10
0160+++8F6A~            	JR C,L21
0161+++8F6A~            L20	LD A,6
0162+++8F6A~            L21	LD (Version),A
0163+++8F6A~            	PUSH AF ;VolTable version
0164+++8F6A~            	CP 4
0165+++8F6A~            	LD A,(IX+99-100) ;TONE TABLE NUMBER
0166+++8F6A~            	RLA
0167+++8F6A~            	AND 7
0168+++8F6A~            	PUSH AF ;NoteTable number
0169+++8F6A~            0170+++8F6A~            	LD IY,VARS2+100
0171+++8F6A~            	LD A,(SETUP)
0172+++8F6A~            	AND SETUP.TS02|SETUP.TSPT3
0173+++8F6A~            	JR Z,NOTS
0174+++8F6A~            	CP SETUP.TS02
0175+++8F6A~            	JR Z,TwoPT3s
0176+++8F6A~            	LD A,(Version)
0177+++8F6A~            	CP 7
0178+++8F6A~            	JR C,NOTS
0179+++8F6A~            	LD A,(IX+98-100) ;ALCO TS MARKER
0180+++8F6A~            	CP #20
0181+++8F6A~            	JR Z,NOTS
0182+++8F6A~            	LD HL,VARS1
0183+++8F6A~            	LD DE,VARS2
0184+++8F6A~            	LD BC,VRS
0185+++8F6A~            	LDIR
0186+++8F6A~            	SET 1,(IY-100+VRS.ModNum)
0187+++8F6A~            	LD C,A
0188+++8F6A~            	ADD A,A
0189+++8F6A~            	ADD A,C
0190+++8F6A~            	SUB 2
0191+++8F6A~            	LD (TSSub),A
0192+++8F6A~            	JR AlCoTS_
0193+++8F6A~            TwoPT3s	CALL INITPT3
0194+++8F6A~            AlCoTS_	LD A,1
0195+++8F6A~            	LD (is_ts),A
0196+++8F6A~            	SET 0,(IY-100+VRS.ModNum)
0197+++8F6A~            0198+++8F6A~            NOTS	LD BC,PT3PD
0199+++8F6A~            	LD HL,0
0200+++8F6A~            	LD DE,PT3EMPTYORN
0201+++8F6A~            	JR INITCOMMON
0202+++8F6A~            0203+++8F6A~            I_PT2	CALL INITPT2
0204+++8F6A~            	LD HL,#51CB
0205+++8F6A~            	LD (SamCnv),HL
0206+++8F6A~            	LD A,#BB
0207+++8F6A~            	LD (OrnCP),A
0208+++8F6A~            	LD (SamCP),A
0209+++8F6A~            	LD A,#7A
0210+++8F6A~            	LD (OrnLD),A
0211+++8F6A~            	LD (SamLD),A
0212+++8F6A~            	LD A,#80
0213+++8F6A~            	LD (SamClc2),A
0214+++8F6A~            	POP HL
0215+++8F6A~            	LD A,5
0216+++8F6A~            	LD (Version),A
0217+++8F6A~            	PUSH AF
0218+++8F6A~            	LD A,2
0219+++8F6A~            	PUSH AF
0220+++8F6A~            0221+++8F6A~            	LD A,(SETUP)
0222+++8F6A~                AND SETUP.TS02|SETUP.TSPT3
0223+++8F6A~            	JR Z,NOTS2
0224+++8F6A~            0225+++8F6A~            	LD IY,VARS2+100
0226+++8F6A~            	LD A,1
0227+++8F6A~            	LD (is_ts),A
0228+++8F6A~            	SET 0,(IY-100+VRS.ModNum)
0229+++8F6A~            	CALL INITPT2
0230+++8F6A~            0231+++8F6A~            NOTS2	LD BC,PT2PD
0232+++8F6A~            	LD HL,#8687
0233+++8F6A~            	LD DE,PT2EMPTYORN
0234+++8F6A~            0235+++8F6A~            INITCOMMON
0236+++8F6A~            0237+++8F6A~            	IF Basic
0238+++8F6A~            	LD IY,#5C3A
0239+++8F6A~            	ENDIF
0240+++8F6A~            0241+++8F6A~            	LD (PTDEC),BC
0242+++8F6A~            	LD (PsCalc),HL
0243+++8F6A~            	PUSH DE
0244+++8F6A~            0245+++8F6A~            ;note table data depacker
0246+++8F6A~            ;(c) Ivan Roshin
0247+++8F6A~            	LD DE,T_PACK
0248+++8F6A~            	LD BC,T1_+(2*49)-1
0249+++8F6A~            TP_0	LD A,(DE)
0250+++8F6A~            	INC DE
0251+++8F6A~            	CP 15*2
0252+++8F6A~            	JR NC,TP_1
0253+++8F6A~            	LD H,A
0254+++8F6A~            	LD A,(DE)
0255+++8F6A~            	LD L,A
0256+++8F6A~            	INC DE
0257+++8F6A~            	JR TP_2
0258+++8F6A~            TP_1	PUSH DE
0259+++8F6A~            	LD D,0
0260+++8F6A~            	LD E,A
0261+++8F6A~            	ADD HL,DE
0262+++8F6A~            	ADD HL,DE
0263+++8F6A~            	POP DE
0264+++8F6A~            TP_2	LD A,H
0265+++8F6A~            	LD (BC),A
0266+++8F6A~            	DEC BC
0267+++8F6A~            	LD A,L
0268+++8F6A~            	LD (BC),A
0269+++8F6A~            	DEC BC
0270+++8F6A~            	SUB (#F8*2)&255
0271+++8F6A~            	JR NZ,TP_0
0272+++8F6A~            0273+++8F6A~            	INC A
0274+++8F6A~            	LD (VARS1+VRS.DelyCnt),A
0275+++8F6A~            	LD (VARS2+VRS.DelyCnt),A
0276+++8F6A~            	LD HL,#F001 ;H - CHP.Volume, L - CHP.NtSkCn
0277+++8F6A~            	LD (VARS1+VRS.ChanA+CHP.NtSkCn),HL
0278+++8F6A~            	LD (VARS1+VRS.ChanB+CHP.NtSkCn),HL
0279+++8F6A~            	LD (VARS1+VRS.ChanC+CHP.NtSkCn),HL
0280+++8F6A~            	LD (VARS2+VRS.ChanA+CHP.NtSkCn),HL
0281+++8F6A~            	LD (VARS2+VRS.ChanB+CHP.NtSkCn),HL
0282+++8F6A~            	LD (VARS2+VRS.ChanC+CHP.NtSkCn),HL
0283+++8F6A~            	POP HL
0284+++8F6A~            	LD (VARS1+VRS.ChanA+CHP.OrnPtr),HL
0285+++8F6A~            	LD (VARS1+VRS.ChanB+CHP.OrnPtr),HL
0286+++8F6A~            	LD (VARS1+VRS.ChanC+CHP.OrnPtr),HL
0287+++8F6A~            	LD (VARS2+VRS.ChanA+CHP.OrnPtr),HL
0288+++8F6A~            	LD (VARS2+VRS.ChanB+CHP.OrnPtr),HL
0289+++8F6A~            	LD (VARS2+VRS.ChanC+CHP.OrnPtr),HL
0290+++8F6A~            0291+++8F6A~            	POP AF
0292+++8F6A~            0293+++8F6A~            ;NoteTableCreator (c) Ivan Roshin
0294+++8F6A~            ;A - NoteTableNumber*2+VersionForNoteTable
0295+++8F6A~            ;(xx1b - 3.xx..3.4r, xx0b - 3.4x..3.6x..VTII1.0)
0296+++8F6A~            0297+++8F6A~            	LD HL,NT_DATA
0298+++8F6A~            	LD D,0
0299+++8F6A~            	ADD A,A
0300+++8F6A~            	LD E,A
0301+++8F6A~            	ADD HL,DE
0302+++8F6A~            	LD E,(HL)
0303+++8F6A~            	INC HL
0304+++8F6A~            	SRL E
0305+++8F6A~            	SBC A,A
0306+++8F6A~            	AND #A7 ;#00 (NOP) or #A7 (AND A)
0307+++8F6A~            	LD (L3),A
0308+++8F6A~            	EX DE,HL
0309+++8F6A~            	LD BC,T1_
0310+++8F6A~            	ADD HL,BC
0311+++8F6A~            0312+++8F6A~            	LD A,(DE)
0313+++8F6A~            	ADD A,T_&255
0314+++8F6A~            	LD C,A
0315+++8F6A~            	ADC A,T_/256
0316+++8F6A~            	SUB C
0317+++8F6A~            	LD B,A
0318+++8F6A~            	PUSH BC
0319+++8F6A~            	LD DE,NT_
0320+++8F6A~            	PUSH DE
0321+++8F6A~            0322+++8F6A~            	LD B,12
0323+++8F6A~            L1	PUSH BC
0324+++8F6A~            	LD C,(HL)
0325+++8F6A~            	INC HL
0326+++8F6A~            	PUSH HL
0327+++8F6A~            	LD B,(HL)
0328+++8F6A~            0329+++8F6A~            	PUSH DE
0330+++8F6A~            	EX DE,HL
0331+++8F6A~            	LD DE,23
0332+++8F6A~            	LD IXH,8
0333+++8F6A~            0334+++8F6A~            L2	SRL B
0335+++8F6A~            	RR C
0336+++8F6A~            L3	DB #19	;AND A or NOP
0337+++8F6A~            	LD A,C
0338+++8F6A~            	ADC A,D	;=ADC 0
0339+++8F6A~            	LD (HL),A
0340+++8F6A~            	INC HL
0341+++8F6A~            	LD A,B
0342+++8F6A~            	ADC A,D
0343+++8F6A~            	LD (HL),A
0344+++8F6A~            	ADD HL,DE
0345+++8F6A~            	DEC IXH
0346+++8F6A~            	JR NZ,L2
0347+++8F6A~            0348+++8F6A~            	POP DE
0349+++8F6A~            	INC DE
0350+++8F6A~            	INC DE
0351+++8F6A~            	POP HL
0352+++8F6A~            	INC HL
0353+++8F6A~            	POP BC
0354+++8F6A~            	DJNZ L1
0355+++8F6A~            0356+++8F6A~            	POP HL
0357+++8F6A~            	POP DE
0358+++8F6A~            0359+++8F6A~            	LD A,E
0360+++8F6A~            	CP TCOLD_1&255
0361+++8F6A~            	JR NZ,CORR_1
0362+++8F6A~            	LD A,#FD
0363+++8F6A~            	LD (NT_+#2E),A
0364+++8F6A~            0365+++8F6A~            CORR_1	LD A,(DE)
0366+++8F6A~            	AND A
0367+++8F6A~            	JR Z,TC_EXIT
0368+++8F6A~            	RRA
0369+++8F6A~            	PUSH AF
0370+++8F6A~            	ADD A,A
0371+++8F6A~            	LD C,A
0372+++8F6A~            	ADD HL,BC
0373+++8F6A~            	POP AF
0374+++8F6A~            	JR NC,CORR_2
0375+++8F6A~            	DEC (HL)
0376+++8F6A~            	DEC (HL)
0377+++8F6A~            CORR_2	INC (HL)
0378+++8F6A~            	AND A
0379+++8F6A~            	SBC HL,BC
0380+++8F6A~            	INC DE
0381+++8F6A~            	JR CORR_1
0382+++8F6A~            0383+++8F6A~            TC_EXIT
0384+++8F6A~            0385+++8F6A~            	POP AF
0386+++8F6A~            0387+++8F6A~            ;VolTableCreator (c) Ivan Roshin
0388+++8F6A~            ;A - VersionForVolumeTable (0..4 - 3.xx..3.4x;
0389+++8F6A~            			   ;5.. - 2.x,3.5x..3.6x..VTII1.0)
0390+++8F6A~            0391+++8F6A~            	CP 5
0392+++8F6A~            	LD HL,#11
0393+++8F6A~            	LD D,H
0394+++8F6A~            	LD E,H
0395+++8F6A~            	LD A,#17
0396+++8F6A~            	JR NC,M1
0397+++8F6A~            	DEC L
0398+++8F6A~            	LD E,L
0399+++8F6A~            	XOR A
0400+++8F6A~            M1      LD (M2),A
0401+++8F6A~            0402+++8F6A~            	LD IX,VT_+16
0403+++8F6A~            0404+++8F6A~            	LD C,#F
0405+++8F6A~            INITV2  PUSH HL
0406+++8F6A~            0407+++8F6A~            	ADD HL,DE
0408+++8F6A~            	EX DE,HL
0409+++8F6A~            	SBC HL,HL
0410+++8F6A~            0411+++8F6A~            	LD B,#10
0412+++8F6A~            INITV1  LD A,L
0413+++8F6A~            M2      DB #7D
0414+++8F6A~            	LD A,H
0415+++8F6A~            	ADC A,0
0416+++8F6A~            	LD (IX),A
0417+++8F6A~            	INC IX
0418+++8F6A~            	ADD HL,DE
0419+++8F6A~            	DJNZ INITV1
0420+++8F6A~            0421+++8F6A~            	POP HL
0422+++8F6A~            	LD A,E
0423+++8F6A~            	CP #77
0424+++8F6A~            	JR NZ,M3
0425+++8F6A~            	INC E
0426+++8F6A~            M3      DEC C
0427+++8F6A~            	JR NZ,INITV2
0428+++8F6A~            0429+++8F6A~            	JP ROUT
0430+++8F6A~            0431+++8F6A~            INITPT3	CALL SETMDAD
0432+++8F6A~            	PUSH HL
0433+++8F6A~            	LD DE,100
0434+++8F6A~            	ADD HL,DE
0435+++8F6A~            	LD A,(HL)
0436+++8F6A~            	LD (IY-100+VRS.Delay),A
0437+++8F6A~            	PUSH HL
0438+++8F6A~            	POP IX
0439+++8F6A~            	ADD HL,DE
0440+++8F6A~            	CALL SETCPPT
0441+++8F6A~            	LD E,(IX+102-100)
0442+++8F6A~            	INC HL
0443+++8F6A~            0444+++8F6A~            	IF CurPosCounter
0445+++8F6A~            	LD (IY-100+VRS.PosSub),L
0446+++8F6A~            	ENDIF
0447+++8F6A~            0448+++8F6A~            	ADD HL,DE
0449+++8F6A~            	CALL SETLPPT
0450+++8F6A~            	POP DE
0451+++8F6A~            	LD L,(IX+103-100)
0452+++8F6A~            	LD H,(IX+104-100)
0453+++8F6A~            	ADD HL,DE
0454+++8F6A~            	CALL SETPTPT
0455+++8F6A~            	LD HL,169
0456+++8F6A~            	ADD HL,DE
0457+++8F6A~            	CALL SETORPT
0458+++8F6A~            	LD HL,105
0459+++8F6A~            	ADD HL,DE
0460+++8F6A~            0461+++8F6A~            SETSMPT LD (IY-100+VRS.SamPtrs),L
0462+++8F6A~            	LD (IY-100+VRS.SamPtrs+1),H
0463+++8F6A~            	RET
0464+++8F6A~            0465+++8F6A~            INITPT2	LD A,(HL)
0466+++8F6A~            	LD (IY-100+VRS.Delay),A
0467+++8F6A~            	PUSH HL
0468+++8F6A~            	PUSH HL
0469+++8F6A~            	PUSH HL
0470+++8F6A~            	INC HL
0471+++8F6A~            	INC HL
0472+++8F6A~            	LD A,(HL)
0473+++8F6A~            	INC HL
0474+++8F6A~            	CALL SETSMPT
0475+++8F6A~            	LD E,(HL)
0476+++8F6A~            	INC HL
0477+++8F6A~            	LD D,(HL)
0478+++8F6A~            	POP HL
0479+++8F6A~            	AND A
0480+++8F6A~            	SBC HL,DE
0481+++8F6A~            	CALL SETMDAD
0482+++8F6A~            	POP HL
0483+++8F6A~            	LD DE,67
0484+++8F6A~            	ADD HL,DE
0485+++8F6A~            	CALL SETORPT
0486+++8F6A~            	LD E,32
0487+++8F6A~            	ADD HL,DE
0488+++8F6A~            	LD C,(HL)
0489+++8F6A~            	INC HL
0490+++8F6A~            	LD B,(HL)
0491+++8F6A~            	LD E,30
0492+++8F6A~            	ADD HL,DE
0493+++8F6A~            	CALL SETCPPT
0494+++8F6A~            	LD E,A
0495+++8F6A~            	INC HL
0496+++8F6A~            0497+++8F6A~            	IF CurPosCounter
0498+++8F6A~            	LD (IY-100+VRS.PosSub),L
0499+++8F6A~            	ENDIF
0500+++8F6A~            0501+++8F6A~            	ADD HL,DE
0502+++8F6A~            	CALL SETLPPT
0503+++8F6A~            	POP HL
0504+++8F6A~            	ADD HL,BC
0505+++8F6A~            0506+++8F6A~            SETPTPT	LD (IY-100+VRS.PatsPtr),L
0507+++8F6A~            	LD (IY-100+VRS.PatsPtr+1),H
0508+++8F6A~            	RET
0509+++8F6A~            0510+++8F6A~            SETMDAD	LD (IY-100+VRS.MODADDR),L
0511+++8F6A~            	LD (IY-100+VRS.MODADDR+1),H
0512+++8F6A~            	RET
0513+++8F6A~            0514+++8F6A~            SETORPT	LD (IY-100+VRS.OrnPtrs),L
0515+++8F6A~            	LD (IY-100+VRS.OrnPtrs+1),H
0516+++8F6A~            	RET
0517+++8F6A~            0518+++8F6A~            SETCPPT	LD (IY-100+VRS.CrPsPtr),L
0519+++8F6A~            	LD (IY-100+VRS.CrPsPtr+1),H
0520+++8F6A~            	RET
0521+++8F6A~            0522+++8F6A~            SETLPPT	LD (IY-100+VRS.LPosPtr),L
0523+++8F6A~            	LD (IY-100+VRS.LPosPtr+1),H
0524+++8F6A~            	RET
0525+++8F6A~            0526+++8F6A~            SETENBS	LD (IY-100+VRS.EnvBase),L
0527+++8F6A~            	LD (IY-100+VRS.EnvBase+1),H
0528+++8F6A~            	RET
0529+++8F6A~            0530+++8F6A~            SETESLD	LD (IY-100+VRS.CurESld),L
0531+++8F6A~            	LD (IY-100+VRS.CurESld+1),H
0532+++8F6A~            	RET
0533+++8F6A~            0534+++8F6A~            GETIX	PUSH IY
0535+++8F6A~            	POP IX
0536+++8F6A~            	ADD IX,DE
0537+++8F6A~            	RET
0538+++8F6A~            0539+++8F6A~            PTDECOD CALL GETIX
0540+++8F6A~            PTDEC	EQU $+1
0541+++8F6A~            	JP #C3C3
0542+++8F6A~            0543+++8F6A~            ;PT2 pattern decoder
0544+++8F6A~            PD2_SAM	CALL SETSAM
0545+++8F6A~            	JR PD2_LOOP
0546+++8F6A~            0547+++8F6A~            PD2_EOff LD (IX-12+CHP.Env_En),A
0548+++8F6A~            	JR PD2_LOOP
0549+++8F6A~            0550+++8F6A~            PD2_ENV	LD (IX-12+CHP.Env_En),16
0551+++8F6A~            	LD (IY-100+VRS.AYREGS+EnvTp),A
0552+++8F6A~            	LD A,(BC)
0553+++8F6A~            	INC BC
0554+++8F6A~            	LD L,A
0555+++8F6A~            	LD A,(BC)
0556+++8F6A~            	INC BC
0557+++8F6A~            	LD H,A
0558+++8F6A~            	CALL SETENBS
0559+++8F6A~            	JR PD2_LOOP
0560+++8F6A~            0561+++8F6A~            PD2_ORN	CALL SETORN
0562+++8F6A~            	JR PD2_LOOP
0563+++8F6A~            0564+++8F6A~            PD2_SKIP INC A
0565+++8F6A~            	LD (IX-12+CHP.NNtSkp),A
0566+++8F6A~            	JR PD2_LOOP
0567+++8F6A~            0568+++8F6A~            PD2_VOL	RRCA
0569+++8F6A~            	RRCA
0570+++8F6A~            	RRCA
0571+++8F6A~            	RRCA
0572+++8F6A~            	LD (IX-12+CHP.Volume),A
0573+++8F6A~            	JR PD2_LOOP
0574+++8F6A~            0575+++8F6A~            PD2_DEL	CALL C_DELAY
0576+++8F6A~            	JR PD2_LOOP
0577+++8F6A~            0578+++8F6A~            PD2_GLIS SET 2,(IX-12+CHP.Flags)
0579+++8F6A~            	INC A
0580+++8F6A~            	LD (IX-12+CHP.TnSlDl),A
0581+++8F6A~            	LD (IX-12+CHP.TSlCnt),A
0582+++8F6A~            	LD A,(BC)
0583+++8F6A~            	INC BC
0584+++8F6A~                    LD (IX-12+CHP.TSlStp),A
0585+++8F6A~            	ADD A,A
0586+++8F6A~            	SBC A,A
0587+++8F6A~                    LD (IX-12+CHP.TSlStp+1),A
0588+++8F6A~            	SCF
0589+++8F6A~            	JR PD2_LP2
0590+++8F6A~            0591+++8F6A~            PT2PD	AND A
0592+++8F6A~            0593+++8F6A~            PD2_LP2	EX AF,AF'
0594+++8F6A~            0595+++8F6A~            PD2_LOOP LD A,(BC)
0596+++8F6A~            	INC BC
0597+++8F6A~            	ADD A,#20
0598+++8F6A~            	JR Z,PD2_REL
0599+++8F6A~            	JR C,PD2_SAM
0600+++8F6A~            	ADD A,96
0601+++8F6A~            	JR C,PD2_NOTE
0602+++8F6A~            	INC A
0603+++8F6A~            	JR Z,PD2_EOff
0604+++8F6A~            	ADD A,15
0605+++8F6A~            	JP Z,PD_FIN
0606+++8F6A~            	JR C,PD2_ENV
0607+++8F6A~            	ADD A,#10
0608+++8F6A~            	JR C,PD2_ORN
0609+++8F6A~            	ADD A,#40
0610+++8F6A~            	JR C,PD2_SKIP
0611+++8F6A~            	ADD A,#10
0612+++8F6A~            	JR C,PD2_VOL
0613+++8F6A~            	INC A
0614+++8F6A~            	JR Z,PD2_DEL
0615+++8F6A~            	INC A
0616+++8F6A~            	JR Z,PD2_GLIS
0617+++8F6A~            	INC A
0618+++8F6A~            	JR Z,PD2_PORT
0619+++8F6A~            	INC A
0620+++8F6A~            	JR Z,PD2_STOP
0621+++8F6A~            	LD A,(BC)
0622+++8F6A~            	INC BC
0623+++8F6A~            	LD (IX-12+CHP.CrNsSl),A
0624+++8F6A~            	JR PD2_LOOP
0625+++8F6A~            0626+++8F6A~            PD2_PORT RES 2,(IX-12+CHP.Flags)
0627+++8F6A~            	LD A,(BC)
0628+++8F6A~            	INC BC
0629+++8F6A~            	INC BC ;ignoring precalc delta to right sound
0630+++8F6A~            	INC BC
0631+++8F6A~            	SCF
0632+++8F6A~            	JR PD2_LP2
0633+++8F6A~            0634+++8F6A~            PD2_STOP LD (IX-12+CHP.TSlCnt),A
0635+++8F6A~            	JR PD2_LOOP
0636+++8F6A~            0637+++8F6A~            PD2_REL	LD (IX-12+CHP.Flags),A
0638+++8F6A~            	JR PD2_EXIT
0639+++8F6A~            0640+++8F6A~            PD2_NOTE LD L,A
0641+++8F6A~            	LD A,(IX-12+CHP.Note)
0642+++8F6A~            	LD (PrNote+1),A
0643+++8F6A~            	LD (IX-12+CHP.Note),L
0644+++8F6A~            	XOR A
0645+++8F6A~            	LD (IX-12+CHP.TSlCnt),A
0646+++8F6A~            	SET 0,(IX-12+CHP.Flags)
0647+++8F6A~            	EX AF,AF'
0648+++8F6A~            	JR NC,NOGLIS2
0649+++8F6A~            	BIT 2,(IX-12+CHP.Flags)
0650+++8F6A~            	JR NZ,NOPORT2
0651+++8F6A~            	LD (LoStep),A
0652+++8F6A~            	ADD A,A
0653+++8F6A~            	SBC A,A
0654+++8F6A~            	EX AF,AF'
0655+++8F6A~            	LD H,A
0656+++8F6A~            	LD L,A
0657+++8F6A~            	INC A
0658+++8F6A~            	CALL SETPORT
0659+++8F6A~            NOPORT2	LD (IX-12+CHP.TSlCnt),1
0660+++8F6A~            NOGLIS2	XOR A
0661+++8F6A~            0662+++8F6A~            0663+++8F6A~            PD2_EXIT LD (IX-12+CHP.PsInSm),A
0664+++8F6A~            	LD (IX-12+CHP.PsInOr),A
0665+++8F6A~            	LD (IX-12+CHP.CrTnSl),A
0666+++8F6A~            	LD (IX-12+CHP.CrTnSl+1),A
0667+++8F6A~            	JP PD_FIN
0668+++8F6A~            0669+++8F6A~            ;PT3 pattern decoder
0670+++8F6A~            PD_OrSm	LD (IX-12+CHP.Env_En),0
0671+++8F6A~            	CALL SETORN
0672+++8F6A~            PD_SAM_	LD A,(BC)
0673+++8F6A~            	INC BC
0674+++8F6A~            	RRCA
0675+++8F6A~            0676+++8F6A~            PD_SAM	CALL SETSAM
0677+++8F6A~            	JR PD_LOOP
0678+++8F6A~            0679+++8F6A~            PD_VOL	RRCA
0680+++8F6A~            	RRCA
0681+++8F6A~            	RRCA
0682+++8F6A~            	RRCA
0683+++8F6A~            	LD (IX-12+CHP.Volume),A
0684+++8F6A~            	JR PD_LP2
0685+++8F6A~            	
0686+++8F6A~            PD_EOff	LD (IX-12+CHP.Env_En),A
0687+++8F6A~            	LD (IX-12+CHP.PsInOr),A
0688+++8F6A~            	JR PD_LP2
0689+++8F6A~            0690+++8F6A~            PD_SorE	DEC A
0691+++8F6A~            	JR NZ,PD_ENV
0692+++8F6A~            	LD A,(BC)
0693+++8F6A~            	INC BC
0694+++8F6A~            	LD (IX-12+CHP.NNtSkp),A
0695+++8F6A~            	JR PD_LP2
0696+++8F6A~            0697+++8F6A~            PD_ENV	CALL SETENV
0698+++8F6A~            	JR PD_LP2
0699+++8F6A~            0700+++8F6A~            PD_ORN	CALL SETORN
0701+++8F6A~            	JR PD_LOOP
0702+++8F6A~            0703+++8F6A~            PD_ESAM	LD (IX-12+CHP.Env_En),A
0704+++8F6A~            	LD (IX-12+CHP.PsInOr),A
0705+++8F6A~            	CALL NZ,SETENV
0706+++8F6A~            	JR PD_SAM_
0707+++8F6A~            0708+++8F6A~            PT3PD	LD A,(IX-12+CHP.Note)
0709+++8F6A~            	LD (PrNote+1),A
0710+++8F6A~            	LD L,(IX-12+CHP.CrTnSl)
0711+++8F6A~            	LD H,(IX-12+CHP.CrTnSl+1)
0712+++8F6A~            	LD (PrSlide+1),HL
0713+++8F6A~            0714+++8F6A~            PD_LOOP	LD DE,#2010
0715+++8F6A~            PD_LP2	LD A,(BC)
0716+++8F6A~            	INC BC
0717+++8F6A~            	ADD A,E
0718+++8F6A~            	JR C,PD_OrSm
0719+++8F6A~            	ADD A,D
0720+++8F6A~            	JR Z,PD_FIN
0721+++8F6A~            	JR C,PD_SAM
0722+++8F6A~            	ADD A,E
0723+++8F6A~            	JR Z,PD_REL
0724+++8F6A~            	JR C,PD_VOL
0725+++8F6A~            	ADD A,E
0726+++8F6A~            	JR Z,PD_EOff
0727+++8F6A~            	JR C,PD_SorE
0728+++8F6A~            	ADD A,96
0729+++8F6A~            	JR C,PD_NOTE
0730+++8F6A~            	ADD A,E
0731+++8F6A~            	JR C,PD_ORN
0732+++8F6A~            	ADD A,D
0733+++8F6A~            	JR C,PD_NOIS
0734+++8F6A~            	ADD A,E
0735+++8F6A~            	JR C,PD_ESAM
0736+++8F6A~            	ADD A,A
0737+++8F6A~            	LD E,A
0738+++8F6A~            	LD HL,(SPCCOMS+#FF20-#2000)&65535
0739+++8F6A~            	ADD HL,DE
0740+++8F6A~            	LD E,(HL)
0741+++8F6A~            	INC HL
0742+++8F6A~            	LD D,(HL)
0743+++8F6A~            	PUSH DE
0744+++8F6A~            	JR PD_LOOP
0745+++8F6A~            0746+++8F6A~            PD_NOIS	LD (IY-100+VRS.Ns_Base),A
0747+++8F6A~            	JR PD_LP2
0748+++8F6A~            0749+++8F6A~            PD_REL	RES 0,(IX-12+CHP.Flags)
0750+++8F6A~            	JR PD_RES
0751+++8F6A~            0752+++8F6A~            PD_NOTE	LD (IX-12+CHP.Note),A
0753+++8F6A~            	SET 0,(IX-12+CHP.Flags)
0754+++8F6A~            	XOR A
0755+++8F6A~            0756+++8F6A~            PD_RES	LD (PDSP_+1),SP
0757+++8F6A~            	LD SP,IX
0758+++8F6A~            	LD H,A
0759+++8F6A~            	LD L,A
0760+++8F6A~            	PUSH HL
0761+++8F6A~            	PUSH HL
0762+++8F6A~            	PUSH HL
0763+++8F6A~            	PUSH HL
0764+++8F6A~            	PUSH HL
0765+++8F6A~            	PUSH HL
0766+++8F6A~            PDSP_	LD SP,#3131
0767+++8F6A~            0768+++8F6A~            PD_FIN	LD A,(IX-12+CHP.NNtSkp)
0769+++8F6A~            	LD (IX-12+CHP.NtSkCn),A
0770+++8F6A~            	RET
0771+++8F6A~            0772+++8F6A~            C_PORTM LD A,(BC)
0773+++8F6A~            	INC BC
0774+++8F6A~            ;SKIP PRECALCULATED TONE DELTA (BECAUSE
0775+++8F6A~            ;CANNOT BE RIGHT AFTER PT3 COMPILATION)
0776+++8F6A~            	INC BC
0777+++8F6A~            	INC BC
0778+++8F6A~            	EX AF,AF'
0779+++8F6A~            	LD A,(BC) ;SIGNED TONE STEP
0780+++8F6A~            	INC BC
0781+++8F6A~            	LD (LoStep),A
0782+++8F6A~            	LD A,(BC)
0783+++8F6A~            	INC BC
0784+++8F6A~            	AND A
0785+++8F6A~            	EX AF,AF'
0786+++8F6A~            	LD L,(IX-12+CHP.CrTnSl)
0787+++8F6A~            	LD H,(IX-12+CHP.CrTnSl+1)
0788+++8F6A~            0789+++8F6A~            ;Set portamento variables
0790+++8F6A~            ;A - Delay; A' - Hi(Step); ZF' - (A'=0); HL - CrTnSl
0791+++8F6A~            0792+++8F6A~            SETPORT	RES 2,(IX-12+CHP.Flags)
0793+++8F6A~            	LD (IX-12+CHP.TnSlDl),A
0794+++8F6A~            	LD (IX-12+CHP.TSlCnt),A
0795+++8F6A~            	PUSH HL
0796+++8F6A~            	LD DE,NT_
0797+++8F6A~            	LD A,(IX-12+CHP.Note)
0798+++8F6A~            	LD (IX-12+CHP.SlToNt),A
0799+++8F6A~            	ADD A,A
0800+++8F6A~            	LD L,A
0801+++8F6A~            	LD H,0
0802+++8F6A~            	ADD HL,DE
0803+++8F6A~            	LD A,(HL)
0804+++8F6A~            	INC HL
0805+++8F6A~            	LD H,(HL)
0806+++8F6A~            	LD L,A
0807+++8F6A~            	PUSH HL
0808+++8F6A~            PrNote	LD A,#3E
0809+++8F6A~            	LD (IX-12+CHP.Note),A
0810+++8F6A~            	ADD A,A
0811+++8F6A~            	LD L,A
0812+++8F6A~            	LD H,0
0813+++8F6A~            	ADD HL,DE
0814+++8F6A~            	LD E,(HL)
0815+++8F6A~            	INC HL
0816+++8F6A~            	LD D,(HL)
0817+++8F6A~            	POP HL
0818+++8F6A~            	SBC HL,DE
0819+++8F6A~            	LD (IX-12+CHP.TnDelt),L
0820+++8F6A~            	LD (IX-12+CHP.TnDelt+1),H
0821+++8F6A~            	POP DE
0822+++8F6A~            Version EQU $+1
0823+++8F6A~            	LD A,#3E
0824+++8F6A~            	CP 6
0825+++8F6A~            	JR C,OLDPRTM ;Old 3xxx for PT v3.5-
0826+++8F6A~            PrSlide	LD DE,#1111
0827+++8F6A~            	LD (IX-12+CHP.CrTnSl),E
0828+++8F6A~            	LD (IX-12+CHP.CrTnSl+1),D
0829+++8F6A~            LoStep	EQU $+1
0830+++8F6A~            OLDPRTM	LD A,#3E
0831+++8F6A~            	EX AF,AF'
0832+++8F6A~            	JR Z,NOSIG
0833+++8F6A~            	EX DE,HL
0834+++8F6A~            NOSIG	SBC HL,DE
0835+++8F6A~            	JP P,SET_STP
0836+++8F6A~            	CPL
0837+++8F6A~            	EX AF,AF'
0838+++8F6A~            	NEG
0839+++8F6A~            	EX AF,AF'
0840+++8F6A~            SET_STP	LD (IX-12+CHP.TSlStp+1),A
0841+++8F6A~            	EX AF,AF'
0842+++8F6A~            	LD (IX-12+CHP.TSlStp),A
0843+++8F6A~            	LD (IX-12+CHP.COnOff),0
0844+++8F6A~            	RET
0845+++8F6A~            0846+++8F6A~            C_GLISS	SET 2,(IX-12+CHP.Flags)
0847+++8F6A~            	LD A,(BC)
0848+++8F6A~            	INC BC
0849+++8F6A~            	LD (IX-12+CHP.TnSlDl),A
0850+++8F6A~            	AND A
0851+++8F6A~            	JR NZ,GL36
0852+++8F6A~            	LD A,(Version) ;AlCo PT3.7+
0853+++8F6A~            	CP 7
0854+++8F6A~            	SBC A,A
0855+++8F6A~            	INC A
0856+++8F6A~            GL36	LD (IX-12+CHP.TSlCnt),A
0857+++8F6A~            	LD A,(BC)
0858+++8F6A~            	INC BC
0859+++8F6A~            	EX AF,AF'
0860+++8F6A~            	LD A,(BC)
0861+++8F6A~            	INC BC
0862+++8F6A~            	JR SET_STP
0863+++8F6A~            0864+++8F6A~            C_SMPOS	LD A,(BC)
0865+++8F6A~            	INC BC
0866+++8F6A~            	LD (IX-12+CHP.PsInSm),A
0867+++8F6A~            	RET
0868+++8F6A~            0869+++8F6A~            C_ORPOS	LD A,(BC)
0870+++8F6A~            	INC BC
0871+++8F6A~            	LD (IX-12+CHP.PsInOr),A
0872+++8F6A~            	RET
0873+++8F6A~            0874+++8F6A~            C_VIBRT	LD A,(BC)
0875+++8F6A~            	INC BC
0876+++8F6A~            	LD (IX-12+CHP.OnOffD),A
0877+++8F6A~            	LD (IX-12+CHP.COnOff),A
0878+++8F6A~            	LD A,(BC)
0879+++8F6A~            	INC BC
0880+++8F6A~            	LD (IX-12+CHP.OffOnD),A
0881+++8F6A~            	XOR A
0882+++8F6A~            	LD (IX-12+CHP.TSlCnt),A
0883+++8F6A~            	LD (IX-12+CHP.CrTnSl),A
0884+++8F6A~            	LD (IX-12+CHP.CrTnSl+1),A
0885+++8F6A~            	RET
0886+++8F6A~            0887+++8F6A~            C_ENGLS	LD A,(BC)
0888+++8F6A~            	INC BC
0889+++8F6A~            	LD (IY-100+VRS.Env_Del),A
0890+++8F6A~            	LD (IY-100+VRS.CurEDel),A
0891+++8F6A~            	LD A,(BC)
0892+++8F6A~            	INC BC
0893+++8F6A~            	LD L,A
0894+++8F6A~            	LD A,(BC)
0895+++8F6A~            	INC BC
0896+++8F6A~            	LD H,A
0897+++8F6A~            	LD (IY-100+VRS.ESldAdd),L
0898+++8F6A~            	LD (IY-100+VRS.ESldAdd+1),H
0899+++8F6A~            	RET
0900+++8F6A~            0901+++8F6A~            C_DELAY	LD A,(BC)
0902+++8F6A~            	INC BC
0903+++8F6A~            	LD (IY-100+VRS.Delay),A
0904+++8F6A~            	LD HL,VARS2+VRS.ModNum ;if AlCo_TS
0905+++8F6A~            	BIT 1,(HL)
0906+++8F6A~            	RET Z
0907+++8F6A~            	LD (VARS1+VRS.Delay),A
0908+++8F6A~            	LD (VARS1+VRS.DelyCnt),A
0909+++8F6A~            	LD (VARS2+VRS.Delay),A
0910+++8F6A~            	RET
0911+++8F6A~            	
0912+++8F6A~            SETENV	LD (IX-12+CHP.Env_En),E
0913+++8F6A~            	LD (IY-100+VRS.AYREGS+EnvTp),A
0914+++8F6A~            	LD A,(BC)
0915+++8F6A~            	INC BC
0916+++8F6A~            	LD H,A
0917+++8F6A~            	LD A,(BC)
0918+++8F6A~            	INC BC
0919+++8F6A~            	LD L,A
0920+++8F6A~            	CALL SETENBS
0921+++8F6A~            	XOR A
0922+++8F6A~            	LD (IX-12+CHP.PsInOr),A
0923+++8F6A~            	LD (IY-100+VRS.CurEDel),A
0924+++8F6A~            	LD H,A
0925+++8F6A~            	LD L,A
0926+++8F6A~            	JP SETESLD
0927+++8F6A~            0928+++8F6A~            SETORN	ADD A,A
0929+++8F6A~            	LD E,A
0930+++8F6A~            	LD D,0
0931+++8F6A~            	LD (IX-12+CHP.PsInOr),D
0932+++8F6A~            	LD L,(IY-100+VRS.OrnPtrs)
0933+++8F6A~            	LD H,(IY-100+VRS.OrnPtrs+1)
0934+++8F6A~            	ADD HL,DE
0935+++8F6A~            	LD E,(HL)
0936+++8F6A~            	INC HL
0937+++8F6A~            	LD D,(HL)
0938+++8F6A~            	LD L,(IY-100+VRS.MODADDR)
0939+++8F6A~            	LD H,(IY-100+VRS.MODADDR+1)
0940+++8F6A~            	ADD HL,DE
0941+++8F6A~            	LD (IX-12+CHP.OrnPtr),L
0942+++8F6A~            	LD (IX-12+CHP.OrnPtr+1),H
0943+++8F6A~            C_NOP	RET
0944+++8F6A~            0945+++8F6A~            SETSAM	ADD A,A
0946+++8F6A~            	LD E,A
0947+++8F6A~            	LD D,0
0948+++8F6A~            	LD L,(IY-100+VRS.SamPtrs);
0949+++8F6A~            	LD H,(IY-100+VRS.SamPtrs+1);
0950+++8F6A~            	ADD HL,DE
0951+++8F6A~            	LD E,(HL)
0952+++8F6A~            	INC HL
0953+++8F6A~            	LD D,(HL)
0954+++8F6A~            	LD L,(IY-100+VRS.MODADDR)
0955+++8F6A~            	LD H,(IY-100+VRS.MODADDR+1)
0956+++8F6A~            	ADD HL,DE
0957+++8F6A~            	LD (IX-12+CHP.SamPtr),L
0958+++8F6A~            	LD (IX-12+CHP.SamPtr+1),H
0959+++8F6A~            	RET
0960+++8F6A~            0961+++8F6A~            ;ALL 16 ADDRESSES TO PROTECT FROM BROKEN PT3 MODULES
0962+++8F6A~            SPCCOMS DW C_NOP
0963+++8F6A~            	DW C_GLISS
0964+++8F6A~            	DW C_PORTM
0965+++8F6A~            	DW C_SMPOS
0966+++8F6A~            	DW C_ORPOS
0967+++8F6A~            	DW C_VIBRT
0968+++8F6A~            	DW C_NOP
0969+++8F6A~            	DW C_NOP
0970+++8F6A~            	DW C_ENGLS
0971+++8F6A~            	DW C_DELAY
0972+++8F6A~            	DW C_NOP
0973+++8F6A~            	DW C_NOP
0974+++8F6A~            	DW C_NOP
0975+++8F6A~            	DW C_NOP
0976+++8F6A~            	DW C_NOP
0977+++8F6A~            	DW C_NOP
0978+++8F6A~            0979+++8F6A~            CHREGS	CALL GETIX
0980+++8F6A~            	XOR A
0981+++8F6A~            	LD (Ampl),A
0982+++8F6A~            	BIT 0,(IX+CHP.Flags)
0983+++8F6A~            	PUSH HL
0984+++8F6A~            	JP Z,CH_EXIT
0985+++8F6A~            	LD (CSP_+1),SP
0986+++8F6A~            	LD L,(IX+CHP.OrnPtr)
0987+++8F6A~            	LD H,(IX+CHP.OrnPtr+1)
0988+++8F6A~            	LD SP,HL
0989+++8F6A~            	POP DE
0990+++8F6A~            	LD H,A
0991+++8F6A~            	LD A,(IX+CHP.PsInOr)
0992+++8F6A~            	LD L,A
0993+++8F6A~            	ADD HL,SP
0994+++8F6A~            	INC A
0995+++8F6A~            		;PT2	PT3
0996+++8F6A~            OrnCP	INC A	;CP E	CP D
0997+++8F6A~            	JR C,CH_ORPS
0998+++8F6A~            OrnLD	DB 1	;LD A,D	LD A,E
0999+++8F6A~            CH_ORPS	LD (IX+CHP.PsInOr),A
1000+++8F6A~            	LD A,(IX+CHP.Note)
1001+++8F6A~            	ADD A,(HL)
1002+++8F6A~            	JP P,CH_NTP
1003+++8F6A~            	XOR A
1004+++8F6A~            CH_NTP	CP 96
1005+++8F6A~            	JR C,CH_NOK
1006+++8F6A~            	LD A,95
1007+++8F6A~            CH_NOK	ADD A,A
1008+++8F6A~            	EX AF,AF'
1009+++8F6A~            	LD L,(IX+CHP.SamPtr)
1010+++8F6A~            	LD H,(IX+CHP.SamPtr+1)
1011+++8F6A~            	LD SP,HL
1012+++8F6A~            	POP DE
1013+++8F6A~            	LD H,0
1014+++8F6A~            	LD A,(IX+CHP.PsInSm)
1015+++8F6A~            	LD B,A
1016+++8F6A~            	ADD A,A
1017+++8F6A~            SamClc2	ADD A,A ;or ADD A,B for PT2
1018+++8F6A~            	LD L,A
1019+++8F6A~            	ADD HL,SP
1020+++8F6A~            	LD SP,HL
1021+++8F6A~            	LD A,B
1022+++8F6A~            	INC A
1023+++8F6A~            		;PT2	PT3
1024+++8F6A~            SamCP	INC A	;CP E	CP D
1025+++8F6A~            	JR C,CH_SMPS
1026+++8F6A~            SamLD	DB 1	;LD A,D	LD A,E
1027+++8F6A~            CH_SMPS	LD (IX+CHP.PsInSm),A
1028+++8F6A~            	POP BC
1029+++8F6A~            	POP HL
1030+++8F6A~            1031+++8F6A~            ;Convert PT2 sample to PT3
1032+++8F6A~            		;PT2		PT3
1033+++8F6A~            SamCnv	POP HL  ;BIT 2,C	JR e_
1034+++8F6A~            	POP HL	
1035+++8F6A~            	LD H,B
1036+++8F6A~            	JR NZ,$+8
1037+++8F6A~            	EX DE,HL
1038+++8F6A~            	AND A
1039+++8F6A~            	SBC HL,HL
1040+++8F6A~            	SBC HL,DE
1041+++8F6A~            	LD D,C
1042+++8F6A~            	RR C
1043+++8F6A~            	SBC A,A
1044+++8F6A~            	CPL
1045+++8F6A~            	AND #3E
1046+++8F6A~            	RR C
1047+++8F6A~            	RR B
1048+++8F6A~            	AND C
1049+++8F6A~            	LD C,A
1050+++8F6A~            	LD A,B
1051+++8F6A~            	RRA
1052+++8F6A~            	RRA
1053+++8F6A~            	RR D
1054+++8F6A~            	RRA
1055+++8F6A~            	AND #9F
1056+++8F6A~            	LD B,A
1057+++8F6A~            1058+++8F6A~            e_	LD E,(IX+CHP.TnAcc)
1059+++8F6A~            	LD D,(IX+CHP.TnAcc+1)
1060+++8F6A~            	ADD HL,DE
1061+++8F6A~            	BIT 6,B
1062+++8F6A~            	JR Z,CH_NOAC
1063+++8F6A~            	LD (IX+CHP.TnAcc),L
1064+++8F6A~            	LD (IX+CHP.TnAcc+1),H
1065+++8F6A~            CH_NOAC EX DE,HL
1066+++8F6A~            	EX AF,AF'
1067+++8F6A~            	ADD A,NT_&255
1068+++8F6A~            	LD L,A
1069+++8F6A~            	ADC A,NT_/256
1070+++8F6A~            	SUB L
1071+++8F6A~            	LD H,A
1072+++8F6A~            	LD SP,HL
1073+++8F6A~            	POP HL
1074+++8F6A~            	ADD HL,DE
1075+++8F6A~            	LD E,(IX+CHP.CrTnSl)
1076+++8F6A~            	LD D,(IX+CHP.CrTnSl+1)
1077+++8F6A~            	ADD HL,DE
1078+++8F6A~            CSP_	LD SP,#3131
1079+++8F6A~            	EX (SP),HL
1080+++8F6A~            	XOR A
1081+++8F6A~            	OR (IX+CHP.TSlCnt)
1082+++8F6A~            	JR Z,CH_AMP
1083+++8F6A~            	DEC (IX+CHP.TSlCnt)
1084+++8F6A~            	JR NZ,CH_AMP
1085+++8F6A~            	LD A,(IX+CHP.TnSlDl)
1086+++8F6A~            	LD (IX+CHP.TSlCnt),A
1087+++8F6A~            	LD L,(IX+CHP.TSlStp)
1088+++8F6A~            	LD H,(IX+CHP.TSlStp+1)
1089+++8F6A~            	LD A,H
1090+++8F6A~            	ADD HL,DE
1091+++8F6A~            	LD (IX+CHP.CrTnSl),L
1092+++8F6A~            	LD (IX+CHP.CrTnSl+1),H
1093+++8F6A~            	BIT 2,(IX+CHP.Flags)
1094+++8F6A~            	JR NZ,CH_AMP
1095+++8F6A~            	LD E,(IX+CHP.TnDelt)
1096+++8F6A~            	LD D,(IX+CHP.TnDelt+1)
1097+++8F6A~            	AND A
1098+++8F6A~            	JR Z,CH_STPP
1099+++8F6A~            	EX DE,HL
1100+++8F6A~            CH_STPP SBC HL,DE
1101+++8F6A~            	JP M,CH_AMP
1102+++8F6A~            	LD A,(IX+CHP.SlToNt)
1103+++8F6A~            	LD (IX+CHP.Note),A
1104+++8F6A~            	XOR A
1105+++8F6A~            	LD (IX+CHP.TSlCnt),A
1106+++8F6A~            	LD (IX+CHP.CrTnSl),A
1107+++8F6A~            	LD (IX+CHP.CrTnSl+1),A
1108+++8F6A~            CH_AMP	LD A,(IX+CHP.CrAmSl)
1109+++8F6A~            	BIT 7,C
1110+++8F6A~            	JR Z,CH_NOAM
1111+++8F6A~            	BIT 6,C
1112+++8F6A~            	JR Z,CH_AMIN
1113+++8F6A~            	CP 15
1114+++8F6A~            	JR Z,CH_NOAM
1115+++8F6A~            	INC A
1116+++8F6A~            	JR CH_SVAM
1117+++8F6A~            CH_AMIN	CP -15
1118+++8F6A~            	JR Z,CH_NOAM
1119+++8F6A~            	DEC A
1120+++8F6A~            CH_SVAM	LD (IX+CHP.CrAmSl),A
1121+++8F6A~            CH_NOAM	LD L,A
1122+++8F6A~            	LD A,B
1123+++8F6A~            	AND 15
1124+++8F6A~            	ADD A,L
1125+++8F6A~            	JP P,CH_APOS
1126+++8F6A~            	XOR A
1127+++8F6A~            CH_APOS	CP 16
1128+++8F6A~            	JR C,CH_VOL
1129+++8F6A~            	LD A,15
1130+++8F6A~            CH_VOL	OR (IX+CHP.Volume)
1131+++8F6A~            	ADD A,VT_&255
1132+++8F6A~            	LD L,A
1133+++8F6A~            	ADC A,VT_/256
1134+++8F6A~            	SUB L
1135+++8F6A~            	LD H,A
1136+++8F6A~            	LD A,(HL)
1137+++8F6A~            CH_ENV	BIT 0,C
1138+++8F6A~            	JR NZ,CH_NOEN
1139+++8F6A~            	OR (IX+CHP.Env_En)
1140+++8F6A~            CH_NOEN	LD (Ampl),A
1141+++8F6A~            	BIT 7,B
1142+++8F6A~            	LD A,C
1143+++8F6A~            	JR Z,NO_ENSL
1144+++8F6A~            	RLA
1145+++8F6A~            	RLA
1146+++8F6A~            	SRA A
1147+++8F6A~            	SRA A
1148+++8F6A~            	SRA A
1149+++8F6A~            	ADD A,(IX+CHP.CrEnSl) ;SEE COMMENT BELOW
1150+++8F6A~            	BIT 5,B
1151+++8F6A~            	JR Z,NO_ENAC
1152+++8F6A~            	LD (IX+CHP.CrEnSl),A
1153+++8F6A~            NO_ENAC	ADD A,(IY-100+VRS.AddToEn) ;BUG IN PT3 - NEED WORD HERE
1154+++8F6A~            	LD (IY-100+VRS.AddToEn),A
1155+++8F6A~            	JR CH_MIX
1156+++8F6A~            NO_ENSL RRA
1157+++8F6A~            	ADD A,(IX+CHP.CrNsSl)
1158+++8F6A~            	LD (IY-100+VRS.AddToNs),A
1159+++8F6A~            	BIT 5,B
1160+++8F6A~            	JR Z,CH_MIX
1161+++8F6A~            	LD (IX+CHP.CrNsSl),A
1162+++8F6A~            CH_MIX	LD A,B
1163+++8F6A~            	RRA
1164+++8F6A~            	AND #48
1165+++8F6A~            CH_EXIT	OR (IY-100+VRS.AYREGS+Mixer)
1166+++8F6A~            	RRCA
1167+++8F6A~            	LD (IY-100+VRS.AYREGS+Mixer),A
1168+++8F6A~            	POP HL
1169+++8F6A~            	XOR A
1170+++8F6A~            	OR (IX+CHP.COnOff)
1171+++8F6A~            	RET Z
1172+++8F6A~            	DEC (IX+CHP.COnOff)
1173+++8F6A~            	RET NZ
1174+++8F6A~            	XOR (IX+CHP.Flags)
1175+++8F6A~            	LD (IX+CHP.Flags),A
1176+++8F6A~            	RRA
1177+++8F6A~            	LD A,(IX+CHP.OnOffD)
1178+++8F6A~            	JR C,CH_ONDL
1179+++8F6A~            	LD A,(IX+CHP.OffOnD)
1180+++8F6A~            CH_ONDL	LD (IX+CHP.COnOff),A
1181+++8F6A~            	RET
1182+++8F6A~            1183+++8F6A~            PLAY_	XOR A
1184+++8F6A~            	LD (IY-100+VRS.AddToEn),A
1185+++8F6A~            	LD (IY-100+VRS.AYREGS+Mixer),A
1186+++8F6A~            	DEC A
1187+++8F6A~            	LD (IY-100+VRS.AYREGS+EnvTp),A
1188+++8F6A~            	DEC (IY-100+VRS.DelyCnt)
1189+++8F6A~            	JP NZ,PL2
1190+++8F6A~            	DEC (IY-100+VRS.ChanA+CHP.NtSkCn)
1191+++8F6A~            	JR NZ,PL1B
1192+++8F6A~            	LD C,(IY-100+VRS.AdInPtA)
1193+++8F6A~            	LD B,(IY-100+VRS.AdInPtA+1)
1194+++8F6A~            	LD A,(BC)
1195+++8F6A~            	AND A
1196+++8F6A~            	JR NZ,PL1A
1197+++8F6A~            	LD D,A
1198+++8F6A~            	LD (IY-100+VRS.Ns_Base),A
1199+++8F6A~            	LD L,(IY-100+VRS.CrPsPtr)
1200+++8F6A~            	LD H,(IY-100+VRS.CrPsPtr+1)
1201+++8F6A~            	INC HL
1202+++8F6A~            	LD A,(HL)
1203+++8F6A~            	INC A
1204+++8F6A~            	JR NZ,PLNLP
1205+++8F6A~            1206+++8F6A~            	IF LoopChecker
1207+++8F6A~            	CALL CHECKLP
1208+++8F6A~            	ENDIF
1209+++8F6A~            1210+++8F6A~            	LD L,(IY-100+VRS.LPosPtr)
1211+++8F6A~            	LD H,(IY-100+VRS.LPosPtr+1)
1212+++8F6A~            	LD A,(HL)
1213+++8F6A~            	INC A
1214+++8F6A~            PLNLP	CALL SETCPPT
1215+++8F6A~            	DEC A
1216+++8F6A~            	BIT 1,(IY-100+VRS.ModNum)
1217+++8F6A~            	JR Z,NoAlCo
1218+++8F6A~            TSSub	EQU $+1
1219+++8F6A~            	SUB #D6
1220+++8F6A~            	CPL
1221+++8F6A~            NoAlCo
1222+++8F6A~            		;PT2		PT3
1223+++8F6A~            PsCalc	DEC A	;ADD A,A	NOP
1224+++8F6A~            	DEC A	;ADD A,(HL)	NOP
1225+++8F6A~            	ADD A,A
1226+++8F6A~            	LD E,A
1227+++8F6A~            	RL D
1228+++8F6A~            1229+++8F6A~            	IF CurPosCounter
1230+++8F6A~            	LD A,L
1231+++8F6A~            	SUB (IY-100+VRS.PosSub)
1232+++8F6A~            	LD (IY-100+VRS.CurPos),A
1233+++8F6A~            	ENDIF
1234+++8F6A~            1235+++8F6A~            	LD L,(IY-100+VRS.PatsPtr)
1236+++8F6A~            	LD H,(IY-100+VRS.PatsPtr+1)
1237+++8F6A~            	ADD HL,DE
1238+++8F6A~            	LD E,(IY-100+VRS.MODADDR)
1239+++8F6A~            	LD D,(IY-100+VRS.MODADDR+1)
1240+++8F6A~            	LD (PSP_+1),SP
1241+++8F6A~            	LD SP,HL
1242+++8F6A~            	POP HL
1243+++8F6A~            	ADD HL,DE
1244+++8F6A~            	LD B,H
1245+++8F6A~            	LD C,L
1246+++8F6A~            	POP HL
1247+++8F6A~            	ADD HL,DE
1248+++8F6A~            	LD (IY-100+VRS.AdInPtB),L
1249+++8F6A~            	LD (IY-100+VRS.AdInPtB+1),H
1250+++8F6A~            	POP HL
1251+++8F6A~            	ADD HL,DE
1252+++8F6A~            	LD (IY-100+VRS.AdInPtC),L
1253+++8F6A~            	LD (IY-100+VRS.AdInPtC+1),H
1254+++8F6A~            PSP_	LD SP,#3131
1255+++8F6A~            PL1A	LD DE,VRS.ChanA+12-100
1256+++8F6A~            	CALL PTDECOD
1257+++8F6A~            	LD (IY-100+VRS.AdInPtA),C
1258+++8F6A~            	LD (IY-100+VRS.AdInPtA+1),B
1259+++8F6A~            1260+++8F6A~            PL1B	DEC (IY-100+VRS.ChanB+CHP.NtSkCn)
1261+++8F6A~            	JR NZ,PL1C
1262+++8F6A~            	LD DE,VRS.ChanB+12-100
1263+++8F6A~            	LD C,(IY-100+VRS.AdInPtB)
1264+++8F6A~            	LD B,(IY-100+VRS.AdInPtB+1)
1265+++8F6A~            	CALL PTDECOD
1266+++8F6A~            	LD (IY-100+VRS.AdInPtB),C
1267+++8F6A~            	LD (IY-100+VRS.AdInPtB+1),B
1268+++8F6A~            1269+++8F6A~            PL1C	DEC (IY-100+VRS.ChanC+CHP.NtSkCn)
1270+++8F6A~            	JR NZ,PL1D
1271+++8F6A~            	LD DE,VRS.ChanC+12-100
1272+++8F6A~            	LD C,(IY-100+VRS.AdInPtC)
1273+++8F6A~            	LD B,(IY-100+VRS.AdInPtC+1)
1274+++8F6A~            	CALL PTDECOD
1275+++8F6A~            	LD (IY-100+VRS.AdInPtC),C
1276+++8F6A~            	LD (IY-100+VRS.AdInPtC+1),B
1277+++8F6A~            1278+++8F6A~            PL1D	LD A,(IY-100+VRS.Delay)
1279+++8F6A~            	LD (IY-100+VRS.DelyCnt),A
1280+++8F6A~            1281+++8F6A~            PL2	LD DE,VRS.ChanA-100
1282+++8F6A~            	LD L,(IY-100+VRS.AYREGS+TonA)
1283+++8F6A~            	LD H,(IY-100+VRS.AYREGS+TonA+1)
1284+++8F6A~            	CALL CHREGS
1285+++8F6A~            	LD (IY-100+VRS.AYREGS+TonA),L
1286+++8F6A~            	LD (IY-100+VRS.AYREGS+TonA+1),H
1287+++8F6A~            Ampl	EQU $+1
1288+++8F6A~            	LD A,#3E
1289+++8F6A~            	LD (IY-100+VRS.AYREGS+AmplA),A
1290+++8F6A~            	LD DE,VRS.ChanB-100
1291+++8F6A~            	LD L,(IY-100+VRS.AYREGS+TonB)
1292+++8F6A~            	LD H,(IY-100+VRS.AYREGS+TonB+1)
1293+++8F6A~            	CALL CHREGS
1294+++8F6A~            	LD (IY-100+VRS.AYREGS+TonB),L
1295+++8F6A~            	LD (IY-100+VRS.AYREGS+TonB+1),H
1296+++8F6A~            	LD A,(Ampl)
1297+++8F6A~            	LD (IY-100+VRS.AYREGS+AmplB),A
1298+++8F6A~            	LD DE,VRS.ChanC-100
1299+++8F6A~            	LD L,(IY-100+VRS.AYREGS+TonC)
1300+++8F6A~            	LD H,(IY-100+VRS.AYREGS+TonC+1)
1301+++8F6A~            	CALL CHREGS
1302+++8F6A~            	LD (IY-100+VRS.AYREGS+TonC),L
1303+++8F6A~            	LD (IY-100+VRS.AYREGS+TonC+1),H
1304+++8F6A~            	LD A,(Ampl)
1305+++8F6A~            	LD (IY-100+VRS.AYREGS+AmplC),A
1306+++8F6A~            1307+++8F6A~            	LD A,(IY-100+VRS.Ns_Base)
1308+++8F6A~            	ADD (IY-100+VRS.AddToNs)
1309+++8F6A~            	LD (IY-100+VRS.AYREGS+Noise),A
1310+++8F6A~            1311+++8F6A~            	LD A,(IY-100+VRS.AddToEn)
1312+++8F6A~            	LD E,A
1313+++8F6A~            	ADD A,A
1314+++8F6A~            	SBC A,A
1315+++8F6A~            	LD D,A
1316+++8F6A~            	LD L,(IY-100+VRS.EnvBase)
1317+++8F6A~            	LD H,(IY-100+VRS.EnvBase+1)
1318+++8F6A~            	ADD HL,DE
1319+++8F6A~            	LD E,(IY-100+VRS.CurESld)
1320+++8F6A~            	LD D,(IY-100+VRS.CurESld+1)
1321+++8F6A~            	ADD HL,DE
1322+++8F6A~            	LD (IY-100+VRS.AYREGS+Env),L
1323+++8F6A~            	LD (IY-100+VRS.AYREGS+Env+1),H
1324+++8F6A~            1325+++8F6A~            	XOR A
1326+++8F6A~            	OR (IY-100+VRS.CurEDel)
1327+++8F6A~            	RET Z
1328+++8F6A~            	DEC (IY-100+VRS.CurEDel)
1329+++8F6A~            	RET NZ
1330+++8F6A~            	LD A,(IY-100+VRS.Env_Del)
1331+++8F6A~            	LD (IY-100+VRS.CurEDel),A
1332+++8F6A~            	LD L,(IY-100+VRS.ESldAdd)
1333+++8F6A~            	LD H,(IY-100+VRS.ESldAdd+1)
1334+++8F6A~            	ADD HL,DE
1335+++8F6A~            	JP SETESLD
1336+++8F6A~            1337+++8F6A~            PLAY    LD IY,VARS1+100
1338+++8F6A~            	CALL PLAY_
1339+++8F6A~            	LD A,(is_ts)
1340+++8F6A~            	AND A
1341+++8F6A~            	JR Z,PL_nts
1342+++8F6A~            	LD IY,VARS2+100
1343+++8F6A~            	CALL PLAY_
1344+++8F6A~            PL_nts
1345+++8F6A~            	IF Basic
1346+++8F6A~            	LD IY,#5C3A
1347+++8F6A~            	ENDIF
1348+++8F6A~            1349+++8F6A~            ROUT	LD BC,#FFFD
1350+++8F6A~              IFDEF ONtfm
1351+++8F6A~                LD L,#F9
1352+++8F6A~                OUT (C),L
1353+++8F6A~              ELSE
1354+++8F6A~            	LD A,(is_ts)
1355+++8F6A~            	AND A
1356+++8F6A~            	JR Z,r_nts ;keep old standard
1357+++8F6A~            	OUT (C),B
1358+++8F6A~                ENDIF
1359+++8F6A~            r_nts	EX AF,AF'
1360+++8F6A~            1361+++8F6A~            	IF ACBBAC
1362+++8F6A~            	LD IX,VARS1+VRS.AYREGS
1363+++8F6A~            	ELSE
1364+++8F6A~            	LD HL,VARS1+VRS.AYREGS
1365+++8F6A~            	ENDIF
1366+++8F6A~            1367+++8F6A~            	CALL ROUT_
1368+++8F6A~            	EX AF,AF'
1369+++8F6A~            	RET Z
1370+++8F6A~            	LD B,D
1371+++8F6A~            1372+++8F6A~                IFDEF ONtfm
1373+++8F6A~                LD A,#F8
1374+++8F6A~                ELSE
1375+++8F6A~            	CPL
1376+++8F6A~                ENDIF
1377+++8F6A~            	OUT (C),A
1378+++8F6A~            1379+++8F6A~            	IF ACBBAC
1380+++8F6A~            	LD IX,VARS2+VRS.AYREGS
1381+++8F6A~            	ELSE
1382+++8F6A~            	LD HL,VARS2+VRS.AYREGS
1383+++8F6A~            	ENDIF
1384+++8F6A~            1385+++8F6A~            ROUT_
1386+++8F6A~            	IF ACBBAC
1387+++8F6A~            	LD A,(SETUP)
1388+++8F6A~            	AND 12
1389+++8F6A~            	JR Z,ABC
1390+++8F6A~            	ADD A,CHTABLE
1391+++8F6A~            	LD E,A
1392+++8F6A~            	ADC A,CHTABLE/256
1393+++8F6A~            	SUB E
1394+++8F6A~            	LD D,A
1395+++8F6A~            	LD B,0
1396+++8F6A~            	PUSH IX
1397+++8F6A~            	POP HL
1398+++8F6A~            	LD A,(DE)
1399+++8F6A~            	INC DE
1400+++8F6A~            	LD C,A
1401+++8F6A~            	ADD HL,BC
1402+++8F6A~            	LD A,(IX+TonB)
1403+++8F6A~            	LD C,(HL)
1404+++8F6A~            	LD (IX+TonB),C
1405+++8F6A~            	LD (HL),A
1406+++8F6A~            	INC HL
1407+++8F6A~            	LD A,(IX+TonB+1)
1408+++8F6A~            	LD C,(HL)
1409+++8F6A~            	LD (IX+TonB+1),C
1410+++8F6A~            	LD (HL),A
1411+++8F6A~            	LD A,(DE)
1412+++8F6A~            	INC DE
1413+++8F6A~            	LD C,A
1414+++8F6A~            	ADD HL,BC
1415+++8F6A~            	LD A,(IX+AmplB)
1416+++8F6A~            	LD C,(HL)
1417+++8F6A~            	LD (IX+AmplB),C
1418+++8F6A~            	LD (HL),A
1419+++8F6A~            	LD A,(DE)
1420+++8F6A~            	INC DE
1421+++8F6A~            	LD (RxCA1),A
1422+++8F6A~            	XOR 8
1423+++8F6A~            	LD (RxCA2),A
1424+++8F6A~            	LD A,(DE)
1425+++8F6A~            	AND (IX+Mixer)
1426+++8F6A~            	LD E,A
1427+++8F6A~            	LD A,(IX+Mixer)
1428+++8F6A~            RxCA1	DB #E6
1429+++8F6A~            	AND %010010
1430+++8F6A~            	OR E
1431+++8F6A~            	LD E,A
1432+++8F6A~            	LD A,(IX+Mixer)
1433+++8F6A~            	AND %010010
1434+++8F6A~            RxCA2	OR E
1435+++8F6A~            	OR E
1436+++8F6A~            	LD (IX+Mixer),A
1437+++8F6A~            ABC
1438+++8F6A~            	ENDIF
1439+++8F6A~            1440+++8F6A~            	XOR A
1441+++8F6A~            	LD DE,#FFBF
1442+++8F6A~            1443+++8F6A~            	IF ACBBAC
1444+++8F6A~            	LD BC,#FFFD
1445+++8F6A~            	PUSH IX
1446+++8F6A~            	POP HL
1447+++8F6A~            	ENDIF
1448+++8F6A~            1449+++8F6A~            LOUT
1450+++8F6A~                IFDEF ONtfm
1451+++8F6A~                INF 
1452+++8F6A~                JP M,$-2
1453+++8F6A~                ENDIF 
1454+++8F6A~                OUT (C),A
1455+++8F6A~                IFDEF ONtfm
1456+++8F6A~                INF 
1457+++8F6A~                JP M,$-2
1458+++8F6A~                ENDIF 
1459+++8F6A~            	LD B,E
1460+++8F6A~            	OUTI 
1461+++8F6A~            	LD B,D
1462+++8F6A~            	INC A
1463+++8F6A~            	CP 13
1464+++8F6A~            	JR NZ,LOUT
1465+++8F6A~                IFDEF ONtfm
1466+++8F6A~                INF 
1467+++8F6A~                JP M,$-2
1468+++8F6A~                ENDIF 
1469+++8F6A~            	OUT (C),A
1470+++8F6A~            	LD A,(HL)
1471+++8F6A~            	AND A
1472+++8F6A~            	RET M
1473+++8F6A~                IFDEF ONtfm
1474+++8F6A~                INF 
1475+++8F6A~                JP M,$-2
1476+++8F6A~                ENDIF 
1477+++8F6A~            	LD B,E
1478+++8F6A~            	OUT (C),A
1479+++8F6A~            	RET
1480+++8F6A~            1481+++8F6A~            	IF ACBBAC
1482+++8F6A~            CHTABLE	EQU $-4
1483+++8F6A~            	DB 4,5,15,%001001,0,7,7,%100100
1484+++8F6A~            	ENDIF
1485+++8F6A~            1486+++8F6A~            NT_DATA	DB (T_NEW_0-T1_)*2
1487+++8F6A~            	DB TCNEW_0-T_
1488+++8F6A~            	DB (T_OLD_0-T1_)*2+1
1489+++8F6A~            	DB TCOLD_0-T_
1490+++8F6A~            	DB (T_NEW_1-T1_)*2+1
1491+++8F6A~            	DB TCNEW_1-T_
1492+++8F6A~            	DB (T_OLD_1-T1_)*2+1
1493+++8F6A~            	DB TCOLD_1-T_
1494+++8F6A~            	DB (T_NEW_2-T1_)*2
1495+++8F6A~            	DB TCNEW_2-T_
1496+++8F6A~            	DB (T_OLD_2-T1_)*2
1497+++8F6A~            	DB TCOLD_2-T_
1498+++8F6A~            	DB (T_NEW_3-T1_)*2
1499+++8F6A~            	DB TCNEW_3-T_
1500+++8F6A~            	DB (T_OLD_3-T1_)*2
1501+++8F6A~            	DB TCOLD_3-T_
1502+++8F6A~            1503+++8F6A~            T_
1504+++8F6A~            1505+++8F6A~            TCOLD_0	DB #00+1,#04+1,#08+1,#0A+1,#0C+1,#0E+1,#12+1,#14+1
1506+++8F6A~            	DB #18+1,#24+1,#3C+1,0
1507+++8F6A~            TCOLD_1	DB #5C+1,0
1508+++8F6A~            TCOLD_2	DB #30+1,#36+1,#4C+1,#52+1,#5E+1,#70+1,#82,#8C,#9C
1509+++8F6A~            	DB #9E,#A0,#A6,#A8,#AA,#AC,#AE,#AE,0
1510+++8F6A~            TCNEW_3	DB #56+1
1511+++8F6A~            TCOLD_3	DB #1E+1,#22+1,#24+1,#28+1,#2C+1,#2E+1,#32+1,#BE+1,0
1512+++8F6A~            TCNEW_0	DB #1C+1,#20+1,#22+1,#26+1,#2A+1,#2C+1,#30+1,#54+1
1513+++8F6A~            	DB #BC+1,#BE+1,0
1514+++8F6A~            TCNEW_1 EQU TCOLD_1
1515+++8F6A~            TCNEW_2	DB #1A+1,#20+1,#24+1,#28+1,#2A+1,#3A+1,#4C+1,#5E+1
1516+++8F6A~            	DB #BA+1,#BC+1,#BE+1,0
1517+++8F6A~            1518+++8F6A~            PT3EMPTYORN EQU $-1
1519+++8F6A~            	DB 1,0
1520+++8F6A~            1521+++8F6A~            ;first 12 values of tone tables (packed)
1522+++8F6A~            1523+++8F6A~            T_PACK	DB #06EC*2/256,#06EC*2&255
1524+++8F6A~            	DB #0755-#06EC
1525+++8F6A~            	DB #07C5-#0755
1526+++8F6A~            	DB #083B-#07C5
1527+++8F6A~            	DB #08B8-#083B
1528+++8F6A~            	DB #093D-#08B8
1529+++8F6A~            	DB #09CA-#093D
1530+++8F6A~            	DB #0A5F-#09CA
1531+++8F6A~            	DB #0AFC-#0A5F
1532+++8F6A~            	DB #0BA4-#0AFC
1533+++8F6A~            	DB #0C55-#0BA4
1534+++8F6A~            	DB #0D10-#0C55
1535+++8F6A~            	DB #066D*2/256,#066D*2&255
1536+++8F6A~            	DB #06CF-#066D
1537+++8F6A~            	DB #0737-#06CF
1538+++8F6A~            	DB #07A4-#0737
1539+++8F6A~            	DB #0819-#07A4
1540+++8F6A~            	DB #0894-#0819
1541+++8F6A~            	DB #0917-#0894
1542+++8F6A~            	DB #09A1-#0917
1543+++8F6A~            	DB #0A33-#09A1
1544+++8F6A~            	DB #0ACF-#0A33
1545+++8F6A~            	DB #0B73-#0ACF
1546+++8F6A~            	DB #0C22-#0B73
1547+++8F6A~            	DB #0CDA-#0C22
1548+++8F6A~            	DB #0704*2/256,#0704*2&255
1549+++8F6A~            	DB #076E-#0704
1550+++8F6A~            	DB #07E0-#076E
1551+++8F6A~            	DB #0858-#07E0
1552+++8F6A~            	DB #08D6-#0858
1553+++8F6A~            	DB #095C-#08D6
1554+++8F6A~            	DB #09EC-#095C
1555+++8F6A~            	DB #0A82-#09EC
1556+++8F6A~            	DB #0B22-#0A82
1557+++8F6A~            	DB #0BCC-#0B22
1558+++8F6A~            	DB #0C80-#0BCC
1559+++8F6A~            	DB #0D3E-#0C80
1560+++8F6A~            	DB #07E0*2/256,#07E0*2&255
1561+++8F6A~            	DB #0858-#07E0
1562+++8F6A~            	DB #08E0-#0858
1563+++8F6A~            	DB #0960-#08E0
1564+++8F6A~            	DB #09F0-#0960
1565+++8F6A~            	DB #0A88-#09F0
1566+++8F6A~            	DB #0B28-#0A88
1567+++8F6A~            	DB #0BD8-#0B28
1568+++8F6A~            	DB #0C80-#0BD8
1569+++8F6A~            	DB #0D60-#0C80
1570+++8F6A~            	DB #0E10-#0D60
1571+++8F6A~            	DB #0EF8-#0E10
1572+++8F6A~            1573+++8F6A~            ;vars from here can be stripped
1574+++8F6A~            ;you can move VARS to any other address
1575+++8F6A~            1576+++8F6A~            VARS
1577+++8F6A~            1578+++8F6A~            is_ts	DB 0
1579+++8F6A~            1580+++8F6A~            ;ChannelsVars
1581+++8F6A~            	STRUCT	CHP
1582+++8F6A~            ;reset group
1583+++8F6A~            PsInOr	DB 0
1584+++8F6A~            PsInSm	DB 0
1585+++8F6A~            CrAmSl	DB 0
1586+++8F6A~            CrNsSl	DB 0
1587+++8F6A~            CrEnSl	DB 0
1588+++8F6A~            TSlCnt	DB 0
1589+++8F6A~            CrTnSl	DW 0
1590+++8F6A~            TnAcc	DW 0
1591+++8F6A~            COnOff	DB 0
1592+++8F6A~            ;reset group
1593+++8F6A~            1594+++8F6A~            OnOffD	DB 0
1595+++8F6A~            1596+++8F6A~            ;IX for PTDECOD here (+12)
1597+++8F6A~            OffOnD	DB 0
1598+++8F6A~            OrnPtr	DW 0
1599+++8F6A~            SamPtr	DW 0
1600+++8F6A~            NNtSkp	DB 0
1601+++8F6A~            Note	DB 0
1602+++8F6A~            SlToNt	DB 0
1603+++8F6A~            Env_En	DB 0
1604+++8F6A~            Flags	DB 0
1605+++8F6A~             ;Enabled - 0, SimpleGliss - 2
1606+++8F6A~            TnSlDl	DB 0
1607+++8F6A~            TSlStp	DW 0
1608+++8F6A~            TnDelt	DW 0
1609+++8F6A~            NtSkCn	DB 0
1610+++8F6A~            Volume	DB 0
1611+++8F6A~            	ENDS
1612+++8F6A~            1613+++8F6A~            	STRUCT	VRS
1614+++8F6A~            1615+++8F6A~            ;IF not works in STRUCT in SjASM :(
1616+++8F6A~            ;	IF CurPosCounter
1617+++8F6A~            CurPos	DB 0
1618+++8F6A~            PosSub	DB 0
1619+++8F6A~            ;	ENDIF
1620+++8F6A~            1621+++8F6A~            ModNum	DB 0 ;bit0: ChipNum
1622+++8F6A~            	     ;bit1: 1-reversed patterns order (AlCo TS)
1623+++8F6A~            1624+++8F6A~            ChanA	DS CHP
1625+++8F6A~            ChanB	DS CHP
1626+++8F6A~            ChanC	DS CHP
1627+++8F6A~            1628+++8F6A~            ;GlobalVars
1629+++8F6A~            MODADDR	DW 0
1630+++8F6A~            OrnPtrs	DW 0
1631+++8F6A~            SamPtrs	DW 0
1632+++8F6A~            PatsPtr	DW 0
1633+++8F6A~            AdInPtA	DW 0
1634+++8F6A~            AdInPtB	DW 0
1635+++8F6A~            AdInPtC	DW 0
1636+++8F6A~            CrPsPtr	DW 0
1637+++8F6A~            LPosPtr	DW 0
1638+++8F6A~            Delay	DB 0
1639+++8F6A~            DelyCnt	DB 0
1640+++8F6A~            ESldAdd	DW 0
1641+++8F6A~            CurESld	DW 0
1642+++8F6A~            Env_Del	DB 0
1643+++8F6A~            CurEDel	DB 0
1644+++8F6A~            Ns_Base	DB 0
1645+++8F6A~            AddToNs	DB 0
1646+++8F6A~            AddToEn	DB 0
1647+++8F6A~            EnvBase	DW 0
1648+++8F6A~            AYREGS	DS 14
1649+++8F6A~            	ENDS
1650+++8F6A~            1651+++8F6A~            VARS1	DS VRS
1652+++8F6A~            VARS2	DS VRS
1653+++8F6A~            1654+++8F6A~            VT_	EQU $-16
1655+++8F6A~            	DS 256-16 ;CreatedVolumeTableAddress
1656+++8F6A~            1657+++8F6A~            T1_	EQU VT_+16 ;Tone tables data depacked here
1658+++8F6A~            1659+++8F6A~            T_OLD_1	EQU T1_
1660+++8F6A~            T_OLD_2	EQU T_OLD_1+24
1661+++8F6A~            T_OLD_3	EQU T_OLD_2+24
1662+++8F6A~            T_OLD_0	EQU T_OLD_3+2
1663+++8F6A~            T_NEW_0	EQU T_OLD_0
1664+++8F6A~            T_NEW_1	EQU T_OLD_1
1665+++8F6A~            T_NEW_2	EQU T_NEW_0+24
1666+++8F6A~            T_NEW_3	EQU T_OLD_3
1667+++8F6A~            1668+++8F6A~            PT2EMPTYORN EQU VT_+31 ;1,0,0 sequence
1669+++8F6A~            1670+++8F6A~            NT_	DS 192 ;CreatedNoteTableAddress
1671+++8F6A~            1672+++8F6A~            VAR0END	EQU VT_+16 ;INIT zeroes from VARS to VAR0END-1
1673+++8F6A~            1674+++8F6A~            VARSEND EQU $
1675+++8F6A~            MDLADDR EQU $
1676+++8F6A~            1677+++8F6A~                   DISPLAY "PTS player size=",$-START
1678+++8F6A~            1679+++8F6A~            ;Release 0 steps:
1680+++8F6A~            ;04/21/2007
1681+++8F6A~            ;Works start (PTxPlay adaptation); first beta.
1682+++8F6A~            ;04/22/2007
1683+++8F6A~            ;Job finished; beta-testing.
1684+++8F6A~            ;04/23/2007
1685+++8F6A~            ;PT v3.7 TS mode corrected (after AlCo remarks).
1686+++8F6A~            ;04/29/2007
1687+++8F6A~            ;Added 1.XX and 2.XX special commands interpretation for PT3
1688+++8F6A~            ;modules of v3.7+.
1689+++8F6A~            1690+++8F6A~            ;Size (minimal build for ZX Spectrum):
1691+++8F6A~            ;Code block #908 bytes
1692+++8F6A~            ;Variables #2BF bytes (can be stripped)
1693+++8F6A~            ;Total size #908+#2BF=#BC7 (3015) bytes
1694+++8F6A~            1695+++8F6A~                   ENDMOD
1696+++8F6A~            1697+++8F6A                    endif
1698+++8F6A             
0099+++8F6A             PT3.Play=PTS.PLAY
0100+++8F6A             PT3.Mute=PTS.MUTE        
0101+++8F6A             PT3.End
0102+++8F6A             
0103+++8F6A                     display "PT3 module size: ",PT3.End-PT3.Start
0104+++8F6A             
0105+++8F6A                     endif
0106+++8F6A                     
0414++ 8F6A                     include "pt2.asm"
0001+++8F6A                     ifndef _pt2_asm_defined
0002+++8F6A                     define _pt2_asm_defined
0003+++8F6A                     
0004+++8F6A                     module PT2
0005+++8F6A             
0006+++8F6A                     struct Header
0007+++8F6A~            Tempo   db 0 ;02-ff
0008+++8F6A~            Length  db 0 ;01-ff
0009+++8F6A~            Loop    db 0 ;00-fe
0010+++8F6A~            Samples 
0011+++8F6A~                    ds 64 ;(? 00-36){32}
0012+++8F6A~            Ornaments
0013+++8F6A~                    ds 32 ;(? 00-36){16}
0014+++8F6A~            Patterns
0015+++8F6A~                    dw 0 ;? 00-01
0016+++8F6A~            Name    ds 30 ;?
0017+++8F6A~            Positions
0018+++8F6A~                    db 0  ;00-1f
0019+++8F6A~                    db 0  ;ff|00-1f             
0020+++8F6A                     ends
0021+++8F6A                     
0022+++8F6A             Start
0023+++8F6A                     ifndef NoPrologue
0024+++8F6A~                    ld hl,End
0025+++8F6A~                    jr Init
0026+++8F6A~                    jp PTS.PLAY
0027+++8F6A~                    jp PTS.MUTE
0028+++8F6A                     endif
0029+++8F6A             
0030+++8F6A 3E 02       Init    ld a,PTS.SETUP.PT2
0031+++8F6C C3 63 83            jp PTS.INIT
0032+++8F6F                     
0033+++8F6F                     ifdef HaveFormatCheck
0034+++8F6F                     include "format.asm"
0001+++8F6F             ;some format checking macros
0002+++8F6F                     ifndef _format_asm_defined
0003+++8F6F~                    define _format_asm_defined
0004+++8F6F~            0005+++8F6F~                    macro LessOrEqual number
0006+++8F6F~                    ld a,number
0007+++8F6F~                    cp (hl)
0008+++8F6F~                    inc hl
0009+++8F6F~                    ret c
0010+++8F6F~                    endm
0011+++8F6F~                    
0012+++8F6F~                    macro Greater number
0013+++8F6F~                    ld a,(hl)
0014+++8F6F~                    inc hl
0015+++8F6F~                    cp number
0016+++8F6F~                    ret c
0017+++8F6F~                    endm
0018+++8F6F~                    
0019+++8F6F~                    macro AnyByte
0020+++8F6F~                    inc hl
0021+++8F6F~                    endm
0022+++8F6F~                    
0023+++8F6F~                    macro AnyBytes count
0024+++8F6F~                    if count > 7
0025+++8F6F~                    ld a,l
0026+++8F6F~                    add a,count
0027+++8F6F~                    ld l,a
0028+++8F6F~                    adc a,h
0029+++8F6F~                    sub l
0030+++8F6F~                    ld h,a
0031+++8F6F~                    else
0032+++8F6F~                    dup count
0033+++8F6F~                    inc hl
0034+++8F6F~                    edup
0035+++8F6F~                    endif
0036+++8F6F~                    endm
0037+++8F6F~                    
0038+++8F6F~                    macro EqualTo number
0039+++8F6F~                    ld a,number
0040+++8F6F~                    cp (hl)
0041+++8F6F~                    inc hl
0042+++8F6F~                    ret nz
0043+++8F6F~                    endm
0044+++8F6F~            0045+++8F6F                     endif
0046+++8F6F             
0035+++8F6F                     
0036+++8F6F             ;in HL - module addr
0037+++8F6F             ;out Z - is pt2
0038+++8F6F             CheckFormat
0039+++8F6F                     ;Tempo
0040+++8F6F                     Greater 2
0040+++8F6F 7E          >        ld a,(hl)
0040+++8F70 23          >        inc hl
0040+++8F71 FE 02       >        cp number
0040+++8F73 D8          >        ret c
0041+++8F74                     ;Length
0042+++8F74                     Greater 1
0042+++8F74 7E          >        ld a,(hl)
0042+++8F75 23          >        inc hl
0042+++8F76 FE 01       >        cp number
0042+++8F78 D8          >        ret c
0043+++8F79                     ;Loop
0044+++8F79                     LessOrEqual 254
0044+++8F79 3E FE       >        ld a,number
0044+++8F7B BE          >        cp (hl)
0044+++8F7C 23          >        inc hl
0044+++8F7D D8          >        ret c
0045+++8F7E                     ;Samples+Ornaments
0046+++8F7E 06 30               ld b,(Header.Patterns-Header.Samples)/2
0047+++8F80             .samorns
0048+++8F80                     AnyByte
0048+++8F80 23          >        inc hl
0049+++8F81                     LessOrEqual #36
0049+++8F81 3E 36       >        ld a,number
0049+++8F83 BE          >        cp (hl)
0049+++8F84 23          >        inc hl
0049+++8F85 D8          >        ret c
0050+++8F86 10 F8               djnz .samorns
0051+++8F88                     ;Patterns
0052+++8F88                     AnyByte
0052+++8F88 23          >        inc hl
0053+++8F89                     LessOrEqual 1
0053+++8F89 3E 01       >        ld a,number
0053+++8F8B BE          >        cp (hl)
0053+++8F8C 23          >        inc hl
0053+++8F8D D8          >        ret c
0054+++8F8E                     ;Name
0055+++8F8E                     AnyBytes Header.Positions-Header.Name
0055+++8F8E 7D          >        ld a,l
0055+++8F8F C6 1E       >        add a,count
0055+++8F91 6F          >        ld l,a
0055+++8F92 8C          >        adc a,h
0055+++8F93 95          >        sub l
0055+++8F94 67          >        ld h,a
0056+++8F95                     ;Positions
0057+++8F95                     ;first should be not marker
0058+++8F95                     LessOrEqual #1f
0058+++8F95 3E 1F       >        ld a,number
0058+++8F97 BE          >        cp (hl)
0058+++8F98 23          >        inc hl
0058+++8F99 D8          >        ret c
0059+++8F9A 06 FF               ld b,255 ;max positions
0060+++8F9C             .positions
0061+++8F9C 7E                  ld a,(hl)
0062+++8F9D FE FF               cp 255
0063+++8F9F C8                  ret z ;finish
0064+++8FA0                     LessOrEqual #1f
0064+++8FA0 3E 1F       >        ld a,number
0064+++8FA2 BE          >        cp (hl)
0064+++8FA3 23          >        inc hl
0064+++8FA4 D8          >        ret c
0065+++8FA5 10 F5               djnz .positions
0066+++8FA7                     ;fall through
0067+++8FA7 7C          .fail   ld a,h
0068+++8FA8 A7                  and a ;reset Z
0069+++8FA9 C9                  ret
0070+++8FAA             
0071+++8FAA                     display "PT2 checker size: ",$-CheckFormat
0072+++8FAA                     endif
0073+++8FAA                     
0074+++8FAA                     endmod
0075+++8FAA                     
0076+++8FAA                     include "PTSPlay.asm"
0001+++8FAA                     ifndef _pts_asm_defined
0002+++8FAA~                    define _pts_asm_defined
0003+++8FAA~            0004+++8FAA~                    MODULE PTS
0005+++8FAA~                    
0006+++8FAA~            ;Universal PT2'n'PT3 Turbo Sound player for ZX Spectrum
0007+++8FAA~            ;(c)2004-2007 S.V.Bulba <vorobey@mail.khstu.ru>
0008+++8FAA~            ;Specially for AlCo
0009+++8FAA~            ;http://bulba.untergrund.net/ (http://bulba.at.kz/)
0010+++8FAA~            0011+++8FAA~            ;Release number
0012+++8FAA~            Release EQU "0"
0013+++8FAA~            0014+++8FAA~            ;Conditional assembly
0015+++8FAA~            ;1) Current position counters at (Vars1+0) and (Vars2+0)
0016+++8FAA~            CurPosCounter=0
0017+++8FAA~            ;2) Allow channels allocation bits at (SETUP)
0018+++8FAA~            ACBBAC=0
0019+++8FAA~            ;3) Allow loop checking and disabling
0020+++8FAA~            LoopChecker=0
0021+++8FAA~            ;4) Insert official identificator
0022+++8FAA~            Id=0
0023+++8FAA~            ;5) Set IY for correct return to ZX Basic
0024+++8FAA~            Basic=0
0025+++8FAA~            0026+++8FAA~            ;Features
0027+++8FAA~            ;--------
0028+++8FAA~            ;-Can be compiled at any address (i.e. no need rounding ORG
0029+++8FAA~            ; address).
0030+++8FAA~            ;-Variables (VARS) can be located at any address (not only after
0031+++8FAA~            ; code block).
0032+++8FAA~            ;-INIT subprogram checks PT3-module version and rightly
0033+++8FAA~            ; generates both note and volume tables outside of code block
0034+++8FAA~            ; (in VARS).
0035+++8FAA~            ;-Two portamento (spc. command 3xxx) algorithms (depending of
0036+++8FAA~            ; PT3 module version).
0037+++8FAA~            ;-New 1.XX and 2.XX special command behaviour (only for PT v3.7
0038+++8FAA~            ; and higher).
0039+++8FAA~            ;-Any Tempo value are accepted (including Tempo=1 and Tempo=2).
0040+++8FAA~            ;-TS modes: 2xPT3, 2xPT2 and PT v3.7 TS standard.
0041+++8FAA~            ;-Fully compatible with Ay_Emul PT3 and PT2 players codes.
0042+++8FAA~            ;-See also notes at the end of this source code.
0043+++8FAA~            0044+++8FAA~            ;Limitations
0045+++8FAA~            ;-----------
0046+++8FAA~            ;-Can run in RAM only (self-modified code is used).
0047+++8FAA~            ;-PT2 position list must be end by #FF marker only.
0048+++8FAA~            0049+++8FAA~            ;Warning!!! PLAY subprogram can crash if no module are loaded
0050+++8FAA~            ;into RAM or INIT subprogram was not called before.
0051+++8FAA~            0052+++8FAA~            ;Call MUTE or INIT one more time to mute sound after stopping
0053+++8FAA~            ;playing 
0054+++8FAA~            0055+++8FAA~            TonA	EQU 0
0056+++8FAA~            TonB	EQU 2
0057+++8FAA~            TonC	EQU 4
0058+++8FAA~            Noise	EQU 6
0059+++8FAA~            Mixer	EQU 7
0060+++8FAA~            AmplA	EQU 8
0061+++8FAA~            AmplB	EQU 9
0062+++8FAA~            AmplC	EQU 10
0063+++8FAA~            Env	EQU 11
0064+++8FAA~            EnvTp	EQU 13
0065+++8FAA~            0066+++8FAA~            START
0067+++8FAA~            0068+++8FAA~            SETUP.NOLOOP EQU 1
0069+++8FAA~            SETUP.PT2 EQU 2
0070+++8FAA~            SETUP.ACB EQU 4
0071+++8FAA~            SETUP.BAC EQU 8
0072+++8FAA~            SETUP.TS02 EQU 16
0073+++8FAA~            SETUP.TSPT3 EQU 32
0074+++8FAA~            0075+++8FAA~            SETUP	DB 0 ;set bit0, if you want to play without looping
0076+++8FAA~            	     ;(optional);
0077+++8FAA~            	     ;set bit1 for PT2 and reset for PT3 before
0078+++8FAA~            	     ;calling INIT;
0079+++8FAA~            	     ;bits2-3: %00-ABC, %01-ACB, %10-BAC (optional);
0080+++8FAA~            	     ;bits4-5: %00-no TS, %01-2 modules TS, %10-
0081+++8FAA~            	     ;autodetect PT3 TS-format by AlCo (PT 3.7+);
0082+++8FAA~            	     ;Remark: old PT3 TS-format by AlCo (PT 3.6) is not
0083+++8FAA~            	     ;documented and must be converted to new standard.
0084+++8FAA~            	     ;bit6 is set each time, when loop point of 2nd TS
0085+++8FAA~            	     ;module is passed (optional).
0086+++8FAA~            	     ;bit7 is set each time, when loop point of 1st TS
0087+++8FAA~            	     ;or of single module is passed (optional).
0088+++8FAA~            0089+++8FAA~            ;Identifier
0090+++8FAA~            	IF Id
0091+++8FAA~            	DB "=UniPT2/PT3/TS-Player r.",Release,"="
0092+++8FAA~            	ENDIF
0093+++8FAA~            0094+++8FAA~            	IF LoopChecker
0095+++8FAA~            CHECKLP	LD HL,SETUP
0096+++8FAA~            	BIT 0,(IY-100+VRS.ModNum)
0097+++8FAA~            	JR Z,CHL1
0098+++8FAA~            	SET 6,(HL)
0099+++8FAA~            	JR CHL2
0100+++8FAA~            CHL1	SET 7,(HL)
0101+++8FAA~            CHL2	BIT 0,(HL)
0102+++8FAA~            	RET Z
0103+++8FAA~            	POP HL
0104+++8FAA~            	INC (IY-100+VRS.DelyCnt)
0105+++8FAA~            	INC (IY-100+VRS.ChanA+CHP.NtSkCn)
0106+++8FAA~            	XOR A
0107+++8FAA~            	LD (IY-100+VRS.AYREGS+AmplA),A
0108+++8FAA~            	LD (IY-100+VRS.AYREGS+AmplB),A
0109+++8FAA~            	LD (IY-100+VRS.AYREGS+AmplC),A
0110+++8FAA~            	RET
0111+++8FAA~            	ENDIF
0112+++8FAA~            0113+++8FAA~            MUTE	XOR A
0114+++8FAA~            	LD H,A
0115+++8FAA~            	LD L,A
0116+++8FAA~            	LD (VARS1+VRS.AYREGS+AmplA),A
0117+++8FAA~            	LD (VARS1+VRS.AYREGS+AmplB),HL
0118+++8FAA~            	LD (VARS2+VRS.AYREGS+AmplA),A
0119+++8FAA~            	LD (VARS2+VRS.AYREGS+AmplB),HL
0120+++8FAA~            	JP ROUT
0121+++8FAA~            0122+++8FAA~            INIT
0123+++8FAA~            ;HL - AddressOfModule
0124+++8FAA~            ;DE - AddresOf2ndModule
0125+++8FAA~            ;A - mode
0126+++8FAA~            	PUSH DE
0127+++8FAA~            	PUSH HL
0128+++8FAA~            	LD HL,VARS
0129+++8FAA~            	LD (HL),0
0130+++8FAA~            	LD DE,VARS+1
0131+++8FAA~            	LD BC,VAR0END-VARS-1
0132+++8FAA~            	LDIR
0133+++8FAA~            	INC HL
0134+++8FAA~            	LD (VARS1+VRS.AdInPtA),HL ;ptr to zero
0135+++8FAA~            	LD (VARS2+VRS.AdInPtA),HL
0136+++8FAA~            0137+++8FAA~            	POP HL
0138+++8FAA~            	LD IY,VARS1+100
0139+++8FAA~                LD (SETUP),A
0140+++8FAA~            	AND SETUP.PT2
0141+++8FAA~            	JP NZ,I_PT2
0142+++8FAA~            0143+++8FAA~            	CALL INITPT3
0144+++8FAA~            	LD HL,(e_-SamCnv-2)*256+#18
0145+++8FAA~            	LD (SamCnv),HL
0146+++8FAA~            	LD A,#BA
0147+++8FAA~            	LD (OrnCP),A
0148+++8FAA~            	LD (SamCP),A
0149+++8FAA~            	LD A,#7B
0150+++8FAA~            	LD (OrnLD),A
0151+++8FAA~            	LD (SamLD),A
0152+++8FAA~            	LD A,#87
0153+++8FAA~            	LD (SamClc2),A
0154+++8FAA~            	POP HL
0155+++8FAA~            	;Use version and ton table of 1st module
0156+++8FAA~            	LD A,(IX+13-100) ;EXTRACT VERSION NUMBER
0157+++8FAA~            	SUB #30
0158+++8FAA~            	JR C,L20
0159+++8FAA~            	CP 10
0160+++8FAA~            	JR C,L21
0161+++8FAA~            L20	LD A,6
0162+++8FAA~            L21	LD (Version),A
0163+++8FAA~            	PUSH AF ;VolTable version
0164+++8FAA~            	CP 4
0165+++8FAA~            	LD A,(IX+99-100) ;TONE TABLE NUMBER
0166+++8FAA~            	RLA
0167+++8FAA~            	AND 7
0168+++8FAA~            	PUSH AF ;NoteTable number
0169+++8FAA~            0170+++8FAA~            	LD IY,VARS2+100
0171+++8FAA~            	LD A,(SETUP)
0172+++8FAA~            	AND SETUP.TS02|SETUP.TSPT3
0173+++8FAA~            	JR Z,NOTS
0174+++8FAA~            	CP SETUP.TS02
0175+++8FAA~            	JR Z,TwoPT3s
0176+++8FAA~            	LD A,(Version)
0177+++8FAA~            	CP 7
0178+++8FAA~            	JR C,NOTS
0179+++8FAA~            	LD A,(IX+98-100) ;ALCO TS MARKER
0180+++8FAA~            	CP #20
0181+++8FAA~            	JR Z,NOTS
0182+++8FAA~            	LD HL,VARS1
0183+++8FAA~            	LD DE,VARS2
0184+++8FAA~            	LD BC,VRS
0185+++8FAA~            	LDIR
0186+++8FAA~            	SET 1,(IY-100+VRS.ModNum)
0187+++8FAA~            	LD C,A
0188+++8FAA~            	ADD A,A
0189+++8FAA~            	ADD A,C
0190+++8FAA~            	SUB 2
0191+++8FAA~            	LD (TSSub),A
0192+++8FAA~            	JR AlCoTS_
0193+++8FAA~            TwoPT3s	CALL INITPT3
0194+++8FAA~            AlCoTS_	LD A,1
0195+++8FAA~            	LD (is_ts),A
0196+++8FAA~            	SET 0,(IY-100+VRS.ModNum)
0197+++8FAA~            0198+++8FAA~            NOTS	LD BC,PT3PD
0199+++8FAA~            	LD HL,0
0200+++8FAA~            	LD DE,PT3EMPTYORN
0201+++8FAA~            	JR INITCOMMON
0202+++8FAA~            0203+++8FAA~            I_PT2	CALL INITPT2
0204+++8FAA~            	LD HL,#51CB
0205+++8FAA~            	LD (SamCnv),HL
0206+++8FAA~            	LD A,#BB
0207+++8FAA~            	LD (OrnCP),A
0208+++8FAA~            	LD (SamCP),A
0209+++8FAA~            	LD A,#7A
0210+++8FAA~            	LD (OrnLD),A
0211+++8FAA~            	LD (SamLD),A
0212+++8FAA~            	LD A,#80
0213+++8FAA~            	LD (SamClc2),A
0214+++8FAA~            	POP HL
0215+++8FAA~            	LD A,5
0216+++8FAA~            	LD (Version),A
0217+++8FAA~            	PUSH AF
0218+++8FAA~            	LD A,2
0219+++8FAA~            	PUSH AF
0220+++8FAA~            0221+++8FAA~            	LD A,(SETUP)
0222+++8FAA~                AND SETUP.TS02|SETUP.TSPT3
0223+++8FAA~            	JR Z,NOTS2
0224+++8FAA~            0225+++8FAA~            	LD IY,VARS2+100
0226+++8FAA~            	LD A,1
0227+++8FAA~            	LD (is_ts),A
0228+++8FAA~            	SET 0,(IY-100+VRS.ModNum)
0229+++8FAA~            	CALL INITPT2
0230+++8FAA~            0231+++8FAA~            NOTS2	LD BC,PT2PD
0232+++8FAA~            	LD HL,#8687
0233+++8FAA~            	LD DE,PT2EMPTYORN
0234+++8FAA~            0235+++8FAA~            INITCOMMON
0236+++8FAA~            0237+++8FAA~            	IF Basic
0238+++8FAA~            	LD IY,#5C3A
0239+++8FAA~            	ENDIF
0240+++8FAA~            0241+++8FAA~            	LD (PTDEC),BC
0242+++8FAA~            	LD (PsCalc),HL
0243+++8FAA~            	PUSH DE
0244+++8FAA~            0245+++8FAA~            ;note table data depacker
0246+++8FAA~            ;(c) Ivan Roshin
0247+++8FAA~            	LD DE,T_PACK
0248+++8FAA~            	LD BC,T1_+(2*49)-1
0249+++8FAA~            TP_0	LD A,(DE)
0250+++8FAA~            	INC DE
0251+++8FAA~            	CP 15*2
0252+++8FAA~            	JR NC,TP_1
0253+++8FAA~            	LD H,A
0254+++8FAA~            	LD A,(DE)
0255+++8FAA~            	LD L,A
0256+++8FAA~            	INC DE
0257+++8FAA~            	JR TP_2
0258+++8FAA~            TP_1	PUSH DE
0259+++8FAA~            	LD D,0
0260+++8FAA~            	LD E,A
0261+++8FAA~            	ADD HL,DE
0262+++8FAA~            	ADD HL,DE
0263+++8FAA~            	POP DE
0264+++8FAA~            TP_2	LD A,H
0265+++8FAA~            	LD (BC),A
0266+++8FAA~            	DEC BC
0267+++8FAA~            	LD A,L
0268+++8FAA~            	LD (BC),A
0269+++8FAA~            	DEC BC
0270+++8FAA~            	SUB (#F8*2)&255
0271+++8FAA~            	JR NZ,TP_0
0272+++8FAA~            0273+++8FAA~            	INC A
0274+++8FAA~            	LD (VARS1+VRS.DelyCnt),A
0275+++8FAA~            	LD (VARS2+VRS.DelyCnt),A
0276+++8FAA~            	LD HL,#F001 ;H - CHP.Volume, L - CHP.NtSkCn
0277+++8FAA~            	LD (VARS1+VRS.ChanA+CHP.NtSkCn),HL
0278+++8FAA~            	LD (VARS1+VRS.ChanB+CHP.NtSkCn),HL
0279+++8FAA~            	LD (VARS1+VRS.ChanC+CHP.NtSkCn),HL
0280+++8FAA~            	LD (VARS2+VRS.ChanA+CHP.NtSkCn),HL
0281+++8FAA~            	LD (VARS2+VRS.ChanB+CHP.NtSkCn),HL
0282+++8FAA~            	LD (VARS2+VRS.ChanC+CHP.NtSkCn),HL
0283+++8FAA~            	POP HL
0284+++8FAA~            	LD (VARS1+VRS.ChanA+CHP.OrnPtr),HL
0285+++8FAA~            	LD (VARS1+VRS.ChanB+CHP.OrnPtr),HL
0286+++8FAA~            	LD (VARS1+VRS.ChanC+CHP.OrnPtr),HL
0287+++8FAA~            	LD (VARS2+VRS.ChanA+CHP.OrnPtr),HL
0288+++8FAA~            	LD (VARS2+VRS.ChanB+CHP.OrnPtr),HL
0289+++8FAA~            	LD (VARS2+VRS.ChanC+CHP.OrnPtr),HL
0290+++8FAA~            0291+++8FAA~            	POP AF
0292+++8FAA~            0293+++8FAA~            ;NoteTableCreator (c) Ivan Roshin
0294+++8FAA~            ;A - NoteTableNumber*2+VersionForNoteTable
0295+++8FAA~            ;(xx1b - 3.xx..3.4r, xx0b - 3.4x..3.6x..VTII1.0)
0296+++8FAA~            0297+++8FAA~            	LD HL,NT_DATA
0298+++8FAA~            	LD D,0
0299+++8FAA~            	ADD A,A
0300+++8FAA~            	LD E,A
0301+++8FAA~            	ADD HL,DE
0302+++8FAA~            	LD E,(HL)
0303+++8FAA~            	INC HL
0304+++8FAA~            	SRL E
0305+++8FAA~            	SBC A,A
0306+++8FAA~            	AND #A7 ;#00 (NOP) or #A7 (AND A)
0307+++8FAA~            	LD (L3),A
0308+++8FAA~            	EX DE,HL
0309+++8FAA~            	LD BC,T1_
0310+++8FAA~            	ADD HL,BC
0311+++8FAA~            0312+++8FAA~            	LD A,(DE)
0313+++8FAA~            	ADD A,T_&255
0314+++8FAA~            	LD C,A
0315+++8FAA~            	ADC A,T_/256
0316+++8FAA~            	SUB C
0317+++8FAA~            	LD B,A
0318+++8FAA~            	PUSH BC
0319+++8FAA~            	LD DE,NT_
0320+++8FAA~            	PUSH DE
0321+++8FAA~            0322+++8FAA~            	LD B,12
0323+++8FAA~            L1	PUSH BC
0324+++8FAA~            	LD C,(HL)
0325+++8FAA~            	INC HL
0326+++8FAA~            	PUSH HL
0327+++8FAA~            	LD B,(HL)
0328+++8FAA~            0329+++8FAA~            	PUSH DE
0330+++8FAA~            	EX DE,HL
0331+++8FAA~            	LD DE,23
0332+++8FAA~            	LD IXH,8
0333+++8FAA~            0334+++8FAA~            L2	SRL B
0335+++8FAA~            	RR C
0336+++8FAA~            L3	DB #19	;AND A or NOP
0337+++8FAA~            	LD A,C
0338+++8FAA~            	ADC A,D	;=ADC 0
0339+++8FAA~            	LD (HL),A
0340+++8FAA~            	INC HL
0341+++8FAA~            	LD A,B
0342+++8FAA~            	ADC A,D
0343+++8FAA~            	LD (HL),A
0344+++8FAA~            	ADD HL,DE
0345+++8FAA~            	DEC IXH
0346+++8FAA~            	JR NZ,L2
0347+++8FAA~            0348+++8FAA~            	POP DE
0349+++8FAA~            	INC DE
0350+++8FAA~            	INC DE
0351+++8FAA~            	POP HL
0352+++8FAA~            	INC HL
0353+++8FAA~            	POP BC
0354+++8FAA~            	DJNZ L1
0355+++8FAA~            0356+++8FAA~            	POP HL
0357+++8FAA~            	POP DE
0358+++8FAA~            0359+++8FAA~            	LD A,E
0360+++8FAA~            	CP TCOLD_1&255
0361+++8FAA~            	JR NZ,CORR_1
0362+++8FAA~            	LD A,#FD
0363+++8FAA~            	LD (NT_+#2E),A
0364+++8FAA~            0365+++8FAA~            CORR_1	LD A,(DE)
0366+++8FAA~            	AND A
0367+++8FAA~            	JR Z,TC_EXIT
0368+++8FAA~            	RRA
0369+++8FAA~            	PUSH AF
0370+++8FAA~            	ADD A,A
0371+++8FAA~            	LD C,A
0372+++8FAA~            	ADD HL,BC
0373+++8FAA~            	POP AF
0374+++8FAA~            	JR NC,CORR_2
0375+++8FAA~            	DEC (HL)
0376+++8FAA~            	DEC (HL)
0377+++8FAA~            CORR_2	INC (HL)
0378+++8FAA~            	AND A
0379+++8FAA~            	SBC HL,BC
0380+++8FAA~            	INC DE
0381+++8FAA~            	JR CORR_1
0382+++8FAA~            0383+++8FAA~            TC_EXIT
0384+++8FAA~            0385+++8FAA~            	POP AF
0386+++8FAA~            0387+++8FAA~            ;VolTableCreator (c) Ivan Roshin
0388+++8FAA~            ;A - VersionForVolumeTable (0..4 - 3.xx..3.4x;
0389+++8FAA~            			   ;5.. - 2.x,3.5x..3.6x..VTII1.0)
0390+++8FAA~            0391+++8FAA~            	CP 5
0392+++8FAA~            	LD HL,#11
0393+++8FAA~            	LD D,H
0394+++8FAA~            	LD E,H
0395+++8FAA~            	LD A,#17
0396+++8FAA~            	JR NC,M1
0397+++8FAA~            	DEC L
0398+++8FAA~            	LD E,L
0399+++8FAA~            	XOR A
0400+++8FAA~            M1      LD (M2),A
0401+++8FAA~            0402+++8FAA~            	LD IX,VT_+16
0403+++8FAA~            0404+++8FAA~            	LD C,#F
0405+++8FAA~            INITV2  PUSH HL
0406+++8FAA~            0407+++8FAA~            	ADD HL,DE
0408+++8FAA~            	EX DE,HL
0409+++8FAA~            	SBC HL,HL
0410+++8FAA~            0411+++8FAA~            	LD B,#10
0412+++8FAA~            INITV1  LD A,L
0413+++8FAA~            M2      DB #7D
0414+++8FAA~            	LD A,H
0415+++8FAA~            	ADC A,0
0416+++8FAA~            	LD (IX),A
0417+++8FAA~            	INC IX
0418+++8FAA~            	ADD HL,DE
0419+++8FAA~            	DJNZ INITV1
0420+++8FAA~            0421+++8FAA~            	POP HL
0422+++8FAA~            	LD A,E
0423+++8FAA~            	CP #77
0424+++8FAA~            	JR NZ,M3
0425+++8FAA~            	INC E
0426+++8FAA~            M3      DEC C
0427+++8FAA~            	JR NZ,INITV2
0428+++8FAA~            0429+++8FAA~            	JP ROUT
0430+++8FAA~            0431+++8FAA~            INITPT3	CALL SETMDAD
0432+++8FAA~            	PUSH HL
0433+++8FAA~            	LD DE,100
0434+++8FAA~            	ADD HL,DE
0435+++8FAA~            	LD A,(HL)
0436+++8FAA~            	LD (IY-100+VRS.Delay),A
0437+++8FAA~            	PUSH HL
0438+++8FAA~            	POP IX
0439+++8FAA~            	ADD HL,DE
0440+++8FAA~            	CALL SETCPPT
0441+++8FAA~            	LD E,(IX+102-100)
0442+++8FAA~            	INC HL
0443+++8FAA~            0444+++8FAA~            	IF CurPosCounter
0445+++8FAA~            	LD (IY-100+VRS.PosSub),L
0446+++8FAA~            	ENDIF
0447+++8FAA~            0448+++8FAA~            	ADD HL,DE
0449+++8FAA~            	CALL SETLPPT
0450+++8FAA~            	POP DE
0451+++8FAA~            	LD L,(IX+103-100)
0452+++8FAA~            	LD H,(IX+104-100)
0453+++8FAA~            	ADD HL,DE
0454+++8FAA~            	CALL SETPTPT
0455+++8FAA~            	LD HL,169
0456+++8FAA~            	ADD HL,DE
0457+++8FAA~            	CALL SETORPT
0458+++8FAA~            	LD HL,105
0459+++8FAA~            	ADD HL,DE
0460+++8FAA~            0461+++8FAA~            SETSMPT LD (IY-100+VRS.SamPtrs),L
0462+++8FAA~            	LD (IY-100+VRS.SamPtrs+1),H
0463+++8FAA~            	RET
0464+++8FAA~            0465+++8FAA~            INITPT2	LD A,(HL)
0466+++8FAA~            	LD (IY-100+VRS.Delay),A
0467+++8FAA~            	PUSH HL
0468+++8FAA~            	PUSH HL
0469+++8FAA~            	PUSH HL
0470+++8FAA~            	INC HL
0471+++8FAA~            	INC HL
0472+++8FAA~            	LD A,(HL)
0473+++8FAA~            	INC HL
0474+++8FAA~            	CALL SETSMPT
0475+++8FAA~            	LD E,(HL)
0476+++8FAA~            	INC HL
0477+++8FAA~            	LD D,(HL)
0478+++8FAA~            	POP HL
0479+++8FAA~            	AND A
0480+++8FAA~            	SBC HL,DE
0481+++8FAA~            	CALL SETMDAD
0482+++8FAA~            	POP HL
0483+++8FAA~            	LD DE,67
0484+++8FAA~            	ADD HL,DE
0485+++8FAA~            	CALL SETORPT
0486+++8FAA~            	LD E,32
0487+++8FAA~            	ADD HL,DE
0488+++8FAA~            	LD C,(HL)
0489+++8FAA~            	INC HL
0490+++8FAA~            	LD B,(HL)
0491+++8FAA~            	LD E,30
0492+++8FAA~            	ADD HL,DE
0493+++8FAA~            	CALL SETCPPT
0494+++8FAA~            	LD E,A
0495+++8FAA~            	INC HL
0496+++8FAA~            0497+++8FAA~            	IF CurPosCounter
0498+++8FAA~            	LD (IY-100+VRS.PosSub),L
0499+++8FAA~            	ENDIF
0500+++8FAA~            0501+++8FAA~            	ADD HL,DE
0502+++8FAA~            	CALL SETLPPT
0503+++8FAA~            	POP HL
0504+++8FAA~            	ADD HL,BC
0505+++8FAA~            0506+++8FAA~            SETPTPT	LD (IY-100+VRS.PatsPtr),L
0507+++8FAA~            	LD (IY-100+VRS.PatsPtr+1),H
0508+++8FAA~            	RET
0509+++8FAA~            0510+++8FAA~            SETMDAD	LD (IY-100+VRS.MODADDR),L
0511+++8FAA~            	LD (IY-100+VRS.MODADDR+1),H
0512+++8FAA~            	RET
0513+++8FAA~            0514+++8FAA~            SETORPT	LD (IY-100+VRS.OrnPtrs),L
0515+++8FAA~            	LD (IY-100+VRS.OrnPtrs+1),H
0516+++8FAA~            	RET
0517+++8FAA~            0518+++8FAA~            SETCPPT	LD (IY-100+VRS.CrPsPtr),L
0519+++8FAA~            	LD (IY-100+VRS.CrPsPtr+1),H
0520+++8FAA~            	RET
0521+++8FAA~            0522+++8FAA~            SETLPPT	LD (IY-100+VRS.LPosPtr),L
0523+++8FAA~            	LD (IY-100+VRS.LPosPtr+1),H
0524+++8FAA~            	RET
0525+++8FAA~            0526+++8FAA~            SETENBS	LD (IY-100+VRS.EnvBase),L
0527+++8FAA~            	LD (IY-100+VRS.EnvBase+1),H
0528+++8FAA~            	RET
0529+++8FAA~            0530+++8FAA~            SETESLD	LD (IY-100+VRS.CurESld),L
0531+++8FAA~            	LD (IY-100+VRS.CurESld+1),H
0532+++8FAA~            	RET
0533+++8FAA~            0534+++8FAA~            GETIX	PUSH IY
0535+++8FAA~            	POP IX
0536+++8FAA~            	ADD IX,DE
0537+++8FAA~            	RET
0538+++8FAA~            0539+++8FAA~            PTDECOD CALL GETIX
0540+++8FAA~            PTDEC	EQU $+1
0541+++8FAA~            	JP #C3C3
0542+++8FAA~            0543+++8FAA~            ;PT2 pattern decoder
0544+++8FAA~            PD2_SAM	CALL SETSAM
0545+++8FAA~            	JR PD2_LOOP
0546+++8FAA~            0547+++8FAA~            PD2_EOff LD (IX-12+CHP.Env_En),A
0548+++8FAA~            	JR PD2_LOOP
0549+++8FAA~            0550+++8FAA~            PD2_ENV	LD (IX-12+CHP.Env_En),16
0551+++8FAA~            	LD (IY-100+VRS.AYREGS+EnvTp),A
0552+++8FAA~            	LD A,(BC)
0553+++8FAA~            	INC BC
0554+++8FAA~            	LD L,A
0555+++8FAA~            	LD A,(BC)
0556+++8FAA~            	INC BC
0557+++8FAA~            	LD H,A
0558+++8FAA~            	CALL SETENBS
0559+++8FAA~            	JR PD2_LOOP
0560+++8FAA~            0561+++8FAA~            PD2_ORN	CALL SETORN
0562+++8FAA~            	JR PD2_LOOP
0563+++8FAA~            0564+++8FAA~            PD2_SKIP INC A
0565+++8FAA~            	LD (IX-12+CHP.NNtSkp),A
0566+++8FAA~            	JR PD2_LOOP
0567+++8FAA~            0568+++8FAA~            PD2_VOL	RRCA
0569+++8FAA~            	RRCA
0570+++8FAA~            	RRCA
0571+++8FAA~            	RRCA
0572+++8FAA~            	LD (IX-12+CHP.Volume),A
0573+++8FAA~            	JR PD2_LOOP
0574+++8FAA~            0575+++8FAA~            PD2_DEL	CALL C_DELAY
0576+++8FAA~            	JR PD2_LOOP
0577+++8FAA~            0578+++8FAA~            PD2_GLIS SET 2,(IX-12+CHP.Flags)
0579+++8FAA~            	INC A
0580+++8FAA~            	LD (IX-12+CHP.TnSlDl),A
0581+++8FAA~            	LD (IX-12+CHP.TSlCnt),A
0582+++8FAA~            	LD A,(BC)
0583+++8FAA~            	INC BC
0584+++8FAA~                    LD (IX-12+CHP.TSlStp),A
0585+++8FAA~            	ADD A,A
0586+++8FAA~            	SBC A,A
0587+++8FAA~                    LD (IX-12+CHP.TSlStp+1),A
0588+++8FAA~            	SCF
0589+++8FAA~            	JR PD2_LP2
0590+++8FAA~            0591+++8FAA~            PT2PD	AND A
0592+++8FAA~            0593+++8FAA~            PD2_LP2	EX AF,AF'
0594+++8FAA~            0595+++8FAA~            PD2_LOOP LD A,(BC)
0596+++8FAA~            	INC BC
0597+++8FAA~            	ADD A,#20
0598+++8FAA~            	JR Z,PD2_REL
0599+++8FAA~            	JR C,PD2_SAM
0600+++8FAA~            	ADD A,96
0601+++8FAA~            	JR C,PD2_NOTE
0602+++8FAA~            	INC A
0603+++8FAA~            	JR Z,PD2_EOff
0604+++8FAA~            	ADD A,15
0605+++8FAA~            	JP Z,PD_FIN
0606+++8FAA~            	JR C,PD2_ENV
0607+++8FAA~            	ADD A,#10
0608+++8FAA~            	JR C,PD2_ORN
0609+++8FAA~            	ADD A,#40
0610+++8FAA~            	JR C,PD2_SKIP
0611+++8FAA~            	ADD A,#10
0612+++8FAA~            	JR C,PD2_VOL
0613+++8FAA~            	INC A
0614+++8FAA~            	JR Z,PD2_DEL
0615+++8FAA~            	INC A
0616+++8FAA~            	JR Z,PD2_GLIS
0617+++8FAA~            	INC A
0618+++8FAA~            	JR Z,PD2_PORT
0619+++8FAA~            	INC A
0620+++8FAA~            	JR Z,PD2_STOP
0621+++8FAA~            	LD A,(BC)
0622+++8FAA~            	INC BC
0623+++8FAA~            	LD (IX-12+CHP.CrNsSl),A
0624+++8FAA~            	JR PD2_LOOP
0625+++8FAA~            0626+++8FAA~            PD2_PORT RES 2,(IX-12+CHP.Flags)
0627+++8FAA~            	LD A,(BC)
0628+++8FAA~            	INC BC
0629+++8FAA~            	INC BC ;ignoring precalc delta to right sound
0630+++8FAA~            	INC BC
0631+++8FAA~            	SCF
0632+++8FAA~            	JR PD2_LP2
0633+++8FAA~            0634+++8FAA~            PD2_STOP LD (IX-12+CHP.TSlCnt),A
0635+++8FAA~            	JR PD2_LOOP
0636+++8FAA~            0637+++8FAA~            PD2_REL	LD (IX-12+CHP.Flags),A
0638+++8FAA~            	JR PD2_EXIT
0639+++8FAA~            0640+++8FAA~            PD2_NOTE LD L,A
0641+++8FAA~            	LD A,(IX-12+CHP.Note)
0642+++8FAA~            	LD (PrNote+1),A
0643+++8FAA~            	LD (IX-12+CHP.Note),L
0644+++8FAA~            	XOR A
0645+++8FAA~            	LD (IX-12+CHP.TSlCnt),A
0646+++8FAA~            	SET 0,(IX-12+CHP.Flags)
0647+++8FAA~            	EX AF,AF'
0648+++8FAA~            	JR NC,NOGLIS2
0649+++8FAA~            	BIT 2,(IX-12+CHP.Flags)
0650+++8FAA~            	JR NZ,NOPORT2
0651+++8FAA~            	LD (LoStep),A
0652+++8FAA~            	ADD A,A
0653+++8FAA~            	SBC A,A
0654+++8FAA~            	EX AF,AF'
0655+++8FAA~            	LD H,A
0656+++8FAA~            	LD L,A
0657+++8FAA~            	INC A
0658+++8FAA~            	CALL SETPORT
0659+++8FAA~            NOPORT2	LD (IX-12+CHP.TSlCnt),1
0660+++8FAA~            NOGLIS2	XOR A
0661+++8FAA~            0662+++8FAA~            0663+++8FAA~            PD2_EXIT LD (IX-12+CHP.PsInSm),A
0664+++8FAA~            	LD (IX-12+CHP.PsInOr),A
0665+++8FAA~            	LD (IX-12+CHP.CrTnSl),A
0666+++8FAA~            	LD (IX-12+CHP.CrTnSl+1),A
0667+++8FAA~            	JP PD_FIN
0668+++8FAA~            0669+++8FAA~            ;PT3 pattern decoder
0670+++8FAA~            PD_OrSm	LD (IX-12+CHP.Env_En),0
0671+++8FAA~            	CALL SETORN
0672+++8FAA~            PD_SAM_	LD A,(BC)
0673+++8FAA~            	INC BC
0674+++8FAA~            	RRCA
0675+++8FAA~            0676+++8FAA~            PD_SAM	CALL SETSAM
0677+++8FAA~            	JR PD_LOOP
0678+++8FAA~            0679+++8FAA~            PD_VOL	RRCA
0680+++8FAA~            	RRCA
0681+++8FAA~            	RRCA
0682+++8FAA~            	RRCA
0683+++8FAA~            	LD (IX-12+CHP.Volume),A
0684+++8FAA~            	JR PD_LP2
0685+++8FAA~            	
0686+++8FAA~            PD_EOff	LD (IX-12+CHP.Env_En),A
0687+++8FAA~            	LD (IX-12+CHP.PsInOr),A
0688+++8FAA~            	JR PD_LP2
0689+++8FAA~            0690+++8FAA~            PD_SorE	DEC A
0691+++8FAA~            	JR NZ,PD_ENV
0692+++8FAA~            	LD A,(BC)
0693+++8FAA~            	INC BC
0694+++8FAA~            	LD (IX-12+CHP.NNtSkp),A
0695+++8FAA~            	JR PD_LP2
0696+++8FAA~            0697+++8FAA~            PD_ENV	CALL SETENV
0698+++8FAA~            	JR PD_LP2
0699+++8FAA~            0700+++8FAA~            PD_ORN	CALL SETORN
0701+++8FAA~            	JR PD_LOOP
0702+++8FAA~            0703+++8FAA~            PD_ESAM	LD (IX-12+CHP.Env_En),A
0704+++8FAA~            	LD (IX-12+CHP.PsInOr),A
0705+++8FAA~            	CALL NZ,SETENV
0706+++8FAA~            	JR PD_SAM_
0707+++8FAA~            0708+++8FAA~            PT3PD	LD A,(IX-12+CHP.Note)
0709+++8FAA~            	LD (PrNote+1),A
0710+++8FAA~            	LD L,(IX-12+CHP.CrTnSl)
0711+++8FAA~            	LD H,(IX-12+CHP.CrTnSl+1)
0712+++8FAA~            	LD (PrSlide+1),HL
0713+++8FAA~            0714+++8FAA~            PD_LOOP	LD DE,#2010
0715+++8FAA~            PD_LP2	LD A,(BC)
0716+++8FAA~            	INC BC
0717+++8FAA~            	ADD A,E
0718+++8FAA~            	JR C,PD_OrSm
0719+++8FAA~            	ADD A,D
0720+++8FAA~            	JR Z,PD_FIN
0721+++8FAA~            	JR C,PD_SAM
0722+++8FAA~            	ADD A,E
0723+++8FAA~            	JR Z,PD_REL
0724+++8FAA~            	JR C,PD_VOL
0725+++8FAA~            	ADD A,E
0726+++8FAA~            	JR Z,PD_EOff
0727+++8FAA~            	JR C,PD_SorE
0728+++8FAA~            	ADD A,96
0729+++8FAA~            	JR C,PD_NOTE
0730+++8FAA~            	ADD A,E
0731+++8FAA~            	JR C,PD_ORN
0732+++8FAA~            	ADD A,D
0733+++8FAA~            	JR C,PD_NOIS
0734+++8FAA~            	ADD A,E
0735+++8FAA~            	JR C,PD_ESAM
0736+++8FAA~            	ADD A,A
0737+++8FAA~            	LD E,A
0738+++8FAA~            	LD HL,(SPCCOMS+#FF20-#2000)&65535
0739+++8FAA~            	ADD HL,DE
0740+++8FAA~            	LD E,(HL)
0741+++8FAA~            	INC HL
0742+++8FAA~            	LD D,(HL)
0743+++8FAA~            	PUSH DE
0744+++8FAA~            	JR PD_LOOP
0745+++8FAA~            0746+++8FAA~            PD_NOIS	LD (IY-100+VRS.Ns_Base),A
0747+++8FAA~            	JR PD_LP2
0748+++8FAA~            0749+++8FAA~            PD_REL	RES 0,(IX-12+CHP.Flags)
0750+++8FAA~            	JR PD_RES
0751+++8FAA~            0752+++8FAA~            PD_NOTE	LD (IX-12+CHP.Note),A
0753+++8FAA~            	SET 0,(IX-12+CHP.Flags)
0754+++8FAA~            	XOR A
0755+++8FAA~            0756+++8FAA~            PD_RES	LD (PDSP_+1),SP
0757+++8FAA~            	LD SP,IX
0758+++8FAA~            	LD H,A
0759+++8FAA~            	LD L,A
0760+++8FAA~            	PUSH HL
0761+++8FAA~            	PUSH HL
0762+++8FAA~            	PUSH HL
0763+++8FAA~            	PUSH HL
0764+++8FAA~            	PUSH HL
0765+++8FAA~            	PUSH HL
0766+++8FAA~            PDSP_	LD SP,#3131
0767+++8FAA~            0768+++8FAA~            PD_FIN	LD A,(IX-12+CHP.NNtSkp)
0769+++8FAA~            	LD (IX-12+CHP.NtSkCn),A
0770+++8FAA~            	RET
0771+++8FAA~            0772+++8FAA~            C_PORTM LD A,(BC)
0773+++8FAA~            	INC BC
0774+++8FAA~            ;SKIP PRECALCULATED TONE DELTA (BECAUSE
0775+++8FAA~            ;CANNOT BE RIGHT AFTER PT3 COMPILATION)
0776+++8FAA~            	INC BC
0777+++8FAA~            	INC BC
0778+++8FAA~            	EX AF,AF'
0779+++8FAA~            	LD A,(BC) ;SIGNED TONE STEP
0780+++8FAA~            	INC BC
0781+++8FAA~            	LD (LoStep),A
0782+++8FAA~            	LD A,(BC)
0783+++8FAA~            	INC BC
0784+++8FAA~            	AND A
0785+++8FAA~            	EX AF,AF'
0786+++8FAA~            	LD L,(IX-12+CHP.CrTnSl)
0787+++8FAA~            	LD H,(IX-12+CHP.CrTnSl+1)
0788+++8FAA~            0789+++8FAA~            ;Set portamento variables
0790+++8FAA~            ;A - Delay; A' - Hi(Step); ZF' - (A'=0); HL - CrTnSl
0791+++8FAA~            0792+++8FAA~            SETPORT	RES 2,(IX-12+CHP.Flags)
0793+++8FAA~            	LD (IX-12+CHP.TnSlDl),A
0794+++8FAA~            	LD (IX-12+CHP.TSlCnt),A
0795+++8FAA~            	PUSH HL
0796+++8FAA~            	LD DE,NT_
0797+++8FAA~            	LD A,(IX-12+CHP.Note)
0798+++8FAA~            	LD (IX-12+CHP.SlToNt),A
0799+++8FAA~            	ADD A,A
0800+++8FAA~            	LD L,A
0801+++8FAA~            	LD H,0
0802+++8FAA~            	ADD HL,DE
0803+++8FAA~            	LD A,(HL)
0804+++8FAA~            	INC HL
0805+++8FAA~            	LD H,(HL)
0806+++8FAA~            	LD L,A
0807+++8FAA~            	PUSH HL
0808+++8FAA~            PrNote	LD A,#3E
0809+++8FAA~            	LD (IX-12+CHP.Note),A
0810+++8FAA~            	ADD A,A
0811+++8FAA~            	LD L,A
0812+++8FAA~            	LD H,0
0813+++8FAA~            	ADD HL,DE
0814+++8FAA~            	LD E,(HL)
0815+++8FAA~            	INC HL
0816+++8FAA~            	LD D,(HL)
0817+++8FAA~            	POP HL
0818+++8FAA~            	SBC HL,DE
0819+++8FAA~            	LD (IX-12+CHP.TnDelt),L
0820+++8FAA~            	LD (IX-12+CHP.TnDelt+1),H
0821+++8FAA~            	POP DE
0822+++8FAA~            Version EQU $+1
0823+++8FAA~            	LD A,#3E
0824+++8FAA~            	CP 6
0825+++8FAA~            	JR C,OLDPRTM ;Old 3xxx for PT v3.5-
0826+++8FAA~            PrSlide	LD DE,#1111
0827+++8FAA~            	LD (IX-12+CHP.CrTnSl),E
0828+++8FAA~            	LD (IX-12+CHP.CrTnSl+1),D
0829+++8FAA~            LoStep	EQU $+1
0830+++8FAA~            OLDPRTM	LD A,#3E
0831+++8FAA~            	EX AF,AF'
0832+++8FAA~            	JR Z,NOSIG
0833+++8FAA~            	EX DE,HL
0834+++8FAA~            NOSIG	SBC HL,DE
0835+++8FAA~            	JP P,SET_STP
0836+++8FAA~            	CPL
0837+++8FAA~            	EX AF,AF'
0838+++8FAA~            	NEG
0839+++8FAA~            	EX AF,AF'
0840+++8FAA~            SET_STP	LD (IX-12+CHP.TSlStp+1),A
0841+++8FAA~            	EX AF,AF'
0842+++8FAA~            	LD (IX-12+CHP.TSlStp),A
0843+++8FAA~            	LD (IX-12+CHP.COnOff),0
0844+++8FAA~            	RET
0845+++8FAA~            0846+++8FAA~            C_GLISS	SET 2,(IX-12+CHP.Flags)
0847+++8FAA~            	LD A,(BC)
0848+++8FAA~            	INC BC
0849+++8FAA~            	LD (IX-12+CHP.TnSlDl),A
0850+++8FAA~            	AND A
0851+++8FAA~            	JR NZ,GL36
0852+++8FAA~            	LD A,(Version) ;AlCo PT3.7+
0853+++8FAA~            	CP 7
0854+++8FAA~            	SBC A,A
0855+++8FAA~            	INC A
0856+++8FAA~            GL36	LD (IX-12+CHP.TSlCnt),A
0857+++8FAA~            	LD A,(BC)
0858+++8FAA~            	INC BC
0859+++8FAA~            	EX AF,AF'
0860+++8FAA~            	LD A,(BC)
0861+++8FAA~            	INC BC
0862+++8FAA~            	JR SET_STP
0863+++8FAA~            0864+++8FAA~            C_SMPOS	LD A,(BC)
0865+++8FAA~            	INC BC
0866+++8FAA~            	LD (IX-12+CHP.PsInSm),A
0867+++8FAA~            	RET
0868+++8FAA~            0869+++8FAA~            C_ORPOS	LD A,(BC)
0870+++8FAA~            	INC BC
0871+++8FAA~            	LD (IX-12+CHP.PsInOr),A
0872+++8FAA~            	RET
0873+++8FAA~            0874+++8FAA~            C_VIBRT	LD A,(BC)
0875+++8FAA~            	INC BC
0876+++8FAA~            	LD (IX-12+CHP.OnOffD),A
0877+++8FAA~            	LD (IX-12+CHP.COnOff),A
0878+++8FAA~            	LD A,(BC)
0879+++8FAA~            	INC BC
0880+++8FAA~            	LD (IX-12+CHP.OffOnD),A
0881+++8FAA~            	XOR A
0882+++8FAA~            	LD (IX-12+CHP.TSlCnt),A
0883+++8FAA~            	LD (IX-12+CHP.CrTnSl),A
0884+++8FAA~            	LD (IX-12+CHP.CrTnSl+1),A
0885+++8FAA~            	RET
0886+++8FAA~            0887+++8FAA~            C_ENGLS	LD A,(BC)
0888+++8FAA~            	INC BC
0889+++8FAA~            	LD (IY-100+VRS.Env_Del),A
0890+++8FAA~            	LD (IY-100+VRS.CurEDel),A
0891+++8FAA~            	LD A,(BC)
0892+++8FAA~            	INC BC
0893+++8FAA~            	LD L,A
0894+++8FAA~            	LD A,(BC)
0895+++8FAA~            	INC BC
0896+++8FAA~            	LD H,A
0897+++8FAA~            	LD (IY-100+VRS.ESldAdd),L
0898+++8FAA~            	LD (IY-100+VRS.ESldAdd+1),H
0899+++8FAA~            	RET
0900+++8FAA~            0901+++8FAA~            C_DELAY	LD A,(BC)
0902+++8FAA~            	INC BC
0903+++8FAA~            	LD (IY-100+VRS.Delay),A
0904+++8FAA~            	LD HL,VARS2+VRS.ModNum ;if AlCo_TS
0905+++8FAA~            	BIT 1,(HL)
0906+++8FAA~            	RET Z
0907+++8FAA~            	LD (VARS1+VRS.Delay),A
0908+++8FAA~            	LD (VARS1+VRS.DelyCnt),A
0909+++8FAA~            	LD (VARS2+VRS.Delay),A
0910+++8FAA~            	RET
0911+++8FAA~            	
0912+++8FAA~            SETENV	LD (IX-12+CHP.Env_En),E
0913+++8FAA~            	LD (IY-100+VRS.AYREGS+EnvTp),A
0914+++8FAA~            	LD A,(BC)
0915+++8FAA~            	INC BC
0916+++8FAA~            	LD H,A
0917+++8FAA~            	LD A,(BC)
0918+++8FAA~            	INC BC
0919+++8FAA~            	LD L,A
0920+++8FAA~            	CALL SETENBS
0921+++8FAA~            	XOR A
0922+++8FAA~            	LD (IX-12+CHP.PsInOr),A
0923+++8FAA~            	LD (IY-100+VRS.CurEDel),A
0924+++8FAA~            	LD H,A
0925+++8FAA~            	LD L,A
0926+++8FAA~            	JP SETESLD
0927+++8FAA~            0928+++8FAA~            SETORN	ADD A,A
0929+++8FAA~            	LD E,A
0930+++8FAA~            	LD D,0
0931+++8FAA~            	LD (IX-12+CHP.PsInOr),D
0932+++8FAA~            	LD L,(IY-100+VRS.OrnPtrs)
0933+++8FAA~            	LD H,(IY-100+VRS.OrnPtrs+1)
0934+++8FAA~            	ADD HL,DE
0935+++8FAA~            	LD E,(HL)
0936+++8FAA~            	INC HL
0937+++8FAA~            	LD D,(HL)
0938+++8FAA~            	LD L,(IY-100+VRS.MODADDR)
0939+++8FAA~            	LD H,(IY-100+VRS.MODADDR+1)
0940+++8FAA~            	ADD HL,DE
0941+++8FAA~            	LD (IX-12+CHP.OrnPtr),L
0942+++8FAA~            	LD (IX-12+CHP.OrnPtr+1),H
0943+++8FAA~            C_NOP	RET
0944+++8FAA~            0945+++8FAA~            SETSAM	ADD A,A
0946+++8FAA~            	LD E,A
0947+++8FAA~            	LD D,0
0948+++8FAA~            	LD L,(IY-100+VRS.SamPtrs);
0949+++8FAA~            	LD H,(IY-100+VRS.SamPtrs+1);
0950+++8FAA~            	ADD HL,DE
0951+++8FAA~            	LD E,(HL)
0952+++8FAA~            	INC HL
0953+++8FAA~            	LD D,(HL)
0954+++8FAA~            	LD L,(IY-100+VRS.MODADDR)
0955+++8FAA~            	LD H,(IY-100+VRS.MODADDR+1)
0956+++8FAA~            	ADD HL,DE
0957+++8FAA~            	LD (IX-12+CHP.SamPtr),L
0958+++8FAA~            	LD (IX-12+CHP.SamPtr+1),H
0959+++8FAA~            	RET
0960+++8FAA~            0961+++8FAA~            ;ALL 16 ADDRESSES TO PROTECT FROM BROKEN PT3 MODULES
0962+++8FAA~            SPCCOMS DW C_NOP
0963+++8FAA~            	DW C_GLISS
0964+++8FAA~            	DW C_PORTM
0965+++8FAA~            	DW C_SMPOS
0966+++8FAA~            	DW C_ORPOS
0967+++8FAA~            	DW C_VIBRT
0968+++8FAA~            	DW C_NOP
0969+++8FAA~            	DW C_NOP
0970+++8FAA~            	DW C_ENGLS
0971+++8FAA~            	DW C_DELAY
0972+++8FAA~            	DW C_NOP
0973+++8FAA~            	DW C_NOP
0974+++8FAA~            	DW C_NOP
0975+++8FAA~            	DW C_NOP
0976+++8FAA~            	DW C_NOP
0977+++8FAA~            	DW C_NOP
0978+++8FAA~            0979+++8FAA~            CHREGS	CALL GETIX
0980+++8FAA~            	XOR A
0981+++8FAA~            	LD (Ampl),A
0982+++8FAA~            	BIT 0,(IX+CHP.Flags)
0983+++8FAA~            	PUSH HL
0984+++8FAA~            	JP Z,CH_EXIT
0985+++8FAA~            	LD (CSP_+1),SP
0986+++8FAA~            	LD L,(IX+CHP.OrnPtr)
0987+++8FAA~            	LD H,(IX+CHP.OrnPtr+1)
0988+++8FAA~            	LD SP,HL
0989+++8FAA~            	POP DE
0990+++8FAA~            	LD H,A
0991+++8FAA~            	LD A,(IX+CHP.PsInOr)
0992+++8FAA~            	LD L,A
0993+++8FAA~            	ADD HL,SP
0994+++8FAA~            	INC A
0995+++8FAA~            		;PT2	PT3
0996+++8FAA~            OrnCP	INC A	;CP E	CP D
0997+++8FAA~            	JR C,CH_ORPS
0998+++8FAA~            OrnLD	DB 1	;LD A,D	LD A,E
0999+++8FAA~            CH_ORPS	LD (IX+CHP.PsInOr),A
1000+++8FAA~            	LD A,(IX+CHP.Note)
1001+++8FAA~            	ADD A,(HL)
1002+++8FAA~            	JP P,CH_NTP
1003+++8FAA~            	XOR A
1004+++8FAA~            CH_NTP	CP 96
1005+++8FAA~            	JR C,CH_NOK
1006+++8FAA~            	LD A,95
1007+++8FAA~            CH_NOK	ADD A,A
1008+++8FAA~            	EX AF,AF'
1009+++8FAA~            	LD L,(IX+CHP.SamPtr)
1010+++8FAA~            	LD H,(IX+CHP.SamPtr+1)
1011+++8FAA~            	LD SP,HL
1012+++8FAA~            	POP DE
1013+++8FAA~            	LD H,0
1014+++8FAA~            	LD A,(IX+CHP.PsInSm)
1015+++8FAA~            	LD B,A
1016+++8FAA~            	ADD A,A
1017+++8FAA~            SamClc2	ADD A,A ;or ADD A,B for PT2
1018+++8FAA~            	LD L,A
1019+++8FAA~            	ADD HL,SP
1020+++8FAA~            	LD SP,HL
1021+++8FAA~            	LD A,B
1022+++8FAA~            	INC A
1023+++8FAA~            		;PT2	PT3
1024+++8FAA~            SamCP	INC A	;CP E	CP D
1025+++8FAA~            	JR C,CH_SMPS
1026+++8FAA~            SamLD	DB 1	;LD A,D	LD A,E
1027+++8FAA~            CH_SMPS	LD (IX+CHP.PsInSm),A
1028+++8FAA~            	POP BC
1029+++8FAA~            	POP HL
1030+++8FAA~            1031+++8FAA~            ;Convert PT2 sample to PT3
1032+++8FAA~            		;PT2		PT3
1033+++8FAA~            SamCnv	POP HL  ;BIT 2,C	JR e_
1034+++8FAA~            	POP HL	
1035+++8FAA~            	LD H,B
1036+++8FAA~            	JR NZ,$+8
1037+++8FAA~            	EX DE,HL
1038+++8FAA~            	AND A
1039+++8FAA~            	SBC HL,HL
1040+++8FAA~            	SBC HL,DE
1041+++8FAA~            	LD D,C
1042+++8FAA~            	RR C
1043+++8FAA~            	SBC A,A
1044+++8FAA~            	CPL
1045+++8FAA~            	AND #3E
1046+++8FAA~            	RR C
1047+++8FAA~            	RR B
1048+++8FAA~            	AND C
1049+++8FAA~            	LD C,A
1050+++8FAA~            	LD A,B
1051+++8FAA~            	RRA
1052+++8FAA~            	RRA
1053+++8FAA~            	RR D
1054+++8FAA~            	RRA
1055+++8FAA~            	AND #9F
1056+++8FAA~            	LD B,A
1057+++8FAA~            1058+++8FAA~            e_	LD E,(IX+CHP.TnAcc)
1059+++8FAA~            	LD D,(IX+CHP.TnAcc+1)
1060+++8FAA~            	ADD HL,DE
1061+++8FAA~            	BIT 6,B
1062+++8FAA~            	JR Z,CH_NOAC
1063+++8FAA~            	LD (IX+CHP.TnAcc),L
1064+++8FAA~            	LD (IX+CHP.TnAcc+1),H
1065+++8FAA~            CH_NOAC EX DE,HL
1066+++8FAA~            	EX AF,AF'
1067+++8FAA~            	ADD A,NT_&255
1068+++8FAA~            	LD L,A
1069+++8FAA~            	ADC A,NT_/256
1070+++8FAA~            	SUB L
1071+++8FAA~            	LD H,A
1072+++8FAA~            	LD SP,HL
1073+++8FAA~            	POP HL
1074+++8FAA~            	ADD HL,DE
1075+++8FAA~            	LD E,(IX+CHP.CrTnSl)
1076+++8FAA~            	LD D,(IX+CHP.CrTnSl+1)
1077+++8FAA~            	ADD HL,DE
1078+++8FAA~            CSP_	LD SP,#3131
1079+++8FAA~            	EX (SP),HL
1080+++8FAA~            	XOR A
1081+++8FAA~            	OR (IX+CHP.TSlCnt)
1082+++8FAA~            	JR Z,CH_AMP
1083+++8FAA~            	DEC (IX+CHP.TSlCnt)
1084+++8FAA~            	JR NZ,CH_AMP
1085+++8FAA~            	LD A,(IX+CHP.TnSlDl)
1086+++8FAA~            	LD (IX+CHP.TSlCnt),A
1087+++8FAA~            	LD L,(IX+CHP.TSlStp)
1088+++8FAA~            	LD H,(IX+CHP.TSlStp+1)
1089+++8FAA~            	LD A,H
1090+++8FAA~            	ADD HL,DE
1091+++8FAA~            	LD (IX+CHP.CrTnSl),L
1092+++8FAA~            	LD (IX+CHP.CrTnSl+1),H
1093+++8FAA~            	BIT 2,(IX+CHP.Flags)
1094+++8FAA~            	JR NZ,CH_AMP
1095+++8FAA~            	LD E,(IX+CHP.TnDelt)
1096+++8FAA~            	LD D,(IX+CHP.TnDelt+1)
1097+++8FAA~            	AND A
1098+++8FAA~            	JR Z,CH_STPP
1099+++8FAA~            	EX DE,HL
1100+++8FAA~            CH_STPP SBC HL,DE
1101+++8FAA~            	JP M,CH_AMP
1102+++8FAA~            	LD A,(IX+CHP.SlToNt)
1103+++8FAA~            	LD (IX+CHP.Note),A
1104+++8FAA~            	XOR A
1105+++8FAA~            	LD (IX+CHP.TSlCnt),A
1106+++8FAA~            	LD (IX+CHP.CrTnSl),A
1107+++8FAA~            	LD (IX+CHP.CrTnSl+1),A
1108+++8FAA~            CH_AMP	LD A,(IX+CHP.CrAmSl)
1109+++8FAA~            	BIT 7,C
1110+++8FAA~            	JR Z,CH_NOAM
1111+++8FAA~            	BIT 6,C
1112+++8FAA~            	JR Z,CH_AMIN
1113+++8FAA~            	CP 15
1114+++8FAA~            	JR Z,CH_NOAM
1115+++8FAA~            	INC A
1116+++8FAA~            	JR CH_SVAM
1117+++8FAA~            CH_AMIN	CP -15
1118+++8FAA~            	JR Z,CH_NOAM
1119+++8FAA~            	DEC A
1120+++8FAA~            CH_SVAM	LD (IX+CHP.CrAmSl),A
1121+++8FAA~            CH_NOAM	LD L,A
1122+++8FAA~            	LD A,B
1123+++8FAA~            	AND 15
1124+++8FAA~            	ADD A,L
1125+++8FAA~            	JP P,CH_APOS
1126+++8FAA~            	XOR A
1127+++8FAA~            CH_APOS	CP 16
1128+++8FAA~            	JR C,CH_VOL
1129+++8FAA~            	LD A,15
1130+++8FAA~            CH_VOL	OR (IX+CHP.Volume)
1131+++8FAA~            	ADD A,VT_&255
1132+++8FAA~            	LD L,A
1133+++8FAA~            	ADC A,VT_/256
1134+++8FAA~            	SUB L
1135+++8FAA~            	LD H,A
1136+++8FAA~            	LD A,(HL)
1137+++8FAA~            CH_ENV	BIT 0,C
1138+++8FAA~            	JR NZ,CH_NOEN
1139+++8FAA~            	OR (IX+CHP.Env_En)
1140+++8FAA~            CH_NOEN	LD (Ampl),A
1141+++8FAA~            	BIT 7,B
1142+++8FAA~            	LD A,C
1143+++8FAA~            	JR Z,NO_ENSL
1144+++8FAA~            	RLA
1145+++8FAA~            	RLA
1146+++8FAA~            	SRA A
1147+++8FAA~            	SRA A
1148+++8FAA~            	SRA A
1149+++8FAA~            	ADD A,(IX+CHP.CrEnSl) ;SEE COMMENT BELOW
1150+++8FAA~            	BIT 5,B
1151+++8FAA~            	JR Z,NO_ENAC
1152+++8FAA~            	LD (IX+CHP.CrEnSl),A
1153+++8FAA~            NO_ENAC	ADD A,(IY-100+VRS.AddToEn) ;BUG IN PT3 - NEED WORD HERE
1154+++8FAA~            	LD (IY-100+VRS.AddToEn),A
1155+++8FAA~            	JR CH_MIX
1156+++8FAA~            NO_ENSL RRA
1157+++8FAA~            	ADD A,(IX+CHP.CrNsSl)
1158+++8FAA~            	LD (IY-100+VRS.AddToNs),A
1159+++8FAA~            	BIT 5,B
1160+++8FAA~            	JR Z,CH_MIX
1161+++8FAA~            	LD (IX+CHP.CrNsSl),A
1162+++8FAA~            CH_MIX	LD A,B
1163+++8FAA~            	RRA
1164+++8FAA~            	AND #48
1165+++8FAA~            CH_EXIT	OR (IY-100+VRS.AYREGS+Mixer)
1166+++8FAA~            	RRCA
1167+++8FAA~            	LD (IY-100+VRS.AYREGS+Mixer),A
1168+++8FAA~            	POP HL
1169+++8FAA~            	XOR A
1170+++8FAA~            	OR (IX+CHP.COnOff)
1171+++8FAA~            	RET Z
1172+++8FAA~            	DEC (IX+CHP.COnOff)
1173+++8FAA~            	RET NZ
1174+++8FAA~            	XOR (IX+CHP.Flags)
1175+++8FAA~            	LD (IX+CHP.Flags),A
1176+++8FAA~            	RRA
1177+++8FAA~            	LD A,(IX+CHP.OnOffD)
1178+++8FAA~            	JR C,CH_ONDL
1179+++8FAA~            	LD A,(IX+CHP.OffOnD)
1180+++8FAA~            CH_ONDL	LD (IX+CHP.COnOff),A
1181+++8FAA~            	RET
1182+++8FAA~            1183+++8FAA~            PLAY_	XOR A
1184+++8FAA~            	LD (IY-100+VRS.AddToEn),A
1185+++8FAA~            	LD (IY-100+VRS.AYREGS+Mixer),A
1186+++8FAA~            	DEC A
1187+++8FAA~            	LD (IY-100+VRS.AYREGS+EnvTp),A
1188+++8FAA~            	DEC (IY-100+VRS.DelyCnt)
1189+++8FAA~            	JP NZ,PL2
1190+++8FAA~            	DEC (IY-100+VRS.ChanA+CHP.NtSkCn)
1191+++8FAA~            	JR NZ,PL1B
1192+++8FAA~            	LD C,(IY-100+VRS.AdInPtA)
1193+++8FAA~            	LD B,(IY-100+VRS.AdInPtA+1)
1194+++8FAA~            	LD A,(BC)
1195+++8FAA~            	AND A
1196+++8FAA~            	JR NZ,PL1A
1197+++8FAA~            	LD D,A
1198+++8FAA~            	LD (IY-100+VRS.Ns_Base),A
1199+++8FAA~            	LD L,(IY-100+VRS.CrPsPtr)
1200+++8FAA~            	LD H,(IY-100+VRS.CrPsPtr+1)
1201+++8FAA~            	INC HL
1202+++8FAA~            	LD A,(HL)
1203+++8FAA~            	INC A
1204+++8FAA~            	JR NZ,PLNLP
1205+++8FAA~            1206+++8FAA~            	IF LoopChecker
1207+++8FAA~            	CALL CHECKLP
1208+++8FAA~            	ENDIF
1209+++8FAA~            1210+++8FAA~            	LD L,(IY-100+VRS.LPosPtr)
1211+++8FAA~            	LD H,(IY-100+VRS.LPosPtr+1)
1212+++8FAA~            	LD A,(HL)
1213+++8FAA~            	INC A
1214+++8FAA~            PLNLP	CALL SETCPPT
1215+++8FAA~            	DEC A
1216+++8FAA~            	BIT 1,(IY-100+VRS.ModNum)
1217+++8FAA~            	JR Z,NoAlCo
1218+++8FAA~            TSSub	EQU $+1
1219+++8FAA~            	SUB #D6
1220+++8FAA~            	CPL
1221+++8FAA~            NoAlCo
1222+++8FAA~            		;PT2		PT3
1223+++8FAA~            PsCalc	DEC A	;ADD A,A	NOP
1224+++8FAA~            	DEC A	;ADD A,(HL)	NOP
1225+++8FAA~            	ADD A,A
1226+++8FAA~            	LD E,A
1227+++8FAA~            	RL D
1228+++8FAA~            1229+++8FAA~            	IF CurPosCounter
1230+++8FAA~            	LD A,L
1231+++8FAA~            	SUB (IY-100+VRS.PosSub)
1232+++8FAA~            	LD (IY-100+VRS.CurPos),A
1233+++8FAA~            	ENDIF
1234+++8FAA~            1235+++8FAA~            	LD L,(IY-100+VRS.PatsPtr)
1236+++8FAA~            	LD H,(IY-100+VRS.PatsPtr+1)
1237+++8FAA~            	ADD HL,DE
1238+++8FAA~            	LD E,(IY-100+VRS.MODADDR)
1239+++8FAA~            	LD D,(IY-100+VRS.MODADDR+1)
1240+++8FAA~            	LD (PSP_+1),SP
1241+++8FAA~            	LD SP,HL
1242+++8FAA~            	POP HL
1243+++8FAA~            	ADD HL,DE
1244+++8FAA~            	LD B,H
1245+++8FAA~            	LD C,L
1246+++8FAA~            	POP HL
1247+++8FAA~            	ADD HL,DE
1248+++8FAA~            	LD (IY-100+VRS.AdInPtB),L
1249+++8FAA~            	LD (IY-100+VRS.AdInPtB+1),H
1250+++8FAA~            	POP HL
1251+++8FAA~            	ADD HL,DE
1252+++8FAA~            	LD (IY-100+VRS.AdInPtC),L
1253+++8FAA~            	LD (IY-100+VRS.AdInPtC+1),H
1254+++8FAA~            PSP_	LD SP,#3131
1255+++8FAA~            PL1A	LD DE,VRS.ChanA+12-100
1256+++8FAA~            	CALL PTDECOD
1257+++8FAA~            	LD (IY-100+VRS.AdInPtA),C
1258+++8FAA~            	LD (IY-100+VRS.AdInPtA+1),B
1259+++8FAA~            1260+++8FAA~            PL1B	DEC (IY-100+VRS.ChanB+CHP.NtSkCn)
1261+++8FAA~            	JR NZ,PL1C
1262+++8FAA~            	LD DE,VRS.ChanB+12-100
1263+++8FAA~            	LD C,(IY-100+VRS.AdInPtB)
1264+++8FAA~            	LD B,(IY-100+VRS.AdInPtB+1)
1265+++8FAA~            	CALL PTDECOD
1266+++8FAA~            	LD (IY-100+VRS.AdInPtB),C
1267+++8FAA~            	LD (IY-100+VRS.AdInPtB+1),B
1268+++8FAA~            1269+++8FAA~            PL1C	DEC (IY-100+VRS.ChanC+CHP.NtSkCn)
1270+++8FAA~            	JR NZ,PL1D
1271+++8FAA~            	LD DE,VRS.ChanC+12-100
1272+++8FAA~            	LD C,(IY-100+VRS.AdInPtC)
1273+++8FAA~            	LD B,(IY-100+VRS.AdInPtC+1)
1274+++8FAA~            	CALL PTDECOD
1275+++8FAA~            	LD (IY-100+VRS.AdInPtC),C
1276+++8FAA~            	LD (IY-100+VRS.AdInPtC+1),B
1277+++8FAA~            1278+++8FAA~            PL1D	LD A,(IY-100+VRS.Delay)
1279+++8FAA~            	LD (IY-100+VRS.DelyCnt),A
1280+++8FAA~            1281+++8FAA~            PL2	LD DE,VRS.ChanA-100
1282+++8FAA~            	LD L,(IY-100+VRS.AYREGS+TonA)
1283+++8FAA~            	LD H,(IY-100+VRS.AYREGS+TonA+1)
1284+++8FAA~            	CALL CHREGS
1285+++8FAA~            	LD (IY-100+VRS.AYREGS+TonA),L
1286+++8FAA~            	LD (IY-100+VRS.AYREGS+TonA+1),H
1287+++8FAA~            Ampl	EQU $+1
1288+++8FAA~            	LD A,#3E
1289+++8FAA~            	LD (IY-100+VRS.AYREGS+AmplA),A
1290+++8FAA~            	LD DE,VRS.ChanB-100
1291+++8FAA~            	LD L,(IY-100+VRS.AYREGS+TonB)
1292+++8FAA~            	LD H,(IY-100+VRS.AYREGS+TonB+1)
1293+++8FAA~            	CALL CHREGS
1294+++8FAA~            	LD (IY-100+VRS.AYREGS+TonB),L
1295+++8FAA~            	LD (IY-100+VRS.AYREGS+TonB+1),H
1296+++8FAA~            	LD A,(Ampl)
1297+++8FAA~            	LD (IY-100+VRS.AYREGS+AmplB),A
1298+++8FAA~            	LD DE,VRS.ChanC-100
1299+++8FAA~            	LD L,(IY-100+VRS.AYREGS+TonC)
1300+++8FAA~            	LD H,(IY-100+VRS.AYREGS+TonC+1)
1301+++8FAA~            	CALL CHREGS
1302+++8FAA~            	LD (IY-100+VRS.AYREGS+TonC),L
1303+++8FAA~            	LD (IY-100+VRS.AYREGS+TonC+1),H
1304+++8FAA~            	LD A,(Ampl)
1305+++8FAA~            	LD (IY-100+VRS.AYREGS+AmplC),A
1306+++8FAA~            1307+++8FAA~            	LD A,(IY-100+VRS.Ns_Base)
1308+++8FAA~            	ADD (IY-100+VRS.AddToNs)
1309+++8FAA~            	LD (IY-100+VRS.AYREGS+Noise),A
1310+++8FAA~            1311+++8FAA~            	LD A,(IY-100+VRS.AddToEn)
1312+++8FAA~            	LD E,A
1313+++8FAA~            	ADD A,A
1314+++8FAA~            	SBC A,A
1315+++8FAA~            	LD D,A
1316+++8FAA~            	LD L,(IY-100+VRS.EnvBase)
1317+++8FAA~            	LD H,(IY-100+VRS.EnvBase+1)
1318+++8FAA~            	ADD HL,DE
1319+++8FAA~            	LD E,(IY-100+VRS.CurESld)
1320+++8FAA~            	LD D,(IY-100+VRS.CurESld+1)
1321+++8FAA~            	ADD HL,DE
1322+++8FAA~            	LD (IY-100+VRS.AYREGS+Env),L
1323+++8FAA~            	LD (IY-100+VRS.AYREGS+Env+1),H
1324+++8FAA~            1325+++8FAA~            	XOR A
1326+++8FAA~            	OR (IY-100+VRS.CurEDel)
1327+++8FAA~            	RET Z
1328+++8FAA~            	DEC (IY-100+VRS.CurEDel)
1329+++8FAA~            	RET NZ
1330+++8FAA~            	LD A,(IY-100+VRS.Env_Del)
1331+++8FAA~            	LD (IY-100+VRS.CurEDel),A
1332+++8FAA~            	LD L,(IY-100+VRS.ESldAdd)
1333+++8FAA~            	LD H,(IY-100+VRS.ESldAdd+1)
1334+++8FAA~            	ADD HL,DE
1335+++8FAA~            	JP SETESLD
1336+++8FAA~            1337+++8FAA~            PLAY    LD IY,VARS1+100
1338+++8FAA~            	CALL PLAY_
1339+++8FAA~            	LD A,(is_ts)
1340+++8FAA~            	AND A
1341+++8FAA~            	JR Z,PL_nts
1342+++8FAA~            	LD IY,VARS2+100
1343+++8FAA~            	CALL PLAY_
1344+++8FAA~            PL_nts
1345+++8FAA~            	IF Basic
1346+++8FAA~            	LD IY,#5C3A
1347+++8FAA~            	ENDIF
1348+++8FAA~            1349+++8FAA~            ROUT	LD BC,#FFFD
1350+++8FAA~              IFDEF ONtfm
1351+++8FAA~                LD L,#F9
1352+++8FAA~                OUT (C),L
1353+++8FAA~              ELSE
1354+++8FAA~            	LD A,(is_ts)
1355+++8FAA~            	AND A
1356+++8FAA~            	JR Z,r_nts ;keep old standard
1357+++8FAA~            	OUT (C),B
1358+++8FAA~                ENDIF
1359+++8FAA~            r_nts	EX AF,AF'
1360+++8FAA~            1361+++8FAA~            	IF ACBBAC
1362+++8FAA~            	LD IX,VARS1+VRS.AYREGS
1363+++8FAA~            	ELSE
1364+++8FAA~            	LD HL,VARS1+VRS.AYREGS
1365+++8FAA~            	ENDIF
1366+++8FAA~            1367+++8FAA~            	CALL ROUT_
1368+++8FAA~            	EX AF,AF'
1369+++8FAA~            	RET Z
1370+++8FAA~            	LD B,D
1371+++8FAA~            1372+++8FAA~                IFDEF ONtfm
1373+++8FAA~                LD A,#F8
1374+++8FAA~                ELSE
1375+++8FAA~            	CPL
1376+++8FAA~                ENDIF
1377+++8FAA~            	OUT (C),A
1378+++8FAA~            1379+++8FAA~            	IF ACBBAC
1380+++8FAA~            	LD IX,VARS2+VRS.AYREGS
1381+++8FAA~            	ELSE
1382+++8FAA~            	LD HL,VARS2+VRS.AYREGS
1383+++8FAA~            	ENDIF
1384+++8FAA~            1385+++8FAA~            ROUT_
1386+++8FAA~            	IF ACBBAC
1387+++8FAA~            	LD A,(SETUP)
1388+++8FAA~            	AND 12
1389+++8FAA~            	JR Z,ABC
1390+++8FAA~            	ADD A,CHTABLE
1391+++8FAA~            	LD E,A
1392+++8FAA~            	ADC A,CHTABLE/256
1393+++8FAA~            	SUB E
1394+++8FAA~            	LD D,A
1395+++8FAA~            	LD B,0
1396+++8FAA~            	PUSH IX
1397+++8FAA~            	POP HL
1398+++8FAA~            	LD A,(DE)
1399+++8FAA~            	INC DE
1400+++8FAA~            	LD C,A
1401+++8FAA~            	ADD HL,BC
1402+++8FAA~            	LD A,(IX+TonB)
1403+++8FAA~            	LD C,(HL)
1404+++8FAA~            	LD (IX+TonB),C
1405+++8FAA~            	LD (HL),A
1406+++8FAA~            	INC HL
1407+++8FAA~            	LD A,(IX+TonB+1)
1408+++8FAA~            	LD C,(HL)
1409+++8FAA~            	LD (IX+TonB+1),C
1410+++8FAA~            	LD (HL),A
1411+++8FAA~            	LD A,(DE)
1412+++8FAA~            	INC DE
1413+++8FAA~            	LD C,A
1414+++8FAA~            	ADD HL,BC
1415+++8FAA~            	LD A,(IX+AmplB)
1416+++8FAA~            	LD C,(HL)
1417+++8FAA~            	LD (IX+AmplB),C
1418+++8FAA~            	LD (HL),A
1419+++8FAA~            	LD A,(DE)
1420+++8FAA~            	INC DE
1421+++8FAA~            	LD (RxCA1),A
1422+++8FAA~            	XOR 8
1423+++8FAA~            	LD (RxCA2),A
1424+++8FAA~            	LD A,(DE)
1425+++8FAA~            	AND (IX+Mixer)
1426+++8FAA~            	LD E,A
1427+++8FAA~            	LD A,(IX+Mixer)
1428+++8FAA~            RxCA1	DB #E6
1429+++8FAA~            	AND %010010
1430+++8FAA~            	OR E
1431+++8FAA~            	LD E,A
1432+++8FAA~            	LD A,(IX+Mixer)
1433+++8FAA~            	AND %010010
1434+++8FAA~            RxCA2	OR E
1435+++8FAA~            	OR E
1436+++8FAA~            	LD (IX+Mixer),A
1437+++8FAA~            ABC
1438+++8FAA~            	ENDIF
1439+++8FAA~            1440+++8FAA~            	XOR A
1441+++8FAA~            	LD DE,#FFBF
1442+++8FAA~            1443+++8FAA~            	IF ACBBAC
1444+++8FAA~            	LD BC,#FFFD
1445+++8FAA~            	PUSH IX
1446+++8FAA~            	POP HL
1447+++8FAA~            	ENDIF
1448+++8FAA~            1449+++8FAA~            LOUT
1450+++8FAA~                IFDEF ONtfm
1451+++8FAA~                INF 
1452+++8FAA~                JP M,$-2
1453+++8FAA~                ENDIF 
1454+++8FAA~                OUT (C),A
1455+++8FAA~                IFDEF ONtfm
1456+++8FAA~                INF 
1457+++8FAA~                JP M,$-2
1458+++8FAA~                ENDIF 
1459+++8FAA~            	LD B,E
1460+++8FAA~            	OUTI 
1461+++8FAA~            	LD B,D
1462+++8FAA~            	INC A
1463+++8FAA~            	CP 13
1464+++8FAA~            	JR NZ,LOUT
1465+++8FAA~                IFDEF ONtfm
1466+++8FAA~                INF 
1467+++8FAA~                JP M,$-2
1468+++8FAA~                ENDIF 
1469+++8FAA~            	OUT (C),A
1470+++8FAA~            	LD A,(HL)
1471+++8FAA~            	AND A
1472+++8FAA~            	RET M
1473+++8FAA~                IFDEF ONtfm
1474+++8FAA~                INF 
1475+++8FAA~                JP M,$-2
1476+++8FAA~                ENDIF 
1477+++8FAA~            	LD B,E
1478+++8FAA~            	OUT (C),A
1479+++8FAA~            	RET
1480+++8FAA~            1481+++8FAA~            	IF ACBBAC
1482+++8FAA~            CHTABLE	EQU $-4
1483+++8FAA~            	DB 4,5,15,%001001,0,7,7,%100100
1484+++8FAA~            	ENDIF
1485+++8FAA~            1486+++8FAA~            NT_DATA	DB (T_NEW_0-T1_)*2
1487+++8FAA~            	DB TCNEW_0-T_
1488+++8FAA~            	DB (T_OLD_0-T1_)*2+1
1489+++8FAA~            	DB TCOLD_0-T_
1490+++8FAA~            	DB (T_NEW_1-T1_)*2+1
1491+++8FAA~            	DB TCNEW_1-T_
1492+++8FAA~            	DB (T_OLD_1-T1_)*2+1
1493+++8FAA~            	DB TCOLD_1-T_
1494+++8FAA~            	DB (T_NEW_2-T1_)*2
1495+++8FAA~            	DB TCNEW_2-T_
1496+++8FAA~            	DB (T_OLD_2-T1_)*2
1497+++8FAA~            	DB TCOLD_2-T_
1498+++8FAA~            	DB (T_NEW_3-T1_)*2
1499+++8FAA~            	DB TCNEW_3-T_
1500+++8FAA~            	DB (T_OLD_3-T1_)*2
1501+++8FAA~            	DB TCOLD_3-T_
1502+++8FAA~            1503+++8FAA~            T_
1504+++8FAA~            1505+++8FAA~            TCOLD_0	DB #00+1,#04+1,#08+1,#0A+1,#0C+1,#0E+1,#12+1,#14+1
1506+++8FAA~            	DB #18+1,#24+1,#3C+1,0
1507+++8FAA~            TCOLD_1	DB #5C+1,0
1508+++8FAA~            TCOLD_2	DB #30+1,#36+1,#4C+1,#52+1,#5E+1,#70+1,#82,#8C,#9C
1509+++8FAA~            	DB #9E,#A0,#A6,#A8,#AA,#AC,#AE,#AE,0
1510+++8FAA~            TCNEW_3	DB #56+1
1511+++8FAA~            TCOLD_3	DB #1E+1,#22+1,#24+1,#28+1,#2C+1,#2E+1,#32+1,#BE+1,0
1512+++8FAA~            TCNEW_0	DB #1C+1,#20+1,#22+1,#26+1,#2A+1,#2C+1,#30+1,#54+1
1513+++8FAA~            	DB #BC+1,#BE+1,0
1514+++8FAA~            TCNEW_1 EQU TCOLD_1
1515+++8FAA~            TCNEW_2	DB #1A+1,#20+1,#24+1,#28+1,#2A+1,#3A+1,#4C+1,#5E+1
1516+++8FAA~            	DB #BA+1,#BC+1,#BE+1,0
1517+++8FAA~            1518+++8FAA~            PT3EMPTYORN EQU $-1
1519+++8FAA~            	DB 1,0
1520+++8FAA~            1521+++8FAA~            ;first 12 values of tone tables (packed)
1522+++8FAA~            1523+++8FAA~            T_PACK	DB #06EC*2/256,#06EC*2&255
1524+++8FAA~            	DB #0755-#06EC
1525+++8FAA~            	DB #07C5-#0755
1526+++8FAA~            	DB #083B-#07C5
1527+++8FAA~            	DB #08B8-#083B
1528+++8FAA~            	DB #093D-#08B8
1529+++8FAA~            	DB #09CA-#093D
1530+++8FAA~            	DB #0A5F-#09CA
1531+++8FAA~            	DB #0AFC-#0A5F
1532+++8FAA~            	DB #0BA4-#0AFC
1533+++8FAA~            	DB #0C55-#0BA4
1534+++8FAA~            	DB #0D10-#0C55
1535+++8FAA~            	DB #066D*2/256,#066D*2&255
1536+++8FAA~            	DB #06CF-#066D
1537+++8FAA~            	DB #0737-#06CF
1538+++8FAA~            	DB #07A4-#0737
1539+++8FAA~            	DB #0819-#07A4
1540+++8FAA~            	DB #0894-#0819
1541+++8FAA~            	DB #0917-#0894
1542+++8FAA~            	DB #09A1-#0917
1543+++8FAA~            	DB #0A33-#09A1
1544+++8FAA~            	DB #0ACF-#0A33
1545+++8FAA~            	DB #0B73-#0ACF
1546+++8FAA~            	DB #0C22-#0B73
1547+++8FAA~            	DB #0CDA-#0C22
1548+++8FAA~            	DB #0704*2/256,#0704*2&255
1549+++8FAA~            	DB #076E-#0704
1550+++8FAA~            	DB #07E0-#076E
1551+++8FAA~            	DB #0858-#07E0
1552+++8FAA~            	DB #08D6-#0858
1553+++8FAA~            	DB #095C-#08D6
1554+++8FAA~            	DB #09EC-#095C
1555+++8FAA~            	DB #0A82-#09EC
1556+++8FAA~            	DB #0B22-#0A82
1557+++8FAA~            	DB #0BCC-#0B22
1558+++8FAA~            	DB #0C80-#0BCC
1559+++8FAA~            	DB #0D3E-#0C80
1560+++8FAA~            	DB #07E0*2/256,#07E0*2&255
1561+++8FAA~            	DB #0858-#07E0
1562+++8FAA~            	DB #08E0-#0858
1563+++8FAA~            	DB #0960-#08E0
1564+++8FAA~            	DB #09F0-#0960
1565+++8FAA~            	DB #0A88-#09F0
1566+++8FAA~            	DB #0B28-#0A88
1567+++8FAA~            	DB #0BD8-#0B28
1568+++8FAA~            	DB #0C80-#0BD8
1569+++8FAA~            	DB #0D60-#0C80
1570+++8FAA~            	DB #0E10-#0D60
1571+++8FAA~            	DB #0EF8-#0E10
1572+++8FAA~            1573+++8FAA~            ;vars from here can be stripped
1574+++8FAA~            ;you can move VARS to any other address
1575+++8FAA~            1576+++8FAA~            VARS
1577+++8FAA~            1578+++8FAA~            is_ts	DB 0
1579+++8FAA~            1580+++8FAA~            ;ChannelsVars
1581+++8FAA~            	STRUCT	CHP
1582+++8FAA~            ;reset group
1583+++8FAA~            PsInOr	DB 0
1584+++8FAA~            PsInSm	DB 0
1585+++8FAA~            CrAmSl	DB 0
1586+++8FAA~            CrNsSl	DB 0
1587+++8FAA~            CrEnSl	DB 0
1588+++8FAA~            TSlCnt	DB 0
1589+++8FAA~            CrTnSl	DW 0
1590+++8FAA~            TnAcc	DW 0
1591+++8FAA~            COnOff	DB 0
1592+++8FAA~            ;reset group
1593+++8FAA~            1594+++8FAA~            OnOffD	DB 0
1595+++8FAA~            1596+++8FAA~            ;IX for PTDECOD here (+12)
1597+++8FAA~            OffOnD	DB 0
1598+++8FAA~            OrnPtr	DW 0
1599+++8FAA~            SamPtr	DW 0
1600+++8FAA~            NNtSkp	DB 0
1601+++8FAA~            Note	DB 0
1602+++8FAA~            SlToNt	DB 0
1603+++8FAA~            Env_En	DB 0
1604+++8FAA~            Flags	DB 0
1605+++8FAA~             ;Enabled - 0, SimpleGliss - 2
1606+++8FAA~            TnSlDl	DB 0
1607+++8FAA~            TSlStp	DW 0
1608+++8FAA~            TnDelt	DW 0
1609+++8FAA~            NtSkCn	DB 0
1610+++8FAA~            Volume	DB 0
1611+++8FAA~            	ENDS
1612+++8FAA~            1613+++8FAA~            	STRUCT	VRS
1614+++8FAA~            1615+++8FAA~            ;IF not works in STRUCT in SjASM :(
1616+++8FAA~            ;	IF CurPosCounter
1617+++8FAA~            CurPos	DB 0
1618+++8FAA~            PosSub	DB 0
1619+++8FAA~            ;	ENDIF
1620+++8FAA~            1621+++8FAA~            ModNum	DB 0 ;bit0: ChipNum
1622+++8FAA~            	     ;bit1: 1-reversed patterns order (AlCo TS)
1623+++8FAA~            1624+++8FAA~            ChanA	DS CHP
1625+++8FAA~            ChanB	DS CHP
1626+++8FAA~            ChanC	DS CHP
1627+++8FAA~            1628+++8FAA~            ;GlobalVars
1629+++8FAA~            MODADDR	DW 0
1630+++8FAA~            OrnPtrs	DW 0
1631+++8FAA~            SamPtrs	DW 0
1632+++8FAA~            PatsPtr	DW 0
1633+++8FAA~            AdInPtA	DW 0
1634+++8FAA~            AdInPtB	DW 0
1635+++8FAA~            AdInPtC	DW 0
1636+++8FAA~            CrPsPtr	DW 0
1637+++8FAA~            LPosPtr	DW 0
1638+++8FAA~            Delay	DB 0
1639+++8FAA~            DelyCnt	DB 0
1640+++8FAA~            ESldAdd	DW 0
1641+++8FAA~            CurESld	DW 0
1642+++8FAA~            Env_Del	DB 0
1643+++8FAA~            CurEDel	DB 0
1644+++8FAA~            Ns_Base	DB 0
1645+++8FAA~            AddToNs	DB 0
1646+++8FAA~            AddToEn	DB 0
1647+++8FAA~            EnvBase	DW 0
1648+++8FAA~            AYREGS	DS 14
1649+++8FAA~            	ENDS
1650+++8FAA~            1651+++8FAA~            VARS1	DS VRS
1652+++8FAA~            VARS2	DS VRS
1653+++8FAA~            1654+++8FAA~            VT_	EQU $-16
1655+++8FAA~            	DS 256-16 ;CreatedVolumeTableAddress
1656+++8FAA~            1657+++8FAA~            T1_	EQU VT_+16 ;Tone tables data depacked here
1658+++8FAA~            1659+++8FAA~            T_OLD_1	EQU T1_
1660+++8FAA~            T_OLD_2	EQU T_OLD_1+24
1661+++8FAA~            T_OLD_3	EQU T_OLD_2+24
1662+++8FAA~            T_OLD_0	EQU T_OLD_3+2
1663+++8FAA~            T_NEW_0	EQU T_OLD_0
1664+++8FAA~            T_NEW_1	EQU T_OLD_1
1665+++8FAA~            T_NEW_2	EQU T_NEW_0+24
1666+++8FAA~            T_NEW_3	EQU T_OLD_3
1667+++8FAA~            1668+++8FAA~            PT2EMPTYORN EQU VT_+31 ;1,0,0 sequence
1669+++8FAA~            1670+++8FAA~            NT_	DS 192 ;CreatedNoteTableAddress
1671+++8FAA~            1672+++8FAA~            VAR0END	EQU VT_+16 ;INIT zeroes from VARS to VAR0END-1
1673+++8FAA~            1674+++8FAA~            VARSEND EQU $
1675+++8FAA~            MDLADDR EQU $
1676+++8FAA~            1677+++8FAA~                   DISPLAY "PTS player size=",$-START
1678+++8FAA~            1679+++8FAA~            ;Release 0 steps:
1680+++8FAA~            ;04/21/2007
1681+++8FAA~            ;Works start (PTxPlay adaptation); first beta.
1682+++8FAA~            ;04/22/2007
1683+++8FAA~            ;Job finished; beta-testing.
1684+++8FAA~            ;04/23/2007
1685+++8FAA~            ;PT v3.7 TS mode corrected (after AlCo remarks).
1686+++8FAA~            ;04/29/2007
1687+++8FAA~            ;Added 1.XX and 2.XX special commands interpretation for PT3
1688+++8FAA~            ;modules of v3.7+.
1689+++8FAA~            1690+++8FAA~            ;Size (minimal build for ZX Spectrum):
1691+++8FAA~            ;Code block #908 bytes
1692+++8FAA~            ;Variables #2BF bytes (can be stripped)
1693+++8FAA~            ;Total size #908+#2BF=#BC7 (3015) bytes
1694+++8FAA~            1695+++8FAA~                   ENDMOD
1696+++8FAA~            1697+++8FAA                    endif
1698+++8FAA             
0077+++8FAA             
0078+++8FAA             PT2.Play=PTS.PLAY
0079+++8FAA             PT2.Mute=PTS.MUTE        
0080+++8FAA             PT2.End
0081+++8FAA             
0082+++8FAA                     display "PT2 module size: ",PT2.End-PT2.Start
0083+++8FAA                     endif
0084+++8FAA                    
0415++ 8FAA                     include "ts.asm"
0001+++8FAA                   ifndef _ts_asm_defined
0002+++8FAA                   define _ts_asm_defined
0003+++8FAA                   
0004+++8FAA                   module TS
0005+++8FAA                   
0006+++8FAA                   struct Footer
0007+++8FAA~            Sign1 DS 4
0008+++8FAA~            Size1 DW 0
0009+++8FAA~            Sign2 DS 4
0010+++8FAA~            Size2 DW 0
0011+++8FAA~            Sign3 DS 4      
0012+++8FAA                   ENDS
0013+++8FAA             
0014+++8FAA             Start      
0015+++8FAA                     ifndef NoPrologue
0016+++8FAA~                    ld hl,End
0017+++8FAA~                    jr .init
0018+++8FAA~                    jp PTS.PLAY
0019+++8FAA~                    jp PTS.MUTE
0020+++8FAA~            .init   call CheckFormat
0021+++8FAA~                    ;ignore invalids
0022+++8FAA                     endif
0023+++8FAA             
0024+++8FAA 3E 10       Init    ld a,PTS.SETUP.TS02
0025+++8FAC C3 63 83            jp PTS.INIT
0026+++8FAF             
0027+++8FAF             ;in HL - module addr
0028+++8FAF             ;out Z - is ts
0029+++8FAF             ;out HL/DE modules offsets (valid only if Z)
0030+++8FAF             CheckFormat
0031+++8FB0 54 5D               ld d,h,e,l
0032+++8FB1 14                  inc d ;skip 256 bytes
0033+++8FB2             .findfooter
0034+++8FB3 62 6B               ld h,d,l,e
0035+++8FB4 CD C1 8F            call CheckFooter
0036+++8FB7 C8                  ret z
0037+++8FB8 1C                  inc e
0038+++8FB9 20 F7               jr nz,.findfooter
0039+++8FBB 14                  inc d
0040+++8FBC 20 F4               jr nz,.findfooter
0041+++8FBE 1C                  inc e ;reset Z
0042+++8FBF                     ;hl/de are invalid!!!
0043+++8FBF C9                  ret
0044+++8FC0             
0045+++8FC0             ;in HL - module addr
0046+++8FC0             ;in BC - module size
0047+++8FC0             ;out Z - is ts
0048+++8FC0             ;out HL/DE - modules offsets (valid only if Z)
0049+++8FC0                     ifdef HaveFormatCheck
0050+++8FC0             CheckFormatKnownSize
0051+++8FC0 09                  add hl,bc
0052+++8FC1                     endif
0053+++8FC1             CheckFooter
0054+++8FC1 2B                  dec hl
0055+++8FC2 7E                  ld a,(hl)
0056+++8FC3 FE 53               cp "S"
0057+++8FC5 C0                  ret nz
0058+++8FC6 2B                  dec hl
0059+++8FC7 7E                  ld a,(hl)
0060+++8FC8 FE 54               cp "T"
0061+++8FCA C0                  ret nz
0062+++8FCB 2B                  dec hl
0063+++8FCC 7E                  ld a,(hl)
0064+++8FCD FE 32               cp "2"
0065+++8FCF C0                  ret nz
0066+++8FD0 2B                  dec hl
0067+++8FD1 7E                  ld a,(hl)
0068+++8FD2 FE 30               cp "0"
0069+++8FD4 C0                  ret nz
0070+++8FD5 2B                  dec hl
0071+++8FD6 56                  ld d,(hl)
0072+++8FD7 2B                  dec hl
0073+++8FD8 5E                  ld e,(hl) ;Size2
0074+++8FDC 2B 2B 2B 2B         dec hl,hl,hl,hl;skip Sign2
0075+++8FDD 2B                  dec hl
0076+++8FDE 46                  ld b,(hl)
0077+++8FDF 2B                  dec hl
0078+++8FE0 4E                  ld c,(hl) ;Size1
0079+++8FE4 2B 2B 2B 2B         dec hl,hl,hl,hl;skip Sign1
0080+++8FE5             
0081+++8FE5 ED 52               sbc hl,de
0082+++8FE7 54                  ld d,h
0083+++8FE8 5D                  ld e,l
0084+++8FE9 ED 42               sbc hl,bc
0085+++8FEB AF                  xor a
0086+++8FEC C9                  ret
0087+++8FED             
0088+++8FED                     ifdef HaveFormatCheck
0089+++8FED                     display "TS checker size: ",$-CheckFormat
0090+++8FED                     endif
0091+++8FED             
0092+++8FED                     endmod
0093+++8FED             
0094+++8FED                     include "PTSPlay.asm"
0001+++8FED                     ifndef _pts_asm_defined
0002+++8FED~                    define _pts_asm_defined
0003+++8FED~            0004+++8FED~                    MODULE PTS
0005+++8FED~                    
0006+++8FED~            ;Universal PT2'n'PT3 Turbo Sound player for ZX Spectrum
0007+++8FED~            ;(c)2004-2007 S.V.Bulba <vorobey@mail.khstu.ru>
0008+++8FED~            ;Specially for AlCo
0009+++8FED~            ;http://bulba.untergrund.net/ (http://bulba.at.kz/)
0010+++8FED~            0011+++8FED~            ;Release number
0012+++8FED~            Release EQU "0"
0013+++8FED~            0014+++8FED~            ;Conditional assembly
0015+++8FED~            ;1) Current position counters at (Vars1+0) and (Vars2+0)
0016+++8FED~            CurPosCounter=0
0017+++8FED~            ;2) Allow channels allocation bits at (SETUP)
0018+++8FED~            ACBBAC=0
0019+++8FED~            ;3) Allow loop checking and disabling
0020+++8FED~            LoopChecker=0
0021+++8FED~            ;4) Insert official identificator
0022+++8FED~            Id=0
0023+++8FED~            ;5) Set IY for correct return to ZX Basic
0024+++8FED~            Basic=0
0025+++8FED~            0026+++8FED~            ;Features
0027+++8FED~            ;--------
0028+++8FED~            ;-Can be compiled at any address (i.e. no need rounding ORG
0029+++8FED~            ; address).
0030+++8FED~            ;-Variables (VARS) can be located at any address (not only after
0031+++8FED~            ; code block).
0032+++8FED~            ;-INIT subprogram checks PT3-module version and rightly
0033+++8FED~            ; generates both note and volume tables outside of code block
0034+++8FED~            ; (in VARS).
0035+++8FED~            ;-Two portamento (spc. command 3xxx) algorithms (depending of
0036+++8FED~            ; PT3 module version).
0037+++8FED~            ;-New 1.XX and 2.XX special command behaviour (only for PT v3.7
0038+++8FED~            ; and higher).
0039+++8FED~            ;-Any Tempo value are accepted (including Tempo=1 and Tempo=2).
0040+++8FED~            ;-TS modes: 2xPT3, 2xPT2 and PT v3.7 TS standard.
0041+++8FED~            ;-Fully compatible with Ay_Emul PT3 and PT2 players codes.
0042+++8FED~            ;-See also notes at the end of this source code.
0043+++8FED~            0044+++8FED~            ;Limitations
0045+++8FED~            ;-----------
0046+++8FED~            ;-Can run in RAM only (self-modified code is used).
0047+++8FED~            ;-PT2 position list must be end by #FF marker only.
0048+++8FED~            0049+++8FED~            ;Warning!!! PLAY subprogram can crash if no module are loaded
0050+++8FED~            ;into RAM or INIT subprogram was not called before.
0051+++8FED~            0052+++8FED~            ;Call MUTE or INIT one more time to mute sound after stopping
0053+++8FED~            ;playing 
0054+++8FED~            0055+++8FED~            TonA	EQU 0
0056+++8FED~            TonB	EQU 2
0057+++8FED~            TonC	EQU 4
0058+++8FED~            Noise	EQU 6
0059+++8FED~            Mixer	EQU 7
0060+++8FED~            AmplA	EQU 8
0061+++8FED~            AmplB	EQU 9
0062+++8FED~            AmplC	EQU 10
0063+++8FED~            Env	EQU 11
0064+++8FED~            EnvTp	EQU 13
0065+++8FED~            0066+++8FED~            START
0067+++8FED~            0068+++8FED~            SETUP.NOLOOP EQU 1
0069+++8FED~            SETUP.PT2 EQU 2
0070+++8FED~            SETUP.ACB EQU 4
0071+++8FED~            SETUP.BAC EQU 8
0072+++8FED~            SETUP.TS02 EQU 16
0073+++8FED~            SETUP.TSPT3 EQU 32
0074+++8FED~            0075+++8FED~            SETUP	DB 0 ;set bit0, if you want to play without looping
0076+++8FED~            	     ;(optional);
0077+++8FED~            	     ;set bit1 for PT2 and reset for PT3 before
0078+++8FED~            	     ;calling INIT;
0079+++8FED~            	     ;bits2-3: %00-ABC, %01-ACB, %10-BAC (optional);
0080+++8FED~            	     ;bits4-5: %00-no TS, %01-2 modules TS, %10-
0081+++8FED~            	     ;autodetect PT3 TS-format by AlCo (PT 3.7+);
0082+++8FED~            	     ;Remark: old PT3 TS-format by AlCo (PT 3.6) is not
0083+++8FED~            	     ;documented and must be converted to new standard.
0084+++8FED~            	     ;bit6 is set each time, when loop point of 2nd TS
0085+++8FED~            	     ;module is passed (optional).
0086+++8FED~            	     ;bit7 is set each time, when loop point of 1st TS
0087+++8FED~            	     ;or of single module is passed (optional).
0088+++8FED~            0089+++8FED~            ;Identifier
0090+++8FED~            	IF Id
0091+++8FED~            	DB "=UniPT2/PT3/TS-Player r.",Release,"="
0092+++8FED~            	ENDIF
0093+++8FED~            0094+++8FED~            	IF LoopChecker
0095+++8FED~            CHECKLP	LD HL,SETUP
0096+++8FED~            	BIT 0,(IY-100+VRS.ModNum)
0097+++8FED~            	JR Z,CHL1
0098+++8FED~            	SET 6,(HL)
0099+++8FED~            	JR CHL2
0100+++8FED~            CHL1	SET 7,(HL)
0101+++8FED~            CHL2	BIT 0,(HL)
0102+++8FED~            	RET Z
0103+++8FED~            	POP HL
0104+++8FED~            	INC (IY-100+VRS.DelyCnt)
0105+++8FED~            	INC (IY-100+VRS.ChanA+CHP.NtSkCn)
0106+++8FED~            	XOR A
0107+++8FED~            	LD (IY-100+VRS.AYREGS+AmplA),A
0108+++8FED~            	LD (IY-100+VRS.AYREGS+AmplB),A
0109+++8FED~            	LD (IY-100+VRS.AYREGS+AmplC),A
0110+++8FED~            	RET
0111+++8FED~            	ENDIF
0112+++8FED~            0113+++8FED~            MUTE	XOR A
0114+++8FED~            	LD H,A
0115+++8FED~            	LD L,A
0116+++8FED~            	LD (VARS1+VRS.AYREGS+AmplA),A
0117+++8FED~            	LD (VARS1+VRS.AYREGS+AmplB),HL
0118+++8FED~            	LD (VARS2+VRS.AYREGS+AmplA),A
0119+++8FED~            	LD (VARS2+VRS.AYREGS+AmplB),HL
0120+++8FED~            	JP ROUT
0121+++8FED~            0122+++8FED~            INIT
0123+++8FED~            ;HL - AddressOfModule
0124+++8FED~            ;DE - AddresOf2ndModule
0125+++8FED~            ;A - mode
0126+++8FED~            	PUSH DE
0127+++8FED~            	PUSH HL
0128+++8FED~            	LD HL,VARS
0129+++8FED~            	LD (HL),0
0130+++8FED~            	LD DE,VARS+1
0131+++8FED~            	LD BC,VAR0END-VARS-1
0132+++8FED~            	LDIR
0133+++8FED~            	INC HL
0134+++8FED~            	LD (VARS1+VRS.AdInPtA),HL ;ptr to zero
0135+++8FED~            	LD (VARS2+VRS.AdInPtA),HL
0136+++8FED~            0137+++8FED~            	POP HL
0138+++8FED~            	LD IY,VARS1+100
0139+++8FED~                LD (SETUP),A
0140+++8FED~            	AND SETUP.PT2
0141+++8FED~            	JP NZ,I_PT2
0142+++8FED~            0143+++8FED~            	CALL INITPT3
0144+++8FED~            	LD HL,(e_-SamCnv-2)*256+#18
0145+++8FED~            	LD (SamCnv),HL
0146+++8FED~            	LD A,#BA
0147+++8FED~            	LD (OrnCP),A
0148+++8FED~            	LD (SamCP),A
0149+++8FED~            	LD A,#7B
0150+++8FED~            	LD (OrnLD),A
0151+++8FED~            	LD (SamLD),A
0152+++8FED~            	LD A,#87
0153+++8FED~            	LD (SamClc2),A
0154+++8FED~            	POP HL
0155+++8FED~            	;Use version and ton table of 1st module
0156+++8FED~            	LD A,(IX+13-100) ;EXTRACT VERSION NUMBER
0157+++8FED~            	SUB #30
0158+++8FED~            	JR C,L20
0159+++8FED~            	CP 10
0160+++8FED~            	JR C,L21
0161+++8FED~            L20	LD A,6
0162+++8FED~            L21	LD (Version),A
0163+++8FED~            	PUSH AF ;VolTable version
0164+++8FED~            	CP 4
0165+++8FED~            	LD A,(IX+99-100) ;TONE TABLE NUMBER
0166+++8FED~            	RLA
0167+++8FED~            	AND 7
0168+++8FED~            	PUSH AF ;NoteTable number
0169+++8FED~            0170+++8FED~            	LD IY,VARS2+100
0171+++8FED~            	LD A,(SETUP)
0172+++8FED~            	AND SETUP.TS02|SETUP.TSPT3
0173+++8FED~            	JR Z,NOTS
0174+++8FED~            	CP SETUP.TS02
0175+++8FED~            	JR Z,TwoPT3s
0176+++8FED~            	LD A,(Version)
0177+++8FED~            	CP 7
0178+++8FED~            	JR C,NOTS
0179+++8FED~            	LD A,(IX+98-100) ;ALCO TS MARKER
0180+++8FED~            	CP #20
0181+++8FED~            	JR Z,NOTS
0182+++8FED~            	LD HL,VARS1
0183+++8FED~            	LD DE,VARS2
0184+++8FED~            	LD BC,VRS
0185+++8FED~            	LDIR
0186+++8FED~            	SET 1,(IY-100+VRS.ModNum)
0187+++8FED~            	LD C,A
0188+++8FED~            	ADD A,A
0189+++8FED~            	ADD A,C
0190+++8FED~            	SUB 2
0191+++8FED~            	LD (TSSub),A
0192+++8FED~            	JR AlCoTS_
0193+++8FED~            TwoPT3s	CALL INITPT3
0194+++8FED~            AlCoTS_	LD A,1
0195+++8FED~            	LD (is_ts),A
0196+++8FED~            	SET 0,(IY-100+VRS.ModNum)
0197+++8FED~            0198+++8FED~            NOTS	LD BC,PT3PD
0199+++8FED~            	LD HL,0
0200+++8FED~            	LD DE,PT3EMPTYORN
0201+++8FED~            	JR INITCOMMON
0202+++8FED~            0203+++8FED~            I_PT2	CALL INITPT2
0204+++8FED~            	LD HL,#51CB
0205+++8FED~            	LD (SamCnv),HL
0206+++8FED~            	LD A,#BB
0207+++8FED~            	LD (OrnCP),A
0208+++8FED~            	LD (SamCP),A
0209+++8FED~            	LD A,#7A
0210+++8FED~            	LD (OrnLD),A
0211+++8FED~            	LD (SamLD),A
0212+++8FED~            	LD A,#80
0213+++8FED~            	LD (SamClc2),A
0214+++8FED~            	POP HL
0215+++8FED~            	LD A,5
0216+++8FED~            	LD (Version),A
0217+++8FED~            	PUSH AF
0218+++8FED~            	LD A,2
0219+++8FED~            	PUSH AF
0220+++8FED~            0221+++8FED~            	LD A,(SETUP)
0222+++8FED~                AND SETUP.TS02|SETUP.TSPT3
0223+++8FED~            	JR Z,NOTS2
0224+++8FED~            0225+++8FED~            	LD IY,VARS2+100
0226+++8FED~            	LD A,1
0227+++8FED~            	LD (is_ts),A
0228+++8FED~            	SET 0,(IY-100+VRS.ModNum)
0229+++8FED~            	CALL INITPT2
0230+++8FED~            0231+++8FED~            NOTS2	LD BC,PT2PD
0232+++8FED~            	LD HL,#8687
0233+++8FED~            	LD DE,PT2EMPTYORN
0234+++8FED~            0235+++8FED~            INITCOMMON
0236+++8FED~            0237+++8FED~            	IF Basic
0238+++8FED~            	LD IY,#5C3A
0239+++8FED~            	ENDIF
0240+++8FED~            0241+++8FED~            	LD (PTDEC),BC
0242+++8FED~            	LD (PsCalc),HL
0243+++8FED~            	PUSH DE
0244+++8FED~            0245+++8FED~            ;note table data depacker
0246+++8FED~            ;(c) Ivan Roshin
0247+++8FED~            	LD DE,T_PACK
0248+++8FED~            	LD BC,T1_+(2*49)-1
0249+++8FED~            TP_0	LD A,(DE)
0250+++8FED~            	INC DE
0251+++8FED~            	CP 15*2
0252+++8FED~            	JR NC,TP_1
0253+++8FED~            	LD H,A
0254+++8FED~            	LD A,(DE)
0255+++8FED~            	LD L,A
0256+++8FED~            	INC DE
0257+++8FED~            	JR TP_2
0258+++8FED~            TP_1	PUSH DE
0259+++8FED~            	LD D,0
0260+++8FED~            	LD E,A
0261+++8FED~            	ADD HL,DE
0262+++8FED~            	ADD HL,DE
0263+++8FED~            	POP DE
0264+++8FED~            TP_2	LD A,H
0265+++8FED~            	LD (BC),A
0266+++8FED~            	DEC BC
0267+++8FED~            	LD A,L
0268+++8FED~            	LD (BC),A
0269+++8FED~            	DEC BC
0270+++8FED~            	SUB (#F8*2)&255
0271+++8FED~            	JR NZ,TP_0
0272+++8FED~            0273+++8FED~            	INC A
0274+++8FED~            	LD (VARS1+VRS.DelyCnt),A
0275+++8FED~            	LD (VARS2+VRS.DelyCnt),A
0276+++8FED~            	LD HL,#F001 ;H - CHP.Volume, L - CHP.NtSkCn
0277+++8FED~            	LD (VARS1+VRS.ChanA+CHP.NtSkCn),HL
0278+++8FED~            	LD (VARS1+VRS.ChanB+CHP.NtSkCn),HL
0279+++8FED~            	LD (VARS1+VRS.ChanC+CHP.NtSkCn),HL
0280+++8FED~            	LD (VARS2+VRS.ChanA+CHP.NtSkCn),HL
0281+++8FED~            	LD (VARS2+VRS.ChanB+CHP.NtSkCn),HL
0282+++8FED~            	LD (VARS2+VRS.ChanC+CHP.NtSkCn),HL
0283+++8FED~            	POP HL
0284+++8FED~            	LD (VARS1+VRS.ChanA+CHP.OrnPtr),HL
0285+++8FED~            	LD (VARS1+VRS.ChanB+CHP.OrnPtr),HL
0286+++8FED~            	LD (VARS1+VRS.ChanC+CHP.OrnPtr),HL
0287+++8FED~            	LD (VARS2+VRS.ChanA+CHP.OrnPtr),HL
0288+++8FED~            	LD (VARS2+VRS.ChanB+CHP.OrnPtr),HL
0289+++8FED~            	LD (VARS2+VRS.ChanC+CHP.OrnPtr),HL
0290+++8FED~            0291+++8FED~            	POP AF
0292+++8FED~            0293+++8FED~            ;NoteTableCreator (c) Ivan Roshin
0294+++8FED~            ;A - NoteTableNumber*2+VersionForNoteTable
0295+++8FED~            ;(xx1b - 3.xx..3.4r, xx0b - 3.4x..3.6x..VTII1.0)
0296+++8FED~            0297+++8FED~            	LD HL,NT_DATA
0298+++8FED~            	LD D,0
0299+++8FED~            	ADD A,A
0300+++8FED~            	LD E,A
0301+++8FED~            	ADD HL,DE
0302+++8FED~            	LD E,(HL)
0303+++8FED~            	INC HL
0304+++8FED~            	SRL E
0305+++8FED~            	SBC A,A
0306+++8FED~            	AND #A7 ;#00 (NOP) or #A7 (AND A)
0307+++8FED~            	LD (L3),A
0308+++8FED~            	EX DE,HL
0309+++8FED~            	LD BC,T1_
0310+++8FED~            	ADD HL,BC
0311+++8FED~            0312+++8FED~            	LD A,(DE)
0313+++8FED~            	ADD A,T_&255
0314+++8FED~            	LD C,A
0315+++8FED~            	ADC A,T_/256
0316+++8FED~            	SUB C
0317+++8FED~            	LD B,A
0318+++8FED~            	PUSH BC
0319+++8FED~            	LD DE,NT_
0320+++8FED~            	PUSH DE
0321+++8FED~            0322+++8FED~            	LD B,12
0323+++8FED~            L1	PUSH BC
0324+++8FED~            	LD C,(HL)
0325+++8FED~            	INC HL
0326+++8FED~            	PUSH HL
0327+++8FED~            	LD B,(HL)
0328+++8FED~            0329+++8FED~            	PUSH DE
0330+++8FED~            	EX DE,HL
0331+++8FED~            	LD DE,23
0332+++8FED~            	LD IXH,8
0333+++8FED~            0334+++8FED~            L2	SRL B
0335+++8FED~            	RR C
0336+++8FED~            L3	DB #19	;AND A or NOP
0337+++8FED~            	LD A,C
0338+++8FED~            	ADC A,D	;=ADC 0
0339+++8FED~            	LD (HL),A
0340+++8FED~            	INC HL
0341+++8FED~            	LD A,B
0342+++8FED~            	ADC A,D
0343+++8FED~            	LD (HL),A
0344+++8FED~            	ADD HL,DE
0345+++8FED~            	DEC IXH
0346+++8FED~            	JR NZ,L2
0347+++8FED~            0348+++8FED~            	POP DE
0349+++8FED~            	INC DE
0350+++8FED~            	INC DE
0351+++8FED~            	POP HL
0352+++8FED~            	INC HL
0353+++8FED~            	POP BC
0354+++8FED~            	DJNZ L1
0355+++8FED~            0356+++8FED~            	POP HL
0357+++8FED~            	POP DE
0358+++8FED~            0359+++8FED~            	LD A,E
0360+++8FED~            	CP TCOLD_1&255
0361+++8FED~            	JR NZ,CORR_1
0362+++8FED~            	LD A,#FD
0363+++8FED~            	LD (NT_+#2E),A
0364+++8FED~            0365+++8FED~            CORR_1	LD A,(DE)
0366+++8FED~            	AND A
0367+++8FED~            	JR Z,TC_EXIT
0368+++8FED~            	RRA
0369+++8FED~            	PUSH AF
0370+++8FED~            	ADD A,A
0371+++8FED~            	LD C,A
0372+++8FED~            	ADD HL,BC
0373+++8FED~            	POP AF
0374+++8FED~            	JR NC,CORR_2
0375+++8FED~            	DEC (HL)
0376+++8FED~            	DEC (HL)
0377+++8FED~            CORR_2	INC (HL)
0378+++8FED~            	AND A
0379+++8FED~            	SBC HL,BC
0380+++8FED~            	INC DE
0381+++8FED~            	JR CORR_1
0382+++8FED~            0383+++8FED~            TC_EXIT
0384+++8FED~            0385+++8FED~            	POP AF
0386+++8FED~            0387+++8FED~            ;VolTableCreator (c) Ivan Roshin
0388+++8FED~            ;A - VersionForVolumeTable (0..4 - 3.xx..3.4x;
0389+++8FED~            			   ;5.. - 2.x,3.5x..3.6x..VTII1.0)
0390+++8FED~            0391+++8FED~            	CP 5
0392+++8FED~            	LD HL,#11
0393+++8FED~            	LD D,H
0394+++8FED~            	LD E,H
0395+++8FED~            	LD A,#17
0396+++8FED~            	JR NC,M1
0397+++8FED~            	DEC L
0398+++8FED~            	LD E,L
0399+++8FED~            	XOR A
0400+++8FED~            M1      LD (M2),A
0401+++8FED~            0402+++8FED~            	LD IX,VT_+16
0403+++8FED~            0404+++8FED~            	LD C,#F
0405+++8FED~            INITV2  PUSH HL
0406+++8FED~            0407+++8FED~            	ADD HL,DE
0408+++8FED~            	EX DE,HL
0409+++8FED~            	SBC HL,HL
0410+++8FED~            0411+++8FED~            	LD B,#10
0412+++8FED~            INITV1  LD A,L
0413+++8FED~            M2      DB #7D
0414+++8FED~            	LD A,H
0415+++8FED~            	ADC A,0
0416+++8FED~            	LD (IX),A
0417+++8FED~            	INC IX
0418+++8FED~            	ADD HL,DE
0419+++8FED~            	DJNZ INITV1
0420+++8FED~            0421+++8FED~            	POP HL
0422+++8FED~            	LD A,E
0423+++8FED~            	CP #77
0424+++8FED~            	JR NZ,M3
0425+++8FED~            	INC E
0426+++8FED~            M3      DEC C
0427+++8FED~            	JR NZ,INITV2
0428+++8FED~            0429+++8FED~            	JP ROUT
0430+++8FED~            0431+++8FED~            INITPT3	CALL SETMDAD
0432+++8FED~            	PUSH HL
0433+++8FED~            	LD DE,100
0434+++8FED~            	ADD HL,DE
0435+++8FED~            	LD A,(HL)
0436+++8FED~            	LD (IY-100+VRS.Delay),A
0437+++8FED~            	PUSH HL
0438+++8FED~            	POP IX
0439+++8FED~            	ADD HL,DE
0440+++8FED~            	CALL SETCPPT
0441+++8FED~            	LD E,(IX+102-100)
0442+++8FED~            	INC HL
0443+++8FED~            0444+++8FED~            	IF CurPosCounter
0445+++8FED~            	LD (IY-100+VRS.PosSub),L
0446+++8FED~            	ENDIF
0447+++8FED~            0448+++8FED~            	ADD HL,DE
0449+++8FED~            	CALL SETLPPT
0450+++8FED~            	POP DE
0451+++8FED~            	LD L,(IX+103-100)
0452+++8FED~            	LD H,(IX+104-100)
0453+++8FED~            	ADD HL,DE
0454+++8FED~            	CALL SETPTPT
0455+++8FED~            	LD HL,169
0456+++8FED~            	ADD HL,DE
0457+++8FED~            	CALL SETORPT
0458+++8FED~            	LD HL,105
0459+++8FED~            	ADD HL,DE
0460+++8FED~            0461+++8FED~            SETSMPT LD (IY-100+VRS.SamPtrs),L
0462+++8FED~            	LD (IY-100+VRS.SamPtrs+1),H
0463+++8FED~            	RET
0464+++8FED~            0465+++8FED~            INITPT2	LD A,(HL)
0466+++8FED~            	LD (IY-100+VRS.Delay),A
0467+++8FED~            	PUSH HL
0468+++8FED~            	PUSH HL
0469+++8FED~            	PUSH HL
0470+++8FED~            	INC HL
0471+++8FED~            	INC HL
0472+++8FED~            	LD A,(HL)
0473+++8FED~            	INC HL
0474+++8FED~            	CALL SETSMPT
0475+++8FED~            	LD E,(HL)
0476+++8FED~            	INC HL
0477+++8FED~            	LD D,(HL)
0478+++8FED~            	POP HL
0479+++8FED~            	AND A
0480+++8FED~            	SBC HL,DE
0481+++8FED~            	CALL SETMDAD
0482+++8FED~            	POP HL
0483+++8FED~            	LD DE,67
0484+++8FED~            	ADD HL,DE
0485+++8FED~            	CALL SETORPT
0486+++8FED~            	LD E,32
0487+++8FED~            	ADD HL,DE
0488+++8FED~            	LD C,(HL)
0489+++8FED~            	INC HL
0490+++8FED~            	LD B,(HL)
0491+++8FED~            	LD E,30
0492+++8FED~            	ADD HL,DE
0493+++8FED~            	CALL SETCPPT
0494+++8FED~            	LD E,A
0495+++8FED~            	INC HL
0496+++8FED~            0497+++8FED~            	IF CurPosCounter
0498+++8FED~            	LD (IY-100+VRS.PosSub),L
0499+++8FED~            	ENDIF
0500+++8FED~            0501+++8FED~            	ADD HL,DE
0502+++8FED~            	CALL SETLPPT
0503+++8FED~            	POP HL
0504+++8FED~            	ADD HL,BC
0505+++8FED~            0506+++8FED~            SETPTPT	LD (IY-100+VRS.PatsPtr),L
0507+++8FED~            	LD (IY-100+VRS.PatsPtr+1),H
0508+++8FED~            	RET
0509+++8FED~            0510+++8FED~            SETMDAD	LD (IY-100+VRS.MODADDR),L
0511+++8FED~            	LD (IY-100+VRS.MODADDR+1),H
0512+++8FED~            	RET
0513+++8FED~            0514+++8FED~            SETORPT	LD (IY-100+VRS.OrnPtrs),L
0515+++8FED~            	LD (IY-100+VRS.OrnPtrs+1),H
0516+++8FED~            	RET
0517+++8FED~            0518+++8FED~            SETCPPT	LD (IY-100+VRS.CrPsPtr),L
0519+++8FED~            	LD (IY-100+VRS.CrPsPtr+1),H
0520+++8FED~            	RET
0521+++8FED~            0522+++8FED~            SETLPPT	LD (IY-100+VRS.LPosPtr),L
0523+++8FED~            	LD (IY-100+VRS.LPosPtr+1),H
0524+++8FED~            	RET
0525+++8FED~            0526+++8FED~            SETENBS	LD (IY-100+VRS.EnvBase),L
0527+++8FED~            	LD (IY-100+VRS.EnvBase+1),H
0528+++8FED~            	RET
0529+++8FED~            0530+++8FED~            SETESLD	LD (IY-100+VRS.CurESld),L
0531+++8FED~            	LD (IY-100+VRS.CurESld+1),H
0532+++8FED~            	RET
0533+++8FED~            0534+++8FED~            GETIX	PUSH IY
0535+++8FED~            	POP IX
0536+++8FED~            	ADD IX,DE
0537+++8FED~            	RET
0538+++8FED~            0539+++8FED~            PTDECOD CALL GETIX
0540+++8FED~            PTDEC	EQU $+1
0541+++8FED~            	JP #C3C3
0542+++8FED~            0543+++8FED~            ;PT2 pattern decoder
0544+++8FED~            PD2_SAM	CALL SETSAM
0545+++8FED~            	JR PD2_LOOP
0546+++8FED~            0547+++8FED~            PD2_EOff LD (IX-12+CHP.Env_En),A
0548+++8FED~            	JR PD2_LOOP
0549+++8FED~            0550+++8FED~            PD2_ENV	LD (IX-12+CHP.Env_En),16
0551+++8FED~            	LD (IY-100+VRS.AYREGS+EnvTp),A
0552+++8FED~            	LD A,(BC)
0553+++8FED~            	INC BC
0554+++8FED~            	LD L,A
0555+++8FED~            	LD A,(BC)
0556+++8FED~            	INC BC
0557+++8FED~            	LD H,A
0558+++8FED~            	CALL SETENBS
0559+++8FED~            	JR PD2_LOOP
0560+++8FED~            0561+++8FED~            PD2_ORN	CALL SETORN
0562+++8FED~            	JR PD2_LOOP
0563+++8FED~            0564+++8FED~            PD2_SKIP INC A
0565+++8FED~            	LD (IX-12+CHP.NNtSkp),A
0566+++8FED~            	JR PD2_LOOP
0567+++8FED~            0568+++8FED~            PD2_VOL	RRCA
0569+++8FED~            	RRCA
0570+++8FED~            	RRCA
0571+++8FED~            	RRCA
0572+++8FED~            	LD (IX-12+CHP.Volume),A
0573+++8FED~            	JR PD2_LOOP
0574+++8FED~            0575+++8FED~            PD2_DEL	CALL C_DELAY
0576+++8FED~            	JR PD2_LOOP
0577+++8FED~            0578+++8FED~            PD2_GLIS SET 2,(IX-12+CHP.Flags)
0579+++8FED~            	INC A
0580+++8FED~            	LD (IX-12+CHP.TnSlDl),A
0581+++8FED~            	LD (IX-12+CHP.TSlCnt),A
0582+++8FED~            	LD A,(BC)
0583+++8FED~            	INC BC
0584+++8FED~                    LD (IX-12+CHP.TSlStp),A
0585+++8FED~            	ADD A,A
0586+++8FED~            	SBC A,A
0587+++8FED~                    LD (IX-12+CHP.TSlStp+1),A
0588+++8FED~            	SCF
0589+++8FED~            	JR PD2_LP2
0590+++8FED~            0591+++8FED~            PT2PD	AND A
0592+++8FED~            0593+++8FED~            PD2_LP2	EX AF,AF'
0594+++8FED~            0595+++8FED~            PD2_LOOP LD A,(BC)
0596+++8FED~            	INC BC
0597+++8FED~            	ADD A,#20
0598+++8FED~            	JR Z,PD2_REL
0599+++8FED~            	JR C,PD2_SAM
0600+++8FED~            	ADD A,96
0601+++8FED~            	JR C,PD2_NOTE
0602+++8FED~            	INC A
0603+++8FED~            	JR Z,PD2_EOff
0604+++8FED~            	ADD A,15
0605+++8FED~            	JP Z,PD_FIN
0606+++8FED~            	JR C,PD2_ENV
0607+++8FED~            	ADD A,#10
0608+++8FED~            	JR C,PD2_ORN
0609+++8FED~            	ADD A,#40
0610+++8FED~            	JR C,PD2_SKIP
0611+++8FED~            	ADD A,#10
0612+++8FED~            	JR C,PD2_VOL
0613+++8FED~            	INC A
0614+++8FED~            	JR Z,PD2_DEL
0615+++8FED~            	INC A
0616+++8FED~            	JR Z,PD2_GLIS
0617+++8FED~            	INC A
0618+++8FED~            	JR Z,PD2_PORT
0619+++8FED~            	INC A
0620+++8FED~            	JR Z,PD2_STOP
0621+++8FED~            	LD A,(BC)
0622+++8FED~            	INC BC
0623+++8FED~            	LD (IX-12+CHP.CrNsSl),A
0624+++8FED~            	JR PD2_LOOP
0625+++8FED~            0626+++8FED~            PD2_PORT RES 2,(IX-12+CHP.Flags)
0627+++8FED~            	LD A,(BC)
0628+++8FED~            	INC BC
0629+++8FED~            	INC BC ;ignoring precalc delta to right sound
0630+++8FED~            	INC BC
0631+++8FED~            	SCF
0632+++8FED~            	JR PD2_LP2
0633+++8FED~            0634+++8FED~            PD2_STOP LD (IX-12+CHP.TSlCnt),A
0635+++8FED~            	JR PD2_LOOP
0636+++8FED~            0637+++8FED~            PD2_REL	LD (IX-12+CHP.Flags),A
0638+++8FED~            	JR PD2_EXIT
0639+++8FED~            0640+++8FED~            PD2_NOTE LD L,A
0641+++8FED~            	LD A,(IX-12+CHP.Note)
0642+++8FED~            	LD (PrNote+1),A
0643+++8FED~            	LD (IX-12+CHP.Note),L
0644+++8FED~            	XOR A
0645+++8FED~            	LD (IX-12+CHP.TSlCnt),A
0646+++8FED~            	SET 0,(IX-12+CHP.Flags)
0647+++8FED~            	EX AF,AF'
0648+++8FED~            	JR NC,NOGLIS2
0649+++8FED~            	BIT 2,(IX-12+CHP.Flags)
0650+++8FED~            	JR NZ,NOPORT2
0651+++8FED~            	LD (LoStep),A
0652+++8FED~            	ADD A,A
0653+++8FED~            	SBC A,A
0654+++8FED~            	EX AF,AF'
0655+++8FED~            	LD H,A
0656+++8FED~            	LD L,A
0657+++8FED~            	INC A
0658+++8FED~            	CALL SETPORT
0659+++8FED~            NOPORT2	LD (IX-12+CHP.TSlCnt),1
0660+++8FED~            NOGLIS2	XOR A
0661+++8FED~            0662+++8FED~            0663+++8FED~            PD2_EXIT LD (IX-12+CHP.PsInSm),A
0664+++8FED~            	LD (IX-12+CHP.PsInOr),A
0665+++8FED~            	LD (IX-12+CHP.CrTnSl),A
0666+++8FED~            	LD (IX-12+CHP.CrTnSl+1),A
0667+++8FED~            	JP PD_FIN
0668+++8FED~            0669+++8FED~            ;PT3 pattern decoder
0670+++8FED~            PD_OrSm	LD (IX-12+CHP.Env_En),0
0671+++8FED~            	CALL SETORN
0672+++8FED~            PD_SAM_	LD A,(BC)
0673+++8FED~            	INC BC
0674+++8FED~            	RRCA
0675+++8FED~            0676+++8FED~            PD_SAM	CALL SETSAM
0677+++8FED~            	JR PD_LOOP
0678+++8FED~            0679+++8FED~            PD_VOL	RRCA
0680+++8FED~            	RRCA
0681+++8FED~            	RRCA
0682+++8FED~            	RRCA
0683+++8FED~            	LD (IX-12+CHP.Volume),A
0684+++8FED~            	JR PD_LP2
0685+++8FED~            	
0686+++8FED~            PD_EOff	LD (IX-12+CHP.Env_En),A
0687+++8FED~            	LD (IX-12+CHP.PsInOr),A
0688+++8FED~            	JR PD_LP2
0689+++8FED~            0690+++8FED~            PD_SorE	DEC A
0691+++8FED~            	JR NZ,PD_ENV
0692+++8FED~            	LD A,(BC)
0693+++8FED~            	INC BC
0694+++8FED~            	LD (IX-12+CHP.NNtSkp),A
0695+++8FED~            	JR PD_LP2
0696+++8FED~            0697+++8FED~            PD_ENV	CALL SETENV
0698+++8FED~            	JR PD_LP2
0699+++8FED~            0700+++8FED~            PD_ORN	CALL SETORN
0701+++8FED~            	JR PD_LOOP
0702+++8FED~            0703+++8FED~            PD_ESAM	LD (IX-12+CHP.Env_En),A
0704+++8FED~            	LD (IX-12+CHP.PsInOr),A
0705+++8FED~            	CALL NZ,SETENV
0706+++8FED~            	JR PD_SAM_
0707+++8FED~            0708+++8FED~            PT3PD	LD A,(IX-12+CHP.Note)
0709+++8FED~            	LD (PrNote+1),A
0710+++8FED~            	LD L,(IX-12+CHP.CrTnSl)
0711+++8FED~            	LD H,(IX-12+CHP.CrTnSl+1)
0712+++8FED~            	LD (PrSlide+1),HL
0713+++8FED~            0714+++8FED~            PD_LOOP	LD DE,#2010
0715+++8FED~            PD_LP2	LD A,(BC)
0716+++8FED~            	INC BC
0717+++8FED~            	ADD A,E
0718+++8FED~            	JR C,PD_OrSm
0719+++8FED~            	ADD A,D
0720+++8FED~            	JR Z,PD_FIN
0721+++8FED~            	JR C,PD_SAM
0722+++8FED~            	ADD A,E
0723+++8FED~            	JR Z,PD_REL
0724+++8FED~            	JR C,PD_VOL
0725+++8FED~            	ADD A,E
0726+++8FED~            	JR Z,PD_EOff
0727+++8FED~            	JR C,PD_SorE
0728+++8FED~            	ADD A,96
0729+++8FED~            	JR C,PD_NOTE
0730+++8FED~            	ADD A,E
0731+++8FED~            	JR C,PD_ORN
0732+++8FED~            	ADD A,D
0733+++8FED~            	JR C,PD_NOIS
0734+++8FED~            	ADD A,E
0735+++8FED~            	JR C,PD_ESAM
0736+++8FED~            	ADD A,A
0737+++8FED~            	LD E,A
0738+++8FED~            	LD HL,(SPCCOMS+#FF20-#2000)&65535
0739+++8FED~            	ADD HL,DE
0740+++8FED~            	LD E,(HL)
0741+++8FED~            	INC HL
0742+++8FED~            	LD D,(HL)
0743+++8FED~            	PUSH DE
0744+++8FED~            	JR PD_LOOP
0745+++8FED~            0746+++8FED~            PD_NOIS	LD (IY-100+VRS.Ns_Base),A
0747+++8FED~            	JR PD_LP2
0748+++8FED~            0749+++8FED~            PD_REL	RES 0,(IX-12+CHP.Flags)
0750+++8FED~            	JR PD_RES
0751+++8FED~            0752+++8FED~            PD_NOTE	LD (IX-12+CHP.Note),A
0753+++8FED~            	SET 0,(IX-12+CHP.Flags)
0754+++8FED~            	XOR A
0755+++8FED~            0756+++8FED~            PD_RES	LD (PDSP_+1),SP
0757+++8FED~            	LD SP,IX
0758+++8FED~            	LD H,A
0759+++8FED~            	LD L,A
0760+++8FED~            	PUSH HL
0761+++8FED~            	PUSH HL
0762+++8FED~            	PUSH HL
0763+++8FED~            	PUSH HL
0764+++8FED~            	PUSH HL
0765+++8FED~            	PUSH HL
0766+++8FED~            PDSP_	LD SP,#3131
0767+++8FED~            0768+++8FED~            PD_FIN	LD A,(IX-12+CHP.NNtSkp)
0769+++8FED~            	LD (IX-12+CHP.NtSkCn),A
0770+++8FED~            	RET
0771+++8FED~            0772+++8FED~            C_PORTM LD A,(BC)
0773+++8FED~            	INC BC
0774+++8FED~            ;SKIP PRECALCULATED TONE DELTA (BECAUSE
0775+++8FED~            ;CANNOT BE RIGHT AFTER PT3 COMPILATION)
0776+++8FED~            	INC BC
0777+++8FED~            	INC BC
0778+++8FED~            	EX AF,AF'
0779+++8FED~            	LD A,(BC) ;SIGNED TONE STEP
0780+++8FED~            	INC BC
0781+++8FED~            	LD (LoStep),A
0782+++8FED~            	LD A,(BC)
0783+++8FED~            	INC BC
0784+++8FED~            	AND A
0785+++8FED~            	EX AF,AF'
0786+++8FED~            	LD L,(IX-12+CHP.CrTnSl)
0787+++8FED~            	LD H,(IX-12+CHP.CrTnSl+1)
0788+++8FED~            0789+++8FED~            ;Set portamento variables
0790+++8FED~            ;A - Delay; A' - Hi(Step); ZF' - (A'=0); HL - CrTnSl
0791+++8FED~            0792+++8FED~            SETPORT	RES 2,(IX-12+CHP.Flags)
0793+++8FED~            	LD (IX-12+CHP.TnSlDl),A
0794+++8FED~            	LD (IX-12+CHP.TSlCnt),A
0795+++8FED~            	PUSH HL
0796+++8FED~            	LD DE,NT_
0797+++8FED~            	LD A,(IX-12+CHP.Note)
0798+++8FED~            	LD (IX-12+CHP.SlToNt),A
0799+++8FED~            	ADD A,A
0800+++8FED~            	LD L,A
0801+++8FED~            	LD H,0
0802+++8FED~            	ADD HL,DE
0803+++8FED~            	LD A,(HL)
0804+++8FED~            	INC HL
0805+++8FED~            	LD H,(HL)
0806+++8FED~            	LD L,A
0807+++8FED~            	PUSH HL
0808+++8FED~            PrNote	LD A,#3E
0809+++8FED~            	LD (IX-12+CHP.Note),A
0810+++8FED~            	ADD A,A
0811+++8FED~            	LD L,A
0812+++8FED~            	LD H,0
0813+++8FED~            	ADD HL,DE
0814+++8FED~            	LD E,(HL)
0815+++8FED~            	INC HL
0816+++8FED~            	LD D,(HL)
0817+++8FED~            	POP HL
0818+++8FED~            	SBC HL,DE
0819+++8FED~            	LD (IX-12+CHP.TnDelt),L
0820+++8FED~            	LD (IX-12+CHP.TnDelt+1),H
0821+++8FED~            	POP DE
0822+++8FED~            Version EQU $+1
0823+++8FED~            	LD A,#3E
0824+++8FED~            	CP 6
0825+++8FED~            	JR C,OLDPRTM ;Old 3xxx for PT v3.5-
0826+++8FED~            PrSlide	LD DE,#1111
0827+++8FED~            	LD (IX-12+CHP.CrTnSl),E
0828+++8FED~            	LD (IX-12+CHP.CrTnSl+1),D
0829+++8FED~            LoStep	EQU $+1
0830+++8FED~            OLDPRTM	LD A,#3E
0831+++8FED~            	EX AF,AF'
0832+++8FED~            	JR Z,NOSIG
0833+++8FED~            	EX DE,HL
0834+++8FED~            NOSIG	SBC HL,DE
0835+++8FED~            	JP P,SET_STP
0836+++8FED~            	CPL
0837+++8FED~            	EX AF,AF'
0838+++8FED~            	NEG
0839+++8FED~            	EX AF,AF'
0840+++8FED~            SET_STP	LD (IX-12+CHP.TSlStp+1),A
0841+++8FED~            	EX AF,AF'
0842+++8FED~            	LD (IX-12+CHP.TSlStp),A
0843+++8FED~            	LD (IX-12+CHP.COnOff),0
0844+++8FED~            	RET
0845+++8FED~            0846+++8FED~            C_GLISS	SET 2,(IX-12+CHP.Flags)
0847+++8FED~            	LD A,(BC)
0848+++8FED~            	INC BC
0849+++8FED~            	LD (IX-12+CHP.TnSlDl),A
0850+++8FED~            	AND A
0851+++8FED~            	JR NZ,GL36
0852+++8FED~            	LD A,(Version) ;AlCo PT3.7+
0853+++8FED~            	CP 7
0854+++8FED~            	SBC A,A
0855+++8FED~            	INC A
0856+++8FED~            GL36	LD (IX-12+CHP.TSlCnt),A
0857+++8FED~            	LD A,(BC)
0858+++8FED~            	INC BC
0859+++8FED~            	EX AF,AF'
0860+++8FED~            	LD A,(BC)
0861+++8FED~            	INC BC
0862+++8FED~            	JR SET_STP
0863+++8FED~            0864+++8FED~            C_SMPOS	LD A,(BC)
0865+++8FED~            	INC BC
0866+++8FED~            	LD (IX-12+CHP.PsInSm),A
0867+++8FED~            	RET
0868+++8FED~            0869+++8FED~            C_ORPOS	LD A,(BC)
0870+++8FED~            	INC BC
0871+++8FED~            	LD (IX-12+CHP.PsInOr),A
0872+++8FED~            	RET
0873+++8FED~            0874+++8FED~            C_VIBRT	LD A,(BC)
0875+++8FED~            	INC BC
0876+++8FED~            	LD (IX-12+CHP.OnOffD),A
0877+++8FED~            	LD (IX-12+CHP.COnOff),A
0878+++8FED~            	LD A,(BC)
0879+++8FED~            	INC BC
0880+++8FED~            	LD (IX-12+CHP.OffOnD),A
0881+++8FED~            	XOR A
0882+++8FED~            	LD (IX-12+CHP.TSlCnt),A
0883+++8FED~            	LD (IX-12+CHP.CrTnSl),A
0884+++8FED~            	LD (IX-12+CHP.CrTnSl+1),A
0885+++8FED~            	RET
0886+++8FED~            0887+++8FED~            C_ENGLS	LD A,(BC)
0888+++8FED~            	INC BC
0889+++8FED~            	LD (IY-100+VRS.Env_Del),A
0890+++8FED~            	LD (IY-100+VRS.CurEDel),A
0891+++8FED~            	LD A,(BC)
0892+++8FED~            	INC BC
0893+++8FED~            	LD L,A
0894+++8FED~            	LD A,(BC)
0895+++8FED~            	INC BC
0896+++8FED~            	LD H,A
0897+++8FED~            	LD (IY-100+VRS.ESldAdd),L
0898+++8FED~            	LD (IY-100+VRS.ESldAdd+1),H
0899+++8FED~            	RET
0900+++8FED~            0901+++8FED~            C_DELAY	LD A,(BC)
0902+++8FED~            	INC BC
0903+++8FED~            	LD (IY-100+VRS.Delay),A
0904+++8FED~            	LD HL,VARS2+VRS.ModNum ;if AlCo_TS
0905+++8FED~            	BIT 1,(HL)
0906+++8FED~            	RET Z
0907+++8FED~            	LD (VARS1+VRS.Delay),A
0908+++8FED~            	LD (VARS1+VRS.DelyCnt),A
0909+++8FED~            	LD (VARS2+VRS.Delay),A
0910+++8FED~            	RET
0911+++8FED~            	
0912+++8FED~            SETENV	LD (IX-12+CHP.Env_En),E
0913+++8FED~            	LD (IY-100+VRS.AYREGS+EnvTp),A
0914+++8FED~            	LD A,(BC)
0915+++8FED~            	INC BC
0916+++8FED~            	LD H,A
0917+++8FED~            	LD A,(BC)
0918+++8FED~            	INC BC
0919+++8FED~            	LD L,A
0920+++8FED~            	CALL SETENBS
0921+++8FED~            	XOR A
0922+++8FED~            	LD (IX-12+CHP.PsInOr),A
0923+++8FED~            	LD (IY-100+VRS.CurEDel),A
0924+++8FED~            	LD H,A
0925+++8FED~            	LD L,A
0926+++8FED~            	JP SETESLD
0927+++8FED~            0928+++8FED~            SETORN	ADD A,A
0929+++8FED~            	LD E,A
0930+++8FED~            	LD D,0
0931+++8FED~            	LD (IX-12+CHP.PsInOr),D
0932+++8FED~            	LD L,(IY-100+VRS.OrnPtrs)
0933+++8FED~            	LD H,(IY-100+VRS.OrnPtrs+1)
0934+++8FED~            	ADD HL,DE
0935+++8FED~            	LD E,(HL)
0936+++8FED~            	INC HL
0937+++8FED~            	LD D,(HL)
0938+++8FED~            	LD L,(IY-100+VRS.MODADDR)
0939+++8FED~            	LD H,(IY-100+VRS.MODADDR+1)
0940+++8FED~            	ADD HL,DE
0941+++8FED~            	LD (IX-12+CHP.OrnPtr),L
0942+++8FED~            	LD (IX-12+CHP.OrnPtr+1),H
0943+++8FED~            C_NOP	RET
0944+++8FED~            0945+++8FED~            SETSAM	ADD A,A
0946+++8FED~            	LD E,A
0947+++8FED~            	LD D,0
0948+++8FED~            	LD L,(IY-100+VRS.SamPtrs);
0949+++8FED~            	LD H,(IY-100+VRS.SamPtrs+1);
0950+++8FED~            	ADD HL,DE
0951+++8FED~            	LD E,(HL)
0952+++8FED~            	INC HL
0953+++8FED~            	LD D,(HL)
0954+++8FED~            	LD L,(IY-100+VRS.MODADDR)
0955+++8FED~            	LD H,(IY-100+VRS.MODADDR+1)
0956+++8FED~            	ADD HL,DE
0957+++8FED~            	LD (IX-12+CHP.SamPtr),L
0958+++8FED~            	LD (IX-12+CHP.SamPtr+1),H
0959+++8FED~            	RET
0960+++8FED~            0961+++8FED~            ;ALL 16 ADDRESSES TO PROTECT FROM BROKEN PT3 MODULES
0962+++8FED~            SPCCOMS DW C_NOP
0963+++8FED~            	DW C_GLISS
0964+++8FED~            	DW C_PORTM
0965+++8FED~            	DW C_SMPOS
0966+++8FED~            	DW C_ORPOS
0967+++8FED~            	DW C_VIBRT
0968+++8FED~            	DW C_NOP
0969+++8FED~            	DW C_NOP
0970+++8FED~            	DW C_ENGLS
0971+++8FED~            	DW C_DELAY
0972+++8FED~            	DW C_NOP
0973+++8FED~            	DW C_NOP
0974+++8FED~            	DW C_NOP
0975+++8FED~            	DW C_NOP
0976+++8FED~            	DW C_NOP
0977+++8FED~            	DW C_NOP
0978+++8FED~            0979+++8FED~            CHREGS	CALL GETIX
0980+++8FED~            	XOR A
0981+++8FED~            	LD (Ampl),A
0982+++8FED~            	BIT 0,(IX+CHP.Flags)
0983+++8FED~            	PUSH HL
0984+++8FED~            	JP Z,CH_EXIT
0985+++8FED~            	LD (CSP_+1),SP
0986+++8FED~            	LD L,(IX+CHP.OrnPtr)
0987+++8FED~            	LD H,(IX+CHP.OrnPtr+1)
0988+++8FED~            	LD SP,HL
0989+++8FED~            	POP DE
0990+++8FED~            	LD H,A
0991+++8FED~            	LD A,(IX+CHP.PsInOr)
0992+++8FED~            	LD L,A
0993+++8FED~            	ADD HL,SP
0994+++8FED~            	INC A
0995+++8FED~            		;PT2	PT3
0996+++8FED~            OrnCP	INC A	;CP E	CP D
0997+++8FED~            	JR C,CH_ORPS
0998+++8FED~            OrnLD	DB 1	;LD A,D	LD A,E
0999+++8FED~            CH_ORPS	LD (IX+CHP.PsInOr),A
1000+++8FED~            	LD A,(IX+CHP.Note)
1001+++8FED~            	ADD A,(HL)
1002+++8FED~            	JP P,CH_NTP
1003+++8FED~            	XOR A
1004+++8FED~            CH_NTP	CP 96
1005+++8FED~            	JR C,CH_NOK
1006+++8FED~            	LD A,95
1007+++8FED~            CH_NOK	ADD A,A
1008+++8FED~            	EX AF,AF'
1009+++8FED~            	LD L,(IX+CHP.SamPtr)
1010+++8FED~            	LD H,(IX+CHP.SamPtr+1)
1011+++8FED~            	LD SP,HL
1012+++8FED~            	POP DE
1013+++8FED~            	LD H,0
1014+++8FED~            	LD A,(IX+CHP.PsInSm)
1015+++8FED~            	LD B,A
1016+++8FED~            	ADD A,A
1017+++8FED~            SamClc2	ADD A,A ;or ADD A,B for PT2
1018+++8FED~            	LD L,A
1019+++8FED~            	ADD HL,SP
1020+++8FED~            	LD SP,HL
1021+++8FED~            	LD A,B
1022+++8FED~            	INC A
1023+++8FED~            		;PT2	PT3
1024+++8FED~            SamCP	INC A	;CP E	CP D
1025+++8FED~            	JR C,CH_SMPS
1026+++8FED~            SamLD	DB 1	;LD A,D	LD A,E
1027+++8FED~            CH_SMPS	LD (IX+CHP.PsInSm),A
1028+++8FED~            	POP BC
1029+++8FED~            	POP HL
1030+++8FED~            1031+++8FED~            ;Convert PT2 sample to PT3
1032+++8FED~            		;PT2		PT3
1033+++8FED~            SamCnv	POP HL  ;BIT 2,C	JR e_
1034+++8FED~            	POP HL	
1035+++8FED~            	LD H,B
1036+++8FED~            	JR NZ,$+8
1037+++8FED~            	EX DE,HL
1038+++8FED~            	AND A
1039+++8FED~            	SBC HL,HL
1040+++8FED~            	SBC HL,DE
1041+++8FED~            	LD D,C
1042+++8FED~            	RR C
1043+++8FED~            	SBC A,A
1044+++8FED~            	CPL
1045+++8FED~            	AND #3E
1046+++8FED~            	RR C
1047+++8FED~            	RR B
1048+++8FED~            	AND C
1049+++8FED~            	LD C,A
1050+++8FED~            	LD A,B
1051+++8FED~            	RRA
1052+++8FED~            	RRA
1053+++8FED~            	RR D
1054+++8FED~            	RRA
1055+++8FED~            	AND #9F
1056+++8FED~            	LD B,A
1057+++8FED~            1058+++8FED~            e_	LD E,(IX+CHP.TnAcc)
1059+++8FED~            	LD D,(IX+CHP.TnAcc+1)
1060+++8FED~            	ADD HL,DE
1061+++8FED~            	BIT 6,B
1062+++8FED~            	JR Z,CH_NOAC
1063+++8FED~            	LD (IX+CHP.TnAcc),L
1064+++8FED~            	LD (IX+CHP.TnAcc+1),H
1065+++8FED~            CH_NOAC EX DE,HL
1066+++8FED~            	EX AF,AF'
1067+++8FED~            	ADD A,NT_&255
1068+++8FED~            	LD L,A
1069+++8FED~            	ADC A,NT_/256
1070+++8FED~            	SUB L
1071+++8FED~            	LD H,A
1072+++8FED~            	LD SP,HL
1073+++8FED~            	POP HL
1074+++8FED~            	ADD HL,DE
1075+++8FED~            	LD E,(IX+CHP.CrTnSl)
1076+++8FED~            	LD D,(IX+CHP.CrTnSl+1)
1077+++8FED~            	ADD HL,DE
1078+++8FED~            CSP_	LD SP,#3131
1079+++8FED~            	EX (SP),HL
1080+++8FED~            	XOR A
1081+++8FED~            	OR (IX+CHP.TSlCnt)
1082+++8FED~            	JR Z,CH_AMP
1083+++8FED~            	DEC (IX+CHP.TSlCnt)
1084+++8FED~            	JR NZ,CH_AMP
1085+++8FED~            	LD A,(IX+CHP.TnSlDl)
1086+++8FED~            	LD (IX+CHP.TSlCnt),A
1087+++8FED~            	LD L,(IX+CHP.TSlStp)
1088+++8FED~            	LD H,(IX+CHP.TSlStp+1)
1089+++8FED~            	LD A,H
1090+++8FED~            	ADD HL,DE
1091+++8FED~            	LD (IX+CHP.CrTnSl),L
1092+++8FED~            	LD (IX+CHP.CrTnSl+1),H
1093+++8FED~            	BIT 2,(IX+CHP.Flags)
1094+++8FED~            	JR NZ,CH_AMP
1095+++8FED~            	LD E,(IX+CHP.TnDelt)
1096+++8FED~            	LD D,(IX+CHP.TnDelt+1)
1097+++8FED~            	AND A
1098+++8FED~            	JR Z,CH_STPP
1099+++8FED~            	EX DE,HL
1100+++8FED~            CH_STPP SBC HL,DE
1101+++8FED~            	JP M,CH_AMP
1102+++8FED~            	LD A,(IX+CHP.SlToNt)
1103+++8FED~            	LD (IX+CHP.Note),A
1104+++8FED~            	XOR A
1105+++8FED~            	LD (IX+CHP.TSlCnt),A
1106+++8FED~            	LD (IX+CHP.CrTnSl),A
1107+++8FED~            	LD (IX+CHP.CrTnSl+1),A
1108+++8FED~            CH_AMP	LD A,(IX+CHP.CrAmSl)
1109+++8FED~            	BIT 7,C
1110+++8FED~            	JR Z,CH_NOAM
1111+++8FED~            	BIT 6,C
1112+++8FED~            	JR Z,CH_AMIN
1113+++8FED~            	CP 15
1114+++8FED~            	JR Z,CH_NOAM
1115+++8FED~            	INC A
1116+++8FED~            	JR CH_SVAM
1117+++8FED~            CH_AMIN	CP -15
1118+++8FED~            	JR Z,CH_NOAM
1119+++8FED~            	DEC A
1120+++8FED~            CH_SVAM	LD (IX+CHP.CrAmSl),A
1121+++8FED~            CH_NOAM	LD L,A
1122+++8FED~            	LD A,B
1123+++8FED~            	AND 15
1124+++8FED~            	ADD A,L
1125+++8FED~            	JP P,CH_APOS
1126+++8FED~            	XOR A
1127+++8FED~            CH_APOS	CP 16
1128+++8FED~            	JR C,CH_VOL
1129+++8FED~            	LD A,15
1130+++8FED~            CH_VOL	OR (IX+CHP.Volume)
1131+++8FED~            	ADD A,VT_&255
1132+++8FED~            	LD L,A
1133+++8FED~            	ADC A,VT_/256
1134+++8FED~            	SUB L
1135+++8FED~            	LD H,A
1136+++8FED~            	LD A,(HL)
1137+++8FED~            CH_ENV	BIT 0,C
1138+++8FED~            	JR NZ,CH_NOEN
1139+++8FED~            	OR (IX+CHP.Env_En)
1140+++8FED~            CH_NOEN	LD (Ampl),A
1141+++8FED~            	BIT 7,B
1142+++8FED~            	LD A,C
1143+++8FED~            	JR Z,NO_ENSL
1144+++8FED~            	RLA
1145+++8FED~            	RLA
1146+++8FED~            	SRA A
1147+++8FED~            	SRA A
1148+++8FED~            	SRA A
1149+++8FED~            	ADD A,(IX+CHP.CrEnSl) ;SEE COMMENT BELOW
1150+++8FED~            	BIT 5,B
1151+++8FED~            	JR Z,NO_ENAC
1152+++8FED~            	LD (IX+CHP.CrEnSl),A
1153+++8FED~            NO_ENAC	ADD A,(IY-100+VRS.AddToEn) ;BUG IN PT3 - NEED WORD HERE
1154+++8FED~            	LD (IY-100+VRS.AddToEn),A
1155+++8FED~            	JR CH_MIX
1156+++8FED~            NO_ENSL RRA
1157+++8FED~            	ADD A,(IX+CHP.CrNsSl)
1158+++8FED~            	LD (IY-100+VRS.AddToNs),A
1159+++8FED~            	BIT 5,B
1160+++8FED~            	JR Z,CH_MIX
1161+++8FED~            	LD (IX+CHP.CrNsSl),A
1162+++8FED~            CH_MIX	LD A,B
1163+++8FED~            	RRA
1164+++8FED~            	AND #48
1165+++8FED~            CH_EXIT	OR (IY-100+VRS.AYREGS+Mixer)
1166+++8FED~            	RRCA
1167+++8FED~            	LD (IY-100+VRS.AYREGS+Mixer),A
1168+++8FED~            	POP HL
1169+++8FED~            	XOR A
1170+++8FED~            	OR (IX+CHP.COnOff)
1171+++8FED~            	RET Z
1172+++8FED~            	DEC (IX+CHP.COnOff)
1173+++8FED~            	RET NZ
1174+++8FED~            	XOR (IX+CHP.Flags)
1175+++8FED~            	LD (IX+CHP.Flags),A
1176+++8FED~            	RRA
1177+++8FED~            	LD A,(IX+CHP.OnOffD)
1178+++8FED~            	JR C,CH_ONDL
1179+++8FED~            	LD A,(IX+CHP.OffOnD)
1180+++8FED~            CH_ONDL	LD (IX+CHP.COnOff),A
1181+++8FED~            	RET
1182+++8FED~            1183+++8FED~            PLAY_	XOR A
1184+++8FED~            	LD (IY-100+VRS.AddToEn),A
1185+++8FED~            	LD (IY-100+VRS.AYREGS+Mixer),A
1186+++8FED~            	DEC A
1187+++8FED~            	LD (IY-100+VRS.AYREGS+EnvTp),A
1188+++8FED~            	DEC (IY-100+VRS.DelyCnt)
1189+++8FED~            	JP NZ,PL2
1190+++8FED~            	DEC (IY-100+VRS.ChanA+CHP.NtSkCn)
1191+++8FED~            	JR NZ,PL1B
1192+++8FED~            	LD C,(IY-100+VRS.AdInPtA)
1193+++8FED~            	LD B,(IY-100+VRS.AdInPtA+1)
1194+++8FED~            	LD A,(BC)
1195+++8FED~            	AND A
1196+++8FED~            	JR NZ,PL1A
1197+++8FED~            	LD D,A
1198+++8FED~            	LD (IY-100+VRS.Ns_Base),A
1199+++8FED~            	LD L,(IY-100+VRS.CrPsPtr)
1200+++8FED~            	LD H,(IY-100+VRS.CrPsPtr+1)
1201+++8FED~            	INC HL
1202+++8FED~            	LD A,(HL)
1203+++8FED~            	INC A
1204+++8FED~            	JR NZ,PLNLP
1205+++8FED~            1206+++8FED~            	IF LoopChecker
1207+++8FED~            	CALL CHECKLP
1208+++8FED~            	ENDIF
1209+++8FED~            1210+++8FED~            	LD L,(IY-100+VRS.LPosPtr)
1211+++8FED~            	LD H,(IY-100+VRS.LPosPtr+1)
1212+++8FED~            	LD A,(HL)
1213+++8FED~            	INC A
1214+++8FED~            PLNLP	CALL SETCPPT
1215+++8FED~            	DEC A
1216+++8FED~            	BIT 1,(IY-100+VRS.ModNum)
1217+++8FED~            	JR Z,NoAlCo
1218+++8FED~            TSSub	EQU $+1
1219+++8FED~            	SUB #D6
1220+++8FED~            	CPL
1221+++8FED~            NoAlCo
1222+++8FED~            		;PT2		PT3
1223+++8FED~            PsCalc	DEC A	;ADD A,A	NOP
1224+++8FED~            	DEC A	;ADD A,(HL)	NOP
1225+++8FED~            	ADD A,A
1226+++8FED~            	LD E,A
1227+++8FED~            	RL D
1228+++8FED~            1229+++8FED~            	IF CurPosCounter
1230+++8FED~            	LD A,L
1231+++8FED~            	SUB (IY-100+VRS.PosSub)
1232+++8FED~            	LD (IY-100+VRS.CurPos),A
1233+++8FED~            	ENDIF
1234+++8FED~            1235+++8FED~            	LD L,(IY-100+VRS.PatsPtr)
1236+++8FED~            	LD H,(IY-100+VRS.PatsPtr+1)
1237+++8FED~            	ADD HL,DE
1238+++8FED~            	LD E,(IY-100+VRS.MODADDR)
1239+++8FED~            	LD D,(IY-100+VRS.MODADDR+1)
1240+++8FED~            	LD (PSP_+1),SP
1241+++8FED~            	LD SP,HL
1242+++8FED~            	POP HL
1243+++8FED~            	ADD HL,DE
1244+++8FED~            	LD B,H
1245+++8FED~            	LD C,L
1246+++8FED~            	POP HL
1247+++8FED~            	ADD HL,DE
1248+++8FED~            	LD (IY-100+VRS.AdInPtB),L
1249+++8FED~            	LD (IY-100+VRS.AdInPtB+1),H
1250+++8FED~            	POP HL
1251+++8FED~            	ADD HL,DE
1252+++8FED~            	LD (IY-100+VRS.AdInPtC),L
1253+++8FED~            	LD (IY-100+VRS.AdInPtC+1),H
1254+++8FED~            PSP_	LD SP,#3131
1255+++8FED~            PL1A	LD DE,VRS.ChanA+12-100
1256+++8FED~            	CALL PTDECOD
1257+++8FED~            	LD (IY-100+VRS.AdInPtA),C
1258+++8FED~            	LD (IY-100+VRS.AdInPtA+1),B
1259+++8FED~            1260+++8FED~            PL1B	DEC (IY-100+VRS.ChanB+CHP.NtSkCn)
1261+++8FED~            	JR NZ,PL1C
1262+++8FED~            	LD DE,VRS.ChanB+12-100
1263+++8FED~            	LD C,(IY-100+VRS.AdInPtB)
1264+++8FED~            	LD B,(IY-100+VRS.AdInPtB+1)
1265+++8FED~            	CALL PTDECOD
1266+++8FED~            	LD (IY-100+VRS.AdInPtB),C
1267+++8FED~            	LD (IY-100+VRS.AdInPtB+1),B
1268+++8FED~            1269+++8FED~            PL1C	DEC (IY-100+VRS.ChanC+CHP.NtSkCn)
1270+++8FED~            	JR NZ,PL1D
1271+++8FED~            	LD DE,VRS.ChanC+12-100
1272+++8FED~            	LD C,(IY-100+VRS.AdInPtC)
1273+++8FED~            	LD B,(IY-100+VRS.AdInPtC+1)
1274+++8FED~            	CALL PTDECOD
1275+++8FED~            	LD (IY-100+VRS.AdInPtC),C
1276+++8FED~            	LD (IY-100+VRS.AdInPtC+1),B
1277+++8FED~            1278+++8FED~            PL1D	LD A,(IY-100+VRS.Delay)
1279+++8FED~            	LD (IY-100+VRS.DelyCnt),A
1280+++8FED~            1281+++8FED~            PL2	LD DE,VRS.ChanA-100
1282+++8FED~            	LD L,(IY-100+VRS.AYREGS+TonA)
1283+++8FED~            	LD H,(IY-100+VRS.AYREGS+TonA+1)
1284+++8FED~            	CALL CHREGS
1285+++8FED~            	LD (IY-100+VRS.AYREGS+TonA),L
1286+++8FED~            	LD (IY-100+VRS.AYREGS+TonA+1),H
1287+++8FED~            Ampl	EQU $+1
1288+++8FED~            	LD A,#3E
1289+++8FED~            	LD (IY-100+VRS.AYREGS+AmplA),A
1290+++8FED~            	LD DE,VRS.ChanB-100
1291+++8FED~            	LD L,(IY-100+VRS.AYREGS+TonB)
1292+++8FED~            	LD H,(IY-100+VRS.AYREGS+TonB+1)
1293+++8FED~            	CALL CHREGS
1294+++8FED~            	LD (IY-100+VRS.AYREGS+TonB),L
1295+++8FED~            	LD (IY-100+VRS.AYREGS+TonB+1),H
1296+++8FED~            	LD A,(Ampl)
1297+++8FED~            	LD (IY-100+VRS.AYREGS+AmplB),A
1298+++8FED~            	LD DE,VRS.ChanC-100
1299+++8FED~            	LD L,(IY-100+VRS.AYREGS+TonC)
1300+++8FED~            	LD H,(IY-100+VRS.AYREGS+TonC+1)
1301+++8FED~            	CALL CHREGS
1302+++8FED~            	LD (IY-100+VRS.AYREGS+TonC),L
1303+++8FED~            	LD (IY-100+VRS.AYREGS+TonC+1),H
1304+++8FED~            	LD A,(Ampl)
1305+++8FED~            	LD (IY-100+VRS.AYREGS+AmplC),A
1306+++8FED~            1307+++8FED~            	LD A,(IY-100+VRS.Ns_Base)
1308+++8FED~            	ADD (IY-100+VRS.AddToNs)
1309+++8FED~            	LD (IY-100+VRS.AYREGS+Noise),A
1310+++8FED~            1311+++8FED~            	LD A,(IY-100+VRS.AddToEn)
1312+++8FED~            	LD E,A
1313+++8FED~            	ADD A,A
1314+++8FED~            	SBC A,A
1315+++8FED~            	LD D,A
1316+++8FED~            	LD L,(IY-100+VRS.EnvBase)
1317+++8FED~            	LD H,(IY-100+VRS.EnvBase+1)
1318+++8FED~            	ADD HL,DE
1319+++8FED~            	LD E,(IY-100+VRS.CurESld)
1320+++8FED~            	LD D,(IY-100+VRS.CurESld+1)
1321+++8FED~            	ADD HL,DE
1322+++8FED~            	LD (IY-100+VRS.AYREGS+Env),L
1323+++8FED~            	LD (IY-100+VRS.AYREGS+Env+1),H
1324+++8FED~            1325+++8FED~            	XOR A
1326+++8FED~            	OR (IY-100+VRS.CurEDel)
1327+++8FED~            	RET Z
1328+++8FED~            	DEC (IY-100+VRS.CurEDel)
1329+++8FED~            	RET NZ
1330+++8FED~            	LD A,(IY-100+VRS.Env_Del)
1331+++8FED~            	LD (IY-100+VRS.CurEDel),A
1332+++8FED~            	LD L,(IY-100+VRS.ESldAdd)
1333+++8FED~            	LD H,(IY-100+VRS.ESldAdd+1)
1334+++8FED~            	ADD HL,DE
1335+++8FED~            	JP SETESLD
1336+++8FED~            1337+++8FED~            PLAY    LD IY,VARS1+100
1338+++8FED~            	CALL PLAY_
1339+++8FED~            	LD A,(is_ts)
1340+++8FED~            	AND A
1341+++8FED~            	JR Z,PL_nts
1342+++8FED~            	LD IY,VARS2+100
1343+++8FED~            	CALL PLAY_
1344+++8FED~            PL_nts
1345+++8FED~            	IF Basic
1346+++8FED~            	LD IY,#5C3A
1347+++8FED~            	ENDIF
1348+++8FED~            1349+++8FED~            ROUT	LD BC,#FFFD
1350+++8FED~              IFDEF ONtfm
1351+++8FED~                LD L,#F9
1352+++8FED~                OUT (C),L
1353+++8FED~              ELSE
1354+++8FED~            	LD A,(is_ts)
1355+++8FED~            	AND A
1356+++8FED~            	JR Z,r_nts ;keep old standard
1357+++8FED~            	OUT (C),B
1358+++8FED~                ENDIF
1359+++8FED~            r_nts	EX AF,AF'
1360+++8FED~            1361+++8FED~            	IF ACBBAC
1362+++8FED~            	LD IX,VARS1+VRS.AYREGS
1363+++8FED~            	ELSE
1364+++8FED~            	LD HL,VARS1+VRS.AYREGS
1365+++8FED~            	ENDIF
1366+++8FED~            1367+++8FED~            	CALL ROUT_
1368+++8FED~            	EX AF,AF'
1369+++8FED~            	RET Z
1370+++8FED~            	LD B,D
1371+++8FED~            1372+++8FED~                IFDEF ONtfm
1373+++8FED~                LD A,#F8
1374+++8FED~                ELSE
1375+++8FED~            	CPL
1376+++8FED~                ENDIF
1377+++8FED~            	OUT (C),A
1378+++8FED~            1379+++8FED~            	IF ACBBAC
1380+++8FED~            	LD IX,VARS2+VRS.AYREGS
1381+++8FED~            	ELSE
1382+++8FED~            	LD HL,VARS2+VRS.AYREGS
1383+++8FED~            	ENDIF
1384+++8FED~            1385+++8FED~            ROUT_
1386+++8FED~            	IF ACBBAC
1387+++8FED~            	LD A,(SETUP)
1388+++8FED~            	AND 12
1389+++8FED~            	JR Z,ABC
1390+++8FED~            	ADD A,CHTABLE
1391+++8FED~            	LD E,A
1392+++8FED~            	ADC A,CHTABLE/256
1393+++8FED~            	SUB E
1394+++8FED~            	LD D,A
1395+++8FED~            	LD B,0
1396+++8FED~            	PUSH IX
1397+++8FED~            	POP HL
1398+++8FED~            	LD A,(DE)
1399+++8FED~            	INC DE
1400+++8FED~            	LD C,A
1401+++8FED~            	ADD HL,BC
1402+++8FED~            	LD A,(IX+TonB)
1403+++8FED~            	LD C,(HL)
1404+++8FED~            	LD (IX+TonB),C
1405+++8FED~            	LD (HL),A
1406+++8FED~            	INC HL
1407+++8FED~            	LD A,(IX+TonB+1)
1408+++8FED~            	LD C,(HL)
1409+++8FED~            	LD (IX+TonB+1),C
1410+++8FED~            	LD (HL),A
1411+++8FED~            	LD A,(DE)
1412+++8FED~            	INC DE
1413+++8FED~            	LD C,A
1414+++8FED~            	ADD HL,BC
1415+++8FED~            	LD A,(IX+AmplB)
1416+++8FED~            	LD C,(HL)
1417+++8FED~            	LD (IX+AmplB),C
1418+++8FED~            	LD (HL),A
1419+++8FED~            	LD A,(DE)
1420+++8FED~            	INC DE
1421+++8FED~            	LD (RxCA1),A
1422+++8FED~            	XOR 8
1423+++8FED~            	LD (RxCA2),A
1424+++8FED~            	LD A,(DE)
1425+++8FED~            	AND (IX+Mixer)
1426+++8FED~            	LD E,A
1427+++8FED~            	LD A,(IX+Mixer)
1428+++8FED~            RxCA1	DB #E6
1429+++8FED~            	AND %010010
1430+++8FED~            	OR E
1431+++8FED~            	LD E,A
1432+++8FED~            	LD A,(IX+Mixer)
1433+++8FED~            	AND %010010
1434+++8FED~            RxCA2	OR E
1435+++8FED~            	OR E
1436+++8FED~            	LD (IX+Mixer),A
1437+++8FED~            ABC
1438+++8FED~            	ENDIF
1439+++8FED~            1440+++8FED~            	XOR A
1441+++8FED~            	LD DE,#FFBF
1442+++8FED~            1443+++8FED~            	IF ACBBAC
1444+++8FED~            	LD BC,#FFFD
1445+++8FED~            	PUSH IX
1446+++8FED~            	POP HL
1447+++8FED~            	ENDIF
1448+++8FED~            1449+++8FED~            LOUT
1450+++8FED~                IFDEF ONtfm
1451+++8FED~                INF 
1452+++8FED~                JP M,$-2
1453+++8FED~                ENDIF 
1454+++8FED~                OUT (C),A
1455+++8FED~                IFDEF ONtfm
1456+++8FED~                INF 
1457+++8FED~                JP M,$-2
1458+++8FED~                ENDIF 
1459+++8FED~            	LD B,E
1460+++8FED~            	OUTI 
1461+++8FED~            	LD B,D
1462+++8FED~            	INC A
1463+++8FED~            	CP 13
1464+++8FED~            	JR NZ,LOUT
1465+++8FED~                IFDEF ONtfm
1466+++8FED~                INF 
1467+++8FED~                JP M,$-2
1468+++8FED~                ENDIF 
1469+++8FED~            	OUT (C),A
1470+++8FED~            	LD A,(HL)
1471+++8FED~            	AND A
1472+++8FED~            	RET M
1473+++8FED~                IFDEF ONtfm
1474+++8FED~                INF 
1475+++8FED~                JP M,$-2
1476+++8FED~                ENDIF 
1477+++8FED~            	LD B,E
1478+++8FED~            	OUT (C),A
1479+++8FED~            	RET
1480+++8FED~            1481+++8FED~            	IF ACBBAC
1482+++8FED~            CHTABLE	EQU $-4
1483+++8FED~            	DB 4,5,15,%001001,0,7,7,%100100
1484+++8FED~            	ENDIF
1485+++8FED~            1486+++8FED~            NT_DATA	DB (T_NEW_0-T1_)*2
1487+++8FED~            	DB TCNEW_0-T_
1488+++8FED~            	DB (T_OLD_0-T1_)*2+1
1489+++8FED~            	DB TCOLD_0-T_
1490+++8FED~            	DB (T_NEW_1-T1_)*2+1
1491+++8FED~            	DB TCNEW_1-T_
1492+++8FED~            	DB (T_OLD_1-T1_)*2+1
1493+++8FED~            	DB TCOLD_1-T_
1494+++8FED~            	DB (T_NEW_2-T1_)*2
1495+++8FED~            	DB TCNEW_2-T_
1496+++8FED~            	DB (T_OLD_2-T1_)*2
1497+++8FED~            	DB TCOLD_2-T_
1498+++8FED~            	DB (T_NEW_3-T1_)*2
1499+++8FED~            	DB TCNEW_3-T_
1500+++8FED~            	DB (T_OLD_3-T1_)*2
1501+++8FED~            	DB TCOLD_3-T_
1502+++8FED~            1503+++8FED~            T_
1504+++8FED~            1505+++8FED~            TCOLD_0	DB #00+1,#04+1,#08+1,#0A+1,#0C+1,#0E+1,#12+1,#14+1
1506+++8FED~            	DB #18+1,#24+1,#3C+1,0
1507+++8FED~            TCOLD_1	DB #5C+1,0
1508+++8FED~            TCOLD_2	DB #30+1,#36+1,#4C+1,#52+1,#5E+1,#70+1,#82,#8C,#9C
1509+++8FED~            	DB #9E,#A0,#A6,#A8,#AA,#AC,#AE,#AE,0
1510+++8FED~            TCNEW_3	DB #56+1
1511+++8FED~            TCOLD_3	DB #1E+1,#22+1,#24+1,#28+1,#2C+1,#2E+1,#32+1,#BE+1,0
1512+++8FED~            TCNEW_0	DB #1C+1,#20+1,#22+1,#26+1,#2A+1,#2C+1,#30+1,#54+1
1513+++8FED~            	DB #BC+1,#BE+1,0
1514+++8FED~            TCNEW_1 EQU TCOLD_1
1515+++8FED~            TCNEW_2	DB #1A+1,#20+1,#24+1,#28+1,#2A+1,#3A+1,#4C+1,#5E+1
1516+++8FED~            	DB #BA+1,#BC+1,#BE+1,0
1517+++8FED~            1518+++8FED~            PT3EMPTYORN EQU $-1
1519+++8FED~            	DB 1,0
1520+++8FED~            1521+++8FED~            ;first 12 values of tone tables (packed)
1522+++8FED~            1523+++8FED~            T_PACK	DB #06EC*2/256,#06EC*2&255
1524+++8FED~            	DB #0755-#06EC
1525+++8FED~            	DB #07C5-#0755
1526+++8FED~            	DB #083B-#07C5
1527+++8FED~            	DB #08B8-#083B
1528+++8FED~            	DB #093D-#08B8
1529+++8FED~            	DB #09CA-#093D
1530+++8FED~            	DB #0A5F-#09CA
1531+++8FED~            	DB #0AFC-#0A5F
1532+++8FED~            	DB #0BA4-#0AFC
1533+++8FED~            	DB #0C55-#0BA4
1534+++8FED~            	DB #0D10-#0C55
1535+++8FED~            	DB #066D*2/256,#066D*2&255
1536+++8FED~            	DB #06CF-#066D
1537+++8FED~            	DB #0737-#06CF
1538+++8FED~            	DB #07A4-#0737
1539+++8FED~            	DB #0819-#07A4
1540+++8FED~            	DB #0894-#0819
1541+++8FED~            	DB #0917-#0894
1542+++8FED~            	DB #09A1-#0917
1543+++8FED~            	DB #0A33-#09A1
1544+++8FED~            	DB #0ACF-#0A33
1545+++8FED~            	DB #0B73-#0ACF
1546+++8FED~            	DB #0C22-#0B73
1547+++8FED~            	DB #0CDA-#0C22
1548+++8FED~            	DB #0704*2/256,#0704*2&255
1549+++8FED~            	DB #076E-#0704
1550+++8FED~            	DB #07E0-#076E
1551+++8FED~            	DB #0858-#07E0
1552+++8FED~            	DB #08D6-#0858
1553+++8FED~            	DB #095C-#08D6
1554+++8FED~            	DB #09EC-#095C
1555+++8FED~            	DB #0A82-#09EC
1556+++8FED~            	DB #0B22-#0A82
1557+++8FED~            	DB #0BCC-#0B22
1558+++8FED~            	DB #0C80-#0BCC
1559+++8FED~            	DB #0D3E-#0C80
1560+++8FED~            	DB #07E0*2/256,#07E0*2&255
1561+++8FED~            	DB #0858-#07E0
1562+++8FED~            	DB #08E0-#0858
1563+++8FED~            	DB #0960-#08E0
1564+++8FED~            	DB #09F0-#0960
1565+++8FED~            	DB #0A88-#09F0
1566+++8FED~            	DB #0B28-#0A88
1567+++8FED~            	DB #0BD8-#0B28
1568+++8FED~            	DB #0C80-#0BD8
1569+++8FED~            	DB #0D60-#0C80
1570+++8FED~            	DB #0E10-#0D60
1571+++8FED~            	DB #0EF8-#0E10
1572+++8FED~            1573+++8FED~            ;vars from here can be stripped
1574+++8FED~            ;you can move VARS to any other address
1575+++8FED~            1576+++8FED~            VARS
1577+++8FED~            1578+++8FED~            is_ts	DB 0
1579+++8FED~            1580+++8FED~            ;ChannelsVars
1581+++8FED~            	STRUCT	CHP
1582+++8FED~            ;reset group
1583+++8FED~            PsInOr	DB 0
1584+++8FED~            PsInSm	DB 0
1585+++8FED~            CrAmSl	DB 0
1586+++8FED~            CrNsSl	DB 0
1587+++8FED~            CrEnSl	DB 0
1588+++8FED~            TSlCnt	DB 0
1589+++8FED~            CrTnSl	DW 0
1590+++8FED~            TnAcc	DW 0
1591+++8FED~            COnOff	DB 0
1592+++8FED~            ;reset group
1593+++8FED~            1594+++8FED~            OnOffD	DB 0
1595+++8FED~            1596+++8FED~            ;IX for PTDECOD here (+12)
1597+++8FED~            OffOnD	DB 0
1598+++8FED~            OrnPtr	DW 0
1599+++8FED~            SamPtr	DW 0
1600+++8FED~            NNtSkp	DB 0
1601+++8FED~            Note	DB 0
1602+++8FED~            SlToNt	DB 0
1603+++8FED~            Env_En	DB 0
1604+++8FED~            Flags	DB 0
1605+++8FED~             ;Enabled - 0, SimpleGliss - 2
1606+++8FED~            TnSlDl	DB 0
1607+++8FED~            TSlStp	DW 0
1608+++8FED~            TnDelt	DW 0
1609+++8FED~            NtSkCn	DB 0
1610+++8FED~            Volume	DB 0
1611+++8FED~            	ENDS
1612+++8FED~            1613+++8FED~            	STRUCT	VRS
1614+++8FED~            1615+++8FED~            ;IF not works in STRUCT in SjASM :(
1616+++8FED~            ;	IF CurPosCounter
1617+++8FED~            CurPos	DB 0
1618+++8FED~            PosSub	DB 0
1619+++8FED~            ;	ENDIF
1620+++8FED~            1621+++8FED~            ModNum	DB 0 ;bit0: ChipNum
1622+++8FED~            	     ;bit1: 1-reversed patterns order (AlCo TS)
1623+++8FED~            1624+++8FED~            ChanA	DS CHP
1625+++8FED~            ChanB	DS CHP
1626+++8FED~            ChanC	DS CHP
1627+++8FED~            1628+++8FED~            ;GlobalVars
1629+++8FED~            MODADDR	DW 0
1630+++8FED~            OrnPtrs	DW 0
1631+++8FED~            SamPtrs	DW 0
1632+++8FED~            PatsPtr	DW 0
1633+++8FED~            AdInPtA	DW 0
1634+++8FED~            AdInPtB	DW 0
1635+++8FED~            AdInPtC	DW 0
1636+++8FED~            CrPsPtr	DW 0
1637+++8FED~            LPosPtr	DW 0
1638+++8FED~            Delay	DB 0
1639+++8FED~            DelyCnt	DB 0
1640+++8FED~            ESldAdd	DW 0
1641+++8FED~            CurESld	DW 0
1642+++8FED~            Env_Del	DB 0
1643+++8FED~            CurEDel	DB 0
1644+++8FED~            Ns_Base	DB 0
1645+++8FED~            AddToNs	DB 0
1646+++8FED~            AddToEn	DB 0
1647+++8FED~            EnvBase	DW 0
1648+++8FED~            AYREGS	DS 14
1649+++8FED~            	ENDS
1650+++8FED~            1651+++8FED~            VARS1	DS VRS
1652+++8FED~            VARS2	DS VRS
1653+++8FED~            1654+++8FED~            VT_	EQU $-16
1655+++8FED~            	DS 256-16 ;CreatedVolumeTableAddress
1656+++8FED~            1657+++8FED~            T1_	EQU VT_+16 ;Tone tables data depacked here
1658+++8FED~            1659+++8FED~            T_OLD_1	EQU T1_
1660+++8FED~            T_OLD_2	EQU T_OLD_1+24
1661+++8FED~            T_OLD_3	EQU T_OLD_2+24
1662+++8FED~            T_OLD_0	EQU T_OLD_3+2
1663+++8FED~            T_NEW_0	EQU T_OLD_0
1664+++8FED~            T_NEW_1	EQU T_OLD_1
1665+++8FED~            T_NEW_2	EQU T_NEW_0+24
1666+++8FED~            T_NEW_3	EQU T_OLD_3
1667+++8FED~            1668+++8FED~            PT2EMPTYORN EQU VT_+31 ;1,0,0 sequence
1669+++8FED~            1670+++8FED~            NT_	DS 192 ;CreatedNoteTableAddress
1671+++8FED~            1672+++8FED~            VAR0END	EQU VT_+16 ;INIT zeroes from VARS to VAR0END-1
1673+++8FED~            1674+++8FED~            VARSEND EQU $
1675+++8FED~            MDLADDR EQU $
1676+++8FED~            1677+++8FED~                   DISPLAY "PTS player size=",$-START
1678+++8FED~            1679+++8FED~            ;Release 0 steps:
1680+++8FED~            ;04/21/2007
1681+++8FED~            ;Works start (PTxPlay adaptation); first beta.
1682+++8FED~            ;04/22/2007
1683+++8FED~            ;Job finished; beta-testing.
1684+++8FED~            ;04/23/2007
1685+++8FED~            ;PT v3.7 TS mode corrected (after AlCo remarks).
1686+++8FED~            ;04/29/2007
1687+++8FED~            ;Added 1.XX and 2.XX special commands interpretation for PT3
1688+++8FED~            ;modules of v3.7+.
1689+++8FED~            1690+++8FED~            ;Size (minimal build for ZX Spectrum):
1691+++8FED~            ;Code block #908 bytes
1692+++8FED~            ;Variables #2BF bytes (can be stripped)
1693+++8FED~            ;Total size #908+#2BF=#BC7 (3015) bytes
1694+++8FED~            1695+++8FED~                   ENDMOD
1696+++8FED~            1697+++8FED                    endif
1698+++8FED             
0095+++8FED             
0096+++8FED             TS.End    
0097+++8FED             TS.Play=PTS.PLAY
0098+++8FED             TS.Mute=PTS.MUTE        
0099+++8FED             
0100+++8FED                     display "TS module size: ",TS.End-TS.Start
0101+++8FED             
0102+++8FED                     endif
0103+++8FED             
0416++ 8FED                     include "tfc.asm"
0001+++8FED                     ifndef _tfc_asm_defined
0002+++8FED                     define _tfc_asm_defined
0003+++8FED             
0004+++8FED                     module TFC
0005+++8FED                     
0006+++8FED             ; Original version by (C) Alone Coder
0007+++8FED             ; SjasmPlus adaptation, code cleanup and size optimization by (C) Vitamin/CAIG
0008+++8FED             
0009+++8FED             ; Warning: no 60Hz modules support!
0010+++8FED                     
0011+++8FED             ;TODO begin&end    
0012+++8FED             newtfm=1 ;0=revision A, 1=revision C
0013+++8FED             
0014+++8FED                     if newtfm == 1
0015+++8FED             statuschip0=%11111000
0016+++8FED             statuschip1=%11111001
0017+++8FED                     else
0018+++8FED~                    if newtfm == 2 ;US031DX
0019+++8FED~            statuschip0=%11111110
0020+++8FED~            statuschip1=%11111111
0021+++8FED~                    else ;newtfm=0
0022+++8FED~            statuschip0=%11111100
0023+++8FED~            statuschip1=%11111101
0024+++8FED~                    endif
0025+++8FED                     endif 
0026+++8FED                    
0027+++8FED                     struct Header
0028+++8FED~            signature
0029+++8FED~                    ds 6
0030+++8FED~            version ds 3        
0031+++8FED~            intfreq db 0
0032+++8FED~            tfmptrs ds 12
0033+++8FED~            ssgptrs ds 12
0034+++8FED                     ends
0035+++8FED             
0036+++8FED                     struct TFMData
0037+++8FED~            addr    dw 0
0038+++8FED~            skip    db 0
0039+++8FED~            blkcnt  db 0
0040+++8FED~            blkretaddr
0041+++8FED~                    db 0
0042+++8FED~            loopaddr
0043+++8FED~                    db 0        
0044+++8FED~            tfmlow  db 0
0045+++8FED~            tfmhigh db 0        
0046+++8FED                     ends
0047+++8FED                     
0048+++8FED                     macro WaitStatus
0049+++8FED~                    if newtfm != 2
0050+++8FED~                    inf
0051+++8FED~                    jp m,$-2
0052+++8FED~                    endif 
0053+++8FED                     endm
0054+++8FED                     
0055+++8FED                     macro FM.OutReg Reg
0056+++8FED~                    WaitStatus
0057+++8FED~                    out (c),Reg
0058+++8FED                     endm
0059+++8FED             
0060+++8FED                     macro FM.SelectReg Reg
0061+++8FED~                    ld b,d
0062+++8FED~                    FM.OutReg Reg
0063+++8FED                     endm
0064+++8FED                     
0065+++8FED                     macro FM.WriteReg Reg
0066+++8FED~                    ld b,e
0067+++8FED~                    FM.OutReg Reg
0068+++8FED                     endm
0069+++8FED             
0070+++8FED             Start
0071+++8FED 21 66 92            ld hl,End
0072+++8FF0 18 2F               jr Init
0073+++8FF2 C3 D4 90            jp Play
0074+++8FF5 C3 5D 90            jp Mute
0075+++8FF8             
0076+++8FF8                     ifdef HaveFormatCheck
0077+++8FF8                     include "format.asm"
0001+++8FF8             ;some format checking macros
0002+++8FF8                     ifndef _format_asm_defined
0003+++8FF8~                    define _format_asm_defined
0004+++8FF8~            0005+++8FF8~                    macro LessOrEqual number
0006+++8FF8~                    ld a,number
0007+++8FF8~                    cp (hl)
0008+++8FF8~                    inc hl
0009+++8FF8~                    ret c
0010+++8FF8~                    endm
0011+++8FF8~                    
0012+++8FF8~                    macro Greater number
0013+++8FF8~                    ld a,(hl)
0014+++8FF8~                    inc hl
0015+++8FF8~                    cp number
0016+++8FF8~                    ret c
0017+++8FF8~                    endm
0018+++8FF8~                    
0019+++8FF8~                    macro AnyByte
0020+++8FF8~                    inc hl
0021+++8FF8~                    endm
0022+++8FF8~                    
0023+++8FF8~                    macro AnyBytes count
0024+++8FF8~                    if count > 7
0025+++8FF8~                    ld a,l
0026+++8FF8~                    add a,count
0027+++8FF8~                    ld l,a
0028+++8FF8~                    adc a,h
0029+++8FF8~                    sub l
0030+++8FF8~                    ld h,a
0031+++8FF8~                    else
0032+++8FF8~                    dup count
0033+++8FF8~                    inc hl
0034+++8FF8~                    edup
0035+++8FF8~                    endif
0036+++8FF8~                    endm
0037+++8FF8~                    
0038+++8FF8~                    macro EqualTo number
0039+++8FF8~                    ld a,number
0040+++8FF8~                    cp (hl)
0041+++8FF8~                    inc hl
0042+++8FF8~                    ret nz
0043+++8FF8~                    endm
0044+++8FF8~            0045+++8FF8                     endif
0046+++8FF8             
0078+++8FF8                     
0079+++8FF8             ;in HL - module addr
0080+++8FF8             ;out Z - is tfc
0081+++8FF8             ;out C - 60 Hz (valid only if Z)
0082+++8FF8             CheckFormat
0083+++8FF8                     EqualTo "T"
0083+++8FF8 3E 54       >        ld a,number
0083+++8FFA BE          >        cp (hl)
0083+++8FFB 23          >        inc hl
0083+++8FFC C0          >        ret nz
0084+++8FFD                     EqualTo "F"
0084+++8FFD 3E 46       >        ld a,number
0084+++8FFF BE          >        cp (hl)
0084+++9000 23          >        inc hl
0084+++9001 C0          >        ret nz
0085+++9002                     EqualTo "M"
0085+++9002 3E 4D       >        ld a,number
0085+++9004 BE          >        cp (hl)
0085+++9005 23          >        inc hl
0085+++9006 C0          >        ret nz
0086+++9007                     EqualTo "c"
0086+++9007 3E 63       >        ld a,number
0086+++9009 BE          >        cp (hl)
0086+++900A 23          >        inc hl
0086+++900B C0          >        ret nz
0087+++900C                     EqualTo "o"
0087+++900C 3E 6F       >        ld a,number
0087+++900E BE          >        cp (hl)
0087+++900F 23          >        inc hl
0087+++9010 C0          >        ret nz
0088+++9011                     EqualTo "m"
0088+++9011 3E 6D       >        ld a,number
0088+++9013 BE          >        cp (hl)
0088+++9014 23          >        inc hl
0088+++9015 C0          >        ret nz
0089+++9016                     AnyBytes 3
0090+++9016 23          >        inc hl
0090+++9017 23          >        inc hl
0090+++9018 23          >        inc hl
0090+++9019 7E                  ld a,(hl)
0091+++901A FE 32               cp 50
0092+++901C C8                  ret z
0093+++901D FE 3C               cp 60
0094+++901F 3F                  ccf
0095+++9020 C9                  ret
0096+++9021                     
0097+++9021                     display "TFC checker size: ",$-CheckFormat
0098+++9021                     endif
0099+++9021                     
0100+++9021             ;HL - module addr
0101+++9021             Init
0102+++9021 EB                  exd
0103+++9022 21 0A 00            ld hl,Header.tfmptrs
0104+++9025 19                  add hl,de
0105+++9026 D9                  exx 
0106+++9027             
0107+++9027 21 2E 92            ld hl,TFM.Init
0108+++902A 11 36 92            ld de,TFM.A
0109+++902D 01 30 00            ld bc,6*TFMData
0110+++9030 ED B0               ldir
0111+++9032             
0112+++9032 21 51 90            ld hl,.tfminitab
0113+++9035 01 FD 06            ld bc,128*(.tfminitab_end-.tfminitab)+#fd
0114+++9038             .tfmini0
0115+++9038 11 47 90            ld de,.tfminiHL
0116+++903B ED A0               ldi 
0117+++903D ED A0               ldi 
0118+++903F D9                  exx 
0119+++9040 7E                  ld a,(hl)
0120+++9041 23                  inc hl
0121+++9042 E5                  push hl
0122+++9043 66                  ld h,(hl)
0123+++9044 6F                  ld l,a
0124+++9045 19                  add hl,de
0125+++9046             .tfminiHL=$+1
0126+++9046 22 00 00            ld (0),hl
0127+++9049 E1                  pop hl
0128+++904A 23                  inc hl
0129+++904B D9                  exx 
0130+++904C 10 EA               djnz .tfmini0
0131+++904E             
0132+++904E C3 5D 90            jp Mute
0133+++9051                     
0134+++9051             .tfminitab
0135+++9051 36 92               DW TFM.A.addr
0136+++9053 3E 92               DW TFM.B.addr
0137+++9055 46 92               DW TFM.C.addr
0138+++9057 4E 92               DW TFM.D.addr
0139+++9059 56 92               DW TFM.E.addr
0140+++905B 5E 92               DW TFM.F.addr
0141+++905D             .tfminitab_end       
0142+++905D             
0143+++905D             Mute
0144+++905D 11 BF FF            ld de,#ffbf
0145+++9060 0E FD               ld c,#fd
0146+++9062 CD CC 90            call selChip0
0147+++9065 CD 6B 90            call .tfminiPP
0148+++9068 CD D0 90            call selChip1
0149+++906B             .tfminiPP
0150+++906B                     ; 0 -> (00..0D)
0151+++906B 21 00 00            ld hl,#0000
0152+++906E 3E 0E               ld a,#0e
0153+++9070 CD B3 90            call .writeregsset
0154+++9073                     
0155+++9073                     ; 0 -> (30..3F)
0156+++9073 26 30               ld h,#30
0157+++9075 3E 40               ld a,#40
0158+++9077 CD B3 90            call .writeregsset
0159+++907A                     
0160+++907A                     ; 0 -> (50..B4)
0161+++907A 26 50               ld h,#50
0162+++907C 3E B5               ld a,#b5
0163+++907E CD B3 90            call .writeregsset
0164+++9081                     
0165+++9081                     ; 0F -> (80..8F) ;max speed to RR
0166+++9081 21 0F 80            ld hl,#800f
0167+++9084 3E 90               ld a,#90
0168+++9086 CD B3 90            call .writeregsset
0169+++9089                     
0170+++9089                     ; 0..2 -> 28, key off
0171+++9089                     ; 2 -> 27 channel 3 mode
0172+++9089 21 00 28            ld hl,#2800
0173+++908C CD BB 90            call .writereg
0174+++908F 2C                  inc l
0175+++9090 CD BB 90            call .writereg
0176+++9093 2C                  inc l
0177+++9094 CD BB 90            call .writereg
0178+++9097 25                  dec h
0179+++9098 CD BB 90            call .writereg
0180+++909B                     
0181+++909B                     ; 7F -> (40..4F,2F,2D)
0182+++909B 21 7F 40            ld hl,#407f
0183+++909E 3E 50               ld a,#50
0184+++90A0 CD B3 90            call .writeregsset
0185+++90A3                     
0186+++90A3 26 2F               ld h,#2f
0187+++90A5 CD BB 90            call .writereg
0188+++90A8                     
0189+++90A8 26 2D               ld h,#2d
0190+++90AA CD BB 90            call .writereg
0191+++90AD             
0192+++90AD 3E FF               ld a,#ff ;. FM
0193+++90AF             .selRegA
0194+++90AF 42                  ld b,d
0195+++90B0 ED 79               out (c),a
0196+++90B2 C9                  ret
0197+++90B3             
0198+++90B3             ;H=REG start
0199+++90B3             ;L=VALUE
0200+++90B3             ;A=REG end (not inclusive)
0201+++90B3             .writeregsset
0202+++90B3 CD BB 90            call .writereg
0203+++90B6 24                  inc h
0204+++90B7 BC                  cp h
0205+++90B8 20 F9               jr nz,.writeregsset
0206+++90BA C9                  ret
0207+++90BB             ;H=REG
0208+++90BB             ;L=VALUE
0209+++90BB             .writereg
0210+++90BB                     FM.SelectReg h
0210+++90BB 42          >        ld b,d
0210+++90BC ED 70       >        inf
0210+++90BE FA BC 90    >        jp m,$-2
0210+++90C1 ED 61       >        out (c),Reg
0211+++90C3                     FM.WriteReg l
0211+++90C3 43          >        ld b,e
0211+++90C4 ED 70       >        inf
0211+++90C6 FA C4 90    >        jp m,$-2
0211+++90C9 ED 69       >        out (c),Reg
0212+++90CB C9                  ret
0213+++90CC             
0214+++90CC             selChip0
0215+++90CC 3E F8               ld a,statuschip0
0216+++90CE 18 DF               jr Mute.selRegA
0217+++90D0             
0218+++90D0             selChip1
0219+++90D0 3E F9               ld a,statuschip1
0220+++90D2 18 DB               jr Mute.selRegA
0221+++90D4             
0222+++90D4             Play
0223+++90D4 11 BF FF            ld de,#FFBF
0224+++90D7 0E FD               ld c,#FD
0225+++90D9             
0226+++90D9 CD CC 90            call selChip0
0227+++90DC             
0228+++90DC AF                  xor a
0229+++90DD 08                  exa
0230+++90DE DD 21 36 92         ld ix,TFM.A
0231+++90E2 CD 19 91            call PlayChannel
0232+++90E5 3E 01               ld a,1
0233+++90E7 08                  exa
0234+++90E8 DD 21 3E 92         ld ix,TFM.B
0235+++90EC CD 19 91            call PlayChannel
0236+++90EF 3E 02               ld a,2
0237+++90F1 08                  exa
0238+++90F2 DD 21 46 92         ld ix,TFM.C
0239+++90F6 CD 19 91            call PlayChannel
0240+++90F9                     
0241+++90F9 CD D0 90            call selChip1
0242+++90FC             
0243+++90FC AF                  xor a
0244+++90FD 08                  exa
0245+++90FE DD 21 4E 92         ld ix,TFM.D
0246+++9102 CD 19 91            call PlayChannel
0247+++9105 3E 01               ld a,1
0248+++9107 08                  exa
0249+++9108 DD 21 56 92         ld ix,TFM.E
0250+++910C CD 19 91            call PlayChannel
0251+++910F 3E 02               ld a,2
0252+++9111 08                  exa
0253+++9112 DD 21 5E 92         ld ix,TFM.F
0254+++9116 C3 19 91            jp PlayChannel
0255+++9119             
0256+++9119             ;%11111111,-disp8 =      -disp8
0257+++9119             ;%111ttttt = skip 32..2 frames
0258+++9119             ;%110ddddd = slide d-16
0259+++9119             ;%11010000,frames,-disp16 = repeat block (skips = 1 frame)
0260+++9119             ;%10111111,-disp16 =      -disp16
0261+++9119             ;%10NNNNNf = keyoff,[freq,]0..30 regs, keyon
0262+++9119             ;%01111111 = end
0263+++9119             ;%01111110 = begin
0264+++9119             ;%01NNNNNf = keyoff,[freq,]0..31 regs
0265+++9119             ;%00NNNNNf =        [freq,]0..30 regs
0266+++9119             bb=%01111110
0267+++9119             be=%01111111
0268+++9119             ;IX - data
0269+++9119             ;DE - hi ports #FFBF
0270+++9119             ;C - low port #FD
0271+++9119             ;A' - fm channel
0272+++9119             PlayChannel
0273+++9119 DD 7E 02            ld a,(ix+TFMData.skip)
0274+++911C 3C                  inc a
0275+++911D C2 DC 91            jp nz,.skiper
0276+++9120 DD 7E 03            ld a,(ix+TFMData.blkcnt)
0277+++9123 A7                  and a
0278+++9124 28 1D               jr z,.noframe
0279+++9126 DD 35 03            dec (ix+TFMData.blkcnt)
0280+++9129 20 18               jr nz,.noframe
0281+++912B DD 6E 04            ld l,(ix+TFMData.blkretaddr)
0282+++912E DD 66 05            ld h,(ix+TFMData.blkretaddr+1)
0283+++9131 18 16               jr .tfmframe
0284+++9133             .begin
0285+++9133 DD 75 05            ld (ix+TFMData.loopaddr),l
0286+++9136 DD 74 06            ld (ix+TFMData.loopaddr+1),h
0287+++9139 18 0E               jr .tfmframe
0288+++913B             .end
0289+++913B DD 6E 05            ld l,(ix+TFMData.loopaddr)
0290+++913E DD 66 06            ld h,(ix+TFMData.loopaddr+1)
0291+++9141 18 06               jr .tfmframe
0292+++9143             .noframe        
0293+++9143 DD 6E 00            ld l,(ix+TFMData.addr)
0294+++9146 DD 66 01            ld h,(ix+TFMData.addr+1)
0295+++9149             .tfmframe
0296+++9149 7E                  ld a,(hl)
0297+++914A 23                  inc hl
0298+++914B FE 7E               cp bb
0299+++914D 28 E4               jr z,.begin
0300+++914F FE 7F               cp be
0301+++9151 28 E8               jr z,.end
0302+++9153 BB                  cp e ;#BF
0303+++9154 D2 CF 91            jp NC,.HLskiper
0304+++9157             ;TestKeyOff
0305+++9157 F2 70 91            jp P,.noffX
0306+++915A F5                  push af
0307+++915B 3E 28               ld a,#28
0308+++915D                     FM.SelectReg a
0308+++915D 42          >        ld b,d
0308+++915E ED 70       >        inf
0308+++9160 FA 5E 91    >        jp m,$-2
0308+++9163 ED 79       >        out (c),Reg
0309+++9165 08                  exa
0310+++9166                     FM.WriteReg a ;FMChannel
0310+++9166 43          >        ld b,e
0310+++9167 ED 70       >        inf
0310+++9169 FA 67 91    >        jp m,$-2
0310+++916C ED 79       >        out (c),Reg
0311+++916E 08                  exa 
0312+++916F F1                  pop af
0313+++9170             .noffX
0314+++9170 B7                  OR a
0315+++9171 F5                  push af
0316+++9172             ;TestFreq
0317+++9172 1F                  RRA 
0318+++9173 30 12               jr NC,.nofrqX
0319+++9175             
0320+++9175 46                  ld b,(hl)
0321+++9176 23                  inc hl
0322+++9177 4E                  ld c,(hl)
0323+++9178 23                  inc hl
0324+++9179 DD 70 07            ld (ix+TFMData.tfmhigh),b
0325+++917C DD 71 06            ld (ix+TFMData.tfmlow),c
0326+++917F C5                  push bc
0327+++9180 E3                  ex (sp),hl
0328+++9181 0E FD               ld c,#FD
0329+++9183 CD F1 91            call .outTone
0330+++9186 E1                  pop hl
0331+++9187             
0332+++9187             .nofrqX
0333+++9187 E6 1F               and #1F
0334+++9189 C4 1A 92            call nz,.OutRegs
0335+++918C CD C8 91            call .storeaddr
0336+++918F F1                  pop af
0337+++9190 F0                  ret P
0338+++9191             ;.KeyOn        
0339+++9191 3E 28               ld a,#28
0340+++9193                     FM.SelectReg a
0340+++9193 42          >        ld b,d
0340+++9194 ED 70       >        inf
0340+++9196 FA 94 91    >        jp m,$-2
0340+++9199 ED 79       >        out (c),Reg
0341+++919B 08                  exa
0342+++919C C6 F0               add a,#F0
0343+++919E                     FM.WriteReg a
0343+++919E 43          >        ld b,e
0343+++919F ED 70       >        inf
0343+++91A1 FA 9F 91    >        jp m,$-2
0343+++91A4 ED 79       >        out (c),Reg
0344+++91A6 D6 F0               sub #F0
0345+++91A8 08                  exa
0346+++91A9 C9                  ret 
0347+++91AA             
0348+++91AA             .block
0349+++91AA 7E                  ld a,(hl) ;N frames
0350+++91AB                               ;1 now, N-1 later
0351+++91AB                               ;skip command is used as 1 frame
0352+++91AB 23                  inc hl
0353+++91AC DD 77 03            ld (ix+TFMData.blkcnt),a
0354+++91AF 46                  ld b,(hl)
0355+++91B0 23                  inc hl
0356+++91B1 4E                  ld c,(hl) ;disp
0357+++91B2 23                  inc hl
0358+++91B3 DD 75 04            ld (ix+TFMData.blkretaddr),l
0359+++91B6 DD 74 05            ld (ix+TFMData.blkretaddr+1),h
0360+++91B9             .subframe        
0361+++91B9 09                  add hl,bc
0362+++91BA 0E FD               ld c,#fd
0363+++91BC C3 49 91            jp .tfmframe
0364+++91BF             
0365+++91BF             .OLDfar
0366+++91BF 46                  ld b,(hl)
0367+++91C0 23                  inc hl
0368+++91C1             .OLDnear
0369+++91C1 4E                  ld c,(hl)
0370+++91C2 23                  inc hl
0371+++91C3 E5                  push hl
0372+++91C4 CD B9 91            call .subframe
0373+++91C7 E1                  pop hl
0374+++91C8             .storeaddr        
0375+++91C8 DD 75 00            ld (ix+TFMData.addr),l
0376+++91CB DD 74 01            ld (ix+TFMData.addr+1),h
0377+++91CE C9                  ret 
0378+++91CF             .HLskiper
0379+++91CF 28 EE               jr z,.OLDfar
0380+++91D1 FE E0               cp %11100000
0381+++91D3 38 0B               jr c,.slide
0382+++91D5 47                  ld b,a
0383+++91D6 BA                  cp d ;#FF
0384+++91D7 28 E8               jr z,.OLDnear
0385+++91D9 CD C8 91            call .storeaddr
0386+++91DC DD 77 02    .skiper ld (ix+TFMData.skip),a
0387+++91DF C9                  ret
0388+++91E0             .slide
0389+++91E0                    ;a=-64..-33
0390+++91E0 C6 30               add a,48
0391+++91E2                    ;a=-16..15
0392+++91E2 28 C6               jr z,.block
0393+++91E4 DD 86 06            add a,(ix+TFMData.tfmlow)
0394+++91E7 DD 77 06            ld (ix+TFMData.tfmlow),a
0395+++91EA CD C8 91            call .storeaddr
0396+++91ED DD 66 07            ld h,(ix+TFMData.tfmhigh)
0397+++91F0 6F                  ld l,a
0398+++91F1             .outTone
0399+++91F1 08                  exa
0400+++91F2 C6 A4               add a,#a4
0401+++91F4                     FM.SelectReg a
0401+++91F4 42          >        ld b,d
0401+++91F5 ED 70       >        inf
0401+++91F7 FA F5 91    >        jp m,$-2
0401+++91FA ED 79       >        out (c),Reg
0402+++91FC                     FM.WriteReg h
0402+++91FC 43          >        ld b,e
0402+++91FD ED 70       >        inf
0402+++91FF FA FD 91    >        jp m,$-2
0402+++9202 ED 61       >        out (c),Reg
0403+++9204 D6 04               sub #04  ;#A0+channel
0404+++9206                     FM.SelectReg a
0404+++9206 42          >        ld b,d
0404+++9207 ED 70       >        inf
0404+++9209 FA 07 92    >        jp m,$-2
0404+++920C ED 79       >        out (c),Reg
0405+++920E                     FM.WriteReg l
0405+++920E 43          >        ld b,e
0405+++920F ED 70       >        inf
0405+++9211 FA 0F 92    >        jp m,$-2
0405+++9214 ED 69       >        out (c),Reg
0406+++9216 D6 A0               sub #a0
0407+++9218 08                  exa
0408+++9219 C9                  ret 
0409+++921A             
0410+++921A 42          .OutRegs ld b,d ;%11111xxx
0411+++921B                     WaitStatus
0411+++921B ED 70       >        inf
0411+++921D FA 1B 92    >        jp m,$-2
0412+++9220 ED A3               outi   ;reg
0413+++9222                     WaitStatus
0413+++9222 ED 70       >        inf
0413+++9224 FA 22 92    >        jp m,$-2
0414+++9227 43                  ld b,e ;#BF
0415+++9228 ED A3               outi   ;value
0416+++922A 3D                  dec a
0417+++922B 20 ED               jr nz,.OutRegs ; turbo jr=jp
0418+++922D C9                  ret 
0419+++922E             
0420+++922E             TFM.Init TFMData 0,-1,0
0420+++922E 0000FF0000000000
0421+++9236             TFM.A  TFMData        
0421+++9236 0000000000000000
0422+++923E             TFM.B  TFMData
0422+++923E 0000000000000000
0423+++9246             TFM.C  TFMData
0423+++9246 0000000000000000
0424+++924E             TFM.D  TFMData
0424+++924E 0000000000000000
0425+++9256             TFM.E  TFMData
0425+++9256 0000000000000000
0426+++925E             TFM.F  TFMData
0426+++925E 0000000000000000
0427+++9266             
0428+++9266                    endmod
0429+++9266             TFC.End
0430+++9266                    
0431+++9266                    display "TFC module size: ",TFC.End-TFC.Start
0432+++9266                    
0433+++9266                    endif
0434+++9266             
0417++ 9266             MTC.End        
0418++ 9266                     display "MTC module size: ",MTC.End-MTC.Start
0419++ 9266             
0420++ 9266                     endif
0421++ 9266             
0078+  9266             UNI.End      
0079+  9266                   display "UNI module size: ",UNI.End-UNI.Init
0080+  9266                   endif
0081+  9266             
0013   9266             
0014   9266             module      
0015   9266                   ;incbin MTC_CYBERMOTION
0016   9266                   ;incbin MTC_DRUMTEST
0017   9266                   ;incbin MTC_MUG
0018   9266                   incbin MTC_MYSTICAL
0019   B5FE                   ;incbin MTC_NEWOLD
0020   B5FE                   ;incbin MTC_SNEGURKA
0021   B5FE                   ;incbin TFC_CYBERMOTION
0022   B5FE                   ;incbin TFC_DRUMTEST
0023   B5FE                   ;incbin TFC_MUG
0024   B5FE                   ;incbin TFC_MYSTICAL
0025   B5FE                   ;incbin TFC_NEWOLD
0026   B5FE                   ;incbin TFC_SNEGURKA
0027   B5FE                   ;incbin PT3_DRUMTEST
0028   B5FE                   ;incbin PT3_MYSTICAL
0029   B5FE                   ;incbin PT3_NEWOLD
0030   B5FE                   ;incbin PT3_SNEGURKA
0031   B5FE                   ;incbin TS_INEEDREST
0032   B5FE                   ;incbin PT2_PITON
0033   B5FE             
0034   B5FE                   savesna "test_uni.sna",begin
0035   B5FE                   savebin "../uni_8000.bin",player,module-player
0036   B5FE             

Value    Label
------ - -----------------------------------------------------------
0x6000   begin
0x8000   init
0x600D   begin.loop
0x6014   begin.delay
0x8005   play
0x8008   mute
0x602C X begin.fail
0x8000   player
0x9266   UNI.End
0x800B   UNI.Init
0x8005   UNI.Play
0x8008   UNI.Mute
0x8028   UNI.Init.tryMTC
0x8039   UNI.Init.tryTFC
0x804A   UNI.Init.tryTS
0x805B   UNI.Init.tryPT2
0x806C   UNI.Init.tryPT3
0x8020   UNI.Init.addr
0x807D   MTC.CheckFormat
0x809C   MTC.Init
0x80D9   MTC.Play
0x80F7   MTC.Mute
0x8FF8   TFC.CheckFormat
0x9021   TFC.Init
0x90D4   TFC.Play
0x905D   TFC.Mute
0x8FAF   TS.CheckFormat
0x8FAA   TS.Init
0x8B7F   TS.Play
0x8351   TS.Mute
0x8F6F   PT2.CheckFormat
0x8F6A   PT2.Init
0x8B7F   PT2.Play
0x8351   PT2.Mute
0x8F23   PT3.CheckFormat
0x8F1E   PT3.Init
0x8B7F   PT3.Play
0x8351   PT3.Mute
0x0005 X MTC.StreamType
0x0000   MTC.StreamType.PT3
0x0001   MTC.StreamType.PT2
0x0002   MTC.StreamType.TS
0x0003   MTC.StreamType.TFC
0x0004   MTC.StreamType.Unknown
0x000B   MTC.StreamData
0x0000   MTC.StreamData.Type
0x0001   MTC.StreamData.Data1
0x0003   MTC.StreamData.Data2
0x0005   MTC.StreamData.Init
0x0007   MTC.StreamData.Play
0x0009   MTC.StreamData.Mute
0x807D   MTC.Start
0x8152   MTC.Streams
0x8117   MTC.ParseChunk
0x0000   MTC.ChunkId.MTC1
0x821C   MTC.ParseMTC1
0x82DD   MTC.MergeStreams
0x80B3   MTC.Init.initstreams
0x8115   MTC.jp_bc
0x80DD   MTC.Play.playstreams
0x80FB   MTC.Mute.mutestreams
0x8200   MTC.Chunks
0x811A   MTC.ParseChunk.checkid
0x8143   MTC.ParseChunk.matched
0x001C   MTC.ChunkId.Unknown
0x8145   MTC.ParseChunk.getdata
0x0003   MTC.MinStreamsCount
0x8173   MTC.Streams.End
0x8200 X MTC.ChunkId
0x0004   MTC.ChunkId.TRCK
0x0008   MTC.ChunkId.DATA
0x000C X MTC.ChunkId.NAME
0x0010 X MTC.ChunkId.AUTH
0x0014 X MTC.ChunkId.ANNO
0x0018 X MTC.ChunkId.PROP
0x000F   MTC.MaxStreamsCount
0x821F   MTC.ParseMTC1.nextchunk
0x8234   MTC.ParseTrack
0x8237   MTC.ParseTrack.nextchunk
0x824D   MTC.ParseData
0x8259   MTC.ParseTFC
0x827B   MTC.ParseTS
0x8288   MTC.ParsePT2
0x829B   MTC.ParsePT3
0x82BA   MTC.FillStream
0x8270   MTC.AddStream
0x8FC0   TS.CheckFormatKnownSize
0x82AE   MTC.FillTS
0x82B4   MTC.FillPts
0x8B7F   PTS.PLAY
0x8351   PTS.MUTE
0x82E9   MTC.Sort
0x82F1   MTC.Sort.cycle
0x8310   MTC.Sort.end
0x8309   MTC.Sort.next
0x82FD   MTC.Sort.swapitems
0x8314 X MTC.Merge
0x831A   MTC.Merge.cycle
0x8328   MTC.Merge.perform
0x8341   MTC.Merge.generic
0x8343   MTC.Merge.copyitems
0x0030 X PTS.Release
0x0000   PTS.CurPosCounter
0x0000   PTS.ACBBAC
0x0000   PTS.LoopChecker
0x0000   PTS.Id
0x0000   PTS.Basic
0x0000   PTS.TonA
0x0002   PTS.TonB
0x0004   PTS.TonC
0x0006   PTS.Noise
0x0007   PTS.Mixer
0x0008   PTS.AmplA
0x0009   PTS.AmplB
0x000A   PTS.AmplC
0x000B   PTS.Env
0x000D   PTS.EnvTp
0x8350   PTS.START
0x0001 X PTS.SETUP.NOLOOP
0x0002   PTS.SETUP.PT2
0x0004 X PTS.SETUP.ACB
0x0008 X PTS.SETUP.BAC
0x0010   PTS.SETUP.TS02
0x0020   PTS.SETUP.TSPT3
0x8350   PTS.SETUP
0x8C60   PTS.VARS1
0x0079   PTS.VRS.AYREGS
0x8CE7   PTS.VARS2
0x8B93   PTS.ROUT
0x8363   PTS.INIT
0x8C5F   PTS.VARS
0x8D6E   PTS.VAR0END
0x0062   PTS.VRS.AdInPtA
0x840C   PTS.I_PT2
0x8555   PTS.INITPT3
0x8949   PTS.e_
0x8928   PTS.SamCnv
0x88F3   PTS.OrnCP
0x891F   PTS.SamCP
0x88F6   PTS.OrnLD
0x8922   PTS.SamLD
0x8919   PTS.SamClc2
0x83B0   PTS.L20
0x83B2   PTS.L21
0x87C6   PTS.Version
0x8401   PTS.NOTS
0x83F5   PTS.TwoPT3s
0x0087   PTS.VRS
0x0002   PTS.VRS.ModNum
0x8A8A   PTS.TSSub
0x83F8   PTS.AlCoTS_
0x8C5F   PTS.is_ts
0x8712   PTS.PT3PD
0x8C27   PTS.PT3EMPTYORN
0x8454   PTS.INITCOMMON
0x858D   PTS.INITPT2
0x844B   PTS.NOTS2
0x864C   PTS.PT2PD
0x8D7D   PTS.PT2EMPTYORN
0x85FD   PTS.PTDEC
0x8A8C   PTS.PsCalc
0x8C2A   PTS.T_PACK
0x8D6E   PTS.T1_
0x8462   PTS.TP_0
0x846E   PTS.TP_1
0x8475   PTS.TP_2
0x006D   PTS.VRS.DelyCnt
0x0003   PTS.VRS.ChanA
0x001B   PTS.CHP.NtSkCn
0x0020   PTS.VRS.ChanB
0x003D   PTS.VRS.ChanC
0x000D   PTS.CHP.OrnPtr
0x8BD7   PTS.NT_DATA
0x84E6   PTS.L3
0x8BE7   PTS.T_
0x8E5E   PTS.NT_
0x84D5   PTS.L1
0x84E2   PTS.L2
0x8BF3   PTS.TCOLD_1
0x8507   PTS.CORR_1
0x851C   PTS.TC_EXIT
0x8515   PTS.CORR_2
0x852B   PTS.M1
0x853C   PTS.M2
0x8D5E   PTS.VT_
0x8534   PTS.INITV2
0x853B   PTS.INITV1
0x854F   PTS.M3
0x85C8   PTS.SETMDAD
0x006C   PTS.VRS.Delay
0x85D6   PTS.SETCPPT
0x85DD   PTS.SETLPPT
0x85C1   PTS.SETPTPT
0x85CF   PTS.SETORPT
0x8586   PTS.SETSMPT
0x005E   PTS.VRS.SamPtrs
0x0060   PTS.VRS.PatsPtr
0x005A   PTS.VRS.MODADDR
0x005C   PTS.VRS.OrnPtrs
0x0068   PTS.VRS.CrPsPtr
0x006A   PTS.VRS.LPosPtr
0x85E4   PTS.SETENBS
0x0077   PTS.VRS.EnvBase
0x85EB   PTS.SETESLD
0x0070   PTS.VRS.CurESld
0x85F2   PTS.GETIX
0x85F9   PTS.PTDECOD
0x85FF   PTS.PD2_SAM
0x8895   PTS.SETSAM
0x864E   PTS.PD2_LOOP
0x8604   PTS.PD2_EOff
0x0014   PTS.CHP.Env_En
0x8609   PTS.PD2_ENV
0x861B   PTS.PD2_ORN
0x8876   PTS.SETORN
0x8620   PTS.PD2_SKIP
0x0011   PTS.CHP.NNtSkp
0x8626   PTS.PD2_VOL
0x001C   PTS.CHP.Volume
0x862F   PTS.PD2_DEL
0x8846   PTS.C_DELAY
0x8634   PTS.PD2_GLIS
0x0015   PTS.CHP.Flags
0x0016   PTS.CHP.TnSlDl
0x0005   PTS.CHP.TSlCnt
0x0017   PTS.CHP.TSlStp
0x864D   PTS.PD2_LP2
0x8693   PTS.PD2_REL
0x8698   PTS.PD2_NOTE
0x8775   PTS.PD_FIN
0x8683   PTS.PD2_PORT
0x868E   PTS.PD2_STOP
0x0003   PTS.CHP.CrNsSl
0x86C4   PTS.PD2_EXIT
0x0012   PTS.CHP.Note
0x87AE   PTS.PrNote
0x86C3   PTS.NOGLIS2
0x86BF   PTS.NOPORT2
0x87D5   PTS.LoStep
0x8790   PTS.SETPORT
0x0001   PTS.CHP.PsInSm
0x0000   PTS.CHP.PsInOr
0x0006   PTS.CHP.CrTnSl
0x86D3   PTS.PD_OrSm
0x86DA   PTS.PD_SAM_
0x86DD   PTS.PD_SAM
0x8721   PTS.PD_LOOP
0x86E2   PTS.PD_VOL
0x8724   PTS.PD_LP2
0x86EB   PTS.PD_EOff
0x86F3   PTS.PD_SorE
0x86FD   PTS.PD_ENV
0x885B   PTS.SETENV
0x8702   PTS.PD_ORN
0x8707   PTS.PD_ESAM
0x87CB   PTS.PrSlide
0x8756   PTS.PD_REL
0x875C   PTS.PD_NOTE
0x8751   PTS.PD_NOIS
0x88B1   PTS.SPCCOMS
0x0074   PTS.VRS.Ns_Base
0x8764   PTS.PD_RES
0x8772   PTS.PDSP_
0x877C   PTS.C_PORTM
0x0013   PTS.CHP.SlToNt
0x0019   PTS.CHP.TnDelt
0x87D4   PTS.OLDPRTM
0x87DA   PTS.NOSIG
0x87E4   PTS.SET_STP
0x000A   PTS.CHP.COnOff
0x87F0   PTS.C_GLISS
0x8803   PTS.GL36
0x880D   PTS.C_SMPOS
0x8813   PTS.C_ORPOS
0x8819   PTS.C_VIBRT
0x000B   PTS.CHP.OnOffD
0x000C   PTS.CHP.OffOnD
0x8831   PTS.C_ENGLS
0x0072   PTS.VRS.Env_Del
0x0073   PTS.VRS.CurEDel
0x006E   PTS.VRS.ESldAdd
0x8894   PTS.C_NOP
0x000F   PTS.CHP.SamPtr
0x88D1   PTS.CHREGS
0x8B0E   PTS.Ampl
0x8A24   PTS.CH_EXIT
0x896D   PTS.CSP_
0x88F7   PTS.CH_ORPS
0x8902   PTS.CH_NTP
0x8908   PTS.CH_NOK
0x8923   PTS.CH_SMPS
0x0008   PTS.CHP.TnAcc
0x895A   PTS.CH_NOAC
0x89B5   PTS.CH_AMP
0x89A0   PTS.CH_STPP
0x0002   PTS.CHP.CrAmSl
0x89CF   PTS.CH_NOAM
0x89C7   PTS.CH_AMIN
0x89CC   PTS.CH_SVAM
0x89D8   PTS.CH_APOS
0x89DE   PTS.CH_VOL
0x89E9 X PTS.CH_ENV
0x89F0   PTS.CH_NOEN
0x8A12   PTS.NO_ENSL
0x0004   PTS.CHP.CrEnSl
0x8A0A   PTS.NO_ENAC
0x0076   PTS.VRS.AddToEn
0x8A20   PTS.CH_MIX
0x0075   PTS.VRS.AddToNs
0x8A44   PTS.CH_ONDL
0x8A48   PTS.PLAY_
0x8AFB   PTS.PL2
0x8AC7   PTS.PL1B
0x8ABB   PTS.PL1A
0x8A7F   PTS.PLNLP
0x8A8C   PTS.NoAlCo
0x8AB8   PTS.PSP_
0x0064   PTS.VRS.AdInPtB
0x0066   PTS.VRS.AdInPtC
0x8ADE   PTS.PL1C
0x8AF5   PTS.PL1D
0x8B93   PTS.PL_nts
0x8B9A X PTS.r_nts
0x8BAB   PTS.ROUT_
0x8BAF   PTS.LOUT
0x8DA0   PTS.T_NEW_0
0x8C11   PTS.TCNEW_0
0x8DA0   PTS.T_OLD_0
0x8BE7   PTS.TCOLD_0
0x8D6E   PTS.T_NEW_1
0x8BF3   PTS.TCNEW_1
0x8D6E   PTS.T_OLD_1
0x8DB8   PTS.T_NEW_2
0x8C1C   PTS.TCNEW_2
0x8D86   PTS.T_OLD_2
0x8BF5   PTS.TCOLD_2
0x8D9E   PTS.T_NEW_3
0x8C07   PTS.TCNEW_3
0x8D9E   PTS.T_OLD_3
0x8C08   PTS.TCOLD_3
0x001D   PTS.CHP
0x0000 X PTS.VRS.CurPos
0x0001 X PTS.VRS.PosSub
0x8F1E X PTS.VARSEND
0x8F1E X PTS.MDLADDR
0x00CB X PT3.Header
0x0000 X PT3.Header.Id
0x000D X PT3.Header.Subversion
0x000E X PT3.Header.Description
0x0062 X PT3.Header.Mode
0x0063   PT3.Header.FreqTable
0x0064 X PT3.Header.Tempo
0x0065 X PT3.Header.Length
0x0066 X PT3.Header.Loop
0x0067 X PT3.Header.Patterns
0x0069   PT3.Header.Samples
0x00A9   PT3.Header.Ornaments
0x00C9   PT3.Header.Positions
0x8F1E   PT3.Start
0x8F3E   PT3.CheckFormat.samples
0x8F48   PT3.CheckFormat.ornaments
0x8F58   PT3.CheckFormat.positions
0x8F5D   PT3.CheckFormat.div3
0x8F65   PT3.CheckFormat.posok
0x8F67 X PT3.CheckFormat.fail
0x8F6A   PT3.End
0x0085 X PT2.Header
0x0000 X PT2.Header.Tempo
0x0001 X PT2.Header.Length
0x0002 X PT2.Header.Loop
0x0003   PT2.Header.Samples
0x0043 X PT2.Header.Ornaments
0x0063   PT2.Header.Patterns
0x0065   PT2.Header.Name
0x0083   PT2.Header.Positions
0x8F6A   PT2.Start
0x8F80   PT2.CheckFormat.samorns
0x8F9C   PT2.CheckFormat.positions
0x8FA7 X PT2.CheckFormat.fail
0x8FAA   PT2.End
0x0010 X TS.Footer
0x0000 X TS.Footer.Sign1
0x0004 X TS.Footer.Size1
0x0006 X TS.Footer.Sign2
0x000A X TS.Footer.Size2
0x000C X TS.Footer.Sign3
0x8FAA   TS.Start
0x8FB2   TS.CheckFormat.findfooter
0x8FC1   TS.CheckFooter
0x8FED   TS.End
0x0001   TFC.newtfm
0x00F8   TFC.statuschip0
0x00F9   TFC.statuschip1
0x0022 X TFC.Header
0x0000 X TFC.Header.signature
0x0006 X TFC.Header.version
0x0009 X TFC.Header.intfreq
0x000A   TFC.Header.tfmptrs
0x0016 X TFC.Header.ssgptrs
0x0008   TFC.TFMData
0x0000   TFC.TFMData.addr
0x0002   TFC.TFMData.skip
0x0003   TFC.TFMData.blkcnt
0x0004   TFC.TFMData.blkretaddr
0x0005   TFC.TFMData.loopaddr
0x0006   TFC.TFMData.tfmlow
0x0007   TFC.TFMData.tfmhigh
0x8FED   TFC.Start
0x9266   TFC.End
0x922E   TFC.TFM.Init
0x9236   TFC.TFM.A
0x9051   TFC.Init.tfminitab
0x905D   TFC.Init.tfminitab_end
0x9038   TFC.Init.tfmini0
0x9047   TFC.Init.tfminiHL
0x9236   TFC.TFM.A.addr
0x923E   TFC.TFM.B.addr
0x9246   TFC.TFM.C.addr
0x924E   TFC.TFM.D.addr
0x9256   TFC.TFM.E.addr
0x925E   TFC.TFM.F.addr
0x90CC   TFC.selChip0
0x906B   TFC.Mute.tfminiPP
0x90D0   TFC.selChip1
0x90B3   TFC.Mute.writeregsset
0x90BB   TFC.Mute.writereg
0x90AF   TFC.Mute.selRegA
0x9119   TFC.PlayChannel
0x923E   TFC.TFM.B
0x9246   TFC.TFM.C
0x924E   TFC.TFM.D
0x9256   TFC.TFM.E
0x925E   TFC.TFM.F
0x007E   TFC.bb
0x007F   TFC.be
0x91DC   TFC.PlayChannel.skiper
0x9143   TFC.PlayChannel.noframe
0x9149   TFC.PlayChannel.tfmframe
0x9133   TFC.PlayChannel.begin
0x913B   TFC.PlayChannel.end
0x91CF   TFC.PlayChannel.HLskiper
0x9170   TFC.PlayChannel.noffX
0x9187   TFC.PlayChannel.nofrqX
0x91F1   TFC.PlayChannel.outTone
0x921A   TFC.PlayChannel.OutRegs
0x91C8   TFC.PlayChannel.storeaddr
0x91AA   TFC.PlayChannel.block
0x91B9   TFC.PlayChannel.subframe
0x91BF   TFC.PlayChannel.OLDfar
0x91C1   TFC.PlayChannel.OLDnear
0x91E0   TFC.PlayChannel.slide
0x922E X TFC.TFM.Init.addr
0x9230 X TFC.TFM.Init.skip
0x9231 X TFC.TFM.Init.blkcnt
0x9232 X TFC.TFM.Init.blkretaddr
0x9233 X TFC.TFM.Init.loopaddr
0x9234 X TFC.TFM.Init.tfmlow
0x9235 X TFC.TFM.Init.tfmhigh
0x9238 X TFC.TFM.A.skip
0x9239 X TFC.TFM.A.blkcnt
0x923A X TFC.TFM.A.blkretaddr
0x923B X TFC.TFM.A.loopaddr
0x923C X TFC.TFM.A.tfmlow
0x923D X TFC.TFM.A.tfmhigh
0x9240 X TFC.TFM.B.skip
0x9241 X TFC.TFM.B.blkcnt
0x9242 X TFC.TFM.B.blkretaddr
0x9243 X TFC.TFM.B.loopaddr
0x9244 X TFC.TFM.B.tfmlow
0x9245 X TFC.TFM.B.tfmhigh
0x9248 X TFC.TFM.C.skip
0x9249 X TFC.TFM.C.blkcnt
0x924A X TFC.TFM.C.blkretaddr
0x924B X TFC.TFM.C.loopaddr
0x924C X TFC.TFM.C.tfmlow
0x924D X TFC.TFM.C.tfmhigh
0x9250 X TFC.TFM.D.skip
0x9251 X TFC.TFM.D.blkcnt
0x9252 X TFC.TFM.D.blkretaddr
0x9253 X TFC.TFM.D.loopaddr
0x9254 X TFC.TFM.D.tfmlow
0x9255 X TFC.TFM.D.tfmhigh
0x9258 X TFC.TFM.E.skip
0x9259 X TFC.TFM.E.blkcnt
0x925A X TFC.TFM.E.blkretaddr
0x925B X TFC.TFM.E.loopaddr
0x925C X TFC.TFM.E.tfmlow
0x925D X TFC.TFM.E.tfmhigh
0x9260 X TFC.TFM.F.skip
0x9261 X TFC.TFM.F.blkcnt
0x9262 X TFC.TFM.F.blkretaddr
0x9263 X TFC.TFM.F.loopaddr
0x9264 X TFC.TFM.F.tfmlow
0x9265 X TFC.TFM.F.tfmhigh
0x9266   MTC.End
0x9266   module
