0001   0000                   device zxspectrum128
0002   0000             
0003   0000                   org #6000
0004   6000             begin 
0005   6000                   include "test.asm"
0001+  6000 F3                di
0002+  6001 CD 00 80          call init
0003+  6004 FD 21 3A 5C       ld iy,#5c3a
0004+  6008 21 58 27          ld hl,10072
0005+  600B D9                exx
0006+  600C FB                ei
0007+  600D 76          .loop halt
0008+  600E 01 01 00          ld bc,1
0009+  6011 21 F4 01          ld hl,500
0010+  6014             .delay
0011+  6014 ED 42             sbc hl,bc
0012+  6016 20 FC             jr nz,.delay
0013+  6018 3E 04             ld a,4
0014+  601A D3 FE             out (-2),a
0015+  601C CD 05 80          call play
0016+  601F AF                xor a
0017+  6020 D3 FE             out (-2),a
0018+  6022 3E 7F             ld a,#7f
0019+  6024 DB FE             in a,(-2)
0020+  6026 1F                rra
0021+  6027 38 E4             jr c,.loop
0022+  6029 CD 08 80          CALL mute
0023+  602C 3E 02       .fail ld a,2
0024+  602E D3 FE             out (-2),a
0025+  6030 F3                di
0026+  6031 76                halt
0027+  6032             
0028+  6032                   define MTC_CYBERMOTION "CyberMotion.mtc"
0029+  6032                   define MTC_DRUMTEST "drumtest.mtc"
0030+  6032                   define MTC_MUG "mug.mtc"
0031+  6032                   define MTC_MYSTICAL "mystical.mtc"
0032+  6032                   define MTC_NEWOLD "newold.mtc"
0033+  6032                   define MTC_SNEGURKA "Snegurka.mtc"
0034+  6032             
0035+  6032                   define TFC_CYBERMOTION MTC_CYBERMOTION,0x76
0036+  6032                   define TFC_DRUMTEST MTC_DRUMTEST,0xa90
0037+  6032                   define TFC_MUG MTC_MUG,0x52
0038+  6032                   define TFC_MYSTICAL MTC_MYSTICAL,0xcd4
0039+  6032                   define TFC_NEWOLD MTC_NEWOLD,0x263a
0040+  6032                   define TFC_SNEGURKA MTC_SNEGURKA,0x52
0041+  6032             
0042+  6032                   define PT3_DRUMTEST MTC_DRUMTEST,0x52
0043+  6032                   define PT3_MYSTICAL MTC_MYSTICAL,0x52
0044+  6032                   define PT3_NEWOLD MTC_NEWOLD,0x52
0045+  6032                   define PT3_SNEGURKA MTC_SNEGURKA,0xaa4
0046+  6032             
0047+  6032                   define TS_INEEDREST "INEEDREST.ts"
0048+  6032             
0049+  6032                   define PT2_PITON "PITON.pt2"
0050+  6032                   
0006   6032                   
0007   6032                   org #8000
0008   8000             player      
0009   8000             init=player
0010   8000             play=player+5
0011   8000             mute=player+8
0012   8000                   include "mtc.asm"
0001+  8000                     ifndef _mtc_asm_defined
0002+  8000                     define _mtc_asm_defined
0003+  8000                     
0004+  8000                     module MTC
0005+  8000             
0006+  8000                     ;enum-like
0007+  8000                     struct StreamType
0008+  8000~            PT3     db 0
0009+  8000~            PT2     db 0
0010+  8000~            TS      db 0        
0011+  8000~            TFC     db 0
0012+  8000~            Unknown db 0
0013+  8000                     ends
0014+  8000                     
0015+  8000                     struct StreamData
0016+  8000~            Type    db 0
0017+  8000~            Data1   dw 0        
0018+  8000~            Data2   dw 0
0019+  8000~            Init    dw 0
0020+  8000~            Play    dw 0
0021+  8000~            Mute    dw 0
0022+  8000                     ends
0023+  8000                     
0024+  8000             Start        
0025+  8000                     ifndef NoPrologue
0026+  8000 21 66 91            ld hl,End
0027+  8003 18 06               jr Init
0028+  8005 C3 48 80            jp Play
0029+  8008 C3 66 80            jp Mute
0030+  800B                     endif
0031+  800B             
0032+  800B                     ifdef HaveFormatCheck
0033+  800B~                    
0034+  800B~                    include "format.asm"
0035+  800B~                    
0036+  800B~            ;in HL - module addr
0037+  800B~            ;out Z - is mtc
0038+  800B~            CheckFormat
0039+  800B~                    EqualTo "M"
0040+  800B~                    EqualTo "T"
0041+  800B~                    EqualTo "C"
0042+  800B~                    EqualTo "1"
0043+  800B~                    EqualTo 0
0044+  800B~                    EqualTo 0
0045+  800B~                    ret
0046+  800B~                    
0047+  800B~                    display "MTC checker size: ",$-CheckFormat
0048+  800B~            0049+  800B                     endif
0050+  800B             
0051+  800B             ;in HL - module addr
0052+  800B DD 21 C1 80 Init    ld ix,Streams
0053+  800F DD 36 00 04         ld (ix+StreamData.Type),StreamType.Unknown
0054+  8013 CD 86 80            call ParseChunk
0055+  8016 FE 00               cp ChunkId.MTC1
0056+  8018 CC 1C 81            call z,ParseMTC1
0057+  801B CD DD 81            call MergeStreams
0058+  801E DD 21 C1 80         ld ix,Streams
0059+  8022             .initstreams
0060+  8022 DD 7E 00            ld a,(ix+StreamData.Type)
0061+  8025 FE 04               cp StreamType.Unknown
0062+  8027 C8                  ret z
0063+  8028 DD 6E 01            ld l,(ix+StreamData.Data1)
0064+  802B DD 66 02            ld h,(ix+StreamData.Data1+1)
0065+  802E DD 5E 03            ld e,(ix+StreamData.Data2)
0066+  8031 DD 56 04            ld d,(ix+StreamData.Data2+1)
0067+  8034 DD 4E 05            ld c,(ix+StreamData.Init)
0068+  8037 DD 46 06            ld b,(ix+StreamData.Init+1)
0069+  803A DD E5               push ix
0070+  803C CD 84 80            call jp_bc
0071+  803F DD E1               pop ix
0072+  8041 01 0B 00            ld bc,StreamData
0073+  8044 DD 09               add ix,bc
0074+  8046 18 DA               jr .initstreams
0075+  8048                     
0076+  8048 DD 21 C1 80 Play    ld ix,Streams
0077+  804C             .playstreams        
0078+  804C DD 7E 00            ld a,(ix+StreamData.Type)
0079+  804F FE 04               cp StreamType.Unknown
0080+  8051 C8                  ret z
0081+  8052 DD 4E 07            ld c,(ix+StreamData.Play)
0082+  8055 DD 46 08            ld b,(ix+StreamData.Play+1)
0083+  8058 DD E5               push ix
0084+  805A CD 84 80            call jp_bc
0085+  805D DD E1               pop ix
0086+  805F 01 0B 00            ld bc,StreamData
0087+  8062 DD 09               add ix,bc
0088+  8064 18 E6               jr .playstreams
0089+  8066             
0090+  8066 DD 21 C1 80 Mute    ld ix,Streams
0091+  806A             .mutestreams        
0092+  806A DD 7E 00            ld a,(ix+StreamData.Type)
0093+  806D FE 04               cp StreamType.Unknown
0094+  806F C8                  ret z
0095+  8070 DD 4E 09            ld c,(ix+StreamData.Mute)
0096+  8073 DD 46 0A            ld b,(ix+StreamData.Mute+1)
0097+  8076 DD E5               push ix
0098+  8078 CD 84 80            call jp_bc
0099+  807B DD E1               pop ix
0100+  807D 01 0B 00            ld bc,StreamData
0101+  8080 DD 09               add ix,bc
0102+  8082 18 E6               jr .mutestreams
0103+  8084             
0104+  8084 C5          jp_bc   push bc
0105+  8085 C9                  ret
0106+  8086             
0107+  8086             ;in hl - chunk start
0108+  8086             ;out a - chunkid
0109+  8086             ;out hl - chunk data start
0110+  8086             ;out bc - chunk data size
0111+  8086             ParseChunk
0112+  8086 11 00 81            ld de,Chunks
0113+  8089             .checkid
0114+  8089 06 04               ld b,4
0115+  808B E5                  push hl
0116+  808C                     dup 4
0117+  808C 1A          >        ld a,(de)
0118+  808D 1C          >        inc e
0119+  808E BE          >        cp (hl)
0120+  808F 23          >        inc hl
0121+  8090 20 01       >        jr nz,$+3
0122+  8092 05          >        dec b
0117+  8093 1A          >        ld a,(de)
0118+  8094 1C          >        inc e
0119+  8095 BE          >        cp (hl)
0120+  8096 23          >        inc hl
0121+  8097 20 01       >        jr nz,$+3
0122+  8099 05          >        dec b
0117+  809A 1A          >        ld a,(de)
0118+  809B 1C          >        inc e
0119+  809C BE          >        cp (hl)
0120+  809D 23          >        inc hl
0121+  809E 20 01       >        jr nz,$+3
0122+  80A0 05          >        dec b
0117+  80A1 1A          >        ld a,(de)
0118+  80A2 1C          >        inc e
0119+  80A3 BE          >        cp (hl)
0120+  80A4 23          >        inc hl
0121+  80A5 20 01       >        jr nz,$+3
0122+  80A7 05          >        dec b
0124+  80A8                     ;nz if last byte is not matched
0125+  80A8                     ;nz if b != 0 (not all bytes matched)
0126+  80A8 7B                  ld a,e
0127+  80A9 28 07               jr z,.matched
0128+  80AB FE 1C               cp ChunkId.Unknown
0129+  80AD 28 05               jr z,.getdata
0130+  80AF E1                  pop hl
0131+  80B0 18 D7               jr .checkid
0132+  80B2             .matched
0133+  80B2 D6 04               sub 4
0134+  80B4             .getdata
0135+  80B4                     ;skip higher bytes of size, assume they are zero
0136+  80B4 23                  inc hl
0137+  80B5 23                  inc hl        
0138+  80B6 46                  ld b,(hl)
0139+  80B7 23                  inc hl
0140+  80B8 4E                  ld c,(hl)
0141+  80B9 23                  inc hl
0142+  80BA                     ;chunk is always aligned at word boundary, so correct length
0143+  80BA CB 41               bit 0,c
0144+  80BC 28 01               jr z,$+3
0145+  80BE 03                  inc bc
0146+  80BF D1                  pop de
0147+  80C0 C9                  ret
0148+  80C1             
0149+  80C1             ;put streams in gap
0150+  80C1             Streams 
0151+  80C1             MinStreamsCount=3 ;approx: ts+tfm
0152+  80C1 00                  ds MinStreamsCount*StreamData ;approx
0153+  80E2             Streams.End
0154+  80E2                     display "MTC: loosed ",256-low $," bytes"
0155+  80E2 00                  align 256
0156+  8100             Chunks
0157+  8100             ChunkId
0158+  8100             .MTC1=low $
0159+  8100 4D 54 43 31         db "MTC1"
0160+  8104             .TRCK=low $
0161+  8104 54 52 43 4B         db "TRCK"
0162+  8108             .DATA=low $
0163+  8108 44 41 54 41         db "DATA"
0164+  810C             .NAME=low $
0165+  810C 4E 41 4D 45         db "NAME"
0166+  8110             .AUTH=low $
0167+  8110 41 55 54 48         db "AUTH"
0168+  8114             .ANNO=low $
0169+  8114 41 4E 4E 4F         db "ANNO"
0170+  8118             .PROP=low $
0171+  8118 50 52 4F 50         db "PROP"
0172+  811C             .Unknown=low $
0173+  811C             
0174+  811C             MaxStreamsCount=(Chunks-Streams)/StreamData
0175+  811C                     display "MTC: max streams ",MaxStreamsCount
0176+  811C                     
0177+  811C             ;in hl - content
0178+  811C             ;in bc - size
0179+  811C             ParseMTC1
0180+  811C E5                  push hl
0181+  811D 09                  add hl,bc
0182+  811E E3                  ex (sp),hl
0183+  811F                     ; (sp) - end of avail data
0184+  811F             .nextchunk        
0185+  811F CD 86 80            call ParseChunk
0186+  8122 E5 C5               push hl,bc
0187+  8124 FE 04               cp ChunkId.TRCK
0188+  8126 CC 34 81            call z,ParseTrack
0189+  8129 C1 E1               pop bc,hl
0190+  812B 09                  add hl,bc
0191+  812C D1                  pop de
0192+  812D                     ;hl- end of chunk
0193+  812D                     ;de- end of avail
0194+  812D ED 52               sbc hl,de
0195+  812F C8                  ret z ;last chunk
0196+  8130 19                  add hl,de
0197+  8131 D5                  push de
0198+  8132 18 EB               jr .nextchunk
0199+  8134             
0200+  8134             ;in hl - content
0201+  8134             ;in bc - size        
0202+  8134             ParseTrack        
0203+  8134 E5                  push hl
0204+  8135 09                  add hl,bc
0205+  8136 E3                  ex (sp),hl
0206+  8137                     ; (sp) - end of avail data
0207+  8137             .nextchunk        
0208+  8137 CD 86 80            call ParseChunk
0209+  813A E5 C5               push hl,bc
0210+  813C FE 08               cp ChunkId.DATA
0211+  813E CC 4D 81            call z,ParseData
0212+  8141 C1 E1               pop bc,hl
0213+  8143 09                  add hl,bc
0214+  8144 D1                  pop de
0215+  8145 C8                  ret z ;data is parsed
0216+  8146                     ;hl- end of chunk
0217+  8146                     ;de- end of avail
0218+  8146 ED 52               sbc hl,de
0219+  8148 C8                  ret z ;last chunk
0220+  8149 19                  add hl,de
0221+  814A D5                  push de
0222+  814B 18 EA               jr .nextchunk
0223+  814D             
0224+  814D             ;in hl - content
0225+  814D             ;in bc - size        
0226+  814D             ;out Z - data parsed and added as stream
0227+  814D             ParseData
0228+  814D CD 59 81            call ParseTFC
0229+  8150 C4 7B 81            call nz,ParseTS
0230+  8153 C4 88 81            call nz,ParsePT2
0231+  8156 20 43               jr nz,ParsePT3
0232+  8158 C9                  ret
0233+  8159                     
0234+  8159             ParseTFC
0235+  8159 E5 C5               push hl,bc
0236+  815B CD F8 8E            call TFC.CheckFormat
0237+  815E C1 E1               pop bc,hl
0238+  8160 C0                  ret nz
0239+  8161 3E 03               ld a,StreamType.TFC
0240+  8163 D9                  exx
0241+  8164 21 21 8F            ld hl,TFC.Init
0242+  8167 11 D4 8F            ld de,TFC.Play
0243+  816A 01 5D 8F            ld bc,TFC.Mute
0244+  816D CD BA 81            call FillStream
0245+  8170             AddStream        
0246+  8170 01 0B 00            ld bc,StreamData
0247+  8173 DD 09               add ix,bc
0248+  8175 DD 36 00 04         ld (ix+StreamData.Type),StreamType.Unknown
0249+  8179 AF                  xor a;set Z
0250+  817A C9                  ret
0251+  817B                     
0252+  817B             ParseTS
0253+  817B E5 C5               push hl,bc
0254+  817D CD C0 8E            call TS.CheckFormatKnownSize
0255+  8180 C1 E1               pop bc,hl
0256+  8182 C0                  ret nz
0257+  8183 CD AE 81            call FillTS
0258+  8186 18 E8               jr AddStream
0259+  8188                     
0260+  8188             ParsePT2
0261+  8188 E5 C5               push hl,bc
0262+  818A CD 6F 8E            call PT2.CheckFormat
0263+  818D C1 E1               pop bc,hl
0264+  818F C0                  ret nz
0265+  8190 3E 01               ld a,StreamType.PT2
0266+  8192 D9                  exx
0267+  8193 21 6A 8E            ld hl,PT2.Init
0268+  8196 CD B4 81            call FillPts
0269+  8199 18 D5               jr AddStream
0270+  819B             
0271+  819B             ParsePT3        
0272+  819B E5 C5               push hl,bc
0273+  819D CD 23 8E            call PT3.CheckFormat
0274+  81A0 C1 E1               pop bc,hl
0275+  81A2 C0                  ret nz
0276+  81A3 3E 00               ld a,StreamType.PT3
0277+  81A5 D9                  exx
0278+  81A6 21 1E 8E            ld hl,PT3.Init
0279+  81A9 CD B4 81            call FillPts
0280+  81AC 18 C2               jr AddStream
0281+  81AE                     
0282+  81AE 3E 02       FillTS  ld a,StreamType.TS        
0283+  81B0 D9                  exx
0284+  81B1 21 AA 8E            ld hl,TS.Init
0285+  81B4 11 7F 8A    FillPts ld de,PTS.PLAY
0286+  81B7 01 51 82            ld bc,PTS.MUTE
0287+  81BA             FillStream
0288+  81BA DD 77 00            ld (ix+StreamData.Type),a
0289+  81BD DD 75 05            ld (ix+StreamData.Init),l
0290+  81C0 DD 74 06            ld (ix+StreamData.Init+1),h
0291+  81C3 DD 73 07            ld (ix+StreamData.Play),e
0292+  81C6 DD 72 08            ld (ix+StreamData.Play+1),d
0293+  81C9 DD 71 09            ld (ix+StreamData.Mute),c
0294+  81CC DD 70 0A            ld (ix+StreamData.Mute+1),b
0295+  81CF D9                  exx
0296+  81D0 DD 75 01            ld (ix+StreamData.Data1),l
0297+  81D3 DD 74 02            ld (ix+StreamData.Data1+1),h
0298+  81D6 DD 73 03            ld (ix+StreamData.Data2),e
0299+  81D9 DD 72 04            ld (ix+StreamData.Data2+1),d
0300+  81DC C9                  ret
0301+  81DD             
0302+  81DD             ;some business-logic related to supported players        
0303+  81DD             MergeStreams
0304+  81DD 3A C1 80            ld a,(Streams+StreamData.Type)
0305+  81E0 FE 04               cp StreamType.Unknown
0306+  81E2 C8                  ret z ;no streams
0307+  81E3 3A CC 80            ld a,(Streams+StreamData+StreamData.Type)
0308+  81E6 FE 04               cp StreamType.Unknown
0309+  81E8 C8                  ret z ;single stream
0310+  81E9             
0311+  81E9                     ;sort streams according to type, use simple bubblesort
0312+  81E9             Sort
0313+  81E9                     assert 0 == ((Streams ^ Streams.End) >> 8)
0314+  81E9                     assert 0 == StreamData.Type
0315+  81E9 11 C1 80            ld de,Streams
0316+  81EC 21 CC 80            ld hl,Streams+StreamData
0317+  81EF 0E 00               ld c,0;swaps mark
0318+  81F1             .cycle        
0319+  81F1 1A                  ld a,(de)
0320+  81F2 FE 04               cp StreamType.Unknown
0321+  81F4 28 1A               jr z,.end
0322+  81F6 BE                  cp (hl)
0323+  81F7 38 10               jr c,.next
0324+  81F9 28 0E               jr z,.next
0325+  81FB 06 0B               ld b,StreamData
0326+  81FD             .swapitems
0327+  81FD 1A                  ld a,(de)        
0328+  81FE 4E                  ld c,(hl)
0329+  81FF 77                  ld (hl),a
0330+  8200 79                  ld a,c
0331+  8201 12                  ld (de),a
0332+  8202 2C                  inc l
0333+  8203 1C                  inc e
0334+  8204 10 F7               djnz .swapitems
0335+  8206 4C                  ld c,h
0336+  8207 18 E8               jr .cycle
0337+  8209             .next
0338+  8209 5D                  ld e,l
0339+  820A 7D                  ld a,l
0340+  820B C6 0B               add a,StreamData
0341+  820D 6F                  ld l,a        
0342+  820E 18 E1               jr .cycle
0343+  8210             .end
0344+  8210 79                  ld a,c
0345+  8211 A7                  and a
0346+  8212 20 D5               jr nz,Sort
0347+  8214                     ;try merge streams
0348+  8214                     ; X X merged to X (last is taken)
0349+  8214                     ; PT3 PT3 merged to TS
0350+  8214             Merge
0351+  8214                     assert 0 == StreamData.Type
0352+  8214 11 C1 80            ld de,Streams
0353+  8217 21 CC 80            ld hl,Streams+StreamData
0354+  821A             .cycle        
0355+  821A 1A                  ld a,(de)
0356+  821B FE 04               cp StreamType.Unknown
0357+  821D C8                  ret z
0358+  821E BE                  cp (hl)
0359+  821F 28 07               jr z,.perform
0360+  8221 5D                  ld e,l
0361+  8222 7D                  ld a,l
0362+  8223 C6 0B               add a,StreamData
0363+  8225 6F                  ld l,a
0364+  8226 18 F2               jr .cycle
0365+  8228             .perform
0366+  8228 FE 00               cp StreamType.PT3
0367+  822A 20 15               jr nz,.generic
0368+  822C                     ;merge PT3 streams to TS
0369+  822C E5 D5               push hl,de
0370+  822E E5 D5               push hl,de
0371+  8230 2C                  inc l
0372+  8231 5E                  ld e,(hl)
0373+  8232 2C                  inc l
0374+  8233 56                  ld d,(hl) ;data1
0375+  8234 E1                  pop hl
0376+  8235 2C                  inc l
0377+  8236 7E                  ld a,(hl)
0378+  8237 2C                  inc l
0379+  8238 66                  ld h,(hl)
0380+  8239 6F                  ld l,a  ;data2
0381+  823A DD E1               pop ix
0382+  823C CD AE 81            call FillTS
0383+  823F D1 E1               pop de,hl
0384+  8241             .generic
0385+  8241                     ;for other types just take last one
0386+  8241 06 0B               ld b,StreamData
0387+  8243             .copyitems
0388+  8243 7E                  ld a,(hl)
0389+  8244 12                  ld (de),a
0390+  8245 2C                  inc l
0391+  8246 1C                  inc e
0392+  8247 10 FA               djnz .copyitems        
0393+  8249 1A                  ld a,(de)
0394+  824A FE 04               cp StreamType.Unknown
0395+  824C 20 F3               jr nz,.generic
0396+  824E 18 8D               jr MergeStreams
0397+  8250             
0398+  8250                     endmod
0399+  8250                     
0400+  8250                     ifndef NoPrologue
0401+  8250                     define NoPrologue
0402+  8250                     endif
0403+  8250                     
0404+  8250                     ifndef HaveFormatCheck
0405+  8250                     define HaveFormatCheck
0406+  8250                     endif
0407+  8250                     
0408+  8250                     ifndef ONtfm
0409+  8250                     define ONtfm
0410+  8250                     endif
0411+  8250                     
0412+  8250                     include "PTSPlay.asm"
0001++ 8250                     ifndef _pts_asm_defined
0002++ 8250                     define _pts_asm_defined
0003++ 8250             
0004++ 8250                     MODULE PTS
0005++ 8250                     
0006++ 8250             ;Universal PT2'n'PT3 Turbo Sound player for ZX Spectrum
0007++ 8250             ;(c)2004-2007 S.V.Bulba <vorobey@mail.khstu.ru>
0008++ 8250             ;Specially for AlCo
0009++ 8250             ;http://bulba.untergrund.net/ (http://bulba.at.kz/)
0010++ 8250             
0011++ 8250             ;Release number
0012++ 8250             Release EQU "0"
0013++ 8250             
0014++ 8250             ;Conditional assembly
0015++ 8250             ;1) Current position counters at (Vars1+0) and (Vars2+0)
0016++ 8250             CurPosCounter=0
0017++ 8250             ;2) Allow channels allocation bits at (SETUP)
0018++ 8250             ACBBAC=0
0019++ 8250             ;3) Allow loop checking and disabling
0020++ 8250             LoopChecker=0
0021++ 8250             ;4) Insert official identificator
0022++ 8250             Id=0
0023++ 8250             ;5) Set IY for correct return to ZX Basic
0024++ 8250             Basic=0
0025++ 8250             
0026++ 8250             ;Features
0027++ 8250             ;--------
0028++ 8250             ;-Can be compiled at any address (i.e. no need rounding ORG
0029++ 8250             ; address).
0030++ 8250             ;-Variables (VARS) can be located at any address (not only after
0031++ 8250             ; code block).
0032++ 8250             ;-INIT subprogram checks PT3-module version and rightly
0033++ 8250             ; generates both note and volume tables outside of code block
0034++ 8250             ; (in VARS).
0035++ 8250             ;-Two portamento (spc. command 3xxx) algorithms (depending of
0036++ 8250             ; PT3 module version).
0037++ 8250             ;-New 1.XX and 2.XX special command behaviour (only for PT v3.7
0038++ 8250             ; and higher).
0039++ 8250             ;-Any Tempo value are accepted (including Tempo=1 and Tempo=2).
0040++ 8250             ;-TS modes: 2xPT3, 2xPT2 and PT v3.7 TS standard.
0041++ 8250             ;-Fully compatible with Ay_Emul PT3 and PT2 players codes.
0042++ 8250             ;-See also notes at the end of this source code.
0043++ 8250             
0044++ 8250             ;Limitations
0045++ 8250             ;-----------
0046++ 8250             ;-Can run in RAM only (self-modified code is used).
0047++ 8250             ;-PT2 position list must be end by #FF marker only.
0048++ 8250             
0049++ 8250             ;Warning!!! PLAY subprogram can crash if no module are loaded
0050++ 8250             ;into RAM or INIT subprogram was not called before.
0051++ 8250             
0052++ 8250             ;Call MUTE or INIT one more time to mute sound after stopping
0053++ 8250             ;playing 
0054++ 8250             
0055++ 8250             TonA	EQU 0
0056++ 8250             TonB	EQU 2
0057++ 8250             TonC	EQU 4
0058++ 8250             Noise	EQU 6
0059++ 8250             Mixer	EQU 7
0060++ 8250             AmplA	EQU 8
0061++ 8250             AmplB	EQU 9
0062++ 8250             AmplC	EQU 10
0063++ 8250             Env	EQU 11
0064++ 8250             EnvTp	EQU 13
0065++ 8250             
0066++ 8250             START
0067++ 8250             
0068++ 8250             SETUP.NOLOOP EQU 1
0069++ 8250             SETUP.PT2 EQU 2
0070++ 8250             SETUP.ACB EQU 4
0071++ 8250             SETUP.BAC EQU 8
0072++ 8250             SETUP.TS02 EQU 16
0073++ 8250             SETUP.TSPT3 EQU 32
0074++ 8250             
0075++ 8250 00          SETUP	DB 0 ;set bit0, if you want to play without looping
0076++ 8251             	     ;(optional);
0077++ 8251             	     ;set bit1 for PT2 and reset for PT3 before
0078++ 8251             	     ;calling INIT;
0079++ 8251             	     ;bits2-3: %00-ABC, %01-ACB, %10-BAC (optional);
0080++ 8251             	     ;bits4-5: %00-no TS, %01-2 modules TS, %10-
0081++ 8251             	     ;autodetect PT3 TS-format by AlCo (PT 3.7+);
0082++ 8251             	     ;Remark: old PT3 TS-format by AlCo (PT 3.6) is not
0083++ 8251             	     ;documented and must be converted to new standard.
0084++ 8251             	     ;bit6 is set each time, when loop point of 2nd TS
0085++ 8251             	     ;module is passed (optional).
0086++ 8251             	     ;bit7 is set each time, when loop point of 1st TS
0087++ 8251             	     ;or of single module is passed (optional).
0088++ 8251             
0089++ 8251             ;Identifier
0090++ 8251             	IF Id
0091++ 8251~            	DB "=UniPT2/PT3/TS-Player r.",Release,"="
0092++ 8251             	ENDIF
0093++ 8251             
0094++ 8251             	IF LoopChecker
0095++ 8251~            CHECKLP	LD HL,SETUP
0096++ 8251~            	BIT 0,(IY-100+VRS.ModNum)
0097++ 8251~            	JR Z,CHL1
0098++ 8251~            	SET 6,(HL)
0099++ 8251~            	JR CHL2
0100++ 8251~            CHL1	SET 7,(HL)
0101++ 8251~            CHL2	BIT 0,(HL)
0102++ 8251~            	RET Z
0103++ 8251~            	POP HL
0104++ 8251~            	INC (IY-100+VRS.DelyCnt)
0105++ 8251~            	INC (IY-100+VRS.ChanA+CHP.NtSkCn)
0106++ 8251~            	XOR A
0107++ 8251~            	LD (IY-100+VRS.AYREGS+AmplA),A
0108++ 8251~            	LD (IY-100+VRS.AYREGS+AmplB),A
0109++ 8251~            	LD (IY-100+VRS.AYREGS+AmplC),A
0110++ 8251~            	RET
0111++ 8251             	ENDIF
0112++ 8251             
0113++ 8251 AF          MUTE	XOR A
0114++ 8252 67          	LD H,A
0115++ 8253 6F          	LD L,A
0116++ 8254 32 E1 8B    	LD (VARS1+VRS.AYREGS+AmplA),A
0117++ 8257 22 E2 8B    	LD (VARS1+VRS.AYREGS+AmplB),HL
0118++ 825A 32 68 8C    	LD (VARS2+VRS.AYREGS+AmplA),A
0119++ 825D 22 69 8C    	LD (VARS2+VRS.AYREGS+AmplB),HL
0120++ 8260 C3 93 8A    	JP ROUT
0121++ 8263             
0122++ 8263             INIT
0123++ 8263             ;HL - AddressOfModule
0124++ 8263             ;DE - AddresOf2ndModule
0125++ 8263             ;A - mode
0126++ 8263 D5          	PUSH DE
0127++ 8264 E5          	PUSH HL
0128++ 8265 21 5F 8B    	LD HL,VARS
0129++ 8268 36 00       	LD (HL),0
0130++ 826A 11 60 8B    	LD DE,VARS+1
0131++ 826D 01 0E 01    	LD BC,VAR0END-VARS-1
0132++ 8270 ED B0       	LDIR
0133++ 8272 23          	INC HL
0134++ 8273 22 C2 8B    	LD (VARS1+VRS.AdInPtA),HL ;ptr to zero
0135++ 8276 22 49 8C    	LD (VARS2+VRS.AdInPtA),HL
0136++ 8279             
0137++ 8279 E1          	POP HL
0138++ 827A FD 21 C4 8B 	LD IY,VARS1+100
0139++ 827E 32 50 82        LD (SETUP),A
0140++ 8281 E6 02       	AND SETUP.PT2
0141++ 8283 C2 0C 83    	JP NZ,I_PT2
0142++ 8286             
0143++ 8286 CD 55 84    	CALL INITPT3
0144++ 8289 21 18 1F    	LD HL,(e_-SamCnv-2)*256+#18
0145++ 828C 22 28 88    	LD (SamCnv),HL
0146++ 828F 3E BA       	LD A,#BA
0147++ 8291 32 F3 87    	LD (OrnCP),A
0148++ 8294 32 1F 88    	LD (SamCP),A
0149++ 8297 3E 7B       	LD A,#7B
0150++ 8299 32 F6 87    	LD (OrnLD),A
0151++ 829C 32 22 88    	LD (SamLD),A
0152++ 829F 3E 87       	LD A,#87
0153++ 82A1 32 19 88    	LD (SamClc2),A
0154++ 82A4 E1          	POP HL
0155++ 82A5             	;Use version and ton table of 1st module
0156++ 82A5 DD 7E A9    	LD A,(IX+13-100) ;EXTRACT VERSION NUMBER
0157++ 82A8 D6 30       	SUB #30
0158++ 82AA 38 04       	JR C,L20
0159++ 82AC FE 0A       	CP 10
0160++ 82AE 38 02       	JR C,L21
0161++ 82B0 3E 06       L20	LD A,6
0162++ 82B2 32 C6 86    L21	LD (Version),A
0163++ 82B5 F5          	PUSH AF ;VolTable version
0164++ 82B6 FE 04       	CP 4
0165++ 82B8 DD 7E FF    	LD A,(IX+99-100) ;TONE TABLE NUMBER
0166++ 82BB 17          	RLA
0167++ 82BC E6 07       	AND 7
0168++ 82BE F5          	PUSH AF ;NoteTable number
0169++ 82BF             
0170++ 82BF FD 21 4B 8C 	LD IY,VARS2+100
0171++ 82C3 3A 50 82    	LD A,(SETUP)
0172++ 82C6 E6 30       	AND SETUP.TS02|SETUP.TSPT3
0173++ 82C8 28 37       	JR Z,NOTS
0174++ 82CA FE 10       	CP SETUP.TS02
0175++ 82CC 28 27       	JR Z,TwoPT3s
0176++ 82CE 3A C6 86    	LD A,(Version)
0177++ 82D1 FE 07       	CP 7
0178++ 82D3 38 2C       	JR C,NOTS
0179++ 82D5 DD 7E FE    	LD A,(IX+98-100) ;ALCO TS MARKER
0180++ 82D8 FE 20       	CP #20
0181++ 82DA 28 25       	JR Z,NOTS
0182++ 82DC 21 60 8B    	LD HL,VARS1
0183++ 82DF 11 E7 8B    	LD DE,VARS2
0184++ 82E2 01 87 00    	LD BC,VRS
0185++ 82E5 ED B0       	LDIR
0186++ 82E7 FD CB 9E CE 	SET 1,(IY-100+VRS.ModNum)
0187++ 82EB 4F          	LD C,A
0188++ 82EC 87          	ADD A,A
0189++ 82ED 81          	ADD A,C
0190++ 82EE D6 02       	SUB 2
0191++ 82F0 32 8A 89    	LD (TSSub),A
0192++ 82F3 18 03       	JR AlCoTS_
0193++ 82F5 CD 55 84    TwoPT3s	CALL INITPT3
0194++ 82F8 3E 01       AlCoTS_	LD A,1
0195++ 82FA 32 5F 8B    	LD (is_ts),A
0196++ 82FD FD CB 9E C6 	SET 0,(IY-100+VRS.ModNum)
0197++ 8301             
0198++ 8301 01 12 86    NOTS	LD BC,PT3PD
0199++ 8304 21 00 00    	LD HL,0
0200++ 8307 11 27 8B    	LD DE,PT3EMPTYORN
0201++ 830A 18 48       	JR INITCOMMON
0202++ 830C             
0203++ 830C CD 8D 84    I_PT2	CALL INITPT2
0204++ 830F 21 CB 51    	LD HL,#51CB
0205++ 8312 22 28 88    	LD (SamCnv),HL
0206++ 8315 3E BB       	LD A,#BB
0207++ 8317 32 F3 87    	LD (OrnCP),A
0208++ 831A 32 1F 88    	LD (SamCP),A
0209++ 831D 3E 7A       	LD A,#7A
0210++ 831F 32 F6 87    	LD (OrnLD),A
0211++ 8322 32 22 88    	LD (SamLD),A
0212++ 8325 3E 80       	LD A,#80
0213++ 8327 32 19 88    	LD (SamClc2),A
0214++ 832A E1          	POP HL
0215++ 832B 3E 05       	LD A,5
0216++ 832D 32 C6 86    	LD (Version),A
0217++ 8330 F5          	PUSH AF
0218++ 8331 3E 02       	LD A,2
0219++ 8333 F5          	PUSH AF
0220++ 8334             
0221++ 8334 3A 50 82    	LD A,(SETUP)
0222++ 8337 E6 30           AND SETUP.TS02|SETUP.TSPT3
0223++ 8339 28 10       	JR Z,NOTS2
0224++ 833B             
0225++ 833B FD 21 4B 8C 	LD IY,VARS2+100
0226++ 833F 3E 01       	LD A,1
0227++ 8341 32 5F 8B    	LD (is_ts),A
0228++ 8344 FD CB 9E C6 	SET 0,(IY-100+VRS.ModNum)
0229++ 8348 CD 8D 84    	CALL INITPT2
0230++ 834B             
0231++ 834B 01 4C 85    NOTS2	LD BC,PT2PD
0232++ 834E 21 87 86    	LD HL,#8687
0233++ 8351 11 7D 8C    	LD DE,PT2EMPTYORN
0234++ 8354             
0235++ 8354             INITCOMMON
0236++ 8354             
0237++ 8354             	IF Basic
0238++ 8354~            	LD IY,#5C3A
0239++ 8354             	ENDIF
0240++ 8354             
0241++ 8354 ED 43 FD 84 	LD (PTDEC),BC
0242++ 8358 22 8C 89    	LD (PsCalc),HL
0243++ 835B D5          	PUSH DE
0244++ 835C             
0245++ 835C             ;note table data depacker
0246++ 835C             ;(c) Ivan Roshin
0247++ 835C 11 2A 8B    	LD DE,T_PACK
0248++ 835F 01 CF 8C    	LD BC,T1_+(2*49)-1
0249++ 8362 1A          TP_0	LD A,(DE)
0250++ 8363 13          	INC DE
0251++ 8364 FE 1E       	CP 15*2
0252++ 8366 30 06       	JR NC,TP_1
0253++ 8368 67          	LD H,A
0254++ 8369 1A          	LD A,(DE)
0255++ 836A 6F          	LD L,A
0256++ 836B 13          	INC DE
0257++ 836C 18 07       	JR TP_2
0258++ 836E D5          TP_1	PUSH DE
0259++ 836F 16 00       	LD D,0
0260++ 8371 5F          	LD E,A
0261++ 8372 19          	ADD HL,DE
0262++ 8373 19          	ADD HL,DE
0263++ 8374 D1          	POP DE
0264++ 8375 7C          TP_2	LD A,H
0265++ 8376 02          	LD (BC),A
0266++ 8377 0B          	DEC BC
0267++ 8378 7D          	LD A,L
0268++ 8379 02          	LD (BC),A
0269++ 837A 0B          	DEC BC
0270++ 837B D6 F0       	SUB (#F8*2)&255
0271++ 837D 20 E3       	JR NZ,TP_0
0272++ 837F             
0273++ 837F 3C          	INC A
0274++ 8380 32 CD 8B    	LD (VARS1+VRS.DelyCnt),A
0275++ 8383 32 54 8C    	LD (VARS2+VRS.DelyCnt),A
0276++ 8386 21 01 F0    	LD HL,#F001 ;H - CHP.Volume, L - CHP.NtSkCn
0277++ 8389 22 7E 8B    	LD (VARS1+VRS.ChanA+CHP.NtSkCn),HL
0278++ 838C 22 9B 8B    	LD (VARS1+VRS.ChanB+CHP.NtSkCn),HL
0279++ 838F 22 B8 8B    	LD (VARS1+VRS.ChanC+CHP.NtSkCn),HL
0280++ 8392 22 05 8C    	LD (VARS2+VRS.ChanA+CHP.NtSkCn),HL
0281++ 8395 22 22 8C    	LD (VARS2+VRS.ChanB+CHP.NtSkCn),HL
0282++ 8398 22 3F 8C    	LD (VARS2+VRS.ChanC+CHP.NtSkCn),HL
0283++ 839B E1          	POP HL
0284++ 839C 22 70 8B    	LD (VARS1+VRS.ChanA+CHP.OrnPtr),HL
0285++ 839F 22 8D 8B    	LD (VARS1+VRS.ChanB+CHP.OrnPtr),HL
0286++ 83A2 22 AA 8B    	LD (VARS1+VRS.ChanC+CHP.OrnPtr),HL
0287++ 83A5 22 F7 8B    	LD (VARS2+VRS.ChanA+CHP.OrnPtr),HL
0288++ 83A8 22 14 8C    	LD (VARS2+VRS.ChanB+CHP.OrnPtr),HL
0289++ 83AB 22 31 8C    	LD (VARS2+VRS.ChanC+CHP.OrnPtr),HL
0290++ 83AE             
0291++ 83AE F1          	POP AF
0292++ 83AF             
0293++ 83AF             ;NoteTableCreator (c) Ivan Roshin
0294++ 83AF             ;A - NoteTableNumber*2+VersionForNoteTable
0295++ 83AF             ;(xx1b - 3.xx..3.4r, xx0b - 3.4x..3.6x..VTII1.0)
0296++ 83AF             
0297++ 83AF 21 D7 8A    	LD HL,NT_DATA
0298++ 83B2 16 00       	LD D,0
0299++ 83B4 87          	ADD A,A
0300++ 83B5 5F          	LD E,A
0301++ 83B6 19          	ADD HL,DE
0302++ 83B7 5E          	LD E,(HL)
0303++ 83B8 23          	INC HL
0304++ 83B9 CB 3B       	SRL E
0305++ 83BB 9F          	SBC A,A
0306++ 83BC E6 A7       	AND #A7 ;#00 (NOP) or #A7 (AND A)
0307++ 83BE 32 E6 83    	LD (L3),A
0308++ 83C1 EB          	EX DE,HL
0309++ 83C2 01 6E 8C    	LD BC,T1_
0310++ 83C5 09          	ADD HL,BC
0311++ 83C6             
0312++ 83C6 1A          	LD A,(DE)
0313++ 83C7 C6 E7       	ADD A,T_&255
0314++ 83C9 4F          	LD C,A
0315++ 83CA CE 8A       	ADC A,T_/256
0316++ 83CC 91          	SUB C
0317++ 83CD 47          	LD B,A
0318++ 83CE C5          	PUSH BC
0319++ 83CF 11 5E 8D    	LD DE,NT_
0320++ 83D2 D5          	PUSH DE
0321++ 83D3             
0322++ 83D3 06 0C       	LD B,12
0323++ 83D5 C5          L1	PUSH BC
0324++ 83D6 4E          	LD C,(HL)
0325++ 83D7 23          	INC HL
0326++ 83D8 E5          	PUSH HL
0327++ 83D9 46          	LD B,(HL)
0328++ 83DA             
0329++ 83DA D5          	PUSH DE
0330++ 83DB EB          	EX DE,HL
0331++ 83DC 11 17 00    	LD DE,23
0332++ 83DF DD 26 08    	LD IXH,8
0333++ 83E2             
0334++ 83E2 CB 38       L2	SRL B
0335++ 83E4 CB 19       	RR C
0336++ 83E6 19          L3	DB #19	;AND A or NOP
0337++ 83E7 79          	LD A,C
0338++ 83E8 8A          	ADC A,D	;=ADC 0
0339++ 83E9 77          	LD (HL),A
0340++ 83EA 23          	INC HL
0341++ 83EB 78          	LD A,B
0342++ 83EC 8A          	ADC A,D
0343++ 83ED 77          	LD (HL),A
0344++ 83EE 19          	ADD HL,DE
0345++ 83EF DD 25       	DEC IXH
0346++ 83F1 20 EF       	JR NZ,L2
0347++ 83F3             
0348++ 83F3 D1          	POP DE
0349++ 83F4 13          	INC DE
0350++ 83F5 13          	INC DE
0351++ 83F6 E1          	POP HL
0352++ 83F7 23          	INC HL
0353++ 83F8 C1          	POP BC
0354++ 83F9 10 DA       	DJNZ L1
0355++ 83FB             
0356++ 83FB E1          	POP HL
0357++ 83FC D1          	POP DE
0358++ 83FD             
0359++ 83FD 7B          	LD A,E
0360++ 83FE FE F3       	CP TCOLD_1&255
0361++ 8400 20 05       	JR NZ,CORR_1
0362++ 8402 3E FD       	LD A,#FD
0363++ 8404 32 8C 8D    	LD (NT_+#2E),A
0364++ 8407             
0365++ 8407 1A          CORR_1	LD A,(DE)
0366++ 8408 A7          	AND A
0367++ 8409 28 11       	JR Z,TC_EXIT
0368++ 840B 1F          	RRA
0369++ 840C F5          	PUSH AF
0370++ 840D 87          	ADD A,A
0371++ 840E 4F          	LD C,A
0372++ 840F 09          	ADD HL,BC
0373++ 8410 F1          	POP AF
0374++ 8411 30 02       	JR NC,CORR_2
0375++ 8413 35          	DEC (HL)
0376++ 8414 35          	DEC (HL)
0377++ 8415 34          CORR_2	INC (HL)
0378++ 8416 A7          	AND A
0379++ 8417 ED 42       	SBC HL,BC
0380++ 8419 13          	INC DE
0381++ 841A 18 EB       	JR CORR_1
0382++ 841C             
0383++ 841C             TC_EXIT
0384++ 841C             
0385++ 841C F1          	POP AF
0386++ 841D             
0387++ 841D             ;VolTableCreator (c) Ivan Roshin
0388++ 841D             ;A - VersionForVolumeTable (0..4 - 3.xx..3.4x;
0389++ 841D             			   ;5.. - 2.x,3.5x..3.6x..VTII1.0)
0390++ 841D             
0391++ 841D FE 05       	CP 5
0392++ 841F 21 11 00    	LD HL,#11
0393++ 8422 54          	LD D,H
0394++ 8423 5C          	LD E,H
0395++ 8424 3E 17       	LD A,#17
0396++ 8426 30 03       	JR NC,M1
0397++ 8428 2D          	DEC L
0398++ 8429 5D          	LD E,L
0399++ 842A AF          	XOR A
0400++ 842B 32 3C 84    M1      LD (M2),A
0401++ 842E             
0402++ 842E DD 21 6E 8C 	LD IX,VT_+16
0403++ 8432             
0404++ 8432 0E 0F       	LD C,#F
0405++ 8434 E5          INITV2  PUSH HL
0406++ 8435             
0407++ 8435 19          	ADD HL,DE
0408++ 8436 EB          	EX DE,HL
0409++ 8437 ED 62       	SBC HL,HL
0410++ 8439             
0411++ 8439 06 10       	LD B,#10
0412++ 843B 7D          INITV1  LD A,L
0413++ 843C 7D          M2      DB #7D
0414++ 843D 7C          	LD A,H
0415++ 843E CE 00       	ADC A,0
0416++ 8440 DD 77 00    	LD (IX),A
0417++ 8443 DD 23       	INC IX
0418++ 8445 19          	ADD HL,DE
0419++ 8446 10 F3       	DJNZ INITV1
0420++ 8448             
0421++ 8448 E1          	POP HL
0422++ 8449 7B          	LD A,E
0423++ 844A FE 77       	CP #77
0424++ 844C 20 01       	JR NZ,M3
0425++ 844E 1C          	INC E
0426++ 844F 0D          M3      DEC C
0427++ 8450 20 E2       	JR NZ,INITV2
0428++ 8452             
0429++ 8452 C3 93 8A    	JP ROUT
0430++ 8455             
0431++ 8455 CD C8 84    INITPT3	CALL SETMDAD
0432++ 8458 E5          	PUSH HL
0433++ 8459 11 64 00    	LD DE,100
0434++ 845C 19          	ADD HL,DE
0435++ 845D 7E          	LD A,(HL)
0436++ 845E FD 77 08    	LD (IY-100+VRS.Delay),A
0437++ 8461 E5          	PUSH HL
0438++ 8462 DD E1       	POP IX
0439++ 8464 19          	ADD HL,DE
0440++ 8465 CD D6 84    	CALL SETCPPT
0441++ 8468 DD 5E 02    	LD E,(IX+102-100)
0442++ 846B 23          	INC HL
0443++ 846C             
0444++ 846C             	IF CurPosCounter
0445++ 846C~            	LD (IY-100+VRS.PosSub),L
0446++ 846C             	ENDIF
0447++ 846C             
0448++ 846C 19          	ADD HL,DE
0449++ 846D CD DD 84    	CALL SETLPPT
0450++ 8470 D1          	POP DE
0451++ 8471 DD 6E 03    	LD L,(IX+103-100)
0452++ 8474 DD 66 04    	LD H,(IX+104-100)
0453++ 8477 19          	ADD HL,DE
0454++ 8478 CD C1 84    	CALL SETPTPT
0455++ 847B 21 A9 00    	LD HL,169
0456++ 847E 19          	ADD HL,DE
0457++ 847F CD CF 84    	CALL SETORPT
0458++ 8482 21 69 00    	LD HL,105
0459++ 8485 19          	ADD HL,DE
0460++ 8486             
0461++ 8486 FD 75 FA    SETSMPT LD (IY-100+VRS.SamPtrs),L
0462++ 8489 FD 74 FB    	LD (IY-100+VRS.SamPtrs+1),H
0463++ 848C C9          	RET
0464++ 848D             
0465++ 848D 7E          INITPT2	LD A,(HL)
0466++ 848E FD 77 08    	LD (IY-100+VRS.Delay),A
0467++ 8491 E5          	PUSH HL
0468++ 8492 E5          	PUSH HL
0469++ 8493 E5          	PUSH HL
0470++ 8494 23          	INC HL
0471++ 8495 23          	INC HL
0472++ 8496 7E          	LD A,(HL)
0473++ 8497 23          	INC HL
0474++ 8498 CD 86 84    	CALL SETSMPT
0475++ 849B 5E          	LD E,(HL)
0476++ 849C 23          	INC HL
0477++ 849D 56          	LD D,(HL)
0478++ 849E E1          	POP HL
0479++ 849F A7          	AND A
0480++ 84A0 ED 52       	SBC HL,DE
0481++ 84A2 CD C8 84    	CALL SETMDAD
0482++ 84A5 E1          	POP HL
0483++ 84A6 11 43 00    	LD DE,67
0484++ 84A9 19          	ADD HL,DE
0485++ 84AA CD CF 84    	CALL SETORPT
0486++ 84AD 1E 20       	LD E,32
0487++ 84AF 19          	ADD HL,DE
0488++ 84B0 4E          	LD C,(HL)
0489++ 84B1 23          	INC HL
0490++ 84B2 46          	LD B,(HL)
0491++ 84B3 1E 1E       	LD E,30
0492++ 84B5 19          	ADD HL,DE
0493++ 84B6 CD D6 84    	CALL SETCPPT
0494++ 84B9 5F          	LD E,A
0495++ 84BA 23          	INC HL
0496++ 84BB             
0497++ 84BB             	IF CurPosCounter
0498++ 84BB~            	LD (IY-100+VRS.PosSub),L
0499++ 84BB             	ENDIF
0500++ 84BB             
0501++ 84BB 19          	ADD HL,DE
0502++ 84BC CD DD 84    	CALL SETLPPT
0503++ 84BF E1          	POP HL
0504++ 84C0 09          	ADD HL,BC
0505++ 84C1             
0506++ 84C1 FD 75 FC    SETPTPT	LD (IY-100+VRS.PatsPtr),L
0507++ 84C4 FD 74 FD    	LD (IY-100+VRS.PatsPtr+1),H
0508++ 84C7 C9          	RET
0509++ 84C8             
0510++ 84C8 FD 75 F6    SETMDAD	LD (IY-100+VRS.MODADDR),L
0511++ 84CB FD 74 F7    	LD (IY-100+VRS.MODADDR+1),H
0512++ 84CE C9          	RET
0513++ 84CF             
0514++ 84CF FD 75 F8    SETORPT	LD (IY-100+VRS.OrnPtrs),L
0515++ 84D2 FD 74 F9    	LD (IY-100+VRS.OrnPtrs+1),H
0516++ 84D5 C9          	RET
0517++ 84D6             
0518++ 84D6 FD 75 04    SETCPPT	LD (IY-100+VRS.CrPsPtr),L
0519++ 84D9 FD 74 05    	LD (IY-100+VRS.CrPsPtr+1),H
0520++ 84DC C9          	RET
0521++ 84DD             
0522++ 84DD FD 75 06    SETLPPT	LD (IY-100+VRS.LPosPtr),L
0523++ 84E0 FD 74 07    	LD (IY-100+VRS.LPosPtr+1),H
0524++ 84E3 C9          	RET
0525++ 84E4             
0526++ 84E4 FD 75 13    SETENBS	LD (IY-100+VRS.EnvBase),L
0527++ 84E7 FD 74 14    	LD (IY-100+VRS.EnvBase+1),H
0528++ 84EA C9          	RET
0529++ 84EB             
0530++ 84EB FD 75 0C    SETESLD	LD (IY-100+VRS.CurESld),L
0531++ 84EE FD 74 0D    	LD (IY-100+VRS.CurESld+1),H
0532++ 84F1 C9          	RET
0533++ 84F2             
0534++ 84F2 FD E5       GETIX	PUSH IY
0535++ 84F4 DD E1       	POP IX
0536++ 84F6 DD 19       	ADD IX,DE
0537++ 84F8 C9          	RET
0538++ 84F9             
0539++ 84F9 CD F2 84    PTDECOD CALL GETIX
0540++ 84FC             PTDEC	EQU $+1
0541++ 84FC C3 C3 C3    	JP #C3C3
0542++ 84FF             
0543++ 84FF             ;PT2 pattern decoder
0544++ 84FF CD 95 87    PD2_SAM	CALL SETSAM
0545++ 8502 18 4A       	JR PD2_LOOP
0546++ 8504             
0547++ 8504 DD 77 08    PD2_EOff LD (IX-12+CHP.Env_En),A
0548++ 8507 18 45       	JR PD2_LOOP
0549++ 8509             
0550++ 8509 DD 36 08 10 PD2_ENV	LD (IX-12+CHP.Env_En),16
0551++ 850D FD 77 22    	LD (IY-100+VRS.AYREGS+EnvTp),A
0552++ 8510 0A          	LD A,(BC)
0553++ 8511 03          	INC BC
0554++ 8512 6F          	LD L,A
0555++ 8513 0A          	LD A,(BC)
0556++ 8514 03          	INC BC
0557++ 8515 67          	LD H,A
0558++ 8516 CD E4 84    	CALL SETENBS
0559++ 8519 18 33       	JR PD2_LOOP
0560++ 851B             
0561++ 851B CD 76 87    PD2_ORN	CALL SETORN
0562++ 851E 18 2E       	JR PD2_LOOP
0563++ 8520             
0564++ 8520 3C          PD2_SKIP INC A
0565++ 8521 DD 77 05    	LD (IX-12+CHP.NNtSkp),A
0566++ 8524 18 28       	JR PD2_LOOP
0567++ 8526             
0568++ 8526 0F          PD2_VOL	RRCA
0569++ 8527 0F          	RRCA
0570++ 8528 0F          	RRCA
0571++ 8529 0F          	RRCA
0572++ 852A DD 77 10    	LD (IX-12+CHP.Volume),A
0573++ 852D 18 1F       	JR PD2_LOOP
0574++ 852F             
0575++ 852F CD 46 87    PD2_DEL	CALL C_DELAY
0576++ 8532 18 1A       	JR PD2_LOOP
0577++ 8534             
0578++ 8534 DD CB 09 D6 PD2_GLIS SET 2,(IX-12+CHP.Flags)
0579++ 8538 3C          	INC A
0580++ 8539 DD 77 0A    	LD (IX-12+CHP.TnSlDl),A
0581++ 853C DD 77 F9    	LD (IX-12+CHP.TSlCnt),A
0582++ 853F 0A          	LD A,(BC)
0583++ 8540 03          	INC BC
0584++ 8541 DD 77 0B            LD (IX-12+CHP.TSlStp),A
0585++ 8544 87          	ADD A,A
0586++ 8545 9F          	SBC A,A
0587++ 8546 DD 77 0C            LD (IX-12+CHP.TSlStp+1),A
0588++ 8549 37          	SCF
0589++ 854A 18 01       	JR PD2_LP2
0590++ 854C             
0591++ 854C A7          PT2PD	AND A
0592++ 854D             
0593++ 854D 08          PD2_LP2	EX AF,AF'
0594++ 854E             
0595++ 854E 0A          PD2_LOOP LD A,(BC)
0596++ 854F 03          	INC BC
0597++ 8550 C6 20       	ADD A,#20
0598++ 8552 28 3F       	JR Z,PD2_REL
0599++ 8554 38 A9       	JR C,PD2_SAM
0600++ 8556 C6 60       	ADD A,96
0601++ 8558 38 3E       	JR C,PD2_NOTE
0602++ 855A 3C          	INC A
0603++ 855B 28 A7       	JR Z,PD2_EOff
0604++ 855D C6 0F       	ADD A,15
0605++ 855F CA 75 86    	JP Z,PD_FIN
0606++ 8562 38 A5       	JR C,PD2_ENV
0607++ 8564 C6 10       	ADD A,#10
0608++ 8566 38 B3       	JR C,PD2_ORN
0609++ 8568 C6 40       	ADD A,#40
0610++ 856A 38 B4       	JR C,PD2_SKIP
0611++ 856C C6 10       	ADD A,#10
0612++ 856E 38 B6       	JR C,PD2_VOL
0613++ 8570 3C          	INC A
0614++ 8571 28 BC       	JR Z,PD2_DEL
0615++ 8573 3C          	INC A
0616++ 8574 28 BE       	JR Z,PD2_GLIS
0617++ 8576 3C          	INC A
0618++ 8577 28 0A       	JR Z,PD2_PORT
0619++ 8579 3C          	INC A
0620++ 857A 28 12       	JR Z,PD2_STOP
0621++ 857C 0A          	LD A,(BC)
0622++ 857D 03          	INC BC
0623++ 857E DD 77 F7    	LD (IX-12+CHP.CrNsSl),A
0624++ 8581 18 CB       	JR PD2_LOOP
0625++ 8583             
0626++ 8583 DD CB 09 96 PD2_PORT RES 2,(IX-12+CHP.Flags)
0627++ 8587 0A          	LD A,(BC)
0628++ 8588 03          	INC BC
0629++ 8589 03          	INC BC ;ignoring precalc delta to right sound
0630++ 858A 03          	INC BC
0631++ 858B 37          	SCF
0632++ 858C 18 BF       	JR PD2_LP2
0633++ 858E             
0634++ 858E DD 77 F9    PD2_STOP LD (IX-12+CHP.TSlCnt),A
0635++ 8591 18 BB       	JR PD2_LOOP
0636++ 8593             
0637++ 8593 DD 77 09    PD2_REL	LD (IX-12+CHP.Flags),A
0638++ 8596 18 2C       	JR PD2_EXIT
0639++ 8598             
0640++ 8598 6F          PD2_NOTE LD L,A
0641++ 8599 DD 7E 06    	LD A,(IX-12+CHP.Note)
0642++ 859C 32 AF 86    	LD (PrNote+1),A
0643++ 859F DD 75 06    	LD (IX-12+CHP.Note),L
0644++ 85A2 AF          	XOR A
0645++ 85A3 DD 77 F9    	LD (IX-12+CHP.TSlCnt),A
0646++ 85A6 DD CB 09 C6 	SET 0,(IX-12+CHP.Flags)
0647++ 85AA 08          	EX AF,AF'
0648++ 85AB 30 16       	JR NC,NOGLIS2
0649++ 85AD DD CB 09 56 	BIT 2,(IX-12+CHP.Flags)
0650++ 85B1 20 0C       	JR NZ,NOPORT2
0651++ 85B3 32 D5 86    	LD (LoStep),A
0652++ 85B6 87          	ADD A,A
0653++ 85B7 9F          	SBC A,A
0654++ 85B8 08          	EX AF,AF'
0655++ 85B9 67          	LD H,A
0656++ 85BA 6F          	LD L,A
0657++ 85BB 3C          	INC A
0658++ 85BC CD 90 86    	CALL SETPORT
0659++ 85BF DD 36 F9 01 NOPORT2	LD (IX-12+CHP.TSlCnt),1
0660++ 85C3 AF          NOGLIS2	XOR A
0661++ 85C4             
0662++ 85C4             
0663++ 85C4 DD 77 F5    PD2_EXIT LD (IX-12+CHP.PsInSm),A
0664++ 85C7 DD 77 F4    	LD (IX-12+CHP.PsInOr),A
0665++ 85CA DD 77 FA    	LD (IX-12+CHP.CrTnSl),A
0666++ 85CD DD 77 FB    	LD (IX-12+CHP.CrTnSl+1),A
0667++ 85D0 C3 75 86    	JP PD_FIN
0668++ 85D3             
0669++ 85D3             ;PT3 pattern decoder
0670++ 85D3 DD 36 08 00 PD_OrSm	LD (IX-12+CHP.Env_En),0
0671++ 85D7 CD 76 87    	CALL SETORN
0672++ 85DA 0A          PD_SAM_	LD A,(BC)
0673++ 85DB 03          	INC BC
0674++ 85DC 0F          	RRCA
0675++ 85DD             
0676++ 85DD CD 95 87    PD_SAM	CALL SETSAM
0677++ 85E0 18 3F       	JR PD_LOOP
0678++ 85E2             
0679++ 85E2 0F          PD_VOL	RRCA
0680++ 85E3 0F          	RRCA
0681++ 85E4 0F          	RRCA
0682++ 85E5 0F          	RRCA
0683++ 85E6 DD 77 10    	LD (IX-12+CHP.Volume),A
0684++ 85E9 18 39       	JR PD_LP2
0685++ 85EB             	
0686++ 85EB DD 77 08    PD_EOff	LD (IX-12+CHP.Env_En),A
0687++ 85EE DD 77 F4    	LD (IX-12+CHP.PsInOr),A
0688++ 85F1 18 31       	JR PD_LP2
0689++ 85F3             
0690++ 85F3 3D          PD_SorE	DEC A
0691++ 85F4 20 07       	JR NZ,PD_ENV
0692++ 85F6 0A          	LD A,(BC)
0693++ 85F7 03          	INC BC
0694++ 85F8 DD 77 05    	LD (IX-12+CHP.NNtSkp),A
0695++ 85FB 18 27       	JR PD_LP2
0696++ 85FD             
0697++ 85FD CD 5B 87    PD_ENV	CALL SETENV
0698++ 8600 18 22       	JR PD_LP2
0699++ 8602             
0700++ 8602 CD 76 87    PD_ORN	CALL SETORN
0701++ 8605 18 1A       	JR PD_LOOP
0702++ 8607             
0703++ 8607 DD 77 08    PD_ESAM	LD (IX-12+CHP.Env_En),A
0704++ 860A DD 77 F4    	LD (IX-12+CHP.PsInOr),A
0705++ 860D C4 5B 87    	CALL NZ,SETENV
0706++ 8610 18 C8       	JR PD_SAM_
0707++ 8612             
0708++ 8612 DD 7E 06    PT3PD	LD A,(IX-12+CHP.Note)
0709++ 8615 32 AF 86    	LD (PrNote+1),A
0710++ 8618 DD 6E FA    	LD L,(IX-12+CHP.CrTnSl)
0711++ 861B DD 66 FB    	LD H,(IX-12+CHP.CrTnSl+1)
0712++ 861E 22 CC 86    	LD (PrSlide+1),HL
0713++ 8621             
0714++ 8621 11 10 20    PD_LOOP	LD DE,#2010
0715++ 8624 0A          PD_LP2	LD A,(BC)
0716++ 8625 03          	INC BC
0717++ 8626 83          	ADD A,E
0718++ 8627 38 AA       	JR C,PD_OrSm
0719++ 8629 82          	ADD A,D
0720++ 862A 28 49       	JR Z,PD_FIN
0721++ 862C 38 AF       	JR C,PD_SAM
0722++ 862E 83          	ADD A,E
0723++ 862F 28 25       	JR Z,PD_REL
0724++ 8631 38 AF       	JR C,PD_VOL
0725++ 8633 83          	ADD A,E
0726++ 8634 28 B5       	JR Z,PD_EOff
0727++ 8636 38 BB       	JR C,PD_SorE
0728++ 8638 C6 60       	ADD A,96
0729++ 863A 38 20       	JR C,PD_NOTE
0730++ 863C 83          	ADD A,E
0731++ 863D 38 C3       	JR C,PD_ORN
0732++ 863F 82          	ADD A,D
0733++ 8640 38 0F       	JR C,PD_NOIS
0734++ 8642 83          	ADD A,E
0735++ 8643 38 C2       	JR C,PD_ESAM
0736++ 8645 87          	ADD A,A
0737++ 8646 5F          	LD E,A
0738++ 8647 21 D1 66    	LD HL,(SPCCOMS+#FF20-#2000)&65535
0739++ 864A 19          	ADD HL,DE
0740++ 864B 5E          	LD E,(HL)
0741++ 864C 23          	INC HL
0742++ 864D 56          	LD D,(HL)
0743++ 864E D5          	PUSH DE
0744++ 864F 18 D0       	JR PD_LOOP
0745++ 8651             
0746++ 8651 FD 77 10    PD_NOIS	LD (IY-100+VRS.Ns_Base),A
0747++ 8654 18 CE       	JR PD_LP2
0748++ 8656             
0749++ 8656 DD CB 09 86 PD_REL	RES 0,(IX-12+CHP.Flags)
0750++ 865A 18 08       	JR PD_RES
0751++ 865C             
0752++ 865C DD 77 06    PD_NOTE	LD (IX-12+CHP.Note),A
0753++ 865F DD CB 09 C6 	SET 0,(IX-12+CHP.Flags)
0754++ 8663 AF          	XOR A
0755++ 8664             
0756++ 8664 ED 73 73 86 PD_RES	LD (PDSP_+1),SP
0757++ 8668 DD F9       	LD SP,IX
0758++ 866A 67          	LD H,A
0759++ 866B 6F          	LD L,A
0760++ 866C E5          	PUSH HL
0761++ 866D E5          	PUSH HL
0762++ 866E E5          	PUSH HL
0763++ 866F E5          	PUSH HL
0764++ 8670 E5          	PUSH HL
0765++ 8671 E5          	PUSH HL
0766++ 8672 31 31 31    PDSP_	LD SP,#3131
0767++ 8675             
0768++ 8675 DD 7E 05    PD_FIN	LD A,(IX-12+CHP.NNtSkp)
0769++ 8678 DD 77 0F    	LD (IX-12+CHP.NtSkCn),A
0770++ 867B C9          	RET
0771++ 867C             
0772++ 867C 0A          C_PORTM LD A,(BC)
0773++ 867D 03          	INC BC
0774++ 867E             ;SKIP PRECALCULATED TONE DELTA (BECAUSE
0775++ 867E             ;CANNOT BE RIGHT AFTER PT3 COMPILATION)
0776++ 867E 03          	INC BC
0777++ 867F 03          	INC BC
0778++ 8680 08          	EX AF,AF'
0779++ 8681 0A          	LD A,(BC) ;SIGNED TONE STEP
0780++ 8682 03          	INC BC
0781++ 8683 32 D5 86    	LD (LoStep),A
0782++ 8686 0A          	LD A,(BC)
0783++ 8687 03          	INC BC
0784++ 8688 A7          	AND A
0785++ 8689 08          	EX AF,AF'
0786++ 868A DD 6E FA    	LD L,(IX-12+CHP.CrTnSl)
0787++ 868D DD 66 FB    	LD H,(IX-12+CHP.CrTnSl+1)
0788++ 8690             
0789++ 8690             ;Set portamento variables
0790++ 8690             ;A - Delay; A' - Hi(Step); ZF' - (A'=0); HL - CrTnSl
0791++ 8690             
0792++ 8690 DD CB 09 96 SETPORT	RES 2,(IX-12+CHP.Flags)
0793++ 8694 DD 77 0A    	LD (IX-12+CHP.TnSlDl),A
0794++ 8697 DD 77 F9    	LD (IX-12+CHP.TSlCnt),A
0795++ 869A E5          	PUSH HL
0796++ 869B 11 5E 8D    	LD DE,NT_
0797++ 869E DD 7E 06    	LD A,(IX-12+CHP.Note)
0798++ 86A1 DD 77 07    	LD (IX-12+CHP.SlToNt),A
0799++ 86A4 87          	ADD A,A
0800++ 86A5 6F          	LD L,A
0801++ 86A6 26 00       	LD H,0
0802++ 86A8 19          	ADD HL,DE
0803++ 86A9 7E          	LD A,(HL)
0804++ 86AA 23          	INC HL
0805++ 86AB 66          	LD H,(HL)
0806++ 86AC 6F          	LD L,A
0807++ 86AD E5          	PUSH HL
0808++ 86AE 3E 3E       PrNote	LD A,#3E
0809++ 86B0 DD 77 06    	LD (IX-12+CHP.Note),A
0810++ 86B3 87          	ADD A,A
0811++ 86B4 6F          	LD L,A
0812++ 86B5 26 00       	LD H,0
0813++ 86B7 19          	ADD HL,DE
0814++ 86B8 5E          	LD E,(HL)
0815++ 86B9 23          	INC HL
0816++ 86BA 56          	LD D,(HL)
0817++ 86BB E1          	POP HL
0818++ 86BC ED 52       	SBC HL,DE
0819++ 86BE DD 75 0D    	LD (IX-12+CHP.TnDelt),L
0820++ 86C1 DD 74 0E    	LD (IX-12+CHP.TnDelt+1),H
0821++ 86C4 D1          	POP DE
0822++ 86C5             Version EQU $+1
0823++ 86C5 3E 3E       	LD A,#3E
0824++ 86C7 FE 06       	CP 6
0825++ 86C9 38 09       	JR C,OLDPRTM ;Old 3xxx for PT v3.5-
0826++ 86CB 11 11 11    PrSlide	LD DE,#1111
0827++ 86CE DD 73 FA    	LD (IX-12+CHP.CrTnSl),E
0828++ 86D1 DD 72 FB    	LD (IX-12+CHP.CrTnSl+1),D
0829++ 86D4             LoStep	EQU $+1
0830++ 86D4 3E 3E       OLDPRTM	LD A,#3E
0831++ 86D6 08          	EX AF,AF'
0832++ 86D7 28 01       	JR Z,NOSIG
0833++ 86D9 EB          	EX DE,HL
0834++ 86DA ED 52       NOSIG	SBC HL,DE
0835++ 86DC F2 E4 86    	JP P,SET_STP
0836++ 86DF 2F          	CPL
0837++ 86E0 08          	EX AF,AF'
0838++ 86E1 ED 44       	NEG
0839++ 86E3 08          	EX AF,AF'
0840++ 86E4 DD 77 0C    SET_STP	LD (IX-12+CHP.TSlStp+1),A
0841++ 86E7 08          	EX AF,AF'
0842++ 86E8 DD 77 0B    	LD (IX-12+CHP.TSlStp),A
0843++ 86EB DD 36 FE 00 	LD (IX-12+CHP.COnOff),0
0844++ 86EF C9          	RET
0845++ 86F0             
0846++ 86F0 DD CB 09 D6 C_GLISS	SET 2,(IX-12+CHP.Flags)
0847++ 86F4 0A          	LD A,(BC)
0848++ 86F5 03          	INC BC
0849++ 86F6 DD 77 0A    	LD (IX-12+CHP.TnSlDl),A
0850++ 86F9 A7          	AND A
0851++ 86FA 20 07       	JR NZ,GL36
0852++ 86FC 3A C6 86    	LD A,(Version) ;AlCo PT3.7+
0853++ 86FF FE 07       	CP 7
0854++ 8701 9F          	SBC A,A
0855++ 8702 3C          	INC A
0856++ 8703 DD 77 F9    GL36	LD (IX-12+CHP.TSlCnt),A
0857++ 8706 0A          	LD A,(BC)
0858++ 8707 03          	INC BC
0859++ 8708 08          	EX AF,AF'
0860++ 8709 0A          	LD A,(BC)
0861++ 870A 03          	INC BC
0862++ 870B 18 D7       	JR SET_STP
0863++ 870D             
0864++ 870D 0A          C_SMPOS	LD A,(BC)
0865++ 870E 03          	INC BC
0866++ 870F DD 77 F5    	LD (IX-12+CHP.PsInSm),A
0867++ 8712 C9          	RET
0868++ 8713             
0869++ 8713 0A          C_ORPOS	LD A,(BC)
0870++ 8714 03          	INC BC
0871++ 8715 DD 77 F4    	LD (IX-12+CHP.PsInOr),A
0872++ 8718 C9          	RET
0873++ 8719             
0874++ 8719 0A          C_VIBRT	LD A,(BC)
0875++ 871A 03          	INC BC
0876++ 871B DD 77 FF    	LD (IX-12+CHP.OnOffD),A
0877++ 871E DD 77 FE    	LD (IX-12+CHP.COnOff),A
0878++ 8721 0A          	LD A,(BC)
0879++ 8722 03          	INC BC
0880++ 8723 DD 77 00    	LD (IX-12+CHP.OffOnD),A
0881++ 8726 AF          	XOR A
0882++ 8727 DD 77 F9    	LD (IX-12+CHP.TSlCnt),A
0883++ 872A DD 77 FA    	LD (IX-12+CHP.CrTnSl),A
0884++ 872D DD 77 FB    	LD (IX-12+CHP.CrTnSl+1),A
0885++ 8730 C9          	RET
0886++ 8731             
0887++ 8731 0A          C_ENGLS	LD A,(BC)
0888++ 8732 03          	INC BC
0889++ 8733 FD 77 0E    	LD (IY-100+VRS.Env_Del),A
0890++ 8736 FD 77 0F    	LD (IY-100+VRS.CurEDel),A
0891++ 8739 0A          	LD A,(BC)
0892++ 873A 03          	INC BC
0893++ 873B 6F          	LD L,A
0894++ 873C 0A          	LD A,(BC)
0895++ 873D 03          	INC BC
0896++ 873E 67          	LD H,A
0897++ 873F FD 75 0A    	LD (IY-100+VRS.ESldAdd),L
0898++ 8742 FD 74 0B    	LD (IY-100+VRS.ESldAdd+1),H
0899++ 8745 C9          	RET
0900++ 8746             
0901++ 8746 0A          C_DELAY	LD A,(BC)
0902++ 8747 03          	INC BC
0903++ 8748 FD 77 08    	LD (IY-100+VRS.Delay),A
0904++ 874B 21 E9 8B    	LD HL,VARS2+VRS.ModNum ;if AlCo_TS
0905++ 874E CB 4E       	BIT 1,(HL)
0906++ 8750 C8          	RET Z
0907++ 8751 32 CC 8B    	LD (VARS1+VRS.Delay),A
0908++ 8754 32 CD 8B    	LD (VARS1+VRS.DelyCnt),A
0909++ 8757 32 53 8C    	LD (VARS2+VRS.Delay),A
0910++ 875A C9          	RET
0911++ 875B             	
0912++ 875B DD 73 08    SETENV	LD (IX-12+CHP.Env_En),E
0913++ 875E FD 77 22    	LD (IY-100+VRS.AYREGS+EnvTp),A
0914++ 8761 0A          	LD A,(BC)
0915++ 8762 03          	INC BC
0916++ 8763 67          	LD H,A
0917++ 8764 0A          	LD A,(BC)
0918++ 8765 03          	INC BC
0919++ 8766 6F          	LD L,A
0920++ 8767 CD E4 84    	CALL SETENBS
0921++ 876A AF          	XOR A
0922++ 876B DD 77 F4    	LD (IX-12+CHP.PsInOr),A
0923++ 876E FD 77 0F    	LD (IY-100+VRS.CurEDel),A
0924++ 8771 67          	LD H,A
0925++ 8772 6F          	LD L,A
0926++ 8773 C3 EB 84    	JP SETESLD
0927++ 8776             
0928++ 8776 87          SETORN	ADD A,A
0929++ 8777 5F          	LD E,A
0930++ 8778 16 00       	LD D,0
0931++ 877A DD 72 F4    	LD (IX-12+CHP.PsInOr),D
0932++ 877D FD 6E F8    	LD L,(IY-100+VRS.OrnPtrs)
0933++ 8780 FD 66 F9    	LD H,(IY-100+VRS.OrnPtrs+1)
0934++ 8783 19          	ADD HL,DE
0935++ 8784 5E          	LD E,(HL)
0936++ 8785 23          	INC HL
0937++ 8786 56          	LD D,(HL)
0938++ 8787 FD 6E F6    	LD L,(IY-100+VRS.MODADDR)
0939++ 878A FD 66 F7    	LD H,(IY-100+VRS.MODADDR+1)
0940++ 878D 19          	ADD HL,DE
0941++ 878E DD 75 01    	LD (IX-12+CHP.OrnPtr),L
0942++ 8791 DD 74 02    	LD (IX-12+CHP.OrnPtr+1),H
0943++ 8794 C9          C_NOP	RET
0944++ 8795             
0945++ 8795 87          SETSAM	ADD A,A
0946++ 8796 5F          	LD E,A
0947++ 8797 16 00       	LD D,0
0948++ 8799 FD 6E FA    	LD L,(IY-100+VRS.SamPtrs);
0949++ 879C FD 66 FB    	LD H,(IY-100+VRS.SamPtrs+1);
0950++ 879F 19          	ADD HL,DE
0951++ 87A0 5E          	LD E,(HL)
0952++ 87A1 23          	INC HL
0953++ 87A2 56          	LD D,(HL)
0954++ 87A3 FD 6E F6    	LD L,(IY-100+VRS.MODADDR)
0955++ 87A6 FD 66 F7    	LD H,(IY-100+VRS.MODADDR+1)
0956++ 87A9 19          	ADD HL,DE
0957++ 87AA DD 75 03    	LD (IX-12+CHP.SamPtr),L
0958++ 87AD DD 74 04    	LD (IX-12+CHP.SamPtr+1),H
0959++ 87B0 C9          	RET
0960++ 87B1             
0961++ 87B1             ;ALL 16 ADDRESSES TO PROTECT FROM BROKEN PT3 MODULES
0962++ 87B1 94 87       SPCCOMS DW C_NOP
0963++ 87B3 F0 86       	DW C_GLISS
0964++ 87B5 7C 86       	DW C_PORTM
0965++ 87B7 0D 87       	DW C_SMPOS
0966++ 87B9 13 87       	DW C_ORPOS
0967++ 87BB 19 87       	DW C_VIBRT
0968++ 87BD 94 87       	DW C_NOP
0969++ 87BF 94 87       	DW C_NOP
0970++ 87C1 31 87       	DW C_ENGLS
0971++ 87C3 46 87       	DW C_DELAY
0972++ 87C5 94 87       	DW C_NOP
0973++ 87C7 94 87       	DW C_NOP
0974++ 87C9 94 87       	DW C_NOP
0975++ 87CB 94 87       	DW C_NOP
0976++ 87CD 94 87       	DW C_NOP
0977++ 87CF 94 87       	DW C_NOP
0978++ 87D1             
0979++ 87D1 CD F2 84    CHREGS	CALL GETIX
0980++ 87D4 AF          	XOR A
0981++ 87D5 32 0E 8A    	LD (Ampl),A
0982++ 87D8 DD CB 15 46 	BIT 0,(IX+CHP.Flags)
0983++ 87DC E5          	PUSH HL
0984++ 87DD CA 24 89    	JP Z,CH_EXIT
0985++ 87E0 ED 73 6E 88 	LD (CSP_+1),SP
0986++ 87E4 DD 6E 0D    	LD L,(IX+CHP.OrnPtr)
0987++ 87E7 DD 66 0E    	LD H,(IX+CHP.OrnPtr+1)
0988++ 87EA F9          	LD SP,HL
0989++ 87EB D1          	POP DE
0990++ 87EC 67          	LD H,A
0991++ 87ED DD 7E 00    	LD A,(IX+CHP.PsInOr)
0992++ 87F0 6F          	LD L,A
0993++ 87F1 39          	ADD HL,SP
0994++ 87F2 3C          	INC A
0995++ 87F3             		;PT2	PT3
0996++ 87F3 3C          OrnCP	INC A	;CP E	CP D
0997++ 87F4 38 01       	JR C,CH_ORPS
0998++ 87F6 01          OrnLD	DB 1	;LD A,D	LD A,E
0999++ 87F7 DD 77 00    CH_ORPS	LD (IX+CHP.PsInOr),A
1000++ 87FA DD 7E 12    	LD A,(IX+CHP.Note)
1001++ 87FD 86          	ADD A,(HL)
1002++ 87FE F2 02 88    	JP P,CH_NTP
1003++ 8801 AF          	XOR A
1004++ 8802 FE 60       CH_NTP	CP 96
1005++ 8804 38 02       	JR C,CH_NOK
1006++ 8806 3E 5F       	LD A,95
1007++ 8808 87          CH_NOK	ADD A,A
1008++ 8809 08          	EX AF,AF'
1009++ 880A DD 6E 0F    	LD L,(IX+CHP.SamPtr)
1010++ 880D DD 66 10    	LD H,(IX+CHP.SamPtr+1)
1011++ 8810 F9          	LD SP,HL
1012++ 8811 D1          	POP DE
1013++ 8812 26 00       	LD H,0
1014++ 8814 DD 7E 01    	LD A,(IX+CHP.PsInSm)
1015++ 8817 47          	LD B,A
1016++ 8818 87          	ADD A,A
1017++ 8819 87          SamClc2	ADD A,A ;or ADD A,B for PT2
1018++ 881A 6F          	LD L,A
1019++ 881B 39          	ADD HL,SP
1020++ 881C F9          	LD SP,HL
1021++ 881D 78          	LD A,B
1022++ 881E 3C          	INC A
1023++ 881F             		;PT2	PT3
1024++ 881F 3C          SamCP	INC A	;CP E	CP D
1025++ 8820 38 01       	JR C,CH_SMPS
1026++ 8822 01          SamLD	DB 1	;LD A,D	LD A,E
1027++ 8823 DD 77 01    CH_SMPS	LD (IX+CHP.PsInSm),A
1028++ 8826 C1          	POP BC
1029++ 8827 E1          	POP HL
1030++ 8828             
1031++ 8828             ;Convert PT2 sample to PT3
1032++ 8828             		;PT2		PT3
1033++ 8828 E1          SamCnv	POP HL  ;BIT 2,C	JR e_
1034++ 8829 E1          	POP HL	
1035++ 882A 60          	LD H,B
1036++ 882B 20 06       	JR NZ,$+8
1037++ 882D EB          	EX DE,HL
1038++ 882E A7          	AND A
1039++ 882F ED 62       	SBC HL,HL
1040++ 8831 ED 52       	SBC HL,DE
1041++ 8833 51          	LD D,C
1042++ 8834 CB 19       	RR C
1043++ 8836 9F          	SBC A,A
1044++ 8837 2F          	CPL
1045++ 8838 E6 3E       	AND #3E
1046++ 883A CB 19       	RR C
1047++ 883C CB 18       	RR B
1048++ 883E A1          	AND C
1049++ 883F 4F          	LD C,A
1050++ 8840 78          	LD A,B
1051++ 8841 1F          	RRA
1052++ 8842 1F          	RRA
1053++ 8843 CB 1A       	RR D
1054++ 8845 1F          	RRA
1055++ 8846 E6 9F       	AND #9F
1056++ 8848 47          	LD B,A
1057++ 8849             
1058++ 8849 DD 5E 08    e_	LD E,(IX+CHP.TnAcc)
1059++ 884C DD 56 09    	LD D,(IX+CHP.TnAcc+1)
1060++ 884F 19          	ADD HL,DE
1061++ 8850 CB 70       	BIT 6,B
1062++ 8852 28 06       	JR Z,CH_NOAC
1063++ 8854 DD 75 08    	LD (IX+CHP.TnAcc),L
1064++ 8857 DD 74 09    	LD (IX+CHP.TnAcc+1),H
1065++ 885A EB          CH_NOAC EX DE,HL
1066++ 885B 08          	EX AF,AF'
1067++ 885C C6 5E       	ADD A,NT_&255
1068++ 885E 6F          	LD L,A
1069++ 885F CE 8D       	ADC A,NT_/256
1070++ 8861 95          	SUB L
1071++ 8862 67          	LD H,A
1072++ 8863 F9          	LD SP,HL
1073++ 8864 E1          	POP HL
1074++ 8865 19          	ADD HL,DE
1075++ 8866 DD 5E 06    	LD E,(IX+CHP.CrTnSl)
1076++ 8869 DD 56 07    	LD D,(IX+CHP.CrTnSl+1)
1077++ 886C 19          	ADD HL,DE
1078++ 886D 31 31 31    CSP_	LD SP,#3131
1079++ 8870 E3          	EX (SP),HL
1080++ 8871 AF          	XOR A
1081++ 8872 DD B6 05    	OR (IX+CHP.TSlCnt)
1082++ 8875 28 3E       	JR Z,CH_AMP
1083++ 8877 DD 35 05    	DEC (IX+CHP.TSlCnt)
1084++ 887A 20 39       	JR NZ,CH_AMP
1085++ 887C DD 7E 16    	LD A,(IX+CHP.TnSlDl)
1086++ 887F DD 77 05    	LD (IX+CHP.TSlCnt),A
1087++ 8882 DD 6E 17    	LD L,(IX+CHP.TSlStp)
1088++ 8885 DD 66 18    	LD H,(IX+CHP.TSlStp+1)
1089++ 8888 7C          	LD A,H
1090++ 8889 19          	ADD HL,DE
1091++ 888A DD 75 06    	LD (IX+CHP.CrTnSl),L
1092++ 888D DD 74 07    	LD (IX+CHP.CrTnSl+1),H
1093++ 8890 DD CB 15 56 	BIT 2,(IX+CHP.Flags)
1094++ 8894 20 1F       	JR NZ,CH_AMP
1095++ 8896 DD 5E 19    	LD E,(IX+CHP.TnDelt)
1096++ 8899 DD 56 1A    	LD D,(IX+CHP.TnDelt+1)
1097++ 889C A7          	AND A
1098++ 889D 28 01       	JR Z,CH_STPP
1099++ 889F EB          	EX DE,HL
1100++ 88A0 ED 52       CH_STPP SBC HL,DE
1101++ 88A2 FA B5 88    	JP M,CH_AMP
1102++ 88A5 DD 7E 13    	LD A,(IX+CHP.SlToNt)
1103++ 88A8 DD 77 12    	LD (IX+CHP.Note),A
1104++ 88AB AF          	XOR A
1105++ 88AC DD 77 05    	LD (IX+CHP.TSlCnt),A
1106++ 88AF DD 77 06    	LD (IX+CHP.CrTnSl),A
1107++ 88B2 DD 77 07    	LD (IX+CHP.CrTnSl+1),A
1108++ 88B5 DD 7E 02    CH_AMP	LD A,(IX+CHP.CrAmSl)
1109++ 88B8 CB 79       	BIT 7,C
1110++ 88BA 28 13       	JR Z,CH_NOAM
1111++ 88BC CB 71       	BIT 6,C
1112++ 88BE 28 07       	JR Z,CH_AMIN
1113++ 88C0 FE 0F       	CP 15
1114++ 88C2 28 0B       	JR Z,CH_NOAM
1115++ 88C4 3C          	INC A
1116++ 88C5 18 05       	JR CH_SVAM
1117++ 88C7 FE F1       CH_AMIN	CP -15
1118++ 88C9 28 04       	JR Z,CH_NOAM
1119++ 88CB 3D          	DEC A
1120++ 88CC DD 77 02    CH_SVAM	LD (IX+CHP.CrAmSl),A
1121++ 88CF 6F          CH_NOAM	LD L,A
1122++ 88D0 78          	LD A,B
1123++ 88D1 E6 0F       	AND 15
1124++ 88D3 85          	ADD A,L
1125++ 88D4 F2 D8 88    	JP P,CH_APOS
1126++ 88D7 AF          	XOR A
1127++ 88D8 FE 10       CH_APOS	CP 16
1128++ 88DA 38 02       	JR C,CH_VOL
1129++ 88DC 3E 0F       	LD A,15
1130++ 88DE DD B6 1C    CH_VOL	OR (IX+CHP.Volume)
1131++ 88E1 C6 5E       	ADD A,VT_&255
1132++ 88E3 6F          	LD L,A
1133++ 88E4 CE 8C       	ADC A,VT_/256
1134++ 88E6 95          	SUB L
1135++ 88E7 67          	LD H,A
1136++ 88E8 7E          	LD A,(HL)
1137++ 88E9 CB 41       CH_ENV	BIT 0,C
1138++ 88EB 20 03       	JR NZ,CH_NOEN
1139++ 88ED DD B6 14    	OR (IX+CHP.Env_En)
1140++ 88F0 32 0E 8A    CH_NOEN	LD (Ampl),A
1141++ 88F3 CB 78       	BIT 7,B
1142++ 88F5 79          	LD A,C
1143++ 88F6 28 1A       	JR Z,NO_ENSL
1144++ 88F8 17          	RLA
1145++ 88F9 17          	RLA
1146++ 88FA CB 2F       	SRA A
1147++ 88FC CB 2F       	SRA A
1148++ 88FE CB 2F       	SRA A
1149++ 8900 DD 86 04    	ADD A,(IX+CHP.CrEnSl) ;SEE COMMENT BELOW
1150++ 8903 CB 68       	BIT 5,B
1151++ 8905 28 03       	JR Z,NO_ENAC
1152++ 8907 DD 77 04    	LD (IX+CHP.CrEnSl),A
1153++ 890A FD 86 12    NO_ENAC	ADD A,(IY-100+VRS.AddToEn) ;BUG IN PT3 - NEED WORD HERE
1154++ 890D FD 77 12    	LD (IY-100+VRS.AddToEn),A
1155++ 8910 18 0E       	JR CH_MIX
1156++ 8912 1F          NO_ENSL RRA
1157++ 8913 DD 86 03    	ADD A,(IX+CHP.CrNsSl)
1158++ 8916 FD 77 11    	LD (IY-100+VRS.AddToNs),A
1159++ 8919 CB 68       	BIT 5,B
1160++ 891B 28 03       	JR Z,CH_MIX
1161++ 891D DD 77 03    	LD (IX+CHP.CrNsSl),A
1162++ 8920 78          CH_MIX	LD A,B
1163++ 8921 1F          	RRA
1164++ 8922 E6 48       	AND #48
1165++ 8924 FD B6 1C    CH_EXIT	OR (IY-100+VRS.AYREGS+Mixer)
1166++ 8927 0F          	RRCA
1167++ 8928 FD 77 1C    	LD (IY-100+VRS.AYREGS+Mixer),A
1168++ 892B E1          	POP HL
1169++ 892C AF          	XOR A
1170++ 892D DD B6 0A    	OR (IX+CHP.COnOff)
1171++ 8930 C8          	RET Z
1172++ 8931 DD 35 0A    	DEC (IX+CHP.COnOff)
1173++ 8934 C0          	RET NZ
1174++ 8935 DD AE 15    	XOR (IX+CHP.Flags)
1175++ 8938 DD 77 15    	LD (IX+CHP.Flags),A
1176++ 893B 1F          	RRA
1177++ 893C DD 7E 0B    	LD A,(IX+CHP.OnOffD)
1178++ 893F 38 03       	JR C,CH_ONDL
1179++ 8941 DD 7E 0C    	LD A,(IX+CHP.OffOnD)
1180++ 8944 DD 77 0A    CH_ONDL	LD (IX+CHP.COnOff),A
1181++ 8947 C9          	RET
1182++ 8948             
1183++ 8948 AF          PLAY_	XOR A
1184++ 8949 FD 77 12    	LD (IY-100+VRS.AddToEn),A
1185++ 894C FD 77 1C    	LD (IY-100+VRS.AYREGS+Mixer),A
1186++ 894F 3D          	DEC A
1187++ 8950 FD 77 22    	LD (IY-100+VRS.AYREGS+EnvTp),A
1188++ 8953 FD 35 09    	DEC (IY-100+VRS.DelyCnt)
1189++ 8956 C2 FB 89    	JP NZ,PL2
1190++ 8959 FD 35 BA    	DEC (IY-100+VRS.ChanA+CHP.NtSkCn)
1191++ 895C 20 69       	JR NZ,PL1B
1192++ 895E FD 4E FE    	LD C,(IY-100+VRS.AdInPtA)
1193++ 8961 FD 46 FF    	LD B,(IY-100+VRS.AdInPtA+1)
1194++ 8964 0A          	LD A,(BC)
1195++ 8965 A7          	AND A
1196++ 8966 20 53       	JR NZ,PL1A
1197++ 8968 57          	LD D,A
1198++ 8969 FD 77 10    	LD (IY-100+VRS.Ns_Base),A
1199++ 896C FD 6E 04    	LD L,(IY-100+VRS.CrPsPtr)
1200++ 896F FD 66 05    	LD H,(IY-100+VRS.CrPsPtr+1)
1201++ 8972 23          	INC HL
1202++ 8973 7E          	LD A,(HL)
1203++ 8974 3C          	INC A
1204++ 8975 20 08       	JR NZ,PLNLP
1205++ 8977             
1206++ 8977             	IF LoopChecker
1207++ 8977~            	CALL CHECKLP
1208++ 8977             	ENDIF
1209++ 8977             
1210++ 8977 FD 6E 06    	LD L,(IY-100+VRS.LPosPtr)
1211++ 897A FD 66 07    	LD H,(IY-100+VRS.LPosPtr+1)
1212++ 897D 7E          	LD A,(HL)
1213++ 897E 3C          	INC A
1214++ 897F CD D6 84    PLNLP	CALL SETCPPT
1215++ 8982 3D          	DEC A
1216++ 8983 FD CB 9E 4E 	BIT 1,(IY-100+VRS.ModNum)
1217++ 8987 28 03       	JR Z,NoAlCo
1218++ 8989             TSSub	EQU $+1
1219++ 8989 D6 D6       	SUB #D6
1220++ 898B 2F          	CPL
1221++ 898C             NoAlCo
1222++ 898C             		;PT2		PT3
1223++ 898C 3D          PsCalc	DEC A	;ADD A,A	NOP
1224++ 898D 3D          	DEC A	;ADD A,(HL)	NOP
1225++ 898E 87          	ADD A,A
1226++ 898F 5F          	LD E,A
1227++ 8990 CB 12       	RL D
1228++ 8992             
1229++ 8992             	IF CurPosCounter
1230++ 8992~            	LD A,L
1231++ 8992~            	SUB (IY-100+VRS.PosSub)
1232++ 8992~            	LD (IY-100+VRS.CurPos),A
1233++ 8992             	ENDIF
1234++ 8992             
1235++ 8992 FD 6E FC    	LD L,(IY-100+VRS.PatsPtr)
1236++ 8995 FD 66 FD    	LD H,(IY-100+VRS.PatsPtr+1)
1237++ 8998 19          	ADD HL,DE
1238++ 8999 FD 5E F6    	LD E,(IY-100+VRS.MODADDR)
1239++ 899C FD 56 F7    	LD D,(IY-100+VRS.MODADDR+1)
1240++ 899F ED 73 B9 89 	LD (PSP_+1),SP
1241++ 89A3 F9          	LD SP,HL
1242++ 89A4 E1          	POP HL
1243++ 89A5 19          	ADD HL,DE
1244++ 89A6 44          	LD B,H
1245++ 89A7 4D          	LD C,L
1246++ 89A8 E1          	POP HL
1247++ 89A9 19          	ADD HL,DE
1248++ 89AA FD 75 00    	LD (IY-100+VRS.AdInPtB),L
1249++ 89AD FD 74 01    	LD (IY-100+VRS.AdInPtB+1),H
1250++ 89B0 E1          	POP HL
1251++ 89B1 19          	ADD HL,DE
1252++ 89B2 FD 75 02    	LD (IY-100+VRS.AdInPtC),L
1253++ 89B5 FD 74 03    	LD (IY-100+VRS.AdInPtC+1),H
1254++ 89B8 31 31 31    PSP_	LD SP,#3131
1255++ 89BB 11 AB FF    PL1A	LD DE,VRS.ChanA+12-100
1256++ 89BE CD F9 84    	CALL PTDECOD
1257++ 89C1 FD 71 FE    	LD (IY-100+VRS.AdInPtA),C
1258++ 89C4 FD 70 FF    	LD (IY-100+VRS.AdInPtA+1),B
1259++ 89C7             
1260++ 89C7 FD 35 D7    PL1B	DEC (IY-100+VRS.ChanB+CHP.NtSkCn)
1261++ 89CA 20 12       	JR NZ,PL1C
1262++ 89CC 11 C8 FF    	LD DE,VRS.ChanB+12-100
1263++ 89CF FD 4E 00    	LD C,(IY-100+VRS.AdInPtB)
1264++ 89D2 FD 46 01    	LD B,(IY-100+VRS.AdInPtB+1)
1265++ 89D5 CD F9 84    	CALL PTDECOD
1266++ 89D8 FD 71 00    	LD (IY-100+VRS.AdInPtB),C
1267++ 89DB FD 70 01    	LD (IY-100+VRS.AdInPtB+1),B
1268++ 89DE             
1269++ 89DE FD 35 F4    PL1C	DEC (IY-100+VRS.ChanC+CHP.NtSkCn)
1270++ 89E1 20 12       	JR NZ,PL1D
1271++ 89E3 11 E5 FF    	LD DE,VRS.ChanC+12-100
1272++ 89E6 FD 4E 02    	LD C,(IY-100+VRS.AdInPtC)
1273++ 89E9 FD 46 03    	LD B,(IY-100+VRS.AdInPtC+1)
1274++ 89EC CD F9 84    	CALL PTDECOD
1275++ 89EF FD 71 02    	LD (IY-100+VRS.AdInPtC),C
1276++ 89F2 FD 70 03    	LD (IY-100+VRS.AdInPtC+1),B
1277++ 89F5             
1278++ 89F5 FD 7E 08    PL1D	LD A,(IY-100+VRS.Delay)
1279++ 89F8 FD 77 09    	LD (IY-100+VRS.DelyCnt),A
1280++ 89FB             
1281++ 89FB 11 9F FF    PL2	LD DE,VRS.ChanA-100
1282++ 89FE FD 6E 15    	LD L,(IY-100+VRS.AYREGS+TonA)
1283++ 8A01 FD 66 16    	LD H,(IY-100+VRS.AYREGS+TonA+1)
1284++ 8A04 CD D1 87    	CALL CHREGS
1285++ 8A07 FD 75 15    	LD (IY-100+VRS.AYREGS+TonA),L
1286++ 8A0A FD 74 16    	LD (IY-100+VRS.AYREGS+TonA+1),H
1287++ 8A0D             Ampl	EQU $+1
1288++ 8A0D 3E 3E       	LD A,#3E
1289++ 8A0F FD 77 1D    	LD (IY-100+VRS.AYREGS+AmplA),A
1290++ 8A12 11 BC FF    	LD DE,VRS.ChanB-100
1291++ 8A15 FD 6E 17    	LD L,(IY-100+VRS.AYREGS+TonB)
1292++ 8A18 FD 66 18    	LD H,(IY-100+VRS.AYREGS+TonB+1)
1293++ 8A1B CD D1 87    	CALL CHREGS
1294++ 8A1E FD 75 17    	LD (IY-100+VRS.AYREGS+TonB),L
1295++ 8A21 FD 74 18    	LD (IY-100+VRS.AYREGS+TonB+1),H
1296++ 8A24 3A 0E 8A    	LD A,(Ampl)
1297++ 8A27 FD 77 1E    	LD (IY-100+VRS.AYREGS+AmplB),A
1298++ 8A2A 11 D9 FF    	LD DE,VRS.ChanC-100
1299++ 8A2D FD 6E 19    	LD L,(IY-100+VRS.AYREGS+TonC)
1300++ 8A30 FD 66 1A    	LD H,(IY-100+VRS.AYREGS+TonC+1)
1301++ 8A33 CD D1 87    	CALL CHREGS
1302++ 8A36 FD 75 19    	LD (IY-100+VRS.AYREGS+TonC),L
1303++ 8A39 FD 74 1A    	LD (IY-100+VRS.AYREGS+TonC+1),H
1304++ 8A3C 3A 0E 8A    	LD A,(Ampl)
1305++ 8A3F FD 77 1F    	LD (IY-100+VRS.AYREGS+AmplC),A
1306++ 8A42             
1307++ 8A42 FD 7E 10    	LD A,(IY-100+VRS.Ns_Base)
1308++ 8A45 FD 86 11    	ADD (IY-100+VRS.AddToNs)
1309++ 8A48 FD 77 1B    	LD (IY-100+VRS.AYREGS+Noise),A
1310++ 8A4B             
1311++ 8A4B FD 7E 12    	LD A,(IY-100+VRS.AddToEn)
1312++ 8A4E 5F          	LD E,A
1313++ 8A4F 87          	ADD A,A
1314++ 8A50 9F          	SBC A,A
1315++ 8A51 57          	LD D,A
1316++ 8A52 FD 6E 13    	LD L,(IY-100+VRS.EnvBase)
1317++ 8A55 FD 66 14    	LD H,(IY-100+VRS.EnvBase+1)
1318++ 8A58 19          	ADD HL,DE
1319++ 8A59 FD 5E 0C    	LD E,(IY-100+VRS.CurESld)
1320++ 8A5C FD 56 0D    	LD D,(IY-100+VRS.CurESld+1)
1321++ 8A5F 19          	ADD HL,DE
1322++ 8A60 FD 75 20    	LD (IY-100+VRS.AYREGS+Env),L
1323++ 8A63 FD 74 21    	LD (IY-100+VRS.AYREGS+Env+1),H
1324++ 8A66             
1325++ 8A66 AF          	XOR A
1326++ 8A67 FD B6 0F    	OR (IY-100+VRS.CurEDel)
1327++ 8A6A C8          	RET Z
1328++ 8A6B FD 35 0F    	DEC (IY-100+VRS.CurEDel)
1329++ 8A6E C0          	RET NZ
1330++ 8A6F FD 7E 0E    	LD A,(IY-100+VRS.Env_Del)
1331++ 8A72 FD 77 0F    	LD (IY-100+VRS.CurEDel),A
1332++ 8A75 FD 6E 0A    	LD L,(IY-100+VRS.ESldAdd)
1333++ 8A78 FD 66 0B    	LD H,(IY-100+VRS.ESldAdd+1)
1334++ 8A7B 19          	ADD HL,DE
1335++ 8A7C C3 EB 84    	JP SETESLD
1336++ 8A7F             
1337++ 8A7F FD 21 C4 8B PLAY    LD IY,VARS1+100
1338++ 8A83 CD 48 89    	CALL PLAY_
1339++ 8A86 3A 5F 8B    	LD A,(is_ts)
1340++ 8A89 A7          	AND A
1341++ 8A8A 28 07       	JR Z,PL_nts
1342++ 8A8C FD 21 4B 8C 	LD IY,VARS2+100
1343++ 8A90 CD 48 89    	CALL PLAY_
1344++ 8A93             PL_nts
1345++ 8A93             	IF Basic
1346++ 8A93~            	LD IY,#5C3A
1347++ 8A93             	ENDIF
1348++ 8A93             
1349++ 8A93 01 FD FF    ROUT	LD BC,#FFFD
1350++ 8A96               IFDEF ONtfm
1351++ 8A96 2E F9           LD L,#F9
1352++ 8A98 ED 69           OUT (C),L
1353++ 8A9A               ELSE
1354++ 8A9A~            	LD A,(is_ts)
1355++ 8A9A~            	AND A
1356++ 8A9A~            	JR Z,r_nts ;keep old standard
1357++ 8A9A~            	OUT (C),B
1358++ 8A9A                 ENDIF
1359++ 8A9A 08          r_nts	EX AF,AF'
1360++ 8A9B             
1361++ 8A9B             	IF ACBBAC
1362++ 8A9B~            	LD IX,VARS1+VRS.AYREGS
1363++ 8A9B             	ELSE
1364++ 8A9B 21 D9 8B    	LD HL,VARS1+VRS.AYREGS
1365++ 8A9E             	ENDIF
1366++ 8A9E             
1367++ 8A9E CD AB 8A    	CALL ROUT_
1368++ 8AA1 08          	EX AF,AF'
1369++ 8AA2 C8          	RET Z
1370++ 8AA3 42          	LD B,D
1371++ 8AA4             
1372++ 8AA4                 IFDEF ONtfm
1373++ 8AA4 3E F8           LD A,#F8
1374++ 8AA6                 ELSE
1375++ 8AA6~            	CPL
1376++ 8AA6                 ENDIF
1377++ 8AA6 ED 79       	OUT (C),A
1378++ 8AA8             
1379++ 8AA8             	IF ACBBAC
1380++ 8AA8~            	LD IX,VARS2+VRS.AYREGS
1381++ 8AA8             	ELSE
1382++ 8AA8 21 60 8C    	LD HL,VARS2+VRS.AYREGS
1383++ 8AAB             	ENDIF
1384++ 8AAB             
1385++ 8AAB             ROUT_
1386++ 8AAB             	IF ACBBAC
1387++ 8AAB~            	LD A,(SETUP)
1388++ 8AAB~            	AND 12
1389++ 8AAB~            	JR Z,ABC
1390++ 8AAB~            	ADD A,CHTABLE
1391++ 8AAB~            	LD E,A
1392++ 8AAB~            	ADC A,CHTABLE/256
1393++ 8AAB~            	SUB E
1394++ 8AAB~            	LD D,A
1395++ 8AAB~            	LD B,0
1396++ 8AAB~            	PUSH IX
1397++ 8AAB~            	POP HL
1398++ 8AAB~            	LD A,(DE)
1399++ 8AAB~            	INC DE
1400++ 8AAB~            	LD C,A
1401++ 8AAB~            	ADD HL,BC
1402++ 8AAB~            	LD A,(IX+TonB)
1403++ 8AAB~            	LD C,(HL)
1404++ 8AAB~            	LD (IX+TonB),C
1405++ 8AAB~            	LD (HL),A
1406++ 8AAB~            	INC HL
1407++ 8AAB~            	LD A,(IX+TonB+1)
1408++ 8AAB~            	LD C,(HL)
1409++ 8AAB~            	LD (IX+TonB+1),C
1410++ 8AAB~            	LD (HL),A
1411++ 8AAB~            	LD A,(DE)
1412++ 8AAB~            	INC DE
1413++ 8AAB~            	LD C,A
1414++ 8AAB~            	ADD HL,BC
1415++ 8AAB~            	LD A,(IX+AmplB)
1416++ 8AAB~            	LD C,(HL)
1417++ 8AAB~            	LD (IX+AmplB),C
1418++ 8AAB~            	LD (HL),A
1419++ 8AAB~            	LD A,(DE)
1420++ 8AAB~            	INC DE
1421++ 8AAB~            	LD (RxCA1),A
1422++ 8AAB~            	XOR 8
1423++ 8AAB~            	LD (RxCA2),A
1424++ 8AAB~            	LD A,(DE)
1425++ 8AAB~            	AND (IX+Mixer)
1426++ 8AAB~            	LD E,A
1427++ 8AAB~            	LD A,(IX+Mixer)
1428++ 8AAB~            RxCA1	DB #E6
1429++ 8AAB~            	AND %010010
1430++ 8AAB~            	OR E
1431++ 8AAB~            	LD E,A
1432++ 8AAB~            	LD A,(IX+Mixer)
1433++ 8AAB~            	AND %010010
1434++ 8AAB~            RxCA2	OR E
1435++ 8AAB~            	OR E
1436++ 8AAB~            	LD (IX+Mixer),A
1437++ 8AAB~            ABC
1438++ 8AAB             	ENDIF
1439++ 8AAB             
1440++ 8AAB AF          	XOR A
1441++ 8AAC 11 BF FF    	LD DE,#FFBF
1442++ 8AAF             
1443++ 8AAF             	IF ACBBAC
1444++ 8AAF~            	LD BC,#FFFD
1445++ 8AAF~            	PUSH IX
1446++ 8AAF~            	POP HL
1447++ 8AAF             	ENDIF
1448++ 8AAF             
1449++ 8AAF             LOUT
1450++ 8AAF                 IFDEF ONtfm
1451++ 8AAF ED 70           INF 
1452++ 8AB1 FA AF 8A        JP M,$-2
1453++ 8AB4                 ENDIF 
1454++ 8AB4 ED 79           OUT (C),A
1455++ 8AB6                 IFDEF ONtfm
1456++ 8AB6 ED 70           INF 
1457++ 8AB8 FA B6 8A        JP M,$-2
1458++ 8ABB                 ENDIF 
1459++ 8ABB 43          	LD B,E
1460++ 8ABC ED A3       	OUTI 
1461++ 8ABE 42          	LD B,D
1462++ 8ABF 3C          	INC A
1463++ 8AC0 FE 0D       	CP 13
1464++ 8AC2 20 EB       	JR NZ,LOUT
1465++ 8AC4                 IFDEF ONtfm
1466++ 8AC4 ED 70           INF 
1467++ 8AC6 FA C4 8A        JP M,$-2
1468++ 8AC9                 ENDIF 
1469++ 8AC9 ED 79       	OUT (C),A
1470++ 8ACB 7E          	LD A,(HL)
1471++ 8ACC A7          	AND A
1472++ 8ACD F8          	RET M
1473++ 8ACE                 IFDEF ONtfm
1474++ 8ACE ED 70           INF 
1475++ 8AD0 FA CE 8A        JP M,$-2
1476++ 8AD3                 ENDIF 
1477++ 8AD3 43          	LD B,E
1478++ 8AD4 ED 79       	OUT (C),A
1479++ 8AD6 C9          	RET
1480++ 8AD7             
1481++ 8AD7             	IF ACBBAC
1482++ 8AD7~            CHTABLE	EQU $-4
1483++ 8AD7~            	DB 4,5,15,%001001,0,7,7,%100100
1484++ 8AD7             	ENDIF
1485++ 8AD7             
1486++ 8AD7 64          NT_DATA	DB (T_NEW_0-T1_)*2
1487++ 8AD8 2A          	DB TCNEW_0-T_
1488++ 8AD9 65          	DB (T_OLD_0-T1_)*2+1
1489++ 8ADA 00          	DB TCOLD_0-T_
1490++ 8ADB 01          	DB (T_NEW_1-T1_)*2+1
1491++ 8ADC 0C          	DB TCNEW_1-T_
1492++ 8ADD 01          	DB (T_OLD_1-T1_)*2+1
1493++ 8ADE 0C          	DB TCOLD_1-T_
1494++ 8ADF 94          	DB (T_NEW_2-T1_)*2
1495++ 8AE0 35          	DB TCNEW_2-T_
1496++ 8AE1 30          	DB (T_OLD_2-T1_)*2
1497++ 8AE2 0E          	DB TCOLD_2-T_
1498++ 8AE3 60          	DB (T_NEW_3-T1_)*2
1499++ 8AE4 20          	DB TCNEW_3-T_
1500++ 8AE5 60          	DB (T_OLD_3-T1_)*2
1501++ 8AE6 21          	DB TCOLD_3-T_
1502++ 8AE7             
1503++ 8AE7             T_
1504++ 8AE7             
1505++ 8AE7             TCOLD_0	DB #00+1,#04+1,#08+1,#0A+1,#0C+1,#0E+1,#12+1,#14+1
1505++ 8AE7 0105090B0D0F1315
1506++ 8AEF 19 25 3D 00 	DB #18+1,#24+1,#3C+1,0
1507++ 8AF3 5D 00       TCOLD_1	DB #5C+1,0
1508++ 8AF5             TCOLD_2	DB #30+1,#36+1,#4C+1,#52+1,#5E+1,#70+1,#82,#8C,#9C
1508++ 8AF5 31374D535F71828C9C
1509++ 8AFE             	DB #9E,#A0,#A6,#A8,#AA,#AC,#AE,#AE,0
1509++ 8AFE 9EA0A6A8AAACAEAE00
1510++ 8B07 57          TCNEW_3	DB #56+1
1511++ 8B08             TCOLD_3	DB #1E+1,#22+1,#24+1,#28+1,#2C+1,#2E+1,#32+1,#BE+1,0
1511++ 8B08 1F2325292D2F33BF00
1512++ 8B11             TCNEW_0	DB #1C+1,#20+1,#22+1,#26+1,#2A+1,#2C+1,#30+1,#54+1
1512++ 8B11 1D2123272B2D3155
1513++ 8B19 BD BF 00    	DB #BC+1,#BE+1,0
1514++ 8B1C             TCNEW_1 EQU TCOLD_1
1515++ 8B1C             TCNEW_2	DB #1A+1,#20+1,#24+1,#28+1,#2A+1,#3A+1,#4C+1,#5E+1
1515++ 8B1C 1B2125292B3B4D5F
1516++ 8B24 BB BD BF 00 	DB #BA+1,#BC+1,#BE+1,0
1517++ 8B28             
1518++ 8B28             PT3EMPTYORN EQU $-1
1519++ 8B28 01 00       	DB 1,0
1520++ 8B2A             
1521++ 8B2A             ;first 12 values of tone tables (packed)
1522++ 8B2A             
1523++ 8B2A 0D D8       T_PACK	DB #06EC*2/256,#06EC*2&255
1524++ 8B2C 69          	DB #0755-#06EC
1525++ 8B2D 70          	DB #07C5-#0755
1526++ 8B2E 76          	DB #083B-#07C5
1527++ 8B2F 7D          	DB #08B8-#083B
1528++ 8B30 85          	DB #093D-#08B8
1529++ 8B31 8D          	DB #09CA-#093D
1530++ 8B32 95          	DB #0A5F-#09CA
1531++ 8B33 9D          	DB #0AFC-#0A5F
1532++ 8B34 A8          	DB #0BA4-#0AFC
1533++ 8B35 B1          	DB #0C55-#0BA4
1534++ 8B36 BB          	DB #0D10-#0C55
1535++ 8B37 0C DA       	DB #066D*2/256,#066D*2&255
1536++ 8B39 62          	DB #06CF-#066D
1537++ 8B3A 68          	DB #0737-#06CF
1538++ 8B3B 6D          	DB #07A4-#0737
1539++ 8B3C 75          	DB #0819-#07A4
1540++ 8B3D 7B          	DB #0894-#0819
1541++ 8B3E 83          	DB #0917-#0894
1542++ 8B3F 8A          	DB #09A1-#0917
1543++ 8B40 92          	DB #0A33-#09A1
1544++ 8B41 9C          	DB #0ACF-#0A33
1545++ 8B42 A4          	DB #0B73-#0ACF
1546++ 8B43 AF          	DB #0C22-#0B73
1547++ 8B44 B8          	DB #0CDA-#0C22
1548++ 8B45 0E 08       	DB #0704*2/256,#0704*2&255
1549++ 8B47 6A          	DB #076E-#0704
1550++ 8B48 72          	DB #07E0-#076E
1551++ 8B49 78          	DB #0858-#07E0
1552++ 8B4A 7E          	DB #08D6-#0858
1553++ 8B4B 86          	DB #095C-#08D6
1554++ 8B4C 90          	DB #09EC-#095C
1555++ 8B4D 96          	DB #0A82-#09EC
1556++ 8B4E A0          	DB #0B22-#0A82
1557++ 8B4F AA          	DB #0BCC-#0B22
1558++ 8B50 B4          	DB #0C80-#0BCC
1559++ 8B51 BE          	DB #0D3E-#0C80
1560++ 8B52 0F C0       	DB #07E0*2/256,#07E0*2&255
1561++ 8B54 78          	DB #0858-#07E0
1562++ 8B55 88          	DB #08E0-#0858
1563++ 8B56 80          	DB #0960-#08E0
1564++ 8B57 90          	DB #09F0-#0960
1565++ 8B58 98          	DB #0A88-#09F0
1566++ 8B59 A0          	DB #0B28-#0A88
1567++ 8B5A B0          	DB #0BD8-#0B28
1568++ 8B5B A8          	DB #0C80-#0BD8
1569++ 8B5C E0          	DB #0D60-#0C80
1570++ 8B5D B0          	DB #0E10-#0D60
1571++ 8B5E E8          	DB #0EF8-#0E10
1572++ 8B5F             
1573++ 8B5F             ;vars from here can be stripped
1574++ 8B5F             ;you can move VARS to any other address
1575++ 8B5F             
1576++ 8B5F             VARS
1577++ 8B5F             
1578++ 8B5F 00          is_ts	DB 0
1579++ 8B60             
1580++ 8B60             ;ChannelsVars
1581++ 8B60             	STRUCT	CHP
1582++ 8B60~            ;reset group
1583++ 8B60~            PsInOr	DB 0
1584++ 8B60~            PsInSm	DB 0
1585++ 8B60~            CrAmSl	DB 0
1586++ 8B60~            CrNsSl	DB 0
1587++ 8B60~            CrEnSl	DB 0
1588++ 8B60~            TSlCnt	DB 0
1589++ 8B60~            CrTnSl	DW 0
1590++ 8B60~            TnAcc	DW 0
1591++ 8B60~            COnOff	DB 0
1592++ 8B60~            ;reset group
1593++ 8B60~            1594++ 8B60~            OnOffD	DB 0
1595++ 8B60~            1596++ 8B60~            ;IX for PTDECOD here (+12)
1597++ 8B60~            OffOnD	DB 0
1598++ 8B60~            OrnPtr	DW 0
1599++ 8B60~            SamPtr	DW 0
1600++ 8B60~            NNtSkp	DB 0
1601++ 8B60~            Note	DB 0
1602++ 8B60~            SlToNt	DB 0
1603++ 8B60~            Env_En	DB 0
1604++ 8B60~            Flags	DB 0
1605++ 8B60~             ;Enabled - 0, SimpleGliss - 2
1606++ 8B60~            TnSlDl	DB 0
1607++ 8B60~            TSlStp	DW 0
1608++ 8B60~            TnDelt	DW 0
1609++ 8B60~            NtSkCn	DB 0
1610++ 8B60~            Volume	DB 0
1611++ 8B60             	ENDS
1612++ 8B60             
1613++ 8B60             	STRUCT	VRS
1614++ 8B60~            1615++ 8B60~            ;IF not works in STRUCT in SjASM :(
1616++ 8B60~            ;	IF CurPosCounter
1617++ 8B60~            CurPos	DB 0
1618++ 8B60~            PosSub	DB 0
1619++ 8B60~            ;	ENDIF
1620++ 8B60~            1621++ 8B60~            ModNum	DB 0 ;bit0: ChipNum
1622++ 8B60~            	     ;bit1: 1-reversed patterns order (AlCo TS)
1623++ 8B60~            1624++ 8B60~            ChanA	DS CHP
1625++ 8B60~            ChanB	DS CHP
1626++ 8B60~            ChanC	DS CHP
1627++ 8B60~            1628++ 8B60~            ;GlobalVars
1629++ 8B60~            MODADDR	DW 0
1630++ 8B60~            OrnPtrs	DW 0
1631++ 8B60~            SamPtrs	DW 0
1632++ 8B60~            PatsPtr	DW 0
1633++ 8B60~            AdInPtA	DW 0
1634++ 8B60~            AdInPtB	DW 0
1635++ 8B60~            AdInPtC	DW 0
1636++ 8B60~            CrPsPtr	DW 0
1637++ 8B60~            LPosPtr	DW 0
1638++ 8B60~            Delay	DB 0
1639++ 8B60~            DelyCnt	DB 0
1640++ 8B60~            ESldAdd	DW 0
1641++ 8B60~            CurESld	DW 0
1642++ 8B60~            Env_Del	DB 0
1643++ 8B60~            CurEDel	DB 0
1644++ 8B60~            Ns_Base	DB 0
1645++ 8B60~            AddToNs	DB 0
1646++ 8B60~            AddToEn	DB 0
1647++ 8B60~            EnvBase	DW 0
1648++ 8B60~            AYREGS	DS 14
1649++ 8B60             	ENDS
1650++ 8B60             
1651++ 8B60 00          VARS1	DS VRS
1652++ 8BE7 00          VARS2	DS VRS
1653++ 8C6E             
1654++ 8C6E             VT_	EQU $-16
1655++ 8C6E 00          	DS 256-16 ;CreatedVolumeTableAddress
1656++ 8D5E             
1657++ 8D5E             T1_	EQU VT_+16 ;Tone tables data depacked here
1658++ 8D5E             
1659++ 8D5E             T_OLD_1	EQU T1_
1660++ 8D5E             T_OLD_2	EQU T_OLD_1+24
1661++ 8D5E             T_OLD_3	EQU T_OLD_2+24
1662++ 8D5E             T_OLD_0	EQU T_OLD_3+2
1663++ 8D5E             T_NEW_0	EQU T_OLD_0
1664++ 8D5E             T_NEW_1	EQU T_OLD_1
1665++ 8D5E             T_NEW_2	EQU T_NEW_0+24
1666++ 8D5E             T_NEW_3	EQU T_OLD_3
1667++ 8D5E             
1668++ 8D5E             PT2EMPTYORN EQU VT_+31 ;1,0,0 sequence
1669++ 8D5E             
1670++ 8D5E 00          NT_	DS 192 ;CreatedNoteTableAddress
1671++ 8E1E             
1672++ 8E1E             VAR0END	EQU VT_+16 ;INIT zeroes from VARS to VAR0END-1
1673++ 8E1E             
1674++ 8E1E             VARSEND EQU $
1675++ 8E1E             MDLADDR EQU $
1676++ 8E1E             
1677++ 8E1E                    DISPLAY "PTS player size=",$-START
1678++ 8E1E             
1679++ 8E1E             ;Release 0 steps:
1680++ 8E1E             ;04/21/2007
1681++ 8E1E             ;Works start (PTxPlay adaptation); first beta.
1682++ 8E1E             ;04/22/2007
1683++ 8E1E             ;Job finished; beta-testing.
1684++ 8E1E             ;04/23/2007
1685++ 8E1E             ;PT v3.7 TS mode corrected (after AlCo remarks).
1686++ 8E1E             ;04/29/2007
1687++ 8E1E             ;Added 1.XX and 2.XX special commands interpretation for PT3
1688++ 8E1E             ;modules of v3.7+.
1689++ 8E1E             
1690++ 8E1E             ;Size (minimal build for ZX Spectrum):
1691++ 8E1E             ;Code block #908 bytes
1692++ 8E1E             ;Variables #2BF bytes (can be stripped)
1693++ 8E1E             ;Total size #908+#2BF=#BC7 (3015) bytes
1694++ 8E1E             
1695++ 8E1E                    ENDMOD
1696++ 8E1E             
1697++ 8E1E                    endif
1698++ 8E1E             
0413+  8E1E                     include "pt3.asm"
0001++ 8E1E                     ifndef _pt3_asm_defined
0002++ 8E1E                     define _pt3_asm_defined
0003++ 8E1E             
0004++ 8E1E                     module PT3
0005++ 8E1E                     
0006++ 8E1E                     struct Header
0007++ 8E1E~            Id      ds 13 ; usually 'Protracker 3.'
0008++ 8E1E~            Subversion
0009++ 8E1E~                    db 0
0010++ 8E1E~            Description
0011++ 8E1E~                    ds 84 ; usually ' compilation of ' + Name[32] + ' by ' + Author[32]
0012++ 8E1E~            Mode    db 0
0013++ 8E1E~            FreqTable
0014++ 8E1E~                    db 0  ;assume 0..04
0015++ 8E1E~            Tempo   db 0  ;01-ff
0016++ 8E1E~            Length  db 0
0017++ 8E1E~            Loop    db 0
0018++ 8E1E~            Patterns
0019++ 8E1E~                    dw 0  ;? 00-01
0020++ 8E1E~            Samples 
0021++ 8E1E~                    ds 64  ;(? 00-bf}{32}
0022++ 8E1E~            Ornaments
0023++ 8E1E~                    ds 32  ;(? 00-d9){16}
0024++ 8E1E~            Positions
0025++ 8E1E~                    db 0  ;*3&00-fe
0026++ 8E1E~                    db 0  ;*3|ff       
0027++ 8E1E                     ends
0028++ 8E1E                     
0029++ 8E1E             Start
0030++ 8E1E                     ifndef NoPrologue
0031++ 8E1E~                    ld hl,End
0032++ 8E1E~                    jr Init
0033++ 8E1E~                    jp PTS.PLAY
0034++ 8E1E~                    jp PTS.MUTE
0035++ 8E1E                     endif
0036++ 8E1E             
0037++ 8E1E 3E 20       Init    ld a,PTS.SETUP.TSPT3
0038++ 8E20 C3 63 82            jp PTS.INIT
0039++ 8E23             
0040++ 8E23                     ifdef HaveFormatCheck
0041++ 8E23                     include "format.asm"
0001+++8E23             ;some format checking macros
0002+++8E23                     ifndef _format_asm_defined
0003+++8E23                     define _format_asm_defined
0004+++8E23             
0005+++8E23                     macro LessOrEqual number
0006+++8E23~                    ld a,number
0007+++8E23~                    cp (hl)
0008+++8E23~                    inc hl
0009+++8E23~                    ret c
0010+++8E23                     endm
0011+++8E23                     
0012+++8E23                     macro Greater number
0013+++8E23~                    ld a,(hl)
0014+++8E23~                    inc hl
0015+++8E23~                    cp number
0016+++8E23~                    ret c
0017+++8E23                     endm
0018+++8E23                     
0019+++8E23                     macro AnyByte
0020+++8E23~                    inc hl
0021+++8E23                     endm
0022+++8E23                     
0023+++8E23                     macro AnyBytes count
0024+++8E23~                    if count > 7
0025+++8E23~                    ld a,l
0026+++8E23~                    add a,count
0027+++8E23~                    ld l,a
0028+++8E23~                    adc a,h
0029+++8E23~                    sub l
0030+++8E23~                    ld h,a
0031+++8E23~                    else
0032+++8E23~                    dup count
0033+++8E23~                    inc hl
0034+++8E23~                    edup
0035+++8E23~                    endif
0036+++8E23                     endm
0037+++8E23                     
0038+++8E23                     macro EqualTo number
0039+++8E23~                    ld a,number
0040+++8E23~                    cp (hl)
0041+++8E23~                    inc hl
0042+++8E23~                    ret nz
0043+++8E23                     endm
0044+++8E23             
0045+++8E23                     endif
0046+++8E23             
0042++ 8E23                     
0043++ 8E23             ;in HL - module addr
0044++ 8E23             ;out Z - is pt3
0045++ 8E23             CheckFormat
0046++ 8E23                     ; meta
0047++ 8E23                     AnyBytes Header.FreqTable
0047++ 8E23 7D          >        ld a,l
0047++ 8E24 C6 63       >        add a,count
0047++ 8E26 6F          >        ld l,a
0047++ 8E27 8C          >        adc a,h
0047++ 8E28 95          >        sub l
0047++ 8E29 67          >        ld h,a
0048++ 8E2A                     ;FreqTable
0049++ 8E2A                     LessOrEqual 4
0049++ 8E2A 3E 04       >        ld a,number
0049++ 8E2C BE          >        cp (hl)
0049++ 8E2D 23          >        inc hl
0049++ 8E2E D8          >        ret c
0050++ 8E2F                     ;Tempo
0051++ 8E2F                     Greater 1
0051++ 8E2F 7E          >        ld a,(hl)
0051++ 8E30 23          >        inc hl
0051++ 8E31 FE 01       >        cp number
0051++ 8E33 D8          >        ret c
0052++ 8E34                     ;Length
0053++ 8E34                     AnyByte
0053++ 8E34 23          >        inc hl
0054++ 8E35                     ;Loop
0055++ 8E35                     AnyByte
0055++ 8E35 23          >        inc hl
0056++ 8E36                     ;Patterns
0057++ 8E36                     AnyByte
0057++ 8E36 23          >        inc hl
0058++ 8E37                     LessOrEqual 1
0058++ 8E37 3E 01       >        ld a,number
0058++ 8E39 BE          >        cp (hl)
0058++ 8E3A 23          >        inc hl
0058++ 8E3B D8          >        ret c
0059++ 8E3C                     ;Samples
0060++ 8E3C 06 20               ld b,(Header.Ornaments-Header.Samples)/2
0061++ 8E3E             .samples
0062++ 8E3E                     AnyByte
0062++ 8E3E 23          >        inc hl
0063++ 8E3F                     LessOrEqual #bf
0063++ 8E3F 3E BF       >        ld a,number
0063++ 8E41 BE          >        cp (hl)
0063++ 8E42 23          >        inc hl
0063++ 8E43 D8          >        ret c
0064++ 8E44 10 F8               djnz .samples
0065++ 8E46                     ;Ornaments
0066++ 8E46 06 10               ld b,(Header.Positions-Header.Ornaments)/2
0067++ 8E48             .ornaments
0068++ 8E48                     AnyByte
0068++ 8E48 23          >        inc hl
0069++ 8E49                     LessOrEqual #d9
0069++ 8E49 3E D9       >        ld a,number
0069++ 8E4B BE          >        cp (hl)
0069++ 8E4C 23          >        inc hl
0069++ 8E4D D8          >        ret c
0070++ 8E4E 10 F8               djnz .ornaments
0071++ 8E50                     ;Positions
0072++ 8E50                     ;255 at first position is denied
0073++ 8E50                     LessOrEqual 254
0073++ 8E50 3E FE       >        ld a,number
0073++ 8E52 BE          >        cp (hl)
0073++ 8E53 23          >        inc hl
0073++ 8E54 D8          >        ret c
0074++ 8E55 06 00               ld b,0
0075++ 8E57 2B                  dec hl
0076++ 8E58             .positions
0077++ 8E58 7E                  ld a,(hl)
0078++ 8E59 23                  inc hl
0079++ 8E5A FE FF               cp 255
0080++ 8E5C C8                  ret z ;finish
0081++ 8E5D                     ;check is multiple of 3
0082++ 8E5D A7          .div3   and a
0083++ 8E5E 28 05               jr z,.posok
0084++ 8E60 D6 03               sub 3
0085++ 8E62 D8                  ret c
0086++ 8E63 20 F8               jr nz,.div3
0087++ 8E65 10 F1       .posok  djnz .positions
0088++ 8E67                     ;fall through
0089++ 8E67 7C          .fail   ld a,h
0090++ 8E68 A7                  and a ;reset Z
0091++ 8E69 C9                  ret
0092++ 8E6A                     
0093++ 8E6A                     display "PT3 checker size: ",$-CheckFormat
0094++ 8E6A                     endif
0095++ 8E6A                     
0096++ 8E6A                     endmod
0097++ 8E6A             
0098++ 8E6A                     include "PTSPlay.asm"
0001+++8E6A                     ifndef _pts_asm_defined
0002+++8E6A~                    define _pts_asm_defined
0003+++8E6A~            0004+++8E6A~                    MODULE PTS
0005+++8E6A~                    
0006+++8E6A~            ;Universal PT2'n'PT3 Turbo Sound player for ZX Spectrum
0007+++8E6A~            ;(c)2004-2007 S.V.Bulba <vorobey@mail.khstu.ru>
0008+++8E6A~            ;Specially for AlCo
0009+++8E6A~            ;http://bulba.untergrund.net/ (http://bulba.at.kz/)
0010+++8E6A~            0011+++8E6A~            ;Release number
0012+++8E6A~            Release EQU "0"
0013+++8E6A~            0014+++8E6A~            ;Conditional assembly
0015+++8E6A~            ;1) Current position counters at (Vars1+0) and (Vars2+0)
0016+++8E6A~            CurPosCounter=0
0017+++8E6A~            ;2) Allow channels allocation bits at (SETUP)
0018+++8E6A~            ACBBAC=0
0019+++8E6A~            ;3) Allow loop checking and disabling
0020+++8E6A~            LoopChecker=0
0021+++8E6A~            ;4) Insert official identificator
0022+++8E6A~            Id=0
0023+++8E6A~            ;5) Set IY for correct return to ZX Basic
0024+++8E6A~            Basic=0
0025+++8E6A~            0026+++8E6A~            ;Features
0027+++8E6A~            ;--------
0028+++8E6A~            ;-Can be compiled at any address (i.e. no need rounding ORG
0029+++8E6A~            ; address).
0030+++8E6A~            ;-Variables (VARS) can be located at any address (not only after
0031+++8E6A~            ; code block).
0032+++8E6A~            ;-INIT subprogram checks PT3-module version and rightly
0033+++8E6A~            ; generates both note and volume tables outside of code block
0034+++8E6A~            ; (in VARS).
0035+++8E6A~            ;-Two portamento (spc. command 3xxx) algorithms (depending of
0036+++8E6A~            ; PT3 module version).
0037+++8E6A~            ;-New 1.XX and 2.XX special command behaviour (only for PT v3.7
0038+++8E6A~            ; and higher).
0039+++8E6A~            ;-Any Tempo value are accepted (including Tempo=1 and Tempo=2).
0040+++8E6A~            ;-TS modes: 2xPT3, 2xPT2 and PT v3.7 TS standard.
0041+++8E6A~            ;-Fully compatible with Ay_Emul PT3 and PT2 players codes.
0042+++8E6A~            ;-See also notes at the end of this source code.
0043+++8E6A~            0044+++8E6A~            ;Limitations
0045+++8E6A~            ;-----------
0046+++8E6A~            ;-Can run in RAM only (self-modified code is used).
0047+++8E6A~            ;-PT2 position list must be end by #FF marker only.
0048+++8E6A~            0049+++8E6A~            ;Warning!!! PLAY subprogram can crash if no module are loaded
0050+++8E6A~            ;into RAM or INIT subprogram was not called before.
0051+++8E6A~            0052+++8E6A~            ;Call MUTE or INIT one more time to mute sound after stopping
0053+++8E6A~            ;playing 
0054+++8E6A~            0055+++8E6A~            TonA	EQU 0
0056+++8E6A~            TonB	EQU 2
0057+++8E6A~            TonC	EQU 4
0058+++8E6A~            Noise	EQU 6
0059+++8E6A~            Mixer	EQU 7
0060+++8E6A~            AmplA	EQU 8
0061+++8E6A~            AmplB	EQU 9
0062+++8E6A~            AmplC	EQU 10
0063+++8E6A~            Env	EQU 11
0064+++8E6A~            EnvTp	EQU 13
0065+++8E6A~            0066+++8E6A~            START
0067+++8E6A~            0068+++8E6A~            SETUP.NOLOOP EQU 1
0069+++8E6A~            SETUP.PT2 EQU 2
0070+++8E6A~            SETUP.ACB EQU 4
0071+++8E6A~            SETUP.BAC EQU 8
0072+++8E6A~            SETUP.TS02 EQU 16
0073+++8E6A~            SETUP.TSPT3 EQU 32
0074+++8E6A~            0075+++8E6A~            SETUP	DB 0 ;set bit0, if you want to play without looping
0076+++8E6A~            	     ;(optional);
0077+++8E6A~            	     ;set bit1 for PT2 and reset for PT3 before
0078+++8E6A~            	     ;calling INIT;
0079+++8E6A~            	     ;bits2-3: %00-ABC, %01-ACB, %10-BAC (optional);
0080+++8E6A~            	     ;bits4-5: %00-no TS, %01-2 modules TS, %10-
0081+++8E6A~            	     ;autodetect PT3 TS-format by AlCo (PT 3.7+);
0082+++8E6A~            	     ;Remark: old PT3 TS-format by AlCo (PT 3.6) is not
0083+++8E6A~            	     ;documented and must be converted to new standard.
0084+++8E6A~            	     ;bit6 is set each time, when loop point of 2nd TS
0085+++8E6A~            	     ;module is passed (optional).
0086+++8E6A~            	     ;bit7 is set each time, when loop point of 1st TS
0087+++8E6A~            	     ;or of single module is passed (optional).
0088+++8E6A~            0089+++8E6A~            ;Identifier
0090+++8E6A~            	IF Id
0091+++8E6A~            	DB "=UniPT2/PT3/TS-Player r.",Release,"="
0092+++8E6A~            	ENDIF
0093+++8E6A~            0094+++8E6A~            	IF LoopChecker
0095+++8E6A~            CHECKLP	LD HL,SETUP
0096+++8E6A~            	BIT 0,(IY-100+VRS.ModNum)
0097+++8E6A~            	JR Z,CHL1
0098+++8E6A~            	SET 6,(HL)
0099+++8E6A~            	JR CHL2
0100+++8E6A~            CHL1	SET 7,(HL)
0101+++8E6A~            CHL2	BIT 0,(HL)
0102+++8E6A~            	RET Z
0103+++8E6A~            	POP HL
0104+++8E6A~            	INC (IY-100+VRS.DelyCnt)
0105+++8E6A~            	INC (IY-100+VRS.ChanA+CHP.NtSkCn)
0106+++8E6A~            	XOR A
0107+++8E6A~            	LD (IY-100+VRS.AYREGS+AmplA),A
0108+++8E6A~            	LD (IY-100+VRS.AYREGS+AmplB),A
0109+++8E6A~            	LD (IY-100+VRS.AYREGS+AmplC),A
0110+++8E6A~            	RET
0111+++8E6A~            	ENDIF
0112+++8E6A~            0113+++8E6A~            MUTE	XOR A
0114+++8E6A~            	LD H,A
0115+++8E6A~            	LD L,A
0116+++8E6A~            	LD (VARS1+VRS.AYREGS+AmplA),A
0117+++8E6A~            	LD (VARS1+VRS.AYREGS+AmplB),HL
0118+++8E6A~            	LD (VARS2+VRS.AYREGS+AmplA),A
0119+++8E6A~            	LD (VARS2+VRS.AYREGS+AmplB),HL
0120+++8E6A~            	JP ROUT
0121+++8E6A~            0122+++8E6A~            INIT
0123+++8E6A~            ;HL - AddressOfModule
0124+++8E6A~            ;DE - AddresOf2ndModule
0125+++8E6A~            ;A - mode
0126+++8E6A~            	PUSH DE
0127+++8E6A~            	PUSH HL
0128+++8E6A~            	LD HL,VARS
0129+++8E6A~            	LD (HL),0
0130+++8E6A~            	LD DE,VARS+1
0131+++8E6A~            	LD BC,VAR0END-VARS-1
0132+++8E6A~            	LDIR
0133+++8E6A~            	INC HL
0134+++8E6A~            	LD (VARS1+VRS.AdInPtA),HL ;ptr to zero
0135+++8E6A~            	LD (VARS2+VRS.AdInPtA),HL
0136+++8E6A~            0137+++8E6A~            	POP HL
0138+++8E6A~            	LD IY,VARS1+100
0139+++8E6A~                LD (SETUP),A
0140+++8E6A~            	AND SETUP.PT2
0141+++8E6A~            	JP NZ,I_PT2
0142+++8E6A~            0143+++8E6A~            	CALL INITPT3
0144+++8E6A~            	LD HL,(e_-SamCnv-2)*256+#18
0145+++8E6A~            	LD (SamCnv),HL
0146+++8E6A~            	LD A,#BA
0147+++8E6A~            	LD (OrnCP),A
0148+++8E6A~            	LD (SamCP),A
0149+++8E6A~            	LD A,#7B
0150+++8E6A~            	LD (OrnLD),A
0151+++8E6A~            	LD (SamLD),A
0152+++8E6A~            	LD A,#87
0153+++8E6A~            	LD (SamClc2),A
0154+++8E6A~            	POP HL
0155+++8E6A~            	;Use version and ton table of 1st module
0156+++8E6A~            	LD A,(IX+13-100) ;EXTRACT VERSION NUMBER
0157+++8E6A~            	SUB #30
0158+++8E6A~            	JR C,L20
0159+++8E6A~            	CP 10
0160+++8E6A~            	JR C,L21
0161+++8E6A~            L20	LD A,6
0162+++8E6A~            L21	LD (Version),A
0163+++8E6A~            	PUSH AF ;VolTable version
0164+++8E6A~            	CP 4
0165+++8E6A~            	LD A,(IX+99-100) ;TONE TABLE NUMBER
0166+++8E6A~            	RLA
0167+++8E6A~            	AND 7
0168+++8E6A~            	PUSH AF ;NoteTable number
0169+++8E6A~            0170+++8E6A~            	LD IY,VARS2+100
0171+++8E6A~            	LD A,(SETUP)
0172+++8E6A~            	AND SETUP.TS02|SETUP.TSPT3
0173+++8E6A~            	JR Z,NOTS
0174+++8E6A~            	CP SETUP.TS02
0175+++8E6A~            	JR Z,TwoPT3s
0176+++8E6A~            	LD A,(Version)
0177+++8E6A~            	CP 7
0178+++8E6A~            	JR C,NOTS
0179+++8E6A~            	LD A,(IX+98-100) ;ALCO TS MARKER
0180+++8E6A~            	CP #20
0181+++8E6A~            	JR Z,NOTS
0182+++8E6A~            	LD HL,VARS1
0183+++8E6A~            	LD DE,VARS2
0184+++8E6A~            	LD BC,VRS
0185+++8E6A~            	LDIR
0186+++8E6A~            	SET 1,(IY-100+VRS.ModNum)
0187+++8E6A~            	LD C,A
0188+++8E6A~            	ADD A,A
0189+++8E6A~            	ADD A,C
0190+++8E6A~            	SUB 2
0191+++8E6A~            	LD (TSSub),A
0192+++8E6A~            	JR AlCoTS_
0193+++8E6A~            TwoPT3s	CALL INITPT3
0194+++8E6A~            AlCoTS_	LD A,1
0195+++8E6A~            	LD (is_ts),A
0196+++8E6A~            	SET 0,(IY-100+VRS.ModNum)
0197+++8E6A~            0198+++8E6A~            NOTS	LD BC,PT3PD
0199+++8E6A~            	LD HL,0
0200+++8E6A~            	LD DE,PT3EMPTYORN
0201+++8E6A~            	JR INITCOMMON
0202+++8E6A~            0203+++8E6A~            I_PT2	CALL INITPT2
0204+++8E6A~            	LD HL,#51CB
0205+++8E6A~            	LD (SamCnv),HL
0206+++8E6A~            	LD A,#BB
0207+++8E6A~            	LD (OrnCP),A
0208+++8E6A~            	LD (SamCP),A
0209+++8E6A~            	LD A,#7A
0210+++8E6A~            	LD (OrnLD),A
0211+++8E6A~            	LD (SamLD),A
0212+++8E6A~            	LD A,#80
0213+++8E6A~            	LD (SamClc2),A
0214+++8E6A~            	POP HL
0215+++8E6A~            	LD A,5
0216+++8E6A~            	LD (Version),A
0217+++8E6A~            	PUSH AF
0218+++8E6A~            	LD A,2
0219+++8E6A~            	PUSH AF
0220+++8E6A~            0221+++8E6A~            	LD A,(SETUP)
0222+++8E6A~                AND SETUP.TS02|SETUP.TSPT3
0223+++8E6A~            	JR Z,NOTS2
0224+++8E6A~            0225+++8E6A~            	LD IY,VARS2+100
0226+++8E6A~            	LD A,1
0227+++8E6A~            	LD (is_ts),A
0228+++8E6A~            	SET 0,(IY-100+VRS.ModNum)
0229+++8E6A~            	CALL INITPT2
0230+++8E6A~            0231+++8E6A~            NOTS2	LD BC,PT2PD
0232+++8E6A~            	LD HL,#8687
0233+++8E6A~            	LD DE,PT2EMPTYORN
0234+++8E6A~            0235+++8E6A~            INITCOMMON
0236+++8E6A~            0237+++8E6A~            	IF Basic
0238+++8E6A~            	LD IY,#5C3A
0239+++8E6A~            	ENDIF
0240+++8E6A~            0241+++8E6A~            	LD (PTDEC),BC
0242+++8E6A~            	LD (PsCalc),HL
0243+++8E6A~            	PUSH DE
0244+++8E6A~            0245+++8E6A~            ;note table data depacker
0246+++8E6A~            ;(c) Ivan Roshin
0247+++8E6A~            	LD DE,T_PACK
0248+++8E6A~            	LD BC,T1_+(2*49)-1
0249+++8E6A~            TP_0	LD A,(DE)
0250+++8E6A~            	INC DE
0251+++8E6A~            	CP 15*2
0252+++8E6A~            	JR NC,TP_1
0253+++8E6A~            	LD H,A
0254+++8E6A~            	LD A,(DE)
0255+++8E6A~            	LD L,A
0256+++8E6A~            	INC DE
0257+++8E6A~            	JR TP_2
0258+++8E6A~            TP_1	PUSH DE
0259+++8E6A~            	LD D,0
0260+++8E6A~            	LD E,A
0261+++8E6A~            	ADD HL,DE
0262+++8E6A~            	ADD HL,DE
0263+++8E6A~            	POP DE
0264+++8E6A~            TP_2	LD A,H
0265+++8E6A~            	LD (BC),A
0266+++8E6A~            	DEC BC
0267+++8E6A~            	LD A,L
0268+++8E6A~            	LD (BC),A
0269+++8E6A~            	DEC BC
0270+++8E6A~            	SUB (#F8*2)&255
0271+++8E6A~            	JR NZ,TP_0
0272+++8E6A~            0273+++8E6A~            	INC A
0274+++8E6A~            	LD (VARS1+VRS.DelyCnt),A
0275+++8E6A~            	LD (VARS2+VRS.DelyCnt),A
0276+++8E6A~            	LD HL,#F001 ;H - CHP.Volume, L - CHP.NtSkCn
0277+++8E6A~            	LD (VARS1+VRS.ChanA+CHP.NtSkCn),HL
0278+++8E6A~            	LD (VARS1+VRS.ChanB+CHP.NtSkCn),HL
0279+++8E6A~            	LD (VARS1+VRS.ChanC+CHP.NtSkCn),HL
0280+++8E6A~            	LD (VARS2+VRS.ChanA+CHP.NtSkCn),HL
0281+++8E6A~            	LD (VARS2+VRS.ChanB+CHP.NtSkCn),HL
0282+++8E6A~            	LD (VARS2+VRS.ChanC+CHP.NtSkCn),HL
0283+++8E6A~            	POP HL
0284+++8E6A~            	LD (VARS1+VRS.ChanA+CHP.OrnPtr),HL
0285+++8E6A~            	LD (VARS1+VRS.ChanB+CHP.OrnPtr),HL
0286+++8E6A~            	LD (VARS1+VRS.ChanC+CHP.OrnPtr),HL
0287+++8E6A~            	LD (VARS2+VRS.ChanA+CHP.OrnPtr),HL
0288+++8E6A~            	LD (VARS2+VRS.ChanB+CHP.OrnPtr),HL
0289+++8E6A~            	LD (VARS2+VRS.ChanC+CHP.OrnPtr),HL
0290+++8E6A~            0291+++8E6A~            	POP AF
0292+++8E6A~            0293+++8E6A~            ;NoteTableCreator (c) Ivan Roshin
0294+++8E6A~            ;A - NoteTableNumber*2+VersionForNoteTable
0295+++8E6A~            ;(xx1b - 3.xx..3.4r, xx0b - 3.4x..3.6x..VTII1.0)
0296+++8E6A~            0297+++8E6A~            	LD HL,NT_DATA
0298+++8E6A~            	LD D,0
0299+++8E6A~            	ADD A,A
0300+++8E6A~            	LD E,A
0301+++8E6A~            	ADD HL,DE
0302+++8E6A~            	LD E,(HL)
0303+++8E6A~            	INC HL
0304+++8E6A~            	SRL E
0305+++8E6A~            	SBC A,A
0306+++8E6A~            	AND #A7 ;#00 (NOP) or #A7 (AND A)
0307+++8E6A~            	LD (L3),A
0308+++8E6A~            	EX DE,HL
0309+++8E6A~            	LD BC,T1_
0310+++8E6A~            	ADD HL,BC
0311+++8E6A~            0312+++8E6A~            	LD A,(DE)
0313+++8E6A~            	ADD A,T_&255
0314+++8E6A~            	LD C,A
0315+++8E6A~            	ADC A,T_/256
0316+++8E6A~            	SUB C
0317+++8E6A~            	LD B,A
0318+++8E6A~            	PUSH BC
0319+++8E6A~            	LD DE,NT_
0320+++8E6A~            	PUSH DE
0321+++8E6A~            0322+++8E6A~            	LD B,12
0323+++8E6A~            L1	PUSH BC
0324+++8E6A~            	LD C,(HL)
0325+++8E6A~            	INC HL
0326+++8E6A~            	PUSH HL
0327+++8E6A~            	LD B,(HL)
0328+++8E6A~            0329+++8E6A~            	PUSH DE
0330+++8E6A~            	EX DE,HL
0331+++8E6A~            	LD DE,23
0332+++8E6A~            	LD IXH,8
0333+++8E6A~            0334+++8E6A~            L2	SRL B
0335+++8E6A~            	RR C
0336+++8E6A~            L3	DB #19	;AND A or NOP
0337+++8E6A~            	LD A,C
0338+++8E6A~            	ADC A,D	;=ADC 0
0339+++8E6A~            	LD (HL),A
0340+++8E6A~            	INC HL
0341+++8E6A~            	LD A,B
0342+++8E6A~            	ADC A,D
0343+++8E6A~            	LD (HL),A
0344+++8E6A~            	ADD HL,DE
0345+++8E6A~            	DEC IXH
0346+++8E6A~            	JR NZ,L2
0347+++8E6A~            0348+++8E6A~            	POP DE
0349+++8E6A~            	INC DE
0350+++8E6A~            	INC DE
0351+++8E6A~            	POP HL
0352+++8E6A~            	INC HL
0353+++8E6A~            	POP BC
0354+++8E6A~            	DJNZ L1
0355+++8E6A~            0356+++8E6A~            	POP HL
0357+++8E6A~            	POP DE
0358+++8E6A~            0359+++8E6A~            	LD A,E
0360+++8E6A~            	CP TCOLD_1&255
0361+++8E6A~            	JR NZ,CORR_1
0362+++8E6A~            	LD A,#FD
0363+++8E6A~            	LD (NT_+#2E),A
0364+++8E6A~            0365+++8E6A~            CORR_1	LD A,(DE)
0366+++8E6A~            	AND A
0367+++8E6A~            	JR Z,TC_EXIT
0368+++8E6A~            	RRA
0369+++8E6A~            	PUSH AF
0370+++8E6A~            	ADD A,A
0371+++8E6A~            	LD C,A
0372+++8E6A~            	ADD HL,BC
0373+++8E6A~            	POP AF
0374+++8E6A~            	JR NC,CORR_2
0375+++8E6A~            	DEC (HL)
0376+++8E6A~            	DEC (HL)
0377+++8E6A~            CORR_2	INC (HL)
0378+++8E6A~            	AND A
0379+++8E6A~            	SBC HL,BC
0380+++8E6A~            	INC DE
0381+++8E6A~            	JR CORR_1
0382+++8E6A~            0383+++8E6A~            TC_EXIT
0384+++8E6A~            0385+++8E6A~            	POP AF
0386+++8E6A~            0387+++8E6A~            ;VolTableCreator (c) Ivan Roshin
0388+++8E6A~            ;A - VersionForVolumeTable (0..4 - 3.xx..3.4x;
0389+++8E6A~            			   ;5.. - 2.x,3.5x..3.6x..VTII1.0)
0390+++8E6A~            0391+++8E6A~            	CP 5
0392+++8E6A~            	LD HL,#11
0393+++8E6A~            	LD D,H
0394+++8E6A~            	LD E,H
0395+++8E6A~            	LD A,#17
0396+++8E6A~            	JR NC,M1
0397+++8E6A~            	DEC L
0398+++8E6A~            	LD E,L
0399+++8E6A~            	XOR A
0400+++8E6A~            M1      LD (M2),A
0401+++8E6A~            0402+++8E6A~            	LD IX,VT_+16
0403+++8E6A~            0404+++8E6A~            	LD C,#F
0405+++8E6A~            INITV2  PUSH HL
0406+++8E6A~            0407+++8E6A~            	ADD HL,DE
0408+++8E6A~            	EX DE,HL
0409+++8E6A~            	SBC HL,HL
0410+++8E6A~            0411+++8E6A~            	LD B,#10
0412+++8E6A~            INITV1  LD A,L
0413+++8E6A~            M2      DB #7D
0414+++8E6A~            	LD A,H
0415+++8E6A~            	ADC A,0
0416+++8E6A~            	LD (IX),A
0417+++8E6A~            	INC IX
0418+++8E6A~            	ADD HL,DE
0419+++8E6A~            	DJNZ INITV1
0420+++8E6A~            0421+++8E6A~            	POP HL
0422+++8E6A~            	LD A,E
0423+++8E6A~            	CP #77
0424+++8E6A~            	JR NZ,M3
0425+++8E6A~            	INC E
0426+++8E6A~            M3      DEC C
0427+++8E6A~            	JR NZ,INITV2
0428+++8E6A~            0429+++8E6A~            	JP ROUT
0430+++8E6A~            0431+++8E6A~            INITPT3	CALL SETMDAD
0432+++8E6A~            	PUSH HL
0433+++8E6A~            	LD DE,100
0434+++8E6A~            	ADD HL,DE
0435+++8E6A~            	LD A,(HL)
0436+++8E6A~            	LD (IY-100+VRS.Delay),A
0437+++8E6A~            	PUSH HL
0438+++8E6A~            	POP IX
0439+++8E6A~            	ADD HL,DE
0440+++8E6A~            	CALL SETCPPT
0441+++8E6A~            	LD E,(IX+102-100)
0442+++8E6A~            	INC HL
0443+++8E6A~            0444+++8E6A~            	IF CurPosCounter
0445+++8E6A~            	LD (IY-100+VRS.PosSub),L
0446+++8E6A~            	ENDIF
0447+++8E6A~            0448+++8E6A~            	ADD HL,DE
0449+++8E6A~            	CALL SETLPPT
0450+++8E6A~            	POP DE
0451+++8E6A~            	LD L,(IX+103-100)
0452+++8E6A~            	LD H,(IX+104-100)
0453+++8E6A~            	ADD HL,DE
0454+++8E6A~            	CALL SETPTPT
0455+++8E6A~            	LD HL,169
0456+++8E6A~            	ADD HL,DE
0457+++8E6A~            	CALL SETORPT
0458+++8E6A~            	LD HL,105
0459+++8E6A~            	ADD HL,DE
0460+++8E6A~            0461+++8E6A~            SETSMPT LD (IY-100+VRS.SamPtrs),L
0462+++8E6A~            	LD (IY-100+VRS.SamPtrs+1),H
0463+++8E6A~            	RET
0464+++8E6A~            0465+++8E6A~            INITPT2	LD A,(HL)
0466+++8E6A~            	LD (IY-100+VRS.Delay),A
0467+++8E6A~            	PUSH HL
0468+++8E6A~            	PUSH HL
0469+++8E6A~            	PUSH HL
0470+++8E6A~            	INC HL
0471+++8E6A~            	INC HL
0472+++8E6A~            	LD A,(HL)
0473+++8E6A~            	INC HL
0474+++8E6A~            	CALL SETSMPT
0475+++8E6A~            	LD E,(HL)
0476+++8E6A~            	INC HL
0477+++8E6A~            	LD D,(HL)
0478+++8E6A~            	POP HL
0479+++8E6A~            	AND A
0480+++8E6A~            	SBC HL,DE
0481+++8E6A~            	CALL SETMDAD
0482+++8E6A~            	POP HL
0483+++8E6A~            	LD DE,67
0484+++8E6A~            	ADD HL,DE
0485+++8E6A~            	CALL SETORPT
0486+++8E6A~            	LD E,32
0487+++8E6A~            	ADD HL,DE
0488+++8E6A~            	LD C,(HL)
0489+++8E6A~            	INC HL
0490+++8E6A~            	LD B,(HL)
0491+++8E6A~            	LD E,30
0492+++8E6A~            	ADD HL,DE
0493+++8E6A~            	CALL SETCPPT
0494+++8E6A~            	LD E,A
0495+++8E6A~            	INC HL
0496+++8E6A~            0497+++8E6A~            	IF CurPosCounter
0498+++8E6A~            	LD (IY-100+VRS.PosSub),L
0499+++8E6A~            	ENDIF
0500+++8E6A~            0501+++8E6A~            	ADD HL,DE
0502+++8E6A~            	CALL SETLPPT
0503+++8E6A~            	POP HL
0504+++8E6A~            	ADD HL,BC
0505+++8E6A~            0506+++8E6A~            SETPTPT	LD (IY-100+VRS.PatsPtr),L
0507+++8E6A~            	LD (IY-100+VRS.PatsPtr+1),H
0508+++8E6A~            	RET
0509+++8E6A~            0510+++8E6A~            SETMDAD	LD (IY-100+VRS.MODADDR),L
0511+++8E6A~            	LD (IY-100+VRS.MODADDR+1),H
0512+++8E6A~            	RET
0513+++8E6A~            0514+++8E6A~            SETORPT	LD (IY-100+VRS.OrnPtrs),L
0515+++8E6A~            	LD (IY-100+VRS.OrnPtrs+1),H
0516+++8E6A~            	RET
0517+++8E6A~            0518+++8E6A~            SETCPPT	LD (IY-100+VRS.CrPsPtr),L
0519+++8E6A~            	LD (IY-100+VRS.CrPsPtr+1),H
0520+++8E6A~            	RET
0521+++8E6A~            0522+++8E6A~            SETLPPT	LD (IY-100+VRS.LPosPtr),L
0523+++8E6A~            	LD (IY-100+VRS.LPosPtr+1),H
0524+++8E6A~            	RET
0525+++8E6A~            0526+++8E6A~            SETENBS	LD (IY-100+VRS.EnvBase),L
0527+++8E6A~            	LD (IY-100+VRS.EnvBase+1),H
0528+++8E6A~            	RET
0529+++8E6A~            0530+++8E6A~            SETESLD	LD (IY-100+VRS.CurESld),L
0531+++8E6A~            	LD (IY-100+VRS.CurESld+1),H
0532+++8E6A~            	RET
0533+++8E6A~            0534+++8E6A~            GETIX	PUSH IY
0535+++8E6A~            	POP IX
0536+++8E6A~            	ADD IX,DE
0537+++8E6A~            	RET
0538+++8E6A~            0539+++8E6A~            PTDECOD CALL GETIX
0540+++8E6A~            PTDEC	EQU $+1
0541+++8E6A~            	JP #C3C3
0542+++8E6A~            0543+++8E6A~            ;PT2 pattern decoder
0544+++8E6A~            PD2_SAM	CALL SETSAM
0545+++8E6A~            	JR PD2_LOOP
0546+++8E6A~            0547+++8E6A~            PD2_EOff LD (IX-12+CHP.Env_En),A
0548+++8E6A~            	JR PD2_LOOP
0549+++8E6A~            0550+++8E6A~            PD2_ENV	LD (IX-12+CHP.Env_En),16
0551+++8E6A~            	LD (IY-100+VRS.AYREGS+EnvTp),A
0552+++8E6A~            	LD A,(BC)
0553+++8E6A~            	INC BC
0554+++8E6A~            	LD L,A
0555+++8E6A~            	LD A,(BC)
0556+++8E6A~            	INC BC
0557+++8E6A~            	LD H,A
0558+++8E6A~            	CALL SETENBS
0559+++8E6A~            	JR PD2_LOOP
0560+++8E6A~            0561+++8E6A~            PD2_ORN	CALL SETORN
0562+++8E6A~            	JR PD2_LOOP
0563+++8E6A~            0564+++8E6A~            PD2_SKIP INC A
0565+++8E6A~            	LD (IX-12+CHP.NNtSkp),A
0566+++8E6A~            	JR PD2_LOOP
0567+++8E6A~            0568+++8E6A~            PD2_VOL	RRCA
0569+++8E6A~            	RRCA
0570+++8E6A~            	RRCA
0571+++8E6A~            	RRCA
0572+++8E6A~            	LD (IX-12+CHP.Volume),A
0573+++8E6A~            	JR PD2_LOOP
0574+++8E6A~            0575+++8E6A~            PD2_DEL	CALL C_DELAY
0576+++8E6A~            	JR PD2_LOOP
0577+++8E6A~            0578+++8E6A~            PD2_GLIS SET 2,(IX-12+CHP.Flags)
0579+++8E6A~            	INC A
0580+++8E6A~            	LD (IX-12+CHP.TnSlDl),A
0581+++8E6A~            	LD (IX-12+CHP.TSlCnt),A
0582+++8E6A~            	LD A,(BC)
0583+++8E6A~            	INC BC
0584+++8E6A~                    LD (IX-12+CHP.TSlStp),A
0585+++8E6A~            	ADD A,A
0586+++8E6A~            	SBC A,A
0587+++8E6A~                    LD (IX-12+CHP.TSlStp+1),A
0588+++8E6A~            	SCF
0589+++8E6A~            	JR PD2_LP2
0590+++8E6A~            0591+++8E6A~            PT2PD	AND A
0592+++8E6A~            0593+++8E6A~            PD2_LP2	EX AF,AF'
0594+++8E6A~            0595+++8E6A~            PD2_LOOP LD A,(BC)
0596+++8E6A~            	INC BC
0597+++8E6A~            	ADD A,#20
0598+++8E6A~            	JR Z,PD2_REL
0599+++8E6A~            	JR C,PD2_SAM
0600+++8E6A~            	ADD A,96
0601+++8E6A~            	JR C,PD2_NOTE
0602+++8E6A~            	INC A
0603+++8E6A~            	JR Z,PD2_EOff
0604+++8E6A~            	ADD A,15
0605+++8E6A~            	JP Z,PD_FIN
0606+++8E6A~            	JR C,PD2_ENV
0607+++8E6A~            	ADD A,#10
0608+++8E6A~            	JR C,PD2_ORN
0609+++8E6A~            	ADD A,#40
0610+++8E6A~            	JR C,PD2_SKIP
0611+++8E6A~            	ADD A,#10
0612+++8E6A~            	JR C,PD2_VOL
0613+++8E6A~            	INC A
0614+++8E6A~            	JR Z,PD2_DEL
0615+++8E6A~            	INC A
0616+++8E6A~            	JR Z,PD2_GLIS
0617+++8E6A~            	INC A
0618+++8E6A~            	JR Z,PD2_PORT
0619+++8E6A~            	INC A
0620+++8E6A~            	JR Z,PD2_STOP
0621+++8E6A~            	LD A,(BC)
0622+++8E6A~            	INC BC
0623+++8E6A~            	LD (IX-12+CHP.CrNsSl),A
0624+++8E6A~            	JR PD2_LOOP
0625+++8E6A~            0626+++8E6A~            PD2_PORT RES 2,(IX-12+CHP.Flags)
0627+++8E6A~            	LD A,(BC)
0628+++8E6A~            	INC BC
0629+++8E6A~            	INC BC ;ignoring precalc delta to right sound
0630+++8E6A~            	INC BC
0631+++8E6A~            	SCF
0632+++8E6A~            	JR PD2_LP2
0633+++8E6A~            0634+++8E6A~            PD2_STOP LD (IX-12+CHP.TSlCnt),A
0635+++8E6A~            	JR PD2_LOOP
0636+++8E6A~            0637+++8E6A~            PD2_REL	LD (IX-12+CHP.Flags),A
0638+++8E6A~            	JR PD2_EXIT
0639+++8E6A~            0640+++8E6A~            PD2_NOTE LD L,A
0641+++8E6A~            	LD A,(IX-12+CHP.Note)
0642+++8E6A~            	LD (PrNote+1),A
0643+++8E6A~            	LD (IX-12+CHP.Note),L
0644+++8E6A~            	XOR A
0645+++8E6A~            	LD (IX-12+CHP.TSlCnt),A
0646+++8E6A~            	SET 0,(IX-12+CHP.Flags)
0647+++8E6A~            	EX AF,AF'
0648+++8E6A~            	JR NC,NOGLIS2
0649+++8E6A~            	BIT 2,(IX-12+CHP.Flags)
0650+++8E6A~            	JR NZ,NOPORT2
0651+++8E6A~            	LD (LoStep),A
0652+++8E6A~            	ADD A,A
0653+++8E6A~            	SBC A,A
0654+++8E6A~            	EX AF,AF'
0655+++8E6A~            	LD H,A
0656+++8E6A~            	LD L,A
0657+++8E6A~            	INC A
0658+++8E6A~            	CALL SETPORT
0659+++8E6A~            NOPORT2	LD (IX-12+CHP.TSlCnt),1
0660+++8E6A~            NOGLIS2	XOR A
0661+++8E6A~            0662+++8E6A~            0663+++8E6A~            PD2_EXIT LD (IX-12+CHP.PsInSm),A
0664+++8E6A~            	LD (IX-12+CHP.PsInOr),A
0665+++8E6A~            	LD (IX-12+CHP.CrTnSl),A
0666+++8E6A~            	LD (IX-12+CHP.CrTnSl+1),A
0667+++8E6A~            	JP PD_FIN
0668+++8E6A~            0669+++8E6A~            ;PT3 pattern decoder
0670+++8E6A~            PD_OrSm	LD (IX-12+CHP.Env_En),0
0671+++8E6A~            	CALL SETORN
0672+++8E6A~            PD_SAM_	LD A,(BC)
0673+++8E6A~            	INC BC
0674+++8E6A~            	RRCA
0675+++8E6A~            0676+++8E6A~            PD_SAM	CALL SETSAM
0677+++8E6A~            	JR PD_LOOP
0678+++8E6A~            0679+++8E6A~            PD_VOL	RRCA
0680+++8E6A~            	RRCA
0681+++8E6A~            	RRCA
0682+++8E6A~            	RRCA
0683+++8E6A~            	LD (IX-12+CHP.Volume),A
0684+++8E6A~            	JR PD_LP2
0685+++8E6A~            	
0686+++8E6A~            PD_EOff	LD (IX-12+CHP.Env_En),A
0687+++8E6A~            	LD (IX-12+CHP.PsInOr),A
0688+++8E6A~            	JR PD_LP2
0689+++8E6A~            0690+++8E6A~            PD_SorE	DEC A
0691+++8E6A~            	JR NZ,PD_ENV
0692+++8E6A~            	LD A,(BC)
0693+++8E6A~            	INC BC
0694+++8E6A~            	LD (IX-12+CHP.NNtSkp),A
0695+++8E6A~            	JR PD_LP2
0696+++8E6A~            0697+++8E6A~            PD_ENV	CALL SETENV
0698+++8E6A~            	JR PD_LP2
0699+++8E6A~            0700+++8E6A~            PD_ORN	CALL SETORN
0701+++8E6A~            	JR PD_LOOP
0702+++8E6A~            0703+++8E6A~            PD_ESAM	LD (IX-12+CHP.Env_En),A
0704+++8E6A~            	LD (IX-12+CHP.PsInOr),A
0705+++8E6A~            	CALL NZ,SETENV
0706+++8E6A~            	JR PD_SAM_
0707+++8E6A~            0708+++8E6A~            PT3PD	LD A,(IX-12+CHP.Note)
0709+++8E6A~            	LD (PrNote+1),A
0710+++8E6A~            	LD L,(IX-12+CHP.CrTnSl)
0711+++8E6A~            	LD H,(IX-12+CHP.CrTnSl+1)
0712+++8E6A~            	LD (PrSlide+1),HL
0713+++8E6A~            0714+++8E6A~            PD_LOOP	LD DE,#2010
0715+++8E6A~            PD_LP2	LD A,(BC)
0716+++8E6A~            	INC BC
0717+++8E6A~            	ADD A,E
0718+++8E6A~            	JR C,PD_OrSm
0719+++8E6A~            	ADD A,D
0720+++8E6A~            	JR Z,PD_FIN
0721+++8E6A~            	JR C,PD_SAM
0722+++8E6A~            	ADD A,E
0723+++8E6A~            	JR Z,PD_REL
0724+++8E6A~            	JR C,PD_VOL
0725+++8E6A~            	ADD A,E
0726+++8E6A~            	JR Z,PD_EOff
0727+++8E6A~            	JR C,PD_SorE
0728+++8E6A~            	ADD A,96
0729+++8E6A~            	JR C,PD_NOTE
0730+++8E6A~            	ADD A,E
0731+++8E6A~            	JR C,PD_ORN
0732+++8E6A~            	ADD A,D
0733+++8E6A~            	JR C,PD_NOIS
0734+++8E6A~            	ADD A,E
0735+++8E6A~            	JR C,PD_ESAM
0736+++8E6A~            	ADD A,A
0737+++8E6A~            	LD E,A
0738+++8E6A~            	LD HL,(SPCCOMS+#FF20-#2000)&65535
0739+++8E6A~            	ADD HL,DE
0740+++8E6A~            	LD E,(HL)
0741+++8E6A~            	INC HL
0742+++8E6A~            	LD D,(HL)
0743+++8E6A~            	PUSH DE
0744+++8E6A~            	JR PD_LOOP
0745+++8E6A~            0746+++8E6A~            PD_NOIS	LD (IY-100+VRS.Ns_Base),A
0747+++8E6A~            	JR PD_LP2
0748+++8E6A~            0749+++8E6A~            PD_REL	RES 0,(IX-12+CHP.Flags)
0750+++8E6A~            	JR PD_RES
0751+++8E6A~            0752+++8E6A~            PD_NOTE	LD (IX-12+CHP.Note),A
0753+++8E6A~            	SET 0,(IX-12+CHP.Flags)
0754+++8E6A~            	XOR A
0755+++8E6A~            0756+++8E6A~            PD_RES	LD (PDSP_+1),SP
0757+++8E6A~            	LD SP,IX
0758+++8E6A~            	LD H,A
0759+++8E6A~            	LD L,A
0760+++8E6A~            	PUSH HL
0761+++8E6A~            	PUSH HL
0762+++8E6A~            	PUSH HL
0763+++8E6A~            	PUSH HL
0764+++8E6A~            	PUSH HL
0765+++8E6A~            	PUSH HL
0766+++8E6A~            PDSP_	LD SP,#3131
0767+++8E6A~            0768+++8E6A~            PD_FIN	LD A,(IX-12+CHP.NNtSkp)
0769+++8E6A~            	LD (IX-12+CHP.NtSkCn),A
0770+++8E6A~            	RET
0771+++8E6A~            0772+++8E6A~            C_PORTM LD A,(BC)
0773+++8E6A~            	INC BC
0774+++8E6A~            ;SKIP PRECALCULATED TONE DELTA (BECAUSE
0775+++8E6A~            ;CANNOT BE RIGHT AFTER PT3 COMPILATION)
0776+++8E6A~            	INC BC
0777+++8E6A~            	INC BC
0778+++8E6A~            	EX AF,AF'
0779+++8E6A~            	LD A,(BC) ;SIGNED TONE STEP
0780+++8E6A~            	INC BC
0781+++8E6A~            	LD (LoStep),A
0782+++8E6A~            	LD A,(BC)
0783+++8E6A~            	INC BC
0784+++8E6A~            	AND A
0785+++8E6A~            	EX AF,AF'
0786+++8E6A~            	LD L,(IX-12+CHP.CrTnSl)
0787+++8E6A~            	LD H,(IX-12+CHP.CrTnSl+1)
0788+++8E6A~            0789+++8E6A~            ;Set portamento variables
0790+++8E6A~            ;A - Delay; A' - Hi(Step); ZF' - (A'=0); HL - CrTnSl
0791+++8E6A~            0792+++8E6A~            SETPORT	RES 2,(IX-12+CHP.Flags)
0793+++8E6A~            	LD (IX-12+CHP.TnSlDl),A
0794+++8E6A~            	LD (IX-12+CHP.TSlCnt),A
0795+++8E6A~            	PUSH HL
0796+++8E6A~            	LD DE,NT_
0797+++8E6A~            	LD A,(IX-12+CHP.Note)
0798+++8E6A~            	LD (IX-12+CHP.SlToNt),A
0799+++8E6A~            	ADD A,A
0800+++8E6A~            	LD L,A
0801+++8E6A~            	LD H,0
0802+++8E6A~            	ADD HL,DE
0803+++8E6A~            	LD A,(HL)
0804+++8E6A~            	INC HL
0805+++8E6A~            	LD H,(HL)
0806+++8E6A~            	LD L,A
0807+++8E6A~            	PUSH HL
0808+++8E6A~            PrNote	LD A,#3E
0809+++8E6A~            	LD (IX-12+CHP.Note),A
0810+++8E6A~            	ADD A,A
0811+++8E6A~            	LD L,A
0812+++8E6A~            	LD H,0
0813+++8E6A~            	ADD HL,DE
0814+++8E6A~            	LD E,(HL)
0815+++8E6A~            	INC HL
0816+++8E6A~            	LD D,(HL)
0817+++8E6A~            	POP HL
0818+++8E6A~            	SBC HL,DE
0819+++8E6A~            	LD (IX-12+CHP.TnDelt),L
0820+++8E6A~            	LD (IX-12+CHP.TnDelt+1),H
0821+++8E6A~            	POP DE
0822+++8E6A~            Version EQU $+1
0823+++8E6A~            	LD A,#3E
0824+++8E6A~            	CP 6
0825+++8E6A~            	JR C,OLDPRTM ;Old 3xxx for PT v3.5-
0826+++8E6A~            PrSlide	LD DE,#1111
0827+++8E6A~            	LD (IX-12+CHP.CrTnSl),E
0828+++8E6A~            	LD (IX-12+CHP.CrTnSl+1),D
0829+++8E6A~            LoStep	EQU $+1
0830+++8E6A~            OLDPRTM	LD A,#3E
0831+++8E6A~            	EX AF,AF'
0832+++8E6A~            	JR Z,NOSIG
0833+++8E6A~            	EX DE,HL
0834+++8E6A~            NOSIG	SBC HL,DE
0835+++8E6A~            	JP P,SET_STP
0836+++8E6A~            	CPL
0837+++8E6A~            	EX AF,AF'
0838+++8E6A~            	NEG
0839+++8E6A~            	EX AF,AF'
0840+++8E6A~            SET_STP	LD (IX-12+CHP.TSlStp+1),A
0841+++8E6A~            	EX AF,AF'
0842+++8E6A~            	LD (IX-12+CHP.TSlStp),A
0843+++8E6A~            	LD (IX-12+CHP.COnOff),0
0844+++8E6A~            	RET
0845+++8E6A~            0846+++8E6A~            C_GLISS	SET 2,(IX-12+CHP.Flags)
0847+++8E6A~            	LD A,(BC)
0848+++8E6A~            	INC BC
0849+++8E6A~            	LD (IX-12+CHP.TnSlDl),A
0850+++8E6A~            	AND A
0851+++8E6A~            	JR NZ,GL36
0852+++8E6A~            	LD A,(Version) ;AlCo PT3.7+
0853+++8E6A~            	CP 7
0854+++8E6A~            	SBC A,A
0855+++8E6A~            	INC A
0856+++8E6A~            GL36	LD (IX-12+CHP.TSlCnt),A
0857+++8E6A~            	LD A,(BC)
0858+++8E6A~            	INC BC
0859+++8E6A~            	EX AF,AF'
0860+++8E6A~            	LD A,(BC)
0861+++8E6A~            	INC BC
0862+++8E6A~            	JR SET_STP
0863+++8E6A~            0864+++8E6A~            C_SMPOS	LD A,(BC)
0865+++8E6A~            	INC BC
0866+++8E6A~            	LD (IX-12+CHP.PsInSm),A
0867+++8E6A~            	RET
0868+++8E6A~            0869+++8E6A~            C_ORPOS	LD A,(BC)
0870+++8E6A~            	INC BC
0871+++8E6A~            	LD (IX-12+CHP.PsInOr),A
0872+++8E6A~            	RET
0873+++8E6A~            0874+++8E6A~            C_VIBRT	LD A,(BC)
0875+++8E6A~            	INC BC
0876+++8E6A~            	LD (IX-12+CHP.OnOffD),A
0877+++8E6A~            	LD (IX-12+CHP.COnOff),A
0878+++8E6A~            	LD A,(BC)
0879+++8E6A~            	INC BC
0880+++8E6A~            	LD (IX-12+CHP.OffOnD),A
0881+++8E6A~            	XOR A
0882+++8E6A~            	LD (IX-12+CHP.TSlCnt),A
0883+++8E6A~            	LD (IX-12+CHP.CrTnSl),A
0884+++8E6A~            	LD (IX-12+CHP.CrTnSl+1),A
0885+++8E6A~            	RET
0886+++8E6A~            0887+++8E6A~            C_ENGLS	LD A,(BC)
0888+++8E6A~            	INC BC
0889+++8E6A~            	LD (IY-100+VRS.Env_Del),A
0890+++8E6A~            	LD (IY-100+VRS.CurEDel),A
0891+++8E6A~            	LD A,(BC)
0892+++8E6A~            	INC BC
0893+++8E6A~            	LD L,A
0894+++8E6A~            	LD A,(BC)
0895+++8E6A~            	INC BC
0896+++8E6A~            	LD H,A
0897+++8E6A~            	LD (IY-100+VRS.ESldAdd),L
0898+++8E6A~            	LD (IY-100+VRS.ESldAdd+1),H
0899+++8E6A~            	RET
0900+++8E6A~            0901+++8E6A~            C_DELAY	LD A,(BC)
0902+++8E6A~            	INC BC
0903+++8E6A~            	LD (IY-100+VRS.Delay),A
0904+++8E6A~            	LD HL,VARS2+VRS.ModNum ;if AlCo_TS
0905+++8E6A~            	BIT 1,(HL)
0906+++8E6A~            	RET Z
0907+++8E6A~            	LD (VARS1+VRS.Delay),A
0908+++8E6A~            	LD (VARS1+VRS.DelyCnt),A
0909+++8E6A~            	LD (VARS2+VRS.Delay),A
0910+++8E6A~            	RET
0911+++8E6A~            	
0912+++8E6A~            SETENV	LD (IX-12+CHP.Env_En),E
0913+++8E6A~            	LD (IY-100+VRS.AYREGS+EnvTp),A
0914+++8E6A~            	LD A,(BC)
0915+++8E6A~            	INC BC
0916+++8E6A~            	LD H,A
0917+++8E6A~            	LD A,(BC)
0918+++8E6A~            	INC BC
0919+++8E6A~            	LD L,A
0920+++8E6A~            	CALL SETENBS
0921+++8E6A~            	XOR A
0922+++8E6A~            	LD (IX-12+CHP.PsInOr),A
0923+++8E6A~            	LD (IY-100+VRS.CurEDel),A
0924+++8E6A~            	LD H,A
0925+++8E6A~            	LD L,A
0926+++8E6A~            	JP SETESLD
0927+++8E6A~            0928+++8E6A~            SETORN	ADD A,A
0929+++8E6A~            	LD E,A
0930+++8E6A~            	LD D,0
0931+++8E6A~            	LD (IX-12+CHP.PsInOr),D
0932+++8E6A~            	LD L,(IY-100+VRS.OrnPtrs)
0933+++8E6A~            	LD H,(IY-100+VRS.OrnPtrs+1)
0934+++8E6A~            	ADD HL,DE
0935+++8E6A~            	LD E,(HL)
0936+++8E6A~            	INC HL
0937+++8E6A~            	LD D,(HL)
0938+++8E6A~            	LD L,(IY-100+VRS.MODADDR)
0939+++8E6A~            	LD H,(IY-100+VRS.MODADDR+1)
0940+++8E6A~            	ADD HL,DE
0941+++8E6A~            	LD (IX-12+CHP.OrnPtr),L
0942+++8E6A~            	LD (IX-12+CHP.OrnPtr+1),H
0943+++8E6A~            C_NOP	RET
0944+++8E6A~            0945+++8E6A~            SETSAM	ADD A,A
0946+++8E6A~            	LD E,A
0947+++8E6A~            	LD D,0
0948+++8E6A~            	LD L,(IY-100+VRS.SamPtrs);
0949+++8E6A~            	LD H,(IY-100+VRS.SamPtrs+1);
0950+++8E6A~            	ADD HL,DE
0951+++8E6A~            	LD E,(HL)
0952+++8E6A~            	INC HL
0953+++8E6A~            	LD D,(HL)
0954+++8E6A~            	LD L,(IY-100+VRS.MODADDR)
0955+++8E6A~            	LD H,(IY-100+VRS.MODADDR+1)
0956+++8E6A~            	ADD HL,DE
0957+++8E6A~            	LD (IX-12+CHP.SamPtr),L
0958+++8E6A~            	LD (IX-12+CHP.SamPtr+1),H
0959+++8E6A~            	RET
0960+++8E6A~            0961+++8E6A~            ;ALL 16 ADDRESSES TO PROTECT FROM BROKEN PT3 MODULES
0962+++8E6A~            SPCCOMS DW C_NOP
0963+++8E6A~            	DW C_GLISS
0964+++8E6A~            	DW C_PORTM
0965+++8E6A~            	DW C_SMPOS
0966+++8E6A~            	DW C_ORPOS
0967+++8E6A~            	DW C_VIBRT
0968+++8E6A~            	DW C_NOP
0969+++8E6A~            	DW C_NOP
0970+++8E6A~            	DW C_ENGLS
0971+++8E6A~            	DW C_DELAY
0972+++8E6A~            	DW C_NOP
0973+++8E6A~            	DW C_NOP
0974+++8E6A~            	DW C_NOP
0975+++8E6A~            	DW C_NOP
0976+++8E6A~            	DW C_NOP
0977+++8E6A~            	DW C_NOP
0978+++8E6A~            0979+++8E6A~            CHREGS	CALL GETIX
0980+++8E6A~            	XOR A
0981+++8E6A~            	LD (Ampl),A
0982+++8E6A~            	BIT 0,(IX+CHP.Flags)
0983+++8E6A~            	PUSH HL
0984+++8E6A~            	JP Z,CH_EXIT
0985+++8E6A~            	LD (CSP_+1),SP
0986+++8E6A~            	LD L,(IX+CHP.OrnPtr)
0987+++8E6A~            	LD H,(IX+CHP.OrnPtr+1)
0988+++8E6A~            	LD SP,HL
0989+++8E6A~            	POP DE
0990+++8E6A~            	LD H,A
0991+++8E6A~            	LD A,(IX+CHP.PsInOr)
0992+++8E6A~            	LD L,A
0993+++8E6A~            	ADD HL,SP
0994+++8E6A~            	INC A
0995+++8E6A~            		;PT2	PT3
0996+++8E6A~            OrnCP	INC A	;CP E	CP D
0997+++8E6A~            	JR C,CH_ORPS
0998+++8E6A~            OrnLD	DB 1	;LD A,D	LD A,E
0999+++8E6A~            CH_ORPS	LD (IX+CHP.PsInOr),A
1000+++8E6A~            	LD A,(IX+CHP.Note)
1001+++8E6A~            	ADD A,(HL)
1002+++8E6A~            	JP P,CH_NTP
1003+++8E6A~            	XOR A
1004+++8E6A~            CH_NTP	CP 96
1005+++8E6A~            	JR C,CH_NOK
1006+++8E6A~            	LD A,95
1007+++8E6A~            CH_NOK	ADD A,A
1008+++8E6A~            	EX AF,AF'
1009+++8E6A~            	LD L,(IX+CHP.SamPtr)
1010+++8E6A~            	LD H,(IX+CHP.SamPtr+1)
1011+++8E6A~            	LD SP,HL
1012+++8E6A~            	POP DE
1013+++8E6A~            	LD H,0
1014+++8E6A~            	LD A,(IX+CHP.PsInSm)
1015+++8E6A~            	LD B,A
1016+++8E6A~            	ADD A,A
1017+++8E6A~            SamClc2	ADD A,A ;or ADD A,B for PT2
1018+++8E6A~            	LD L,A
1019+++8E6A~            	ADD HL,SP
1020+++8E6A~            	LD SP,HL
1021+++8E6A~            	LD A,B
1022+++8E6A~            	INC A
1023+++8E6A~            		;PT2	PT3
1024+++8E6A~            SamCP	INC A	;CP E	CP D
1025+++8E6A~            	JR C,CH_SMPS
1026+++8E6A~            SamLD	DB 1	;LD A,D	LD A,E
1027+++8E6A~            CH_SMPS	LD (IX+CHP.PsInSm),A
1028+++8E6A~            	POP BC
1029+++8E6A~            	POP HL
1030+++8E6A~            1031+++8E6A~            ;Convert PT2 sample to PT3
1032+++8E6A~            		;PT2		PT3
1033+++8E6A~            SamCnv	POP HL  ;BIT 2,C	JR e_
1034+++8E6A~            	POP HL	
1035+++8E6A~            	LD H,B
1036+++8E6A~            	JR NZ,$+8
1037+++8E6A~            	EX DE,HL
1038+++8E6A~            	AND A
1039+++8E6A~            	SBC HL,HL
1040+++8E6A~            	SBC HL,DE
1041+++8E6A~            	LD D,C
1042+++8E6A~            	RR C
1043+++8E6A~            	SBC A,A
1044+++8E6A~            	CPL
1045+++8E6A~            	AND #3E
1046+++8E6A~            	RR C
1047+++8E6A~            	RR B
1048+++8E6A~            	AND C
1049+++8E6A~            	LD C,A
1050+++8E6A~            	LD A,B
1051+++8E6A~            	RRA
1052+++8E6A~            	RRA
1053+++8E6A~            	RR D
1054+++8E6A~            	RRA
1055+++8E6A~            	AND #9F
1056+++8E6A~            	LD B,A
1057+++8E6A~            1058+++8E6A~            e_	LD E,(IX+CHP.TnAcc)
1059+++8E6A~            	LD D,(IX+CHP.TnAcc+1)
1060+++8E6A~            	ADD HL,DE
1061+++8E6A~            	BIT 6,B
1062+++8E6A~            	JR Z,CH_NOAC
1063+++8E6A~            	LD (IX+CHP.TnAcc),L
1064+++8E6A~            	LD (IX+CHP.TnAcc+1),H
1065+++8E6A~            CH_NOAC EX DE,HL
1066+++8E6A~            	EX AF,AF'
1067+++8E6A~            	ADD A,NT_&255
1068+++8E6A~            	LD L,A
1069+++8E6A~            	ADC A,NT_/256
1070+++8E6A~            	SUB L
1071+++8E6A~            	LD H,A
1072+++8E6A~            	LD SP,HL
1073+++8E6A~            	POP HL
1074+++8E6A~            	ADD HL,DE
1075+++8E6A~            	LD E,(IX+CHP.CrTnSl)
1076+++8E6A~            	LD D,(IX+CHP.CrTnSl+1)
1077+++8E6A~            	ADD HL,DE
1078+++8E6A~            CSP_	LD SP,#3131
1079+++8E6A~            	EX (SP),HL
1080+++8E6A~            	XOR A
1081+++8E6A~            	OR (IX+CHP.TSlCnt)
1082+++8E6A~            	JR Z,CH_AMP
1083+++8E6A~            	DEC (IX+CHP.TSlCnt)
1084+++8E6A~            	JR NZ,CH_AMP
1085+++8E6A~            	LD A,(IX+CHP.TnSlDl)
1086+++8E6A~            	LD (IX+CHP.TSlCnt),A
1087+++8E6A~            	LD L,(IX+CHP.TSlStp)
1088+++8E6A~            	LD H,(IX+CHP.TSlStp+1)
1089+++8E6A~            	LD A,H
1090+++8E6A~            	ADD HL,DE
1091+++8E6A~            	LD (IX+CHP.CrTnSl),L
1092+++8E6A~            	LD (IX+CHP.CrTnSl+1),H
1093+++8E6A~            	BIT 2,(IX+CHP.Flags)
1094+++8E6A~            	JR NZ,CH_AMP
1095+++8E6A~            	LD E,(IX+CHP.TnDelt)
1096+++8E6A~            	LD D,(IX+CHP.TnDelt+1)
1097+++8E6A~            	AND A
1098+++8E6A~            	JR Z,CH_STPP
1099+++8E6A~            	EX DE,HL
1100+++8E6A~            CH_STPP SBC HL,DE
1101+++8E6A~            	JP M,CH_AMP
1102+++8E6A~            	LD A,(IX+CHP.SlToNt)
1103+++8E6A~            	LD (IX+CHP.Note),A
1104+++8E6A~            	XOR A
1105+++8E6A~            	LD (IX+CHP.TSlCnt),A
1106+++8E6A~            	LD (IX+CHP.CrTnSl),A
1107+++8E6A~            	LD (IX+CHP.CrTnSl+1),A
1108+++8E6A~            CH_AMP	LD A,(IX+CHP.CrAmSl)
1109+++8E6A~            	BIT 7,C
1110+++8E6A~            	JR Z,CH_NOAM
1111+++8E6A~            	BIT 6,C
1112+++8E6A~            	JR Z,CH_AMIN
1113+++8E6A~            	CP 15
1114+++8E6A~            	JR Z,CH_NOAM
1115+++8E6A~            	INC A
1116+++8E6A~            	JR CH_SVAM
1117+++8E6A~            CH_AMIN	CP -15
1118+++8E6A~            	JR Z,CH_NOAM
1119+++8E6A~            	DEC A
1120+++8E6A~            CH_SVAM	LD (IX+CHP.CrAmSl),A
1121+++8E6A~            CH_NOAM	LD L,A
1122+++8E6A~            	LD A,B
1123+++8E6A~            	AND 15
1124+++8E6A~            	ADD A,L
1125+++8E6A~            	JP P,CH_APOS
1126+++8E6A~            	XOR A
1127+++8E6A~            CH_APOS	CP 16
1128+++8E6A~            	JR C,CH_VOL
1129+++8E6A~            	LD A,15
1130+++8E6A~            CH_VOL	OR (IX+CHP.Volume)
1131+++8E6A~            	ADD A,VT_&255
1132+++8E6A~            	LD L,A
1133+++8E6A~            	ADC A,VT_/256
1134+++8E6A~            	SUB L
1135+++8E6A~            	LD H,A
1136+++8E6A~            	LD A,(HL)
1137+++8E6A~            CH_ENV	BIT 0,C
1138+++8E6A~            	JR NZ,CH_NOEN
1139+++8E6A~            	OR (IX+CHP.Env_En)
1140+++8E6A~            CH_NOEN	LD (Ampl),A
1141+++8E6A~            	BIT 7,B
1142+++8E6A~            	LD A,C
1143+++8E6A~            	JR Z,NO_ENSL
1144+++8E6A~            	RLA
1145+++8E6A~            	RLA
1146+++8E6A~            	SRA A
1147+++8E6A~            	SRA A
1148+++8E6A~            	SRA A
1149+++8E6A~            	ADD A,(IX+CHP.CrEnSl) ;SEE COMMENT BELOW
1150+++8E6A~            	BIT 5,B
1151+++8E6A~            	JR Z,NO_ENAC
1152+++8E6A~            	LD (IX+CHP.CrEnSl),A
1153+++8E6A~            NO_ENAC	ADD A,(IY-100+VRS.AddToEn) ;BUG IN PT3 - NEED WORD HERE
1154+++8E6A~            	LD (IY-100+VRS.AddToEn),A
1155+++8E6A~            	JR CH_MIX
1156+++8E6A~            NO_ENSL RRA
1157+++8E6A~            	ADD A,(IX+CHP.CrNsSl)
1158+++8E6A~            	LD (IY-100+VRS.AddToNs),A
1159+++8E6A~            	BIT 5,B
1160+++8E6A~            	JR Z,CH_MIX
1161+++8E6A~            	LD (IX+CHP.CrNsSl),A
1162+++8E6A~            CH_MIX	LD A,B
1163+++8E6A~            	RRA
1164+++8E6A~            	AND #48
1165+++8E6A~            CH_EXIT	OR (IY-100+VRS.AYREGS+Mixer)
1166+++8E6A~            	RRCA
1167+++8E6A~            	LD (IY-100+VRS.AYREGS+Mixer),A
1168+++8E6A~            	POP HL
1169+++8E6A~            	XOR A
1170+++8E6A~            	OR (IX+CHP.COnOff)
1171+++8E6A~            	RET Z
1172+++8E6A~            	DEC (IX+CHP.COnOff)
1173+++8E6A~            	RET NZ
1174+++8E6A~            	XOR (IX+CHP.Flags)
1175+++8E6A~            	LD (IX+CHP.Flags),A
1176+++8E6A~            	RRA
1177+++8E6A~            	LD A,(IX+CHP.OnOffD)
1178+++8E6A~            	JR C,CH_ONDL
1179+++8E6A~            	LD A,(IX+CHP.OffOnD)
1180+++8E6A~            CH_ONDL	LD (IX+CHP.COnOff),A
1181+++8E6A~            	RET
1182+++8E6A~            1183+++8E6A~            PLAY_	XOR A
1184+++8E6A~            	LD (IY-100+VRS.AddToEn),A
1185+++8E6A~            	LD (IY-100+VRS.AYREGS+Mixer),A
1186+++8E6A~            	DEC A
1187+++8E6A~            	LD (IY-100+VRS.AYREGS+EnvTp),A
1188+++8E6A~            	DEC (IY-100+VRS.DelyCnt)
1189+++8E6A~            	JP NZ,PL2
1190+++8E6A~            	DEC (IY-100+VRS.ChanA+CHP.NtSkCn)
1191+++8E6A~            	JR NZ,PL1B
1192+++8E6A~            	LD C,(IY-100+VRS.AdInPtA)
1193+++8E6A~            	LD B,(IY-100+VRS.AdInPtA+1)
1194+++8E6A~            	LD A,(BC)
1195+++8E6A~            	AND A
1196+++8E6A~            	JR NZ,PL1A
1197+++8E6A~            	LD D,A
1198+++8E6A~            	LD (IY-100+VRS.Ns_Base),A
1199+++8E6A~            	LD L,(IY-100+VRS.CrPsPtr)
1200+++8E6A~            	LD H,(IY-100+VRS.CrPsPtr+1)
1201+++8E6A~            	INC HL
1202+++8E6A~            	LD A,(HL)
1203+++8E6A~            	INC A
1204+++8E6A~            	JR NZ,PLNLP
1205+++8E6A~            1206+++8E6A~            	IF LoopChecker
1207+++8E6A~            	CALL CHECKLP
1208+++8E6A~            	ENDIF
1209+++8E6A~            1210+++8E6A~            	LD L,(IY-100+VRS.LPosPtr)
1211+++8E6A~            	LD H,(IY-100+VRS.LPosPtr+1)
1212+++8E6A~            	LD A,(HL)
1213+++8E6A~            	INC A
1214+++8E6A~            PLNLP	CALL SETCPPT
1215+++8E6A~            	DEC A
1216+++8E6A~            	BIT 1,(IY-100+VRS.ModNum)
1217+++8E6A~            	JR Z,NoAlCo
1218+++8E6A~            TSSub	EQU $+1
1219+++8E6A~            	SUB #D6
1220+++8E6A~            	CPL
1221+++8E6A~            NoAlCo
1222+++8E6A~            		;PT2		PT3
1223+++8E6A~            PsCalc	DEC A	;ADD A,A	NOP
1224+++8E6A~            	DEC A	;ADD A,(HL)	NOP
1225+++8E6A~            	ADD A,A
1226+++8E6A~            	LD E,A
1227+++8E6A~            	RL D
1228+++8E6A~            1229+++8E6A~            	IF CurPosCounter
1230+++8E6A~            	LD A,L
1231+++8E6A~            	SUB (IY-100+VRS.PosSub)
1232+++8E6A~            	LD (IY-100+VRS.CurPos),A
1233+++8E6A~            	ENDIF
1234+++8E6A~            1235+++8E6A~            	LD L,(IY-100+VRS.PatsPtr)
1236+++8E6A~            	LD H,(IY-100+VRS.PatsPtr+1)
1237+++8E6A~            	ADD HL,DE
1238+++8E6A~            	LD E,(IY-100+VRS.MODADDR)
1239+++8E6A~            	LD D,(IY-100+VRS.MODADDR+1)
1240+++8E6A~            	LD (PSP_+1),SP
1241+++8E6A~            	LD SP,HL
1242+++8E6A~            	POP HL
1243+++8E6A~            	ADD HL,DE
1244+++8E6A~            	LD B,H
1245+++8E6A~            	LD C,L
1246+++8E6A~            	POP HL
1247+++8E6A~            	ADD HL,DE
1248+++8E6A~            	LD (IY-100+VRS.AdInPtB),L
1249+++8E6A~            	LD (IY-100+VRS.AdInPtB+1),H
1250+++8E6A~            	POP HL
1251+++8E6A~            	ADD HL,DE
1252+++8E6A~            	LD (IY-100+VRS.AdInPtC),L
1253+++8E6A~            	LD (IY-100+VRS.AdInPtC+1),H
1254+++8E6A~            PSP_	LD SP,#3131
1255+++8E6A~            PL1A	LD DE,VRS.ChanA+12-100
1256+++8E6A~            	CALL PTDECOD
1257+++8E6A~            	LD (IY-100+VRS.AdInPtA),C
1258+++8E6A~            	LD (IY-100+VRS.AdInPtA+1),B
1259+++8E6A~            1260+++8E6A~            PL1B	DEC (IY-100+VRS.ChanB+CHP.NtSkCn)
1261+++8E6A~            	JR NZ,PL1C
1262+++8E6A~            	LD DE,VRS.ChanB+12-100
1263+++8E6A~            	LD C,(IY-100+VRS.AdInPtB)
1264+++8E6A~            	LD B,(IY-100+VRS.AdInPtB+1)
1265+++8E6A~            	CALL PTDECOD
1266+++8E6A~            	LD (IY-100+VRS.AdInPtB),C
1267+++8E6A~            	LD (IY-100+VRS.AdInPtB+1),B
1268+++8E6A~            1269+++8E6A~            PL1C	DEC (IY-100+VRS.ChanC+CHP.NtSkCn)
1270+++8E6A~            	JR NZ,PL1D
1271+++8E6A~            	LD DE,VRS.ChanC+12-100
1272+++8E6A~            	LD C,(IY-100+VRS.AdInPtC)
1273+++8E6A~            	LD B,(IY-100+VRS.AdInPtC+1)
1274+++8E6A~            	CALL PTDECOD
1275+++8E6A~            	LD (IY-100+VRS.AdInPtC),C
1276+++8E6A~            	LD (IY-100+VRS.AdInPtC+1),B
1277+++8E6A~            1278+++8E6A~            PL1D	LD A,(IY-100+VRS.Delay)
1279+++8E6A~            	LD (IY-100+VRS.DelyCnt),A
1280+++8E6A~            1281+++8E6A~            PL2	LD DE,VRS.ChanA-100
1282+++8E6A~            	LD L,(IY-100+VRS.AYREGS+TonA)
1283+++8E6A~            	LD H,(IY-100+VRS.AYREGS+TonA+1)
1284+++8E6A~            	CALL CHREGS
1285+++8E6A~            	LD (IY-100+VRS.AYREGS+TonA),L
1286+++8E6A~            	LD (IY-100+VRS.AYREGS+TonA+1),H
1287+++8E6A~            Ampl	EQU $+1
1288+++8E6A~            	LD A,#3E
1289+++8E6A~            	LD (IY-100+VRS.AYREGS+AmplA),A
1290+++8E6A~            	LD DE,VRS.ChanB-100
1291+++8E6A~            	LD L,(IY-100+VRS.AYREGS+TonB)
1292+++8E6A~            	LD H,(IY-100+VRS.AYREGS+TonB+1)
1293+++8E6A~            	CALL CHREGS
1294+++8E6A~            	LD (IY-100+VRS.AYREGS+TonB),L
1295+++8E6A~            	LD (IY-100+VRS.AYREGS+TonB+1),H
1296+++8E6A~            	LD A,(Ampl)
1297+++8E6A~            	LD (IY-100+VRS.AYREGS+AmplB),A
1298+++8E6A~            	LD DE,VRS.ChanC-100
1299+++8E6A~            	LD L,(IY-100+VRS.AYREGS+TonC)
1300+++8E6A~            	LD H,(IY-100+VRS.AYREGS+TonC+1)
1301+++8E6A~            	CALL CHREGS
1302+++8E6A~            	LD (IY-100+VRS.AYREGS+TonC),L
1303+++8E6A~            	LD (IY-100+VRS.AYREGS+TonC+1),H
1304+++8E6A~            	LD A,(Ampl)
1305+++8E6A~            	LD (IY-100+VRS.AYREGS+AmplC),A
1306+++8E6A~            1307+++8E6A~            	LD A,(IY-100+VRS.Ns_Base)
1308+++8E6A~            	ADD (IY-100+VRS.AddToNs)
1309+++8E6A~            	LD (IY-100+VRS.AYREGS+Noise),A
1310+++8E6A~            1311+++8E6A~            	LD A,(IY-100+VRS.AddToEn)
1312+++8E6A~            	LD E,A
1313+++8E6A~            	ADD A,A
1314+++8E6A~            	SBC A,A
1315+++8E6A~            	LD D,A
1316+++8E6A~            	LD L,(IY-100+VRS.EnvBase)
1317+++8E6A~            	LD H,(IY-100+VRS.EnvBase+1)
1318+++8E6A~            	ADD HL,DE
1319+++8E6A~            	LD E,(IY-100+VRS.CurESld)
1320+++8E6A~            	LD D,(IY-100+VRS.CurESld+1)
1321+++8E6A~            	ADD HL,DE
1322+++8E6A~            	LD (IY-100+VRS.AYREGS+Env),L
1323+++8E6A~            	LD (IY-100+VRS.AYREGS+Env+1),H
1324+++8E6A~            1325+++8E6A~            	XOR A
1326+++8E6A~            	OR (IY-100+VRS.CurEDel)
1327+++8E6A~            	RET Z
1328+++8E6A~            	DEC (IY-100+VRS.CurEDel)
1329+++8E6A~            	RET NZ
1330+++8E6A~            	LD A,(IY-100+VRS.Env_Del)
1331+++8E6A~            	LD (IY-100+VRS.CurEDel),A
1332+++8E6A~            	LD L,(IY-100+VRS.ESldAdd)
1333+++8E6A~            	LD H,(IY-100+VRS.ESldAdd+1)
1334+++8E6A~            	ADD HL,DE
1335+++8E6A~            	JP SETESLD
1336+++8E6A~            1337+++8E6A~            PLAY    LD IY,VARS1+100
1338+++8E6A~            	CALL PLAY_
1339+++8E6A~            	LD A,(is_ts)
1340+++8E6A~            	AND A
1341+++8E6A~            	JR Z,PL_nts
1342+++8E6A~            	LD IY,VARS2+100
1343+++8E6A~            	CALL PLAY_
1344+++8E6A~            PL_nts
1345+++8E6A~            	IF Basic
1346+++8E6A~            	LD IY,#5C3A
1347+++8E6A~            	ENDIF
1348+++8E6A~            1349+++8E6A~            ROUT	LD BC,#FFFD
1350+++8E6A~              IFDEF ONtfm
1351+++8E6A~                LD L,#F9
1352+++8E6A~                OUT (C),L
1353+++8E6A~              ELSE
1354+++8E6A~            	LD A,(is_ts)
1355+++8E6A~            	AND A
1356+++8E6A~            	JR Z,r_nts ;keep old standard
1357+++8E6A~            	OUT (C),B
1358+++8E6A~                ENDIF
1359+++8E6A~            r_nts	EX AF,AF'
1360+++8E6A~            1361+++8E6A~            	IF ACBBAC
1362+++8E6A~            	LD IX,VARS1+VRS.AYREGS
1363+++8E6A~            	ELSE
1364+++8E6A~            	LD HL,VARS1+VRS.AYREGS
1365+++8E6A~            	ENDIF
1366+++8E6A~            1367+++8E6A~            	CALL ROUT_
1368+++8E6A~            	EX AF,AF'
1369+++8E6A~            	RET Z
1370+++8E6A~            	LD B,D
1371+++8E6A~            1372+++8E6A~                IFDEF ONtfm
1373+++8E6A~                LD A,#F8
1374+++8E6A~                ELSE
1375+++8E6A~            	CPL
1376+++8E6A~                ENDIF
1377+++8E6A~            	OUT (C),A
1378+++8E6A~            1379+++8E6A~            	IF ACBBAC
1380+++8E6A~            	LD IX,VARS2+VRS.AYREGS
1381+++8E6A~            	ELSE
1382+++8E6A~            	LD HL,VARS2+VRS.AYREGS
1383+++8E6A~            	ENDIF
1384+++8E6A~            1385+++8E6A~            ROUT_
1386+++8E6A~            	IF ACBBAC
1387+++8E6A~            	LD A,(SETUP)
1388+++8E6A~            	AND 12
1389+++8E6A~            	JR Z,ABC
1390+++8E6A~            	ADD A,CHTABLE
1391+++8E6A~            	LD E,A
1392+++8E6A~            	ADC A,CHTABLE/256
1393+++8E6A~            	SUB E
1394+++8E6A~            	LD D,A
1395+++8E6A~            	LD B,0
1396+++8E6A~            	PUSH IX
1397+++8E6A~            	POP HL
1398+++8E6A~            	LD A,(DE)
1399+++8E6A~            	INC DE
1400+++8E6A~            	LD C,A
1401+++8E6A~            	ADD HL,BC
1402+++8E6A~            	LD A,(IX+TonB)
1403+++8E6A~            	LD C,(HL)
1404+++8E6A~            	LD (IX+TonB),C
1405+++8E6A~            	LD (HL),A
1406+++8E6A~            	INC HL
1407+++8E6A~            	LD A,(IX+TonB+1)
1408+++8E6A~            	LD C,(HL)
1409+++8E6A~            	LD (IX+TonB+1),C
1410+++8E6A~            	LD (HL),A
1411+++8E6A~            	LD A,(DE)
1412+++8E6A~            	INC DE
1413+++8E6A~            	LD C,A
1414+++8E6A~            	ADD HL,BC
1415+++8E6A~            	LD A,(IX+AmplB)
1416+++8E6A~            	LD C,(HL)
1417+++8E6A~            	LD (IX+AmplB),C
1418+++8E6A~            	LD (HL),A
1419+++8E6A~            	LD A,(DE)
1420+++8E6A~            	INC DE
1421+++8E6A~            	LD (RxCA1),A
1422+++8E6A~            	XOR 8
1423+++8E6A~            	LD (RxCA2),A
1424+++8E6A~            	LD A,(DE)
1425+++8E6A~            	AND (IX+Mixer)
1426+++8E6A~            	LD E,A
1427+++8E6A~            	LD A,(IX+Mixer)
1428+++8E6A~            RxCA1	DB #E6
1429+++8E6A~            	AND %010010
1430+++8E6A~            	OR E
1431+++8E6A~            	LD E,A
1432+++8E6A~            	LD A,(IX+Mixer)
1433+++8E6A~            	AND %010010
1434+++8E6A~            RxCA2	OR E
1435+++8E6A~            	OR E
1436+++8E6A~            	LD (IX+Mixer),A
1437+++8E6A~            ABC
1438+++8E6A~            	ENDIF
1439+++8E6A~            1440+++8E6A~            	XOR A
1441+++8E6A~            	LD DE,#FFBF
1442+++8E6A~            1443+++8E6A~            	IF ACBBAC
1444+++8E6A~            	LD BC,#FFFD
1445+++8E6A~            	PUSH IX
1446+++8E6A~            	POP HL
1447+++8E6A~            	ENDIF
1448+++8E6A~            1449+++8E6A~            LOUT
1450+++8E6A~                IFDEF ONtfm
1451+++8E6A~                INF 
1452+++8E6A~                JP M,$-2
1453+++8E6A~                ENDIF 
1454+++8E6A~                OUT (C),A
1455+++8E6A~                IFDEF ONtfm
1456+++8E6A~                INF 
1457+++8E6A~                JP M,$-2
1458+++8E6A~                ENDIF 
1459+++8E6A~            	LD B,E
1460+++8E6A~            	OUTI 
1461+++8E6A~            	LD B,D
1462+++8E6A~            	INC A
1463+++8E6A~            	CP 13
1464+++8E6A~            	JR NZ,LOUT
1465+++8E6A~                IFDEF ONtfm
1466+++8E6A~                INF 
1467+++8E6A~                JP M,$-2
1468+++8E6A~                ENDIF 
1469+++8E6A~            	OUT (C),A
1470+++8E6A~            	LD A,(HL)
1471+++8E6A~            	AND A
1472+++8E6A~            	RET M
1473+++8E6A~                IFDEF ONtfm
1474+++8E6A~                INF 
1475+++8E6A~                JP M,$-2
1476+++8E6A~                ENDIF 
1477+++8E6A~            	LD B,E
1478+++8E6A~            	OUT (C),A
1479+++8E6A~            	RET
1480+++8E6A~            1481+++8E6A~            	IF ACBBAC
1482+++8E6A~            CHTABLE	EQU $-4
1483+++8E6A~            	DB 4,5,15,%001001,0,7,7,%100100
1484+++8E6A~            	ENDIF
1485+++8E6A~            1486+++8E6A~            NT_DATA	DB (T_NEW_0-T1_)*2
1487+++8E6A~            	DB TCNEW_0-T_
1488+++8E6A~            	DB (T_OLD_0-T1_)*2+1
1489+++8E6A~            	DB TCOLD_0-T_
1490+++8E6A~            	DB (T_NEW_1-T1_)*2+1
1491+++8E6A~            	DB TCNEW_1-T_
1492+++8E6A~            	DB (T_OLD_1-T1_)*2+1
1493+++8E6A~            	DB TCOLD_1-T_
1494+++8E6A~            	DB (T_NEW_2-T1_)*2
1495+++8E6A~            	DB TCNEW_2-T_
1496+++8E6A~            	DB (T_OLD_2-T1_)*2
1497+++8E6A~            	DB TCOLD_2-T_
1498+++8E6A~            	DB (T_NEW_3-T1_)*2
1499+++8E6A~            	DB TCNEW_3-T_
1500+++8E6A~            	DB (T_OLD_3-T1_)*2
1501+++8E6A~            	DB TCOLD_3-T_
1502+++8E6A~            1503+++8E6A~            T_
1504+++8E6A~            1505+++8E6A~            TCOLD_0	DB #00+1,#04+1,#08+1,#0A+1,#0C+1,#0E+1,#12+1,#14+1
1506+++8E6A~            	DB #18+1,#24+1,#3C+1,0
1507+++8E6A~            TCOLD_1	DB #5C+1,0
1508+++8E6A~            TCOLD_2	DB #30+1,#36+1,#4C+1,#52+1,#5E+1,#70+1,#82,#8C,#9C
1509+++8E6A~            	DB #9E,#A0,#A6,#A8,#AA,#AC,#AE,#AE,0
1510+++8E6A~            TCNEW_3	DB #56+1
1511+++8E6A~            TCOLD_3	DB #1E+1,#22+1,#24+1,#28+1,#2C+1,#2E+1,#32+1,#BE+1,0
1512+++8E6A~            TCNEW_0	DB #1C+1,#20+1,#22+1,#26+1,#2A+1,#2C+1,#30+1,#54+1
1513+++8E6A~            	DB #BC+1,#BE+1,0
1514+++8E6A~            TCNEW_1 EQU TCOLD_1
1515+++8E6A~            TCNEW_2	DB #1A+1,#20+1,#24+1,#28+1,#2A+1,#3A+1,#4C+1,#5E+1
1516+++8E6A~            	DB #BA+1,#BC+1,#BE+1,0
1517+++8E6A~            1518+++8E6A~            PT3EMPTYORN EQU $-1
1519+++8E6A~            	DB 1,0
1520+++8E6A~            1521+++8E6A~            ;first 12 values of tone tables (packed)
1522+++8E6A~            1523+++8E6A~            T_PACK	DB #06EC*2/256,#06EC*2&255
1524+++8E6A~            	DB #0755-#06EC
1525+++8E6A~            	DB #07C5-#0755
1526+++8E6A~            	DB #083B-#07C5
1527+++8E6A~            	DB #08B8-#083B
1528+++8E6A~            	DB #093D-#08B8
1529+++8E6A~            	DB #09CA-#093D
1530+++8E6A~            	DB #0A5F-#09CA
1531+++8E6A~            	DB #0AFC-#0A5F
1532+++8E6A~            	DB #0BA4-#0AFC
1533+++8E6A~            	DB #0C55-#0BA4
1534+++8E6A~            	DB #0D10-#0C55
1535+++8E6A~            	DB #066D*2/256,#066D*2&255
1536+++8E6A~            	DB #06CF-#066D
1537+++8E6A~            	DB #0737-#06CF
1538+++8E6A~            	DB #07A4-#0737
1539+++8E6A~            	DB #0819-#07A4
1540+++8E6A~            	DB #0894-#0819
1541+++8E6A~            	DB #0917-#0894
1542+++8E6A~            	DB #09A1-#0917
1543+++8E6A~            	DB #0A33-#09A1
1544+++8E6A~            	DB #0ACF-#0A33
1545+++8E6A~            	DB #0B73-#0ACF
1546+++8E6A~            	DB #0C22-#0B73
1547+++8E6A~            	DB #0CDA-#0C22
1548+++8E6A~            	DB #0704*2/256,#0704*2&255
1549+++8E6A~            	DB #076E-#0704
1550+++8E6A~            	DB #07E0-#076E
1551+++8E6A~            	DB #0858-#07E0
1552+++8E6A~            	DB #08D6-#0858
1553+++8E6A~            	DB #095C-#08D6
1554+++8E6A~            	DB #09EC-#095C
1555+++8E6A~            	DB #0A82-#09EC
1556+++8E6A~            	DB #0B22-#0A82
1557+++8E6A~            	DB #0BCC-#0B22
1558+++8E6A~            	DB #0C80-#0BCC
1559+++8E6A~            	DB #0D3E-#0C80
1560+++8E6A~            	DB #07E0*2/256,#07E0*2&255
1561+++8E6A~            	DB #0858-#07E0
1562+++8E6A~            	DB #08E0-#0858
1563+++8E6A~            	DB #0960-#08E0
1564+++8E6A~            	DB #09F0-#0960
1565+++8E6A~            	DB #0A88-#09F0
1566+++8E6A~            	DB #0B28-#0A88
1567+++8E6A~            	DB #0BD8-#0B28
1568+++8E6A~            	DB #0C80-#0BD8
1569+++8E6A~            	DB #0D60-#0C80
1570+++8E6A~            	DB #0E10-#0D60
1571+++8E6A~            	DB #0EF8-#0E10
1572+++8E6A~            1573+++8E6A~            ;vars from here can be stripped
1574+++8E6A~            ;you can move VARS to any other address
1575+++8E6A~            1576+++8E6A~            VARS
1577+++8E6A~            1578+++8E6A~            is_ts	DB 0
1579+++8E6A~            1580+++8E6A~            ;ChannelsVars
1581+++8E6A~            	STRUCT	CHP
1582+++8E6A~            ;reset group
1583+++8E6A~            PsInOr	DB 0
1584+++8E6A~            PsInSm	DB 0
1585+++8E6A~            CrAmSl	DB 0
1586+++8E6A~            CrNsSl	DB 0
1587+++8E6A~            CrEnSl	DB 0
1588+++8E6A~            TSlCnt	DB 0
1589+++8E6A~            CrTnSl	DW 0
1590+++8E6A~            TnAcc	DW 0
1591+++8E6A~            COnOff	DB 0
1592+++8E6A~            ;reset group
1593+++8E6A~            1594+++8E6A~            OnOffD	DB 0
1595+++8E6A~            1596+++8E6A~            ;IX for PTDECOD here (+12)
1597+++8E6A~            OffOnD	DB 0
1598+++8E6A~            OrnPtr	DW 0
1599+++8E6A~            SamPtr	DW 0
1600+++8E6A~            NNtSkp	DB 0
1601+++8E6A~            Note	DB 0
1602+++8E6A~            SlToNt	DB 0
1603+++8E6A~            Env_En	DB 0
1604+++8E6A~            Flags	DB 0
1605+++8E6A~             ;Enabled - 0, SimpleGliss - 2
1606+++8E6A~            TnSlDl	DB 0
1607+++8E6A~            TSlStp	DW 0
1608+++8E6A~            TnDelt	DW 0
1609+++8E6A~            NtSkCn	DB 0
1610+++8E6A~            Volume	DB 0
1611+++8E6A~            	ENDS
1612+++8E6A~            1613+++8E6A~            	STRUCT	VRS
1614+++8E6A~            1615+++8E6A~            ;IF not works in STRUCT in SjASM :(
1616+++8E6A~            ;	IF CurPosCounter
1617+++8E6A~            CurPos	DB 0
1618+++8E6A~            PosSub	DB 0
1619+++8E6A~            ;	ENDIF
1620+++8E6A~            1621+++8E6A~            ModNum	DB 0 ;bit0: ChipNum
1622+++8E6A~            	     ;bit1: 1-reversed patterns order (AlCo TS)
1623+++8E6A~            1624+++8E6A~            ChanA	DS CHP
1625+++8E6A~            ChanB	DS CHP
1626+++8E6A~            ChanC	DS CHP
1627+++8E6A~            1628+++8E6A~            ;GlobalVars
1629+++8E6A~            MODADDR	DW 0
1630+++8E6A~            OrnPtrs	DW 0
1631+++8E6A~            SamPtrs	DW 0
1632+++8E6A~            PatsPtr	DW 0
1633+++8E6A~            AdInPtA	DW 0
1634+++8E6A~            AdInPtB	DW 0
1635+++8E6A~            AdInPtC	DW 0
1636+++8E6A~            CrPsPtr	DW 0
1637+++8E6A~            LPosPtr	DW 0
1638+++8E6A~            Delay	DB 0
1639+++8E6A~            DelyCnt	DB 0
1640+++8E6A~            ESldAdd	DW 0
1641+++8E6A~            CurESld	DW 0
1642+++8E6A~            Env_Del	DB 0
1643+++8E6A~            CurEDel	DB 0
1644+++8E6A~            Ns_Base	DB 0
1645+++8E6A~            AddToNs	DB 0
1646+++8E6A~            AddToEn	DB 0
1647+++8E6A~            EnvBase	DW 0
1648+++8E6A~            AYREGS	DS 14
1649+++8E6A~            	ENDS
1650+++8E6A~            1651+++8E6A~            VARS1	DS VRS
1652+++8E6A~            VARS2	DS VRS
1653+++8E6A~            1654+++8E6A~            VT_	EQU $-16
1655+++8E6A~            	DS 256-16 ;CreatedVolumeTableAddress
1656+++8E6A~            1657+++8E6A~            T1_	EQU VT_+16 ;Tone tables data depacked here
1658+++8E6A~            1659+++8E6A~            T_OLD_1	EQU T1_
1660+++8E6A~            T_OLD_2	EQU T_OLD_1+24
1661+++8E6A~            T_OLD_3	EQU T_OLD_2+24
1662+++8E6A~            T_OLD_0	EQU T_OLD_3+2
1663+++8E6A~            T_NEW_0	EQU T_OLD_0
1664+++8E6A~            T_NEW_1	EQU T_OLD_1
1665+++8E6A~            T_NEW_2	EQU T_NEW_0+24
1666+++8E6A~            T_NEW_3	EQU T_OLD_3
1667+++8E6A~            1668+++8E6A~            PT2EMPTYORN EQU VT_+31 ;1,0,0 sequence
1669+++8E6A~            1670+++8E6A~            NT_	DS 192 ;CreatedNoteTableAddress
1671+++8E6A~            1672+++8E6A~            VAR0END	EQU VT_+16 ;INIT zeroes from VARS to VAR0END-1
1673+++8E6A~            1674+++8E6A~            VARSEND EQU $
1675+++8E6A~            MDLADDR EQU $
1676+++8E6A~            1677+++8E6A~                   DISPLAY "PTS player size=",$-START
1678+++8E6A~            1679+++8E6A~            ;Release 0 steps:
1680+++8E6A~            ;04/21/2007
1681+++8E6A~            ;Works start (PTxPlay adaptation); first beta.
1682+++8E6A~            ;04/22/2007
1683+++8E6A~            ;Job finished; beta-testing.
1684+++8E6A~            ;04/23/2007
1685+++8E6A~            ;PT v3.7 TS mode corrected (after AlCo remarks).
1686+++8E6A~            ;04/29/2007
1687+++8E6A~            ;Added 1.XX and 2.XX special commands interpretation for PT3
1688+++8E6A~            ;modules of v3.7+.
1689+++8E6A~            1690+++8E6A~            ;Size (minimal build for ZX Spectrum):
1691+++8E6A~            ;Code block #908 bytes
1692+++8E6A~            ;Variables #2BF bytes (can be stripped)
1693+++8E6A~            ;Total size #908+#2BF=#BC7 (3015) bytes
1694+++8E6A~            1695+++8E6A~                   ENDMOD
1696+++8E6A~            1697+++8E6A                    endif
1698+++8E6A             
0099++ 8E6A             PT3.Play=PTS.PLAY
0100++ 8E6A             PT3.Mute=PTS.MUTE        
0101++ 8E6A             PT3.End
0102++ 8E6A             
0103++ 8E6A                     display "PT3 module size: ",PT3.End-PT3.Start
0104++ 8E6A             
0105++ 8E6A                     endif
0106++ 8E6A                     
0414+  8E6A                     include "pt2.asm"
0001++ 8E6A                     ifndef _pt2_asm_defined
0002++ 8E6A                     define _pt2_asm_defined
0003++ 8E6A                     
0004++ 8E6A                     module PT2
0005++ 8E6A             
0006++ 8E6A                     struct Header
0007++ 8E6A~            Tempo   db 0 ;02-ff
0008++ 8E6A~            Length  db 0 ;01-ff
0009++ 8E6A~            Loop    db 0 ;00-fe
0010++ 8E6A~            Samples 
0011++ 8E6A~                    ds 64 ;(? 00-36){32}
0012++ 8E6A~            Ornaments
0013++ 8E6A~                    ds 32 ;(? 00-36){16}
0014++ 8E6A~            Patterns
0015++ 8E6A~                    dw 0 ;? 00-01
0016++ 8E6A~            Name    ds 30 ;?
0017++ 8E6A~            Positions
0018++ 8E6A~                    db 0  ;00-1f
0019++ 8E6A~                    db 0  ;ff|00-1f             
0020++ 8E6A                     ends
0021++ 8E6A                     
0022++ 8E6A             Start
0023++ 8E6A                     ifndef NoPrologue
0024++ 8E6A~                    ld hl,End
0025++ 8E6A~                    jr Init
0026++ 8E6A~                    jp PTS.PLAY
0027++ 8E6A~                    jp PTS.MUTE
0028++ 8E6A                     endif
0029++ 8E6A             
0030++ 8E6A 3E 02       Init    ld a,PTS.SETUP.PT2
0031++ 8E6C C3 63 82            jp PTS.INIT
0032++ 8E6F                     
0033++ 8E6F                     ifdef HaveFormatCheck
0034++ 8E6F                     include "format.asm"
0001+++8E6F             ;some format checking macros
0002+++8E6F                     ifndef _format_asm_defined
0003+++8E6F~                    define _format_asm_defined
0004+++8E6F~            0005+++8E6F~                    macro LessOrEqual number
0006+++8E6F~                    ld a,number
0007+++8E6F~                    cp (hl)
0008+++8E6F~                    inc hl
0009+++8E6F~                    ret c
0010+++8E6F~                    endm
0011+++8E6F~                    
0012+++8E6F~                    macro Greater number
0013+++8E6F~                    ld a,(hl)
0014+++8E6F~                    inc hl
0015+++8E6F~                    cp number
0016+++8E6F~                    ret c
0017+++8E6F~                    endm
0018+++8E6F~                    
0019+++8E6F~                    macro AnyByte
0020+++8E6F~                    inc hl
0021+++8E6F~                    endm
0022+++8E6F~                    
0023+++8E6F~                    macro AnyBytes count
0024+++8E6F~                    if count > 7
0025+++8E6F~                    ld a,l
0026+++8E6F~                    add a,count
0027+++8E6F~                    ld l,a
0028+++8E6F~                    adc a,h
0029+++8E6F~                    sub l
0030+++8E6F~                    ld h,a
0031+++8E6F~                    else
0032+++8E6F~                    dup count
0033+++8E6F~                    inc hl
0034+++8E6F~                    edup
0035+++8E6F~                    endif
0036+++8E6F~                    endm
0037+++8E6F~                    
0038+++8E6F~                    macro EqualTo number
0039+++8E6F~                    ld a,number
0040+++8E6F~                    cp (hl)
0041+++8E6F~                    inc hl
0042+++8E6F~                    ret nz
0043+++8E6F~                    endm
0044+++8E6F~            0045+++8E6F                     endif
0046+++8E6F             
0035++ 8E6F                     
0036++ 8E6F             ;in HL - module addr
0037++ 8E6F             ;out Z - is pt2
0038++ 8E6F             CheckFormat
0039++ 8E6F                     ;Tempo
0040++ 8E6F                     Greater 2
0040++ 8E6F 7E          >        ld a,(hl)
0040++ 8E70 23          >        inc hl
0040++ 8E71 FE 02       >        cp number
0040++ 8E73 D8          >        ret c
0041++ 8E74                     ;Length
0042++ 8E74                     Greater 1
0042++ 8E74 7E          >        ld a,(hl)
0042++ 8E75 23          >        inc hl
0042++ 8E76 FE 01       >        cp number
0042++ 8E78 D8          >        ret c
0043++ 8E79                     ;Loop
0044++ 8E79                     LessOrEqual 254
0044++ 8E79 3E FE       >        ld a,number
0044++ 8E7B BE          >        cp (hl)
0044++ 8E7C 23          >        inc hl
0044++ 8E7D D8          >        ret c
0045++ 8E7E                     ;Samples+Ornaments
0046++ 8E7E 06 30               ld b,(Header.Patterns-Header.Samples)/2
0047++ 8E80             .samorns
0048++ 8E80                     AnyByte
0048++ 8E80 23          >        inc hl
0049++ 8E81                     LessOrEqual #36
0049++ 8E81 3E 36       >        ld a,number
0049++ 8E83 BE          >        cp (hl)
0049++ 8E84 23          >        inc hl
0049++ 8E85 D8          >        ret c
0050++ 8E86 10 F8               djnz .samorns
0051++ 8E88                     ;Patterns
0052++ 8E88                     AnyByte
0052++ 8E88 23          >        inc hl
0053++ 8E89                     LessOrEqual 1
0053++ 8E89 3E 01       >        ld a,number
0053++ 8E8B BE          >        cp (hl)
0053++ 8E8C 23          >        inc hl
0053++ 8E8D D8          >        ret c
0054++ 8E8E                     ;Name
0055++ 8E8E                     AnyBytes Header.Positions-Header.Name
0055++ 8E8E 7D          >        ld a,l
0055++ 8E8F C6 1E       >        add a,count
0055++ 8E91 6F          >        ld l,a
0055++ 8E92 8C          >        adc a,h
0055++ 8E93 95          >        sub l
0055++ 8E94 67          >        ld h,a
0056++ 8E95                     ;Positions
0057++ 8E95                     ;first should be not marker
0058++ 8E95                     LessOrEqual #1f
0058++ 8E95 3E 1F       >        ld a,number
0058++ 8E97 BE          >        cp (hl)
0058++ 8E98 23          >        inc hl
0058++ 8E99 D8          >        ret c
0059++ 8E9A 06 FF               ld b,255 ;max positions
0060++ 8E9C             .positions
0061++ 8E9C 7E                  ld a,(hl)
0062++ 8E9D FE FF               cp 255
0063++ 8E9F C8                  ret z ;finish
0064++ 8EA0                     LessOrEqual #1f
0064++ 8EA0 3E 1F       >        ld a,number
0064++ 8EA2 BE          >        cp (hl)
0064++ 8EA3 23          >        inc hl
0064++ 8EA4 D8          >        ret c
0065++ 8EA5 10 F5               djnz .positions
0066++ 8EA7                     ;fall through
0067++ 8EA7 7C          .fail   ld a,h
0068++ 8EA8 A7                  and a ;reset Z
0069++ 8EA9 C9                  ret
0070++ 8EAA             
0071++ 8EAA                     display "PT2 checker size: ",$-CheckFormat
0072++ 8EAA                     endif
0073++ 8EAA                     
0074++ 8EAA                     endmod
0075++ 8EAA                     
0076++ 8EAA                     include "PTSPlay.asm"
0001+++8EAA                     ifndef _pts_asm_defined
0002+++8EAA~                    define _pts_asm_defined
0003+++8EAA~            0004+++8EAA~                    MODULE PTS
0005+++8EAA~                    
0006+++8EAA~            ;Universal PT2'n'PT3 Turbo Sound player for ZX Spectrum
0007+++8EAA~            ;(c)2004-2007 S.V.Bulba <vorobey@mail.khstu.ru>
0008+++8EAA~            ;Specially for AlCo
0009+++8EAA~            ;http://bulba.untergrund.net/ (http://bulba.at.kz/)
0010+++8EAA~            0011+++8EAA~            ;Release number
0012+++8EAA~            Release EQU "0"
0013+++8EAA~            0014+++8EAA~            ;Conditional assembly
0015+++8EAA~            ;1) Current position counters at (Vars1+0) and (Vars2+0)
0016+++8EAA~            CurPosCounter=0
0017+++8EAA~            ;2) Allow channels allocation bits at (SETUP)
0018+++8EAA~            ACBBAC=0
0019+++8EAA~            ;3) Allow loop checking and disabling
0020+++8EAA~            LoopChecker=0
0021+++8EAA~            ;4) Insert official identificator
0022+++8EAA~            Id=0
0023+++8EAA~            ;5) Set IY for correct return to ZX Basic
0024+++8EAA~            Basic=0
0025+++8EAA~            0026+++8EAA~            ;Features
0027+++8EAA~            ;--------
0028+++8EAA~            ;-Can be compiled at any address (i.e. no need rounding ORG
0029+++8EAA~            ; address).
0030+++8EAA~            ;-Variables (VARS) can be located at any address (not only after
0031+++8EAA~            ; code block).
0032+++8EAA~            ;-INIT subprogram checks PT3-module version and rightly
0033+++8EAA~            ; generates both note and volume tables outside of code block
0034+++8EAA~            ; (in VARS).
0035+++8EAA~            ;-Two portamento (spc. command 3xxx) algorithms (depending of
0036+++8EAA~            ; PT3 module version).
0037+++8EAA~            ;-New 1.XX and 2.XX special command behaviour (only for PT v3.7
0038+++8EAA~            ; and higher).
0039+++8EAA~            ;-Any Tempo value are accepted (including Tempo=1 and Tempo=2).
0040+++8EAA~            ;-TS modes: 2xPT3, 2xPT2 and PT v3.7 TS standard.
0041+++8EAA~            ;-Fully compatible with Ay_Emul PT3 and PT2 players codes.
0042+++8EAA~            ;-See also notes at the end of this source code.
0043+++8EAA~            0044+++8EAA~            ;Limitations
0045+++8EAA~            ;-----------
0046+++8EAA~            ;-Can run in RAM only (self-modified code is used).
0047+++8EAA~            ;-PT2 position list must be end by #FF marker only.
0048+++8EAA~            0049+++8EAA~            ;Warning!!! PLAY subprogram can crash if no module are loaded
0050+++8EAA~            ;into RAM or INIT subprogram was not called before.
0051+++8EAA~            0052+++8EAA~            ;Call MUTE or INIT one more time to mute sound after stopping
0053+++8EAA~            ;playing 
0054+++8EAA~            0055+++8EAA~            TonA	EQU 0
0056+++8EAA~            TonB	EQU 2
0057+++8EAA~            TonC	EQU 4
0058+++8EAA~            Noise	EQU 6
0059+++8EAA~            Mixer	EQU 7
0060+++8EAA~            AmplA	EQU 8
0061+++8EAA~            AmplB	EQU 9
0062+++8EAA~            AmplC	EQU 10
0063+++8EAA~            Env	EQU 11
0064+++8EAA~            EnvTp	EQU 13
0065+++8EAA~            0066+++8EAA~            START
0067+++8EAA~            0068+++8EAA~            SETUP.NOLOOP EQU 1
0069+++8EAA~            SETUP.PT2 EQU 2
0070+++8EAA~            SETUP.ACB EQU 4
0071+++8EAA~            SETUP.BAC EQU 8
0072+++8EAA~            SETUP.TS02 EQU 16
0073+++8EAA~            SETUP.TSPT3 EQU 32
0074+++8EAA~            0075+++8EAA~            SETUP	DB 0 ;set bit0, if you want to play without looping
0076+++8EAA~            	     ;(optional);
0077+++8EAA~            	     ;set bit1 for PT2 and reset for PT3 before
0078+++8EAA~            	     ;calling INIT;
0079+++8EAA~            	     ;bits2-3: %00-ABC, %01-ACB, %10-BAC (optional);
0080+++8EAA~            	     ;bits4-5: %00-no TS, %01-2 modules TS, %10-
0081+++8EAA~            	     ;autodetect PT3 TS-format by AlCo (PT 3.7+);
0082+++8EAA~            	     ;Remark: old PT3 TS-format by AlCo (PT 3.6) is not
0083+++8EAA~            	     ;documented and must be converted to new standard.
0084+++8EAA~            	     ;bit6 is set each time, when loop point of 2nd TS
0085+++8EAA~            	     ;module is passed (optional).
0086+++8EAA~            	     ;bit7 is set each time, when loop point of 1st TS
0087+++8EAA~            	     ;or of single module is passed (optional).
0088+++8EAA~            0089+++8EAA~            ;Identifier
0090+++8EAA~            	IF Id
0091+++8EAA~            	DB "=UniPT2/PT3/TS-Player r.",Release,"="
0092+++8EAA~            	ENDIF
0093+++8EAA~            0094+++8EAA~            	IF LoopChecker
0095+++8EAA~            CHECKLP	LD HL,SETUP
0096+++8EAA~            	BIT 0,(IY-100+VRS.ModNum)
0097+++8EAA~            	JR Z,CHL1
0098+++8EAA~            	SET 6,(HL)
0099+++8EAA~            	JR CHL2
0100+++8EAA~            CHL1	SET 7,(HL)
0101+++8EAA~            CHL2	BIT 0,(HL)
0102+++8EAA~            	RET Z
0103+++8EAA~            	POP HL
0104+++8EAA~            	INC (IY-100+VRS.DelyCnt)
0105+++8EAA~            	INC (IY-100+VRS.ChanA+CHP.NtSkCn)
0106+++8EAA~            	XOR A
0107+++8EAA~            	LD (IY-100+VRS.AYREGS+AmplA),A
0108+++8EAA~            	LD (IY-100+VRS.AYREGS+AmplB),A
0109+++8EAA~            	LD (IY-100+VRS.AYREGS+AmplC),A
0110+++8EAA~            	RET
0111+++8EAA~            	ENDIF
0112+++8EAA~            0113+++8EAA~            MUTE	XOR A
0114+++8EAA~            	LD H,A
0115+++8EAA~            	LD L,A
0116+++8EAA~            	LD (VARS1+VRS.AYREGS+AmplA),A
0117+++8EAA~            	LD (VARS1+VRS.AYREGS+AmplB),HL
0118+++8EAA~            	LD (VARS2+VRS.AYREGS+AmplA),A
0119+++8EAA~            	LD (VARS2+VRS.AYREGS+AmplB),HL
0120+++8EAA~            	JP ROUT
0121+++8EAA~            0122+++8EAA~            INIT
0123+++8EAA~            ;HL - AddressOfModule
0124+++8EAA~            ;DE - AddresOf2ndModule
0125+++8EAA~            ;A - mode
0126+++8EAA~            	PUSH DE
0127+++8EAA~            	PUSH HL
0128+++8EAA~            	LD HL,VARS
0129+++8EAA~            	LD (HL),0
0130+++8EAA~            	LD DE,VARS+1
0131+++8EAA~            	LD BC,VAR0END-VARS-1
0132+++8EAA~            	LDIR
0133+++8EAA~            	INC HL
0134+++8EAA~            	LD (VARS1+VRS.AdInPtA),HL ;ptr to zero
0135+++8EAA~            	LD (VARS2+VRS.AdInPtA),HL
0136+++8EAA~            0137+++8EAA~            	POP HL
0138+++8EAA~            	LD IY,VARS1+100
0139+++8EAA~                LD (SETUP),A
0140+++8EAA~            	AND SETUP.PT2
0141+++8EAA~            	JP NZ,I_PT2
0142+++8EAA~            0143+++8EAA~            	CALL INITPT3
0144+++8EAA~            	LD HL,(e_-SamCnv-2)*256+#18
0145+++8EAA~            	LD (SamCnv),HL
0146+++8EAA~            	LD A,#BA
0147+++8EAA~            	LD (OrnCP),A
0148+++8EAA~            	LD (SamCP),A
0149+++8EAA~            	LD A,#7B
0150+++8EAA~            	LD (OrnLD),A
0151+++8EAA~            	LD (SamLD),A
0152+++8EAA~            	LD A,#87
0153+++8EAA~            	LD (SamClc2),A
0154+++8EAA~            	POP HL
0155+++8EAA~            	;Use version and ton table of 1st module
0156+++8EAA~            	LD A,(IX+13-100) ;EXTRACT VERSION NUMBER
0157+++8EAA~            	SUB #30
0158+++8EAA~            	JR C,L20
0159+++8EAA~            	CP 10
0160+++8EAA~            	JR C,L21
0161+++8EAA~            L20	LD A,6
0162+++8EAA~            L21	LD (Version),A
0163+++8EAA~            	PUSH AF ;VolTable version
0164+++8EAA~            	CP 4
0165+++8EAA~            	LD A,(IX+99-100) ;TONE TABLE NUMBER
0166+++8EAA~            	RLA
0167+++8EAA~            	AND 7
0168+++8EAA~            	PUSH AF ;NoteTable number
0169+++8EAA~            0170+++8EAA~            	LD IY,VARS2+100
0171+++8EAA~            	LD A,(SETUP)
0172+++8EAA~            	AND SETUP.TS02|SETUP.TSPT3
0173+++8EAA~            	JR Z,NOTS
0174+++8EAA~            	CP SETUP.TS02
0175+++8EAA~            	JR Z,TwoPT3s
0176+++8EAA~            	LD A,(Version)
0177+++8EAA~            	CP 7
0178+++8EAA~            	JR C,NOTS
0179+++8EAA~            	LD A,(IX+98-100) ;ALCO TS MARKER
0180+++8EAA~            	CP #20
0181+++8EAA~            	JR Z,NOTS
0182+++8EAA~            	LD HL,VARS1
0183+++8EAA~            	LD DE,VARS2
0184+++8EAA~            	LD BC,VRS
0185+++8EAA~            	LDIR
0186+++8EAA~            	SET 1,(IY-100+VRS.ModNum)
0187+++8EAA~            	LD C,A
0188+++8EAA~            	ADD A,A
0189+++8EAA~            	ADD A,C
0190+++8EAA~            	SUB 2
0191+++8EAA~            	LD (TSSub),A
0192+++8EAA~            	JR AlCoTS_
0193+++8EAA~            TwoPT3s	CALL INITPT3
0194+++8EAA~            AlCoTS_	LD A,1
0195+++8EAA~            	LD (is_ts),A
0196+++8EAA~            	SET 0,(IY-100+VRS.ModNum)
0197+++8EAA~            0198+++8EAA~            NOTS	LD BC,PT3PD
0199+++8EAA~            	LD HL,0
0200+++8EAA~            	LD DE,PT3EMPTYORN
0201+++8EAA~            	JR INITCOMMON
0202+++8EAA~            0203+++8EAA~            I_PT2	CALL INITPT2
0204+++8EAA~            	LD HL,#51CB
0205+++8EAA~            	LD (SamCnv),HL
0206+++8EAA~            	LD A,#BB
0207+++8EAA~            	LD (OrnCP),A
0208+++8EAA~            	LD (SamCP),A
0209+++8EAA~            	LD A,#7A
0210+++8EAA~            	LD (OrnLD),A
0211+++8EAA~            	LD (SamLD),A
0212+++8EAA~            	LD A,#80
0213+++8EAA~            	LD (SamClc2),A
0214+++8EAA~            	POP HL
0215+++8EAA~            	LD A,5
0216+++8EAA~            	LD (Version),A
0217+++8EAA~            	PUSH AF
0218+++8EAA~            	LD A,2
0219+++8EAA~            	PUSH AF
0220+++8EAA~            0221+++8EAA~            	LD A,(SETUP)
0222+++8EAA~                AND SETUP.TS02|SETUP.TSPT3
0223+++8EAA~            	JR Z,NOTS2
0224+++8EAA~            0225+++8EAA~            	LD IY,VARS2+100
0226+++8EAA~            	LD A,1
0227+++8EAA~            	LD (is_ts),A
0228+++8EAA~            	SET 0,(IY-100+VRS.ModNum)
0229+++8EAA~            	CALL INITPT2
0230+++8EAA~            0231+++8EAA~            NOTS2	LD BC,PT2PD
0232+++8EAA~            	LD HL,#8687
0233+++8EAA~            	LD DE,PT2EMPTYORN
0234+++8EAA~            0235+++8EAA~            INITCOMMON
0236+++8EAA~            0237+++8EAA~            	IF Basic
0238+++8EAA~            	LD IY,#5C3A
0239+++8EAA~            	ENDIF
0240+++8EAA~            0241+++8EAA~            	LD (PTDEC),BC
0242+++8EAA~            	LD (PsCalc),HL
0243+++8EAA~            	PUSH DE
0244+++8EAA~            0245+++8EAA~            ;note table data depacker
0246+++8EAA~            ;(c) Ivan Roshin
0247+++8EAA~            	LD DE,T_PACK
0248+++8EAA~            	LD BC,T1_+(2*49)-1
0249+++8EAA~            TP_0	LD A,(DE)
0250+++8EAA~            	INC DE
0251+++8EAA~            	CP 15*2
0252+++8EAA~            	JR NC,TP_1
0253+++8EAA~            	LD H,A
0254+++8EAA~            	LD A,(DE)
0255+++8EAA~            	LD L,A
0256+++8EAA~            	INC DE
0257+++8EAA~            	JR TP_2
0258+++8EAA~            TP_1	PUSH DE
0259+++8EAA~            	LD D,0
0260+++8EAA~            	LD E,A
0261+++8EAA~            	ADD HL,DE
0262+++8EAA~            	ADD HL,DE
0263+++8EAA~            	POP DE
0264+++8EAA~            TP_2	LD A,H
0265+++8EAA~            	LD (BC),A
0266+++8EAA~            	DEC BC
0267+++8EAA~            	LD A,L
0268+++8EAA~            	LD (BC),A
0269+++8EAA~            	DEC BC
0270+++8EAA~            	SUB (#F8*2)&255
0271+++8EAA~            	JR NZ,TP_0
0272+++8EAA~            0273+++8EAA~            	INC A
0274+++8EAA~            	LD (VARS1+VRS.DelyCnt),A
0275+++8EAA~            	LD (VARS2+VRS.DelyCnt),A
0276+++8EAA~            	LD HL,#F001 ;H - CHP.Volume, L - CHP.NtSkCn
0277+++8EAA~            	LD (VARS1+VRS.ChanA+CHP.NtSkCn),HL
0278+++8EAA~            	LD (VARS1+VRS.ChanB+CHP.NtSkCn),HL
0279+++8EAA~            	LD (VARS1+VRS.ChanC+CHP.NtSkCn),HL
0280+++8EAA~            	LD (VARS2+VRS.ChanA+CHP.NtSkCn),HL
0281+++8EAA~            	LD (VARS2+VRS.ChanB+CHP.NtSkCn),HL
0282+++8EAA~            	LD (VARS2+VRS.ChanC+CHP.NtSkCn),HL
0283+++8EAA~            	POP HL
0284+++8EAA~            	LD (VARS1+VRS.ChanA+CHP.OrnPtr),HL
0285+++8EAA~            	LD (VARS1+VRS.ChanB+CHP.OrnPtr),HL
0286+++8EAA~            	LD (VARS1+VRS.ChanC+CHP.OrnPtr),HL
0287+++8EAA~            	LD (VARS2+VRS.ChanA+CHP.OrnPtr),HL
0288+++8EAA~            	LD (VARS2+VRS.ChanB+CHP.OrnPtr),HL
0289+++8EAA~            	LD (VARS2+VRS.ChanC+CHP.OrnPtr),HL
0290+++8EAA~            0291+++8EAA~            	POP AF
0292+++8EAA~            0293+++8EAA~            ;NoteTableCreator (c) Ivan Roshin
0294+++8EAA~            ;A - NoteTableNumber*2+VersionForNoteTable
0295+++8EAA~            ;(xx1b - 3.xx..3.4r, xx0b - 3.4x..3.6x..VTII1.0)
0296+++8EAA~            0297+++8EAA~            	LD HL,NT_DATA
0298+++8EAA~            	LD D,0
0299+++8EAA~            	ADD A,A
0300+++8EAA~            	LD E,A
0301+++8EAA~            	ADD HL,DE
0302+++8EAA~            	LD E,(HL)
0303+++8EAA~            	INC HL
0304+++8EAA~            	SRL E
0305+++8EAA~            	SBC A,A
0306+++8EAA~            	AND #A7 ;#00 (NOP) or #A7 (AND A)
0307+++8EAA~            	LD (L3),A
0308+++8EAA~            	EX DE,HL
0309+++8EAA~            	LD BC,T1_
0310+++8EAA~            	ADD HL,BC
0311+++8EAA~            0312+++8EAA~            	LD A,(DE)
0313+++8EAA~            	ADD A,T_&255
0314+++8EAA~            	LD C,A
0315+++8EAA~            	ADC A,T_/256
0316+++8EAA~            	SUB C
0317+++8EAA~            	LD B,A
0318+++8EAA~            	PUSH BC
0319+++8EAA~            	LD DE,NT_
0320+++8EAA~            	PUSH DE
0321+++8EAA~            0322+++8EAA~            	LD B,12
0323+++8EAA~            L1	PUSH BC
0324+++8EAA~            	LD C,(HL)
0325+++8EAA~            	INC HL
0326+++8EAA~            	PUSH HL
0327+++8EAA~            	LD B,(HL)
0328+++8EAA~            0329+++8EAA~            	PUSH DE
0330+++8EAA~            	EX DE,HL
0331+++8EAA~            	LD DE,23
0332+++8EAA~            	LD IXH,8
0333+++8EAA~            0334+++8EAA~            L2	SRL B
0335+++8EAA~            	RR C
0336+++8EAA~            L3	DB #19	;AND A or NOP
0337+++8EAA~            	LD A,C
0338+++8EAA~            	ADC A,D	;=ADC 0
0339+++8EAA~            	LD (HL),A
0340+++8EAA~            	INC HL
0341+++8EAA~            	LD A,B
0342+++8EAA~            	ADC A,D
0343+++8EAA~            	LD (HL),A
0344+++8EAA~            	ADD HL,DE
0345+++8EAA~            	DEC IXH
0346+++8EAA~            	JR NZ,L2
0347+++8EAA~            0348+++8EAA~            	POP DE
0349+++8EAA~            	INC DE
0350+++8EAA~            	INC DE
0351+++8EAA~            	POP HL
0352+++8EAA~            	INC HL
0353+++8EAA~            	POP BC
0354+++8EAA~            	DJNZ L1
0355+++8EAA~            0356+++8EAA~            	POP HL
0357+++8EAA~            	POP DE
0358+++8EAA~            0359+++8EAA~            	LD A,E
0360+++8EAA~            	CP TCOLD_1&255
0361+++8EAA~            	JR NZ,CORR_1
0362+++8EAA~            	LD A,#FD
0363+++8EAA~            	LD (NT_+#2E),A
0364+++8EAA~            0365+++8EAA~            CORR_1	LD A,(DE)
0366+++8EAA~            	AND A
0367+++8EAA~            	JR Z,TC_EXIT
0368+++8EAA~            	RRA
0369+++8EAA~            	PUSH AF
0370+++8EAA~            	ADD A,A
0371+++8EAA~            	LD C,A
0372+++8EAA~            	ADD HL,BC
0373+++8EAA~            	POP AF
0374+++8EAA~            	JR NC,CORR_2
0375+++8EAA~            	DEC (HL)
0376+++8EAA~            	DEC (HL)
0377+++8EAA~            CORR_2	INC (HL)
0378+++8EAA~            	AND A
0379+++8EAA~            	SBC HL,BC
0380+++8EAA~            	INC DE
0381+++8EAA~            	JR CORR_1
0382+++8EAA~            0383+++8EAA~            TC_EXIT
0384+++8EAA~            0385+++8EAA~            	POP AF
0386+++8EAA~            0387+++8EAA~            ;VolTableCreator (c) Ivan Roshin
0388+++8EAA~            ;A - VersionForVolumeTable (0..4 - 3.xx..3.4x;
0389+++8EAA~            			   ;5.. - 2.x,3.5x..3.6x..VTII1.0)
0390+++8EAA~            0391+++8EAA~            	CP 5
0392+++8EAA~            	LD HL,#11
0393+++8EAA~            	LD D,H
0394+++8EAA~            	LD E,H
0395+++8EAA~            	LD A,#17
0396+++8EAA~            	JR NC,M1
0397+++8EAA~            	DEC L
0398+++8EAA~            	LD E,L
0399+++8EAA~            	XOR A
0400+++8EAA~            M1      LD (M2),A
0401+++8EAA~            0402+++8EAA~            	LD IX,VT_+16
0403+++8EAA~            0404+++8EAA~            	LD C,#F
0405+++8EAA~            INITV2  PUSH HL
0406+++8EAA~            0407+++8EAA~            	ADD HL,DE
0408+++8EAA~            	EX DE,HL
0409+++8EAA~            	SBC HL,HL
0410+++8EAA~            0411+++8EAA~            	LD B,#10
0412+++8EAA~            INITV1  LD A,L
0413+++8EAA~            M2      DB #7D
0414+++8EAA~            	LD A,H
0415+++8EAA~            	ADC A,0
0416+++8EAA~            	LD (IX),A
0417+++8EAA~            	INC IX
0418+++8EAA~            	ADD HL,DE
0419+++8EAA~            	DJNZ INITV1
0420+++8EAA~            0421+++8EAA~            	POP HL
0422+++8EAA~            	LD A,E
0423+++8EAA~            	CP #77
0424+++8EAA~            	JR NZ,M3
0425+++8EAA~            	INC E
0426+++8EAA~            M3      DEC C
0427+++8EAA~            	JR NZ,INITV2
0428+++8EAA~            0429+++8EAA~            	JP ROUT
0430+++8EAA~            0431+++8EAA~            INITPT3	CALL SETMDAD
0432+++8EAA~            	PUSH HL
0433+++8EAA~            	LD DE,100
0434+++8EAA~            	ADD HL,DE
0435+++8EAA~            	LD A,(HL)
0436+++8EAA~            	LD (IY-100+VRS.Delay),A
0437+++8EAA~            	PUSH HL
0438+++8EAA~            	POP IX
0439+++8EAA~            	ADD HL,DE
0440+++8EAA~            	CALL SETCPPT
0441+++8EAA~            	LD E,(IX+102-100)
0442+++8EAA~            	INC HL
0443+++8EAA~            0444+++8EAA~            	IF CurPosCounter
0445+++8EAA~            	LD (IY-100+VRS.PosSub),L
0446+++8EAA~            	ENDIF
0447+++8EAA~            0448+++8EAA~            	ADD HL,DE
0449+++8EAA~            	CALL SETLPPT
0450+++8EAA~            	POP DE
0451+++8EAA~            	LD L,(IX+103-100)
0452+++8EAA~            	LD H,(IX+104-100)
0453+++8EAA~            	ADD HL,DE
0454+++8EAA~            	CALL SETPTPT
0455+++8EAA~            	LD HL,169
0456+++8EAA~            	ADD HL,DE
0457+++8EAA~            	CALL SETORPT
0458+++8EAA~            	LD HL,105
0459+++8EAA~            	ADD HL,DE
0460+++8EAA~            0461+++8EAA~            SETSMPT LD (IY-100+VRS.SamPtrs),L
0462+++8EAA~            	LD (IY-100+VRS.SamPtrs+1),H
0463+++8EAA~            	RET
0464+++8EAA~            0465+++8EAA~            INITPT2	LD A,(HL)
0466+++8EAA~            	LD (IY-100+VRS.Delay),A
0467+++8EAA~            	PUSH HL
0468+++8EAA~            	PUSH HL
0469+++8EAA~            	PUSH HL
0470+++8EAA~            	INC HL
0471+++8EAA~            	INC HL
0472+++8EAA~            	LD A,(HL)
0473+++8EAA~            	INC HL
0474+++8EAA~            	CALL SETSMPT
0475+++8EAA~            	LD E,(HL)
0476+++8EAA~            	INC HL
0477+++8EAA~            	LD D,(HL)
0478+++8EAA~            	POP HL
0479+++8EAA~            	AND A
0480+++8EAA~            	SBC HL,DE
0481+++8EAA~            	CALL SETMDAD
0482+++8EAA~            	POP HL
0483+++8EAA~            	LD DE,67
0484+++8EAA~            	ADD HL,DE
0485+++8EAA~            	CALL SETORPT
0486+++8EAA~            	LD E,32
0487+++8EAA~            	ADD HL,DE
0488+++8EAA~            	LD C,(HL)
0489+++8EAA~            	INC HL
0490+++8EAA~            	LD B,(HL)
0491+++8EAA~            	LD E,30
0492+++8EAA~            	ADD HL,DE
0493+++8EAA~            	CALL SETCPPT
0494+++8EAA~            	LD E,A
0495+++8EAA~            	INC HL
0496+++8EAA~            0497+++8EAA~            	IF CurPosCounter
0498+++8EAA~            	LD (IY-100+VRS.PosSub),L
0499+++8EAA~            	ENDIF
0500+++8EAA~            0501+++8EAA~            	ADD HL,DE
0502+++8EAA~            	CALL SETLPPT
0503+++8EAA~            	POP HL
0504+++8EAA~            	ADD HL,BC
0505+++8EAA~            0506+++8EAA~            SETPTPT	LD (IY-100+VRS.PatsPtr),L
0507+++8EAA~            	LD (IY-100+VRS.PatsPtr+1),H
0508+++8EAA~            	RET
0509+++8EAA~            0510+++8EAA~            SETMDAD	LD (IY-100+VRS.MODADDR),L
0511+++8EAA~            	LD (IY-100+VRS.MODADDR+1),H
0512+++8EAA~            	RET
0513+++8EAA~            0514+++8EAA~            SETORPT	LD (IY-100+VRS.OrnPtrs),L
0515+++8EAA~            	LD (IY-100+VRS.OrnPtrs+1),H
0516+++8EAA~            	RET
0517+++8EAA~            0518+++8EAA~            SETCPPT	LD (IY-100+VRS.CrPsPtr),L
0519+++8EAA~            	LD (IY-100+VRS.CrPsPtr+1),H
0520+++8EAA~            	RET
0521+++8EAA~            0522+++8EAA~            SETLPPT	LD (IY-100+VRS.LPosPtr),L
0523+++8EAA~            	LD (IY-100+VRS.LPosPtr+1),H
0524+++8EAA~            	RET
0525+++8EAA~            0526+++8EAA~            SETENBS	LD (IY-100+VRS.EnvBase),L
0527+++8EAA~            	LD (IY-100+VRS.EnvBase+1),H
0528+++8EAA~            	RET
0529+++8EAA~            0530+++8EAA~            SETESLD	LD (IY-100+VRS.CurESld),L
0531+++8EAA~            	LD (IY-100+VRS.CurESld+1),H
0532+++8EAA~            	RET
0533+++8EAA~            0534+++8EAA~            GETIX	PUSH IY
0535+++8EAA~            	POP IX
0536+++8EAA~            	ADD IX,DE
0537+++8EAA~            	RET
0538+++8EAA~            0539+++8EAA~            PTDECOD CALL GETIX
0540+++8EAA~            PTDEC	EQU $+1
0541+++8EAA~            	JP #C3C3
0542+++8EAA~            0543+++8EAA~            ;PT2 pattern decoder
0544+++8EAA~            PD2_SAM	CALL SETSAM
0545+++8EAA~            	JR PD2_LOOP
0546+++8EAA~            0547+++8EAA~            PD2_EOff LD (IX-12+CHP.Env_En),A
0548+++8EAA~            	JR PD2_LOOP
0549+++8EAA~            0550+++8EAA~            PD2_ENV	LD (IX-12+CHP.Env_En),16
0551+++8EAA~            	LD (IY-100+VRS.AYREGS+EnvTp),A
0552+++8EAA~            	LD A,(BC)
0553+++8EAA~            	INC BC
0554+++8EAA~            	LD L,A
0555+++8EAA~            	LD A,(BC)
0556+++8EAA~            	INC BC
0557+++8EAA~            	LD H,A
0558+++8EAA~            	CALL SETENBS
0559+++8EAA~            	JR PD2_LOOP
0560+++8EAA~            0561+++8EAA~            PD2_ORN	CALL SETORN
0562+++8EAA~            	JR PD2_LOOP
0563+++8EAA~            0564+++8EAA~            PD2_SKIP INC A
0565+++8EAA~            	LD (IX-12+CHP.NNtSkp),A
0566+++8EAA~            	JR PD2_LOOP
0567+++8EAA~            0568+++8EAA~            PD2_VOL	RRCA
0569+++8EAA~            	RRCA
0570+++8EAA~            	RRCA
0571+++8EAA~            	RRCA
0572+++8EAA~            	LD (IX-12+CHP.Volume),A
0573+++8EAA~            	JR PD2_LOOP
0574+++8EAA~            0575+++8EAA~            PD2_DEL	CALL C_DELAY
0576+++8EAA~            	JR PD2_LOOP
0577+++8EAA~            0578+++8EAA~            PD2_GLIS SET 2,(IX-12+CHP.Flags)
0579+++8EAA~            	INC A
0580+++8EAA~            	LD (IX-12+CHP.TnSlDl),A
0581+++8EAA~            	LD (IX-12+CHP.TSlCnt),A
0582+++8EAA~            	LD A,(BC)
0583+++8EAA~            	INC BC
0584+++8EAA~                    LD (IX-12+CHP.TSlStp),A
0585+++8EAA~            	ADD A,A
0586+++8EAA~            	SBC A,A
0587+++8EAA~                    LD (IX-12+CHP.TSlStp+1),A
0588+++8EAA~            	SCF
0589+++8EAA~            	JR PD2_LP2
0590+++8EAA~            0591+++8EAA~            PT2PD	AND A
0592+++8EAA~            0593+++8EAA~            PD2_LP2	EX AF,AF'
0594+++8EAA~            0595+++8EAA~            PD2_LOOP LD A,(BC)
0596+++8EAA~            	INC BC
0597+++8EAA~            	ADD A,#20
0598+++8EAA~            	JR Z,PD2_REL
0599+++8EAA~            	JR C,PD2_SAM
0600+++8EAA~            	ADD A,96
0601+++8EAA~            	JR C,PD2_NOTE
0602+++8EAA~            	INC A
0603+++8EAA~            	JR Z,PD2_EOff
0604+++8EAA~            	ADD A,15
0605+++8EAA~            	JP Z,PD_FIN
0606+++8EAA~            	JR C,PD2_ENV
0607+++8EAA~            	ADD A,#10
0608+++8EAA~            	JR C,PD2_ORN
0609+++8EAA~            	ADD A,#40
0610+++8EAA~            	JR C,PD2_SKIP
0611+++8EAA~            	ADD A,#10
0612+++8EAA~            	JR C,PD2_VOL
0613+++8EAA~            	INC A
0614+++8EAA~            	JR Z,PD2_DEL
0615+++8EAA~            	INC A
0616+++8EAA~            	JR Z,PD2_GLIS
0617+++8EAA~            	INC A
0618+++8EAA~            	JR Z,PD2_PORT
0619+++8EAA~            	INC A
0620+++8EAA~            	JR Z,PD2_STOP
0621+++8EAA~            	LD A,(BC)
0622+++8EAA~            	INC BC
0623+++8EAA~            	LD (IX-12+CHP.CrNsSl),A
0624+++8EAA~            	JR PD2_LOOP
0625+++8EAA~            0626+++8EAA~            PD2_PORT RES 2,(IX-12+CHP.Flags)
0627+++8EAA~            	LD A,(BC)
0628+++8EAA~            	INC BC
0629+++8EAA~            	INC BC ;ignoring precalc delta to right sound
0630+++8EAA~            	INC BC
0631+++8EAA~            	SCF
0632+++8EAA~            	JR PD2_LP2
0633+++8EAA~            0634+++8EAA~            PD2_STOP LD (IX-12+CHP.TSlCnt),A
0635+++8EAA~            	JR PD2_LOOP
0636+++8EAA~            0637+++8EAA~            PD2_REL	LD (IX-12+CHP.Flags),A
0638+++8EAA~            	JR PD2_EXIT
0639+++8EAA~            0640+++8EAA~            PD2_NOTE LD L,A
0641+++8EAA~            	LD A,(IX-12+CHP.Note)
0642+++8EAA~            	LD (PrNote+1),A
0643+++8EAA~            	LD (IX-12+CHP.Note),L
0644+++8EAA~            	XOR A
0645+++8EAA~            	LD (IX-12+CHP.TSlCnt),A
0646+++8EAA~            	SET 0,(IX-12+CHP.Flags)
0647+++8EAA~            	EX AF,AF'
0648+++8EAA~            	JR NC,NOGLIS2
0649+++8EAA~            	BIT 2,(IX-12+CHP.Flags)
0650+++8EAA~            	JR NZ,NOPORT2
0651+++8EAA~            	LD (LoStep),A
0652+++8EAA~            	ADD A,A
0653+++8EAA~            	SBC A,A
0654+++8EAA~            	EX AF,AF'
0655+++8EAA~            	LD H,A
0656+++8EAA~            	LD L,A
0657+++8EAA~            	INC A
0658+++8EAA~            	CALL SETPORT
0659+++8EAA~            NOPORT2	LD (IX-12+CHP.TSlCnt),1
0660+++8EAA~            NOGLIS2	XOR A
0661+++8EAA~            0662+++8EAA~            0663+++8EAA~            PD2_EXIT LD (IX-12+CHP.PsInSm),A
0664+++8EAA~            	LD (IX-12+CHP.PsInOr),A
0665+++8EAA~            	LD (IX-12+CHP.CrTnSl),A
0666+++8EAA~            	LD (IX-12+CHP.CrTnSl+1),A
0667+++8EAA~            	JP PD_FIN
0668+++8EAA~            0669+++8EAA~            ;PT3 pattern decoder
0670+++8EAA~            PD_OrSm	LD (IX-12+CHP.Env_En),0
0671+++8EAA~            	CALL SETORN
0672+++8EAA~            PD_SAM_	LD A,(BC)
0673+++8EAA~            	INC BC
0674+++8EAA~            	RRCA
0675+++8EAA~            0676+++8EAA~            PD_SAM	CALL SETSAM
0677+++8EAA~            	JR PD_LOOP
0678+++8EAA~            0679+++8EAA~            PD_VOL	RRCA
0680+++8EAA~            	RRCA
0681+++8EAA~            	RRCA
0682+++8EAA~            	RRCA
0683+++8EAA~            	LD (IX-12+CHP.Volume),A
0684+++8EAA~            	JR PD_LP2
0685+++8EAA~            	
0686+++8EAA~            PD_EOff	LD (IX-12+CHP.Env_En),A
0687+++8EAA~            	LD (IX-12+CHP.PsInOr),A
0688+++8EAA~            	JR PD_LP2
0689+++8EAA~            0690+++8EAA~            PD_SorE	DEC A
0691+++8EAA~            	JR NZ,PD_ENV
0692+++8EAA~            	LD A,(BC)
0693+++8EAA~            	INC BC
0694+++8EAA~            	LD (IX-12+CHP.NNtSkp),A
0695+++8EAA~            	JR PD_LP2
0696+++8EAA~            0697+++8EAA~            PD_ENV	CALL SETENV
0698+++8EAA~            	JR PD_LP2
0699+++8EAA~            0700+++8EAA~            PD_ORN	CALL SETORN
0701+++8EAA~            	JR PD_LOOP
0702+++8EAA~            0703+++8EAA~            PD_ESAM	LD (IX-12+CHP.Env_En),A
0704+++8EAA~            	LD (IX-12+CHP.PsInOr),A
0705+++8EAA~            	CALL NZ,SETENV
0706+++8EAA~            	JR PD_SAM_
0707+++8EAA~            0708+++8EAA~            PT3PD	LD A,(IX-12+CHP.Note)
0709+++8EAA~            	LD (PrNote+1),A
0710+++8EAA~            	LD L,(IX-12+CHP.CrTnSl)
0711+++8EAA~            	LD H,(IX-12+CHP.CrTnSl+1)
0712+++8EAA~            	LD (PrSlide+1),HL
0713+++8EAA~            0714+++8EAA~            PD_LOOP	LD DE,#2010
0715+++8EAA~            PD_LP2	LD A,(BC)
0716+++8EAA~            	INC BC
0717+++8EAA~            	ADD A,E
0718+++8EAA~            	JR C,PD_OrSm
0719+++8EAA~            	ADD A,D
0720+++8EAA~            	JR Z,PD_FIN
0721+++8EAA~            	JR C,PD_SAM
0722+++8EAA~            	ADD A,E
0723+++8EAA~            	JR Z,PD_REL
0724+++8EAA~            	JR C,PD_VOL
0725+++8EAA~            	ADD A,E
0726+++8EAA~            	JR Z,PD_EOff
0727+++8EAA~            	JR C,PD_SorE
0728+++8EAA~            	ADD A,96
0729+++8EAA~            	JR C,PD_NOTE
0730+++8EAA~            	ADD A,E
0731+++8EAA~            	JR C,PD_ORN
0732+++8EAA~            	ADD A,D
0733+++8EAA~            	JR C,PD_NOIS
0734+++8EAA~            	ADD A,E
0735+++8EAA~            	JR C,PD_ESAM
0736+++8EAA~            	ADD A,A
0737+++8EAA~            	LD E,A
0738+++8EAA~            	LD HL,(SPCCOMS+#FF20-#2000)&65535
0739+++8EAA~            	ADD HL,DE
0740+++8EAA~            	LD E,(HL)
0741+++8EAA~            	INC HL
0742+++8EAA~            	LD D,(HL)
0743+++8EAA~            	PUSH DE
0744+++8EAA~            	JR PD_LOOP
0745+++8EAA~            0746+++8EAA~            PD_NOIS	LD (IY-100+VRS.Ns_Base),A
0747+++8EAA~            	JR PD_LP2
0748+++8EAA~            0749+++8EAA~            PD_REL	RES 0,(IX-12+CHP.Flags)
0750+++8EAA~            	JR PD_RES
0751+++8EAA~            0752+++8EAA~            PD_NOTE	LD (IX-12+CHP.Note),A
0753+++8EAA~            	SET 0,(IX-12+CHP.Flags)
0754+++8EAA~            	XOR A
0755+++8EAA~            0756+++8EAA~            PD_RES	LD (PDSP_+1),SP
0757+++8EAA~            	LD SP,IX
0758+++8EAA~            	LD H,A
0759+++8EAA~            	LD L,A
0760+++8EAA~            	PUSH HL
0761+++8EAA~            	PUSH HL
0762+++8EAA~            	PUSH HL
0763+++8EAA~            	PUSH HL
0764+++8EAA~            	PUSH HL
0765+++8EAA~            	PUSH HL
0766+++8EAA~            PDSP_	LD SP,#3131
0767+++8EAA~            0768+++8EAA~            PD_FIN	LD A,(IX-12+CHP.NNtSkp)
0769+++8EAA~            	LD (IX-12+CHP.NtSkCn),A
0770+++8EAA~            	RET
0771+++8EAA~            0772+++8EAA~            C_PORTM LD A,(BC)
0773+++8EAA~            	INC BC
0774+++8EAA~            ;SKIP PRECALCULATED TONE DELTA (BECAUSE
0775+++8EAA~            ;CANNOT BE RIGHT AFTER PT3 COMPILATION)
0776+++8EAA~            	INC BC
0777+++8EAA~            	INC BC
0778+++8EAA~            	EX AF,AF'
0779+++8EAA~            	LD A,(BC) ;SIGNED TONE STEP
0780+++8EAA~            	INC BC
0781+++8EAA~            	LD (LoStep),A
0782+++8EAA~            	LD A,(BC)
0783+++8EAA~            	INC BC
0784+++8EAA~            	AND A
0785+++8EAA~            	EX AF,AF'
0786+++8EAA~            	LD L,(IX-12+CHP.CrTnSl)
0787+++8EAA~            	LD H,(IX-12+CHP.CrTnSl+1)
0788+++8EAA~            0789+++8EAA~            ;Set portamento variables
0790+++8EAA~            ;A - Delay; A' - Hi(Step); ZF' - (A'=0); HL - CrTnSl
0791+++8EAA~            0792+++8EAA~            SETPORT	RES 2,(IX-12+CHP.Flags)
0793+++8EAA~            	LD (IX-12+CHP.TnSlDl),A
0794+++8EAA~            	LD (IX-12+CHP.TSlCnt),A
0795+++8EAA~            	PUSH HL
0796+++8EAA~            	LD DE,NT_
0797+++8EAA~            	LD A,(IX-12+CHP.Note)
0798+++8EAA~            	LD (IX-12+CHP.SlToNt),A
0799+++8EAA~            	ADD A,A
0800+++8EAA~            	LD L,A
0801+++8EAA~            	LD H,0
0802+++8EAA~            	ADD HL,DE
0803+++8EAA~            	LD A,(HL)
0804+++8EAA~            	INC HL
0805+++8EAA~            	LD H,(HL)
0806+++8EAA~            	LD L,A
0807+++8EAA~            	PUSH HL
0808+++8EAA~            PrNote	LD A,#3E
0809+++8EAA~            	LD (IX-12+CHP.Note),A
0810+++8EAA~            	ADD A,A
0811+++8EAA~            	LD L,A
0812+++8EAA~            	LD H,0
0813+++8EAA~            	ADD HL,DE
0814+++8EAA~            	LD E,(HL)
0815+++8EAA~            	INC HL
0816+++8EAA~            	LD D,(HL)
0817+++8EAA~            	POP HL
0818+++8EAA~            	SBC HL,DE
0819+++8EAA~            	LD (IX-12+CHP.TnDelt),L
0820+++8EAA~            	LD (IX-12+CHP.TnDelt+1),H
0821+++8EAA~            	POP DE
0822+++8EAA~            Version EQU $+1
0823+++8EAA~            	LD A,#3E
0824+++8EAA~            	CP 6
0825+++8EAA~            	JR C,OLDPRTM ;Old 3xxx for PT v3.5-
0826+++8EAA~            PrSlide	LD DE,#1111
0827+++8EAA~            	LD (IX-12+CHP.CrTnSl),E
0828+++8EAA~            	LD (IX-12+CHP.CrTnSl+1),D
0829+++8EAA~            LoStep	EQU $+1
0830+++8EAA~            OLDPRTM	LD A,#3E
0831+++8EAA~            	EX AF,AF'
0832+++8EAA~            	JR Z,NOSIG
0833+++8EAA~            	EX DE,HL
0834+++8EAA~            NOSIG	SBC HL,DE
0835+++8EAA~            	JP P,SET_STP
0836+++8EAA~            	CPL
0837+++8EAA~            	EX AF,AF'
0838+++8EAA~            	NEG
0839+++8EAA~            	EX AF,AF'
0840+++8EAA~            SET_STP	LD (IX-12+CHP.TSlStp+1),A
0841+++8EAA~            	EX AF,AF'
0842+++8EAA~            	LD (IX-12+CHP.TSlStp),A
0843+++8EAA~            	LD (IX-12+CHP.COnOff),0
0844+++8EAA~            	RET
0845+++8EAA~            0846+++8EAA~            C_GLISS	SET 2,(IX-12+CHP.Flags)
0847+++8EAA~            	LD A,(BC)
0848+++8EAA~            	INC BC
0849+++8EAA~            	LD (IX-12+CHP.TnSlDl),A
0850+++8EAA~            	AND A
0851+++8EAA~            	JR NZ,GL36
0852+++8EAA~            	LD A,(Version) ;AlCo PT3.7+
0853+++8EAA~            	CP 7
0854+++8EAA~            	SBC A,A
0855+++8EAA~            	INC A
0856+++8EAA~            GL36	LD (IX-12+CHP.TSlCnt),A
0857+++8EAA~            	LD A,(BC)
0858+++8EAA~            	INC BC
0859+++8EAA~            	EX AF,AF'
0860+++8EAA~            	LD A,(BC)
0861+++8EAA~            	INC BC
0862+++8EAA~            	JR SET_STP
0863+++8EAA~            0864+++8EAA~            C_SMPOS	LD A,(BC)
0865+++8EAA~            	INC BC
0866+++8EAA~            	LD (IX-12+CHP.PsInSm),A
0867+++8EAA~            	RET
0868+++8EAA~            0869+++8EAA~            C_ORPOS	LD A,(BC)
0870+++8EAA~            	INC BC
0871+++8EAA~            	LD (IX-12+CHP.PsInOr),A
0872+++8EAA~            	RET
0873+++8EAA~            0874+++8EAA~            C_VIBRT	LD A,(BC)
0875+++8EAA~            	INC BC
0876+++8EAA~            	LD (IX-12+CHP.OnOffD),A
0877+++8EAA~            	LD (IX-12+CHP.COnOff),A
0878+++8EAA~            	LD A,(BC)
0879+++8EAA~            	INC BC
0880+++8EAA~            	LD (IX-12+CHP.OffOnD),A
0881+++8EAA~            	XOR A
0882+++8EAA~            	LD (IX-12+CHP.TSlCnt),A
0883+++8EAA~            	LD (IX-12+CHP.CrTnSl),A
0884+++8EAA~            	LD (IX-12+CHP.CrTnSl+1),A
0885+++8EAA~            	RET
0886+++8EAA~            0887+++8EAA~            C_ENGLS	LD A,(BC)
0888+++8EAA~            	INC BC
0889+++8EAA~            	LD (IY-100+VRS.Env_Del),A
0890+++8EAA~            	LD (IY-100+VRS.CurEDel),A
0891+++8EAA~            	LD A,(BC)
0892+++8EAA~            	INC BC
0893+++8EAA~            	LD L,A
0894+++8EAA~            	LD A,(BC)
0895+++8EAA~            	INC BC
0896+++8EAA~            	LD H,A
0897+++8EAA~            	LD (IY-100+VRS.ESldAdd),L
0898+++8EAA~            	LD (IY-100+VRS.ESldAdd+1),H
0899+++8EAA~            	RET
0900+++8EAA~            0901+++8EAA~            C_DELAY	LD A,(BC)
0902+++8EAA~            	INC BC
0903+++8EAA~            	LD (IY-100+VRS.Delay),A
0904+++8EAA~            	LD HL,VARS2+VRS.ModNum ;if AlCo_TS
0905+++8EAA~            	BIT 1,(HL)
0906+++8EAA~            	RET Z
0907+++8EAA~            	LD (VARS1+VRS.Delay),A
0908+++8EAA~            	LD (VARS1+VRS.DelyCnt),A
0909+++8EAA~            	LD (VARS2+VRS.Delay),A
0910+++8EAA~            	RET
0911+++8EAA~            	
0912+++8EAA~            SETENV	LD (IX-12+CHP.Env_En),E
0913+++8EAA~            	LD (IY-100+VRS.AYREGS+EnvTp),A
0914+++8EAA~            	LD A,(BC)
0915+++8EAA~            	INC BC
0916+++8EAA~            	LD H,A
0917+++8EAA~            	LD A,(BC)
0918+++8EAA~            	INC BC
0919+++8EAA~            	LD L,A
0920+++8EAA~            	CALL SETENBS
0921+++8EAA~            	XOR A
0922+++8EAA~            	LD (IX-12+CHP.PsInOr),A
0923+++8EAA~            	LD (IY-100+VRS.CurEDel),A
0924+++8EAA~            	LD H,A
0925+++8EAA~            	LD L,A
0926+++8EAA~            	JP SETESLD
0927+++8EAA~            0928+++8EAA~            SETORN	ADD A,A
0929+++8EAA~            	LD E,A
0930+++8EAA~            	LD D,0
0931+++8EAA~            	LD (IX-12+CHP.PsInOr),D
0932+++8EAA~            	LD L,(IY-100+VRS.OrnPtrs)
0933+++8EAA~            	LD H,(IY-100+VRS.OrnPtrs+1)
0934+++8EAA~            	ADD HL,DE
0935+++8EAA~            	LD E,(HL)
0936+++8EAA~            	INC HL
0937+++8EAA~            	LD D,(HL)
0938+++8EAA~            	LD L,(IY-100+VRS.MODADDR)
0939+++8EAA~            	LD H,(IY-100+VRS.MODADDR+1)
0940+++8EAA~            	ADD HL,DE
0941+++8EAA~            	LD (IX-12+CHP.OrnPtr),L
0942+++8EAA~            	LD (IX-12+CHP.OrnPtr+1),H
0943+++8EAA~            C_NOP	RET
0944+++8EAA~            0945+++8EAA~            SETSAM	ADD A,A
0946+++8EAA~            	LD E,A
0947+++8EAA~            	LD D,0
0948+++8EAA~            	LD L,(IY-100+VRS.SamPtrs);
0949+++8EAA~            	LD H,(IY-100+VRS.SamPtrs+1);
0950+++8EAA~            	ADD HL,DE
0951+++8EAA~            	LD E,(HL)
0952+++8EAA~            	INC HL
0953+++8EAA~            	LD D,(HL)
0954+++8EAA~            	LD L,(IY-100+VRS.MODADDR)
0955+++8EAA~            	LD H,(IY-100+VRS.MODADDR+1)
0956+++8EAA~            	ADD HL,DE
0957+++8EAA~            	LD (IX-12+CHP.SamPtr),L
0958+++8EAA~            	LD (IX-12+CHP.SamPtr+1),H
0959+++8EAA~            	RET
0960+++8EAA~            0961+++8EAA~            ;ALL 16 ADDRESSES TO PROTECT FROM BROKEN PT3 MODULES
0962+++8EAA~            SPCCOMS DW C_NOP
0963+++8EAA~            	DW C_GLISS
0964+++8EAA~            	DW C_PORTM
0965+++8EAA~            	DW C_SMPOS
0966+++8EAA~            	DW C_ORPOS
0967+++8EAA~            	DW C_VIBRT
0968+++8EAA~            	DW C_NOP
0969+++8EAA~            	DW C_NOP
0970+++8EAA~            	DW C_ENGLS
0971+++8EAA~            	DW C_DELAY
0972+++8EAA~            	DW C_NOP
0973+++8EAA~            	DW C_NOP
0974+++8EAA~            	DW C_NOP
0975+++8EAA~            	DW C_NOP
0976+++8EAA~            	DW C_NOP
0977+++8EAA~            	DW C_NOP
0978+++8EAA~            0979+++8EAA~            CHREGS	CALL GETIX
0980+++8EAA~            	XOR A
0981+++8EAA~            	LD (Ampl),A
0982+++8EAA~            	BIT 0,(IX+CHP.Flags)
0983+++8EAA~            	PUSH HL
0984+++8EAA~            	JP Z,CH_EXIT
0985+++8EAA~            	LD (CSP_+1),SP
0986+++8EAA~            	LD L,(IX+CHP.OrnPtr)
0987+++8EAA~            	LD H,(IX+CHP.OrnPtr+1)
0988+++8EAA~            	LD SP,HL
0989+++8EAA~            	POP DE
0990+++8EAA~            	LD H,A
0991+++8EAA~            	LD A,(IX+CHP.PsInOr)
0992+++8EAA~            	LD L,A
0993+++8EAA~            	ADD HL,SP
0994+++8EAA~            	INC A
0995+++8EAA~            		;PT2	PT3
0996+++8EAA~            OrnCP	INC A	;CP E	CP D
0997+++8EAA~            	JR C,CH_ORPS
0998+++8EAA~            OrnLD	DB 1	;LD A,D	LD A,E
0999+++8EAA~            CH_ORPS	LD (IX+CHP.PsInOr),A
1000+++8EAA~            	LD A,(IX+CHP.Note)
1001+++8EAA~            	ADD A,(HL)
1002+++8EAA~            	JP P,CH_NTP
1003+++8EAA~            	XOR A
1004+++8EAA~            CH_NTP	CP 96
1005+++8EAA~            	JR C,CH_NOK
1006+++8EAA~            	LD A,95
1007+++8EAA~            CH_NOK	ADD A,A
1008+++8EAA~            	EX AF,AF'
1009+++8EAA~            	LD L,(IX+CHP.SamPtr)
1010+++8EAA~            	LD H,(IX+CHP.SamPtr+1)
1011+++8EAA~            	LD SP,HL
1012+++8EAA~            	POP DE
1013+++8EAA~            	LD H,0
1014+++8EAA~            	LD A,(IX+CHP.PsInSm)
1015+++8EAA~            	LD B,A
1016+++8EAA~            	ADD A,A
1017+++8EAA~            SamClc2	ADD A,A ;or ADD A,B for PT2
1018+++8EAA~            	LD L,A
1019+++8EAA~            	ADD HL,SP
1020+++8EAA~            	LD SP,HL
1021+++8EAA~            	LD A,B
1022+++8EAA~            	INC A
1023+++8EAA~            		;PT2	PT3
1024+++8EAA~            SamCP	INC A	;CP E	CP D
1025+++8EAA~            	JR C,CH_SMPS
1026+++8EAA~            SamLD	DB 1	;LD A,D	LD A,E
1027+++8EAA~            CH_SMPS	LD (IX+CHP.PsInSm),A
1028+++8EAA~            	POP BC
1029+++8EAA~            	POP HL
1030+++8EAA~            1031+++8EAA~            ;Convert PT2 sample to PT3
1032+++8EAA~            		;PT2		PT3
1033+++8EAA~            SamCnv	POP HL  ;BIT 2,C	JR e_
1034+++8EAA~            	POP HL	
1035+++8EAA~            	LD H,B
1036+++8EAA~            	JR NZ,$+8
1037+++8EAA~            	EX DE,HL
1038+++8EAA~            	AND A
1039+++8EAA~            	SBC HL,HL
1040+++8EAA~            	SBC HL,DE
1041+++8EAA~            	LD D,C
1042+++8EAA~            	RR C
1043+++8EAA~            	SBC A,A
1044+++8EAA~            	CPL
1045+++8EAA~            	AND #3E
1046+++8EAA~            	RR C
1047+++8EAA~            	RR B
1048+++8EAA~            	AND C
1049+++8EAA~            	LD C,A
1050+++8EAA~            	LD A,B
1051+++8EAA~            	RRA
1052+++8EAA~            	RRA
1053+++8EAA~            	RR D
1054+++8EAA~            	RRA
1055+++8EAA~            	AND #9F
1056+++8EAA~            	LD B,A
1057+++8EAA~            1058+++8EAA~            e_	LD E,(IX+CHP.TnAcc)
1059+++8EAA~            	LD D,(IX+CHP.TnAcc+1)
1060+++8EAA~            	ADD HL,DE
1061+++8EAA~            	BIT 6,B
1062+++8EAA~            	JR Z,CH_NOAC
1063+++8EAA~            	LD (IX+CHP.TnAcc),L
1064+++8EAA~            	LD (IX+CHP.TnAcc+1),H
1065+++8EAA~            CH_NOAC EX DE,HL
1066+++8EAA~            	EX AF,AF'
1067+++8EAA~            	ADD A,NT_&255
1068+++8EAA~            	LD L,A
1069+++8EAA~            	ADC A,NT_/256
1070+++8EAA~            	SUB L
1071+++8EAA~            	LD H,A
1072+++8EAA~            	LD SP,HL
1073+++8EAA~            	POP HL
1074+++8EAA~            	ADD HL,DE
1075+++8EAA~            	LD E,(IX+CHP.CrTnSl)
1076+++8EAA~            	LD D,(IX+CHP.CrTnSl+1)
1077+++8EAA~            	ADD HL,DE
1078+++8EAA~            CSP_	LD SP,#3131
1079+++8EAA~            	EX (SP),HL
1080+++8EAA~            	XOR A
1081+++8EAA~            	OR (IX+CHP.TSlCnt)
1082+++8EAA~            	JR Z,CH_AMP
1083+++8EAA~            	DEC (IX+CHP.TSlCnt)
1084+++8EAA~            	JR NZ,CH_AMP
1085+++8EAA~            	LD A,(IX+CHP.TnSlDl)
1086+++8EAA~            	LD (IX+CHP.TSlCnt),A
1087+++8EAA~            	LD L,(IX+CHP.TSlStp)
1088+++8EAA~            	LD H,(IX+CHP.TSlStp+1)
1089+++8EAA~            	LD A,H
1090+++8EAA~            	ADD HL,DE
1091+++8EAA~            	LD (IX+CHP.CrTnSl),L
1092+++8EAA~            	LD (IX+CHP.CrTnSl+1),H
1093+++8EAA~            	BIT 2,(IX+CHP.Flags)
1094+++8EAA~            	JR NZ,CH_AMP
1095+++8EAA~            	LD E,(IX+CHP.TnDelt)
1096+++8EAA~            	LD D,(IX+CHP.TnDelt+1)
1097+++8EAA~            	AND A
1098+++8EAA~            	JR Z,CH_STPP
1099+++8EAA~            	EX DE,HL
1100+++8EAA~            CH_STPP SBC HL,DE
1101+++8EAA~            	JP M,CH_AMP
1102+++8EAA~            	LD A,(IX+CHP.SlToNt)
1103+++8EAA~            	LD (IX+CHP.Note),A
1104+++8EAA~            	XOR A
1105+++8EAA~            	LD (IX+CHP.TSlCnt),A
1106+++8EAA~            	LD (IX+CHP.CrTnSl),A
1107+++8EAA~            	LD (IX+CHP.CrTnSl+1),A
1108+++8EAA~            CH_AMP	LD A,(IX+CHP.CrAmSl)
1109+++8EAA~            	BIT 7,C
1110+++8EAA~            	JR Z,CH_NOAM
1111+++8EAA~            	BIT 6,C
1112+++8EAA~            	JR Z,CH_AMIN
1113+++8EAA~            	CP 15
1114+++8EAA~            	JR Z,CH_NOAM
1115+++8EAA~            	INC A
1116+++8EAA~            	JR CH_SVAM
1117+++8EAA~            CH_AMIN	CP -15
1118+++8EAA~            	JR Z,CH_NOAM
1119+++8EAA~            	DEC A
1120+++8EAA~            CH_SVAM	LD (IX+CHP.CrAmSl),A
1121+++8EAA~            CH_NOAM	LD L,A
1122+++8EAA~            	LD A,B
1123+++8EAA~            	AND 15
1124+++8EAA~            	ADD A,L
1125+++8EAA~            	JP P,CH_APOS
1126+++8EAA~            	XOR A
1127+++8EAA~            CH_APOS	CP 16
1128+++8EAA~            	JR C,CH_VOL
1129+++8EAA~            	LD A,15
1130+++8EAA~            CH_VOL	OR (IX+CHP.Volume)
1131+++8EAA~            	ADD A,VT_&255
1132+++8EAA~            	LD L,A
1133+++8EAA~            	ADC A,VT_/256
1134+++8EAA~            	SUB L
1135+++8EAA~            	LD H,A
1136+++8EAA~            	LD A,(HL)
1137+++8EAA~            CH_ENV	BIT 0,C
1138+++8EAA~            	JR NZ,CH_NOEN
1139+++8EAA~            	OR (IX+CHP.Env_En)
1140+++8EAA~            CH_NOEN	LD (Ampl),A
1141+++8EAA~            	BIT 7,B
1142+++8EAA~            	LD A,C
1143+++8EAA~            	JR Z,NO_ENSL
1144+++8EAA~            	RLA
1145+++8EAA~            	RLA
1146+++8EAA~            	SRA A
1147+++8EAA~            	SRA A
1148+++8EAA~            	SRA A
1149+++8EAA~            	ADD A,(IX+CHP.CrEnSl) ;SEE COMMENT BELOW
1150+++8EAA~            	BIT 5,B
1151+++8EAA~            	JR Z,NO_ENAC
1152+++8EAA~            	LD (IX+CHP.CrEnSl),A
1153+++8EAA~            NO_ENAC	ADD A,(IY-100+VRS.AddToEn) ;BUG IN PT3 - NEED WORD HERE
1154+++8EAA~            	LD (IY-100+VRS.AddToEn),A
1155+++8EAA~            	JR CH_MIX
1156+++8EAA~            NO_ENSL RRA
1157+++8EAA~            	ADD A,(IX+CHP.CrNsSl)
1158+++8EAA~            	LD (IY-100+VRS.AddToNs),A
1159+++8EAA~            	BIT 5,B
1160+++8EAA~            	JR Z,CH_MIX
1161+++8EAA~            	LD (IX+CHP.CrNsSl),A
1162+++8EAA~            CH_MIX	LD A,B
1163+++8EAA~            	RRA
1164+++8EAA~            	AND #48
1165+++8EAA~            CH_EXIT	OR (IY-100+VRS.AYREGS+Mixer)
1166+++8EAA~            	RRCA
1167+++8EAA~            	LD (IY-100+VRS.AYREGS+Mixer),A
1168+++8EAA~            	POP HL
1169+++8EAA~            	XOR A
1170+++8EAA~            	OR (IX+CHP.COnOff)
1171+++8EAA~            	RET Z
1172+++8EAA~            	DEC (IX+CHP.COnOff)
1173+++8EAA~            	RET NZ
1174+++8EAA~            	XOR (IX+CHP.Flags)
1175+++8EAA~            	LD (IX+CHP.Flags),A
1176+++8EAA~            	RRA
1177+++8EAA~            	LD A,(IX+CHP.OnOffD)
1178+++8EAA~            	JR C,CH_ONDL
1179+++8EAA~            	LD A,(IX+CHP.OffOnD)
1180+++8EAA~            CH_ONDL	LD (IX+CHP.COnOff),A
1181+++8EAA~            	RET
1182+++8EAA~            1183+++8EAA~            PLAY_	XOR A
1184+++8EAA~            	LD (IY-100+VRS.AddToEn),A
1185+++8EAA~            	LD (IY-100+VRS.AYREGS+Mixer),A
1186+++8EAA~            	DEC A
1187+++8EAA~            	LD (IY-100+VRS.AYREGS+EnvTp),A
1188+++8EAA~            	DEC (IY-100+VRS.DelyCnt)
1189+++8EAA~            	JP NZ,PL2
1190+++8EAA~            	DEC (IY-100+VRS.ChanA+CHP.NtSkCn)
1191+++8EAA~            	JR NZ,PL1B
1192+++8EAA~            	LD C,(IY-100+VRS.AdInPtA)
1193+++8EAA~            	LD B,(IY-100+VRS.AdInPtA+1)
1194+++8EAA~            	LD A,(BC)
1195+++8EAA~            	AND A
1196+++8EAA~            	JR NZ,PL1A
1197+++8EAA~            	LD D,A
1198+++8EAA~            	LD (IY-100+VRS.Ns_Base),A
1199+++8EAA~            	LD L,(IY-100+VRS.CrPsPtr)
1200+++8EAA~            	LD H,(IY-100+VRS.CrPsPtr+1)
1201+++8EAA~            	INC HL
1202+++8EAA~            	LD A,(HL)
1203+++8EAA~            	INC A
1204+++8EAA~            	JR NZ,PLNLP
1205+++8EAA~            1206+++8EAA~            	IF LoopChecker
1207+++8EAA~            	CALL CHECKLP
1208+++8EAA~            	ENDIF
1209+++8EAA~            1210+++8EAA~            	LD L,(IY-100+VRS.LPosPtr)
1211+++8EAA~            	LD H,(IY-100+VRS.LPosPtr+1)
1212+++8EAA~            	LD A,(HL)
1213+++8EAA~            	INC A
1214+++8EAA~            PLNLP	CALL SETCPPT
1215+++8EAA~            	DEC A
1216+++8EAA~            	BIT 1,(IY-100+VRS.ModNum)
1217+++8EAA~            	JR Z,NoAlCo
1218+++8EAA~            TSSub	EQU $+1
1219+++8EAA~            	SUB #D6
1220+++8EAA~            	CPL
1221+++8EAA~            NoAlCo
1222+++8EAA~            		;PT2		PT3
1223+++8EAA~            PsCalc	DEC A	;ADD A,A	NOP
1224+++8EAA~            	DEC A	;ADD A,(HL)	NOP
1225+++8EAA~            	ADD A,A
1226+++8EAA~            	LD E,A
1227+++8EAA~            	RL D
1228+++8EAA~            1229+++8EAA~            	IF CurPosCounter
1230+++8EAA~            	LD A,L
1231+++8EAA~            	SUB (IY-100+VRS.PosSub)
1232+++8EAA~            	LD (IY-100+VRS.CurPos),A
1233+++8EAA~            	ENDIF
1234+++8EAA~            1235+++8EAA~            	LD L,(IY-100+VRS.PatsPtr)
1236+++8EAA~            	LD H,(IY-100+VRS.PatsPtr+1)
1237+++8EAA~            	ADD HL,DE
1238+++8EAA~            	LD E,(IY-100+VRS.MODADDR)
1239+++8EAA~            	LD D,(IY-100+VRS.MODADDR+1)
1240+++8EAA~            	LD (PSP_+1),SP
1241+++8EAA~            	LD SP,HL
1242+++8EAA~            	POP HL
1243+++8EAA~            	ADD HL,DE
1244+++8EAA~            	LD B,H
1245+++8EAA~            	LD C,L
1246+++8EAA~            	POP HL
1247+++8EAA~            	ADD HL,DE
1248+++8EAA~            	LD (IY-100+VRS.AdInPtB),L
1249+++8EAA~            	LD (IY-100+VRS.AdInPtB+1),H
1250+++8EAA~            	POP HL
1251+++8EAA~            	ADD HL,DE
1252+++8EAA~            	LD (IY-100+VRS.AdInPtC),L
1253+++8EAA~            	LD (IY-100+VRS.AdInPtC+1),H
1254+++8EAA~            PSP_	LD SP,#3131
1255+++8EAA~            PL1A	LD DE,VRS.ChanA+12-100
1256+++8EAA~            	CALL PTDECOD
1257+++8EAA~            	LD (IY-100+VRS.AdInPtA),C
1258+++8EAA~            	LD (IY-100+VRS.AdInPtA+1),B
1259+++8EAA~            1260+++8EAA~            PL1B	DEC (IY-100+VRS.ChanB+CHP.NtSkCn)
1261+++8EAA~            	JR NZ,PL1C
1262+++8EAA~            	LD DE,VRS.ChanB+12-100
1263+++8EAA~            	LD C,(IY-100+VRS.AdInPtB)
1264+++8EAA~            	LD B,(IY-100+VRS.AdInPtB+1)
1265+++8EAA~            	CALL PTDECOD
1266+++8EAA~            	LD (IY-100+VRS.AdInPtB),C
1267+++8EAA~            	LD (IY-100+VRS.AdInPtB+1),B
1268+++8EAA~            1269+++8EAA~            PL1C	DEC (IY-100+VRS.ChanC+CHP.NtSkCn)
1270+++8EAA~            	JR NZ,PL1D
1271+++8EAA~            	LD DE,VRS.ChanC+12-100
1272+++8EAA~            	LD C,(IY-100+VRS.AdInPtC)
1273+++8EAA~            	LD B,(IY-100+VRS.AdInPtC+1)
1274+++8EAA~            	CALL PTDECOD
1275+++8EAA~            	LD (IY-100+VRS.AdInPtC),C
1276+++8EAA~            	LD (IY-100+VRS.AdInPtC+1),B
1277+++8EAA~            1278+++8EAA~            PL1D	LD A,(IY-100+VRS.Delay)
1279+++8EAA~            	LD (IY-100+VRS.DelyCnt),A
1280+++8EAA~            1281+++8EAA~            PL2	LD DE,VRS.ChanA-100
1282+++8EAA~            	LD L,(IY-100+VRS.AYREGS+TonA)
1283+++8EAA~            	LD H,(IY-100+VRS.AYREGS+TonA+1)
1284+++8EAA~            	CALL CHREGS
1285+++8EAA~            	LD (IY-100+VRS.AYREGS+TonA),L
1286+++8EAA~            	LD (IY-100+VRS.AYREGS+TonA+1),H
1287+++8EAA~            Ampl	EQU $+1
1288+++8EAA~            	LD A,#3E
1289+++8EAA~            	LD (IY-100+VRS.AYREGS+AmplA),A
1290+++8EAA~            	LD DE,VRS.ChanB-100
1291+++8EAA~            	LD L,(IY-100+VRS.AYREGS+TonB)
1292+++8EAA~            	LD H,(IY-100+VRS.AYREGS+TonB+1)
1293+++8EAA~            	CALL CHREGS
1294+++8EAA~            	LD (IY-100+VRS.AYREGS+TonB),L
1295+++8EAA~            	LD (IY-100+VRS.AYREGS+TonB+1),H
1296+++8EAA~            	LD A,(Ampl)
1297+++8EAA~            	LD (IY-100+VRS.AYREGS+AmplB),A
1298+++8EAA~            	LD DE,VRS.ChanC-100
1299+++8EAA~            	LD L,(IY-100+VRS.AYREGS+TonC)
1300+++8EAA~            	LD H,(IY-100+VRS.AYREGS+TonC+1)
1301+++8EAA~            	CALL CHREGS
1302+++8EAA~            	LD (IY-100+VRS.AYREGS+TonC),L
1303+++8EAA~            	LD (IY-100+VRS.AYREGS+TonC+1),H
1304+++8EAA~            	LD A,(Ampl)
1305+++8EAA~            	LD (IY-100+VRS.AYREGS+AmplC),A
1306+++8EAA~            1307+++8EAA~            	LD A,(IY-100+VRS.Ns_Base)
1308+++8EAA~            	ADD (IY-100+VRS.AddToNs)
1309+++8EAA~            	LD (IY-100+VRS.AYREGS+Noise),A
1310+++8EAA~            1311+++8EAA~            	LD A,(IY-100+VRS.AddToEn)
1312+++8EAA~            	LD E,A
1313+++8EAA~            	ADD A,A
1314+++8EAA~            	SBC A,A
1315+++8EAA~            	LD D,A
1316+++8EAA~            	LD L,(IY-100+VRS.EnvBase)
1317+++8EAA~            	LD H,(IY-100+VRS.EnvBase+1)
1318+++8EAA~            	ADD HL,DE
1319+++8EAA~            	LD E,(IY-100+VRS.CurESld)
1320+++8EAA~            	LD D,(IY-100+VRS.CurESld+1)
1321+++8EAA~            	ADD HL,DE
1322+++8EAA~            	LD (IY-100+VRS.AYREGS+Env),L
1323+++8EAA~            	LD (IY-100+VRS.AYREGS+Env+1),H
1324+++8EAA~            1325+++8EAA~            	XOR A
1326+++8EAA~            	OR (IY-100+VRS.CurEDel)
1327+++8EAA~            	RET Z
1328+++8EAA~            	DEC (IY-100+VRS.CurEDel)
1329+++8EAA~            	RET NZ
1330+++8EAA~            	LD A,(IY-100+VRS.Env_Del)
1331+++8EAA~            	LD (IY-100+VRS.CurEDel),A
1332+++8EAA~            	LD L,(IY-100+VRS.ESldAdd)
1333+++8EAA~            	LD H,(IY-100+VRS.ESldAdd+1)
1334+++8EAA~            	ADD HL,DE
1335+++8EAA~            	JP SETESLD
1336+++8EAA~            1337+++8EAA~            PLAY    LD IY,VARS1+100
1338+++8EAA~            	CALL PLAY_
1339+++8EAA~            	LD A,(is_ts)
1340+++8EAA~            	AND A
1341+++8EAA~            	JR Z,PL_nts
1342+++8EAA~            	LD IY,VARS2+100
1343+++8EAA~            	CALL PLAY_
1344+++8EAA~            PL_nts
1345+++8EAA~            	IF Basic
1346+++8EAA~            	LD IY,#5C3A
1347+++8EAA~            	ENDIF
1348+++8EAA~            1349+++8EAA~            ROUT	LD BC,#FFFD
1350+++8EAA~              IFDEF ONtfm
1351+++8EAA~                LD L,#F9
1352+++8EAA~                OUT (C),L
1353+++8EAA~              ELSE
1354+++8EAA~            	LD A,(is_ts)
1355+++8EAA~            	AND A
1356+++8EAA~            	JR Z,r_nts ;keep old standard
1357+++8EAA~            	OUT (C),B
1358+++8EAA~                ENDIF
1359+++8EAA~            r_nts	EX AF,AF'
1360+++8EAA~            1361+++8EAA~            	IF ACBBAC
1362+++8EAA~            	LD IX,VARS1+VRS.AYREGS
1363+++8EAA~            	ELSE
1364+++8EAA~            	LD HL,VARS1+VRS.AYREGS
1365+++8EAA~            	ENDIF
1366+++8EAA~            1367+++8EAA~            	CALL ROUT_
1368+++8EAA~            	EX AF,AF'
1369+++8EAA~            	RET Z
1370+++8EAA~            	LD B,D
1371+++8EAA~            1372+++8EAA~                IFDEF ONtfm
1373+++8EAA~                LD A,#F8
1374+++8EAA~                ELSE
1375+++8EAA~            	CPL
1376+++8EAA~                ENDIF
1377+++8EAA~            	OUT (C),A
1378+++8EAA~            1379+++8EAA~            	IF ACBBAC
1380+++8EAA~            	LD IX,VARS2+VRS.AYREGS
1381+++8EAA~            	ELSE
1382+++8EAA~            	LD HL,VARS2+VRS.AYREGS
1383+++8EAA~            	ENDIF
1384+++8EAA~            1385+++8EAA~            ROUT_
1386+++8EAA~            	IF ACBBAC
1387+++8EAA~            	LD A,(SETUP)
1388+++8EAA~            	AND 12
1389+++8EAA~            	JR Z,ABC
1390+++8EAA~            	ADD A,CHTABLE
1391+++8EAA~            	LD E,A
1392+++8EAA~            	ADC A,CHTABLE/256
1393+++8EAA~            	SUB E
1394+++8EAA~            	LD D,A
1395+++8EAA~            	LD B,0
1396+++8EAA~            	PUSH IX
1397+++8EAA~            	POP HL
1398+++8EAA~            	LD A,(DE)
1399+++8EAA~            	INC DE
1400+++8EAA~            	LD C,A
1401+++8EAA~            	ADD HL,BC
1402+++8EAA~            	LD A,(IX+TonB)
1403+++8EAA~            	LD C,(HL)
1404+++8EAA~            	LD (IX+TonB),C
1405+++8EAA~            	LD (HL),A
1406+++8EAA~            	INC HL
1407+++8EAA~            	LD A,(IX+TonB+1)
1408+++8EAA~            	LD C,(HL)
1409+++8EAA~            	LD (IX+TonB+1),C
1410+++8EAA~            	LD (HL),A
1411+++8EAA~            	LD A,(DE)
1412+++8EAA~            	INC DE
1413+++8EAA~            	LD C,A
1414+++8EAA~            	ADD HL,BC
1415+++8EAA~            	LD A,(IX+AmplB)
1416+++8EAA~            	LD C,(HL)
1417+++8EAA~            	LD (IX+AmplB),C
1418+++8EAA~            	LD (HL),A
1419+++8EAA~            	LD A,(DE)
1420+++8EAA~            	INC DE
1421+++8EAA~            	LD (RxCA1),A
1422+++8EAA~            	XOR 8
1423+++8EAA~            	LD (RxCA2),A
1424+++8EAA~            	LD A,(DE)
1425+++8EAA~            	AND (IX+Mixer)
1426+++8EAA~            	LD E,A
1427+++8EAA~            	LD A,(IX+Mixer)
1428+++8EAA~            RxCA1	DB #E6
1429+++8EAA~            	AND %010010
1430+++8EAA~            	OR E
1431+++8EAA~            	LD E,A
1432+++8EAA~            	LD A,(IX+Mixer)
1433+++8EAA~            	AND %010010
1434+++8EAA~            RxCA2	OR E
1435+++8EAA~            	OR E
1436+++8EAA~            	LD (IX+Mixer),A
1437+++8EAA~            ABC
1438+++8EAA~            	ENDIF
1439+++8EAA~            1440+++8EAA~            	XOR A
1441+++8EAA~            	LD DE,#FFBF
1442+++8EAA~            1443+++8EAA~            	IF ACBBAC
1444+++8EAA~            	LD BC,#FFFD
1445+++8EAA~            	PUSH IX
1446+++8EAA~            	POP HL
1447+++8EAA~            	ENDIF
1448+++8EAA~            1449+++8EAA~            LOUT
1450+++8EAA~                IFDEF ONtfm
1451+++8EAA~                INF 
1452+++8EAA~                JP M,$-2
1453+++8EAA~                ENDIF 
1454+++8EAA~                OUT (C),A
1455+++8EAA~                IFDEF ONtfm
1456+++8EAA~                INF 
1457+++8EAA~                JP M,$-2
1458+++8EAA~                ENDIF 
1459+++8EAA~            	LD B,E
1460+++8EAA~            	OUTI 
1461+++8EAA~            	LD B,D
1462+++8EAA~            	INC A
1463+++8EAA~            	CP 13
1464+++8EAA~            	JR NZ,LOUT
1465+++8EAA~                IFDEF ONtfm
1466+++8EAA~                INF 
1467+++8EAA~                JP M,$-2
1468+++8EAA~                ENDIF 
1469+++8EAA~            	OUT (C),A
1470+++8EAA~            	LD A,(HL)
1471+++8EAA~            	AND A
1472+++8EAA~            	RET M
1473+++8EAA~                IFDEF ONtfm
1474+++8EAA~                INF 
1475+++8EAA~                JP M,$-2
1476+++8EAA~                ENDIF 
1477+++8EAA~            	LD B,E
1478+++8EAA~            	OUT (C),A
1479+++8EAA~            	RET
1480+++8EAA~            1481+++8EAA~            	IF ACBBAC
1482+++8EAA~            CHTABLE	EQU $-4
1483+++8EAA~            	DB 4,5,15,%001001,0,7,7,%100100
1484+++8EAA~            	ENDIF
1485+++8EAA~            1486+++8EAA~            NT_DATA	DB (T_NEW_0-T1_)*2
1487+++8EAA~            	DB TCNEW_0-T_
1488+++8EAA~            	DB (T_OLD_0-T1_)*2+1
1489+++8EAA~            	DB TCOLD_0-T_
1490+++8EAA~            	DB (T_NEW_1-T1_)*2+1
1491+++8EAA~            	DB TCNEW_1-T_
1492+++8EAA~            	DB (T_OLD_1-T1_)*2+1
1493+++8EAA~            	DB TCOLD_1-T_
1494+++8EAA~            	DB (T_NEW_2-T1_)*2
1495+++8EAA~            	DB TCNEW_2-T_
1496+++8EAA~            	DB (T_OLD_2-T1_)*2
1497+++8EAA~            	DB TCOLD_2-T_
1498+++8EAA~            	DB (T_NEW_3-T1_)*2
1499+++8EAA~            	DB TCNEW_3-T_
1500+++8EAA~            	DB (T_OLD_3-T1_)*2
1501+++8EAA~            	DB TCOLD_3-T_
1502+++8EAA~            1503+++8EAA~            T_
1504+++8EAA~            1505+++8EAA~            TCOLD_0	DB #00+1,#04+1,#08+1,#0A+1,#0C+1,#0E+1,#12+1,#14+1
1506+++8EAA~            	DB #18+1,#24+1,#3C+1,0
1507+++8EAA~            TCOLD_1	DB #5C+1,0
1508+++8EAA~            TCOLD_2	DB #30+1,#36+1,#4C+1,#52+1,#5E+1,#70+1,#82,#8C,#9C
1509+++8EAA~            	DB #9E,#A0,#A6,#A8,#AA,#AC,#AE,#AE,0
1510+++8EAA~            TCNEW_3	DB #56+1
1511+++8EAA~            TCOLD_3	DB #1E+1,#22+1,#24+1,#28+1,#2C+1,#2E+1,#32+1,#BE+1,0
1512+++8EAA~            TCNEW_0	DB #1C+1,#20+1,#22+1,#26+1,#2A+1,#2C+1,#30+1,#54+1
1513+++8EAA~            	DB #BC+1,#BE+1,0
1514+++8EAA~            TCNEW_1 EQU TCOLD_1
1515+++8EAA~            TCNEW_2	DB #1A+1,#20+1,#24+1,#28+1,#2A+1,#3A+1,#4C+1,#5E+1
1516+++8EAA~            	DB #BA+1,#BC+1,#BE+1,0
1517+++8EAA~            1518+++8EAA~            PT3EMPTYORN EQU $-1
1519+++8EAA~            	DB 1,0
1520+++8EAA~            1521+++8EAA~            ;first 12 values of tone tables (packed)
1522+++8EAA~            1523+++8EAA~            T_PACK	DB #06EC*2/256,#06EC*2&255
1524+++8EAA~            	DB #0755-#06EC
1525+++8EAA~            	DB #07C5-#0755
1526+++8EAA~            	DB #083B-#07C5
1527+++8EAA~            	DB #08B8-#083B
1528+++8EAA~            	DB #093D-#08B8
1529+++8EAA~            	DB #09CA-#093D
1530+++8EAA~            	DB #0A5F-#09CA
1531+++8EAA~            	DB #0AFC-#0A5F
1532+++8EAA~            	DB #0BA4-#0AFC
1533+++8EAA~            	DB #0C55-#0BA4
1534+++8EAA~            	DB #0D10-#0C55
1535+++8EAA~            	DB #066D*2/256,#066D*2&255
1536+++8EAA~            	DB #06CF-#066D
1537+++8EAA~            	DB #0737-#06CF
1538+++8EAA~            	DB #07A4-#0737
1539+++8EAA~            	DB #0819-#07A4
1540+++8EAA~            	DB #0894-#0819
1541+++8EAA~            	DB #0917-#0894
1542+++8EAA~            	DB #09A1-#0917
1543+++8EAA~            	DB #0A33-#09A1
1544+++8EAA~            	DB #0ACF-#0A33
1545+++8EAA~            	DB #0B73-#0ACF
1546+++8EAA~            	DB #0C22-#0B73
1547+++8EAA~            	DB #0CDA-#0C22
1548+++8EAA~            	DB #0704*2/256,#0704*2&255
1549+++8EAA~            	DB #076E-#0704
1550+++8EAA~            	DB #07E0-#076E
1551+++8EAA~            	DB #0858-#07E0
1552+++8EAA~            	DB #08D6-#0858
1553+++8EAA~            	DB #095C-#08D6
1554+++8EAA~            	DB #09EC-#095C
1555+++8EAA~            	DB #0A82-#09EC
1556+++8EAA~            	DB #0B22-#0A82
1557+++8EAA~            	DB #0BCC-#0B22
1558+++8EAA~            	DB #0C80-#0BCC
1559+++8EAA~            	DB #0D3E-#0C80
1560+++8EAA~            	DB #07E0*2/256,#07E0*2&255
1561+++8EAA~            	DB #0858-#07E0
1562+++8EAA~            	DB #08E0-#0858
1563+++8EAA~            	DB #0960-#08E0
1564+++8EAA~            	DB #09F0-#0960
1565+++8EAA~            	DB #0A88-#09F0
1566+++8EAA~            	DB #0B28-#0A88
1567+++8EAA~            	DB #0BD8-#0B28
1568+++8EAA~            	DB #0C80-#0BD8
1569+++8EAA~            	DB #0D60-#0C80
1570+++8EAA~            	DB #0E10-#0D60
1571+++8EAA~            	DB #0EF8-#0E10
1572+++8EAA~            1573+++8EAA~            ;vars from here can be stripped
1574+++8EAA~            ;you can move VARS to any other address
1575+++8EAA~            1576+++8EAA~            VARS
1577+++8EAA~            1578+++8EAA~            is_ts	DB 0
1579+++8EAA~            1580+++8EAA~            ;ChannelsVars
1581+++8EAA~            	STRUCT	CHP
1582+++8EAA~            ;reset group
1583+++8EAA~            PsInOr	DB 0
1584+++8EAA~            PsInSm	DB 0
1585+++8EAA~            CrAmSl	DB 0
1586+++8EAA~            CrNsSl	DB 0
1587+++8EAA~            CrEnSl	DB 0
1588+++8EAA~            TSlCnt	DB 0
1589+++8EAA~            CrTnSl	DW 0
1590+++8EAA~            TnAcc	DW 0
1591+++8EAA~            COnOff	DB 0
1592+++8EAA~            ;reset group
1593+++8EAA~            1594+++8EAA~            OnOffD	DB 0
1595+++8EAA~            1596+++8EAA~            ;IX for PTDECOD here (+12)
1597+++8EAA~            OffOnD	DB 0
1598+++8EAA~            OrnPtr	DW 0
1599+++8EAA~            SamPtr	DW 0
1600+++8EAA~            NNtSkp	DB 0
1601+++8EAA~            Note	DB 0
1602+++8EAA~            SlToNt	DB 0
1603+++8EAA~            Env_En	DB 0
1604+++8EAA~            Flags	DB 0
1605+++8EAA~             ;Enabled - 0, SimpleGliss - 2
1606+++8EAA~            TnSlDl	DB 0
1607+++8EAA~            TSlStp	DW 0
1608+++8EAA~            TnDelt	DW 0
1609+++8EAA~            NtSkCn	DB 0
1610+++8EAA~            Volume	DB 0
1611+++8EAA~            	ENDS
1612+++8EAA~            1613+++8EAA~            	STRUCT	VRS
1614+++8EAA~            1615+++8EAA~            ;IF not works in STRUCT in SjASM :(
1616+++8EAA~            ;	IF CurPosCounter
1617+++8EAA~            CurPos	DB 0
1618+++8EAA~            PosSub	DB 0
1619+++8EAA~            ;	ENDIF
1620+++8EAA~            1621+++8EAA~            ModNum	DB 0 ;bit0: ChipNum
1622+++8EAA~            	     ;bit1: 1-reversed patterns order (AlCo TS)
1623+++8EAA~            1624+++8EAA~            ChanA	DS CHP
1625+++8EAA~            ChanB	DS CHP
1626+++8EAA~            ChanC	DS CHP
1627+++8EAA~            1628+++8EAA~            ;GlobalVars
1629+++8EAA~            MODADDR	DW 0
1630+++8EAA~            OrnPtrs	DW 0
1631+++8EAA~            SamPtrs	DW 0
1632+++8EAA~            PatsPtr	DW 0
1633+++8EAA~            AdInPtA	DW 0
1634+++8EAA~            AdInPtB	DW 0
1635+++8EAA~            AdInPtC	DW 0
1636+++8EAA~            CrPsPtr	DW 0
1637+++8EAA~            LPosPtr	DW 0
1638+++8EAA~            Delay	DB 0
1639+++8EAA~            DelyCnt	DB 0
1640+++8EAA~            ESldAdd	DW 0
1641+++8EAA~            CurESld	DW 0
1642+++8EAA~            Env_Del	DB 0
1643+++8EAA~            CurEDel	DB 0
1644+++8EAA~            Ns_Base	DB 0
1645+++8EAA~            AddToNs	DB 0
1646+++8EAA~            AddToEn	DB 0
1647+++8EAA~            EnvBase	DW 0
1648+++8EAA~            AYREGS	DS 14
1649+++8EAA~            	ENDS
1650+++8EAA~            1651+++8EAA~            VARS1	DS VRS
1652+++8EAA~            VARS2	DS VRS
1653+++8EAA~            1654+++8EAA~            VT_	EQU $-16
1655+++8EAA~            	DS 256-16 ;CreatedVolumeTableAddress
1656+++8EAA~            1657+++8EAA~            T1_	EQU VT_+16 ;Tone tables data depacked here
1658+++8EAA~            1659+++8EAA~            T_OLD_1	EQU T1_
1660+++8EAA~            T_OLD_2	EQU T_OLD_1+24
1661+++8EAA~            T_OLD_3	EQU T_OLD_2+24
1662+++8EAA~            T_OLD_0	EQU T_OLD_3+2
1663+++8EAA~            T_NEW_0	EQU T_OLD_0
1664+++8EAA~            T_NEW_1	EQU T_OLD_1
1665+++8EAA~            T_NEW_2	EQU T_NEW_0+24
1666+++8EAA~            T_NEW_3	EQU T_OLD_3
1667+++8EAA~            1668+++8EAA~            PT2EMPTYORN EQU VT_+31 ;1,0,0 sequence
1669+++8EAA~            1670+++8EAA~            NT_	DS 192 ;CreatedNoteTableAddress
1671+++8EAA~            1672+++8EAA~            VAR0END	EQU VT_+16 ;INIT zeroes from VARS to VAR0END-1
1673+++8EAA~            1674+++8EAA~            VARSEND EQU $
1675+++8EAA~            MDLADDR EQU $
1676+++8EAA~            1677+++8EAA~                   DISPLAY "PTS player size=",$-START
1678+++8EAA~            1679+++8EAA~            ;Release 0 steps:
1680+++8EAA~            ;04/21/2007
1681+++8EAA~            ;Works start (PTxPlay adaptation); first beta.
1682+++8EAA~            ;04/22/2007
1683+++8EAA~            ;Job finished; beta-testing.
1684+++8EAA~            ;04/23/2007
1685+++8EAA~            ;PT v3.7 TS mode corrected (after AlCo remarks).
1686+++8EAA~            ;04/29/2007
1687+++8EAA~            ;Added 1.XX and 2.XX special commands interpretation for PT3
1688+++8EAA~            ;modules of v3.7+.
1689+++8EAA~            1690+++8EAA~            ;Size (minimal build for ZX Spectrum):
1691+++8EAA~            ;Code block #908 bytes
1692+++8EAA~            ;Variables #2BF bytes (can be stripped)
1693+++8EAA~            ;Total size #908+#2BF=#BC7 (3015) bytes
1694+++8EAA~            1695+++8EAA~                   ENDMOD
1696+++8EAA~            1697+++8EAA                    endif
1698+++8EAA             
0077++ 8EAA             
0078++ 8EAA             PT2.Play=PTS.PLAY
0079++ 8EAA             PT2.Mute=PTS.MUTE        
0080++ 8EAA             PT2.End
0081++ 8EAA             
0082++ 8EAA                     display "PT2 module size: ",PT2.End-PT2.Start
0083++ 8EAA                     endif
0084++ 8EAA                    
0415+  8EAA                     include "ts.asm"
0001++ 8EAA                   ifndef _ts_asm_defined
0002++ 8EAA                   define _ts_asm_defined
0003++ 8EAA                   
0004++ 8EAA                   module TS
0005++ 8EAA                   
0006++ 8EAA                   struct Footer
0007++ 8EAA~            Sign1 DS 4
0008++ 8EAA~            Size1 DW 0
0009++ 8EAA~            Sign2 DS 4
0010++ 8EAA~            Size2 DW 0
0011++ 8EAA~            Sign3 DS 4      
0012++ 8EAA                   ENDS
0013++ 8EAA             
0014++ 8EAA             Start      
0015++ 8EAA                     ifndef NoPrologue
0016++ 8EAA~                    ld hl,End
0017++ 8EAA~                    jr .init
0018++ 8EAA~                    jp PTS.PLAY
0019++ 8EAA~                    jp PTS.MUTE
0020++ 8EAA~            .init   call CheckFormat
0021++ 8EAA~                    ;ignore invalids
0022++ 8EAA                     endif
0023++ 8EAA             
0024++ 8EAA 3E 10       Init    ld a,PTS.SETUP.TS02
0025++ 8EAC C3 63 82            jp PTS.INIT
0026++ 8EAF             
0027++ 8EAF             ;in HL - module addr
0028++ 8EAF             ;out Z - is ts
0029++ 8EAF             ;out HL/DE modules offsets (valid only if Z)
0030++ 8EAF             CheckFormat
0031++ 8EB0 54 5D               ld d,h,e,l
0032++ 8EB1 14                  inc d ;skip 256 bytes
0033++ 8EB2             .findfooter
0034++ 8EB3 62 6B               ld h,d,l,e
0035++ 8EB4 CD C1 8E            call CheckFooter
0036++ 8EB7 C8                  ret z
0037++ 8EB8 1C                  inc e
0038++ 8EB9 20 F7               jr nz,.findfooter
0039++ 8EBB 14                  inc d
0040++ 8EBC 20 F4               jr nz,.findfooter
0041++ 8EBE 1C                  inc e ;reset Z
0042++ 8EBF                     ;hl/de are invalid!!!
0043++ 8EBF C9                  ret
0044++ 8EC0             
0045++ 8EC0             ;in HL - module addr
0046++ 8EC0             ;in BC - module size
0047++ 8EC0             ;out Z - is ts
0048++ 8EC0             ;out HL/DE - modules offsets (valid only if Z)
0049++ 8EC0                     ifdef HaveFormatCheck
0050++ 8EC0             CheckFormatKnownSize
0051++ 8EC0 09                  add hl,bc
0052++ 8EC1                     endif
0053++ 8EC1             CheckFooter
0054++ 8EC1 2B                  dec hl
0055++ 8EC2 7E                  ld a,(hl)
0056++ 8EC3 FE 53               cp "S"
0057++ 8EC5 C0                  ret nz
0058++ 8EC6 2B                  dec hl
0059++ 8EC7 7E                  ld a,(hl)
0060++ 8EC8 FE 54               cp "T"
0061++ 8ECA C0                  ret nz
0062++ 8ECB 2B                  dec hl
0063++ 8ECC 7E                  ld a,(hl)
0064++ 8ECD FE 32               cp "2"
0065++ 8ECF C0                  ret nz
0066++ 8ED0 2B                  dec hl
0067++ 8ED1 7E                  ld a,(hl)
0068++ 8ED2 FE 30               cp "0"
0069++ 8ED4 C0                  ret nz
0070++ 8ED5 2B                  dec hl
0071++ 8ED6 56                  ld d,(hl)
0072++ 8ED7 2B                  dec hl
0073++ 8ED8 5E                  ld e,(hl) ;Size2
0074++ 8EDC 2B 2B 2B 2B         dec hl,hl,hl,hl;skip Sign2
0075++ 8EDD 2B                  dec hl
0076++ 8EDE 46                  ld b,(hl)
0077++ 8EDF 2B                  dec hl
0078++ 8EE0 4E                  ld c,(hl) ;Size1
0079++ 8EE4 2B 2B 2B 2B         dec hl,hl,hl,hl;skip Sign1
0080++ 8EE5             
0081++ 8EE5 ED 52               sbc hl,de
0082++ 8EE7 54                  ld d,h
0083++ 8EE8 5D                  ld e,l
0084++ 8EE9 ED 42               sbc hl,bc
0085++ 8EEB AF                  xor a
0086++ 8EEC C9                  ret
0087++ 8EED             
0088++ 8EED                     ifdef HaveFormatCheck
0089++ 8EED                     display "TS checker size: ",$-CheckFormat
0090++ 8EED                     endif
0091++ 8EED             
0092++ 8EED                     endmod
0093++ 8EED             
0094++ 8EED                     include "PTSPlay.asm"
0001+++8EED                     ifndef _pts_asm_defined
0002+++8EED~                    define _pts_asm_defined
0003+++8EED~            0004+++8EED~                    MODULE PTS
0005+++8EED~                    
0006+++8EED~            ;Universal PT2'n'PT3 Turbo Sound player for ZX Spectrum
0007+++8EED~            ;(c)2004-2007 S.V.Bulba <vorobey@mail.khstu.ru>
0008+++8EED~            ;Specially for AlCo
0009+++8EED~            ;http://bulba.untergrund.net/ (http://bulba.at.kz/)
0010+++8EED~            0011+++8EED~            ;Release number
0012+++8EED~            Release EQU "0"
0013+++8EED~            0014+++8EED~            ;Conditional assembly
0015+++8EED~            ;1) Current position counters at (Vars1+0) and (Vars2+0)
0016+++8EED~            CurPosCounter=0
0017+++8EED~            ;2) Allow channels allocation bits at (SETUP)
0018+++8EED~            ACBBAC=0
0019+++8EED~            ;3) Allow loop checking and disabling
0020+++8EED~            LoopChecker=0
0021+++8EED~            ;4) Insert official identificator
0022+++8EED~            Id=0
0023+++8EED~            ;5) Set IY for correct return to ZX Basic
0024+++8EED~            Basic=0
0025+++8EED~            0026+++8EED~            ;Features
0027+++8EED~            ;--------
0028+++8EED~            ;-Can be compiled at any address (i.e. no need rounding ORG
0029+++8EED~            ; address).
0030+++8EED~            ;-Variables (VARS) can be located at any address (not only after
0031+++8EED~            ; code block).
0032+++8EED~            ;-INIT subprogram checks PT3-module version and rightly
0033+++8EED~            ; generates both note and volume tables outside of code block
0034+++8EED~            ; (in VARS).
0035+++8EED~            ;-Two portamento (spc. command 3xxx) algorithms (depending of
0036+++8EED~            ; PT3 module version).
0037+++8EED~            ;-New 1.XX and 2.XX special command behaviour (only for PT v3.7
0038+++8EED~            ; and higher).
0039+++8EED~            ;-Any Tempo value are accepted (including Tempo=1 and Tempo=2).
0040+++8EED~            ;-TS modes: 2xPT3, 2xPT2 and PT v3.7 TS standard.
0041+++8EED~            ;-Fully compatible with Ay_Emul PT3 and PT2 players codes.
0042+++8EED~            ;-See also notes at the end of this source code.
0043+++8EED~            0044+++8EED~            ;Limitations
0045+++8EED~            ;-----------
0046+++8EED~            ;-Can run in RAM only (self-modified code is used).
0047+++8EED~            ;-PT2 position list must be end by #FF marker only.
0048+++8EED~            0049+++8EED~            ;Warning!!! PLAY subprogram can crash if no module are loaded
0050+++8EED~            ;into RAM or INIT subprogram was not called before.
0051+++8EED~            0052+++8EED~            ;Call MUTE or INIT one more time to mute sound after stopping
0053+++8EED~            ;playing 
0054+++8EED~            0055+++8EED~            TonA	EQU 0
0056+++8EED~            TonB	EQU 2
0057+++8EED~            TonC	EQU 4
0058+++8EED~            Noise	EQU 6
0059+++8EED~            Mixer	EQU 7
0060+++8EED~            AmplA	EQU 8
0061+++8EED~            AmplB	EQU 9
0062+++8EED~            AmplC	EQU 10
0063+++8EED~            Env	EQU 11
0064+++8EED~            EnvTp	EQU 13
0065+++8EED~            0066+++8EED~            START
0067+++8EED~            0068+++8EED~            SETUP.NOLOOP EQU 1
0069+++8EED~            SETUP.PT2 EQU 2
0070+++8EED~            SETUP.ACB EQU 4
0071+++8EED~            SETUP.BAC EQU 8
0072+++8EED~            SETUP.TS02 EQU 16
0073+++8EED~            SETUP.TSPT3 EQU 32
0074+++8EED~            0075+++8EED~            SETUP	DB 0 ;set bit0, if you want to play without looping
0076+++8EED~            	     ;(optional);
0077+++8EED~            	     ;set bit1 for PT2 and reset for PT3 before
0078+++8EED~            	     ;calling INIT;
0079+++8EED~            	     ;bits2-3: %00-ABC, %01-ACB, %10-BAC (optional);
0080+++8EED~            	     ;bits4-5: %00-no TS, %01-2 modules TS, %10-
0081+++8EED~            	     ;autodetect PT3 TS-format by AlCo (PT 3.7+);
0082+++8EED~            	     ;Remark: old PT3 TS-format by AlCo (PT 3.6) is not
0083+++8EED~            	     ;documented and must be converted to new standard.
0084+++8EED~            	     ;bit6 is set each time, when loop point of 2nd TS
0085+++8EED~            	     ;module is passed (optional).
0086+++8EED~            	     ;bit7 is set each time, when loop point of 1st TS
0087+++8EED~            	     ;or of single module is passed (optional).
0088+++8EED~            0089+++8EED~            ;Identifier
0090+++8EED~            	IF Id
0091+++8EED~            	DB "=UniPT2/PT3/TS-Player r.",Release,"="
0092+++8EED~            	ENDIF
0093+++8EED~            0094+++8EED~            	IF LoopChecker
0095+++8EED~            CHECKLP	LD HL,SETUP
0096+++8EED~            	BIT 0,(IY-100+VRS.ModNum)
0097+++8EED~            	JR Z,CHL1
0098+++8EED~            	SET 6,(HL)
0099+++8EED~            	JR CHL2
0100+++8EED~            CHL1	SET 7,(HL)
0101+++8EED~            CHL2	BIT 0,(HL)
0102+++8EED~            	RET Z
0103+++8EED~            	POP HL
0104+++8EED~            	INC (IY-100+VRS.DelyCnt)
0105+++8EED~            	INC (IY-100+VRS.ChanA+CHP.NtSkCn)
0106+++8EED~            	XOR A
0107+++8EED~            	LD (IY-100+VRS.AYREGS+AmplA),A
0108+++8EED~            	LD (IY-100+VRS.AYREGS+AmplB),A
0109+++8EED~            	LD (IY-100+VRS.AYREGS+AmplC),A
0110+++8EED~            	RET
0111+++8EED~            	ENDIF
0112+++8EED~            0113+++8EED~            MUTE	XOR A
0114+++8EED~            	LD H,A
0115+++8EED~            	LD L,A
0116+++8EED~            	LD (VARS1+VRS.AYREGS+AmplA),A
0117+++8EED~            	LD (VARS1+VRS.AYREGS+AmplB),HL
0118+++8EED~            	LD (VARS2+VRS.AYREGS+AmplA),A
0119+++8EED~            	LD (VARS2+VRS.AYREGS+AmplB),HL
0120+++8EED~            	JP ROUT
0121+++8EED~            0122+++8EED~            INIT
0123+++8EED~            ;HL - AddressOfModule
0124+++8EED~            ;DE - AddresOf2ndModule
0125+++8EED~            ;A - mode
0126+++8EED~            	PUSH DE
0127+++8EED~            	PUSH HL
0128+++8EED~            	LD HL,VARS
0129+++8EED~            	LD (HL),0
0130+++8EED~            	LD DE,VARS+1
0131+++8EED~            	LD BC,VAR0END-VARS-1
0132+++8EED~            	LDIR
0133+++8EED~            	INC HL
0134+++8EED~            	LD (VARS1+VRS.AdInPtA),HL ;ptr to zero
0135+++8EED~            	LD (VARS2+VRS.AdInPtA),HL
0136+++8EED~            0137+++8EED~            	POP HL
0138+++8EED~            	LD IY,VARS1+100
0139+++8EED~                LD (SETUP),A
0140+++8EED~            	AND SETUP.PT2
0141+++8EED~            	JP NZ,I_PT2
0142+++8EED~            0143+++8EED~            	CALL INITPT3
0144+++8EED~            	LD HL,(e_-SamCnv-2)*256+#18
0145+++8EED~            	LD (SamCnv),HL
0146+++8EED~            	LD A,#BA
0147+++8EED~            	LD (OrnCP),A
0148+++8EED~            	LD (SamCP),A
0149+++8EED~            	LD A,#7B
0150+++8EED~            	LD (OrnLD),A
0151+++8EED~            	LD (SamLD),A
0152+++8EED~            	LD A,#87
0153+++8EED~            	LD (SamClc2),A
0154+++8EED~            	POP HL
0155+++8EED~            	;Use version and ton table of 1st module
0156+++8EED~            	LD A,(IX+13-100) ;EXTRACT VERSION NUMBER
0157+++8EED~            	SUB #30
0158+++8EED~            	JR C,L20
0159+++8EED~            	CP 10
0160+++8EED~            	JR C,L21
0161+++8EED~            L20	LD A,6
0162+++8EED~            L21	LD (Version),A
0163+++8EED~            	PUSH AF ;VolTable version
0164+++8EED~            	CP 4
0165+++8EED~            	LD A,(IX+99-100) ;TONE TABLE NUMBER
0166+++8EED~            	RLA
0167+++8EED~            	AND 7
0168+++8EED~            	PUSH AF ;NoteTable number
0169+++8EED~            0170+++8EED~            	LD IY,VARS2+100
0171+++8EED~            	LD A,(SETUP)
0172+++8EED~            	AND SETUP.TS02|SETUP.TSPT3
0173+++8EED~            	JR Z,NOTS
0174+++8EED~            	CP SETUP.TS02
0175+++8EED~            	JR Z,TwoPT3s
0176+++8EED~            	LD A,(Version)
0177+++8EED~            	CP 7
0178+++8EED~            	JR C,NOTS
0179+++8EED~            	LD A,(IX+98-100) ;ALCO TS MARKER
0180+++8EED~            	CP #20
0181+++8EED~            	JR Z,NOTS
0182+++8EED~            	LD HL,VARS1
0183+++8EED~            	LD DE,VARS2
0184+++8EED~            	LD BC,VRS
0185+++8EED~            	LDIR
0186+++8EED~            	SET 1,(IY-100+VRS.ModNum)
0187+++8EED~            	LD C,A
0188+++8EED~            	ADD A,A
0189+++8EED~            	ADD A,C
0190+++8EED~            	SUB 2
0191+++8EED~            	LD (TSSub),A
0192+++8EED~            	JR AlCoTS_
0193+++8EED~            TwoPT3s	CALL INITPT3
0194+++8EED~            AlCoTS_	LD A,1
0195+++8EED~            	LD (is_ts),A
0196+++8EED~            	SET 0,(IY-100+VRS.ModNum)
0197+++8EED~            0198+++8EED~            NOTS	LD BC,PT3PD
0199+++8EED~            	LD HL,0
0200+++8EED~            	LD DE,PT3EMPTYORN
0201+++8EED~            	JR INITCOMMON
0202+++8EED~            0203+++8EED~            I_PT2	CALL INITPT2
0204+++8EED~            	LD HL,#51CB
0205+++8EED~            	LD (SamCnv),HL
0206+++8EED~            	LD A,#BB
0207+++8EED~            	LD (OrnCP),A
0208+++8EED~            	LD (SamCP),A
0209+++8EED~            	LD A,#7A
0210+++8EED~            	LD (OrnLD),A
0211+++8EED~            	LD (SamLD),A
0212+++8EED~            	LD A,#80
0213+++8EED~            	LD (SamClc2),A
0214+++8EED~            	POP HL
0215+++8EED~            	LD A,5
0216+++8EED~            	LD (Version),A
0217+++8EED~            	PUSH AF
0218+++8EED~            	LD A,2
0219+++8EED~            	PUSH AF
0220+++8EED~            0221+++8EED~            	LD A,(SETUP)
0222+++8EED~                AND SETUP.TS02|SETUP.TSPT3
0223+++8EED~            	JR Z,NOTS2
0224+++8EED~            0225+++8EED~            	LD IY,VARS2+100
0226+++8EED~            	LD A,1
0227+++8EED~            	LD (is_ts),A
0228+++8EED~            	SET 0,(IY-100+VRS.ModNum)
0229+++8EED~            	CALL INITPT2
0230+++8EED~            0231+++8EED~            NOTS2	LD BC,PT2PD
0232+++8EED~            	LD HL,#8687
0233+++8EED~            	LD DE,PT2EMPTYORN
0234+++8EED~            0235+++8EED~            INITCOMMON
0236+++8EED~            0237+++8EED~            	IF Basic
0238+++8EED~            	LD IY,#5C3A
0239+++8EED~            	ENDIF
0240+++8EED~            0241+++8EED~            	LD (PTDEC),BC
0242+++8EED~            	LD (PsCalc),HL
0243+++8EED~            	PUSH DE
0244+++8EED~            0245+++8EED~            ;note table data depacker
0246+++8EED~            ;(c) Ivan Roshin
0247+++8EED~            	LD DE,T_PACK
0248+++8EED~            	LD BC,T1_+(2*49)-1
0249+++8EED~            TP_0	LD A,(DE)
0250+++8EED~            	INC DE
0251+++8EED~            	CP 15*2
0252+++8EED~            	JR NC,TP_1
0253+++8EED~            	LD H,A
0254+++8EED~            	LD A,(DE)
0255+++8EED~            	LD L,A
0256+++8EED~            	INC DE
0257+++8EED~            	JR TP_2
0258+++8EED~            TP_1	PUSH DE
0259+++8EED~            	LD D,0
0260+++8EED~            	LD E,A
0261+++8EED~            	ADD HL,DE
0262+++8EED~            	ADD HL,DE
0263+++8EED~            	POP DE
0264+++8EED~            TP_2	LD A,H
0265+++8EED~            	LD (BC),A
0266+++8EED~            	DEC BC
0267+++8EED~            	LD A,L
0268+++8EED~            	LD (BC),A
0269+++8EED~            	DEC BC
0270+++8EED~            	SUB (#F8*2)&255
0271+++8EED~            	JR NZ,TP_0
0272+++8EED~            0273+++8EED~            	INC A
0274+++8EED~            	LD (VARS1+VRS.DelyCnt),A
0275+++8EED~            	LD (VARS2+VRS.DelyCnt),A
0276+++8EED~            	LD HL,#F001 ;H - CHP.Volume, L - CHP.NtSkCn
0277+++8EED~            	LD (VARS1+VRS.ChanA+CHP.NtSkCn),HL
0278+++8EED~            	LD (VARS1+VRS.ChanB+CHP.NtSkCn),HL
0279+++8EED~            	LD (VARS1+VRS.ChanC+CHP.NtSkCn),HL
0280+++8EED~            	LD (VARS2+VRS.ChanA+CHP.NtSkCn),HL
0281+++8EED~            	LD (VARS2+VRS.ChanB+CHP.NtSkCn),HL
0282+++8EED~            	LD (VARS2+VRS.ChanC+CHP.NtSkCn),HL
0283+++8EED~            	POP HL
0284+++8EED~            	LD (VARS1+VRS.ChanA+CHP.OrnPtr),HL
0285+++8EED~            	LD (VARS1+VRS.ChanB+CHP.OrnPtr),HL
0286+++8EED~            	LD (VARS1+VRS.ChanC+CHP.OrnPtr),HL
0287+++8EED~            	LD (VARS2+VRS.ChanA+CHP.OrnPtr),HL
0288+++8EED~            	LD (VARS2+VRS.ChanB+CHP.OrnPtr),HL
0289+++8EED~            	LD (VARS2+VRS.ChanC+CHP.OrnPtr),HL
0290+++8EED~            0291+++8EED~            	POP AF
0292+++8EED~            0293+++8EED~            ;NoteTableCreator (c) Ivan Roshin
0294+++8EED~            ;A - NoteTableNumber*2+VersionForNoteTable
0295+++8EED~            ;(xx1b - 3.xx..3.4r, xx0b - 3.4x..3.6x..VTII1.0)
0296+++8EED~            0297+++8EED~            	LD HL,NT_DATA
0298+++8EED~            	LD D,0
0299+++8EED~            	ADD A,A
0300+++8EED~            	LD E,A
0301+++8EED~            	ADD HL,DE
0302+++8EED~            	LD E,(HL)
0303+++8EED~            	INC HL
0304+++8EED~            	SRL E
0305+++8EED~            	SBC A,A
0306+++8EED~            	AND #A7 ;#00 (NOP) or #A7 (AND A)
0307+++8EED~            	LD (L3),A
0308+++8EED~            	EX DE,HL
0309+++8EED~            	LD BC,T1_
0310+++8EED~            	ADD HL,BC
0311+++8EED~            0312+++8EED~            	LD A,(DE)
0313+++8EED~            	ADD A,T_&255
0314+++8EED~            	LD C,A
0315+++8EED~            	ADC A,T_/256
0316+++8EED~            	SUB C
0317+++8EED~            	LD B,A
0318+++8EED~            	PUSH BC
0319+++8EED~            	LD DE,NT_
0320+++8EED~            	PUSH DE
0321+++8EED~            0322+++8EED~            	LD B,12
0323+++8EED~            L1	PUSH BC
0324+++8EED~            	LD C,(HL)
0325+++8EED~            	INC HL
0326+++8EED~            	PUSH HL
0327+++8EED~            	LD B,(HL)
0328+++8EED~            0329+++8EED~            	PUSH DE
0330+++8EED~            	EX DE,HL
0331+++8EED~            	LD DE,23
0332+++8EED~            	LD IXH,8
0333+++8EED~            0334+++8EED~            L2	SRL B
0335+++8EED~            	RR C
0336+++8EED~            L3	DB #19	;AND A or NOP
0337+++8EED~            	LD A,C
0338+++8EED~            	ADC A,D	;=ADC 0
0339+++8EED~            	LD (HL),A
0340+++8EED~            	INC HL
0341+++8EED~            	LD A,B
0342+++8EED~            	ADC A,D
0343+++8EED~            	LD (HL),A
0344+++8EED~            	ADD HL,DE
0345+++8EED~            	DEC IXH
0346+++8EED~            	JR NZ,L2
0347+++8EED~            0348+++8EED~            	POP DE
0349+++8EED~            	INC DE
0350+++8EED~            	INC DE
0351+++8EED~            	POP HL
0352+++8EED~            	INC HL
0353+++8EED~            	POP BC
0354+++8EED~            	DJNZ L1
0355+++8EED~            0356+++8EED~            	POP HL
0357+++8EED~            	POP DE
0358+++8EED~            0359+++8EED~            	LD A,E
0360+++8EED~            	CP TCOLD_1&255
0361+++8EED~            	JR NZ,CORR_1
0362+++8EED~            	LD A,#FD
0363+++8EED~            	LD (NT_+#2E),A
0364+++8EED~            0365+++8EED~            CORR_1	LD A,(DE)
0366+++8EED~            	AND A
0367+++8EED~            	JR Z,TC_EXIT
0368+++8EED~            	RRA
0369+++8EED~            	PUSH AF
0370+++8EED~            	ADD A,A
0371+++8EED~            	LD C,A
0372+++8EED~            	ADD HL,BC
0373+++8EED~            	POP AF
0374+++8EED~            	JR NC,CORR_2
0375+++8EED~            	DEC (HL)
0376+++8EED~            	DEC (HL)
0377+++8EED~            CORR_2	INC (HL)
0378+++8EED~            	AND A
0379+++8EED~            	SBC HL,BC
0380+++8EED~            	INC DE
0381+++8EED~            	JR CORR_1
0382+++8EED~            0383+++8EED~            TC_EXIT
0384+++8EED~            0385+++8EED~            	POP AF
0386+++8EED~            0387+++8EED~            ;VolTableCreator (c) Ivan Roshin
0388+++8EED~            ;A - VersionForVolumeTable (0..4 - 3.xx..3.4x;
0389+++8EED~            			   ;5.. - 2.x,3.5x..3.6x..VTII1.0)
0390+++8EED~            0391+++8EED~            	CP 5
0392+++8EED~            	LD HL,#11
0393+++8EED~            	LD D,H
0394+++8EED~            	LD E,H
0395+++8EED~            	LD A,#17
0396+++8EED~            	JR NC,M1
0397+++8EED~            	DEC L
0398+++8EED~            	LD E,L
0399+++8EED~            	XOR A
0400+++8EED~            M1      LD (M2),A
0401+++8EED~            0402+++8EED~            	LD IX,VT_+16
0403+++8EED~            0404+++8EED~            	LD C,#F
0405+++8EED~            INITV2  PUSH HL
0406+++8EED~            0407+++8EED~            	ADD HL,DE
0408+++8EED~            	EX DE,HL
0409+++8EED~            	SBC HL,HL
0410+++8EED~            0411+++8EED~            	LD B,#10
0412+++8EED~            INITV1  LD A,L
0413+++8EED~            M2      DB #7D
0414+++8EED~            	LD A,H
0415+++8EED~            	ADC A,0
0416+++8EED~            	LD (IX),A
0417+++8EED~            	INC IX
0418+++8EED~            	ADD HL,DE
0419+++8EED~            	DJNZ INITV1
0420+++8EED~            0421+++8EED~            	POP HL
0422+++8EED~            	LD A,E
0423+++8EED~            	CP #77
0424+++8EED~            	JR NZ,M3
0425+++8EED~            	INC E
0426+++8EED~            M3      DEC C
0427+++8EED~            	JR NZ,INITV2
0428+++8EED~            0429+++8EED~            	JP ROUT
0430+++8EED~            0431+++8EED~            INITPT3	CALL SETMDAD
0432+++8EED~            	PUSH HL
0433+++8EED~            	LD DE,100
0434+++8EED~            	ADD HL,DE
0435+++8EED~            	LD A,(HL)
0436+++8EED~            	LD (IY-100+VRS.Delay),A
0437+++8EED~            	PUSH HL
0438+++8EED~            	POP IX
0439+++8EED~            	ADD HL,DE
0440+++8EED~            	CALL SETCPPT
0441+++8EED~            	LD E,(IX+102-100)
0442+++8EED~            	INC HL
0443+++8EED~            0444+++8EED~            	IF CurPosCounter
0445+++8EED~            	LD (IY-100+VRS.PosSub),L
0446+++8EED~            	ENDIF
0447+++8EED~            0448+++8EED~            	ADD HL,DE
0449+++8EED~            	CALL SETLPPT
0450+++8EED~            	POP DE
0451+++8EED~            	LD L,(IX+103-100)
0452+++8EED~            	LD H,(IX+104-100)
0453+++8EED~            	ADD HL,DE
0454+++8EED~            	CALL SETPTPT
0455+++8EED~            	LD HL,169
0456+++8EED~            	ADD HL,DE
0457+++8EED~            	CALL SETORPT
0458+++8EED~            	LD HL,105
0459+++8EED~            	ADD HL,DE
0460+++8EED~            0461+++8EED~            SETSMPT LD (IY-100+VRS.SamPtrs),L
0462+++8EED~            	LD (IY-100+VRS.SamPtrs+1),H
0463+++8EED~            	RET
0464+++8EED~            0465+++8EED~            INITPT2	LD A,(HL)
0466+++8EED~            	LD (IY-100+VRS.Delay),A
0467+++8EED~            	PUSH HL
0468+++8EED~            	PUSH HL
0469+++8EED~            	PUSH HL
0470+++8EED~            	INC HL
0471+++8EED~            	INC HL
0472+++8EED~            	LD A,(HL)
0473+++8EED~            	INC HL
0474+++8EED~            	CALL SETSMPT
0475+++8EED~            	LD E,(HL)
0476+++8EED~            	INC HL
0477+++8EED~            	LD D,(HL)
0478+++8EED~            	POP HL
0479+++8EED~            	AND A
0480+++8EED~            	SBC HL,DE
0481+++8EED~            	CALL SETMDAD
0482+++8EED~            	POP HL
0483+++8EED~            	LD DE,67
0484+++8EED~            	ADD HL,DE
0485+++8EED~            	CALL SETORPT
0486+++8EED~            	LD E,32
0487+++8EED~            	ADD HL,DE
0488+++8EED~            	LD C,(HL)
0489+++8EED~            	INC HL
0490+++8EED~            	LD B,(HL)
0491+++8EED~            	LD E,30
0492+++8EED~            	ADD HL,DE
0493+++8EED~            	CALL SETCPPT
0494+++8EED~            	LD E,A
0495+++8EED~            	INC HL
0496+++8EED~            0497+++8EED~            	IF CurPosCounter
0498+++8EED~            	LD (IY-100+VRS.PosSub),L
0499+++8EED~            	ENDIF
0500+++8EED~            0501+++8EED~            	ADD HL,DE
0502+++8EED~            	CALL SETLPPT
0503+++8EED~            	POP HL
0504+++8EED~            	ADD HL,BC
0505+++8EED~            0506+++8EED~            SETPTPT	LD (IY-100+VRS.PatsPtr),L
0507+++8EED~            	LD (IY-100+VRS.PatsPtr+1),H
0508+++8EED~            	RET
0509+++8EED~            0510+++8EED~            SETMDAD	LD (IY-100+VRS.MODADDR),L
0511+++8EED~            	LD (IY-100+VRS.MODADDR+1),H
0512+++8EED~            	RET
0513+++8EED~            0514+++8EED~            SETORPT	LD (IY-100+VRS.OrnPtrs),L
0515+++8EED~            	LD (IY-100+VRS.OrnPtrs+1),H
0516+++8EED~            	RET
0517+++8EED~            0518+++8EED~            SETCPPT	LD (IY-100+VRS.CrPsPtr),L
0519+++8EED~            	LD (IY-100+VRS.CrPsPtr+1),H
0520+++8EED~            	RET
0521+++8EED~            0522+++8EED~            SETLPPT	LD (IY-100+VRS.LPosPtr),L
0523+++8EED~            	LD (IY-100+VRS.LPosPtr+1),H
0524+++8EED~            	RET
0525+++8EED~            0526+++8EED~            SETENBS	LD (IY-100+VRS.EnvBase),L
0527+++8EED~            	LD (IY-100+VRS.EnvBase+1),H
0528+++8EED~            	RET
0529+++8EED~            0530+++8EED~            SETESLD	LD (IY-100+VRS.CurESld),L
0531+++8EED~            	LD (IY-100+VRS.CurESld+1),H
0532+++8EED~            	RET
0533+++8EED~            0534+++8EED~            GETIX	PUSH IY
0535+++8EED~            	POP IX
0536+++8EED~            	ADD IX,DE
0537+++8EED~            	RET
0538+++8EED~            0539+++8EED~            PTDECOD CALL GETIX
0540+++8EED~            PTDEC	EQU $+1
0541+++8EED~            	JP #C3C3
0542+++8EED~            0543+++8EED~            ;PT2 pattern decoder
0544+++8EED~            PD2_SAM	CALL SETSAM
0545+++8EED~            	JR PD2_LOOP
0546+++8EED~            0547+++8EED~            PD2_EOff LD (IX-12+CHP.Env_En),A
0548+++8EED~            	JR PD2_LOOP
0549+++8EED~            0550+++8EED~            PD2_ENV	LD (IX-12+CHP.Env_En),16
0551+++8EED~            	LD (IY-100+VRS.AYREGS+EnvTp),A
0552+++8EED~            	LD A,(BC)
0553+++8EED~            	INC BC
0554+++8EED~            	LD L,A
0555+++8EED~            	LD A,(BC)
0556+++8EED~            	INC BC
0557+++8EED~            	LD H,A
0558+++8EED~            	CALL SETENBS
0559+++8EED~            	JR PD2_LOOP
0560+++8EED~            0561+++8EED~            PD2_ORN	CALL SETORN
0562+++8EED~            	JR PD2_LOOP
0563+++8EED~            0564+++8EED~            PD2_SKIP INC A
0565+++8EED~            	LD (IX-12+CHP.NNtSkp),A
0566+++8EED~            	JR PD2_LOOP
0567+++8EED~            0568+++8EED~            PD2_VOL	RRCA
0569+++8EED~            	RRCA
0570+++8EED~            	RRCA
0571+++8EED~            	RRCA
0572+++8EED~            	LD (IX-12+CHP.Volume),A
0573+++8EED~            	JR PD2_LOOP
0574+++8EED~            0575+++8EED~            PD2_DEL	CALL C_DELAY
0576+++8EED~            	JR PD2_LOOP
0577+++8EED~            0578+++8EED~            PD2_GLIS SET 2,(IX-12+CHP.Flags)
0579+++8EED~            	INC A
0580+++8EED~            	LD (IX-12+CHP.TnSlDl),A
0581+++8EED~            	LD (IX-12+CHP.TSlCnt),A
0582+++8EED~            	LD A,(BC)
0583+++8EED~            	INC BC
0584+++8EED~                    LD (IX-12+CHP.TSlStp),A
0585+++8EED~            	ADD A,A
0586+++8EED~            	SBC A,A
0587+++8EED~                    LD (IX-12+CHP.TSlStp+1),A
0588+++8EED~            	SCF
0589+++8EED~            	JR PD2_LP2
0590+++8EED~            0591+++8EED~            PT2PD	AND A
0592+++8EED~            0593+++8EED~            PD2_LP2	EX AF,AF'
0594+++8EED~            0595+++8EED~            PD2_LOOP LD A,(BC)
0596+++8EED~            	INC BC
0597+++8EED~            	ADD A,#20
0598+++8EED~            	JR Z,PD2_REL
0599+++8EED~            	JR C,PD2_SAM
0600+++8EED~            	ADD A,96
0601+++8EED~            	JR C,PD2_NOTE
0602+++8EED~            	INC A
0603+++8EED~            	JR Z,PD2_EOff
0604+++8EED~            	ADD A,15
0605+++8EED~            	JP Z,PD_FIN
0606+++8EED~            	JR C,PD2_ENV
0607+++8EED~            	ADD A,#10
0608+++8EED~            	JR C,PD2_ORN
0609+++8EED~            	ADD A,#40
0610+++8EED~            	JR C,PD2_SKIP
0611+++8EED~            	ADD A,#10
0612+++8EED~            	JR C,PD2_VOL
0613+++8EED~            	INC A
0614+++8EED~            	JR Z,PD2_DEL
0615+++8EED~            	INC A
0616+++8EED~            	JR Z,PD2_GLIS
0617+++8EED~            	INC A
0618+++8EED~            	JR Z,PD2_PORT
0619+++8EED~            	INC A
0620+++8EED~            	JR Z,PD2_STOP
0621+++8EED~            	LD A,(BC)
0622+++8EED~            	INC BC
0623+++8EED~            	LD (IX-12+CHP.CrNsSl),A
0624+++8EED~            	JR PD2_LOOP
0625+++8EED~            0626+++8EED~            PD2_PORT RES 2,(IX-12+CHP.Flags)
0627+++8EED~            	LD A,(BC)
0628+++8EED~            	INC BC
0629+++8EED~            	INC BC ;ignoring precalc delta to right sound
0630+++8EED~            	INC BC
0631+++8EED~            	SCF
0632+++8EED~            	JR PD2_LP2
0633+++8EED~            0634+++8EED~            PD2_STOP LD (IX-12+CHP.TSlCnt),A
0635+++8EED~            	JR PD2_LOOP
0636+++8EED~            0637+++8EED~            PD2_REL	LD (IX-12+CHP.Flags),A
0638+++8EED~            	JR PD2_EXIT
0639+++8EED~            0640+++8EED~            PD2_NOTE LD L,A
0641+++8EED~            	LD A,(IX-12+CHP.Note)
0642+++8EED~            	LD (PrNote+1),A
0643+++8EED~            	LD (IX-12+CHP.Note),L
0644+++8EED~            	XOR A
0645+++8EED~            	LD (IX-12+CHP.TSlCnt),A
0646+++8EED~            	SET 0,(IX-12+CHP.Flags)
0647+++8EED~            	EX AF,AF'
0648+++8EED~            	JR NC,NOGLIS2
0649+++8EED~            	BIT 2,(IX-12+CHP.Flags)
0650+++8EED~            	JR NZ,NOPORT2
0651+++8EED~            	LD (LoStep),A
0652+++8EED~            	ADD A,A
0653+++8EED~            	SBC A,A
0654+++8EED~            	EX AF,AF'
0655+++8EED~            	LD H,A
0656+++8EED~            	LD L,A
0657+++8EED~            	INC A
0658+++8EED~            	CALL SETPORT
0659+++8EED~            NOPORT2	LD (IX-12+CHP.TSlCnt),1
0660+++8EED~            NOGLIS2	XOR A
0661+++8EED~            0662+++8EED~            0663+++8EED~            PD2_EXIT LD (IX-12+CHP.PsInSm),A
0664+++8EED~            	LD (IX-12+CHP.PsInOr),A
0665+++8EED~            	LD (IX-12+CHP.CrTnSl),A
0666+++8EED~            	LD (IX-12+CHP.CrTnSl+1),A
0667+++8EED~            	JP PD_FIN
0668+++8EED~            0669+++8EED~            ;PT3 pattern decoder
0670+++8EED~            PD_OrSm	LD (IX-12+CHP.Env_En),0
0671+++8EED~            	CALL SETORN
0672+++8EED~            PD_SAM_	LD A,(BC)
0673+++8EED~            	INC BC
0674+++8EED~            	RRCA
0675+++8EED~            0676+++8EED~            PD_SAM	CALL SETSAM
0677+++8EED~            	JR PD_LOOP
0678+++8EED~            0679+++8EED~            PD_VOL	RRCA
0680+++8EED~            	RRCA
0681+++8EED~            	RRCA
0682+++8EED~            	RRCA
0683+++8EED~            	LD (IX-12+CHP.Volume),A
0684+++8EED~            	JR PD_LP2
0685+++8EED~            	
0686+++8EED~            PD_EOff	LD (IX-12+CHP.Env_En),A
0687+++8EED~            	LD (IX-12+CHP.PsInOr),A
0688+++8EED~            	JR PD_LP2
0689+++8EED~            0690+++8EED~            PD_SorE	DEC A
0691+++8EED~            	JR NZ,PD_ENV
0692+++8EED~            	LD A,(BC)
0693+++8EED~            	INC BC
0694+++8EED~            	LD (IX-12+CHP.NNtSkp),A
0695+++8EED~            	JR PD_LP2
0696+++8EED~            0697+++8EED~            PD_ENV	CALL SETENV
0698+++8EED~            	JR PD_LP2
0699+++8EED~            0700+++8EED~            PD_ORN	CALL SETORN
0701+++8EED~            	JR PD_LOOP
0702+++8EED~            0703+++8EED~            PD_ESAM	LD (IX-12+CHP.Env_En),A
0704+++8EED~            	LD (IX-12+CHP.PsInOr),A
0705+++8EED~            	CALL NZ,SETENV
0706+++8EED~            	JR PD_SAM_
0707+++8EED~            0708+++8EED~            PT3PD	LD A,(IX-12+CHP.Note)
0709+++8EED~            	LD (PrNote+1),A
0710+++8EED~            	LD L,(IX-12+CHP.CrTnSl)
0711+++8EED~            	LD H,(IX-12+CHP.CrTnSl+1)
0712+++8EED~            	LD (PrSlide+1),HL
0713+++8EED~            0714+++8EED~            PD_LOOP	LD DE,#2010
0715+++8EED~            PD_LP2	LD A,(BC)
0716+++8EED~            	INC BC
0717+++8EED~            	ADD A,E
0718+++8EED~            	JR C,PD_OrSm
0719+++8EED~            	ADD A,D
0720+++8EED~            	JR Z,PD_FIN
0721+++8EED~            	JR C,PD_SAM
0722+++8EED~            	ADD A,E
0723+++8EED~            	JR Z,PD_REL
0724+++8EED~            	JR C,PD_VOL
0725+++8EED~            	ADD A,E
0726+++8EED~            	JR Z,PD_EOff
0727+++8EED~            	JR C,PD_SorE
0728+++8EED~            	ADD A,96
0729+++8EED~            	JR C,PD_NOTE
0730+++8EED~            	ADD A,E
0731+++8EED~            	JR C,PD_ORN
0732+++8EED~            	ADD A,D
0733+++8EED~            	JR C,PD_NOIS
0734+++8EED~            	ADD A,E
0735+++8EED~            	JR C,PD_ESAM
0736+++8EED~            	ADD A,A
0737+++8EED~            	LD E,A
0738+++8EED~            	LD HL,(SPCCOMS+#FF20-#2000)&65535
0739+++8EED~            	ADD HL,DE
0740+++8EED~            	LD E,(HL)
0741+++8EED~            	INC HL
0742+++8EED~            	LD D,(HL)
0743+++8EED~            	PUSH DE
0744+++8EED~            	JR PD_LOOP
0745+++8EED~            0746+++8EED~            PD_NOIS	LD (IY-100+VRS.Ns_Base),A
0747+++8EED~            	JR PD_LP2
0748+++8EED~            0749+++8EED~            PD_REL	RES 0,(IX-12+CHP.Flags)
0750+++8EED~            	JR PD_RES
0751+++8EED~            0752+++8EED~            PD_NOTE	LD (IX-12+CHP.Note),A
0753+++8EED~            	SET 0,(IX-12+CHP.Flags)
0754+++8EED~            	XOR A
0755+++8EED~            0756+++8EED~            PD_RES	LD (PDSP_+1),SP
0757+++8EED~            	LD SP,IX
0758+++8EED~            	LD H,A
0759+++8EED~            	LD L,A
0760+++8EED~            	PUSH HL
0761+++8EED~            	PUSH HL
0762+++8EED~            	PUSH HL
0763+++8EED~            	PUSH HL
0764+++8EED~            	PUSH HL
0765+++8EED~            	PUSH HL
0766+++8EED~            PDSP_	LD SP,#3131
0767+++8EED~            0768+++8EED~            PD_FIN	LD A,(IX-12+CHP.NNtSkp)
0769+++8EED~            	LD (IX-12+CHP.NtSkCn),A
0770+++8EED~            	RET
0771+++8EED~            0772+++8EED~            C_PORTM LD A,(BC)
0773+++8EED~            	INC BC
0774+++8EED~            ;SKIP PRECALCULATED TONE DELTA (BECAUSE
0775+++8EED~            ;CANNOT BE RIGHT AFTER PT3 COMPILATION)
0776+++8EED~            	INC BC
0777+++8EED~            	INC BC
0778+++8EED~            	EX AF,AF'
0779+++8EED~            	LD A,(BC) ;SIGNED TONE STEP
0780+++8EED~            	INC BC
0781+++8EED~            	LD (LoStep),A
0782+++8EED~            	LD A,(BC)
0783+++8EED~            	INC BC
0784+++8EED~            	AND A
0785+++8EED~            	EX AF,AF'
0786+++8EED~            	LD L,(IX-12+CHP.CrTnSl)
0787+++8EED~            	LD H,(IX-12+CHP.CrTnSl+1)
0788+++8EED~            0789+++8EED~            ;Set portamento variables
0790+++8EED~            ;A - Delay; A' - Hi(Step); ZF' - (A'=0); HL - CrTnSl
0791+++8EED~            0792+++8EED~            SETPORT	RES 2,(IX-12+CHP.Flags)
0793+++8EED~            	LD (IX-12+CHP.TnSlDl),A
0794+++8EED~            	LD (IX-12+CHP.TSlCnt),A
0795+++8EED~            	PUSH HL
0796+++8EED~            	LD DE,NT_
0797+++8EED~            	LD A,(IX-12+CHP.Note)
0798+++8EED~            	LD (IX-12+CHP.SlToNt),A
0799+++8EED~            	ADD A,A
0800+++8EED~            	LD L,A
0801+++8EED~            	LD H,0
0802+++8EED~            	ADD HL,DE
0803+++8EED~            	LD A,(HL)
0804+++8EED~            	INC HL
0805+++8EED~            	LD H,(HL)
0806+++8EED~            	LD L,A
0807+++8EED~            	PUSH HL
0808+++8EED~            PrNote	LD A,#3E
0809+++8EED~            	LD (IX-12+CHP.Note),A
0810+++8EED~            	ADD A,A
0811+++8EED~            	LD L,A
0812+++8EED~            	LD H,0
0813+++8EED~            	ADD HL,DE
0814+++8EED~            	LD E,(HL)
0815+++8EED~            	INC HL
0816+++8EED~            	LD D,(HL)
0817+++8EED~            	POP HL
0818+++8EED~            	SBC HL,DE
0819+++8EED~            	LD (IX-12+CHP.TnDelt),L
0820+++8EED~            	LD (IX-12+CHP.TnDelt+1),H
0821+++8EED~            	POP DE
0822+++8EED~            Version EQU $+1
0823+++8EED~            	LD A,#3E
0824+++8EED~            	CP 6
0825+++8EED~            	JR C,OLDPRTM ;Old 3xxx for PT v3.5-
0826+++8EED~            PrSlide	LD DE,#1111
0827+++8EED~            	LD (IX-12+CHP.CrTnSl),E
0828+++8EED~            	LD (IX-12+CHP.CrTnSl+1),D
0829+++8EED~            LoStep	EQU $+1
0830+++8EED~            OLDPRTM	LD A,#3E
0831+++8EED~            	EX AF,AF'
0832+++8EED~            	JR Z,NOSIG
0833+++8EED~            	EX DE,HL
0834+++8EED~            NOSIG	SBC HL,DE
0835+++8EED~            	JP P,SET_STP
0836+++8EED~            	CPL
0837+++8EED~            	EX AF,AF'
0838+++8EED~            	NEG
0839+++8EED~            	EX AF,AF'
0840+++8EED~            SET_STP	LD (IX-12+CHP.TSlStp+1),A
0841+++8EED~            	EX AF,AF'
0842+++8EED~            	LD (IX-12+CHP.TSlStp),A
0843+++8EED~            	LD (IX-12+CHP.COnOff),0
0844+++8EED~            	RET
0845+++8EED~            0846+++8EED~            C_GLISS	SET 2,(IX-12+CHP.Flags)
0847+++8EED~            	LD A,(BC)
0848+++8EED~            	INC BC
0849+++8EED~            	LD (IX-12+CHP.TnSlDl),A
0850+++8EED~            	AND A
0851+++8EED~            	JR NZ,GL36
0852+++8EED~            	LD A,(Version) ;AlCo PT3.7+
0853+++8EED~            	CP 7
0854+++8EED~            	SBC A,A
0855+++8EED~            	INC A
0856+++8EED~            GL36	LD (IX-12+CHP.TSlCnt),A
0857+++8EED~            	LD A,(BC)
0858+++8EED~            	INC BC
0859+++8EED~            	EX AF,AF'
0860+++8EED~            	LD A,(BC)
0861+++8EED~            	INC BC
0862+++8EED~            	JR SET_STP
0863+++8EED~            0864+++8EED~            C_SMPOS	LD A,(BC)
0865+++8EED~            	INC BC
0866+++8EED~            	LD (IX-12+CHP.PsInSm),A
0867+++8EED~            	RET
0868+++8EED~            0869+++8EED~            C_ORPOS	LD A,(BC)
0870+++8EED~            	INC BC
0871+++8EED~            	LD (IX-12+CHP.PsInOr),A
0872+++8EED~            	RET
0873+++8EED~            0874+++8EED~            C_VIBRT	LD A,(BC)
0875+++8EED~            	INC BC
0876+++8EED~            	LD (IX-12+CHP.OnOffD),A
0877+++8EED~            	LD (IX-12+CHP.COnOff),A
0878+++8EED~            	LD A,(BC)
0879+++8EED~            	INC BC
0880+++8EED~            	LD (IX-12+CHP.OffOnD),A
0881+++8EED~            	XOR A
0882+++8EED~            	LD (IX-12+CHP.TSlCnt),A
0883+++8EED~            	LD (IX-12+CHP.CrTnSl),A
0884+++8EED~            	LD (IX-12+CHP.CrTnSl+1),A
0885+++8EED~            	RET
0886+++8EED~            0887+++8EED~            C_ENGLS	LD A,(BC)
0888+++8EED~            	INC BC
0889+++8EED~            	LD (IY-100+VRS.Env_Del),A
0890+++8EED~            	LD (IY-100+VRS.CurEDel),A
0891+++8EED~            	LD A,(BC)
0892+++8EED~            	INC BC
0893+++8EED~            	LD L,A
0894+++8EED~            	LD A,(BC)
0895+++8EED~            	INC BC
0896+++8EED~            	LD H,A
0897+++8EED~            	LD (IY-100+VRS.ESldAdd),L
0898+++8EED~            	LD (IY-100+VRS.ESldAdd+1),H
0899+++8EED~            	RET
0900+++8EED~            0901+++8EED~            C_DELAY	LD A,(BC)
0902+++8EED~            	INC BC
0903+++8EED~            	LD (IY-100+VRS.Delay),A
0904+++8EED~            	LD HL,VARS2+VRS.ModNum ;if AlCo_TS
0905+++8EED~            	BIT 1,(HL)
0906+++8EED~            	RET Z
0907+++8EED~            	LD (VARS1+VRS.Delay),A
0908+++8EED~            	LD (VARS1+VRS.DelyCnt),A
0909+++8EED~            	LD (VARS2+VRS.Delay),A
0910+++8EED~            	RET
0911+++8EED~            	
0912+++8EED~            SETENV	LD (IX-12+CHP.Env_En),E
0913+++8EED~            	LD (IY-100+VRS.AYREGS+EnvTp),A
0914+++8EED~            	LD A,(BC)
0915+++8EED~            	INC BC
0916+++8EED~            	LD H,A
0917+++8EED~            	LD A,(BC)
0918+++8EED~            	INC BC
0919+++8EED~            	LD L,A
0920+++8EED~            	CALL SETENBS
0921+++8EED~            	XOR A
0922+++8EED~            	LD (IX-12+CHP.PsInOr),A
0923+++8EED~            	LD (IY-100+VRS.CurEDel),A
0924+++8EED~            	LD H,A
0925+++8EED~            	LD L,A
0926+++8EED~            	JP SETESLD
0927+++8EED~            0928+++8EED~            SETORN	ADD A,A
0929+++8EED~            	LD E,A
0930+++8EED~            	LD D,0
0931+++8EED~            	LD (IX-12+CHP.PsInOr),D
0932+++8EED~            	LD L,(IY-100+VRS.OrnPtrs)
0933+++8EED~            	LD H,(IY-100+VRS.OrnPtrs+1)
0934+++8EED~            	ADD HL,DE
0935+++8EED~            	LD E,(HL)
0936+++8EED~            	INC HL
0937+++8EED~            	LD D,(HL)
0938+++8EED~            	LD L,(IY-100+VRS.MODADDR)
0939+++8EED~            	LD H,(IY-100+VRS.MODADDR+1)
0940+++8EED~            	ADD HL,DE
0941+++8EED~            	LD (IX-12+CHP.OrnPtr),L
0942+++8EED~            	LD (IX-12+CHP.OrnPtr+1),H
0943+++8EED~            C_NOP	RET
0944+++8EED~            0945+++8EED~            SETSAM	ADD A,A
0946+++8EED~            	LD E,A
0947+++8EED~            	LD D,0
0948+++8EED~            	LD L,(IY-100+VRS.SamPtrs);
0949+++8EED~            	LD H,(IY-100+VRS.SamPtrs+1);
0950+++8EED~            	ADD HL,DE
0951+++8EED~            	LD E,(HL)
0952+++8EED~            	INC HL
0953+++8EED~            	LD D,(HL)
0954+++8EED~            	LD L,(IY-100+VRS.MODADDR)
0955+++8EED~            	LD H,(IY-100+VRS.MODADDR+1)
0956+++8EED~            	ADD HL,DE
0957+++8EED~            	LD (IX-12+CHP.SamPtr),L
0958+++8EED~            	LD (IX-12+CHP.SamPtr+1),H
0959+++8EED~            	RET
0960+++8EED~            0961+++8EED~            ;ALL 16 ADDRESSES TO PROTECT FROM BROKEN PT3 MODULES
0962+++8EED~            SPCCOMS DW C_NOP
0963+++8EED~            	DW C_GLISS
0964+++8EED~            	DW C_PORTM
0965+++8EED~            	DW C_SMPOS
0966+++8EED~            	DW C_ORPOS
0967+++8EED~            	DW C_VIBRT
0968+++8EED~            	DW C_NOP
0969+++8EED~            	DW C_NOP
0970+++8EED~            	DW C_ENGLS
0971+++8EED~            	DW C_DELAY
0972+++8EED~            	DW C_NOP
0973+++8EED~            	DW C_NOP
0974+++8EED~            	DW C_NOP
0975+++8EED~            	DW C_NOP
0976+++8EED~            	DW C_NOP
0977+++8EED~            	DW C_NOP
0978+++8EED~            0979+++8EED~            CHREGS	CALL GETIX
0980+++8EED~            	XOR A
0981+++8EED~            	LD (Ampl),A
0982+++8EED~            	BIT 0,(IX+CHP.Flags)
0983+++8EED~            	PUSH HL
0984+++8EED~            	JP Z,CH_EXIT
0985+++8EED~            	LD (CSP_+1),SP
0986+++8EED~            	LD L,(IX+CHP.OrnPtr)
0987+++8EED~            	LD H,(IX+CHP.OrnPtr+1)
0988+++8EED~            	LD SP,HL
0989+++8EED~            	POP DE
0990+++8EED~            	LD H,A
0991+++8EED~            	LD A,(IX+CHP.PsInOr)
0992+++8EED~            	LD L,A
0993+++8EED~            	ADD HL,SP
0994+++8EED~            	INC A
0995+++8EED~            		;PT2	PT3
0996+++8EED~            OrnCP	INC A	;CP E	CP D
0997+++8EED~            	JR C,CH_ORPS
0998+++8EED~            OrnLD	DB 1	;LD A,D	LD A,E
0999+++8EED~            CH_ORPS	LD (IX+CHP.PsInOr),A
1000+++8EED~            	LD A,(IX+CHP.Note)
1001+++8EED~            	ADD A,(HL)
1002+++8EED~            	JP P,CH_NTP
1003+++8EED~            	XOR A
1004+++8EED~            CH_NTP	CP 96
1005+++8EED~            	JR C,CH_NOK
1006+++8EED~            	LD A,95
1007+++8EED~            CH_NOK	ADD A,A
1008+++8EED~            	EX AF,AF'
1009+++8EED~            	LD L,(IX+CHP.SamPtr)
1010+++8EED~            	LD H,(IX+CHP.SamPtr+1)
1011+++8EED~            	LD SP,HL
1012+++8EED~            	POP DE
1013+++8EED~            	LD H,0
1014+++8EED~            	LD A,(IX+CHP.PsInSm)
1015+++8EED~            	LD B,A
1016+++8EED~            	ADD A,A
1017+++8EED~            SamClc2	ADD A,A ;or ADD A,B for PT2
1018+++8EED~            	LD L,A
1019+++8EED~            	ADD HL,SP
1020+++8EED~            	LD SP,HL
1021+++8EED~            	LD A,B
1022+++8EED~            	INC A
1023+++8EED~            		;PT2	PT3
1024+++8EED~            SamCP	INC A	;CP E	CP D
1025+++8EED~            	JR C,CH_SMPS
1026+++8EED~            SamLD	DB 1	;LD A,D	LD A,E
1027+++8EED~            CH_SMPS	LD (IX+CHP.PsInSm),A
1028+++8EED~            	POP BC
1029+++8EED~            	POP HL
1030+++8EED~            1031+++8EED~            ;Convert PT2 sample to PT3
1032+++8EED~            		;PT2		PT3
1033+++8EED~            SamCnv	POP HL  ;BIT 2,C	JR e_
1034+++8EED~            	POP HL	
1035+++8EED~            	LD H,B
1036+++8EED~            	JR NZ,$+8
1037+++8EED~            	EX DE,HL
1038+++8EED~            	AND A
1039+++8EED~            	SBC HL,HL
1040+++8EED~            	SBC HL,DE
1041+++8EED~            	LD D,C
1042+++8EED~            	RR C
1043+++8EED~            	SBC A,A
1044+++8EED~            	CPL
1045+++8EED~            	AND #3E
1046+++8EED~            	RR C
1047+++8EED~            	RR B
1048+++8EED~            	AND C
1049+++8EED~            	LD C,A
1050+++8EED~            	LD A,B
1051+++8EED~            	RRA
1052+++8EED~            	RRA
1053+++8EED~            	RR D
1054+++8EED~            	RRA
1055+++8EED~            	AND #9F
1056+++8EED~            	LD B,A
1057+++8EED~            1058+++8EED~            e_	LD E,(IX+CHP.TnAcc)
1059+++8EED~            	LD D,(IX+CHP.TnAcc+1)
1060+++8EED~            	ADD HL,DE
1061+++8EED~            	BIT 6,B
1062+++8EED~            	JR Z,CH_NOAC
1063+++8EED~            	LD (IX+CHP.TnAcc),L
1064+++8EED~            	LD (IX+CHP.TnAcc+1),H
1065+++8EED~            CH_NOAC EX DE,HL
1066+++8EED~            	EX AF,AF'
1067+++8EED~            	ADD A,NT_&255
1068+++8EED~            	LD L,A
1069+++8EED~            	ADC A,NT_/256
1070+++8EED~            	SUB L
1071+++8EED~            	LD H,A
1072+++8EED~            	LD SP,HL
1073+++8EED~            	POP HL
1074+++8EED~            	ADD HL,DE
1075+++8EED~            	LD E,(IX+CHP.CrTnSl)
1076+++8EED~            	LD D,(IX+CHP.CrTnSl+1)
1077+++8EED~            	ADD HL,DE
1078+++8EED~            CSP_	LD SP,#3131
1079+++8EED~            	EX (SP),HL
1080+++8EED~            	XOR A
1081+++8EED~            	OR (IX+CHP.TSlCnt)
1082+++8EED~            	JR Z,CH_AMP
1083+++8EED~            	DEC (IX+CHP.TSlCnt)
1084+++8EED~            	JR NZ,CH_AMP
1085+++8EED~            	LD A,(IX+CHP.TnSlDl)
1086+++8EED~            	LD (IX+CHP.TSlCnt),A
1087+++8EED~            	LD L,(IX+CHP.TSlStp)
1088+++8EED~            	LD H,(IX+CHP.TSlStp+1)
1089+++8EED~            	LD A,H
1090+++8EED~            	ADD HL,DE
1091+++8EED~            	LD (IX+CHP.CrTnSl),L
1092+++8EED~            	LD (IX+CHP.CrTnSl+1),H
1093+++8EED~            	BIT 2,(IX+CHP.Flags)
1094+++8EED~            	JR NZ,CH_AMP
1095+++8EED~            	LD E,(IX+CHP.TnDelt)
1096+++8EED~            	LD D,(IX+CHP.TnDelt+1)
1097+++8EED~            	AND A
1098+++8EED~            	JR Z,CH_STPP
1099+++8EED~            	EX DE,HL
1100+++8EED~            CH_STPP SBC HL,DE
1101+++8EED~            	JP M,CH_AMP
1102+++8EED~            	LD A,(IX+CHP.SlToNt)
1103+++8EED~            	LD (IX+CHP.Note),A
1104+++8EED~            	XOR A
1105+++8EED~            	LD (IX+CHP.TSlCnt),A
1106+++8EED~            	LD (IX+CHP.CrTnSl),A
1107+++8EED~            	LD (IX+CHP.CrTnSl+1),A
1108+++8EED~            CH_AMP	LD A,(IX+CHP.CrAmSl)
1109+++8EED~            	BIT 7,C
1110+++8EED~            	JR Z,CH_NOAM
1111+++8EED~            	BIT 6,C
1112+++8EED~            	JR Z,CH_AMIN
1113+++8EED~            	CP 15
1114+++8EED~            	JR Z,CH_NOAM
1115+++8EED~            	INC A
1116+++8EED~            	JR CH_SVAM
1117+++8EED~            CH_AMIN	CP -15
1118+++8EED~            	JR Z,CH_NOAM
1119+++8EED~            	DEC A
1120+++8EED~            CH_SVAM	LD (IX+CHP.CrAmSl),A
1121+++8EED~            CH_NOAM	LD L,A
1122+++8EED~            	LD A,B
1123+++8EED~            	AND 15
1124+++8EED~            	ADD A,L
1125+++8EED~            	JP P,CH_APOS
1126+++8EED~            	XOR A
1127+++8EED~            CH_APOS	CP 16
1128+++8EED~            	JR C,CH_VOL
1129+++8EED~            	LD A,15
1130+++8EED~            CH_VOL	OR (IX+CHP.Volume)
1131+++8EED~            	ADD A,VT_&255
1132+++8EED~            	LD L,A
1133+++8EED~            	ADC A,VT_/256
1134+++8EED~            	SUB L
1135+++8EED~            	LD H,A
1136+++8EED~            	LD A,(HL)
1137+++8EED~            CH_ENV	BIT 0,C
1138+++8EED~            	JR NZ,CH_NOEN
1139+++8EED~            	OR (IX+CHP.Env_En)
1140+++8EED~            CH_NOEN	LD (Ampl),A
1141+++8EED~            	BIT 7,B
1142+++8EED~            	LD A,C
1143+++8EED~            	JR Z,NO_ENSL
1144+++8EED~            	RLA
1145+++8EED~            	RLA
1146+++8EED~            	SRA A
1147+++8EED~            	SRA A
1148+++8EED~            	SRA A
1149+++8EED~            	ADD A,(IX+CHP.CrEnSl) ;SEE COMMENT BELOW
1150+++8EED~            	BIT 5,B
1151+++8EED~            	JR Z,NO_ENAC
1152+++8EED~            	LD (IX+CHP.CrEnSl),A
1153+++8EED~            NO_ENAC	ADD A,(IY-100+VRS.AddToEn) ;BUG IN PT3 - NEED WORD HERE
1154+++8EED~            	LD (IY-100+VRS.AddToEn),A
1155+++8EED~            	JR CH_MIX
1156+++8EED~            NO_ENSL RRA
1157+++8EED~            	ADD A,(IX+CHP.CrNsSl)
1158+++8EED~            	LD (IY-100+VRS.AddToNs),A
1159+++8EED~            	BIT 5,B
1160+++8EED~            	JR Z,CH_MIX
1161+++8EED~            	LD (IX+CHP.CrNsSl),A
1162+++8EED~            CH_MIX	LD A,B
1163+++8EED~            	RRA
1164+++8EED~            	AND #48
1165+++8EED~            CH_EXIT	OR (IY-100+VRS.AYREGS+Mixer)
1166+++8EED~            	RRCA
1167+++8EED~            	LD (IY-100+VRS.AYREGS+Mixer),A
1168+++8EED~            	POP HL
1169+++8EED~            	XOR A
1170+++8EED~            	OR (IX+CHP.COnOff)
1171+++8EED~            	RET Z
1172+++8EED~            	DEC (IX+CHP.COnOff)
1173+++8EED~            	RET NZ
1174+++8EED~            	XOR (IX+CHP.Flags)
1175+++8EED~            	LD (IX+CHP.Flags),A
1176+++8EED~            	RRA
1177+++8EED~            	LD A,(IX+CHP.OnOffD)
1178+++8EED~            	JR C,CH_ONDL
1179+++8EED~            	LD A,(IX+CHP.OffOnD)
1180+++8EED~            CH_ONDL	LD (IX+CHP.COnOff),A
1181+++8EED~            	RET
1182+++8EED~            1183+++8EED~            PLAY_	XOR A
1184+++8EED~            	LD (IY-100+VRS.AddToEn),A
1185+++8EED~            	LD (IY-100+VRS.AYREGS+Mixer),A
1186+++8EED~            	DEC A
1187+++8EED~            	LD (IY-100+VRS.AYREGS+EnvTp),A
1188+++8EED~            	DEC (IY-100+VRS.DelyCnt)
1189+++8EED~            	JP NZ,PL2
1190+++8EED~            	DEC (IY-100+VRS.ChanA+CHP.NtSkCn)
1191+++8EED~            	JR NZ,PL1B
1192+++8EED~            	LD C,(IY-100+VRS.AdInPtA)
1193+++8EED~            	LD B,(IY-100+VRS.AdInPtA+1)
1194+++8EED~            	LD A,(BC)
1195+++8EED~            	AND A
1196+++8EED~            	JR NZ,PL1A
1197+++8EED~            	LD D,A
1198+++8EED~            	LD (IY-100+VRS.Ns_Base),A
1199+++8EED~            	LD L,(IY-100+VRS.CrPsPtr)
1200+++8EED~            	LD H,(IY-100+VRS.CrPsPtr+1)
1201+++8EED~            	INC HL
1202+++8EED~            	LD A,(HL)
1203+++8EED~            	INC A
1204+++8EED~            	JR NZ,PLNLP
1205+++8EED~            1206+++8EED~            	IF LoopChecker
1207+++8EED~            	CALL CHECKLP
1208+++8EED~            	ENDIF
1209+++8EED~            1210+++8EED~            	LD L,(IY-100+VRS.LPosPtr)
1211+++8EED~            	LD H,(IY-100+VRS.LPosPtr+1)
1212+++8EED~            	LD A,(HL)
1213+++8EED~            	INC A
1214+++8EED~            PLNLP	CALL SETCPPT
1215+++8EED~            	DEC A
1216+++8EED~            	BIT 1,(IY-100+VRS.ModNum)
1217+++8EED~            	JR Z,NoAlCo
1218+++8EED~            TSSub	EQU $+1
1219+++8EED~            	SUB #D6
1220+++8EED~            	CPL
1221+++8EED~            NoAlCo
1222+++8EED~            		;PT2		PT3
1223+++8EED~            PsCalc	DEC A	;ADD A,A	NOP
1224+++8EED~            	DEC A	;ADD A,(HL)	NOP
1225+++8EED~            	ADD A,A
1226+++8EED~            	LD E,A
1227+++8EED~            	RL D
1228+++8EED~            1229+++8EED~            	IF CurPosCounter
1230+++8EED~            	LD A,L
1231+++8EED~            	SUB (IY-100+VRS.PosSub)
1232+++8EED~            	LD (IY-100+VRS.CurPos),A
1233+++8EED~            	ENDIF
1234+++8EED~            1235+++8EED~            	LD L,(IY-100+VRS.PatsPtr)
1236+++8EED~            	LD H,(IY-100+VRS.PatsPtr+1)
1237+++8EED~            	ADD HL,DE
1238+++8EED~            	LD E,(IY-100+VRS.MODADDR)
1239+++8EED~            	LD D,(IY-100+VRS.MODADDR+1)
1240+++8EED~            	LD (PSP_+1),SP
1241+++8EED~            	LD SP,HL
1242+++8EED~            	POP HL
1243+++8EED~            	ADD HL,DE
1244+++8EED~            	LD B,H
1245+++8EED~            	LD C,L
1246+++8EED~            	POP HL
1247+++8EED~            	ADD HL,DE
1248+++8EED~            	LD (IY-100+VRS.AdInPtB),L
1249+++8EED~            	LD (IY-100+VRS.AdInPtB+1),H
1250+++8EED~            	POP HL
1251+++8EED~            	ADD HL,DE
1252+++8EED~            	LD (IY-100+VRS.AdInPtC),L
1253+++8EED~            	LD (IY-100+VRS.AdInPtC+1),H
1254+++8EED~            PSP_	LD SP,#3131
1255+++8EED~            PL1A	LD DE,VRS.ChanA+12-100
1256+++8EED~            	CALL PTDECOD
1257+++8EED~            	LD (IY-100+VRS.AdInPtA),C
1258+++8EED~            	LD (IY-100+VRS.AdInPtA+1),B
1259+++8EED~            1260+++8EED~            PL1B	DEC (IY-100+VRS.ChanB+CHP.NtSkCn)
1261+++8EED~            	JR NZ,PL1C
1262+++8EED~            	LD DE,VRS.ChanB+12-100
1263+++8EED~            	LD C,(IY-100+VRS.AdInPtB)
1264+++8EED~            	LD B,(IY-100+VRS.AdInPtB+1)
1265+++8EED~            	CALL PTDECOD
1266+++8EED~            	LD (IY-100+VRS.AdInPtB),C
1267+++8EED~            	LD (IY-100+VRS.AdInPtB+1),B
1268+++8EED~            1269+++8EED~            PL1C	DEC (IY-100+VRS.ChanC+CHP.NtSkCn)
1270+++8EED~            	JR NZ,PL1D
1271+++8EED~            	LD DE,VRS.ChanC+12-100
1272+++8EED~            	LD C,(IY-100+VRS.AdInPtC)
1273+++8EED~            	LD B,(IY-100+VRS.AdInPtC+1)
1274+++8EED~            	CALL PTDECOD
1275+++8EED~            	LD (IY-100+VRS.AdInPtC),C
1276+++8EED~            	LD (IY-100+VRS.AdInPtC+1),B
1277+++8EED~            1278+++8EED~            PL1D	LD A,(IY-100+VRS.Delay)
1279+++8EED~            	LD (IY-100+VRS.DelyCnt),A
1280+++8EED~            1281+++8EED~            PL2	LD DE,VRS.ChanA-100
1282+++8EED~            	LD L,(IY-100+VRS.AYREGS+TonA)
1283+++8EED~            	LD H,(IY-100+VRS.AYREGS+TonA+1)
1284+++8EED~            	CALL CHREGS
1285+++8EED~            	LD (IY-100+VRS.AYREGS+TonA),L
1286+++8EED~            	LD (IY-100+VRS.AYREGS+TonA+1),H
1287+++8EED~            Ampl	EQU $+1
1288+++8EED~            	LD A,#3E
1289+++8EED~            	LD (IY-100+VRS.AYREGS+AmplA),A
1290+++8EED~            	LD DE,VRS.ChanB-100
1291+++8EED~            	LD L,(IY-100+VRS.AYREGS+TonB)
1292+++8EED~            	LD H,(IY-100+VRS.AYREGS+TonB+1)
1293+++8EED~            	CALL CHREGS
1294+++8EED~            	LD (IY-100+VRS.AYREGS+TonB),L
1295+++8EED~            	LD (IY-100+VRS.AYREGS+TonB+1),H
1296+++8EED~            	LD A,(Ampl)
1297+++8EED~            	LD (IY-100+VRS.AYREGS+AmplB),A
1298+++8EED~            	LD DE,VRS.ChanC-100
1299+++8EED~            	LD L,(IY-100+VRS.AYREGS+TonC)
1300+++8EED~            	LD H,(IY-100+VRS.AYREGS+TonC+1)
1301+++8EED~            	CALL CHREGS
1302+++8EED~            	LD (IY-100+VRS.AYREGS+TonC),L
1303+++8EED~            	LD (IY-100+VRS.AYREGS+TonC+1),H
1304+++8EED~            	LD A,(Ampl)
1305+++8EED~            	LD (IY-100+VRS.AYREGS+AmplC),A
1306+++8EED~            1307+++8EED~            	LD A,(IY-100+VRS.Ns_Base)
1308+++8EED~            	ADD (IY-100+VRS.AddToNs)
1309+++8EED~            	LD (IY-100+VRS.AYREGS+Noise),A
1310+++8EED~            1311+++8EED~            	LD A,(IY-100+VRS.AddToEn)
1312+++8EED~            	LD E,A
1313+++8EED~            	ADD A,A
1314+++8EED~            	SBC A,A
1315+++8EED~            	LD D,A
1316+++8EED~            	LD L,(IY-100+VRS.EnvBase)
1317+++8EED~            	LD H,(IY-100+VRS.EnvBase+1)
1318+++8EED~            	ADD HL,DE
1319+++8EED~            	LD E,(IY-100+VRS.CurESld)
1320+++8EED~            	LD D,(IY-100+VRS.CurESld+1)
1321+++8EED~            	ADD HL,DE
1322+++8EED~            	LD (IY-100+VRS.AYREGS+Env),L
1323+++8EED~            	LD (IY-100+VRS.AYREGS+Env+1),H
1324+++8EED~            1325+++8EED~            	XOR A
1326+++8EED~            	OR (IY-100+VRS.CurEDel)
1327+++8EED~            	RET Z
1328+++8EED~            	DEC (IY-100+VRS.CurEDel)
1329+++8EED~            	RET NZ
1330+++8EED~            	LD A,(IY-100+VRS.Env_Del)
1331+++8EED~            	LD (IY-100+VRS.CurEDel),A
1332+++8EED~            	LD L,(IY-100+VRS.ESldAdd)
1333+++8EED~            	LD H,(IY-100+VRS.ESldAdd+1)
1334+++8EED~            	ADD HL,DE
1335+++8EED~            	JP SETESLD
1336+++8EED~            1337+++8EED~            PLAY    LD IY,VARS1+100
1338+++8EED~            	CALL PLAY_
1339+++8EED~            	LD A,(is_ts)
1340+++8EED~            	AND A
1341+++8EED~            	JR Z,PL_nts
1342+++8EED~            	LD IY,VARS2+100
1343+++8EED~            	CALL PLAY_
1344+++8EED~            PL_nts
1345+++8EED~            	IF Basic
1346+++8EED~            	LD IY,#5C3A
1347+++8EED~            	ENDIF
1348+++8EED~            1349+++8EED~            ROUT	LD BC,#FFFD
1350+++8EED~              IFDEF ONtfm
1351+++8EED~                LD L,#F9
1352+++8EED~                OUT (C),L
1353+++8EED~              ELSE
1354+++8EED~            	LD A,(is_ts)
1355+++8EED~            	AND A
1356+++8EED~            	JR Z,r_nts ;keep old standard
1357+++8EED~            	OUT (C),B
1358+++8EED~                ENDIF
1359+++8EED~            r_nts	EX AF,AF'
1360+++8EED~            1361+++8EED~            	IF ACBBAC
1362+++8EED~            	LD IX,VARS1+VRS.AYREGS
1363+++8EED~            	ELSE
1364+++8EED~            	LD HL,VARS1+VRS.AYREGS
1365+++8EED~            	ENDIF
1366+++8EED~            1367+++8EED~            	CALL ROUT_
1368+++8EED~            	EX AF,AF'
1369+++8EED~            	RET Z
1370+++8EED~            	LD B,D
1371+++8EED~            1372+++8EED~                IFDEF ONtfm
1373+++8EED~                LD A,#F8
1374+++8EED~                ELSE
1375+++8EED~            	CPL
1376+++8EED~                ENDIF
1377+++8EED~            	OUT (C),A
1378+++8EED~            1379+++8EED~            	IF ACBBAC
1380+++8EED~            	LD IX,VARS2+VRS.AYREGS
1381+++8EED~            	ELSE
1382+++8EED~            	LD HL,VARS2+VRS.AYREGS
1383+++8EED~            	ENDIF
1384+++8EED~            1385+++8EED~            ROUT_
1386+++8EED~            	IF ACBBAC
1387+++8EED~            	LD A,(SETUP)
1388+++8EED~            	AND 12
1389+++8EED~            	JR Z,ABC
1390+++8EED~            	ADD A,CHTABLE
1391+++8EED~            	LD E,A
1392+++8EED~            	ADC A,CHTABLE/256
1393+++8EED~            	SUB E
1394+++8EED~            	LD D,A
1395+++8EED~            	LD B,0
1396+++8EED~            	PUSH IX
1397+++8EED~            	POP HL
1398+++8EED~            	LD A,(DE)
1399+++8EED~            	INC DE
1400+++8EED~            	LD C,A
1401+++8EED~            	ADD HL,BC
1402+++8EED~            	LD A,(IX+TonB)
1403+++8EED~            	LD C,(HL)
1404+++8EED~            	LD (IX+TonB),C
1405+++8EED~            	LD (HL),A
1406+++8EED~            	INC HL
1407+++8EED~            	LD A,(IX+TonB+1)
1408+++8EED~            	LD C,(HL)
1409+++8EED~            	LD (IX+TonB+1),C
1410+++8EED~            	LD (HL),A
1411+++8EED~            	LD A,(DE)
1412+++8EED~            	INC DE
1413+++8EED~            	LD C,A
1414+++8EED~            	ADD HL,BC
1415+++8EED~            	LD A,(IX+AmplB)
1416+++8EED~            	LD C,(HL)
1417+++8EED~            	LD (IX+AmplB),C
1418+++8EED~            	LD (HL),A
1419+++8EED~            	LD A,(DE)
1420+++8EED~            	INC DE
1421+++8EED~            	LD (RxCA1),A
1422+++8EED~            	XOR 8
1423+++8EED~            	LD (RxCA2),A
1424+++8EED~            	LD A,(DE)
1425+++8EED~            	AND (IX+Mixer)
1426+++8EED~            	LD E,A
1427+++8EED~            	LD A,(IX+Mixer)
1428+++8EED~            RxCA1	DB #E6
1429+++8EED~            	AND %010010
1430+++8EED~            	OR E
1431+++8EED~            	LD E,A
1432+++8EED~            	LD A,(IX+Mixer)
1433+++8EED~            	AND %010010
1434+++8EED~            RxCA2	OR E
1435+++8EED~            	OR E
1436+++8EED~            	LD (IX+Mixer),A
1437+++8EED~            ABC
1438+++8EED~            	ENDIF
1439+++8EED~            1440+++8EED~            	XOR A
1441+++8EED~            	LD DE,#FFBF
1442+++8EED~            1443+++8EED~            	IF ACBBAC
1444+++8EED~            	LD BC,#FFFD
1445+++8EED~            	PUSH IX
1446+++8EED~            	POP HL
1447+++8EED~            	ENDIF
1448+++8EED~            1449+++8EED~            LOUT
1450+++8EED~                IFDEF ONtfm
1451+++8EED~                INF 
1452+++8EED~                JP M,$-2
1453+++8EED~                ENDIF 
1454+++8EED~                OUT (C),A
1455+++8EED~                IFDEF ONtfm
1456+++8EED~                INF 
1457+++8EED~                JP M,$-2
1458+++8EED~                ENDIF 
1459+++8EED~            	LD B,E
1460+++8EED~            	OUTI 
1461+++8EED~            	LD B,D
1462+++8EED~            	INC A
1463+++8EED~            	CP 13
1464+++8EED~            	JR NZ,LOUT
1465+++8EED~                IFDEF ONtfm
1466+++8EED~                INF 
1467+++8EED~                JP M,$-2
1468+++8EED~                ENDIF 
1469+++8EED~            	OUT (C),A
1470+++8EED~            	LD A,(HL)
1471+++8EED~            	AND A
1472+++8EED~            	RET M
1473+++8EED~                IFDEF ONtfm
1474+++8EED~                INF 
1475+++8EED~                JP M,$-2
1476+++8EED~                ENDIF 
1477+++8EED~            	LD B,E
1478+++8EED~            	OUT (C),A
1479+++8EED~            	RET
1480+++8EED~            1481+++8EED~            	IF ACBBAC
1482+++8EED~            CHTABLE	EQU $-4
1483+++8EED~            	DB 4,5,15,%001001,0,7,7,%100100
1484+++8EED~            	ENDIF
1485+++8EED~            1486+++8EED~            NT_DATA	DB (T_NEW_0-T1_)*2
1487+++8EED~            	DB TCNEW_0-T_
1488+++8EED~            	DB (T_OLD_0-T1_)*2+1
1489+++8EED~            	DB TCOLD_0-T_
1490+++8EED~            	DB (T_NEW_1-T1_)*2+1
1491+++8EED~            	DB TCNEW_1-T_
1492+++8EED~            	DB (T_OLD_1-T1_)*2+1
1493+++8EED~            	DB TCOLD_1-T_
1494+++8EED~            	DB (T_NEW_2-T1_)*2
1495+++8EED~            	DB TCNEW_2-T_
1496+++8EED~            	DB (T_OLD_2-T1_)*2
1497+++8EED~            	DB TCOLD_2-T_
1498+++8EED~            	DB (T_NEW_3-T1_)*2
1499+++8EED~            	DB TCNEW_3-T_
1500+++8EED~            	DB (T_OLD_3-T1_)*2
1501+++8EED~            	DB TCOLD_3-T_
1502+++8EED~            1503+++8EED~            T_
1504+++8EED~            1505+++8EED~            TCOLD_0	DB #00+1,#04+1,#08+1,#0A+1,#0C+1,#0E+1,#12+1,#14+1
1506+++8EED~            	DB #18+1,#24+1,#3C+1,0
1507+++8EED~            TCOLD_1	DB #5C+1,0
1508+++8EED~            TCOLD_2	DB #30+1,#36+1,#4C+1,#52+1,#5E+1,#70+1,#82,#8C,#9C
1509+++8EED~            	DB #9E,#A0,#A6,#A8,#AA,#AC,#AE,#AE,0
1510+++8EED~            TCNEW_3	DB #56+1
1511+++8EED~            TCOLD_3	DB #1E+1,#22+1,#24+1,#28+1,#2C+1,#2E+1,#32+1,#BE+1,0
1512+++8EED~            TCNEW_0	DB #1C+1,#20+1,#22+1,#26+1,#2A+1,#2C+1,#30+1,#54+1
1513+++8EED~            	DB #BC+1,#BE+1,0
1514+++8EED~            TCNEW_1 EQU TCOLD_1
1515+++8EED~            TCNEW_2	DB #1A+1,#20+1,#24+1,#28+1,#2A+1,#3A+1,#4C+1,#5E+1
1516+++8EED~            	DB #BA+1,#BC+1,#BE+1,0
1517+++8EED~            1518+++8EED~            PT3EMPTYORN EQU $-1
1519+++8EED~            	DB 1,0
1520+++8EED~            1521+++8EED~            ;first 12 values of tone tables (packed)
1522+++8EED~            1523+++8EED~            T_PACK	DB #06EC*2/256,#06EC*2&255
1524+++8EED~            	DB #0755-#06EC
1525+++8EED~            	DB #07C5-#0755
1526+++8EED~            	DB #083B-#07C5
1527+++8EED~            	DB #08B8-#083B
1528+++8EED~            	DB #093D-#08B8
1529+++8EED~            	DB #09CA-#093D
1530+++8EED~            	DB #0A5F-#09CA
1531+++8EED~            	DB #0AFC-#0A5F
1532+++8EED~            	DB #0BA4-#0AFC
1533+++8EED~            	DB #0C55-#0BA4
1534+++8EED~            	DB #0D10-#0C55
1535+++8EED~            	DB #066D*2/256,#066D*2&255
1536+++8EED~            	DB #06CF-#066D
1537+++8EED~            	DB #0737-#06CF
1538+++8EED~            	DB #07A4-#0737
1539+++8EED~            	DB #0819-#07A4
1540+++8EED~            	DB #0894-#0819
1541+++8EED~            	DB #0917-#0894
1542+++8EED~            	DB #09A1-#0917
1543+++8EED~            	DB #0A33-#09A1
1544+++8EED~            	DB #0ACF-#0A33
1545+++8EED~            	DB #0B73-#0ACF
1546+++8EED~            	DB #0C22-#0B73
1547+++8EED~            	DB #0CDA-#0C22
1548+++8EED~            	DB #0704*2/256,#0704*2&255
1549+++8EED~            	DB #076E-#0704
1550+++8EED~            	DB #07E0-#076E
1551+++8EED~            	DB #0858-#07E0
1552+++8EED~            	DB #08D6-#0858
1553+++8EED~            	DB #095C-#08D6
1554+++8EED~            	DB #09EC-#095C
1555+++8EED~            	DB #0A82-#09EC
1556+++8EED~            	DB #0B22-#0A82
1557+++8EED~            	DB #0BCC-#0B22
1558+++8EED~            	DB #0C80-#0BCC
1559+++8EED~            	DB #0D3E-#0C80
1560+++8EED~            	DB #07E0*2/256,#07E0*2&255
1561+++8EED~            	DB #0858-#07E0
1562+++8EED~            	DB #08E0-#0858
1563+++8EED~            	DB #0960-#08E0
1564+++8EED~            	DB #09F0-#0960
1565+++8EED~            	DB #0A88-#09F0
1566+++8EED~            	DB #0B28-#0A88
1567+++8EED~            	DB #0BD8-#0B28
1568+++8EED~            	DB #0C80-#0BD8
1569+++8EED~            	DB #0D60-#0C80
1570+++8EED~            	DB #0E10-#0D60
1571+++8EED~            	DB #0EF8-#0E10
1572+++8EED~            1573+++8EED~            ;vars from here can be stripped
1574+++8EED~            ;you can move VARS to any other address
1575+++8EED~            1576+++8EED~            VARS
1577+++8EED~            1578+++8EED~            is_ts	DB 0
1579+++8EED~            1580+++8EED~            ;ChannelsVars
1581+++8EED~            	STRUCT	CHP
1582+++8EED~            ;reset group
1583+++8EED~            PsInOr	DB 0
1584+++8EED~            PsInSm	DB 0
1585+++8EED~            CrAmSl	DB 0
1586+++8EED~            CrNsSl	DB 0
1587+++8EED~            CrEnSl	DB 0
1588+++8EED~            TSlCnt	DB 0
1589+++8EED~            CrTnSl	DW 0
1590+++8EED~            TnAcc	DW 0
1591+++8EED~            COnOff	DB 0
1592+++8EED~            ;reset group
1593+++8EED~            1594+++8EED~            OnOffD	DB 0
1595+++8EED~            1596+++8EED~            ;IX for PTDECOD here (+12)
1597+++8EED~            OffOnD	DB 0
1598+++8EED~            OrnPtr	DW 0
1599+++8EED~            SamPtr	DW 0
1600+++8EED~            NNtSkp	DB 0
1601+++8EED~            Note	DB 0
1602+++8EED~            SlToNt	DB 0
1603+++8EED~            Env_En	DB 0
1604+++8EED~            Flags	DB 0
1605+++8EED~             ;Enabled - 0, SimpleGliss - 2
1606+++8EED~            TnSlDl	DB 0
1607+++8EED~            TSlStp	DW 0
1608+++8EED~            TnDelt	DW 0
1609+++8EED~            NtSkCn	DB 0
1610+++8EED~            Volume	DB 0
1611+++8EED~            	ENDS
1612+++8EED~            1613+++8EED~            	STRUCT	VRS
1614+++8EED~            1615+++8EED~            ;IF not works in STRUCT in SjASM :(
1616+++8EED~            ;	IF CurPosCounter
1617+++8EED~            CurPos	DB 0
1618+++8EED~            PosSub	DB 0
1619+++8EED~            ;	ENDIF
1620+++8EED~            1621+++8EED~            ModNum	DB 0 ;bit0: ChipNum
1622+++8EED~            	     ;bit1: 1-reversed patterns order (AlCo TS)
1623+++8EED~            1624+++8EED~            ChanA	DS CHP
1625+++8EED~            ChanB	DS CHP
1626+++8EED~            ChanC	DS CHP
1627+++8EED~            1628+++8EED~            ;GlobalVars
1629+++8EED~            MODADDR	DW 0
1630+++8EED~            OrnPtrs	DW 0
1631+++8EED~            SamPtrs	DW 0
1632+++8EED~            PatsPtr	DW 0
1633+++8EED~            AdInPtA	DW 0
1634+++8EED~            AdInPtB	DW 0
1635+++8EED~            AdInPtC	DW 0
1636+++8EED~            CrPsPtr	DW 0
1637+++8EED~            LPosPtr	DW 0
1638+++8EED~            Delay	DB 0
1639+++8EED~            DelyCnt	DB 0
1640+++8EED~            ESldAdd	DW 0
1641+++8EED~            CurESld	DW 0
1642+++8EED~            Env_Del	DB 0
1643+++8EED~            CurEDel	DB 0
1644+++8EED~            Ns_Base	DB 0
1645+++8EED~            AddToNs	DB 0
1646+++8EED~            AddToEn	DB 0
1647+++8EED~            EnvBase	DW 0
1648+++8EED~            AYREGS	DS 14
1649+++8EED~            	ENDS
1650+++8EED~            1651+++8EED~            VARS1	DS VRS
1652+++8EED~            VARS2	DS VRS
1653+++8EED~            1654+++8EED~            VT_	EQU $-16
1655+++8EED~            	DS 256-16 ;CreatedVolumeTableAddress
1656+++8EED~            1657+++8EED~            T1_	EQU VT_+16 ;Tone tables data depacked here
1658+++8EED~            1659+++8EED~            T_OLD_1	EQU T1_
1660+++8EED~            T_OLD_2	EQU T_OLD_1+24
1661+++8EED~            T_OLD_3	EQU T_OLD_2+24
1662+++8EED~            T_OLD_0	EQU T_OLD_3+2
1663+++8EED~            T_NEW_0	EQU T_OLD_0
1664+++8EED~            T_NEW_1	EQU T_OLD_1
1665+++8EED~            T_NEW_2	EQU T_NEW_0+24
1666+++8EED~            T_NEW_3	EQU T_OLD_3
1667+++8EED~            1668+++8EED~            PT2EMPTYORN EQU VT_+31 ;1,0,0 sequence
1669+++8EED~            1670+++8EED~            NT_	DS 192 ;CreatedNoteTableAddress
1671+++8EED~            1672+++8EED~            VAR0END	EQU VT_+16 ;INIT zeroes from VARS to VAR0END-1
1673+++8EED~            1674+++8EED~            VARSEND EQU $
1675+++8EED~            MDLADDR EQU $
1676+++8EED~            1677+++8EED~                   DISPLAY "PTS player size=",$-START
1678+++8EED~            1679+++8EED~            ;Release 0 steps:
1680+++8EED~            ;04/21/2007
1681+++8EED~            ;Works start (PTxPlay adaptation); first beta.
1682+++8EED~            ;04/22/2007
1683+++8EED~            ;Job finished; beta-testing.
1684+++8EED~            ;04/23/2007
1685+++8EED~            ;PT v3.7 TS mode corrected (after AlCo remarks).
1686+++8EED~            ;04/29/2007
1687+++8EED~            ;Added 1.XX and 2.XX special commands interpretation for PT3
1688+++8EED~            ;modules of v3.7+.
1689+++8EED~            1690+++8EED~            ;Size (minimal build for ZX Spectrum):
1691+++8EED~            ;Code block #908 bytes
1692+++8EED~            ;Variables #2BF bytes (can be stripped)
1693+++8EED~            ;Total size #908+#2BF=#BC7 (3015) bytes
1694+++8EED~            1695+++8EED~                   ENDMOD
1696+++8EED~            1697+++8EED                    endif
1698+++8EED             
0095++ 8EED             
0096++ 8EED             TS.End    
0097++ 8EED             TS.Play=PTS.PLAY
0098++ 8EED             TS.Mute=PTS.MUTE        
0099++ 8EED             
0100++ 8EED                     display "TS module size: ",TS.End-TS.Start
0101++ 8EED             
0102++ 8EED                     endif
0103++ 8EED             
0416+  8EED                     include "tfc.asm"
0001++ 8EED                     ifndef _tfc_asm_defined
0002++ 8EED                     define _tfc_asm_defined
0003++ 8EED             
0004++ 8EED                     module TFC
0005++ 8EED                     
0006++ 8EED             ; Original version by (C) Alone Coder
0007++ 8EED             ; SjasmPlus adaptation, code cleanup and size optimization by (C) Vitamin/CAIG
0008++ 8EED             
0009++ 8EED             ; Warning: no 60Hz modules support!
0010++ 8EED                     
0011++ 8EED             ;TODO begin&end    
0012++ 8EED             newtfm=1 ;0=revision A, 1=revision C
0013++ 8EED             
0014++ 8EED                     if newtfm == 1
0015++ 8EED             statuschip0=%11111000
0016++ 8EED             statuschip1=%11111001
0017++ 8EED                     else
0018++ 8EED~                    if newtfm == 2 ;US031DX
0019++ 8EED~            statuschip0=%11111110
0020++ 8EED~            statuschip1=%11111111
0021++ 8EED~                    else ;newtfm=0
0022++ 8EED~            statuschip0=%11111100
0023++ 8EED~            statuschip1=%11111101
0024++ 8EED~                    endif
0025++ 8EED                     endif 
0026++ 8EED                    
0027++ 8EED                     struct Header
0028++ 8EED~            signature
0029++ 8EED~                    ds 6
0030++ 8EED~            version ds 3        
0031++ 8EED~            intfreq db 0
0032++ 8EED~            tfmptrs ds 12
0033++ 8EED~            ssgptrs ds 12
0034++ 8EED                     ends
0035++ 8EED             
0036++ 8EED                     struct TFMData
0037++ 8EED~            addr    dw 0
0038++ 8EED~            skip    db 0
0039++ 8EED~            blkcnt  db 0
0040++ 8EED~            blkretaddr
0041++ 8EED~                    db 0
0042++ 8EED~            loopaddr
0043++ 8EED~                    db 0        
0044++ 8EED~            tfmlow  db 0
0045++ 8EED~            tfmhigh db 0        
0046++ 8EED                     ends
0047++ 8EED                     
0048++ 8EED                     macro WaitStatus
0049++ 8EED~                    if newtfm != 2
0050++ 8EED~                    inf
0051++ 8EED~                    jp m,$-2
0052++ 8EED~                    endif 
0053++ 8EED                     endm
0054++ 8EED                     
0055++ 8EED                     macro FM.OutReg Reg
0056++ 8EED~                    WaitStatus
0057++ 8EED~                    out (c),Reg
0058++ 8EED                     endm
0059++ 8EED             
0060++ 8EED                     macro FM.SelectReg Reg
0061++ 8EED~                    ld b,d
0062++ 8EED~                    FM.OutReg Reg
0063++ 8EED                     endm
0064++ 8EED                     
0065++ 8EED                     macro FM.WriteReg Reg
0066++ 8EED~                    ld b,e
0067++ 8EED~                    FM.OutReg Reg
0068++ 8EED                     endm
0069++ 8EED             
0070++ 8EED             Start
0071++ 8EED 21 66 91            ld hl,End
0072++ 8EF0 18 2F               jr Init
0073++ 8EF2 C3 D4 8F            jp Play
0074++ 8EF5 C3 5D 8F            jp Mute
0075++ 8EF8             
0076++ 8EF8                     ifdef HaveFormatCheck
0077++ 8EF8                     include "format.asm"
0001+++8EF8             ;some format checking macros
0002+++8EF8                     ifndef _format_asm_defined
0003+++8EF8~                    define _format_asm_defined
0004+++8EF8~            0005+++8EF8~                    macro LessOrEqual number
0006+++8EF8~                    ld a,number
0007+++8EF8~                    cp (hl)
0008+++8EF8~                    inc hl
0009+++8EF8~                    ret c
0010+++8EF8~                    endm
0011+++8EF8~                    
0012+++8EF8~                    macro Greater number
0013+++8EF8~                    ld a,(hl)
0014+++8EF8~                    inc hl
0015+++8EF8~                    cp number
0016+++8EF8~                    ret c
0017+++8EF8~                    endm
0018+++8EF8~                    
0019+++8EF8~                    macro AnyByte
0020+++8EF8~                    inc hl
0021+++8EF8~                    endm
0022+++8EF8~                    
0023+++8EF8~                    macro AnyBytes count
0024+++8EF8~                    if count > 7
0025+++8EF8~                    ld a,l
0026+++8EF8~                    add a,count
0027+++8EF8~                    ld l,a
0028+++8EF8~                    adc a,h
0029+++8EF8~                    sub l
0030+++8EF8~                    ld h,a
0031+++8EF8~                    else
0032+++8EF8~                    dup count
0033+++8EF8~                    inc hl
0034+++8EF8~                    edup
0035+++8EF8~                    endif
0036+++8EF8~                    endm
0037+++8EF8~                    
0038+++8EF8~                    macro EqualTo number
0039+++8EF8~                    ld a,number
0040+++8EF8~                    cp (hl)
0041+++8EF8~                    inc hl
0042+++8EF8~                    ret nz
0043+++8EF8~                    endm
0044+++8EF8~            0045+++8EF8                     endif
0046+++8EF8             
0078++ 8EF8                     
0079++ 8EF8             ;in HL - module addr
0080++ 8EF8             ;out Z - is tfc
0081++ 8EF8             ;out C - 60 Hz (valid only if Z)
0082++ 8EF8             CheckFormat
0083++ 8EF8                     EqualTo "T"
0083++ 8EF8 3E 54       >        ld a,number
0083++ 8EFA BE          >        cp (hl)
0083++ 8EFB 23          >        inc hl
0083++ 8EFC C0          >        ret nz
0084++ 8EFD                     EqualTo "F"
0084++ 8EFD 3E 46       >        ld a,number
0084++ 8EFF BE          >        cp (hl)
0084++ 8F00 23          >        inc hl
0084++ 8F01 C0          >        ret nz
0085++ 8F02                     EqualTo "M"
0085++ 8F02 3E 4D       >        ld a,number
0085++ 8F04 BE          >        cp (hl)
0085++ 8F05 23          >        inc hl
0085++ 8F06 C0          >        ret nz
0086++ 8F07                     EqualTo "c"
0086++ 8F07 3E 63       >        ld a,number
0086++ 8F09 BE          >        cp (hl)
0086++ 8F0A 23          >        inc hl
0086++ 8F0B C0          >        ret nz
0087++ 8F0C                     EqualTo "o"
0087++ 8F0C 3E 6F       >        ld a,number
0087++ 8F0E BE          >        cp (hl)
0087++ 8F0F 23          >        inc hl
0087++ 8F10 C0          >        ret nz
0088++ 8F11                     EqualTo "m"
0088++ 8F11 3E 6D       >        ld a,number
0088++ 8F13 BE          >        cp (hl)
0088++ 8F14 23          >        inc hl
0088++ 8F15 C0          >        ret nz
0089++ 8F16                     AnyBytes 3
0090++ 8F16 23          >        inc hl
0090++ 8F17 23          >        inc hl
0090++ 8F18 23          >        inc hl
0090++ 8F19 7E                  ld a,(hl)
0091++ 8F1A FE 32               cp 50
0092++ 8F1C C8                  ret z
0093++ 8F1D FE 3C               cp 60
0094++ 8F1F 3F                  ccf
0095++ 8F20 C9                  ret
0096++ 8F21                     
0097++ 8F21                     display "TFC checker size: ",$-CheckFormat
0098++ 8F21                     endif
0099++ 8F21                     
0100++ 8F21             ;HL - module addr
0101++ 8F21             Init
0102++ 8F21 EB                  exd
0103++ 8F22 21 0A 00            ld hl,Header.tfmptrs
0104++ 8F25 19                  add hl,de
0105++ 8F26 D9                  exx 
0106++ 8F27             
0107++ 8F27 21 2E 91            ld hl,TFM.Init
0108++ 8F2A 11 36 91            ld de,TFM.A
0109++ 8F2D 01 30 00            ld bc,6*TFMData
0110++ 8F30 ED B0               ldir
0111++ 8F32             
0112++ 8F32 21 51 8F            ld hl,.tfminitab
0113++ 8F35 01 FD 06            ld bc,128*(.tfminitab_end-.tfminitab)+#fd
0114++ 8F38             .tfmini0
0115++ 8F38 11 47 8F            ld de,.tfminiHL
0116++ 8F3B ED A0               ldi 
0117++ 8F3D ED A0               ldi 
0118++ 8F3F D9                  exx 
0119++ 8F40 7E                  ld a,(hl)
0120++ 8F41 23                  inc hl
0121++ 8F42 E5                  push hl
0122++ 8F43 66                  ld h,(hl)
0123++ 8F44 6F                  ld l,a
0124++ 8F45 19                  add hl,de
0125++ 8F46             .tfminiHL=$+1
0126++ 8F46 22 00 00            ld (0),hl
0127++ 8F49 E1                  pop hl
0128++ 8F4A 23                  inc hl
0129++ 8F4B D9                  exx 
0130++ 8F4C 10 EA               djnz .tfmini0
0131++ 8F4E             
0132++ 8F4E C3 5D 8F            jp Mute
0133++ 8F51                     
0134++ 8F51             .tfminitab
0135++ 8F51 36 91               DW TFM.A.addr
0136++ 8F53 3E 91               DW TFM.B.addr
0137++ 8F55 46 91               DW TFM.C.addr
0138++ 8F57 4E 91               DW TFM.D.addr
0139++ 8F59 56 91               DW TFM.E.addr
0140++ 8F5B 5E 91               DW TFM.F.addr
0141++ 8F5D             .tfminitab_end       
0142++ 8F5D             
0143++ 8F5D             Mute
0144++ 8F5D 11 BF FF            ld de,#ffbf
0145++ 8F60 0E FD               ld c,#fd
0146++ 8F62 CD CC 8F            call selChip0
0147++ 8F65 CD 6B 8F            call .tfminiPP
0148++ 8F68 CD D0 8F            call selChip1
0149++ 8F6B             .tfminiPP
0150++ 8F6B                     ; 0 -> (00..0D)
0151++ 8F6B 21 00 00            ld hl,#0000
0152++ 8F6E 3E 0E               ld a,#0e
0153++ 8F70 CD B3 8F            call .writeregsset
0154++ 8F73                     
0155++ 8F73                     ; 0 -> (30..3F)
0156++ 8F73 26 30               ld h,#30
0157++ 8F75 3E 40               ld a,#40
0158++ 8F77 CD B3 8F            call .writeregsset
0159++ 8F7A                     
0160++ 8F7A                     ; 0 -> (50..B4)
0161++ 8F7A 26 50               ld h,#50
0162++ 8F7C 3E B5               ld a,#b5
0163++ 8F7E CD B3 8F            call .writeregsset
0164++ 8F81                     
0165++ 8F81                     ; 0F -> (80..8F) ;max speed to RR
0166++ 8F81 21 0F 80            ld hl,#800f
0167++ 8F84 3E 90               ld a,#90
0168++ 8F86 CD B3 8F            call .writeregsset
0169++ 8F89                     
0170++ 8F89                     ; 0..2 -> 28, key off
0171++ 8F89                     ; 2 -> 27 channel 3 mode
0172++ 8F89 21 00 28            ld hl,#2800
0173++ 8F8C CD BB 8F            call .writereg
0174++ 8F8F 2C                  inc l
0175++ 8F90 CD BB 8F            call .writereg
0176++ 8F93 2C                  inc l
0177++ 8F94 CD BB 8F            call .writereg
0178++ 8F97 25                  dec h
0179++ 8F98 CD BB 8F            call .writereg
0180++ 8F9B                     
0181++ 8F9B                     ; 7F -> (40..4F,2F,2D)
0182++ 8F9B 21 7F 40            ld hl,#407f
0183++ 8F9E 3E 50               ld a,#50
0184++ 8FA0 CD B3 8F            call .writeregsset
0185++ 8FA3                     
0186++ 8FA3 26 2F               ld h,#2f
0187++ 8FA5 CD BB 8F            call .writereg
0188++ 8FA8                     
0189++ 8FA8 26 2D               ld h,#2d
0190++ 8FAA CD BB 8F            call .writereg
0191++ 8FAD             
0192++ 8FAD 3E FF               ld a,#ff ;. FM
0193++ 8FAF             .selRegA
0194++ 8FAF 42                  ld b,d
0195++ 8FB0 ED 79               out (c),a
0196++ 8FB2 C9                  ret
0197++ 8FB3             
0198++ 8FB3             ;H=REG start
0199++ 8FB3             ;L=VALUE
0200++ 8FB3             ;A=REG end (not inclusive)
0201++ 8FB3             .writeregsset
0202++ 8FB3 CD BB 8F            call .writereg
0203++ 8FB6 24                  inc h
0204++ 8FB7 BC                  cp h
0205++ 8FB8 20 F9               jr nz,.writeregsset
0206++ 8FBA C9                  ret
0207++ 8FBB             ;H=REG
0208++ 8FBB             ;L=VALUE
0209++ 8FBB             .writereg
0210++ 8FBB                     FM.SelectReg h
0210++ 8FBB 42          >        ld b,d
0210++ 8FBC ED 70       >        inf
0210++ 8FBE FA BC 8F    >        jp m,$-2
0210++ 8FC1 ED 61       >        out (c),Reg
0211++ 8FC3                     FM.WriteReg l
0211++ 8FC3 43          >        ld b,e
0211++ 8FC4 ED 70       >        inf
0211++ 8FC6 FA C4 8F    >        jp m,$-2
0211++ 8FC9 ED 69       >        out (c),Reg
0212++ 8FCB C9                  ret
0213++ 8FCC             
0214++ 8FCC             selChip0
0215++ 8FCC 3E F8               ld a,statuschip0
0216++ 8FCE 18 DF               jr Mute.selRegA
0217++ 8FD0             
0218++ 8FD0             selChip1
0219++ 8FD0 3E F9               ld a,statuschip1
0220++ 8FD2 18 DB               jr Mute.selRegA
0221++ 8FD4             
0222++ 8FD4             Play
0223++ 8FD4 11 BF FF            ld de,#FFBF
0224++ 8FD7 0E FD               ld c,#FD
0225++ 8FD9             
0226++ 8FD9 CD CC 8F            call selChip0
0227++ 8FDC             
0228++ 8FDC AF                  xor a
0229++ 8FDD 08                  exa
0230++ 8FDE DD 21 36 91         ld ix,TFM.A
0231++ 8FE2 CD 19 90            call PlayChannel
0232++ 8FE5 3E 01               ld a,1
0233++ 8FE7 08                  exa
0234++ 8FE8 DD 21 3E 91         ld ix,TFM.B
0235++ 8FEC CD 19 90            call PlayChannel
0236++ 8FEF 3E 02               ld a,2
0237++ 8FF1 08                  exa
0238++ 8FF2 DD 21 46 91         ld ix,TFM.C
0239++ 8FF6 CD 19 90            call PlayChannel
0240++ 8FF9                     
0241++ 8FF9 CD D0 8F            call selChip1
0242++ 8FFC             
0243++ 8FFC AF                  xor a
0244++ 8FFD 08                  exa
0245++ 8FFE DD 21 4E 91         ld ix,TFM.D
0246++ 9002 CD 19 90            call PlayChannel
0247++ 9005 3E 01               ld a,1
0248++ 9007 08                  exa
0249++ 9008 DD 21 56 91         ld ix,TFM.E
0250++ 900C CD 19 90            call PlayChannel
0251++ 900F 3E 02               ld a,2
0252++ 9011 08                  exa
0253++ 9012 DD 21 5E 91         ld ix,TFM.F
0254++ 9016 C3 19 90            jp PlayChannel
0255++ 9019             
0256++ 9019             ;%11111111,-disp8 =      -disp8
0257++ 9019             ;%111ttttt = skip 32..2 frames
0258++ 9019             ;%110ddddd = slide d-16
0259++ 9019             ;%11010000,frames,-disp16 = repeat block (skips = 1 frame)
0260++ 9019             ;%10111111,-disp16 =      -disp16
0261++ 9019             ;%10NNNNNf = keyoff,[freq,]0..30 regs, keyon
0262++ 9019             ;%01111111 = end
0263++ 9019             ;%01111110 = begin
0264++ 9019             ;%01NNNNNf = keyoff,[freq,]0..31 regs
0265++ 9019             ;%00NNNNNf =        [freq,]0..30 regs
0266++ 9019             bb=%01111110
0267++ 9019             be=%01111111
0268++ 9019             ;IX - data
0269++ 9019             ;DE - hi ports #FFBF
0270++ 9019             ;C - low port #FD
0271++ 9019             ;A' - fm channel
0272++ 9019             PlayChannel
0273++ 9019 DD 7E 02            ld a,(ix+TFMData.skip)
0274++ 901C 3C                  inc a
0275++ 901D C2 DC 90            jp nz,.skiper
0276++ 9020 DD 7E 03            ld a,(ix+TFMData.blkcnt)
0277++ 9023 A7                  and a
0278++ 9024 28 1D               jr z,.noframe
0279++ 9026 DD 35 03            dec (ix+TFMData.blkcnt)
0280++ 9029 20 18               jr nz,.noframe
0281++ 902B DD 6E 04            ld l,(ix+TFMData.blkretaddr)
0282++ 902E DD 66 05            ld h,(ix+TFMData.blkretaddr+1)
0283++ 9031 18 16               jr .tfmframe
0284++ 9033             .begin
0285++ 9033 DD 75 05            ld (ix+TFMData.loopaddr),l
0286++ 9036 DD 74 06            ld (ix+TFMData.loopaddr+1),h
0287++ 9039 18 0E               jr .tfmframe
0288++ 903B             .end
0289++ 903B DD 6E 05            ld l,(ix+TFMData.loopaddr)
0290++ 903E DD 66 06            ld h,(ix+TFMData.loopaddr+1)
0291++ 9041 18 06               jr .tfmframe
0292++ 9043             .noframe        
0293++ 9043 DD 6E 00            ld l,(ix+TFMData.addr)
0294++ 9046 DD 66 01            ld h,(ix+TFMData.addr+1)
0295++ 9049             .tfmframe
0296++ 9049 7E                  ld a,(hl)
0297++ 904A 23                  inc hl
0298++ 904B FE 7E               cp bb
0299++ 904D 28 E4               jr z,.begin
0300++ 904F FE 7F               cp be
0301++ 9051 28 E8               jr z,.end
0302++ 9053 BB                  cp e ;#BF
0303++ 9054 D2 CF 90            jp NC,.HLskiper
0304++ 9057             ;TestKeyOff
0305++ 9057 F2 70 90            jp P,.noffX
0306++ 905A F5                  push af
0307++ 905B 3E 28               ld a,#28
0308++ 905D                     FM.SelectReg a
0308++ 905D 42          >        ld b,d
0308++ 905E ED 70       >        inf
0308++ 9060 FA 5E 90    >        jp m,$-2
0308++ 9063 ED 79       >        out (c),Reg
0309++ 9065 08                  exa
0310++ 9066                     FM.WriteReg a ;FMChannel
0310++ 9066 43          >        ld b,e
0310++ 9067 ED 70       >        inf
0310++ 9069 FA 67 90    >        jp m,$-2
0310++ 906C ED 79       >        out (c),Reg
0311++ 906E 08                  exa 
0312++ 906F F1                  pop af
0313++ 9070             .noffX
0314++ 9070 B7                  OR a
0315++ 9071 F5                  push af
0316++ 9072             ;TestFreq
0317++ 9072 1F                  RRA 
0318++ 9073 30 12               jr NC,.nofrqX
0319++ 9075             
0320++ 9075 46                  ld b,(hl)
0321++ 9076 23                  inc hl
0322++ 9077 4E                  ld c,(hl)
0323++ 9078 23                  inc hl
0324++ 9079 DD 70 07            ld (ix+TFMData.tfmhigh),b
0325++ 907C DD 71 06            ld (ix+TFMData.tfmlow),c
0326++ 907F C5                  push bc
0327++ 9080 E3                  ex (sp),hl
0328++ 9081 0E FD               ld c,#FD
0329++ 9083 CD F1 90            call .outTone
0330++ 9086 E1                  pop hl
0331++ 9087             
0332++ 9087             .nofrqX
0333++ 9087 E6 1F               and #1F
0334++ 9089 C4 1A 91            call nz,.OutRegs
0335++ 908C CD C8 90            call .storeaddr
0336++ 908F F1                  pop af
0337++ 9090 F0                  ret P
0338++ 9091             ;.KeyOn        
0339++ 9091 3E 28               ld a,#28
0340++ 9093                     FM.SelectReg a
0340++ 9093 42          >        ld b,d
0340++ 9094 ED 70       >        inf
0340++ 9096 FA 94 90    >        jp m,$-2
0340++ 9099 ED 79       >        out (c),Reg
0341++ 909B 08                  exa
0342++ 909C C6 F0               add a,#F0
0343++ 909E                     FM.WriteReg a
0343++ 909E 43          >        ld b,e
0343++ 909F ED 70       >        inf
0343++ 90A1 FA 9F 90    >        jp m,$-2
0343++ 90A4 ED 79       >        out (c),Reg
0344++ 90A6 D6 F0               sub #F0
0345++ 90A8 08                  exa
0346++ 90A9 C9                  ret 
0347++ 90AA             
0348++ 90AA             .block
0349++ 90AA 7E                  ld a,(hl) ;N frames
0350++ 90AB                               ;1 now, N-1 later
0351++ 90AB                               ;skip command is used as 1 frame
0352++ 90AB 23                  inc hl
0353++ 90AC DD 77 03            ld (ix+TFMData.blkcnt),a
0354++ 90AF 46                  ld b,(hl)
0355++ 90B0 23                  inc hl
0356++ 90B1 4E                  ld c,(hl) ;disp
0357++ 90B2 23                  inc hl
0358++ 90B3 DD 75 04            ld (ix+TFMData.blkretaddr),l
0359++ 90B6 DD 74 05            ld (ix+TFMData.blkretaddr+1),h
0360++ 90B9             .subframe        
0361++ 90B9 09                  add hl,bc
0362++ 90BA 0E FD               ld c,#fd
0363++ 90BC C3 49 90            jp .tfmframe
0364++ 90BF             
0365++ 90BF             .OLDfar
0366++ 90BF 46                  ld b,(hl)
0367++ 90C0 23                  inc hl
0368++ 90C1             .OLDnear
0369++ 90C1 4E                  ld c,(hl)
0370++ 90C2 23                  inc hl
0371++ 90C3 E5                  push hl
0372++ 90C4 CD B9 90            call .subframe
0373++ 90C7 E1                  pop hl
0374++ 90C8             .storeaddr        
0375++ 90C8 DD 75 00            ld (ix+TFMData.addr),l
0376++ 90CB DD 74 01            ld (ix+TFMData.addr+1),h
0377++ 90CE C9                  ret 
0378++ 90CF             .HLskiper
0379++ 90CF 28 EE               jr z,.OLDfar
0380++ 90D1 FE E0               cp %11100000
0381++ 90D3 38 0B               jr c,.slide
0382++ 90D5 47                  ld b,a
0383++ 90D6 BA                  cp d ;#FF
0384++ 90D7 28 E8               jr z,.OLDnear
0385++ 90D9 CD C8 90            call .storeaddr
0386++ 90DC DD 77 02    .skiper ld (ix+TFMData.skip),a
0387++ 90DF C9                  ret
0388++ 90E0             .slide
0389++ 90E0                    ;a=-64..-33
0390++ 90E0 C6 30               add a,48
0391++ 90E2                    ;a=-16..15
0392++ 90E2 28 C6               jr z,.block
0393++ 90E4 DD 86 06            add a,(ix+TFMData.tfmlow)
0394++ 90E7 DD 77 06            ld (ix+TFMData.tfmlow),a
0395++ 90EA CD C8 90            call .storeaddr
0396++ 90ED DD 66 07            ld h,(ix+TFMData.tfmhigh)
0397++ 90F0 6F                  ld l,a
0398++ 90F1             .outTone
0399++ 90F1 08                  exa
0400++ 90F2 C6 A4               add a,#a4
0401++ 90F4                     FM.SelectReg a
0401++ 90F4 42          >        ld b,d
0401++ 90F5 ED 70       >        inf
0401++ 90F7 FA F5 90    >        jp m,$-2
0401++ 90FA ED 79       >        out (c),Reg
0402++ 90FC                     FM.WriteReg h
0402++ 90FC 43          >        ld b,e
0402++ 90FD ED 70       >        inf
0402++ 90FF FA FD 90    >        jp m,$-2
0402++ 9102 ED 61       >        out (c),Reg
0403++ 9104 D6 04               sub #04  ;#A0+channel
0404++ 9106                     FM.SelectReg a
0404++ 9106 42          >        ld b,d
0404++ 9107 ED 70       >        inf
0404++ 9109 FA 07 91    >        jp m,$-2
0404++ 910C ED 79       >        out (c),Reg
0405++ 910E                     FM.WriteReg l
0405++ 910E 43          >        ld b,e
0405++ 910F ED 70       >        inf
0405++ 9111 FA 0F 91    >        jp m,$-2
0405++ 9114 ED 69       >        out (c),Reg
0406++ 9116 D6 A0               sub #a0
0407++ 9118 08                  exa
0408++ 9119 C9                  ret 
0409++ 911A             
0410++ 911A 42          .OutRegs ld b,d ;%11111xxx
0411++ 911B                     WaitStatus
0411++ 911B ED 70       >        inf
0411++ 911D FA 1B 91    >        jp m,$-2
0412++ 9120 ED A3               outi   ;reg
0413++ 9122                     WaitStatus
0413++ 9122 ED 70       >        inf
0413++ 9124 FA 22 91    >        jp m,$-2
0414++ 9127 43                  ld b,e ;#BF
0415++ 9128 ED A3               outi   ;value
0416++ 912A 3D                  dec a
0417++ 912B 20 ED               jr nz,.OutRegs ; turbo jr=jp
0418++ 912D C9                  ret 
0419++ 912E             
0420++ 912E             TFM.Init TFMData 0,-1,0
0420++ 912E 0000FF0000000000
0421++ 9136             TFM.A  TFMData        
0421++ 9136 0000000000000000
0422++ 913E             TFM.B  TFMData
0422++ 913E 0000000000000000
0423++ 9146             TFM.C  TFMData
0423++ 9146 0000000000000000
0424++ 914E             TFM.D  TFMData
0424++ 914E 0000000000000000
0425++ 9156             TFM.E  TFMData
0425++ 9156 0000000000000000
0426++ 915E             TFM.F  TFMData
0426++ 915E 0000000000000000
0427++ 9166             
0428++ 9166                    endmod
0429++ 9166             TFC.End
0430++ 9166                    
0431++ 9166                    display "TFC module size: ",TFC.End-TFC.Start
0432++ 9166                    
0433++ 9166                    endif
0434++ 9166             
0417+  9166             MTC.End        
0418+  9166                     display "MTC module size: ",MTC.End-MTC.Start
0419+  9166             
0420+  9166                     endif
0421+  9166             
0013   9166             
0014   9166             module      
0015   9166                   ;incbin MTC_CYBERMOTION
0016   9166                   ;incbin MTC_DRUMTEST
0017   9166                   ;incbin MTC_MUG
0018   9166                   incbin MTC_MYSTICAL
0019   B4FE                   ;incbin MTC_NEWOLD
0020   B4FE                   ;incbin MTC_SNEGURKA
0021   B4FE             
0022   B4FE                   savesna "test_mtc.sna",begin
0023   B4FE                   savebin "../mtc_8000.bin",player,module-player
0024   B4FE             

Value    Label
------ - -----------------------------------------------------------
0x6000   begin
0x8000   init
0x600D   begin.loop
0x6014   begin.delay
0x8005   play
0x8008   mute
0x602C X begin.fail
0x8000   player
0x0005 X MTC.StreamType
0x0000   MTC.StreamType.PT3
0x0001   MTC.StreamType.PT2
0x0002   MTC.StreamType.TS
0x0003   MTC.StreamType.TFC
0x0004   MTC.StreamType.Unknown
0x000B   MTC.StreamData
0x0000   MTC.StreamData.Type
0x0001   MTC.StreamData.Data1
0x0003   MTC.StreamData.Data2
0x0005   MTC.StreamData.Init
0x0007   MTC.StreamData.Play
0x0009   MTC.StreamData.Mute
0x8000   MTC.Start
0x9166   MTC.End
0x800B   MTC.Init
0x8048   MTC.Play
0x8066   MTC.Mute
0x80C1   MTC.Streams
0x8086   MTC.ParseChunk
0x0000   MTC.ChunkId.MTC1
0x811C   MTC.ParseMTC1
0x81DD   MTC.MergeStreams
0x8022   MTC.Init.initstreams
0x8084   MTC.jp_bc
0x804C   MTC.Play.playstreams
0x806A   MTC.Mute.mutestreams
0x8100   MTC.Chunks
0x8089   MTC.ParseChunk.checkid
0x80B2   MTC.ParseChunk.matched
0x001C   MTC.ChunkId.Unknown
0x80B4   MTC.ParseChunk.getdata
0x0003   MTC.MinStreamsCount
0x80E2   MTC.Streams.End
0x8100 X MTC.ChunkId
0x0004   MTC.ChunkId.TRCK
0x0008   MTC.ChunkId.DATA
0x000C X MTC.ChunkId.NAME
0x0010 X MTC.ChunkId.AUTH
0x0014 X MTC.ChunkId.ANNO
0x0018 X MTC.ChunkId.PROP
0x0005   MTC.MaxStreamsCount
0x811F   MTC.ParseMTC1.nextchunk
0x8134   MTC.ParseTrack
0x8137   MTC.ParseTrack.nextchunk
0x814D   MTC.ParseData
0x8159   MTC.ParseTFC
0x817B   MTC.ParseTS
0x8188   MTC.ParsePT2
0x819B   MTC.ParsePT3
0x8EF8   TFC.CheckFormat
0x8F21   TFC.Init
0x8FD4   TFC.Play
0x8F5D   TFC.Mute
0x81BA   MTC.FillStream
0x8170   MTC.AddStream
0x8EC0   TS.CheckFormatKnownSize
0x81AE   MTC.FillTS
0x8E6F   PT2.CheckFormat
0x8E6A   PT2.Init
0x81B4   MTC.FillPts
0x8E23   PT3.CheckFormat
0x8E1E   PT3.Init
0x8EAA   TS.Init
0x8A7F   PTS.PLAY
0x8251   PTS.MUTE
0x81E9   MTC.Sort
0x81F1   MTC.Sort.cycle
0x8210   MTC.Sort.end
0x8209   MTC.Sort.next
0x81FD   MTC.Sort.swapitems
0x8214 X MTC.Merge
0x821A   MTC.Merge.cycle
0x8228   MTC.Merge.perform
0x8241   MTC.Merge.generic
0x8243   MTC.Merge.copyitems
0x0030 X PTS.Release
0x0000   PTS.CurPosCounter
0x0000   PTS.ACBBAC
0x0000   PTS.LoopChecker
0x0000   PTS.Id
0x0000   PTS.Basic
0x0000   PTS.TonA
0x0002   PTS.TonB
0x0004   PTS.TonC
0x0006   PTS.Noise
0x0007   PTS.Mixer
0x0008   PTS.AmplA
0x0009   PTS.AmplB
0x000A   PTS.AmplC
0x000B   PTS.Env
0x000D   PTS.EnvTp
0x8250   PTS.START
0x0001 X PTS.SETUP.NOLOOP
0x0002   PTS.SETUP.PT2
0x0004 X PTS.SETUP.ACB
0x0008 X PTS.SETUP.BAC
0x0010   PTS.SETUP.TS02
0x0020   PTS.SETUP.TSPT3
0x8250   PTS.SETUP
0x8B60   PTS.VARS1
0x0079   PTS.VRS.AYREGS
0x8BE7   PTS.VARS2
0x8A93   PTS.ROUT
0x8263   PTS.INIT
0x8B5F   PTS.VARS
0x8C6E   PTS.VAR0END
0x0062   PTS.VRS.AdInPtA
0x830C   PTS.I_PT2
0x8455   PTS.INITPT3
0x8849   PTS.e_
0x8828   PTS.SamCnv
0x87F3   PTS.OrnCP
0x881F   PTS.SamCP
0x87F6   PTS.OrnLD
0x8822   PTS.SamLD
0x8819   PTS.SamClc2
0x82B0   PTS.L20
0x82B2   PTS.L21
0x86C6   PTS.Version
0x8301   PTS.NOTS
0x82F5   PTS.TwoPT3s
0x0087   PTS.VRS
0x0002   PTS.VRS.ModNum
0x898A   PTS.TSSub
0x82F8   PTS.AlCoTS_
0x8B5F   PTS.is_ts
0x8612   PTS.PT3PD
0x8B27   PTS.PT3EMPTYORN
0x8354   PTS.INITCOMMON
0x848D   PTS.INITPT2
0x834B   PTS.NOTS2
0x854C   PTS.PT2PD
0x8C7D   PTS.PT2EMPTYORN
0x84FD   PTS.PTDEC
0x898C   PTS.PsCalc
0x8B2A   PTS.T_PACK
0x8C6E   PTS.T1_
0x8362   PTS.TP_0
0x836E   PTS.TP_1
0x8375   PTS.TP_2
0x006D   PTS.VRS.DelyCnt
0x0003   PTS.VRS.ChanA
0x001B   PTS.CHP.NtSkCn
0x0020   PTS.VRS.ChanB
0x003D   PTS.VRS.ChanC
0x000D   PTS.CHP.OrnPtr
0x8AD7   PTS.NT_DATA
0x83E6   PTS.L3
0x8AE7   PTS.T_
0x8D5E   PTS.NT_
0x83D5   PTS.L1
0x83E2   PTS.L2
0x8AF3   PTS.TCOLD_1
0x8407   PTS.CORR_1
0x841C   PTS.TC_EXIT
0x8415   PTS.CORR_2
0x842B   PTS.M1
0x843C   PTS.M2
0x8C5E   PTS.VT_
0x8434   PTS.INITV2
0x843B   PTS.INITV1
0x844F   PTS.M3
0x84C8   PTS.SETMDAD
0x006C   PTS.VRS.Delay
0x84D6   PTS.SETCPPT
0x84DD   PTS.SETLPPT
0x84C1   PTS.SETPTPT
0x84CF   PTS.SETORPT
0x8486   PTS.SETSMPT
0x005E   PTS.VRS.SamPtrs
0x0060   PTS.VRS.PatsPtr
0x005A   PTS.VRS.MODADDR
0x005C   PTS.VRS.OrnPtrs
0x0068   PTS.VRS.CrPsPtr
0x006A   PTS.VRS.LPosPtr
0x84E4   PTS.SETENBS
0x0077   PTS.VRS.EnvBase
0x84EB   PTS.SETESLD
0x0070   PTS.VRS.CurESld
0x84F2   PTS.GETIX
0x84F9   PTS.PTDECOD
0x84FF   PTS.PD2_SAM
0x8795   PTS.SETSAM
0x854E   PTS.PD2_LOOP
0x8504   PTS.PD2_EOff
0x0014   PTS.CHP.Env_En
0x8509   PTS.PD2_ENV
0x851B   PTS.PD2_ORN
0x8776   PTS.SETORN
0x8520   PTS.PD2_SKIP
0x0011   PTS.CHP.NNtSkp
0x8526   PTS.PD2_VOL
0x001C   PTS.CHP.Volume
0x852F   PTS.PD2_DEL
0x8746   PTS.C_DELAY
0x8534   PTS.PD2_GLIS
0x0015   PTS.CHP.Flags
0x0016   PTS.CHP.TnSlDl
0x0005   PTS.CHP.TSlCnt
0x0017   PTS.CHP.TSlStp
0x854D   PTS.PD2_LP2
0x8593   PTS.PD2_REL
0x8598   PTS.PD2_NOTE
0x8675   PTS.PD_FIN
0x8583   PTS.PD2_PORT
0x858E   PTS.PD2_STOP
0x0003   PTS.CHP.CrNsSl
0x85C4   PTS.PD2_EXIT
0x0012   PTS.CHP.Note
0x86AE   PTS.PrNote
0x85C3   PTS.NOGLIS2
0x85BF   PTS.NOPORT2
0x86D5   PTS.LoStep
0x8690   PTS.SETPORT
0x0001   PTS.CHP.PsInSm
0x0000   PTS.CHP.PsInOr
0x0006   PTS.CHP.CrTnSl
0x85D3   PTS.PD_OrSm
0x85DA   PTS.PD_SAM_
0x85DD   PTS.PD_SAM
0x8621   PTS.PD_LOOP
0x85E2   PTS.PD_VOL
0x8624   PTS.PD_LP2
0x85EB   PTS.PD_EOff
0x85F3   PTS.PD_SorE
0x85FD   PTS.PD_ENV
0x875B   PTS.SETENV
0x8602   PTS.PD_ORN
0x8607   PTS.PD_ESAM
0x86CB   PTS.PrSlide
0x8656   PTS.PD_REL
0x865C   PTS.PD_NOTE
0x8651   PTS.PD_NOIS
0x87B1   PTS.SPCCOMS
0x0074   PTS.VRS.Ns_Base
0x8664   PTS.PD_RES
0x8672   PTS.PDSP_
0x867C   PTS.C_PORTM
0x0013   PTS.CHP.SlToNt
0x0019   PTS.CHP.TnDelt
0x86D4   PTS.OLDPRTM
0x86DA   PTS.NOSIG
0x86E4   PTS.SET_STP
0x000A   PTS.CHP.COnOff
0x86F0   PTS.C_GLISS
0x8703   PTS.GL36
0x870D   PTS.C_SMPOS
0x8713   PTS.C_ORPOS
0x8719   PTS.C_VIBRT
0x000B   PTS.CHP.OnOffD
0x000C   PTS.CHP.OffOnD
0x8731   PTS.C_ENGLS
0x0072   PTS.VRS.Env_Del
0x0073   PTS.VRS.CurEDel
0x006E   PTS.VRS.ESldAdd
0x8794   PTS.C_NOP
0x000F   PTS.CHP.SamPtr
0x87D1   PTS.CHREGS
0x8A0E   PTS.Ampl
0x8924   PTS.CH_EXIT
0x886D   PTS.CSP_
0x87F7   PTS.CH_ORPS
0x8802   PTS.CH_NTP
0x8808   PTS.CH_NOK
0x8823   PTS.CH_SMPS
0x0008   PTS.CHP.TnAcc
0x885A   PTS.CH_NOAC
0x88B5   PTS.CH_AMP
0x88A0   PTS.CH_STPP
0x0002   PTS.CHP.CrAmSl
0x88CF   PTS.CH_NOAM
0x88C7   PTS.CH_AMIN
0x88CC   PTS.CH_SVAM
0x88D8   PTS.CH_APOS
0x88DE   PTS.CH_VOL
0x88E9 X PTS.CH_ENV
0x88F0   PTS.CH_NOEN
0x8912   PTS.NO_ENSL
0x0004   PTS.CHP.CrEnSl
0x890A   PTS.NO_ENAC
0x0076   PTS.VRS.AddToEn
0x8920   PTS.CH_MIX
0x0075   PTS.VRS.AddToNs
0x8944   PTS.CH_ONDL
0x8948   PTS.PLAY_
0x89FB   PTS.PL2
0x89C7   PTS.PL1B
0x89BB   PTS.PL1A
0x897F   PTS.PLNLP
0x898C   PTS.NoAlCo
0x89B8   PTS.PSP_
0x0064   PTS.VRS.AdInPtB
0x0066   PTS.VRS.AdInPtC
0x89DE   PTS.PL1C
0x89F5   PTS.PL1D
0x8A93   PTS.PL_nts
0x8A9A X PTS.r_nts
0x8AAB   PTS.ROUT_
0x8AAF   PTS.LOUT
0x8CA0   PTS.T_NEW_0
0x8B11   PTS.TCNEW_0
0x8CA0   PTS.T_OLD_0
0x8AE7   PTS.TCOLD_0
0x8C6E   PTS.T_NEW_1
0x8AF3   PTS.TCNEW_1
0x8C6E   PTS.T_OLD_1
0x8CB8   PTS.T_NEW_2
0x8B1C   PTS.TCNEW_2
0x8C86   PTS.T_OLD_2
0x8AF5   PTS.TCOLD_2
0x8C9E   PTS.T_NEW_3
0x8B07   PTS.TCNEW_3
0x8C9E   PTS.T_OLD_3
0x8B08   PTS.TCOLD_3
0x001D   PTS.CHP
0x0000 X PTS.VRS.CurPos
0x0001 X PTS.VRS.PosSub
0x8E1E X PTS.VARSEND
0x8E1E X PTS.MDLADDR
0x00CB X PT3.Header
0x0000 X PT3.Header.Id
0x000D X PT3.Header.Subversion
0x000E X PT3.Header.Description
0x0062 X PT3.Header.Mode
0x0063   PT3.Header.FreqTable
0x0064 X PT3.Header.Tempo
0x0065 X PT3.Header.Length
0x0066 X PT3.Header.Loop
0x0067 X PT3.Header.Patterns
0x0069   PT3.Header.Samples
0x00A9   PT3.Header.Ornaments
0x00C9   PT3.Header.Positions
0x8E1E   PT3.Start
0x8E3E   PT3.CheckFormat.samples
0x8E48   PT3.CheckFormat.ornaments
0x8E58   PT3.CheckFormat.positions
0x8E5D   PT3.CheckFormat.div3
0x8E65   PT3.CheckFormat.posok
0x8E67 X PT3.CheckFormat.fail
0x8A7F X PT3.Play
0x8251 X PT3.Mute
0x8E6A   PT3.End
0x0085 X PT2.Header
0x0000 X PT2.Header.Tempo
0x0001 X PT2.Header.Length
0x0002 X PT2.Header.Loop
0x0003   PT2.Header.Samples
0x0043 X PT2.Header.Ornaments
0x0063   PT2.Header.Patterns
0x0065   PT2.Header.Name
0x0083   PT2.Header.Positions
0x8E6A   PT2.Start
0x8E80   PT2.CheckFormat.samorns
0x8E9C   PT2.CheckFormat.positions
0x8EA7 X PT2.CheckFormat.fail
0x8A7F X PT2.Play
0x8251 X PT2.Mute
0x8EAA   PT2.End
0x0010 X TS.Footer
0x0000 X TS.Footer.Sign1
0x0004 X TS.Footer.Size1
0x0006 X TS.Footer.Sign2
0x000A X TS.Footer.Size2
0x000C X TS.Footer.Sign3
0x8EAA   TS.Start
0x8EAF   TS.CheckFormat
0x8EB2   TS.CheckFormat.findfooter
0x8EC1   TS.CheckFooter
0x8EED   TS.End
0x8A7F X TS.Play
0x8251 X TS.Mute
0x0001   TFC.newtfm
0x00F8   TFC.statuschip0
0x00F9   TFC.statuschip1
0x0022 X TFC.Header
0x0000 X TFC.Header.signature
0x0006 X TFC.Header.version
0x0009 X TFC.Header.intfreq
0x000A   TFC.Header.tfmptrs
0x0016 X TFC.Header.ssgptrs
0x0008   TFC.TFMData
0x0000   TFC.TFMData.addr
0x0002   TFC.TFMData.skip
0x0003   TFC.TFMData.blkcnt
0x0004   TFC.TFMData.blkretaddr
0x0005   TFC.TFMData.loopaddr
0x0006   TFC.TFMData.tfmlow
0x0007   TFC.TFMData.tfmhigh
0x8EED   TFC.Start
0x9166   TFC.End
0x912E   TFC.TFM.Init
0x9136   TFC.TFM.A
0x8F51   TFC.Init.tfminitab
0x8F5D   TFC.Init.tfminitab_end
0x8F38   TFC.Init.tfmini0
0x8F47   TFC.Init.tfminiHL
0x9136   TFC.TFM.A.addr
0x913E   TFC.TFM.B.addr
0x9146   TFC.TFM.C.addr
0x914E   TFC.TFM.D.addr
0x9156   TFC.TFM.E.addr
0x915E   TFC.TFM.F.addr
0x8FCC   TFC.selChip0
0x8F6B   TFC.Mute.tfminiPP
0x8FD0   TFC.selChip1
0x8FB3   TFC.Mute.writeregsset
0x8FBB   TFC.Mute.writereg
0x8FAF   TFC.Mute.selRegA
0x9019   TFC.PlayChannel
0x913E   TFC.TFM.B
0x9146   TFC.TFM.C
0x914E   TFC.TFM.D
0x9156   TFC.TFM.E
0x915E   TFC.TFM.F
0x007E   TFC.bb
0x007F   TFC.be
0x90DC   TFC.PlayChannel.skiper
0x9043   TFC.PlayChannel.noframe
0x9049   TFC.PlayChannel.tfmframe
0x9033   TFC.PlayChannel.begin
0x903B   TFC.PlayChannel.end
0x90CF   TFC.PlayChannel.HLskiper
0x9070   TFC.PlayChannel.noffX
0x9087   TFC.PlayChannel.nofrqX
0x90F1   TFC.PlayChannel.outTone
0x911A   TFC.PlayChannel.OutRegs
0x90C8   TFC.PlayChannel.storeaddr
0x90AA   TFC.PlayChannel.block
0x90B9   TFC.PlayChannel.subframe
0x90BF   TFC.PlayChannel.OLDfar
0x90C1   TFC.PlayChannel.OLDnear
0x90E0   TFC.PlayChannel.slide
0x912E X TFC.TFM.Init.addr
0x9130 X TFC.TFM.Init.skip
0x9131 X TFC.TFM.Init.blkcnt
0x9132 X TFC.TFM.Init.blkretaddr
0x9133 X TFC.TFM.Init.loopaddr
0x9134 X TFC.TFM.Init.tfmlow
0x9135 X TFC.TFM.Init.tfmhigh
0x9138 X TFC.TFM.A.skip
0x9139 X TFC.TFM.A.blkcnt
0x913A X TFC.TFM.A.blkretaddr
0x913B X TFC.TFM.A.loopaddr
0x913C X TFC.TFM.A.tfmlow
0x913D X TFC.TFM.A.tfmhigh
0x9140 X TFC.TFM.B.skip
0x9141 X TFC.TFM.B.blkcnt
0x9142 X TFC.TFM.B.blkretaddr
0x9143 X TFC.TFM.B.loopaddr
0x9144 X TFC.TFM.B.tfmlow
0x9145 X TFC.TFM.B.tfmhigh
0x9148 X TFC.TFM.C.skip
0x9149 X TFC.TFM.C.blkcnt
0x914A X TFC.TFM.C.blkretaddr
0x914B X TFC.TFM.C.loopaddr
0x914C X TFC.TFM.C.tfmlow
0x914D X TFC.TFM.C.tfmhigh
0x9150 X TFC.TFM.D.skip
0x9151 X TFC.TFM.D.blkcnt
0x9152 X TFC.TFM.D.blkretaddr
0x9153 X TFC.TFM.D.loopaddr
0x9154 X TFC.TFM.D.tfmlow
0x9155 X TFC.TFM.D.tfmhigh
0x9158 X TFC.TFM.E.skip
0x9159 X TFC.TFM.E.blkcnt
0x915A X TFC.TFM.E.blkretaddr
0x915B X TFC.TFM.E.loopaddr
0x915C X TFC.TFM.E.tfmlow
0x915D X TFC.TFM.E.tfmhigh
0x9160 X TFC.TFM.F.skip
0x9161 X TFC.TFM.F.blkcnt
0x9162 X TFC.TFM.F.blkretaddr
0x9163 X TFC.TFM.F.loopaddr
0x9164 X TFC.TFM.F.tfmlow
0x9165 X TFC.TFM.F.tfmhigh
0x9166   module
